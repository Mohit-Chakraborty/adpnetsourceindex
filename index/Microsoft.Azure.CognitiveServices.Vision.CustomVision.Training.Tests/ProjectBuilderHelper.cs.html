<!DOCTYPE html>
<html><head><title>ProjectBuilderHelper.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(204);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training.Tests/ProjectBuilderHelper.cs" target="_top">ProjectBuilderHelper.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/master//sdk/cognitiveservices/Vision.CustomVision.Training/tests/ProjectBuilderHelper.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training.Tests" target="_top">Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training.Tests.csproj</a> (Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">CognitiveServices</span>.<span class="i n">Vision</span>.<span class="i n">CustomVision</span>.<span class="i n">Training</span>.<span class="i n">Tests</span>
{
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">CognitiveServices</span>.<span class="i n">Vision</span>.<span class="i n">CustomVision</span>.<span class="i n">Training</span>.<span class="i n">Models</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Test</span>.<span class="i n">HttpRecorder</span>;
    <b>using</b> <span class="i n">System</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
    <b>using</b> <span class="i n">Xunit</span>;
 
    <b>public static class</b> <a id="518bee80761cdd1e" href="R/518bee80761cdd1e.html" target="n" data-glyph="0,0" class="t t">ProjectBuilderHelper</a>
    {
        <b>public const string</b> <a id="d31e089be274b098" href="R/d31e089be274b098.html" target="n" data-glyph="6,1" class="i field">ProjectPrefix</a> = <span class="s">&quot;SDK UT: &quot;</span>;
        <b>public const string</b> <a id="d23a412b3aa5dfad" href="R/../../0000000000.html" target="n" data-glyph="6,1" class="i field">ObjDetectionProjectName</a> = <a href="#d31e089be274b098" class="i field">ProjectPrefix</a> + <span class="s">&quot;Obj Detection SDK Tests&quot;</span>;
 
        <b>public const string</b> <a id="06924e0a240d3fe6" href="R/../../0000000000.html" target="n" data-glyph="6,1" class="i field">ClassificationPublishName</a> = <span class="s">&quot;Training UnitTest Iteration&quot;</span>;
        <b>public const string</b> <a id="5c88315a362c5375" href="R/../../0000000000.html" target="n" data-glyph="6,1" class="i field">ObjDetectionPublishName</a> = <span class="s">&quot;Training Obj Detection UnitTest Iteration&quot;</span>;
 
        <b>public static</b> <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a> <a id="702bbd636158b8f7" href="R/702bbd636158b8f7.html" target="n" data-glyph="42,1" class="i field">FoodDomain</a> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#c0f15e43675529c4" class="i method">Parse</a>(<a href="../GuidAssembly/R/c151d5b5-dd07-472a-acc8-15d29dea8518.html" target="n" class="s">&quot;C151D5B5-DD07-472A-ACC8-15D29DEA8518&quot;</a>);
        <b>public static</b> <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a> <a id="ac3bdcc67273a4b6" href="R/ac3bdcc67273a4b6.html" target="n" data-glyph="42,1" class="i field">GeneralDomain</a> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#c0f15e43675529c4" class="i method">Parse</a>(<a href="../GuidAssembly/R/ee85a74c-405e-4adc-bb47-ffa8ca0c9f31.html" target="n" class="s">&quot;EE85A74C-405E-4ADC-BB47-FFA8CA0C9F31&quot;</a>);
        <b>public static</b> <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a> <a id="8362274dde558218" href="R/8362274dde558218.html" target="n" data-glyph="42,1" class="i field">ExportableDomain</a> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#c0f15e43675529c4" class="i method">Parse</a>(<a href="../GuidAssembly/R/0732100f-1a38-4e49-a514-c9b44c697ab5.html" target="n" class="s">&quot;0732100F-1A38-4E49-A514-C9B44C697AB5&quot;</a>);
 
        <b>public static void</b> <a id="5b9520bbe480a9c7" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CleanUpOldProjects</a>(<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#5a3819ca970bc275" class="t t">ICustomVisionTrainingClient</a> <span id="r0 rd" class="r0 r">client</span>)
        {
            <b>foreach</b> (<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#03ff1bb8c932c719" class="k">var</a> <span id="r1 rd" class="r1 r">project</span> <b>in</b> <span class="r0 r">client</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#b2b3b837447967f8" class="i method">GetProjects</a>())
            {
                <b>if</b> (<span class="r1 r">project</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#75ab17de4149e4fb" class="i property">Name</a>.<a href="@0@mscorlib/A.html#23804789ea4c9c0e" class="i method">StartsWith</a>(<a href="#d31e089be274b098" class="i field">ProjectPrefix</a>))
                {
                    <span class="i n">System</span>.<a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#5ac7c4fda643413b" class="i method">WriteLine</a>(<span class="s">&quot;Cleaning old project: &quot;</span> + <span class="r1 r">project</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#75ab17de4149e4fb" class="i property">Name</a>);
                    <b>foreach</b> (<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#870a64dc23bbafc4" class="k">var</a> <span id="r2 rd" class="r2 r">iter</span> <b>in</b> <span class="r0 r">client</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#eda9e52976062b7d" class="i method">GetIterations</a>(<span class="r1 r">project</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#732b71edfda650ab" class="i property">Id</a>))
                    {
                        <b>if</b> (!<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r2 r">iter</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#f53998f9a19997fa" class="i property">PublishName</a>))
                        {
                            <span class="r0 r">client</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#35561edf07df70a0" class="i method">UnpublishIteration</a>(<span class="r1 r">project</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#732b71edfda650ab" class="i property">Id</a>, <span class="r2 r">iter</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#2357d3da321e53b5" class="i property">Id</a>);
                        }
                    }
                    <span class="r0 r">client</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#b668e63fadb0463b" class="i method">DeleteProject</a>(<span class="r1 r">project</span>.<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#732b71edfda650ab" class="i property">Id</a>);
                }
            }
        }
 
        <b>public static</b> <a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#870a64dc23bbafc4" class="t t">Iteration</a> <a id="f65db3149d6383e8" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CreateTrainedImageClassificationProject</a>(<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#5a3819ca970bc275" class="t t">ICustomVisionTrainingClient</a> <span id="r3 rd" class="r3 r">client</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r4 rd" class="r4 r">predictionResourceId</span>, <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>? <span id="r5 rd" class="r5 r">domain</span> = <b>null</b>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">RECORD_MODE</span>
<span class="e">            var projName = ProjectPrefix + Guid.NewGuid().ToString();
 
            // Create a project
            var projDomain = domain.HasValue ? domain : GeneralDomain;
            var project = client.CreateProject(projName, null, projDomain);
 
            // Create two tags
            var tagOne = client.CreateTag(project.Id, &quot;Tag1&quot;);
            var tagTwo = client.CreateTag(project.Id, &quot;Tag2&quot;);
 
            // Add five images for tag 1
            var imagePath = Path.Combine(&quot;TestImages&quot;, &quot;tag1&quot;);
            var imageFileEntries = new List&lt;ImageFileCreateEntry&gt;();
            foreach (var fileName in Directory.EnumerateFiles(imagePath))
            {
                imageFileEntries.Add(new ImageFileCreateEntry(fileName, File.ReadAllBytes(fileName)));
            }
            client.CreateImagesFromFiles(project.Id, new ImageFileCreateBatch(imageFileEntries, new List&lt;Guid&gt;(new Guid[] { tagOne.Id })));
 
            // Add five images for tag 2
            imagePath = Path.Combine(&quot;TestImages&quot;, &quot;tag2&quot;);
            imageFileEntries = new List&lt;ImageFileCreateEntry&gt;();
            foreach (var fileName in Directory.EnumerateFiles(imagePath))
            {
                imageFileEntries.Add(new ImageFileCreateEntry(fileName, File.ReadAllBytes(fileName)));
            }
            client.CreateImagesFromFiles(project.Id, new ImageFileCreateBatch(imageFileEntries, new List&lt;Guid&gt;(new Guid[] { tagTwo.Id })));
 
            // Train
            var iteration = client.TrainProject(project.Id);
            while (iteration.Status != &quot;Completed&quot;)
            {
                Thread.Sleep(1000);
                iteration = client.GetIteration(project.Id, iteration.Id);
            }
            Assert.True(client.PublishIteration(project.Id, iteration.Id, ClassificationPublishName, predictionResourceId));
 
            // Get latest iteration
            iteration = client.GetIteration(project.Id, iteration.Id);
 
            // Make one prediction
            string imageUrl = &quot;https://raw.githubusercontent.com/Microsoft/Cognitive-CustomVision-Windows/master/Samples/Images/Test/test_image.jpg&quot;;
            client.QuickTestImageUrl(project.Id, new ImageUrl(imageUrl), iteration.Id);
 
            // Flush and re-init so we don&#39;t get all of the test setup in the session.
            HttpMockServer.Flush();
            HttpMockServer.Initialize(HttpMockServer.CallerIdentity, HttpMockServer.TestIdentity, HttpRecorderMode.Record);
 
            return iteration;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <b>null</b>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>public static</b> <a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#870a64dc23bbafc4" class="t t">Iteration</a> <a id="48e13f080e158250" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CreateTrainedObjDetectionProject</a>(<a href="/Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training/A.html#5a3819ca970bc275" class="t t">ICustomVisionTrainingClient</a> <span id="r6 rd" class="r6 r">client</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r7 rd" class="r7 r">predictionResourceId</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">RECORD_MODE</span>
<span class="e">            Dictionary&lt;string, double[]&gt; fileToRegionMap = new Dictionary&lt;string, double[]&gt;()
            {
                // FileName, Left, Top, Width, Height
                {&quot;fork_1&quot;, new double[] { 0.219362751, 0.141781077, 0.5919118, 0.6683006 } },
                {&quot;fork_2&quot;, new double[] { 0.115196079, 0.341127485, 0.819852948, 0.222222224 } },
                {&quot;fork_3&quot;, new double[] { 0.107843138, 0.128709182, 0.727941155, 0.71405226 } },
                {&quot;fork_4&quot;, new double[] { 0.148284316, 0.318251669, 0.7879902, 0.3970588 } },
                {&quot;fork_5&quot;, new double[] { 0.08210784, 0.07805559, 0.759803951, 0.593137264 } },
                {&quot;fork_6&quot;, new double[] { 0.2977941, 0.220212445, 0.5355392, 0.6013072 } },
                {&quot;fork_7&quot;, new double[] { 0.143382356, 0.346029431, 0.590686262, 0.256535947 } },
                {&quot;fork_8&quot;, new double[] { 0.294117659, 0.216944471, 0.49142158, 0.5980392 } },
                {&quot;fork_9&quot;, new double[] { 0.240196079, 0.1385131, 0.5955882, 0.643790841 } },
                {&quot;fork_10&quot;, new double[] { 0.25, 0.149951011, 0.534313738, 0.642156839 } },
                {&quot;fork_11&quot;, new double[] { 0.234068632, 0.445702642, 0.6127451, 0.344771236 } },
                {&quot;fork_12&quot;, new double[] { 0.180147052, 0.239820287, 0.6887255, 0.235294119 } },
                {&quot;fork_13&quot;, new double[] { 0.140931368, 0.480016381, 0.6838235, 0.240196079 } },
                {&quot;fork_14&quot;, new double[] { 0.186274514, 0.0633497, 0.579656839, 0.8611111 } },
                {&quot;fork_15&quot;, new double[] { 0.243872553, 0.212042511, 0.470588237, 0.6683006 } },
                {&quot;fork_16&quot;, new double[] { 0.143382356, 0.218578458, 0.7977941, 0.295751631 } },
                {&quot;fork_17&quot;, new double[] { 0.3345588, 0.07315363, 0.375, 0.9150327 } },
                {&quot;fork_18&quot;, new double[] { 0.05759804, 0.0894935, 0.9007353, 0.3251634 } },
                {&quot;fork_19&quot;, new double[] { 0.05269608, 0.282303959, 0.8088235, 0.452614367 } },
                {&quot;fork_20&quot;, new double[] { 0.18259804, 0.2136765, 0.6335784, 0.643790841 } },
                {&quot;scissors_1&quot;, new double[] { 0.169117644, 0.3378595, 0.780637264, 0.393790841 } },
                {&quot;scissors_2&quot;, new double[] { 0.145833328, 0.06661768, 0.6838235, 0.8153595 } },
                {&quot;scissors_3&quot;, new double[] { 0.3125, 0.09766343, 0.435049027, 0.71405226 } },
                {&quot;scissors_4&quot;, new double[] { 0.432598025, 0.177728787, 0.18259804, 0.576797366 } },
                {&quot;scissors_5&quot;, new double[] { 0.354166657, 0.210408524, 0.305147052, 0.625817 } },
                {&quot;scissors_6&quot;, new double[] { 0.368872553, 0.234918326, 0.3394608, 0.5833333 } },
                {&quot;scissors_7&quot;, new double[] { 0.4007353, 0.184264734, 0.2720588, 0.6862745 } },
                {&quot;scissors_8&quot;, new double[] { 0.319852948, 0.0339379422, 0.455882341, 0.843137264 } },
                {&quot;scissors_9&quot;, new double[] { 0.295343131, 0.259428144, 0.403186262, 0.421568632 } },
                {&quot;scissors_10&quot;, new double[] { 0.341911763, 0.0894935, 0.351715684, 0.828431368 } },
                {&quot;scissors_11&quot;, new double[] { 0.2720588, 0.131977156, 0.4987745, 0.6911765 } },
                {&quot;scissors_12&quot;, new double[] { 0.186274514, 0.14504905, 0.7022059, 0.748366 } },
                {&quot;scissors_13&quot;, new double[] { 0.05759804, 0.05027781, 0.75, 0.882352948 } },
                {&quot;scissors_14&quot;, new double[] { 0.181372553, 0.112369314, 0.629901946, 0.71405226 } },
                {&quot;scissors_15&quot;, new double[] { 0.256127447, 0.190800682, 0.441176474, 0.6862745 } },
                {&quot;scissors_16&quot;, new double[] { 0.261029422, 0.153218985, 0.513480365, 0.6388889 } },
                {&quot;scissors_17&quot;, new double[] { 0.113970585, 0.2643301, 0.6666667, 0.504901946 } },
                {&quot;scissors_18&quot;, new double[] { 0.05514706, 0.159754932, 0.799019635, 0.730392158 } },
                {&quot;scissors_19&quot;, new double[] { 0.204656869, 0.120539248, 0.5245098, 0.743464053 } },
                {&quot;scissors_20&quot;, new double[] { 0.231617644, 0.08459154, 0.504901946, 0.8480392 } }
            };
 
            // Find the object detection domain
            var domains = client.GetDomains();
            var objDetectionDomain = domains.FirstOrDefault(d =&gt; d.Type == &quot;ObjectDetection&quot; &amp;&amp; d.Name == &quot;General&quot;);
            Assert.NotNull(objDetectionDomain);
 
            // Create a new project
            var project = client.CreateProject(ObjDetectionProjectName, null, objDetectionDomain.Id);
 
            // Create two tags
            var forkTag = client.CreateTag(project.Id, &quot;fork&quot;);
            var scissorsTag = client.CreateTag(project.Id, &quot;scissors&quot;);
 
            // Add all images for fork
            var imagePath = Path.Combine(&quot;TestImages&quot;, &quot;fork&quot;);
            var imageFileEntries = new List&lt;ImageFileCreateEntry&gt;();
            foreach (var fileName in Directory.EnumerateFiles(imagePath))
            {
                var region = fileToRegionMap[Path.GetFileNameWithoutExtension(fileName)];
                imageFileEntries.Add(new ImageFileCreateEntry(fileName, File.ReadAllBytes(fileName), null, new List&lt;Region&gt;(new Region[] { new Region(forkTag.Id, region[0], region[1], region[2], region[3]) })));
            }
            client.CreateImagesFromFiles(project.Id, new ImageFileCreateBatch(imageFileEntries));
 
            // Add all images for scissors
            imagePath = Path.Combine(&quot;TestImages&quot;, &quot;scissors&quot;);
            imageFileEntries = new List&lt;ImageFileCreateEntry&gt;();
            foreach (var fileName in Directory.EnumerateFiles(imagePath))
            {
                var region = fileToRegionMap[Path.GetFileNameWithoutExtension(fileName)];
                imageFileEntries.Add(new ImageFileCreateEntry(fileName, File.ReadAllBytes(fileName), null, new List&lt;Region&gt;(new Region[] { new Region(scissorsTag.Id, region[0], region[1], region[2], region[3]) })));
            }
            client.CreateImagesFromFiles(project.Id, new ImageFileCreateBatch(imageFileEntries));
 
            // Train
            var iteration = client.TrainProject(project.Id);
            while (iteration.Status != &quot;Completed&quot;)
            {
                Thread.Sleep(1000);
                iteration = client.GetIteration(project.Id, iteration.Id);
            }
            Assert.True(client.PublishIteration(project.Id, iteration.Id, ObjDetectionPublishName, predictionResourceId));
 
            // Get latest iteration
            iteration = client.GetIteration(project.Id, iteration.Id);
 
            // Flush and re-init so we don&#39;t get all of the test setup in the session.
            HttpMockServer.Flush();
            HttpMockServer.Initialize(HttpMockServer.CallerIdentity, HttpMockServer.TestIdentity, HttpRecorderMode.Record);
 
            return iteration;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <b>null</b>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
    }
}
</pre></td></tr></table></div></body></html>
