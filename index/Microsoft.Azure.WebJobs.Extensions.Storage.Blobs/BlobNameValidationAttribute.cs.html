<!DOCTYPE html>
<html><head><title>BlobNameValidationAttribute.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(141);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/BlobNameValidationAttribute.cs" target="_top">BlobNameValidationAttribute.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.WebJobs.Extensions.Storage.Blobs" target="_top">Microsoft.Azure.WebJobs.Extensions.Storage.Blobs.csproj</a> (Microsoft.Azure.WebJobs.Extensions.Storage.Blobs)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">ComponentModel</span>.<span class="i n">DataAnnotations</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>.<span class="i n">RegularExpressions</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">WebJobs</span>.<span class="i n">Extensions</span>.<span class="i n">Storage</span>.<span class="i n">Blobs</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> DataAnnotation attribute to validate a Blob Path against Azure Storage rules.</span>
    <span class="c">///</span><span class="c"> A BlobPath could be:</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">list</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">item</span><span class="c">&gt;</span><span class="c">A Container / Blob Name</span><span class="c">&lt;/</span><span class="c">item</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">item</span><span class="c">&gt;</span><span class="c">An absolute URI specifying a Blob</span><span class="c">&lt;/</span><span class="c">item</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">item</span><span class="c">&gt;</span><span class="c">Just a Container Name</span><span class="c">&lt;/</span><span class="c">item</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">list</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Naming rules are here: http://msdn.microsoft.com/en-us/library/dd135715.aspx</span>
    <span class="c">///</span><span class="c"> Validate this on the client side so that we can get a user-friendly error rather than a 400 from the service.</span>
    <span class="c">///</span><span class="c"> See code here: http://social.msdn.microsoft.com/Forums/en-GB/windowsazuredata/thread/d364761b-6d9d-4c15-8353-46c6719a3392</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="8f9f6aea7584bfde" href="R/8f9f6aea7584bfde.html" target="n" data-glyph="2,0" class="t t"><span id="41e8349dea9a7534">BlobNameValidationAttribute</span></a> : <span class="t t">ValidationAttribute</span>
    {
        <span class="c">// Tested against storage service on July 2016. All other unsafe and reserved characters work fine.</span>
        <b>private static readonly char</b>[] <a id="d6df0d3c978f9c95" href="R/d6df0d3c978f9c95.html" target="n" data-glyph="46,1" class="i field">UnsafeBlobNameCharacters</a> = { <span class="s">&#39;\\&#39;</span> };
 
        <span class="c">// Called by the framework.</span>
        <span class="c">// This has already resolved any %%, { }  in the path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">inheritdoc</span><span class="c">/&gt;</span>
        <b>protected override</b> <span class="t t">ValidationResult</span> <a id="982402897cc0d05e" href="R/982402897cc0d05e.html" target="n" data-glyph="75,1" class="i method">IsValid</a>(<b>object</b> <span id="r0 rd" class="r0 r">value</span>, <span class="t t">ValidationContext</span> <span id="r1 rd" class="r1 r">validationContext</span>)
        {
            <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r2 rd" class="r2 r">path</span> = (<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>)<span class="r0 r">value</span>;
            <b>if</b> (<span class="r0 r">value</span> == <b>null</b>)
            {
                <b>return</b> <b>new</b> <span class="t constructor">ValidationResult</span>(<span class="s">&quot;Blob path can&#39;t be null&quot;</span>);
            }
 
            <span class="c">// Could be either just a container, container/blob, or url</span>
            <a href="@1@netstandard/A.html#991565dd25f47c90" class="t t">Uri</a> <span id="r3 rd" class="r3 r">uri</span>;
            <b>if</b> (<a href="@1@netstandard/A.html#991565dd25f47c90" class="t t">Uri</a>.<a href="@1@netstandard/A.html#49754736d6982eb6" class="i method">TryCreate</a>(<span class="r2 r">path</span>, <a href="@1@netstandard/A.html#ac43655101ad74be" class="t t">UriKind</a>.<a href="@1@netstandard/A.html#d734108197254429" class="i field">Absolute</a>, <b>out</b> <span class="r3 r">uri</span>))
            {
                <span class="c">// still get container and blob name</span>
                <b>return</b> <b>null</b>;
            }
 
            <b>int</b> <span id="r4 rd" class="r4 r">slashIndex</span> = <span class="r2 r">path</span>.<a href="@1@netstandard/A.html#eb06d6d166f6a3d9" class="i method">IndexOf</a>(<span class="s">&#39;/&#39;</span>);
 
            <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r5 rd" class="r5 r">containerName</span>;
            <b>if</b> (<span class="r4 r">slashIndex</span> &lt;= 0)
            {
                <span class="c">// Container-only name</span>
                <span class="r5 r">containerName</span> = <span class="r2 r">path</span>;
            }
            <b>else</b>
            {
                <b>if</b> (<span class="r4 r">slashIndex</span> == <span class="r2 r">path</span>.<a href="@1@netstandard/A.html#e13f5829ef28aa07" class="i property">Length</a> - 1)
                {
                    <span class="c">// if there is a slash present, there must be at least one character before</span>
                    <span class="c">// the slash and one character after the slash.</span>
                    <b>return</b> <b>new</b> <span class="t constructor">ValidationResult</span>(<span class="s">&quot;Illegal blob path&quot;</span>);
                }
 
                <span class="r5 r">containerName</span> = <span class="r2 r">path</span>.<a href="@1@netstandard/A.html#8124961f027d9ac9" class="i method">Substring</a>(0, <span class="r4 r">slashIndex</span>);
                <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r6 rd" class="r6 r">blobName</span> = <span class="r2 r">path</span>.<a href="@1@netstandard/A.html#882fa7998d6ca35a" class="i method">Substring</a>(<span class="r4 r">slashIndex</span> + 1);
 
                <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r7 rd" class="r7 r">msg</span>;
                <b>if</b> (!<a href="#4a89f133c047c59f" class="i method">IsValidBlobName</a>(<span class="r6 r">blobName</span>, <b>out</b> <span class="r7 r">msg</span>))
                {
                    <b>return</b> <b>new</b> <span class="t constructor">ValidationResult</span>(<span class="r7 r">msg</span>);
                }
            }
            <b>if</b> (!<a href="#1488e3916aafe2db" class="i method">IsValidContainerName</a>(<span class="r5 r">containerName</span>))
            {
                <b>return</b> <b>new</b> <span class="t constructor">ValidationResult</span>(<span class="s">&quot;Invalid container name&quot;</span>);
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <b>internal static bool</b> <a id="1488e3916aafe2db" href="R/1488e3916aafe2db.html" target="n" data-glyph="74,1" class="i method">IsValidContainerName</a>(<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r8 rd" class="r8 r">containerName</span>)
        {
            <b>if</b> (<span class="r8 r">containerName</span> == <b>null</b>)
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>if</b> (<span class="r8 r">containerName</span>.<a href="@1@netstandard/A.html#b98069ccbe2d3960" class="i method">Equals</a>(<span class="s">&quot;$root&quot;</span>, <a href="@1@netstandard/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@netstandard/A.html#eb6ce9ac0dbf4269" class="i field">InvariantCulture</a>))
            {
                <b>return</b> <b>true</b>;
            }
 
            <b>return</b> <a href="@1@netstandard/A.html#bbe3b2eb80ae5526" class="t t">Regex</a>.<a href="@1@netstandard/A.html#ffaf97ebd1d02f3c" class="i method">IsMatch</a>(<span class="r8 r">containerName</span>, <span class="s">@&quot;^[a-z0-9](([a-z0-9\-[^\-])){1,61}[a-z0-9]$&quot;</span>);
        }
 
        <b>internal static bool</b> <a id="4a89f133c047c59f" href="R/4a89f133c047c59f.html" target="n" data-glyph="74,1" class="i method">IsValidBlobName</a>(<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r9 rd" class="r9 r">blobName</span>, <b>out string</b> <span id="r10 rd" class="r10 r">errorMessage</span>)
        {
            <b>const string</b> <span id="r11 rd" class="r11 r">UnsafeCharactersMessage</span> =
                <span class="s">&quot;The given blob name &#39;{0}&#39; contain illegal characters. A blob name cannot the following character(s): &#39;\\&#39;.&quot;</span>;
            <b>const string</b> <span id="r12 rd" class="r12 r">TooLongErrorMessage</span> =
                <span class="s">&quot;The given blob name &#39;{0}&#39; is too long. A blob name must be at least one character long and cannot be more than 1,024 characters long.&quot;</span>;
            <b>const string</b> <span id="r13 rd" class="r13 r">TooShortErrorMessage</span> =
                <span class="s">&quot;The given blob name &#39;{0}&#39; is too short. A blob name must be at least one character long and cannot be more than 1,024 characters long.&quot;</span>;
            <b>const string</b> <span id="r14 rd" class="r14 r">InvalidSuffixErrorMessage</span> =
                <span class="s">&quot;The given blob name &#39;{0}&#39; has an invalid suffix. Avoid blob names that end with a dot (&#39;.&#39;), a forward slash (&#39;/&#39;), or a sequence or combination of the two.&quot;</span>;
 
            <b>if</b> (<span class="r9 r">blobName</span> == <b>null</b>)
            {
                <span class="r10 r">errorMessage</span> = <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#c07c3772222caaff" class="i method">Format</a>(<a href="@1@netstandard/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@1@netstandard/A.html#1f5907384ac6bb55" class="i property">CurrentCulture</a>, <span class="r13 r">TooShortErrorMessage</span>, <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@1@netstandard/A.html#c9f70a27facb27cf" class="i field">Empty</a>);
                <b>return</b> <b>false</b>;
            }
            <b>if</b> (<span class="r9 r">blobName</span>.<a href="@1@netstandard/A.html#e13f5829ef28aa07" class="i property">Length</a> == 0)
            {
                <span class="r10 r">errorMessage</span> = <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#c07c3772222caaff" class="i method">Format</a>(<a href="@1@netstandard/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@1@netstandard/A.html#1f5907384ac6bb55" class="i property">CurrentCulture</a>, <span class="r13 r">TooShortErrorMessage</span>, <span class="r9 r">blobName</span>);
                <b>return</b> <b>false</b>;
            }
 
            <b>if</b> (<span class="r9 r">blobName</span>.<a href="@1@netstandard/A.html#e13f5829ef28aa07" class="i property">Length</a> &gt; 1024)
            {
                <span class="r10 r">errorMessage</span> = <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#c07c3772222caaff" class="i method">Format</a>(<a href="@1@netstandard/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@1@netstandard/A.html#1f5907384ac6bb55" class="i property">CurrentCulture</a>, <span class="r12 r">TooLongErrorMessage</span>, <span class="r9 r">blobName</span>);
                <b>return</b> <b>false</b>;
            }
 
            <b>if</b> (<span class="r9 r">blobName</span>.<a href="@1@netstandard/A.html#41a31e4feec3ef41" class="i method">EndsWith</a>(<span class="s">&quot;.&quot;</span>, <a href="@1@netstandard/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@netstandard/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>) || <span class="r9 r">blobName</span>.<a href="@1@netstandard/A.html#41a31e4feec3ef41" class="i method">EndsWith</a>(<span class="s">&quot;/&quot;</span>, <a href="@1@netstandard/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@netstandard/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>))
            {
                <span class="r10 r">errorMessage</span> = <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#c07c3772222caaff" class="i method">Format</a>(<a href="@1@netstandard/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@1@netstandard/A.html#1f5907384ac6bb55" class="i property">CurrentCulture</a>, <span class="r14 r">InvalidSuffixErrorMessage</span>, <span class="r9 r">blobName</span>);
                <b>return</b> <b>false</b>;
            }
 
            <b>if</b> (<span class="r9 r">blobName</span>.<a href="@1@netstandard/A.html#299d36326434ba20" class="i method">IndexOfAny</a>(<a href="#d6df0d3c978f9c95" class="i field">UnsafeBlobNameCharacters</a>) &gt; -1)
            {
                <span class="r10 r">errorMessage</span> = <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#c07c3772222caaff" class="i method">Format</a>(<a href="@1@netstandard/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@1@netstandard/A.html#1f5907384ac6bb55" class="i property">CurrentCulture</a>, <span class="r11 r">UnsafeCharactersMessage</span>, <span class="r9 r">blobName</span>);
                <b>return</b> <b>false</b>;
            }
 
            <span class="r10 r">errorMessage</span> = <b>null</b>;
            <b>return</b> <b>true</b>;
        }
    }
}
</pre></td></tr></table></div></body></html>
