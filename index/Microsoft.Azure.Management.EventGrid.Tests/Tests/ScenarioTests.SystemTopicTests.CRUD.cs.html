<!DOCTYPE html>
<html><head><title>ScenarioTests.SystemTopicTests.CRUD.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(168);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Management.EventGrid.Tests/Tests/ScenarioTests.SystemTopicTests.CRUD.cs" target="_top">Tests\ScenarioTests.SystemTopicTests.CRUD.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Management.EventGrid.Tests" target="_top">Microsoft.Azure.Management.EventGrid.Tests.csproj</a> (Microsoft.Azure.Management.EventGrid.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>using</b> <span class="i">System</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">EventGrid</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">EventGrid</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">Rest</span>.<span class="i">Azure</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">Rest</span>.<span class="i">ClientRuntime</span>.<span class="i">Azure</span>.<span class="i">TestFramework</span>;
<b>using</b> <span class="i n">EventGrid</span>.<span class="i n">Tests</span>.<span class="i n">TestHelper</span>;
<b>using</b> <span class="i">Xunit</span>;
 
<b>namespace</b> <span class="i n">EventGrid</span>.<span class="i n">Tests</span>.<span class="i n">ScenarioTests</span>
{
    <b>public</b> <a href="../P/9ffdfede6c6f9c92.html" target="s" class="k">partial</a> <b>class</b> <a id="9ffdfede6c6f9c92" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="fb9a6f505c1bd213">ScenarioTests</span></a>
    {
        <span class="c">// Disable the test as system topic is not part of GA API yet.</span>
        <span class="c">//////[Fact]</span>
        <span class="c">//////public void SystemTopicCreateGetUpdateDelete()</span>
        <span class="c">//////{</span>
        <span class="c">//////    using (MockContext context = MockContext.Start(this.GetType()))</span>
        <span class="c">//////    {</span>
        <span class="c">//////        this.InitializeClients(context);</span>
 
        <span class="c">//////        var location = this.ResourceManagementClient.GetLocationFromProvider();</span>
 
        <span class="c">//////        string resourceGroup = &quot;testtobedeleted&quot;;</span>
        <span class="c">//////        var systemTopicName = TestUtilities.GenerateName(EventGridManagementHelper.SystemTopicPrefix);</span>
 
        <span class="c">//////        // Temporarily commenting this out as this is not yet enabled for the new API version</span>
        <span class="c">//////        // var operationsResponse = this.EventGridManagementClient.Operations.List();</span>
 
        <span class="c">//////        var originalTagsDictionary = new Dictionary&lt;string, string&gt;()</span>
        <span class="c">//////        {</span>
        <span class="c">//////            {&quot;originalTag1&quot;, &quot;originalValue1&quot;},</span>
        <span class="c">//////            {&quot;originalTag2&quot;, &quot;originalValue2&quot;}</span>
        <span class="c">//////        };</span>
 
        <span class="c">//////        SystemTopic systemTopic = new SystemTopic()</span>
        <span class="c">//////        {</span>
        <span class="c">//////            Location = location,</span>
        <span class="c">//////            Tags = originalTagsDictionary,</span>
        <span class="c">//////            TopicType = &quot;microsoft.storage.storageaccounts&quot;,</span>
        <span class="c">//////            Source = &quot;/subscriptions/5b4b650e-28b9-4790-b3ab-ddbd88d727c4/resourceGroups/testtobedeleted/providers/Microsoft.Storage/storageAccounts/testtrackedsourcev2&quot;,</span>
        <span class="c">//////        };</span>
 
        <span class="c">//////        try</span>
        <span class="c">//////        {</span>
        <span class="c">//////            var createSystemTopicResponse = this.EventGridManagementClient.SystemTopics.CreateOrUpdateAsync(resourceGroup, systemTopicName, systemTopic).Result;</span>
 
        <span class="c">//////            Assert.NotNull(createSystemTopicResponse);</span>
        <span class="c">//////            Assert.Equal(createSystemTopicResponse.Name, systemTopicName);</span>
 
        <span class="c">//////            TestUtilities.Wait(TimeSpan.FromSeconds(5));</span>
 
        <span class="c">//////            // Get the created systemTopic</span>
        <span class="c">//////            var getSystemTopicResponse = this.EventGridManagementClient.SystemTopics.Get(resourceGroup, systemTopicName);</span>
        <span class="c">//////            if (string.Compare(getSystemTopicResponse.ProvisioningState, &quot;Succeeded&quot;, true) != 0)</span>
        <span class="c">//////            {</span>
        <span class="c">//////                TestUtilities.Wait(TimeSpan.FromSeconds(5));</span>
        <span class="c">//////            }</span>
 
        <span class="c">//////            getSystemTopicResponse = this.EventGridManagementClient.SystemTopics.Get(resourceGroup, systemTopicName);</span>
        <span class="c">//////            Assert.NotNull(getSystemTopicResponse);</span>
        <span class="c">//////            Assert.Equal(&quot;Succeeded&quot;, getSystemTopicResponse.ProvisioningState, StringComparer.CurrentCultureIgnoreCase);</span>
        <span class="c">//////            Assert.Equal(location, getSystemTopicResponse.Location, StringComparer.CurrentCultureIgnoreCase);</span>
 
        <span class="c">//////            // Get all systemTopics created within a resourceGroup</span>
        <span class="c">//////            IPage&lt;SystemTopic&gt; systemTopicsInResourceGroupPage = this.EventGridManagementClient.SystemTopics.ListByResourceGroupAsync(resourceGroup).Result;</span>
        <span class="c">//////            var systemTopicsInResourceGroupList = new List&lt;SystemTopic&gt;();</span>
        <span class="c">//////            if (systemTopicsInResourceGroupPage.Any())</span>
        <span class="c">//////            {</span>
        <span class="c">//////                systemTopicsInResourceGroupList.AddRange(systemTopicsInResourceGroupPage);</span>
        <span class="c">//////                var nextLink = systemTopicsInResourceGroupPage.NextPageLink;</span>
        <span class="c">//////                while (nextLink != null)</span>
        <span class="c">//////                {</span>
        <span class="c">//////                    systemTopicsInResourceGroupPage = this.EventGridManagementClient.SystemTopics.ListByResourceGroupNextAsync(nextLink).Result;</span>
        <span class="c">//////                    systemTopicsInResourceGroupList.AddRange(systemTopicsInResourceGroupPage);</span>
        <span class="c">//////                    nextLink = systemTopicsInResourceGroupPage.NextPageLink;</span>
        <span class="c">//////                }</span>
        <span class="c">//////            }</span>
 
        <span class="c">//////            Assert.NotNull(systemTopicsInResourceGroupList);</span>
        <span class="c">//////            Assert.True(systemTopicsInResourceGroupList.Count() &gt;= 1);</span>
        <span class="c">//////            Assert.Contains(systemTopicsInResourceGroupList, t =&gt; t.Name == systemTopicName);</span>
        <span class="c">//////            Assert.True(systemTopicsInResourceGroupList.All(ns =&gt; ns.Id.Contains(resourceGroup)));</span>
 
        <span class="c">//////            IPage&lt;SystemTopic&gt; systemTopicsInResourceGroupPageWithTop = this.EventGridManagementClient.SystemTopics.ListByResourceGroupAsync(resourceGroup, null, 5).Result;</span>
        <span class="c">//////            var systemTopicsInResourceGroupListWithTop = new List&lt;SystemTopic&gt;();</span>
        <span class="c">//////            if (systemTopicsInResourceGroupPageWithTop.Any())</span>
        <span class="c">//////            {</span>
        <span class="c">//////                systemTopicsInResourceGroupListWithTop.AddRange(systemTopicsInResourceGroupPageWithTop);</span>
        <span class="c">//////                var nextLink = systemTopicsInResourceGroupPageWithTop.NextPageLink;</span>
        <span class="c">//////                while (nextLink != null)</span>
        <span class="c">//////                {</span>
        <span class="c">//////                    systemTopicsInResourceGroupPageWithTop = this.EventGridManagementClient.SystemTopics.ListByResourceGroupNextAsync(nextLink).Result;</span>
        <span class="c">//////                    systemTopicsInResourceGroupListWithTop.AddRange(systemTopicsInResourceGroupPageWithTop);</span>
        <span class="c">//////                    nextLink = systemTopicsInResourceGroupPageWithTop.NextPageLink;</span>
        <span class="c">//////                }</span>
        <span class="c">//////            }</span>
 
        <span class="c">//////            Assert.NotNull(systemTopicsInResourceGroupListWithTop);</span>
        <span class="c">//////            Assert.True(systemTopicsInResourceGroupListWithTop.Count() &gt;= 1);</span>
        <span class="c">//////            Assert.Contains(systemTopicsInResourceGroupListWithTop, t =&gt; t.Name == systemTopicName);</span>
        <span class="c">//////            Assert.True(systemTopicsInResourceGroupListWithTop.All(ns =&gt; ns.Id.Contains(resourceGroup)));</span>
 
        <span class="c">//////            // Get all systemTopics created within the subscription irrespective of the resourceGroup</span>
        <span class="c">//////            IPage&lt;SystemTopic&gt; systemTopicsInAzureSubscription = this.EventGridManagementClient.SystemTopics.ListBySubscriptionAsync(null, 100).Result;</span>
        <span class="c">//////            var systemTopicsInAzureSubscriptionList = new List&lt;SystemTopic&gt;();</span>
        <span class="c">//////            if (systemTopicsInAzureSubscription.Any())</span>
        <span class="c">//////            {</span>
        <span class="c">//////                systemTopicsInAzureSubscriptionList.AddRange(systemTopicsInAzureSubscription);</span>
        <span class="c">//////                var nextLink = systemTopicsInAzureSubscription.NextPageLink;</span>
        <span class="c">//////                while (nextLink != null)</span>
        <span class="c">//////                {</span>
        <span class="c">//////                    try</span>
        <span class="c">//////                    {</span>
        <span class="c">//////                        systemTopicsInAzureSubscription = this.EventGridManagementClient.SystemTopics.ListBySubscriptionNextAsync(nextLink).Result;</span>
        <span class="c">//////                        systemTopicsInAzureSubscriptionList.AddRange(systemTopicsInAzureSubscription);</span>
        <span class="c">//////                        nextLink = systemTopicsInAzureSubscription.NextPageLink;</span>
        <span class="c">//////                    }</span>
        <span class="c">//////                    catch (Exception ex)</span>
        <span class="c">//////                    {</span>
        <span class="c">//////                        Console.WriteLine(ex);</span>
        <span class="c">//////                        break;</span>
        <span class="c">//////                    }</span>
        <span class="c">//////                }</span>
        <span class="c">//////            }</span>
 
        <span class="c">//////            Assert.NotNull(systemTopicsInAzureSubscriptionList);</span>
        <span class="c">//////            Assert.True(systemTopicsInAzureSubscriptionList.Count() &gt;= 1);</span>
        <span class="c">//////            Assert.Contains(systemTopicsInAzureSubscriptionList, t =&gt; t.Name == systemTopicName);</span>
 
        <span class="c">//////            var replaceSystemTopicTagsDictionary = new Dictionary&lt;string, string&gt;()</span>
        <span class="c">//////            {</span>
        <span class="c">//////                { &quot;replacedTag1&quot;, &quot;replacedValue1&quot; },</span>
        <span class="c">//////                { &quot;replacedTag2&quot;, &quot;replacedValue2&quot; }</span>
        <span class="c">//////            };</span>
 
        <span class="c">//////            // Replace the systemTopic</span>
        <span class="c">//////            systemTopic.Tags = replaceSystemTopicTagsDictionary;</span>
        <span class="c">//////            var replaceSystemTopicResponse = this.EventGridManagementClient.SystemTopics.CreateOrUpdateAsync(resourceGroup, systemTopicName, systemTopic).Result;</span>
 
        <span class="c">//////            Assert.Contains(replaceSystemTopicResponse.Tags, tag =&gt; tag.Key == &quot;replacedTag1&quot;);</span>
        <span class="c">//////            Assert.DoesNotContain(replaceSystemTopicResponse.Tags, tag =&gt; tag.Key == &quot;originalTag1&quot;);</span>
 
        <span class="c">//////            // Update the systemTopic with tags &amp; allow traffic from all ips</span>
        <span class="c">//////            SystemTopicUpdateParameters systemTopicUpdateParameters = new SystemTopicUpdateParameters();</span>
        <span class="c">//////            systemTopicUpdateParameters.Tags = new Dictionary&lt;string, string&gt;()</span>
        <span class="c">//////            {</span>
        <span class="c">//////                { &quot;updatedTag1&quot;, &quot;updatedValue1&quot; },</span>
        <span class="c">//////                { &quot;updatedTag2&quot;, &quot;updatedValue2&quot; }</span>
        <span class="c">//////            };</span>
 
        <span class="c">//////            var updateSystemTopicResponse = this.EventGridManagementClient.SystemTopics.UpdateAsync(resourceGroup, systemTopicName, systemTopicUpdateParameters.Tags).Result;</span>
        <span class="c">//////            Assert.Contains(updateSystemTopicResponse.Tags, tag =&gt; tag.Key == &quot;updatedTag1&quot;);</span>
        <span class="c">//////            Assert.DoesNotContain(updateSystemTopicResponse.Tags, tag =&gt; tag.Key == &quot;replacedTag1&quot;);</span>
        <span class="c">//////        }</span>
        <span class="c">//////        finally</span>
        <span class="c">//////        {</span>
        <span class="c">//////            // Delete systemTopic</span>
        <span class="c">//////            this.EventGridManagementClient.SystemTopics.DeleteAsync(resourceGroup, systemTopicName).Wait();</span>
        <span class="c">//////        }</span>
        <span class="c">//////    }</span>
        <span class="c">//////}</span>
    }
}</pre></td></tr></table></div></body></html>
