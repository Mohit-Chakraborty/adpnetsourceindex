<!DOCTYPE html>
<html><head><title>CustomClientWithHttpClientTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(225);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Rest.ClientRuntime.Tests/CustomClientWithHttpClientTests.cs" target="_top">CustomClientWithHttpClientTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Rest.ClientRuntime.Tests" target="_top">ClientRuntime\Tests\ClientRuntime.NetCore.Tests\ClientRuntime.NetCore.Tests.csproj</a> (Microsoft.Rest.ClientRuntime.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Rest</span>.<span class="i n">ClientRuntime</span>.<span class="i n">Tests</span>
{
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Rest</span>.<span class="i n">ClientRuntime</span>.<span class="i n">Tests</span>.<span class="i n">CustomClients</span>;
    <b>using</b> <span class="i">System</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Linq</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Net</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Net</span>.<span class="i">Http</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Net</span>.<span class="i">Http</span>.<span class="i">Headers</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Threading</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
    <b>using</b> <span class="i">Xunit</span>;
 
    <b>public class</b> <a id="2dc2a3417ccb1c4d" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="907d069c4969d099">CustomClientWithHttpClientTests</span></a>
    {
        <b>const string</b> <a id="05801c2a26789233" href="R/05801c2a26789233.html" target="n" data-glyph="10,1" class="i field">MY_PRODUCT</a> = <span class="s">&quot;MyProduct&quot;</span>;
        <b>const string</b> <a id="fde8886c24207778" href="R/fde8886c24207778.html" target="n" data-glyph="10,1" class="i field">MY_VERSION</a> = <span class="s">&quot;MyVersion&quot;</span>;
        <b>const string</b> <a id="176f34c4bd87caad" href="R/176f34c4bd87caad.html" target="n" data-glyph="10,1" class="i field">DEFAULT_URI</a> = <span class="s">&quot;http://www.microsoft.com&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Basic test to pass in simple HttpClient to the ServiceClient (Contoso)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public void</b> <a id="dcca14f224a102be" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">InitializeServiceClientWithHttpClient</a>()
        {
            <span class="i">HttpClient</span> <span id="r0 rd" class="r0 r">hc</span> = <b>new</b> <span class="i">HttpClient</span>();
            <a href="CustomClients/ContosoServiceClient.cs.html#1318cd86b3135155" class="t t">ContosoServiceClient</a> <span id="r1 rd" class="r1 r">contosoClient</span> = <b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#fcbe43f58b7cf3a8" class="t constructor">ContosoServiceClient</a>(<span class="r0 r">hc</span>);
            <span class="i">HttpResponseMessage</span> <span id="r2 rd" class="r2 r">response</span> = <span class="r1 r">contosoClient</span>.<a href="CustomClients/ContosoServiceClient.cs.html#b5778ffbf2f7510c" class="i method">DoSyncWork</a>();
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r2 r">response</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Pass in null HttpClient and get default HttpClient</span>
        <span class="c">///</span><span class="c"> Verify if baseClient httpClient has the default information</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public void</b> <a id="234ffcf5b4df0310" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetBaseClassHttpClient</a>()
        {
            <b>string</b> <span id="r3 rd" class="r3 r">defaultProductName</span> = <span class="s">&quot;FxVersion&quot;</span>;
            <span class="i">Version</span> <span id="r4 rd" class="r4 r">defaultProductVer</span>;
 
            <a href="CustomClients/ContosoServiceClient.cs.html#1318cd86b3135155" class="t t">ContosoServiceClient</a> <span id="r5 rd" class="r5 r">contosoClient</span> = <b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#1e2837334bd44704" class="t constructor">ContosoServiceClient</a>(<b>null</b>);
            <span class="i">HttpResponseMessage</span> <span id="r6 rd" class="r6 r">response</span> = <span class="r5 r">contosoClient</span>.<a href="CustomClients/ContosoServiceClient.cs.html#b5778ffbf2f7510c" class="i method">DoSyncWork</a>();
            <b>string</b> <span id="r7 rd" class="r7 r">cont</span> = <span class="r6 r">response</span>.<span class="i">Content</span>.<span class="i">ReadAsStringAsync</span>().<span class="i">ConfigureAwait</span>(<b>false</b>).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r6 r">response</span>);
 
            <span class="i">HttpHeaderValueCollection</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt; <span id="r8 rd" class="r8 r">userAgentValueCollection</span> = <span class="r5 r">contosoClient</span>.<span class="i">HttpClient</span>.<span class="i">DefaultRequestHeaders</span>.<span class="i">UserAgent</span>;
            <b>var</b> <span id="r9 rd" class="r9 r">dP</span> = <span class="r8 r">userAgentValueCollection</span>.<span class="i">Where</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt;((<span id="r10 rd" class="r10 r">p</span>) =&gt; <span class="r10 r">p</span>.<span class="i">Product</span>.<span class="i">Name</span>.<span class="i">Equals</span>(<span class="r3 r">defaultProductName</span>)).<span class="i">FirstOrDefault</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt;();
            <span class="i">Version</span>.<span class="i">TryParse</span>(<span class="r9 r">dP</span>.<span class="i">Product</span>.<span class="i">Version</span>, <b>out</b> <span class="r4 r">defaultProductVer</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="r3 r">defaultProductName</span>, <span class="r9 r">dP</span>.<span class="i">Product</span>.<span class="i">Name</span>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r4 r">defaultProductVer</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates Constoso Client with it&#39;s own handler</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public void</b> <a id="0177fbf91969bed3" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">InitializeMessageHandlerPostContructor</a>()
        {
            <span class="i">HttpClient</span> <span id="r11 rd" class="r11 r">hc</span> = <b>new</b> <span class="i">HttpClient</span>(<b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#42d7b628e493b36a" class="t constructor">ContosoMessageHandler</a>());
            <a href="CustomClients/ContosoServiceClient.cs.html#1318cd86b3135155" class="t t">ContosoServiceClient</a> <span id="r12 rd" class="r12 r">contosoClient</span> = <b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#fcbe43f58b7cf3a8" class="t constructor">ContosoServiceClient</a>(<span class="r11 r">hc</span>);
            <span class="i">HttpResponseMessage</span> <span id="r13 rd" class="r13 r">response</span> = <span class="r12 r">contosoClient</span>.<a href="CustomClients/ContosoServiceClient.cs.html#b5778ffbf2f7510c" class="i method">DoSyncWork</a>();
            <b>string</b> <span id="r14 rd" class="r14 r">cont</span> = <span class="r13 r">response</span>.<span class="i">Content</span>.<span class="i">ReadAsStringAsync</span>().<span class="i">ConfigureAwait</span>(<b>false</b>).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="s">&quot;Contoso Rocks&quot;</span>, <span class="r14 r">cont</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This test will create contoso client with delayedHandler</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public void</b> <a id="428b78489f928dda" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ProvideHttpClientAfterInitialization</a>()
        {
            <a href="CustomClients/ContosoServiceClient.cs.html#1318cd86b3135155" class="t t">ContosoServiceClient</a> <span id="r15 rd" class="r15 r">contosoClient</span> = <b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#1e2837334bd44704" class="t constructor">ContosoServiceClient</a>(<span class="r16 r">overRideDefaultHandler</span>: <b>true</b>);
            <span class="i">HttpResponseMessage</span> <span id="r17 rd" class="r17 r">response</span> = <span class="r15 r">contosoClient</span>.<a href="CustomClients/ContosoServiceClient.cs.html#b5778ffbf2f7510c" class="i method">DoSyncWork</a>();
            <b>string</b> <span id="r18 rd" class="r18 r">cont</span> = <span class="r17 r">response</span>.<span class="i">Content</span>.<span class="i">ReadAsStringAsync</span>().<span class="i">ConfigureAwait</span>(<b>false</b>).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="s">&quot;Delayed User Provided HttpClient after initialization&quot;</span>, <span class="r18 r">cont</span>);
        }
        
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The purpose of this test is to verify if we use httpClient prior to</span>
        <span class="c">///</span><span class="c"> creating service client, everything works as expected</span>
        <span class="c">///</span><span class="c"> Also verifies if any properties set prior to constructing ServiceClient</span>
        <span class="c">///</span><span class="c"> The provided httpClient will not change it&#39;s properties</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public void</b> <a id="090080f6b535e1b0" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UseHttpClientBeforeConstructingServiceClient</a>()
        {
            <span class="i">HttpClient</span> <span id="r19 rd" class="r19 r">hc</span> = <b>new</b> <span class="i">HttpClient</span>(<b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#42d7b628e493b36a" class="t constructor">ContosoMessageHandler</a>());
            <span class="r19 r">hc</span>.<span class="i">BaseAddress</span> = <b>new</b> <span class="i">Uri</span>(<a href="#176f34c4bd87caad" class="i field">DEFAULT_URI</a>);
            <span class="i">HttpResponseMessage</span> <span id="r20 rd" class="r20 r">resMsg</span> = <a href="#4e7fb2b6789178bf" class="i method">SendAndReceiveResponse</a>(<span class="r19 r">hc</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="i">HttpStatusCode</span>.<span class="i">OK</span>, <span class="r20 r">resMsg</span>.<span class="i">StatusCode</span>);
            
            <a href="CustomClients/ContosoServiceClient.cs.html#1318cd86b3135155" class="t t">ContosoServiceClient</a> <span id="r21 rd" class="r21 r">contosoClient</span> = <b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#fcbe43f58b7cf3a8" class="t constructor">ContosoServiceClient</a>(<span class="r19 r">hc</span>);
            <span class="i">HttpResponseMessage</span> <span id="r22 rd" class="r22 r">response</span> = <span class="r21 r">contosoClient</span>.<a href="CustomClients/ContosoServiceClient.cs.html#b5778ffbf2f7510c" class="i method">DoSyncWork</a>();
            <b>string</b> <span id="r23 rd" class="r23 r">cont</span> = <span class="r22 r">response</span>.<span class="i">Content</span>.<span class="i">ReadAsStringAsync</span>().<span class="i">ConfigureAwait</span>(<b>false</b>).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="s">&quot;Contoso Rocks&quot;</span>, <span class="r23 r">cont</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<b>new</b> <span class="i">Uri</span>(<a href="#176f34c4bd87caad" class="i field">DEFAULT_URI</a>), <span class="r21 r">contosoClient</span>.<span class="i">HttpClient</span>.<span class="i">BaseAddress</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test verifies that HttpClient provided to ServiceClient can be resued even after Disposing ServiceClient</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public void</b> <a id="875a69e88203912d" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UseHttpClientAfterServiceClientDispose</a>()
        {
            <span class="i">HttpClient</span> <span id="r24 rd" class="r24 r">hc</span> = <b>new</b> <span class="i">HttpClient</span>(<b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#42d7b628e493b36a" class="t constructor">ContosoMessageHandler</a>());
            <span class="r24 r">hc</span>.<span class="i">BaseAddress</span> = <b>new</b> <span class="i">Uri</span>(<a href="#176f34c4bd87caad" class="i field">DEFAULT_URI</a>);
            <span class="i">HttpResponseMessage</span> <span id="r25 rd" class="r25 r">resMsg</span> = <a href="#4e7fb2b6789178bf" class="i method">SendAndReceiveResponse</a>(<span class="r24 r">hc</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="i">HttpStatusCode</span>.<span class="i">OK</span>, <span class="r25 r">resMsg</span>.<span class="i">StatusCode</span>);
 
            <a href="CustomClients/ContosoServiceClient.cs.html#1318cd86b3135155" class="t t">ContosoServiceClient</a> <span id="r26 rd" class="r26 r">contosoClient</span> = <b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#fcbe43f58b7cf3a8" class="t constructor">ContosoServiceClient</a>(<span class="r24 r">hc</span>, <b>false</b>);
            <span class="i">HttpResponseMessage</span> <span id="r27 rd" class="r27 r">response</span> = <span class="r26 r">contosoClient</span>.<a href="CustomClients/ContosoServiceClient.cs.html#b5778ffbf2f7510c" class="i method">DoSyncWork</a>();
            <b>string</b> <span id="r28 rd" class="r28 r">cont</span> = <span class="r27 r">response</span>.<span class="i">Content</span>.<span class="i">ReadAsStringAsync</span>().<span class="i">ConfigureAwait</span>(<b>false</b>).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="s">&quot;Contoso Rocks&quot;</span>, <span class="r28 r">cont</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<b>new</b> <span class="i">Uri</span>(<a href="#176f34c4bd87caad" class="i field">DEFAULT_URI</a>), <span class="r26 r">contosoClient</span>.<span class="i">HttpClient</span>.<span class="i">BaseAddress</span>);
 
            <span class="r26 r">contosoClient</span>.<span class="i">Dispose</span>();
 
            <span class="i">HttpResponseMessage</span> <span id="r29 rd" class="r29 r">secondTimeMsg</span> = <a href="#4e7fb2b6789178bf" class="i method">SendAndReceiveResponse</a>(<span class="r24 r">hc</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="i">HttpStatusCode</span>.<span class="i">OK</span>, <span class="r29 r">secondTimeMsg</span>.<span class="i">StatusCode</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispose ServiceClient while request is being processed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public void</b> <a id="2d1aaaacaf574827" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">DisposeServiceClientWhileProcessingRequest</a>()
        {
            <span class="i">HttpClient</span> <span id="r30 rd" class="r30 r">hc</span> = <b>new</b> <span class="i">HttpClient</span>(<b>new</b> <span class="t">DelayedHandler</span>(<span class="s">&quot;DelayingResponse&quot;</span>, <span class="i">TimeSpan</span>.<span class="i">FromSeconds</span>(5)));
            <span class="r30 r">hc</span>.<span class="i">BaseAddress</span> = <b>new</b> <span class="i">Uri</span>(<a href="#176f34c4bd87caad" class="i field">DEFAULT_URI</a>);
            <span class="i">HttpResponseMessage</span> <span id="r31 rd" class="r31 r">resMsg</span> = <a href="#4e7fb2b6789178bf" class="i method">SendAndReceiveResponse</a>(<span class="r30 r">hc</span>);
            <b>string</b> <span id="r32 rd" class="r32 r">resStr</span> = <span class="r31 r">resMsg</span>.<span class="i">Content</span>.<span class="i">ReadAsStringAsync</span>().<span class="i">ConfigureAwait</span>(<b>false</b>).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="s">&quot;DelayingResponse&quot;</span>, <span class="r32 r">resStr</span>);
 
            <a href="CustomClients/ContosoServiceClient.cs.html#1318cd86b3135155" class="t t">ContosoServiceClient</a> <span id="r33 rd" class="r33 r">contosoClient</span> = <b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#fcbe43f58b7cf3a8" class="t constructor">ContosoServiceClient</a>(<span class="r30 r">hc</span>, <b>false</b>);
 
            <b>var</b> <span id="r34 rd" class="r34 r">result</span> = <span class="i">Task</span>.<span class="i">Run</span>&lt;<span class="i">HttpResponseMessage</span>&gt;(<b>async</b> () =&gt;
            {
                <b>return</b> <b>await</b> <span class="r33 r">contosoClient</span>.<a href="CustomClients/ContosoServiceClient.cs.html#41234d956823c9ff" class="i method">DoAsyncWork</a>();
            });
 
            <span class="r33 r">contosoClient</span>.<span class="i">Dispose</span>();
 
            <span class="i">HttpResponseMessage</span> <span id="r35 rd" class="r35 r">delayedResponse</span> = <span class="r34 r">result</span>.<span class="i">ConfigureAwait</span>(<b>false</b>).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
            <b>string</b> <span id="r36 rd" class="r36 r">delayedContent</span> = <span class="r35 r">delayedResponse</span>.<span class="i">Content</span>.<span class="i">ReadAsStringAsync</span>().<span class="i">ConfigureAwait</span>(<b>false</b>).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="s">&quot;DelayingResponse&quot;</span>, <span class="r36 r">delayedContent</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is to verify if a HttpClient is passed, we still add default userAgent information</span>
        <span class="c">///</span><span class="c"> inside defaultheaders of the passed in HttpClient</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public void</b> <a id="1de64db2b6fb05c2" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">NullReferenceExceptionAfterClientDispose</a>()
        {
            <a href="CustomClients/ContosoServiceClient.cs.html#1318cd86b3135155" class="t t">ContosoServiceClient</a> <span id="r37 rd" class="r37 r">contosoClient</span> = <b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#1e2837334bd44704" class="t constructor">ContosoServiceClient</a>(<b>null</b>);
            <span class="i">HttpResponseMessage</span> <span id="r38 rd" class="r38 r">response</span> = <span class="r37 r">contosoClient</span>.<a href="CustomClients/ContosoServiceClient.cs.html#b5778ffbf2f7510c" class="i method">DoSyncWork</a>();
            <b>string</b> <span id="r39 rd" class="r39 r">cont</span> = <span class="r38 r">response</span>.<span class="i">Content</span>.<span class="i">ReadAsStringAsync</span>().<span class="i">ConfigureAwait</span>(<b>false</b>).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r38 r">response</span>);
 
            <span class="r37 r">contosoClient</span>.<span class="i">Dispose</span>();
 
            <span class="i">Assert</span>.<span class="i">ThrowsAny</span>&lt;<span class="i">NullReferenceException</span>&gt;(() =&gt; <span class="i">SendAndReceiveResponse</span>(<span class="r37 r">contosoClient</span>.<span class="i">HttpClient</span>));
        }
 
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> THe HttpClient that is provided to ServiceClient will have it&#39;s own set of UserAgent information</span>
        <span class="c">///</span><span class="c"> inside default headers. This is to verify if we merge DefaultHeader information</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public void</b> <a id="6a30db78b710f8e0" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">AddHeaderInformationToHttpClient</a>()
        {
            <span class="i">Version</span> <span id="r40 rd" class="r40 r">defaultVersion</span> = <b>null</b>;
            <span class="i">HttpClient</span> <span id="r41 rd" class="r41 r">hc</span> = <b>new</b> <span class="i">HttpClient</span>(<b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#42d7b628e493b36a" class="t constructor">ContosoMessageHandler</a>());
            <span class="r41 r">hc</span>.<span class="i">DefaultRequestHeaders</span>.<span class="i">UserAgent</span>.<span class="i">Add</span>(<b>new</b> <span class="i">ProductInfoHeaderValue</span>(<a href="#05801c2a26789233" class="i field">MY_PRODUCT</a>, <a href="#fde8886c24207778" class="i field">MY_VERSION</a>));
            <a href="CustomClients/ContosoServiceClient.cs.html#1318cd86b3135155" class="t t">ContosoServiceClient</a> <span id="r42 rd" class="r42 r">contosoClient</span> = <b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#fcbe43f58b7cf3a8" class="t constructor">ContosoServiceClient</a>(<span class="r41 r">hc</span>);
            <span class="i">HttpResponseMessage</span> <span id="r43 rd" class="r43 r">response</span> = <span class="r42 r">contosoClient</span>.<a href="CustomClients/ContosoServiceClient.cs.html#b5778ffbf2f7510c" class="i method">DoSyncWork</a>();
 
            <span class="i">HttpHeaderValueCollection</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt; <span id="r44 rd" class="r44 r">userAgentValueCollection</span> = <span class="r42 r">contosoClient</span>.<span class="i">HttpClient</span>.<span class="i">DefaultRequestHeaders</span>.<span class="i">UserAgent</span>;
            <span class="i">ProductInfoHeaderValue</span> <span id="r45 rd" class="r45 r">myProduct</span> = <span class="r44 r">userAgentValueCollection</span>.<span class="i">Where</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt;((<span id="r46 rd" class="r46 r">p</span>) =&gt; <span class="r46 r">p</span>.<span class="i">Product</span>.<span class="i">Name</span>.<span class="i">Equals</span>(<a href="#05801c2a26789233" class="i field">MY_PRODUCT</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)).<span class="i">First</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt;();
            <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="#fde8886c24207778" class="i field">MY_VERSION</a>, <span class="r45 r">myProduct</span>.<span class="i">Product</span>.<span class="i">Version</span>);
 
            <span class="i">ProductInfoHeaderValue</span> <span id="r47 rd" class="r47 r">fxVer</span> = <span class="r44 r">userAgentValueCollection</span>.<span class="i">Where</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt;((<span id="r48 rd" class="r48 r">p</span>) =&gt; <span class="r48 r">p</span>.<span class="i">Product</span>.<span class="i">Name</span>.<span class="i">Equals</span>(<span class="s">&quot;FxVersion&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)).<span class="i">First</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt;();
            <span class="i">Version</span>.<span class="i">TryParse</span>(<span class="r47 r">fxVer</span>.<span class="i">Product</span>.<span class="i">Version</span>, <b>out</b> <span class="r40 r">defaultVersion</span>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r40 r">defaultVersion</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is to verify if a HttpClient is passed, we still add default userAgent information</span>
        <span class="c">///</span><span class="c"> inside defaultheaders of the passed in HttpClient</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public void</b> <a id="93d915a5b3a7a606" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">AddFxVersionHeaderInformation</a>()
        {
            <span class="i">Version</span> <span id="r49 rd" class="r49 r">defaultVersion</span> = <b>null</b>;
            <span class="i">HttpClient</span> <span id="r50 rd" class="r50 r">hc</span> = <b>new</b> <span class="i">HttpClient</span>(<b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#42d7b628e493b36a" class="t constructor">ContosoMessageHandler</a>());
            <span class="r50 r">hc</span>.<span class="i">DefaultRequestHeaders</span>.<span class="i">UserAgent</span>.<span class="i">Add</span>(<b>new</b> <span class="i">ProductInfoHeaderValue</span>(<span class="s">&quot;FxVersion&quot;</span>, <span class="s">&quot;1.0.0.0&quot;</span>));
            <a href="CustomClients/ContosoServiceClient.cs.html#1318cd86b3135155" class="t t">ContosoServiceClient</a> <span id="r51 rd" class="r51 r">contosoClient</span> = <b>new</b> <a href="CustomClients/ContosoServiceClient.cs.html#fcbe43f58b7cf3a8" class="t constructor">ContosoServiceClient</a>(<span class="r50 r">hc</span>);
            <span class="i">HttpResponseMessage</span> <span id="r52 rd" class="r52 r">response</span> = <span class="r51 r">contosoClient</span>.<a href="CustomClients/ContosoServiceClient.cs.html#b5778ffbf2f7510c" class="i method">DoSyncWork</a>();
 
            <span class="i">HttpHeaderValueCollection</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt; <span id="r53 rd" class="r53 r">userAgentValueCollection</span> = <span class="r51 r">contosoClient</span>.<span class="i">HttpClient</span>.<span class="i">DefaultRequestHeaders</span>.<span class="i">UserAgent</span>;
            <span class="i">ProductInfoHeaderValue</span> <span id="r54 rd" class="r54 r">fxVer</span> = <span class="r53 r">userAgentValueCollection</span>.<span class="i">Where</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt;((<span id="r55 rd" class="r55 r">p</span>) =&gt; <span class="r55 r">p</span>.<span class="i">Product</span>.<span class="i">Name</span>.<span class="i">Equals</span>(<span class="s">&quot;FxVersion&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)).<span class="i">First</span>&lt;<span class="i">ProductInfoHeaderValue</span>&gt;();
            <span class="i">Version</span>.<span class="i">TryParse</span>(<span class="r54 r">fxVer</span>.<span class="i">Product</span>.<span class="i">Version</span>, <b>out</b> <span class="r49 r">defaultVersion</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="r49 r">defaultVersion</span>.<span class="i">ToString</span>(), <span class="s">&quot;1.0.0.0&quot;</span>);
        }
 
        <b>private</b> <span class="i">HttpResponseMessage</span> <a id="4e7fb2b6789178bf" href="R/4e7fb2b6789178bf.html" target="n" data-glyph="76,1" class="i method">SendAndReceiveResponse</a>(<span class="i">HttpClient</span> <span id="r56 rd" class="r56 r">httpClient</span>)
        {
            <span class="c">// Create HTTP transport objects</span>
            <span class="i">HttpRequestMessage</span> <span id="r57 rd" class="r57 r">_httpRequest</span> = <b>null</b>;
 
            <span class="r57 r">_httpRequest</span> = <b>new</b> <span class="i">HttpRequestMessage</span>();
            <span class="r57 r">_httpRequest</span>.<span class="i">Method</span> = <span class="i">HttpMethod</span>.<span class="i">Get</span>;
            <span class="r57 r">_httpRequest</span>.<span class="i">RequestUri</span> = <b>new</b> <span class="i">Uri</span>(<a href="#176f34c4bd87caad" class="i field">DEFAULT_URI</a>);
 
            <span class="c">// Set Headers</span>
            <span class="r57 r">_httpRequest</span>.<span class="i">Headers</span>.<span class="i">Add</span>(<span class="s">&quot;x-ms-version&quot;</span>, <span class="s">&quot;2013-11-01&quot;</span>);
            <b>return</b> <span class="i">Task</span>.<span class="i">Run</span>&lt;<span class="i">HttpResponseMessage</span>&gt;(<b>async</b> () =&gt; <b>await</b> <span class="r56 r">httpClient</span>.<span class="i">SendAsync</span>(<span class="r57 r">_httpRequest</span>, <b>new</b> <span class="i">CancellationToken</span>()).<span class="i">ConfigureAwait</span>(<b>false</b>)).<span class="i">ConfigureAwait</span>(<b>false</b>).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
        }
    }
}
</pre></td></tr></table></div></body></html>
