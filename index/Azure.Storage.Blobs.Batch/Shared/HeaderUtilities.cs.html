<!DOCTYPE html>
<html><head><title>HeaderUtilities.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(765);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Storage.Blobs.Batch/Shared/HeaderUtilities.cs" target="_top">Shared\HeaderUtilities.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Storage.Blobs.Batch" target="_top">Azure.Storage.Blobs.Batch.csproj</a> (Azure.Storage.Blobs.Batch)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="c">// Copied from https://github.com/aspnet/AspNetCore/tree/master/src/Http/Headers/src</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i n">Contracts</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Globalization</span>;
 
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">CA1305</span>  <span class="c">// ToString Locale</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">CA1802</span>  <span class="c">// const fields</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">IDE0008</span> <span class="c">// Use explicit type</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">IDE0018</span> <span class="c">// Inline declaration</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">IDE0054</span> <span class="c">// Use compound assignment</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">IDE0051</span> <span class="c">// Unused private member</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">IDE0059</span> <span class="c">// Unnecessary assignment</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">IDE1006</span> <span class="c">// Missing s_ prefix</span>
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">Http</span>.<span class="i n">Multipart</span>
{
    <b>internal static class</b> <a id="00e7f45320b1d86d" href="../R/00e7f45320b1d86d.html" target="n" data-glyph="2,0" class="t t">HeaderUtilities</a>
    {
        <b>private static readonly int</b> <a id="c2236a975cd79879" href="../R/c2236a975cd79879.html" target="n" data-glyph="46,1" class="i field">_int64MaxStringLength</a> = 19;
        <b>private static readonly int</b> <a id="c3089ad89cb0be60" href="../R/c3089ad89cb0be60.html" target="n" data-glyph="46,1" class="i field">_qualityValueMaxCharCount</a> = 10; <span class="c">// Little bit more permissive than RFC7231 5.3.1</span>
        <b>private const string</b> <a id="75ddad26389cde30" href="../R/75ddad26389cde30.html" target="n" data-glyph="10,1" class="i field">QualityName</a> = <span class="s">&quot;q&quot;</span>;
        <b>internal const string</b> <a id="4735b54cf2140dfc" href="../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">BytesUnit</a> = <span class="s">&quot;bytes&quot;</span>;
 
        <b>internal static void</b> <a id="42f0cd78c1fcc5e0" href="../R/42f0cd78c1fcc5e0.html" target="n" data-glyph="74,1" class="i method">SetQuality</a>(<a href="@1@netstandard/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="NameValueHeaderValue.cs.html#918174b994ea58a4" class="t t">NameValueHeaderValue</a>&gt; <span id="r0 rd" class="r0 r">parameters</span>, <b>double</b>? <span id="r1 rd" class="r1 r">value</span>)
        {
            <a href="@1@netstandard/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@1@netstandard/A.html#1f51ef07e80c9b68" class="i method">Requires</a>(<span class="r0 r">parameters</span> != <b>null</b>);
 
            <a href="NameValueHeaderValue.cs.html#918174b994ea58a4" class="k">var</a> <span id="r2 rd" class="r2 r">qualityParameter</span> = <a href="NameValueHeaderValue.cs.html#918174b994ea58a4" class="t t">NameValueHeaderValue</a>.<a href="NameValueHeaderValue.cs.html#fc249570450c5247" class="i method">Find</a>(<span class="r0 r">parameters</span>, <a href="#75ddad26389cde30" class="i field">QualityName</a>);
            <b>if</b> (<span class="r1 r">value</span>.<a href="@1@netstandard/A.html#7bbe60e33e857298" class="i property">HasValue</a>)
            {
                <span class="c">// Note that even if we check the value here, we can&#39;t prevent a user from adding an invalid quality</span>
                <span class="c">// value using Parameters.Add(). Even if we would prevent the user from adding an invalid value</span>
                <span class="c">// using Parameters.Add() he could always add invalid values using HttpHeaders.AddWithoutValidation().</span>
                <span class="c">// So this check is really for convenience to show users that they&#39;re trying to add an invalid</span>
                <span class="c">// value.</span>
                <b>if</b> ((<span class="r1 r">value</span> &lt; 0) || (<span class="r1 r">value</span> &gt; 1))
                {
                    <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#5fec5e06371b1f6c" class="t constructor">ArgumentOutOfRangeException</a>(<b>nameof</b>(<span class="r1 r">value</span>));
                }
 
                <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r3 rd" class="r3 r">qualityString</span> = ((<b>double</b>)<span class="r1 r">value</span>).<a href="@1@netstandard/A.html#73d3e678dc781387" class="i method">ToString</a>(<span class="s">&quot;0.0##&quot;</span>, <a href="@1@netstandard/A.html#a5002cb4e584a151" class="t t">NumberFormatInfo</a>.<a href="@1@netstandard/A.html#cf7e50019ddcbfc6" class="i property">InvariantInfo</a>);
                <b>if</b> (<span class="r2 r">qualityParameter</span> != <b>null</b>)
                {
                    <span class="r2 r">qualityParameter</span>.<a href="NameValueHeaderValue.cs.html#ddfbf4af43f73ded" class="i property">Value</a> = <span class="r3 r">qualityString</span>;
                }
                <b>else</b>
                {
                    <span class="r0 r">parameters</span>.<a href="@1@netstandard/A.html#a9319db8c62ae453" class="i method">Add</a>(<b>new</b> <a href="NameValueHeaderValue.cs.html#77ca47b9a45a33ab" class="t constructor">NameValueHeaderValue</a>(<a href="#75ddad26389cde30" class="i field">QualityName</a>, <span class="r3 r">qualityString</span>));
                }
            }
            <b>else</b>
            {
                <span class="c">// Remove quality parameter</span>
                <b>if</b> (<span class="r2 r">qualityParameter</span> != <b>null</b>)
                {
                    <span class="r0 r">parameters</span>.<a href="@1@netstandard/A.html#12ab6cfa5ca2ceec" class="i method">Remove</a>(<span class="r2 r">qualityParameter</span>);
                }
            }
        }
 
        <b>internal static double</b>? <a id="a7ff156e36903bee" href="../R/a7ff156e36903bee.html" target="n" data-glyph="74,1" class="i method">GetQuality</a>(<a href="@1@netstandard/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="NameValueHeaderValue.cs.html#918174b994ea58a4" class="t t">NameValueHeaderValue</a>&gt; <span id="r4 rd" class="r4 r">parameters</span>)
        {
            <a href="@1@netstandard/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@1@netstandard/A.html#1f51ef07e80c9b68" class="i method">Requires</a>(<span class="r4 r">parameters</span> != <b>null</b>);
 
            <a href="NameValueHeaderValue.cs.html#918174b994ea58a4" class="k">var</a> <span id="r5 rd" class="r5 r">qualityParameter</span> = <a href="NameValueHeaderValue.cs.html#918174b994ea58a4" class="t t">NameValueHeaderValue</a>.<a href="NameValueHeaderValue.cs.html#fc249570450c5247" class="i method">Find</a>(<span class="r4 r">parameters</span>, <a href="#75ddad26389cde30" class="i field">QualityName</a>);
            <b>if</b> (<span class="r5 r">qualityParameter</span> != <b>null</b>)
            {
                <span class="c">// Note that the RFC requires decimal &#39;.&#39; regardless of the culture. I.e. using &#39;,&#39; as decimal</span>
                <span class="c">// separator is considered invalid (even if the current culture would allow it).</span>
                <b>if</b> (<a href="#17eff2585e691947" class="i method">TryParseQualityDouble</a>(<span class="r5 r">qualityParameter</span>.<a href="NameValueHeaderValue.cs.html#ddfbf4af43f73ded" class="i property">Value</a>, 0, <b>out</b> <a href="@1@netstandard/A.html#1a65cbdb09544ba1" class="k">var</a> <span id="r6 rd" class="r6 r">qualityValue</span>, <b>out</b> <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r7 rd" class="r7 r">length</span>))
                {
                    <b>return</b> <span class="r6 r">qualityValue</span>;
                }
            }
            <b>return</b> <b>null</b>;
        }
 
        <b>internal static void</b> <a id="810ab376c32db714" href="../R/810ab376c32db714.html" target="n" data-glyph="74,1" class="i method">CheckValidToken</a>(<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <span id="r8 rd" class="r8 r">value</span>, <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r9 rd" class="r9 r">parameterName</span>)
        {
            <b>if</b> (<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a>.<a href="StringSegment.cs.html#a1f6454b10e90428" class="i method">IsNullOrEmpty</a>(<span class="r8 r">value</span>))
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#4b20cd3790b6426a" class="t constructor">ArgumentException</a>(<span class="s">&quot;An empty string is not allowed.&quot;</span>, <span class="r9 r">parameterName</span>);
            }
 
            <b>if</b> (<a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#a8ee38d5d1490b1f" class="i method">GetTokenLength</a>(<span class="r8 r">value</span>, 0) != <span class="r8 r">value</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a>)
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#172972c225b16e44" class="t constructor">FormatException</a>(<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#c07c3772222caaff" class="i method">Format</a>(<a href="@1@netstandard/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@1@netstandard/A.html#26ef1c020f0dbb7a" class="i property">InvariantCulture</a>, <span class="s">&quot;Invalid token &#39;{0}.&quot;</span>, <span class="r8 r">value</span>));
            }
        }
 
        <b>internal static bool</b> <a id="0fb572d3aae6b335" href="../R/0fb572d3aae6b335.html" target="n" data-glyph="74,1" class="i method">AreEqualCollections</a>&lt;<span id="r10 rd t" class="r10 r t">T</span>&gt;(<a href="@1@netstandard/A.html#a9bf1395d3addc77" class="t t">ICollection</a>&lt;<span class="r10 r t">T</span>&gt; <span id="r11 rd" class="r11 r">x</span>, <a href="@1@netstandard/A.html#a9bf1395d3addc77" class="t t">ICollection</a>&lt;<span class="r10 r t">T</span>&gt; <span id="r12 rd" class="r12 r">y</span>)
        {
            <b>return</b> <a href="#97d1303bd4c5658c" class="i method">AreEqualCollections</a>(<span class="r11 r">x</span>, <span class="r12 r">y</span>, <b>null</b>);
        }
 
        <b>internal static bool</b> <a id="97d1303bd4c5658c" href="../R/97d1303bd4c5658c.html" target="n" data-glyph="74,1" class="i method">AreEqualCollections</a>&lt;<span id="r13 rd t" class="r13 r t">T</span>&gt;(<a href="@1@netstandard/A.html#a9bf1395d3addc77" class="t t">ICollection</a>&lt;<span class="r13 r t">T</span>&gt; <span id="r14 rd" class="r14 r">x</span>, <a href="@1@netstandard/A.html#a9bf1395d3addc77" class="t t">ICollection</a>&lt;<span class="r13 r t">T</span>&gt; <span id="r15 rd" class="r15 r">y</span>, <a href="@1@netstandard/A.html#66a06cfe895400c7" class="t t">IEqualityComparer</a>&lt;<span class="r13 r t">T</span>&gt; <span id="r16 rd" class="r16 r">comparer</span>)
        {
            <b>if</b> (<span class="r14 r">x</span> == <b>null</b>)
            {
                <b>return</b> (<span class="r15 r">y</span> == <b>null</b>) || (<span class="r15 r">y</span>.<a href="@1@netstandard/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == 0);
            }
 
            <b>if</b> (<span class="r15 r">y</span> == <b>null</b>)
            {
                <b>return</b> (<span class="r14 r">x</span>.<a href="@1@netstandard/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == 0);
            }
 
            <b>if</b> (<span class="r14 r">x</span>.<a href="@1@netstandard/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> != <span class="r15 r">y</span>.<a href="@1@netstandard/A.html#3d6c21c4e9bd5f63" class="i property">Count</a>)
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>if</b> (<span class="r14 r">x</span>.<a href="@1@netstandard/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == 0)
            {
                <b>return</b> <b>true</b>;
            }
 
            <span class="c">// We have two unordered lists. So comparison is an O(n*m) operation which is expensive. Usually</span>
            <span class="c">// headers have 1-2 parameters (if any), so this comparison shouldn&#39;t be too expensive.</span>
            <b>var</b> <span id="r17 rd" class="r17 r">alreadyFound</span> = <b>new</b> <b>bool</b>[<span class="r14 r">x</span>.<a href="@1@netstandard/A.html#3d6c21c4e9bd5f63" class="i property">Count</a>];
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r18 rd" class="r18 r">i</span> = 0;
            <b>foreach</b> (<span class="r13 r t">var</span> <span id="r19 rd" class="r19 r">xItem</span> <b>in</b> <span class="r14 r">x</span>)
            {
                <a href="@1@netstandard/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@1@netstandard/A.html#e87e73b73368f052" class="i method">Assert</a>(<span class="r19 r">xItem</span> != <b>null</b>);
 
                <span class="r18 r">i</span> = 0;
                <a href="@1@netstandard/A.html#f1b135ff6c380b37" class="k">var</a> <span id="r20 rd" class="r20 r">found</span> = <b>false</b>;
                <b>foreach</b> (<span class="r13 r t">var</span> <span id="r21 rd" class="r21 r">yItem</span> <b>in</b> <span class="r15 r">y</span>)
                {
                    <b>if</b> (!<span class="r17 r">alreadyFound</span>[<span class="r18 r">i</span>])
                    {
                        <b>if</b> (((<span class="r16 r">comparer</span> == <b>null</b>) &amp;&amp; <span class="r19 r">xItem</span>.<a href="@1@netstandard/A.html#517682d5f6f4f8b4" class="i method">Equals</a>(<span class="r21 r">yItem</span>)) ||
                            ((<span class="r16 r">comparer</span> != <b>null</b>) &amp;&amp; <span class="r16 r">comparer</span>.<a href="@1@netstandard/A.html#fef57190b3709891" class="i method">Equals</a>(<span class="r19 r">xItem</span>, <span class="r21 r">yItem</span>)))
                        {
                            <span class="r17 r">alreadyFound</span>[<span class="r18 r">i</span>] = <b>true</b>;
                            <span class="r20 r">found</span> = <b>true</b>;
                            <b>break</b>;
                        }
                    }
                    <span class="r18 r">i</span>++;
                }
 
                <b>if</b> (!<span class="r20 r">found</span>)
                {
                    <b>return</b> <b>false</b>;
                }
            }
 
            <span class="c">// Since we never re-use a &quot;found&quot; value in &#39;y&#39;, we expected &#39;alreadyFound&#39; to have all fields set to &#39;true&#39;.</span>
            <span class="c">// Otherwise the two collections can&#39;t be equal and we should not get here.</span>
            <a href="@1@netstandard/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@1@netstandard/A.html#e1f5696175c73b50" class="i method">Assert</a>(<a href="@1@netstandard/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@1@netstandard/A.html#fe16a8cf7f086e6f" class="i method">ForAll</a>(<span class="r17 r">alreadyFound</span>, <span id="r22 rd" class="r22 r">value</span> =&gt; { <b>return</b> <span class="r22 r">value</span>; }),
                <span class="s">&quot;Expected all values in &#39;alreadyFound&#39; to be true since collections are considered equal.&quot;</span>);
 
            <b>return</b> <b>true</b>;
        }
 
        <b>internal static int</b> <a id="96499c140cc0c4d8" href="../R/96499c140cc0c4d8.html" target="n" data-glyph="74,1" class="i method">GetNextNonEmptyOrWhitespaceIndex</a>(
            <a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <span id="r23 rd" class="r23 r">input</span>,
            <b>int</b> <span id="r24 rd" class="r24 r">startIndex</span>,
            <b>bool</b> <span id="r25 rd" class="r25 r">skipEmptyValues</span>,
            <b>out bool</b> <span id="r26 rd" class="r26 r">separatorFound</span>)
        {
            <a href="@1@netstandard/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@1@netstandard/A.html#1f51ef07e80c9b68" class="i method">Requires</a>(<span class="r23 r">input</span> != <b>null</b>);
            <a href="@1@netstandard/A.html#c575dbe300e57438" class="t t">Contract</a>.<a href="@1@netstandard/A.html#1f51ef07e80c9b68" class="i method">Requires</a>(<span class="r24 r">startIndex</span> &lt;= <span class="r23 r">input</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a>); <span class="c">// it&#39;s OK if index == value.Length.</span>
 
            <span class="r26 r">separatorFound</span> = <b>false</b>;
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r27 rd" class="r27 r">current</span> = <span class="r24 r">startIndex</span> + <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#aa08733b07353cff" class="i method">GetWhitespaceLength</a>(<span class="r23 r">input</span>, <span class="r24 r">startIndex</span>);
 
            <b>if</b> ((<span class="r27 r">current</span> == <span class="r23 r">input</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a>) || (<span class="r23 r">input</span><a href="StringSegment.cs.html#082fd93c33d8dcf9">[</a><span class="r27 r">current</span>] != <span class="s">&#39;,&#39;</span>))
            {
                <b>return</b> <span class="r27 r">current</span>;
            }
 
            <span class="c">// If we have a separator, skip the separator and all following whitespaces. If we support</span>
            <span class="c">// empty values, continue until the current character is neither a separator nor a whitespace.</span>
            <span class="r26 r">separatorFound</span> = <b>true</b>;
            <span class="r27 r">current</span>++; <span class="c">// skip delimiter.</span>
            <span class="r27 r">current</span> = <span class="r27 r">current</span> + <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#aa08733b07353cff" class="i method">GetWhitespaceLength</a>(<span class="r23 r">input</span>, <span class="r27 r">current</span>);
 
            <b>if</b> (<span class="r25 r">skipEmptyValues</span>)
            {
                <b>while</b> ((<span class="r27 r">current</span> &lt; <span class="r23 r">input</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a>) &amp;&amp; (<span class="r23 r">input</span><a href="StringSegment.cs.html#082fd93c33d8dcf9">[</a><span class="r27 r">current</span>] == <span class="s">&#39;,&#39;</span>))
                {
                    <span class="r27 r">current</span>++; <span class="c">// skip delimiter.</span>
                    <span class="r27 r">current</span> = <span class="r27 r">current</span> + <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#aa08733b07353cff" class="i method">GetWhitespaceLength</a>(<span class="r23 r">input</span>, <span class="r27 r">current</span>);
                }
            }
 
            <b>return</b> <span class="r27 r">current</span>;
        }
 
        <b>private static int</b> <a id="ab6844fc7c2f0aa3" href="../R/ab6844fc7c2f0aa3.html" target="n" data-glyph="76,1" class="i method">AdvanceCacheDirectiveIndex</a>(<b>int</b> <span id="r28 rd" class="r28 r">current</span>, <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r29 rd" class="r29 r">headerValue</span>)
        {
            <span class="c">// Skip until the next potential name</span>
            <span class="r28 r">current</span> += <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#aa08733b07353cff" class="i method">GetWhitespaceLength</a>(<span class="r29 r">headerValue</span>, <span class="r28 r">current</span>);
 
            <span class="c">// Skip the value if present</span>
            <b>if</b> (<span class="r28 r">current</span> &lt; <span class="r29 r">headerValue</span>.<a href="@1@netstandard/A.html#e13f5829ef28aa07" class="i property">Length</a> &amp;&amp; <span class="r29 r">headerValue</span><a href="@1@netstandard/A.html#8307d03426b56fe1">[</a><span class="r28 r">current</span>] == <span class="s">&#39;=&#39;</span>)
            {
                <span class="r28 r">current</span>++; <span class="c">// skip &#39;=&#39;</span>
                <span class="r28 r">current</span> += <a href="NameValueHeaderValue.cs.html#918174b994ea58a4" class="t t">NameValueHeaderValue</a>.<a href="NameValueHeaderValue.cs.html#8452ee3ad26ba480" class="i method">GetValueLength</a>(<span class="r29 r">headerValue</span>, <span class="r28 r">current</span>);
            }
 
            <span class="c">// Find the next delimiter</span>
            <span class="r28 r">current</span> = <span class="r29 r">headerValue</span>.<a href="@1@netstandard/A.html#a3e563d9d6528abf" class="i method">IndexOf</a>(<span class="s">&#39;,&#39;</span>, <span class="r28 r">current</span>);
 
            <b>if</b> (<span class="r28 r">current</span> == -1)
            {
                <span class="c">// If no delimiter found, skip to the end</span>
                <b>return</b> <span class="r29 r">headerValue</span>.<a href="@1@netstandard/A.html#e13f5829ef28aa07" class="i property">Length</a>;
            }
 
            <span class="r28 r">current</span>++; <span class="c">// skip &#39;,&#39;</span>
            <span class="r28 r">current</span> += <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#aa08733b07353cff" class="i method">GetWhitespaceLength</a>(<span class="r29 r">headerValue</span>, <span class="r28 r">current</span>);
 
            <b>return</b> <span class="r28 r">current</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Try to find a target header value among the set of given header values and parse it as a</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="@1@netstandard/A.html#865ef7b89f41b632" class="t t">TimeSpan</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">headerValues</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="StringValues.cs.html#956b282cb850a5ca" class="t t">StringValues</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> containing the set of header values to search.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">targetValue</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The target header value to look for.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r32 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When this method returns, contains the parsed </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="@1@netstandard/A.html#865ef7b89f41b632" class="t t">TimeSpan</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">, if the parsing succeeded, or</span>
        <span class="c">///</span><span class="c"> null if the parsing failed. The conversion fails if the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">targetValue</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> was not</span>
        <span class="c">///</span><span class="c"> found or could not be parsed as a </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="@1@netstandard/A.html#865ef7b89f41b632" class="t t">TimeSpan</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">. This parameter is passed uninitialized;</span>
        <span class="c">///</span><span class="c"> any value originally supplied in result will be overwritten.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span><span class="c"> if </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">targetValue</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is found and successfully parsed; otherwise,</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">// e.g. { &quot;headerValue=10, targetHeaderValue=30&quot; }</span>
        <b>public static bool</b> <a id="d35a8301df98a2fd" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TryParseSeconds</a>(<a href="StringValues.cs.html#956b282cb850a5ca" class="t t">StringValues</a> <span id="r30 rd" class="r30 r">headerValues</span>, <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r31 rd" class="r31 r">targetValue</span>, <b>out</b> <a href="@1@netstandard/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>? <span id="r32 rd" class="r32 r">value</span>)
        {
            <b>if</b> (<a href="StringValues.cs.html#956b282cb850a5ca" class="t t">StringValues</a>.<a href="StringValues.cs.html#67d03baa9d7480fa" class="i method">IsNullOrEmpty</a>(<span class="r30 r">headerValues</span>) || <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r31 r">targetValue</span>))
            {
                <span class="r32 r">value</span> = <b>null</b>;
                <b>return</b> <b>false</b>;
            }
 
            <b>for</b> (<a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r33 rd" class="r33 r">i</span> = 0; <span class="r33 r">i</span> &lt; <span class="r30 r">headerValues</span>.<a href="StringValues.cs.html#e3735d4c34c94b60" class="i property">Count</a>; <span class="r33 r">i</span>++)
            {
                <span class="c">// Trim leading white space</span>
                <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r34 rd" class="r34 r">current</span> = <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#aa08733b07353cff" class="i method">GetWhitespaceLength</a>(<span class="r30 r">headerValues</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r33 r">i</span>], 0);
 
                <b>while</b> (<span class="r34 r">current</span> &lt; <span class="r30 r">headerValues</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r33 r">i</span>].<a href="@1@netstandard/A.html#e13f5829ef28aa07" class="i property">Length</a>)
                {
                    <b>long</b> <span id="r35 rd" class="r35 r">seconds</span>;
                    <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r36 rd" class="r36 r">initial</span> = <span class="r34 r">current</span>;
                    <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r37 rd" class="r37 r">tokenLength</span> = <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#a8ee38d5d1490b1f" class="i method">GetTokenLength</a>(<span class="r30 r">headerValues</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r33 r">i</span>], <span class="r34 r">current</span>);
                    <b>if</b> (<span class="r37 r">tokenLength</span> == <span class="r31 r">targetValue</span>.<a href="@1@netstandard/A.html#e13f5829ef28aa07" class="i property">Length</a>
                        &amp;&amp; <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#1ae4d07b01230bb6" class="i method">Compare</a>(<span class="r30 r">headerValues</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r33 r">i</span>], <span class="r34 r">current</span>, <span class="r31 r">targetValue</span>, 0, <span class="r37 r">tokenLength</span>, <a href="@1@netstandard/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@netstandard/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>) == 0
                        &amp;&amp; <a href="#abc7c78a3c404d0c" class="i method">TryParseNonNegativeInt64FromHeaderValue</a>(<span class="r34 r">current</span> + <span class="r37 r">tokenLength</span>, <span class="r30 r">headerValues</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r33 r">i</span>], <b>out</b> <span class="r35 r">seconds</span>))
                    {
                        <span class="c">// Token matches target value and seconds were parsed</span>
                        <span class="r32 r">value</span> = <a href="@1@netstandard/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@1@netstandard/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(<span class="r35 r">seconds</span>);
                        <b>return</b> <b>true</b>;
                    }
 
                    <span class="r34 r">current</span> = <a href="#ab6844fc7c2f0aa3" class="i method">AdvanceCacheDirectiveIndex</a>(<span class="r34 r">current</span> + <span class="r37 r">tokenLength</span>, <span class="r30 r">headerValues</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r33 r">i</span>]);
 
                    <span class="c">// Ensure index was advanced</span>
                    <b>if</b> (<span class="r34 r">current</span> &lt;= <span class="r36 r">initial</span>)
                    {
                        <a href="@1@netstandard/A.html#632c6da37ce825df" class="t t">Debug</a>.<a href="@1@netstandard/A.html#4f55cf5792dfc5e6" class="i method">Assert</a>(<b>false</b>, <span class="s">$&quot;</span><span class="s">Index &#39;</span>{<b>nameof</b>(<span class="r34 r">current</span>)}<span class="s">&#39; not advanced, this is a bug.</span><span class="s">&quot;</span>);
                        <span class="r32 r">value</span> = <b>null</b>;
                        <b>return</b> <b>false</b>;
                    }
                }
            }
            <span class="r32 r">value</span> = <b>null</b>;
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check if a target directive exists among the set of given cache control directives.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r38 r">cacheControlDirectives</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="StringValues.cs.html#956b282cb850a5ca" class="t t">StringValues</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> containing the set of cache control directives.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r39 r">targetDirectives</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The target cache control directives to look for.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span><span class="c"> if </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r39 r">targetDirectives</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is contained in </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r38 r">cacheControlDirectives</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">;</span>
        <span class="c">///</span><span class="c"> otherwise, </span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static bool</b> <a id="1b918af498f70df5" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ContainsCacheDirective</a>(<a href="StringValues.cs.html#956b282cb850a5ca" class="t t">StringValues</a> <span id="r38 rd" class="r38 r">cacheControlDirectives</span>, <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r39 rd" class="r39 r">targetDirectives</span>)
        {
            <b>if</b> (<a href="StringValues.cs.html#956b282cb850a5ca" class="t t">StringValues</a>.<a href="StringValues.cs.html#67d03baa9d7480fa" class="i method">IsNullOrEmpty</a>(<span class="r38 r">cacheControlDirectives</span>) || <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r39 r">targetDirectives</span>))
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>for</b> (<a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r40 rd" class="r40 r">i</span> = 0; <span class="r40 r">i</span> &lt; <span class="r38 r">cacheControlDirectives</span>.<a href="StringValues.cs.html#e3735d4c34c94b60" class="i property">Count</a>; <span class="r40 r">i</span>++)
            {
                <span class="c">// Trim leading white space</span>
                <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r41 rd" class="r41 r">current</span> = <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#aa08733b07353cff" class="i method">GetWhitespaceLength</a>(<span class="r38 r">cacheControlDirectives</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r40 r">i</span>], 0);
 
                <b>while</b> (<span class="r41 r">current</span> &lt; <span class="r38 r">cacheControlDirectives</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r40 r">i</span>].<a href="@1@netstandard/A.html#e13f5829ef28aa07" class="i property">Length</a>)
                {
                    <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r42 rd" class="r42 r">initial</span> = <span class="r41 r">current</span>;
 
                    <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r43 rd" class="r43 r">tokenLength</span> = <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#a8ee38d5d1490b1f" class="i method">GetTokenLength</a>(<span class="r38 r">cacheControlDirectives</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r40 r">i</span>], <span class="r41 r">current</span>);
                    <b>if</b> (<span class="r43 r">tokenLength</span> == <span class="r39 r">targetDirectives</span>.<a href="@1@netstandard/A.html#e13f5829ef28aa07" class="i property">Length</a>
                        &amp;&amp; <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#1ae4d07b01230bb6" class="i method">Compare</a>(<span class="r38 r">cacheControlDirectives</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r40 r">i</span>], <span class="r41 r">current</span>, <span class="r39 r">targetDirectives</span>, 0, <span class="r43 r">tokenLength</span>, <a href="@1@netstandard/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@netstandard/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>) == 0)
                    {
                        <span class="c">// Token matches target value</span>
                        <b>return</b> <b>true</b>;
                    }
 
                    <span class="r41 r">current</span> = <a href="#ab6844fc7c2f0aa3" class="i method">AdvanceCacheDirectiveIndex</a>(<span class="r41 r">current</span> + <span class="r43 r">tokenLength</span>, <span class="r38 r">cacheControlDirectives</span><a href="StringValues.cs.html#80564c7f8642752d">[</a><span class="r40 r">i</span>]);
 
                    <span class="c">// Ensure index was advanced</span>
                    <b>if</b> (<span class="r41 r">current</span> &lt;= <span class="r42 r">initial</span>)
                    {
                        <a href="@1@netstandard/A.html#632c6da37ce825df" class="t t">Debug</a>.<a href="@1@netstandard/A.html#4f55cf5792dfc5e6" class="i method">Assert</a>(<b>false</b>, <span class="s">$&quot;</span><span class="s">Index &#39;</span>{<b>nameof</b>(<span class="r41 r">current</span>)}<span class="s">&#39; not advanced, this is a bug.</span><span class="s">&quot;</span>);
                        <b>return</b> <b>false</b>;
                    }
                }
            }
 
            <b>return</b> <b>false</b>;
        }
 
        <b>private static unsafe bool</b> <a id="abc7c78a3c404d0c" href="../R/abc7c78a3c404d0c.html" target="n" data-glyph="76,1" class="i method">TryParseNonNegativeInt64FromHeaderValue</a>(<b>int</b> <span id="r44 rd" class="r44 r">startIndex</span>, <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r45 rd" class="r45 r">headerValue</span>, <b>out long</b> <span id="r46 rd" class="r46 r">result</span>)
        {
            <span class="c">// Trim leading whitespace</span>
            <span class="r44 r">startIndex</span> += <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#aa08733b07353cff" class="i method">GetWhitespaceLength</a>(<span class="r45 r">headerValue</span>, <span class="r44 r">startIndex</span>);
 
            <span class="c">// Match and skip &#39;=&#39;, it also can&#39;t be the last character in the headerValue</span>
            <b>if</b> (<span class="r44 r">startIndex</span> &gt;= <span class="r45 r">headerValue</span>.<a href="@1@netstandard/A.html#e13f5829ef28aa07" class="i property">Length</a> - 1 || <span class="r45 r">headerValue</span><a href="@1@netstandard/A.html#8307d03426b56fe1">[</a><span class="r44 r">startIndex</span>] != <span class="s">&#39;=&#39;</span>)
            {
                <span class="r46 r">result</span> = 0;
                <b>return</b> <b>false</b>;
            }
            <span class="r44 r">startIndex</span>++;
 
            <span class="c">// Trim trailing whitespace</span>
            <span class="r44 r">startIndex</span> += <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#aa08733b07353cff" class="i method">GetWhitespaceLength</a>(<span class="r45 r">headerValue</span>, <span class="r44 r">startIndex</span>);
 
            <span class="c">// Try parse the number</span>
            <b>if</b> (<a href="#1429fe7c2216cf34" class="i method">TryParseNonNegativeInt64</a>(<b>new</b> <a href="StringSegment.cs.html#9177613ea9dde254" class="t constructor">StringSegment</a>(<span class="r45 r">headerValue</span>, <span class="r44 r">startIndex</span>, <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#264b58269df14615" class="i method">GetNumberLength</a>(<span class="r45 r">headerValue</span>, <span class="r44 r">startIndex</span>, <b>false</b>)), <b>out</b> <span class="r46 r">result</span>))
            {
                <b>return</b> <b>true</b>;
            }
 
            <span class="r46 r">result</span> = 0;
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Try to convert a string representation of a positive number to its 64-bit signed integer equivalent.</span>
        <span class="c">///</span><span class="c"> A return value indicates whether the conversion succeeded or failed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r47 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A string containing a number to convert.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r48 r">result</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When this method returns, contains the 64-bit signed integer value equivalent of the number contained</span>
        <span class="c">///</span><span class="c"> in the string, if the conversion succeeded, or zero if the conversion failed. The conversion fails if</span>
        <span class="c">///</span><span class="c"> the string is null or String.Empty, is not of the correct format, is negative, or represents a number</span>
        <span class="c">///</span><span class="c"> greater than Int64.MaxValue. This parameter is passed uninitialized; any value originally supplied in</span>
        <span class="c">///</span><span class="c"> result will be overwritten.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span><span class="c"> if parsing succeeded; otherwise, </span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static unsafe bool</b> <a id="6a6b6e165d65ccf9" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TryParseNonNegativeInt32</a>(<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <span id="r47 rd" class="r47 r">value</span>, <b>out int</b> <span id="r48 rd" class="r48 r">result</span>)
        {
            <b>if</b> (<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r47 r">value</span>.<a href="StringSegment.cs.html#e6a3bc23832e0110" class="i property">Buffer</a>) || <span class="r47 r">value</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a> == 0)
            {
                <span class="r48 r">result</span> = 0;
                <b>return</b> <b>false</b>;
            }
 
            <span class="r48 r">result</span> = 0;
            <b>fixed</b> (<b>char</b>* <span id="r49 rd" class="r49 r">ptr</span> = <span class="r47 r">value</span>.<a href="StringSegment.cs.html#e6a3bc23832e0110" class="i property">Buffer</a>)
            {
                <b>var</b> <span id="r50 rd" class="r50 r">ch</span> = (<b>ushort</b>*)<span class="r49 r">ptr</span> + <span class="r47 r">value</span>.<a href="StringSegment.cs.html#8e8a88a5ee0cd972" class="i property">Offset</a>;
                <b>var</b> <span id="r51 rd" class="r51 r">end</span> = <span class="r50 r">ch</span> + <span class="r47 r">value</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a>;
 
                <b>ushort</b> <span id="r52 rd" class="r52 r">digit</span> = 0;
                <b>while</b> (<span class="r50 r">ch</span> &lt; <span class="r51 r">end</span> &amp;&amp; (<span class="r52 r">digit</span> = (<b>ushort</b>)(*<span class="r50 r">ch</span> - 0x30)) &lt;= 9)
                {
                    <span class="c">// Check for overflow</span>
                    <b>if</b> ((<span class="r48 r">result</span> = <span class="r48 r">result</span> * 10 + <span class="r52 r">digit</span>) &lt; 0)
                    {
                        <span class="r48 r">result</span> = 0;
                        <b>return</b> <b>false</b>;
                    }
 
                    <span class="r50 r">ch</span>++;
                }
 
                <b>if</b> (<span class="r50 r">ch</span> != <span class="r51 r">end</span>)
                {
                    <span class="r48 r">result</span> = 0;
                    <b>return</b> <b>false</b>;
                }
                <b>return</b> <b>true</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Try to convert a </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> representation of a positive number to its 64-bit signed</span>
        <span class="c">///</span><span class="c"> integer equivalent. A return value indicates whether the conversion succeeded or failed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r53 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> containing a number to convert.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r54 r">result</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When this method returns, contains the 64-bit signed integer value equivalent of the number contained</span>
        <span class="c">///</span><span class="c"> in the string, if the conversion succeeded, or zero if the conversion failed. The conversion fails if</span>
        <span class="c">///</span><span class="c"> the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is null or String.Empty, is not of the correct format, is negative, or</span>
        <span class="c">///</span><span class="c"> represents a number greater than Int64.MaxValue. This parameter is passed uninitialized; any value</span>
        <span class="c">///</span><span class="c"> originally supplied in result will be overwritten.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span><span class="c"> if parsing succeeded; otherwise, </span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static unsafe bool</b> <a id="1429fe7c2216cf34" href="../R/1429fe7c2216cf34.html" target="n" data-glyph="72,1" class="i method">TryParseNonNegativeInt64</a>(<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <span id="r53 rd" class="r53 r">value</span>, <b>out long</b> <span id="r54 rd" class="r54 r">result</span>)
        {
            <b>if</b> (<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r53 r">value</span>.<a href="StringSegment.cs.html#e6a3bc23832e0110" class="i property">Buffer</a>) || <span class="r53 r">value</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a> == 0)
            {
                <span class="r54 r">result</span> = 0;
                <b>return</b> <b>false</b>;
            }
 
            <span class="r54 r">result</span> = 0;
            <b>fixed</b> (<b>char</b>* <span id="r55 rd" class="r55 r">ptr</span> = <span class="r53 r">value</span>.<a href="StringSegment.cs.html#e6a3bc23832e0110" class="i property">Buffer</a>)
            {
                <b>var</b> <span id="r56 rd" class="r56 r">ch</span> = (<b>ushort</b>*)<span class="r55 r">ptr</span> + <span class="r53 r">value</span>.<a href="StringSegment.cs.html#8e8a88a5ee0cd972" class="i property">Offset</a>;
                <b>var</b> <span id="r57 rd" class="r57 r">end</span> = <span class="r56 r">ch</span> + <span class="r53 r">value</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a>;
 
                <b>ushort</b> <span id="r58 rd" class="r58 r">digit</span> = 0;
                <b>while</b> (<span class="r56 r">ch</span> &lt; <span class="r57 r">end</span> &amp;&amp; (<span class="r58 r">digit</span> = (<b>ushort</b>)(*<span class="r56 r">ch</span> - 0x30)) &lt;= 9)
                {
                    <span class="c">// Check for overflow</span>
                    <b>if</b> ((<span class="r54 r">result</span> = <span class="r54 r">result</span> * 10 + <span class="r58 r">digit</span>) &lt; 0)
                    {
                        <span class="r54 r">result</span> = 0;
                        <b>return</b> <b>false</b>;
                    }
 
                    <span class="r56 r">ch</span>++;
                }
 
                <b>if</b> (<span class="r56 r">ch</span> != <span class="r57 r">end</span>)
                {
                    <span class="r54 r">result</span> = 0;
                    <b>return</b> <b>false</b>;
                }
                <b>return</b> <b>true</b>;
            }
        }
 
        <span class="c">// Strict and fast RFC7231 5.3.1 Quality value parser (and without memory allocation)</span>
        <span class="c">// See https://tools.ietf.org/html/rfc7231#section-5.3.1</span>
        <span class="c">// Check is made to verify if the value is between 0 and 1 (and it returns False if the check fails).</span>
        <b>internal static bool</b> <a id="17eff2585e691947" href="../R/17eff2585e691947.html" target="n" data-glyph="74,1" class="i method">TryParseQualityDouble</a>(<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <span id="r59 rd" class="r59 r">input</span>, <b>int</b> <span id="r60 rd" class="r60 r">startIndex</span>, <b>out double</b> <span id="r61 rd" class="r61 r">quality</span>, <b>out int</b> <span id="r62 rd" class="r62 r">length</span>)
        {
            <span class="r61 r">quality</span> = 0;
            <span class="r62 r">length</span> = 0;
 
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r63 rd" class="r63 r">inputLength</span> = <span class="r59 r">input</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a>;
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r64 rd" class="r64 r">current</span> = <span class="r60 r">startIndex</span>;
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r65 rd" class="r65 r">limit</span> = <span class="r60 r">startIndex</span> + <a href="#c3089ad89cb0be60" class="i field">_qualityValueMaxCharCount</a>;
 
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r66 rd" class="r66 r">intPart</span> = 0;
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r67 rd" class="r67 r">decPart</span> = 0;
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r68 rd" class="r68 r">decPow</span> = 1;
 
            <b>if</b> (<span class="r64 r">current</span> &gt;= <span class="r63 r">inputLength</span>)
            {
                <b>return</b> <b>false</b>;
            }
 
            <a href="@1@netstandard/A.html#02f2b1a33b09362d" class="k">var</a> <span id="r69 rd" class="r69 r">ch</span> = <span class="r59 r">input</span><a href="StringSegment.cs.html#082fd93c33d8dcf9">[</a><span class="r64 r">current</span>];
 
            <b>if</b> (<span class="r69 r">ch</span> &gt;= <span class="s">&#39;0&#39;</span> &amp;&amp; <span class="r69 r">ch</span> &lt;= <span class="s">&#39;1&#39;</span>) <span class="c">// Only values between 0 and 1 are accepted, according to RFC</span>
            {
                <span class="r66 r">intPart</span> = <span class="r69 r">ch</span> - <span class="s">&#39;0&#39;</span>;
                <span class="r64 r">current</span>++;
            }
            <b>else</b>
            {
                <span class="c">// The RFC doesn&#39;t allow decimal values starting with dot. I.e. value &quot;.123&quot; is invalid. It must be in the</span>
                <span class="c">// form &quot;0.123&quot;.</span>
                <b>return</b> <b>false</b>;
            }
 
            <b>if</b> (<span class="r64 r">current</span> &lt; <span class="r63 r">inputLength</span>)
            {
                <span class="r69 r">ch</span> = <span class="r59 r">input</span><a href="StringSegment.cs.html#082fd93c33d8dcf9">[</a><span class="r64 r">current</span>];
 
                <b>if</b> (<span class="r69 r">ch</span> &gt;= <span class="s">&#39;0&#39;</span> &amp;&amp; <span class="r69 r">ch</span> &lt;= <span class="s">&#39;9&#39;</span>)
                {
                    <span class="c">// The RFC accepts only one digit before the dot</span>
                    <b>return</b> <b>false</b>;
                }
 
                <b>if</b> (<span class="r69 r">ch</span> == <span class="s">&#39;.&#39;</span>)
                {
                    <span class="r64 r">current</span>++;
 
                    <b>while</b> (<span class="r64 r">current</span> &lt; <span class="r63 r">inputLength</span>)
                    {
                        <span class="r69 r">ch</span> = <span class="r59 r">input</span><a href="StringSegment.cs.html#082fd93c33d8dcf9">[</a><span class="r64 r">current</span>];
                        <b>if</b> (<span class="r69 r">ch</span> &gt;= <span class="s">&#39;0&#39;</span> &amp;&amp; <span class="r69 r">ch</span> &lt;= <span class="s">&#39;9&#39;</span>)
                        {
                            <b>if</b> (<span class="r64 r">current</span> &gt;= <span class="r65 r">limit</span>)
                            {
                                <b>return</b> <b>false</b>;
                            }
 
                            <span class="r67 r">decPart</span> = <span class="r67 r">decPart</span> * 10 + <span class="r69 r">ch</span> - <span class="s">&#39;0&#39;</span>;
                            <span class="r68 r">decPow</span> *= 10;
                            <span class="r64 r">current</span>++;
                        }
                        <b>else</b>
                        {
                            <b>break</b>;
                        }
                    }
                }
            }
 
            <b>if</b> (<span class="r67 r">decPart</span> != 0)
            {
                <span class="r61 r">quality</span> = <span class="r66 r">intPart</span> + <span class="r67 r">decPart</span> / (<b>double</b>)<span class="r68 r">decPow</span>;
            }
            <b>else</b>
            {
                <span class="r61 r">quality</span> = <span class="r66 r">intPart</span>;
            }
 
            <b>if</b> (<span class="r61 r">quality</span> &gt; 1)
            {
                <span class="c">// reset quality</span>
                <span class="r61 r">quality</span> = 0;
                <b>return</b> <b>false</b>;
            }
 
            <span class="r62 r">length</span> = <span class="r64 r">current</span> - <span class="r60 r">startIndex</span>;
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Converts the non-negative 64-bit numeric value to its equivalent string representation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r70 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The number to convert.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The string representation of the value of this instance, consisting of a sequence of digits ranging from 0 to 9 with no leading zeroes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static unsafe string</b> <a id="66a3c4e1e168d0f7" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">FormatNonNegativeInt64</a>(<b>long</b> <span id="r70 rd" class="r70 r">value</span>)
        {
            <b>if</b> (<span class="r70 r">value</span> &lt; 0)
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#c524af42f1a5665e" class="t constructor">ArgumentOutOfRangeException</a>(<b>nameof</b>(<span class="r70 r">value</span>), <span class="r70 r">value</span>, <span class="s">&quot;The value to be formatted must be non-negative.&quot;</span>);
            }
 
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r71 rd" class="r71 r">position</span> = <a href="#c2236a975cd79879" class="i field">_int64MaxStringLength</a>;
            <b>char</b>* <span id="r72 rd" class="r72 r">charBuffer</span> = <b>stackalloc char</b>[<a href="#c2236a975cd79879" class="i field">_int64MaxStringLength</a>];
 
            <b>do</b>
            {
                <span class="c">// Consider using Math.DivRem() if available</span>
                <a href="@1@netstandard/A.html#e566178cce890c36" class="k">var</a> <span id="r73 rd" class="r73 r">quotient</span> = <span class="r70 r">value</span> / 10;
                <span class="r72 r">charBuffer</span>[--<span class="r71 r">position</span>] = (<b>char</b>)(0x30 + (<span class="r70 r">value</span> - <span class="r73 r">quotient</span> * 10)); <span class="c">// 0x30 = &#39;0&#39;</span>
                <span class="r70 r">value</span> = <span class="r73 r">quotient</span>;
            }
            <b>while</b> (<span class="r70 r">value</span> != 0);
 
            <b>return</b> <b>new</b> <a href="@1@netstandard/A.html#b3355adff4758e39" class="k">string</a>(<span class="r72 r">charBuffer</span>, <span class="r71 r">position</span>, <a href="#c2236a975cd79879" class="i field">_int64MaxStringLength</a> - <span class="r71 r">position</span>);
        }
 
        <b>public static bool</b> <a id="b8f556655673c3d5" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TryParseDate</a>(<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <span id="r74 rd" class="r74 r">input</span>, <b>out</b> <a href="@1@netstandard/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a> <span id="r75 rd" class="r75 r">result</span>)
        {
            <b>return</b> <a href="HttpRuleParser.cs.html#818aace47de76adc" class="t t">HttpRuleParser</a>.<a href="HttpRuleParser.cs.html#a32cda39c959367d" class="i method">TryStringToDate</a>(<span class="r74 r">input</span>, <b>out</b> <span class="r75 r">result</span>);
        }
 
        <span class="c">/*
        public static string FormatDate(DateTimeOffset dateTime)
        {
            return FormatDate(dateTime, false);
        }
 
        public static string FormatDate(DateTimeOffset dateTime, bool quoted)
        {
            if (quoted)
            {
                return string.Create(31, dateTime, (span, dt) =&gt;
                {
                    span[0] = span[30] = &#39;&quot;&#39;;
                    dt.TryFormat(span.Slice(1), out _, &quot;r&quot;);
                });
            }
 
            return dateTime.ToString(&quot;r&quot;);
        }
        */</span>
 
        <b>public static</b> <a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <a id="2eba8314cfbf3623" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">RemoveQuotes</a>(<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <span id="r76 rd" class="r76 r">input</span>)
        {
            <b>if</b> (<a href="#26ab6e77dbaf01ea" class="i method">IsQuoted</a>(<span class="r76 r">input</span>))
            {
                <span class="r76 r">input</span> = <span class="r76 r">input</span>.<a href="StringSegment.cs.html#f022db17a1c4fbb7" class="i method">Subsegment</a>(1, <span class="r76 r">input</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a> - 2);
            }
            <b>return</b> <span class="r76 r">input</span>;
        }
 
        <b>public static bool</b> <a id="26ab6e77dbaf01ea" href="../R/26ab6e77dbaf01ea.html" target="n" data-glyph="72,1" class="i method">IsQuoted</a>(<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <span id="r77 rd" class="r77 r">input</span>)
        {
            <b>return</b> !<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a>.<a href="StringSegment.cs.html#a1f6454b10e90428" class="i method">IsNullOrEmpty</a>(<span class="r77 r">input</span>) &amp;&amp; <span class="r77 r">input</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a> &gt;= 2 &amp;&amp; <span class="r77 r">input</span>[0] == <span class="s">&#39;&quot;&#39;</span> &amp;&amp; <span class="r77 r">input</span><a href="StringSegment.cs.html#082fd93c33d8dcf9">[</a><span class="r77 r">input</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a> - 1] == <span class="s">&#39;&quot;&#39;</span>;
        }
 
        <span class="c">/*
        /// &lt;summary&gt;
        /// Given a quoted-string as defined by &lt;see href=&quot;https://tools.ietf.org/html/rfc7230#section-3.2.6&quot;&gt;the RFC specification&lt;/see&gt;,
        /// removes quotes and unescapes backslashes and quotes. This assumes that the input is a valid quoted-string.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;input&quot;&gt;The quoted-string to be unescaped.&lt;/param&gt;
        /// &lt;returns&gt;An unescaped version of the quoted-string.&lt;/returns&gt;
        public static StringSegment UnescapeAsQuotedString(StringSegment input)
        {
            input = RemoveQuotes(input);
 
            // First pass to calculate the size of the string
            var backSlashCount = CountBackslashesForDecodingQuotedString(input);
 
            if (backSlashCount == 0)
            {
                return input;
            }
 
            return string.Create(input.Length - backSlashCount, input, (span, segment) =&gt;
            {
                var spanIndex = 0;
                var spanLength = span.Length;
                for (var i = 0; i &lt; segment.Length &amp;&amp; (uint)spanIndex &lt; (uint)spanLength; i++)
                {
                    int nextIndex = i + 1;
                    if ((uint)nextIndex &lt; (uint)segment.Length &amp;&amp; segment[i] == &#39;\\&#39;)
                    {
                        // If there is an backslash character as the last character in the string,
                        // we will assume that it should be included literally in the unescaped string
                        // Ex: &quot;hello\\&quot; =&gt; &quot;hello\\&quot;
                        // Also, if a sender adds a quoted pair like &#39;\\&#39;&#39;n&#39;,
                        // we will assume it is over escaping and just add a n to the string.
                        // Ex: &quot;he\\llo&quot; =&gt; &quot;hello&quot;
                        span[spanIndex] = segment[nextIndex];
                        i++;
                    }
                    else
                    {
                        span[spanIndex] = segment[i];
                    }
 
                    spanIndex++;
                }
            });
        }
        */</span>
 
        <b>private static int</b> <a id="54d9f60789918085" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">CountBackslashesForDecodingQuotedString</a>(<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <span id="r78 rd" class="r78 r">input</span>)
        {
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r79 rd" class="r79 r">numberBackSlashes</span> = 0;
            <b>for</b> (<a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r80 rd" class="r80 r">i</span> = 0; <span class="r80 r">i</span> &lt; <span class="r78 r">input</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a>; <span class="r80 r">i</span>++)
            {
                <b>if</b> (<span class="r80 r">i</span> &lt; <span class="r78 r">input</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a> - 1 &amp;&amp; <span class="r78 r">input</span><a href="StringSegment.cs.html#082fd93c33d8dcf9">[</a><span class="r80 r">i</span>] == <span class="s">&#39;\\&#39;</span>)
                {
                    <span class="c">// If there is an backslash character as the last character in the string,</span>
                    <span class="c">// we will assume that it should be included literally in the unescaped string</span>
                    <span class="c">// Ex: &quot;hello\\&quot; =&gt; &quot;hello\\&quot;</span>
                    <span class="c">// Also, if a sender adds a quoted pair like &#39;\\&#39;&#39;n&#39;,</span>
                    <span class="c">// we will assume it is over escaping and just add a n to the string.</span>
                    <span class="c">// Ex: &quot;he\\llo&quot; =&gt; &quot;hello&quot;</span>
                    <b>if</b> (<span class="r78 r">input</span><a href="StringSegment.cs.html#082fd93c33d8dcf9">[</a><span class="r80 r">i</span> + 1] == <span class="s">&#39;\\&#39;</span>)
                    {
                        <span class="c">// Only count escaped backslashes once</span>
                        <span class="r80 r">i</span>++;
                    }
                    <span class="r79 r">numberBackSlashes</span>++;
                }
            }
            <b>return</b> <span class="r79 r">numberBackSlashes</span>;
        }
 
        <span class="c">/*
        /// &lt;summary&gt;
        /// Escapes a &lt;see cref=&quot;StringSegment&quot;/&gt; as a quoted-string, which is defined by
        /// &lt;see href=&quot;https://tools.ietf.org/html/rfc7230#section-3.2.6&quot;&gt;the RFC specification&lt;/see&gt;.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// This will add a backslash before each backslash and quote and add quotes
        /// around the input. Assumes that the input does not have quotes around it,
        /// as this method will add them. Throws if the input contains any invalid escape characters,
        /// as defined by rfc7230.
        /// &lt;/remarks&gt;
        /// &lt;param name=&quot;input&quot;&gt;The input to be escaped.&lt;/param&gt;
        /// &lt;returns&gt;An escaped version of the quoted-string.&lt;/returns&gt;
        public static StringSegment EscapeAsQuotedString(StringSegment input)
        {
            // By calling this, we know that the string requires quotes around it to be a valid token.
            var backSlashCount = CountAndCheckCharactersNeedingBackslashesWhenEncoding(input);
 
            // 2 for quotes
            return string.Create(input.Length + backSlashCount + 2, input, (span, segment) =&gt; {
                // Helps to elide the bounds check for span[0]
                span[span.Length - 1] = span[0] = &#39;\&quot;&#39;;
 
                var spanIndex = 1;
                for (var i = 0; i &lt; segment.Length; i++)
                {
                    if (segment[i] == &#39;\\&#39; || segment[i] == &#39;\&quot;&#39;)
                    {
                        span[spanIndex++] = &#39;\\&#39;;
                    }
                    else if ((segment[i] &lt;= 0x1F || segment[i] == 0x7F) &amp;&amp; segment[i] != 0x09)
                    {
                        // Control characters are not allowed in a quoted-string, which include all characters
                        // below 0x1F (except for 0x09 (TAB)) and 0x7F.
                        throw new FormatException($&quot;Invalid control character &#39;{segment[i]}&#39; in input.&quot;);
                    }
                    span[spanIndex++] = segment[i];
                }
            });
        }
        */</span>
 
        <b>private static int</b> <a id="1b35b9df0a723218" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">CountAndCheckCharactersNeedingBackslashesWhenEncoding</a>(<a href="StringSegment.cs.html#e646f02038a27e62" class="t t">StringSegment</a> <span id="r81 rd" class="r81 r">input</span>)
        {
            <a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r82 rd" class="r82 r">numberOfCharactersNeedingEscaping</span> = 0;
            <b>for</b> (<a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r83 rd" class="r83 r">i</span> = 0; <span class="r83 r">i</span> &lt; <span class="r81 r">input</span>.<a href="StringSegment.cs.html#fc26bc5e8c68c667" class="i property">Length</a>; <span class="r83 r">i</span>++)
            {
                <b>if</b> (<span class="r81 r">input</span><a href="StringSegment.cs.html#082fd93c33d8dcf9">[</a><span class="r83 r">i</span>] == <span class="s">&#39;\\&#39;</span> || <span class="r81 r">input</span><a href="StringSegment.cs.html#082fd93c33d8dcf9">[</a><span class="r83 r">i</span>] == <span class="s">&#39;\&quot;&#39;</span>)
                {
                    <span class="r82 r">numberOfCharactersNeedingEscaping</span>++;
                }
            }
            <b>return</b> <span class="r82 r">numberOfCharactersNeedingEscaping</span>;
        }
 
        <b>internal static void</b> <a id="118b101ae1c2a477" href="../R/118b101ae1c2a477.html" target="n" data-glyph="74,1" class="i method">ThrowIfReadOnly</a>(<b>bool</b> <span id="r84 rd" class="r84 r">isReadOnly</span>)
        {
            <b>if</b> (<span class="r84 r">isReadOnly</span>)
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">&quot;The object cannot be modified because it is read-only.&quot;</span>);
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
