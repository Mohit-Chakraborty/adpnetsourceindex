<!DOCTYPE html>
<html><head><title>SFPtestbase.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(207);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.EventHubs.Tests/ServiceFabricProcessor/SFPtestbase.cs" target="_top">ServiceFabricProcessor\SFPtestbase.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.EventHubs.Tests" target="_top">Microsoft.Azure.EventHubs.Tests.csproj</a> (Microsoft.Azure.EventHubs.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft. All rights reserved.</span>
<span class="c">// Licensed under the MIT license. See LICENSE file in the project root for full license information.</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<span class="i n">Tests</span>.<span class="i n">ServiceFabricProcessor</span>
{
    <b>using</b> <span class="i n">System</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i">Fabric</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<span class="i n">ServiceFabricProcessor</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i">ServiceFabric</span>.<span class="i">Data</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i">ServiceFabric</span>.<span class="i">Data</span>.<span class="i">Collections</span>;
    <b>using</b> <span class="i">Xunit</span>;
 
    <b>public class</b> <a id="68bbb749f6a44ff8" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="7b64f8f3c0e26499">SFPtestbase</span></a>
    {
        [<span class="i">Fact</span>]
        [<span class="i">DisplayTestMethodName</span>]
        <b>public void</b> <a id="b65d6732c9c33be2" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TestMockFabricPartitionLister</a>()
        {
            <a href="TestState.cs.html#bb206b03217d512f" class="t t">TestState</a> <span id="r0 rd" class="r0 r">state</span> = <b>new</b> <a href="TestState.cs.html#bb206b03217d512f" class="t constructor">TestState</a>();
            <span class="r0 r">state</span>.<a href="TestState.cs.html#496747a5f05ff297" class="i method">Initialize</a>(<span class="s">&quot;TestMockFabricPartitionLister&quot;</span>, 1, 0);
 
            <b>int</b> <span id="r1 rd" class="r1 r">setCount</span> = 1;
            <b>int</b> <span id="r2 rd" class="r2 r">setOrd</span> = 0;
            <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#7476ab5a071bd9ab" class="t t">IFabricPartitionLister</a> <span id="r3 rd" class="r3 r">mock</span> = <b>new</b> <a href="MockPartitionLister.cs.html#9e96014faf092b99" class="t constructor">MockPartitionLister</a>(<span class="r1 r">setCount</span>, <span class="r2 r">setOrd</span>);
            <b>int</b> <span id="r4 rd" class="r4 r">gotCount</span> = <span class="r3 r">mock</span>.<span class="i">GetServiceFabricPartitionCount</span>(<span class="r0 r">state</span>.<a href="TestState.cs.html#9d6d318b94f2ab49" class="i property">ServiceUri</a>).<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r4 r">gotCount</span> == <span class="r1 r">setCount</span>, <span class="s">$&quot;</span><span class="s">Returned count </span>{<span class="r4 r">gotCount</span>}<span class="s"> does not match original count </span>{<span class="r1 r">setCount</span>}<span class="s">&quot;</span>);
            <b>int</b> <span id="r5 rd" class="r5 r">gotOrd</span> = <span class="r3 r">mock</span>.<span class="i">GetServiceFabricPartitionOrdinal</span>(<span class="r0 r">state</span>.<a href="TestState.cs.html#8f369970fccc34ec" class="i property">ServicePartitionId</a>).<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r5 r">gotOrd</span> == <span class="r2 r">setOrd</span>, <span class="s">$&quot;</span><span class="s">Returned ordinal </span>{<span class="r5 r">gotOrd</span>}<span class="s"> does not match original ordinal </span>{<span class="r2 r">setOrd</span>}<span class="s">&quot;</span>);
        }
 
        [<span class="i">Fact</span>]
        [<span class="i">DisplayTestMethodName</span>]
        <b>public void</b> <a id="8bb1b9e879121d67" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TestMockStatefulServicePartition</a>()
        {
            <span class="i">IStatefulServicePartition</span> <span id="r6 rd" class="r6 r">mock</span> = <b>new</b> <a href="MockStatefulServicePartition.cs.html#827d7da69634d4ee" class="t constructor">MockStatefulServicePartition</a>();
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<span class="i">LoadMetric</span>&gt; <span id="r7 rd" class="r7 r">loadMetrics</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<span class="i">LoadMetric</span>&gt;();
            <span class="r7 r">loadMetrics</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<b>new</b> <span class="i">LoadMetric</span>(<span class="s">&quot;mockMetric&quot;</span>, 42));
            <span class="r6 r">mock</span>.<span class="i">ReportLoad</span>(<span class="r7 r">loadMetrics</span>);
        }
 
        [<span class="i">Fact</span>]
        [<span class="i">DisplayTestMethodName</span>]
        <b>public void</b> <a id="91be6381fc33022e" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TestMockTransaction</a>()
        {
            <span class="i">ITransaction</span> <span id="r8 rd" class="r8 r">mock0</span> = <b>new</b> <a href="MockTransaction.cs.html#ceacf37cc4f8307a" class="t constructor">MockTransaction</a>();
            <span class="i">ITransaction</span> <span id="r9 rd" class="r9 r">mock1</span> = <b>new</b> <a href="MockTransaction.cs.html#ceacf37cc4f8307a" class="t constructor">MockTransaction</a>();
 
            <b>long</b> <span id="r10 rd" class="r10 r">dummy</span> = <span class="r8 r">mock0</span>.<span class="i">CommitSequenceNumber</span>;
            <b>long</b> <span id="r11 rd" class="r11 r">start</span> = <span class="r10 r">dummy</span>;
            <span class="r10 r">dummy</span> = <span class="r8 r">mock0</span>.<span class="i">TransactionId</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r10 r">dummy</span> == <span class="r11 r">start</span>, <span class="s">$&quot;</span><span class="s">mock0.TransactionId is </span>{<span class="r10 r">dummy</span>}<span class="s"> not </span>{<span class="r11 r">start</span>}<span class="s">&quot;</span>);
            <span class="r10 r">dummy</span> = <span class="r8 r">mock0</span>.<span class="i">GetVisibilitySequenceNumberAsync</span>().<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r10 r">dummy</span> == <span class="r11 r">start</span>, <span class="s">$&quot;</span><span class="s">mock0.GetVisibilitySequenceNumberAsync is </span>{<span class="r10 r">dummy</span>}<span class="s"> not </span>{<span class="r11 r">start</span>}<span class="s">&quot;</span>);
            <span class="r10 r">dummy</span> = <span class="r9 r">mock1</span>.<span class="i">CommitSequenceNumber</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r10 r">dummy</span> == (<span class="r11 r">start</span> + 1), <span class="s">$&quot;</span><span class="s">mock1.CommitSequenceNumber is </span>{<span class="r10 r">dummy</span>}<span class="s"> not </span>{(<span class="r11 r">start</span> + 1)}<span class="s">&quot;</span>);
            <span class="r10 r">dummy</span> = <span class="r9 r">mock1</span>.<span class="i">TransactionId</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r10 r">dummy</span> == (<span class="r11 r">start</span> + 1), <span class="s">$&quot;</span><span class="s">mock1.TransactionId is </span>{<span class="r10 r">dummy</span>}<span class="s"> not </span>{(<span class="r11 r">start</span> + 1)}<span class="s">&quot;</span>);
            <span class="r10 r">dummy</span> = <span class="r9 r">mock1</span>.<span class="i">GetVisibilitySequenceNumberAsync</span>().<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r10 r">dummy</span> == (<span class="r11 r">start</span> + 1), <span class="s">$&quot;</span><span class="s">mock1.GetVisibilitySequenceNumberAsync is </span>{<span class="r10 r">dummy</span>}<span class="s"> not </span>{(<span class="r11 r">start</span> + 1)}<span class="s">&quot;</span>);
 
            <span class="r8 r">mock0</span>.<span class="i">Abort</span>();
            <span class="r8 r">mock0</span>.<span class="i">Dispose</span>();
 
            <span class="r9 r">mock1</span>.<span class="i">CommitAsync</span>();
            <span class="r9 r">mock1</span>.<span class="i">Dispose</span>();
        }
 
        [<span class="i">Fact</span>]
        [<span class="i">DisplayTestMethodName</span>]
        <b>public void</b> <a id="815f29c08a25aa63" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TestMockReliableDictionary</a>()
        {
            <span class="i">IReliableDictionary</span>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <b>object</b>&gt;&gt; <span id="r12 rd" class="r12 r">mock</span> =
                <b>new</b> <a href="MockReliableDictionary.cs.html#e62c5a9f1aff0bcc" class="t constructor">MockReliableDictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <b>object</b>&gt;&gt;();
 
            <a href="@0@mscorlib/A.html#130a9536ac96b392" class="t t">CancellationTokenSource</a> <span id="r13 rd" class="r13 r">tokenSource</span> = <b>new</b> <a href="@0@mscorlib/A.html#0fd973cb6741d972" class="t constructor">CancellationTokenSource</a>();
            <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <span id="r14 rd" class="r14 r">timeout</span> = <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(10.0);
            <span class="i">ITransaction</span> <span id="r15 rd" class="r15 r">mockTx</span> = <b>new</b> <a href="MockTransaction.cs.html#ceacf37cc4f8307a" class="t constructor">MockTransaction</a>();
 
            <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a> <span id="r16 rd" class="r16 r">ck1</span> = <b>new</b> <span class="t">Checkpoint</span>(<span class="s">&quot;666&quot;</span>, 1);
            <span class="r12 r">mock</span>.<span class="i">SetAsync</span>(<span class="r15 r">mockTx</span>, <span class="s">&quot;one&quot;</span>, <span class="r16 r">ck1</span>.<span class="i">ToDictionary</span>(), <span class="r14 r">timeout</span>, <span class="r13 r">tokenSource</span>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>).<span class="i">Wait</span>();
            <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a> <span id="r17 rd" class="r17 r">ck2</span> = <b>new</b> <span class="t">Checkpoint</span>(<span class="s">&quot;7777&quot;</span>, 2);
            <span class="r12 r">mock</span>.<span class="i">SetAsync</span>(<span class="r15 r">mockTx</span>, <span class="s">&quot;two&quot;</span>, <span class="r17 r">ck2</span>.<span class="i">ToDictionary</span>(), <span class="r14 r">timeout</span>, <span class="r13 r">tokenSource</span>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>).<span class="i">Wait</span>();
            <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a> <span id="r18 rd" class="r18 r">ck3</span> = <b>new</b> <span class="t">Checkpoint</span>(<span class="s">&quot;88888&quot;</span>, 3);
            <span class="r12 r">mock</span>.<span class="i">SetAsync</span>(<span class="r15 r">mockTx</span>, <span class="s">&quot;three&quot;</span>, <span class="r18 r">ck3</span>.<span class="i">ToDictionary</span>(), <span class="r14 r">timeout</span>, <span class="r13 r">tokenSource</span>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>).<span class="i">Wait</span>();
 
            <span class="i">ConditionalValue</span>&lt;<a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <b>object</b>&gt;&gt; <span id="r19 rd" class="r19 r">gotback</span>;
            <span class="r19 r">gotback</span> = <span class="r12 r">mock</span>.<span class="i">TryGetValueAsync</span>(<span class="r15 r">mockTx</span>, <span class="s">&quot;nope&quot;</span>, <span class="r14 r">timeout</span>, <span class="r13 r">tokenSource</span>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>).<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">False</span>(<span class="r19 r">gotback</span>.<span class="i">HasValue</span>, <span class="s">&quot;Found value for key &#39;nope&#39;&quot;</span>);
 
            <span class="r19 r">gotback</span> = <span class="r12 r">mock</span>.<span class="i">TryGetValueAsync</span>(<span class="r15 r">mockTx</span>, <span class="s">&quot;one&quot;</span>, <span class="r14 r">timeout</span>, <span class="r13 r">tokenSource</span>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>).<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r19 r">gotback</span>.<span class="i">HasValue</span>, <span class="s">&quot;Did not find value for key &#39;one&#39;&quot;</span>);
            <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a> <span id="r20 rd" class="r20 r">ck1back</span> = <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a>.<span class="i">CreateFromDictionary</span>(<span class="r19 r">gotback</span>.<span class="i">Value</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="r20 r">ck1back</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#bff53215c46b4889" class="i property">Offset</a>, <span class="r16 r">ck1</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#bff53215c46b4889" class="i property">Offset</a>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r20 r">ck1back</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#cfbaeeb01a64d8b5" class="i property">SequenceNumber</a> == <span class="r16 r">ck1</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#cfbaeeb01a64d8b5" class="i property">SequenceNumber</a>);
            <span class="r19 r">gotback</span> = <span class="r12 r">mock</span>.<span class="i">TryGetValueAsync</span>(<span class="r15 r">mockTx</span>, <span class="s">&quot;two&quot;</span>, <span class="r14 r">timeout</span>, <span class="r13 r">tokenSource</span>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>).<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r19 r">gotback</span>.<span class="i">HasValue</span>, <span class="s">&quot;Did not find value for key &#39;two&#39;&quot;</span>);
            <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a> <span id="r21 rd" class="r21 r">ck2back</span> = <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a>.<span class="i">CreateFromDictionary</span>(<span class="r19 r">gotback</span>.<span class="i">Value</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="r21 r">ck2back</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#bff53215c46b4889" class="i property">Offset</a>, <span class="r17 r">ck2</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#bff53215c46b4889" class="i property">Offset</a>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r21 r">ck2back</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#cfbaeeb01a64d8b5" class="i property">SequenceNumber</a> == <span class="r17 r">ck2</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#cfbaeeb01a64d8b5" class="i property">SequenceNumber</a>);
            <span class="r19 r">gotback</span> = <span class="r12 r">mock</span>.<span class="i">TryGetValueAsync</span>(<span class="r15 r">mockTx</span>, <span class="s">&quot;three&quot;</span>, <span class="r14 r">timeout</span>, <span class="r13 r">tokenSource</span>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>).<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r19 r">gotback</span>.<span class="i">HasValue</span>, <span class="s">&quot;Did not find value for key &#39;three&#39;&quot;</span>);
            <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a> <span id="r22 rd" class="r22 r">ck3back</span> = <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a>.<span class="i">CreateFromDictionary</span>(<span class="r19 r">gotback</span>.<span class="i">Value</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="r22 r">ck3back</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#bff53215c46b4889" class="i property">Offset</a>, <span class="r18 r">ck3</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#bff53215c46b4889" class="i property">Offset</a>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r22 r">ck3back</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#cfbaeeb01a64d8b5" class="i property">SequenceNumber</a> == <span class="r18 r">ck3</span>.<a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#cfbaeeb01a64d8b5" class="i property">SequenceNumber</a>);
        }
 
        [<span class="i">Fact</span>]
        [<span class="i">DisplayTestMethodName</span>]
        <b>public void</b> <a id="a2895c6667aed271" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TestMockReliableStateManager</a>()
        {
            <span class="i">IReliableStateManager</span> <span id="r23 rd" class="r23 r">mock</span> = <b>new</b> <a href="MockReliableStateManager.cs.html#385adca1640fff21" class="t constructor">MockReliableStateManager</a>();
 
            <span class="i">ITransaction</span> <span id="r24 rd" class="r24 r">mockTx</span> = <span class="r23 r">mock</span>.<span class="i">CreateTransaction</span>();
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r24 r">mockTx</span>);
 
            <span class="i">IReliableDictionary</span>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <b>object</b>&gt;&gt; <span id="r25 rd" class="r25 r">mockDict</span> =
                <span class="r23 r">mock</span>.<span class="i">GetOrAddAsync</span>&lt;<span class="i">IReliableDictionary</span>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <b>object</b>&gt;&gt;&gt;(<span class="s">&quot;blah&quot;</span>).<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r25 r">mockDict</span>);
 
            <span class="i">ConditionalValue</span>&lt;<span class="i">IReliableDictionary</span>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <b>object</b>&gt;&gt;&gt; <span id="r26 rd" class="r26 r">dummy</span> =
                <span class="r23 r">mock</span>.<span class="i">TryGetAsync</span>&lt;<span class="i">IReliableDictionary</span>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <b>object</b>&gt;&gt;&gt;(<span class="s">&quot;nope&quot;</span>).<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">False</span>(<span class="r26 r">dummy</span>.<span class="i">HasValue</span>, <span class="s">&quot;Found value for key &#39;nope&#39;&quot;</span>);
 
            <span class="r26 r">dummy</span> = <span class="r23 r">mock</span>.<span class="i">TryGetAsync</span>&lt;<span class="i">IReliableDictionary</span>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <b>object</b>&gt;&gt;&gt;(<span class="s">&quot;blah&quot;</span>).<span class="i">Result</span>;
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r26 r">dummy</span>.<span class="i">HasValue</span>, <span class="s">&quot;Did not find value for key &#39;blah&#39;&quot;</span>);
        }
 
        [<span class="i">Fact</span>]
        [<span class="i">DisplayTestMethodName</span>]
        <b>public void</b> <a id="3b96ec2c682d8b69" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SmokeTest</a>()
        {
            <a href="TestState.cs.html#bb206b03217d512f" class="t t">TestState</a> <span id="r27 rd" class="r27 r">state</span> = <b>new</b> <a href="TestState.cs.html#bb206b03217d512f" class="t constructor">TestState</a>();
            <span class="r27 r">state</span>.<a href="TestState.cs.html#496747a5f05ff297" class="i method">Initialize</a>(<span class="s">&quot;smoke&quot;</span>, 1, 0);
 
            <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#a32fbfa5c91e3b37" class="t t">ServiceFabricProcessor</a> <span id="r28 rd" class="r28 r">sfp</span> = <b>new</b> <span class="t">ServiceFabricProcessor</span>(
                    <span class="r27 r">state</span>.<a href="TestState.cs.html#9d6d318b94f2ab49" class="i property">ServiceUri</a>,
                    <span class="r27 r">state</span>.<a href="TestState.cs.html#8f369970fccc34ec" class="i property">ServicePartitionId</a>,
                    <span class="r27 r">state</span>.<a href="TestState.cs.html#92cce9edcbe471d6" class="i property">StateManager</a>,
                    <span class="r27 r">state</span>.<a href="TestState.cs.html#955a0499dd48340d" class="i property">StatefulServicePartition</a>,
                    <span class="r27 r">state</span>.<a href="TestState.cs.html#c9babcafd91f1b96" class="i property">Processor</a>,
                    <span class="r27 r">state</span>.<a href="TestState.cs.html#2d6b1dd385ceec60" class="i property">ConnectionString</a>,
                    <span class="s">&quot;$Default&quot;</span>,
                    <span class="r27 r">state</span>.<a href="TestState.cs.html#a3ca3f9c6e515ecf" class="i property">Options</a>);
            <span class="r28 r">sfp</span>.<span class="i">MockMode</span> = <span class="r27 r">state</span>.<a href="TestState.cs.html#06199c8d2255d25b" class="i property">PartitionLister</a>;
            <span class="r28 r">sfp</span>.<span class="i">EventHubClientFactory</span> = <b>new</b> <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#068222643ab19252" class="t t">EventHubMocks</a>.<span class="t">EventHubClientFactoryMock</span>(1);
 
            <span class="r27 r">state</span>.<a href="TestState.cs.html#1bf4eee5ac1eb1ad" class="i method">PrepareToRun</a>();
            <span class="r27 r">state</span>.<a href="TestState.cs.html#833f9868497911b9" class="i method">StartRun</a>(<span class="r28 r">sfp</span>);
 
            <span class="r27 r">state</span>.<a href="TestState.cs.html#f0b4b0963bddbacb" class="i method">RunForNBatches</a>(20, 10);
 
            <span class="r27 r">state</span>.<a href="TestState.cs.html#bcceeb973a4b0d88" class="i method">WaitRun</a>();
 
            <span class="c">// EXPECTED RESULT: Normal processing.</span>
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r27 r">state</span>.<a href="TestState.cs.html#c9babcafd91f1b96" class="i property">Processor</a>.<a href="TestProcessor.cs.html#4f27e140c6ff301d" class="i property">TotalErrors</a> == 0, <span class="s">$&quot;</span><span class="s">Errors found </span>{<span class="r27 r">state</span>.<a href="TestState.cs.html#c9babcafd91f1b96" class="i property">Processor</a>.<a href="TestProcessor.cs.html#4f27e140c6ff301d" class="i property">TotalErrors</a>}<span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">Null</span>(<span class="r27 r">state</span>.<a href="TestState.cs.html#dbc0333961033f92" class="i property">ShutdownException</a>);
        }
 
        [<span class="i">Fact</span>]
        [<span class="i">DisplayTestMethodName</span>]
        <b>public void</b> <a id="0261e0a5cea0cd7e" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">PartitionCountEnforcement</a>()
        {
            <a href="#d03fbdc2e1ba1595" class="i method">innerPartitionCountEnforcement</a>(4, 16);
            <a href="#d03fbdc2e1ba1595" class="i method">innerPartitionCountEnforcement</a>(4, 2);
        }
 
        <b>private void</b> <a id="d03fbdc2e1ba1595" href="../R/d03fbdc2e1ba1595.html" target="n" data-glyph="76,1" class="i method">innerPartitionCountEnforcement</a>(<b>int</b> <span id="r29 rd" class="r29 r">servicePartitions</span>, <b>int</b> <span id="r30 rd" class="r30 r">eventHubPartitions</span>)
        {
            <a href="TestState.cs.html#bb206b03217d512f" class="t t">TestState</a> <span id="r31 rd" class="r31 r">state</span> = <b>new</b> <a href="TestState.cs.html#bb206b03217d512f" class="t constructor">TestState</a>();
            <span class="r31 r">state</span>.<a href="TestState.cs.html#496747a5f05ff297" class="i method">Initialize</a>(<span class="s">&quot;partitioncountenforcement&quot;</span>, <span class="r29 r">servicePartitions</span>, 0);
 
            <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#a32fbfa5c91e3b37" class="t t">ServiceFabricProcessor</a> <span id="r32 rd" class="r32 r">sfp</span> = <b>new</b> <span class="t">ServiceFabricProcessor</span>(
                    <span class="r31 r">state</span>.<a href="TestState.cs.html#9d6d318b94f2ab49" class="i property">ServiceUri</a>,
                    <span class="r31 r">state</span>.<a href="TestState.cs.html#8f369970fccc34ec" class="i property">ServicePartitionId</a>,
                    <span class="r31 r">state</span>.<a href="TestState.cs.html#92cce9edcbe471d6" class="i property">StateManager</a>,
                    <span class="r31 r">state</span>.<a href="TestState.cs.html#955a0499dd48340d" class="i property">StatefulServicePartition</a>,
                    <span class="r31 r">state</span>.<a href="TestState.cs.html#c9babcafd91f1b96" class="i property">Processor</a>,
                    <span class="r31 r">state</span>.<a href="TestState.cs.html#2d6b1dd385ceec60" class="i property">ConnectionString</a>,
                    <span class="s">&quot;$Default&quot;</span>,
                    <span class="r31 r">state</span>.<a href="TestState.cs.html#a3ca3f9c6e515ecf" class="i property">Options</a>);
            <span class="r32 r">sfp</span>.<span class="i">MockMode</span> = <span class="r31 r">state</span>.<a href="TestState.cs.html#06199c8d2255d25b" class="i property">PartitionLister</a>;
            <span class="r32 r">sfp</span>.<span class="i">EventHubClientFactory</span> = <b>new</b> <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#068222643ab19252" class="t t">EventHubMocks</a>.<span class="t">EventHubClientFactoryMock</span>(<span class="r30 r">eventHubPartitions</span>);
 
            <span class="r31 r">state</span>.<a href="TestState.cs.html#1bf4eee5ac1eb1ad" class="i method">PrepareToRun</a>();
            <span class="r31 r">state</span>.<a href="TestState.cs.html#833f9868497911b9" class="i method">StartRun</a>(<span class="r32 r">sfp</span>);
 
            <b>int</b> <span id="r33 rd" class="r33 r">retries</span> = 0;
            <b>while</b> (!<span class="r31 r">state</span>.<a href="TestState.cs.html#a752c8a85b4a6211" class="i property">HasShutDown</a> &amp;&amp; (<span class="r33 r">retries</span> &lt; 10))
            {
                <a href="@0@mscorlib/A.html#3980e012bae82e96" class="t t">Thread</a>.<a href="@0@mscorlib/A.html#5f1072b92dae1dd8" class="i method">Sleep</a>(1000);
                <span class="r33 r">retries</span>++;
            }
 
            <span class="c">// EXPECTED RESULT: EventProcessorConfigurationException, and IEventProcessor.OpenAsync is never called.</span>
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r31 r">state</span>.<a href="TestState.cs.html#a752c8a85b4a6211" class="i property">HasShutDown</a>, <span class="s">$&quot;</span><span class="s">Shutdown notification did not occur after </span>{<span class="r33 r">retries</span>}<span class="s"> seconds</span><span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">False</span>(<span class="r31 r">state</span>.<a href="TestState.cs.html#c9babcafd91f1b96" class="i property">Processor</a>.<a href="TestProcessor.cs.html#a0c208281da648e8" class="i property">IsOpened</a>, <span class="s">&quot;Processor was opened&quot;</span>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r31 r">state</span>.<a href="TestState.cs.html#dbc0333961033f92" class="i property">ShutdownException</a>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r31 r">state</span>.<a href="TestState.cs.html#dbc0333961033f92" class="i property">ShutdownException</a> <b>is</b> <a href="/Microsoft.Azure.EventHubs.ServiceFabricProcessor/A.html#55b99a9cf0042b09" class="t t">EventProcessorConfigurationException</a>,
                <span class="s">$&quot;</span><span class="s">Unexpected exception type </span>{<span class="r31 r">state</span>.<a href="TestState.cs.html#dbc0333961033f92" class="i property">ShutdownException</a>.<a href="@0@mscorlib/A.html#cf7a3679f8b67db4" class="i method">GetType</a>().<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>}<span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="s">$&quot;</span><span class="s">Service partition count </span>{<span class="r29 r">servicePartitions</span>}<span class="s"> does not match event hub partition count </span>{<span class="r30 r">eventHubPartitions</span>}<span class="s">&quot;</span>,
                <span class="r31 r">state</span>.<a href="TestState.cs.html#dbc0333961033f92" class="i property">ShutdownException</a>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
        }
    }
}
</pre></td></tr></table></div></body></html>
