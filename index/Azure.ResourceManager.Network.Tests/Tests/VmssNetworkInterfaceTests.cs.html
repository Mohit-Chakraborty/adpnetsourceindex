<!DOCTYPE html>
<html><head><title>VmssNetworkInterfaceTests.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(106);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.ResourceManager.Network.Tests/Tests/VmssNetworkInterfaceTests.cs" target="_top">Tests\VmssNetworkInterfaceTests.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/network/Azure.ResourceManager.Network/tests/Tests/VmssNetworkInterfaceTests.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.ResourceManager.Network.Tests" target="_top">Azure.ResourceManager.Network.Tests.csproj</a> (Azure.ResourceManager.Network.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> <b>false</b>
<span class="e">using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Azure.Core.TestFramework;
using Azure.ResourceManager.Resources;
using Azure.ResourceManager.Resources.Models;
using Azure.ResourceManager.Network.Models;
using Azure.ResourceManager.Network.Tests.Helpers;
using NUnit.Framework;
 
namespace Azure.ResourceManager.Network.Tests
{
    public class VmssNetworkInterfaceTests : NetworkTestsManagementClientBase
    {
        public VmssNetworkInterfaceTests(bool isAsync) : base(isAsync)
        {
        }
 
        [SetUp]
        public void ClearChallengeCacheforRecord()
        {
            if (Mode == RecordedTestMode.Record || Mode == RecordedTestMode.Playback)
            {
                Initialize();
            }
        }
 
        private static string GetNameById(string Id, string resourceType)
        {
            string name = Id.Substring(Id.IndexOf(resourceType + &#39;/&#39;) + resourceType.Length + 1);
            if (name.IndexOf(&#39;/&#39;) != -1)
            {
                name = name.Substring(0, name.IndexOf(&#39;/&#39;));
            }
            return name;
        }
 
        [Test]
        public async Task VmssNetworkInterfaceApiTest()
        {
            string resourceGroupName = Recording.GenerateAssetName(&quot;azsmnet&quot;);
 
            string location = TestEnvironment.Location;
            string deploymentName = Recording.GenerateAssetName(&quot;vmss&quot;);
            var resourceGroup = CreateResourceGroup(resourceGroupName, location);
 
            await CreateVmss(ResourceManagementClient, resourceGroupName, deploymentName);
 
            string virtualMachineScaleSetName = &quot;vmssip&quot;;
            AsyncPageable&lt;PublicIPAddress&gt; vmssListAllPageResultAP = NetworkManagementClient.PublicIPAddresses.GetVirtualMachineScaleSetPublicIPAddressesAsync(resourceGroupName, virtualMachineScaleSetName);
            List&lt;PublicIPAddress&gt; vmssListAllPageResult = await vmssListAllPageResultAP.ToEnumerableAsync();
            List&lt;PublicIPAddress&gt; vmssListAllResult = vmssListAllPageResult.ToList();
            PublicIPAddress firstResult = vmssListAllResult.First();
 
            Assert.NotNull(vmssListAllResult);
            Assert.AreEqual(&quot;Succeeded&quot;, firstResult.ProvisioningState.ToString());
            Assert.NotNull(firstResult.ResourceGuid);
 
            string idItem = firstResult.Id;
            string vmIndex = GetNameById(idItem, &quot;virtualMachines&quot;);
            string nicName = GetNameById(idItem, &quot;networkInterfaces&quot;);
 
            // Verify that NICs contain refernce to publicip, nsg and dns settings
            AsyncPageable&lt;NetworkInterface&gt; listNicPerVmssAP = NetworkManagementClient.NetworkInterfaces.GetVirtualMachineScaleSetNetworkInterfacesAsync(resourceGroupName, virtualMachineScaleSetName);
            List&lt;NetworkInterface&gt; listNicPerVmss = await listNicPerVmssAP.ToEnumerableAsync();
            Assert.NotNull(listNicPerVmss);
 
            foreach (NetworkInterface nic in listNicPerVmss)
            {
                VerifyVmssNicProperties(nic);
            }
 
            // Verify nics on a vm level
            AsyncPageable&lt;NetworkInterface&gt; listNicPerVmAP = NetworkManagementClient.NetworkInterfaces.GetVirtualMachineScaleSetVMNetworkInterfacesAsync(resourceGroupName, virtualMachineScaleSetName, vmIndex);
            List&lt;NetworkInterface&gt; listNicPerVm = await listNicPerVmAP.ToEnumerableAsync();
            Assert.NotNull(listNicPerVm);
            Has.One.EqualTo(listNicPerVm);
 
            foreach (NetworkInterface nic in listNicPerVm)
            {
                VerifyVmssNicProperties(nic);
            }
 
            // Verify getting individual nic
            Response&lt;NetworkInterface&gt; getNic = await NetworkManagementClient.NetworkInterfaces.GetVirtualMachineScaleSetNetworkInterfaceAsync(resourceGroupName, virtualMachineScaleSetName, vmIndex, nicName);
            Assert.NotNull(getNic);
            VerifyVmssNicProperties(getNic);
        }
 
        private void VerifyVmssNicProperties(NetworkInterface nic)
        {
            Assert.NotNull(nic.NetworkSecurityGroup);
            Assert.False(string.IsNullOrEmpty(nic.NetworkSecurityGroup.Id));
            Assert.NotNull(nic.DnsSettings);
            Assert.NotNull(nic.DnsSettings.DnsServers);
            Assert.AreEqual(1, nic.DnsSettings.DnsServers.Count);
            Assert.NotNull(nic.IpConfigurations[0].PublicIPAddress);
            Assert.False(string.IsNullOrEmpty(nic.IpConfigurations[0].PublicIPAddress.Id));
        }
    }
}
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
</pre></td></tr></table></div></body></html>
