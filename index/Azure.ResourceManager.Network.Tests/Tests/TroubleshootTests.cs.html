<!DOCTYPE html>
<html><head><title>TroubleshootTests.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(117);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.ResourceManager.Network.Tests/Tests/TroubleshootTests.cs" target="_top">Tests\TroubleshootTests.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/network/Azure.ResourceManager.Network/tests/Tests/TroubleshootTests.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.ResourceManager.Network.Tests" target="_top">Azure.ResourceManager.Network.Tests.csproj</a> (Azure.ResourceManager.Network.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <b>false</b>
<span class="e">using System.Collections.Generic;
using System.Threading.Tasks;
using Azure.Core.TestFramework;
using Azure.ResourceManager.Resources;
using Azure.ResourceManager.Resources.Models;
//using Azure.ResourceManager.Storage.Models;
using Azure.ResourceManager.Network.Models;
using Azure.ResourceManager.Network.Tests.Helpers;
using NUnit.Framework;
//using Sku = Azure.ResourceManager.Storage.Models.Sku;
using SubResource = Azure.ResourceManager.Network.Models.SubResource;
 
namespace Azure.ResourceManager.Network.Tests
{
    public class TroubleshootTests : NetworkServiceClientTestBase
    {
        public TroubleshootTests(bool isAsync) : base(isAsync)
        {
        }
 
        [SetUp]
        public void ClearChallengeCacheforRecord()
        {
            if (Mode == RecordedTestMode.Record || Mode == RecordedTestMode.Playback)
            {
                Initialize();
            }
        }
 
        [Test]
        [Ignore(&quot;Track2: The NetworkWathcer is involved, so disable the test&quot;)]
        public async Task TroubleshootApiTest()
        {
            string resourceGroupName = Recording.GenerateAssetName(&quot;azsmnet&quot;);
 
            string location = &quot;westus2&quot;;
            var resourceGroup = CreateResourceGroup(resourceGroupName, location);
 
            // CreateVirtualNetworkGateway API
            // Prerequisite:- Create PublicIPAddress(Gateway Ip) using Put PublicIPAddress API
            string publicIpName = Recording.GenerateAssetName(&quot;azsmnet&quot;);
            string domainNameLabel = Recording.GenerateAssetName(&quot;azsmnet&quot;);
 
            PublicIPAddress nic1publicIp = await CreateDefaultPublicIpAddress(publicIpName, resourceGroupName, domainNameLabel, location);
 
            //Prerequisite:-Create Virtual Network using Put VirtualNetwork API
            string vnetName = Recording.GenerateAssetName(&quot;azsmnet&quot;);
            string subnetName = &quot;GatewaySubnet&quot;;
 
            await CreateVirtualNetwork(vnetName, subnetName, resourceGroupName, location);
 
            Response&lt;Subnet&gt; getSubnetResponse = await GetVirtualNetworkCollection(resourceGroupName).Get(vnetName).Value.GetSubnets().GetAsync(subnetName);
 
            // CreateVirtualNetworkGateway API
            string virtualNetworkGatewayName = Recording.GenerateAssetName(&quot;azsmnet&quot;);
            string ipConfigName = Recording.GenerateAssetName(&quot;azsmnet&quot;);
 
            var virtualNetworkGateway = new VirtualNetworkGatewayData()
            {
                Location = location,
                Tags = { { &quot;key&quot;, &quot;value&quot; } },
                EnableBgp = false,
                GatewayDefaultSite = null,
                GatewayType = VirtualNetworkGatewayType.Vpn,
                VpnType = VpnType.RouteBased,
                IpConfigurations =
                {
                    new VirtualNetworkGatewayIPConfiguration()
                    {
                        Name = ipConfigName,
                        PrivateIPAllocationMethod = IPAllocationMethod.Dynamic,
                        PublicIPAddress = new SubResource() { Id = nic1publicIp.Id }, Subnet = new SubResource() { Id = getSubnetResponse.Value.Id }
                    }
                },
                Sku = new VirtualNetworkGatewaySku() { Name = VirtualNetworkGatewaySkuName.Basic, Tier = VirtualNetworkGatewaySkuTier.Basic }
            };
 
            var virtualNetworkGatewayCollection = GetVirtualNetworkGatewayCollection(resourceGroupName);
            var putVirtualNetworkGatewayResponseOperation =
                await virtualNetworkGatewayCollection.CreateOrUpdateAsync(virtualNetworkGatewayName, virtualNetworkGateway);
            await putVirtualNetworkGatewayResponseOperation.WaitForCompletionAsync();;
            // GetVirtualNetworkGateway API
            Response&lt;VirtualNetworkGateway&gt; getVirtualNetworkGatewayResponse =
                await virtualNetworkGatewayCollection.GetAsync(virtualNetworkGatewayName);
 
            //TODO:There is no need to perform a separate create NetworkWatchers operation
            //Create network Watcher
            //string networkWatcherName = Recording.GenerateAssetName(&quot;azsmnet&quot;);
            //NetworkWatcher properties = new NetworkWatcher { Location = location };
            //await networkWatcherCollection.CreateOrUpdateAsync(resourceGroupName, networkWatcherName, properties);
 
            //Create storage
            //string storageName = Recording.GenerateAssetName(&quot;azsmnet&quot;);
            //var storageParameters = new StorageAccountCreateParameters(new Sku(SkuName.StandardLRS), Kind.Storage, location);
 
            //Operation&lt;StorageAccount&gt; accountOperation = await StorageManagementClient.StorageAccounts.CreateAsync(resourceGroupName, storageName, storageParameters);
            //Response&lt;StorageAccount&gt; account = await accountOperation.WaitForCompletionAsync();;
            //TroubleshootingParameters parameters = new TroubleshootingParameters(getVirtualNetworkGatewayResponse.Value.Id, account.Value.Id, &quot;https://nwtestdbdzq4xsvskrei6.blob.core.windows.net/vhds&quot;);
 
            ////Get troubleshooting
            //var networkWatcherCollection = GetNetworkWatcherCollection(&quot;NetworkWatcherRG&quot;);
            //var troubleshootOperation = await networkWatcherCollection.Get(&quot;NetworkWatcher_westus2&quot;).Value.GetTroubleshootingAsync(parameters);
            //await troubleshootOperation.WaitForCompletionAsync();;
 
            ////Query last troubleshoot
            //var queryTroubleshootOperation = await networkWatcherCollection.Get(&quot;NetworkWatcher_westus2&quot;).Value.GetTroubleshootingResultAsync(new QueryTroubleshootingParameters(getVirtualNetworkGatewayResponse.Value.Id));
            //await queryTroubleshootOperation.WaitForCompletionAsync();;
            //TODO: make verification once fixed for troubleshoot API deployed
        }
    }
}
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
</pre></td></tr></table></div></body></html>
