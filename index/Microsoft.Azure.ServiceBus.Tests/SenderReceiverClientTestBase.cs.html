<!DOCTYPE html>
<html><head><title>SenderReceiverClientTestBase.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(373);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.ServiceBus.Tests/SenderReceiverClientTestBase.cs" target="_top">SenderReceiverClientTestBase.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.ServiceBus.Tests" target="_top">Microsoft.Azure.ServiceBus.Tests.csproj</a> (Microsoft.Azure.ServiceBus.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft. All rights reserved.</span>
<span class="c">// Licensed under the MIT license. See LICENSE file in the project root for full license information.</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">ServiceBus</span>.<span class="i n">UnitTests</span>
{
    <b>using</b> <span class="i n">System</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
    <b>using</b> <span class="i n">Core</span>;
    <b>using</b> <span class="i">Xunit</span>;
 
    <b>public abstract class</b> <a id="06ad0308b5dd2b05" href="R/06ad0308b5dd2b05.html" target="n" data-glyph="0,0" class="t t"><span id="88e20623c2ef40b0">SenderReceiverClientTestBase</span></a>
    {
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="445a591e9f00e360" href="R/445a591e9f00e360.html" target="n" data-glyph="74,1" class="i method">PeekLockTestCase</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r0 rd" class="r0 r">messageSender</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r1 rd" class="r1 r">messageReceiver</span>, <b>int</b> <span id="r2 rd" class="r2 r">messageCount</span>)
        {
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r0 r">messageSender</span>, <span class="r2 r">messageCount</span>);
            <a href="@0@mscorlib/A.html#b19f71a84062554b" class="k">var</a> <span id="r3 rd" class="r3 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r1 r">messageReceiver</span>, <span class="r2 r">messageCount</span>);
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#9eb316db0b44fff2" class="i method">CompleteMessagesAsync</a>(<span class="r1 r">messageReceiver</span>, <span class="r3 r">receivedMessages</span>);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="f702c2a127378833" href="R/f702c2a127378833.html" target="n" data-glyph="74,1" class="i method">ReceiveDeleteTestCase</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r4 rd" class="r4 r">messageSender</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r5 rd" class="r5 r">messageReceiver</span>, <b>int</b> <span id="r6 rd" class="r6 r">messageCount</span>)
        {
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r4 r">messageSender</span>, <span class="r6 r">messageCount</span>);
            <a href="@0@mscorlib/A.html#b19f71a84062554b" class="k">var</a> <span id="r7 rd" class="r7 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r5 r">messageReceiver</span>, <span class="r6 r">messageCount</span>, <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(10));
            <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="r6 r">messageCount</span>, <span class="r7 r">receivedMessages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a>);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="28fafe388f5d0b32" href="R/28fafe388f5d0b32.html" target="n" data-glyph="74,1" class="i method">PeekLockWithAbandonTestCase</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r8 rd" class="r8 r">messageSender</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r9 rd" class="r9 r">messageReceiver</span>, <b>int</b> <span id="r10 rd" class="r10 r">messageCount</span>)
        {
            <span class="c">// Send messages</span>
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r8 r">messageSender</span>, <span class="r10 r">messageCount</span>);
 
            <span class="c">// Receive 5 messages and Abandon them</span>
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r11 rd" class="r11 r">abandonMessagesCount</span> = 5;
            <a href="@0@mscorlib/A.html#b19f71a84062554b" class="k">var</a> <span id="r12 rd" class="r12 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r9 r">messageReceiver</span>, <span class="r11 r">abandonMessagesCount</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r12 r">receivedMessages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == <span class="r11 r">abandonMessagesCount</span>);
 
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#2d5334d297058788" class="i method">AbandonMessagesAsync</a>(<span class="r9 r">messageReceiver</span>, <span class="r12 r">receivedMessages</span>);
 
            <span class="c">// Receive all 10 messages</span>
            <span class="r12 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r9 r">messageReceiver</span>, <span class="r10 r">messageCount</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r12 r">receivedMessages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == <span class="r10 r">messageCount</span>);
 
            <span class="c">// TODO: Some reason for partitioned entities the delivery count is incorrect. Investigate and enable</span>
            <span class="c">// 5 of these messages should have deliveryCount = 2</span>
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r13 rd" class="r13 r">messagesWithDeliveryCount2</span> = <span class="r12 r">receivedMessages</span>.<span class="i">Where</span>(<span id="r14 rd" class="r14 r">message</span> =&gt; <span class="r14 r">message</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#622acff6cf015d07" class="i property">DeliveryCount</a> == 2).<span class="i">Count</span>();
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">Messages with Delivery Count 2: </span>{<span class="r13 r">messagesWithDeliveryCount2</span>}<span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r13 r">messagesWithDeliveryCount2</span> == <span class="r11 r">abandonMessagesCount</span>);
 
            <span class="c">// Complete Messages</span>
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#9eb316db0b44fff2" class="i method">CompleteMessagesAsync</a>(<span class="r9 r">messageReceiver</span>, <span class="r12 r">receivedMessages</span>);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="a9e356aef740d734" href="R/a9e356aef740d734.html" target="n" data-glyph="74,1" class="i method">PeekLockWithDeadLetterTestCase</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r15 rd" class="r15 r">messageSender</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r16 rd" class="r16 r">messageReceiver</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r17 rd" class="r17 r">deadLetterReceiver</span>, <b>int</b> <span id="r18 rd" class="r18 r">messageCount</span>)
        {
            <span class="c">// Send messages</span>
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r15 r">messageSender</span>, <span class="r18 r">messageCount</span>);
 
            <span class="c">// Receive 5 messages and Deadletter them</span>
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r19 rd" class="r19 r">deadLetterMessageCount</span> = 5;
            <a href="@0@mscorlib/A.html#b19f71a84062554b" class="k">var</a> <span id="r20 rd" class="r20 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r16 r">messageReceiver</span>, <span class="r19 r">deadLetterMessageCount</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r20 r">receivedMessages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == <span class="r19 r">deadLetterMessageCount</span>);
 
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#b3cdd300658b14cc" class="i method">DeadLetterMessagesAsync</a>(<span class="r16 r">messageReceiver</span>, <span class="r20 r">receivedMessages</span>);
 
            <span class="c">// Receive and Complete 5 other regular messages</span>
            <span class="r20 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r16 r">messageReceiver</span>, <span class="r18 r">messageCount</span> - <span class="r19 r">deadLetterMessageCount</span>);
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#9eb316db0b44fff2" class="i method">CompleteMessagesAsync</a>(<span class="r16 r">messageReceiver</span>, <span class="r20 r">receivedMessages</span>);
 
            <span class="c">// TODO: After implementing Receive(WithTimeSpan), Add Try another Receive, We should not get anything.</span>
            <span class="c">// IEnumerable&lt;Message&gt; dummyMessages = await this.ReceiveMessagesAsync(queueClient, 10);</span>
            <span class="c">// Assert.True(dummyMessages == null);</span>
 
            <span class="c">// Receive 5 DLQ messages and Complete them</span>
            <span class="r20 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r17 r">deadLetterReceiver</span>, <span class="r19 r">deadLetterMessageCount</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r20 r">receivedMessages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == <span class="r19 r">deadLetterMessageCount</span>);
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#9eb316db0b44fff2" class="i method">CompleteMessagesAsync</a>(<span class="r17 r">deadLetterReceiver</span>, <span class="r20 r">receivedMessages</span>);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="03d4cc02161e6fbf" href="R/03d4cc02161e6fbf.html" target="n" data-glyph="74,1" class="i method">PeekLockDeferTestCase</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r21 rd" class="r21 r">messageSender</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r22 rd" class="r22 r">messageReceiver</span>, <b>int</b> <span id="r23 rd" class="r23 r">messageCount</span>)
        {
            <span class="c">// Send messages</span>
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r21 r">messageSender</span>, <span class="r23 r">messageCount</span>);
 
            <span class="c">// Receive 5 messages And Defer them</span>
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r24 rd" class="r24 r">deferMessagesCount</span> = 5;
            <a href="@0@mscorlib/A.html#b19f71a84062554b" class="k">var</a> <span id="r25 rd" class="r25 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r22 r">messageReceiver</span>, <span class="r24 r">deferMessagesCount</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r25 r">receivedMessages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == <span class="r24 r">deferMessagesCount</span>);
            <b>var</b> <span id="r26 rd" class="r26 r">sequenceNumbers</span> = <span class="r25 r">receivedMessages</span>.<span class="i">Select</span>(<span id="r27 rd" class="r27 r">receivedMessage</span> =&gt; <span class="r27 r">receivedMessage</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#205df32693f7a775" class="i property">SequenceNumber</a>).<span class="i">ToList</span>();
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#ce6e6b6a1638d0c0" class="i method">DeferMessagesAsync</a>(<span class="r22 r">messageReceiver</span>, <span class="r25 r">receivedMessages</span>);
 
            <span class="c">// Receive and Complete 5 other regular messages</span>
            <span class="r25 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r22 r">messageReceiver</span>, <span class="r23 r">messageCount</span> - <span class="r24 r">deferMessagesCount</span>);
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#9eb316db0b44fff2" class="i method">CompleteMessagesAsync</a>(<span class="r22 r">messageReceiver</span>, <span class="r25 r">receivedMessages</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r25 r">receivedMessages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == <span class="r23 r">messageCount</span> - <span class="r24 r">deferMessagesCount</span>);
 
            <span class="c">// Receive / Abandon deferred messages</span>
            <span class="r25 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<span class="i">ReceiveDeferredMessagesAsync</span>(<span class="r22 r">messageReceiver</span>, <span class="r26 r">sequenceNumbers</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r25 r">receivedMessages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == 5);
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#ce6e6b6a1638d0c0" class="i method">DeferMessagesAsync</a>(<span class="r22 r">messageReceiver</span>, <span class="r25 r">receivedMessages</span>);
 
            <span class="c">// Receive Again and Check delivery count</span>
            <span class="r25 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<span class="i">ReceiveDeferredMessagesAsync</span>(<span class="r22 r">messageReceiver</span>, <span class="r26 r">sequenceNumbers</span>);
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r28 rd" class="r28 r">count</span> = <span class="r25 r">receivedMessages</span>.<span class="i">Count</span>(<span id="r29 rd" class="r29 r">message</span> =&gt; <span class="r29 r">message</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#622acff6cf015d07" class="i property">DeliveryCount</a> == 3);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r28 r">count</span> == <span class="r25 r">receivedMessages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a>);
 
            <span class="c">// Complete messages</span>
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#9eb316db0b44fff2" class="i method">CompleteMessagesAsync</a>(<span class="r22 r">messageReceiver</span>, <span class="r25 r">receivedMessages</span>);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="1e520b587a4c6215" href="R/1e520b587a4c6215.html" target="n" data-glyph="74,1" class="i method">RenewLockTestCase</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r30 rd" class="r30 r">messageSender</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r31 rd" class="r31 r">messageReceiver</span>, <b>int</b> <span id="r32 rd" class="r32 r">messageCount</span>)
        {
            <span class="c">// Send messages</span>
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r30 r">messageSender</span>, <span class="r32 r">messageCount</span>);
 
            <span class="c">// Receive messages</span>
            <a href="@0@mscorlib/A.html#b19f71a84062554b" class="k">var</a> <span id="r33 rd" class="r33 r">receivedMessages</span> = <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r31 r">messageReceiver</span>, <span class="r32 r">messageCount</span>);
 
            <a href="/Microsoft.Azure.ServiceBus/A.html#74fc1aa4fea2b013" class="k">var</a> <span id="r34 rd" class="r34 r">message</span> = <span class="r33 r">receivedMessages</span>.<a href="@0@System.Core/A.html#bc8ae402a61dd9d6" class="i method">First</a>();
            <b>var</b> <span id="r35 rd" class="r35 r">firstLockedUntilUtcTime</span> = <span class="r34 r">message</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#0acddd863bcf3023" class="i property">LockedUntilUtc</a>;
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">MessageLockedUntil: </span>{<span class="r35 r">firstLockedUntilUtcTime</span>}<span class="s">&quot;</span>);
 
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">&quot;Sleeping 10 seconds...&quot;</span>);
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(10));
 
 
            <b>await</b> <span class="r31 r">messageReceiver</span>.<span class="i">RenewLockAsync</span>(<span class="r34 r">message</span>);
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">After First Renewal: </span>{<span class="r34 r">message</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#0acddd863bcf3023" class="i property">LockedUntilUtc</a>}<span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r34 r">message</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#0acddd863bcf3023" class="i property">LockedUntilUtc</a> &gt;= <span class="r35 r">firstLockedUntilUtcTime</span> + <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(10));
 
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">&quot;Sleeping 5 seconds...&quot;</span>);
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(5));
 
            <b>await</b> <span class="r31 r">messageReceiver</span>.<span class="i">RenewLockAsync</span>(<span class="r34 r">message</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#df44fd4ab3d58bb5" class="i property">LockToken</a>);
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">After Second Renewal: </span>{<span class="r34 r">message</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#0acddd863bcf3023" class="i property">LockedUntilUtc</a>}<span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r34 r">message</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#0acddd863bcf3023" class="i property">LockedUntilUtc</a> &gt;= <span class="r35 r">firstLockedUntilUtcTime</span> + <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(5));
 
            <span class="c">// Complete Messages</span>
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#9eb316db0b44fff2" class="i method">CompleteMessagesAsync</a>(<span class="r31 r">messageReceiver</span>, <span class="r33 r">receivedMessages</span>);
 
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r33 r">receivedMessages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == <span class="r32 r">messageCount</span>);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="aaf817333f921a8f" href="R/aaf817333f921a8f.html" target="n" data-glyph="74,1" class="i method">PeekAsyncTestCase</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r36 rd" class="r36 r">messageSender</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r37 rd" class="r37 r">messageReceiver</span>, <b>int</b> <span id="r38 rd" class="r38 r">messageCount</span>)
        {
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r36 r">messageSender</span>, <span class="r38 r">messageCount</span>);
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r39 rd" class="r39 r">peekedMessages</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="/Microsoft.Azure.ServiceBus/A.html#74fc1aa4fea2b013" class="t t">Message</a>&gt;();
            <span class="r39 r">peekedMessages</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#bb4c821231146bdc" class="i method">PeekMessageAsync</a>(<span class="r37 r">messageReceiver</span>));
            <span class="r39 r">peekedMessages</span>.<a href="@0@mscorlib/A.html#e569d850a66a1771" class="i method">AddRange</a>(<b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#a740c134910c3e43" class="i method">PeekMessagesAsync</a>(<span class="r37 r">messageReceiver</span>, <span class="r38 r">messageCount</span> - 1));
 
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r38 r">messageCount</span> == <span class="r39 r">peekedMessages</span>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a>);
            <b>long</b> <span id="r40 rd" class="r40 r">lastSequenceNumber</span> = -1;
            <b>foreach</b> (<a href="/Microsoft.Azure.ServiceBus/A.html#74fc1aa4fea2b013" class="k">var</a> <span id="r41 rd" class="r41 r">message</span> <b>in</b> <span class="r39 r">peekedMessages</span>)
            {
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r41 r">message</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#205df32693f7a775" class="i property">SequenceNumber</a> != <span class="r40 r">lastSequenceNumber</span>);
                <span class="r40 r">lastSequenceNumber</span> = <span class="r41 r">message</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#205df32693f7a775" class="i property">SequenceNumber</a>;
            }
 
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#62e8d3ab5939a194" class="i method">ReceiveMessagesAsync</a>(<span class="r37 r">messageReceiver</span>, <span class="r38 r">messageCount</span>);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="3c17b43a84a7b215" href="R/3c17b43a84a7b215.html" target="n" data-glyph="74,1" class="i method">ReceiveShouldReturnNoLaterThanServerWaitTimeTestCase</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r42 rd" class="r42 r">messageSender</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r43 rd" class="r43 r">messageReceiver</span>, <b>int</b> <span id="r44 rd" class="r44 r">messageCount</span>)
        {
            <a href="@0@System/A.html#ceb0ba9cc88de82e" class="k">var</a> <span id="r45 rd" class="r45 r">timer</span> = <a href="@0@System/A.html#ceb0ba9cc88de82e" class="t t">Stopwatch</a>.<a href="@0@System/A.html#dc0a41ceabc92682" class="i method">StartNew</a>();
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">starting Receive</span><span class="s">&quot;</span>);
            <b>var</b> <span id="r46 rd" class="r46 r">message</span> = <b>await</b> <span class="r43 r">messageReceiver</span>.<span class="i">ReceiveAsync</span>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(2));
            <span class="r45 r">timer</span>.<a href="@0@System/A.html#9dd6cac7fc1e2117" class="i method">Stop</a>();
 
            <span class="c">// If message is not null, then the queue needs to be cleaned up before running the timeout test.</span>
            <span class="i">Assert</span>.<span class="i">Null</span>(<span class="r46 r">message</span>);
 
            <span class="c">// Ensuring total time taken is less than 60 seconds, which is the default timeout for receive.</span>
            <span class="c">// Keeping the value of 40 to avoid flakiness in test infrastructure which may lead to extended time taken.</span>
            <span class="c">// Todo: Change this value to a lower number once test infra is performant.</span>
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">Elapsed Milliseconds: </span>{<span class="r45 r">timer</span>.<a href="@0@System/A.html#60e03fb80c10ec79" class="i property">Elapsed</a>.<a href="@0@mscorlib/A.html#0001a4a9e0a9b848" class="i property">TotalMilliseconds</a>}<span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r45 r">timer</span>.<a href="@0@System/A.html#60e03fb80c10ec79" class="i property">Elapsed</a>.<a href="@0@mscorlib/A.html#061d7498e3227cfb" class="i property">TotalSeconds</a> &lt; 40);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="1b456e4edcd3fbf8" href="R/1b456e4edcd3fbf8.html" target="n" data-glyph="74,1" class="i method">ReceiveShouldThrowForServerTimeoutZero</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r47 rd" class="r47 r">messageReceiver</span>)
        {
            <b>await</b> <span class="i">Assert</span>.<span class="i">ThrowsAsync</span>&lt;<a href="@0@mscorlib/A.html#2975f0aa875d4a32" class="t t">ArgumentOutOfRangeException</a>&gt;(() =&gt; <span class="r47 r">messageReceiver</span>.<span class="i">ReceiveAsync</span>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#225346b4cd3a8300" class="i field">Zero</a>));
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="b4a9be766f8d22a0" href="R/b4a9be766f8d22a0.html" target="n" data-glyph="74,1" class="i method">ScheduleMessagesAppearAfterScheduledTimeAsyncTestCase</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r48 rd" class="r48 r">messageSender</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r49 rd" class="r49 r">messageReceiver</span>, <b>int</b> <span id="r50 rd" class="r50 r">messageCount</span>)
        {
            <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="k">var</a> <span id="r51 rd" class="r51 r">startTime</span> = <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#b0d5e4c9a8d4ddac" class="i property">UtcNow</a>;
            <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="k">var</a> <span id="r52 rd" class="r52 r">scheduleTime</span> = <b>new</b> <a href="@0@mscorlib/A.html#799efb65ff67135d" class="t constructor">DateTimeOffset</a>(<a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#b0d5e4c9a8d4ddac" class="i property">UtcNow</a>).<a href="@0@mscorlib/A.html#b1f3371f1ec3f990" class="i method">AddSeconds</a>(5);
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">Sending message with schedule time: </span>{<span class="r52 r">scheduleTime</span>.<a href="@0@mscorlib/A.html#ae3e62dcd82c2422" class="i property">UtcDateTime</a>}<span class="s">&quot;</span>);
 
            <b>var</b> <span id="r53 rd" class="r53 r">sequenceNumber</span> =
                <b>await</b>
                    <span class="r48 r">messageSender</span>.<span class="i">ScheduleMessageAsync</span>(
                        <b>new</b> <span class="t">Message</span>(<a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#a10eb90a3d884500" class="i property">UTF8</a>.<a href="@0@mscorlib/A.html#83f2d2c6f22db1a9" class="i method">GetBytes</a>(<span class="s">&quot;Test&quot;</span>)) { <a href="/Microsoft.Azure.ServiceBus/A.html#6b02c9ff5b03ba9c" class="i property">MessageId</a> = <span class="s">&quot;randomId&quot;</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#754634e7bae5f519" class="i property">Label</a> = <span class="s">&quot;randomLabel&quot;</span> }, <span class="r52 r">scheduleTime</span>);
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">Received sequence number: </span>{<span class="r53 r">sequenceNumber</span>}<span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r53 r">sequenceNumber</span> &gt; 0);
 
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">&quot;Sleeping for 5 seconds...&quot;</span>);
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(5));
 
            <b>var</b> <span id="r54 rd" class="r54 r">message</span> = <b>await</b> <span class="r49 r">messageReceiver</span>.<span class="i">ReceiveAsync</span>();
 
            <span class="c">// Asserting using Math.Ceiling since TotalSeconds usually ends up being around 4.999 due to precision of</span>
            <span class="c">// the scheduleTime in requestMessage and responseMessage.</span>
            <span class="i">Assert</span>.<span class="i">True</span>(<a href="@0@mscorlib/A.html#a4407e67b9a5afad" class="t t">Math</a>.<span class="i">Ceiling</span>(<span class="r54 r">message</span>.<span class="i">ScheduledEnqueueTimeUtc</span>.<span class="i">Subtract</span>(<span class="r51 r">startTime</span>).<span class="i">TotalSeconds</span>) &gt;= 5);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="ecd6d9c7f5c4128a" href="R/ecd6d9c7f5c4128a.html" target="n" data-glyph="74,1" class="i method">CancelScheduledMessagesAsyncTestCase</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r55 rd" class="r55 r">messageSender</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r56 rd" class="r56 r">messageReceiver</span>, <b>int</b> <span id="r57 rd" class="r57 r">messageCount</span>)
        {
            <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="k">var</a> <span id="r58 rd" class="r58 r">scheduleTime</span> = <b>new</b> <a href="@0@mscorlib/A.html#799efb65ff67135d" class="t constructor">DateTimeOffset</a>(<a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#b0d5e4c9a8d4ddac" class="i property">UtcNow</a>).<a href="@0@mscorlib/A.html#b1f3371f1ec3f990" class="i method">AddSeconds</a>(30);
            <a href="/Microsoft.Azure.ServiceBus/A.html#74fc1aa4fea2b013" class="k">var</a> <span id="r59 rd" class="r59 r">brokeredMessage</span> = <b>new</b> <span class="t">Message</span>(<a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#a10eb90a3d884500" class="i property">UTF8</a>.<a href="@0@mscorlib/A.html#83f2d2c6f22db1a9" class="i method">GetBytes</a>(<span class="s">&quot;Test1&quot;</span>)) { <a href="/Microsoft.Azure.ServiceBus/A.html#6b02c9ff5b03ba9c" class="i property">MessageId</a> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>() };
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(
                <span class="s">$&quot;</span><span class="s">Sending message with schedule time: </span>{<span class="r58 r">scheduleTime</span>.<a href="@0@mscorlib/A.html#ae3e62dcd82c2422" class="i property">UtcDateTime</a>}<span class="s"> and messageID </span>{<span class="r59 r">brokeredMessage</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#6b02c9ff5b03ba9c" class="i property">MessageId</a>}<span class="s">&quot;</span>);
 
            <b>var</b> <span id="r60 rd" class="r60 r">sequenceNumber</span> = <b>await</b> <span class="r55 r">messageSender</span>.<span class="i">ScheduleMessageAsync</span>(<span class="r59 r">brokeredMessage</span>, <span class="r58 r">scheduleTime</span>);
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">Received sequence number: </span>{<span class="r60 r">sequenceNumber</span>}<span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r60 r">sequenceNumber</span> &gt; 0);
 
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">&quot;Cancelling scheduled message&quot;</span>);
            <b>await</b> <span class="r55 r">messageSender</span>.<span class="i">CancelScheduledMessageAsync</span>(<span class="r60 r">sequenceNumber</span>);
 
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">&quot;Sleeping for 30 seconds...&quot;</span>);
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(30));
 
            <span class="c">// Sending a dummy message so that ReceiveAsync(2) returns immediately after getting 1 message</span>
            <span class="c">// instead of waiting for connection timeout on a single message.</span>
            <b>await</b> <span class="r55 r">messageSender</span>.<span class="i">SendAsync</span>(<b>new</b> <span class="t">Message</span>(<a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#a10eb90a3d884500" class="i property">UTF8</a>.<a href="@0@mscorlib/A.html#83f2d2c6f22db1a9" class="i method">GetBytes</a>((<span class="s">&quot;Dummy&quot;</span>))) { <a href="/Microsoft.Azure.ServiceBus/A.html#6b02c9ff5b03ba9c" class="i property">MessageId</a> = <span class="s">&quot;Dummy&quot;</span> });
            <a href="@0@mscorlib/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="/Microsoft.Azure.ServiceBus/A.html#74fc1aa4fea2b013" class="t t">Message</a>&gt; <span id="r61 rd" class="r61 r">messages</span> = <b>null</b>;
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r62 rd" class="r62 r">retryCount</span> = 5;
            <b>while</b> (<span class="r61 r">messages</span> == <b>null</b> &amp;&amp; --<span class="r62 r">retryCount</span> &gt; 0)
            {
                <span class="r61 r">messages</span> = <b>await</b> <span class="r56 r">messageReceiver</span>.<span class="i">ReceiveAsync</span>(2);
            }
 
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r61 r">messages</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r61 r">messages</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a> == 1);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r61 r">messages</span>.<a href="@0@System.Core/A.html#bc8ae402a61dd9d6" class="i method">First</a>().<a href="/Microsoft.Azure.ServiceBus/A.html#6b02c9ff5b03ba9c" class="i property">MessageId</a> == <span class="s">&quot;Dummy&quot;</span>);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="13a76d5e4655b75e" href="R/13a76d5e4655b75e.html" target="n" data-glyph="74,1" class="i method">OnMessageAsyncTestCase</a>(
            <a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r63 rd" class="r63 r">messageSender</span>,
            <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r64 rd" class="r64 r">messageReceiver</span>,
            <b>int</b> <span id="r65 rd" class="r65 r">maxConcurrentCalls</span>,
            <b>bool</b> <span id="r66 rd" class="r66 r">autoComplete</span>,
            <b>int</b> <span id="r67 rd" class="r67 r">messageCount</span>)
        {
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r68 rd" class="r68 r">count</span> = 0;
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r63 r">messageSender</span>, <span class="r67 r">messageCount</span>);
            <span class="r64 r">messageReceiver</span>.<span class="i">RegisterMessageHandler</span>(
                <b>async</b> (<span id="r69 rd" class="r69 r">message</span>, <span id="r70 rd" class="r70 r">token</span>) =&gt;
                {
                    <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">Received message: SequenceNumber: </span>{<span class="r69 r">message</span>.<span class="i">SystemProperties</span>.<span class="i">SequenceNumber</span>}<span class="s">&quot;</span>);
                    <b>if</b> (<span class="r64 r">messageReceiver</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#de85a8b250a9e503" class="i property">ReceiveMode</a> == <a href="/Microsoft.Azure.ServiceBus/A.html#103867a98d0233a8" class="t t">ReceiveMode</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#d43dbf05f584f89c" class="i field">PeekLock</a> &amp;&amp; !<span class="r66 r">autoComplete</span>)
                    {
                        <b>await</b> <span class="r64 r">messageReceiver</span>.<span class="i">CompleteAsync</span>(<span class="r69 r">message</span>.<span class="i">SystemProperties</span>.<span class="i">LockToken</span>);
                    }
                    <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#09bb1e21afd76cf2" class="i method">Increment</a>(<b>ref</b> <span class="r68 r">count</span>);
                },
                <b>new</b> <span class="t">MessageHandlerOptions</span>(<span class="i">ExceptionReceivedHandler</span>) { <a href="/Microsoft.Azure.ServiceBus/A.html#509915be09c76c53" class="i property">MaxConcurrentCalls</a> = <span class="r65 r">maxConcurrentCalls</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#9b4709d2b9e84179" class="i property">AutoComplete</a> = <span class="r66 r">autoComplete</span> });
 
            <span class="c">// Wait for the OnMessage Tasks to finish</span>
            <a href="@0@System/A.html#ceb0ba9cc88de82e" class="k">var</a> <span id="r71 rd" class="r71 r">stopwatch</span> = <a href="@0@System/A.html#ceb0ba9cc88de82e" class="t t">Stopwatch</a>.<a href="@0@System/A.html#dc0a41ceabc92682" class="i method">StartNew</a>();
            <b>while</b> (<span class="r71 r">stopwatch</span>.<a href="@0@System/A.html#60e03fb80c10ec79" class="i property">Elapsed</a>.<a href="@0@mscorlib/A.html#061d7498e3227cfb" class="i property">TotalSeconds</a> &lt;= 60)
            {
                <b>if</b> (<span class="r68 r">count</span> == <span class="r67 r">messageCount</span>)
                {
                    <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">All &#39;</span>{<span class="r67 r">messageCount</span>}<span class="s">&#39; messages Received.</span><span class="s">&quot;</span>);
                    <b>break</b>;
                }
                <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(5));
            }
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r68 r">count</span> == <span class="r67 r">messageCount</span>);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="7bc668a87a5260fe" href="R/7bc668a87a5260fe.html" target="n" data-glyph="74,1" class="i method">OnMessageAsyncUnregisterHandlerLongTimeoutTestCase</a>(
            <a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r72 rd" class="r72 r">messageSender</span>,
            <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r73 rd" class="r73 r">messageReceiver</span>,
            <b>int</b> <span id="r74 rd" class="r74 r">maxConcurrentCalls</span>,
            <b>bool</b> <span id="r75 rd" class="r75 r">autoComplete</span>,
            <b>int</b> <span id="r76 rd" class="r76 r">messageCount</span>)
        {
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r77 rd" class="r77 r">count</span> = 0;
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r72 r">messageSender</span>, <span class="r76 r">messageCount</span>);
            <span class="r73 r">messageReceiver</span>.<span class="i">RegisterMessageHandler</span>(
                <b>async</b> (<span id="r78 rd" class="r78 r">message</span>, <span id="r79 rd" class="r79 r">token</span>) =&gt;
                {
                    <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">Received message: SequenceNumber: </span>{<span class="r78 r">message</span>.<span class="i">SystemProperties</span>.<span class="i">SequenceNumber</span>}<span class="s">&quot;</span>);
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(8));
                    <b>if</b> (<span class="r73 r">messageReceiver</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#de85a8b250a9e503" class="i property">ReceiveMode</a> == <a href="/Microsoft.Azure.ServiceBus/A.html#103867a98d0233a8" class="t t">ReceiveMode</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#d43dbf05f584f89c" class="i field">PeekLock</a> &amp;&amp; !<span class="r75 r">autoComplete</span>)
                    {
                        <b>await</b> <span class="r73 r">messageReceiver</span>.<span class="i">CompleteAsync</span>(<span class="r78 r">message</span>.<span class="i">SystemProperties</span>.<span class="i">LockToken</span>);
                    }
                    <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#09bb1e21afd76cf2" class="i method">Increment</a>(<b>ref</b> <span class="r77 r">count</span>);
 
                },
                <b>new</b> <span class="t">MessageHandlerOptions</span>(<span class="i">ExceptionReceivedHandler</span>) { <a href="/Microsoft.Azure.ServiceBus/A.html#509915be09c76c53" class="i property">MaxConcurrentCalls</a> = <span class="r74 r">maxConcurrentCalls</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#9b4709d2b9e84179" class="i property">AutoComplete</a> = <span class="r75 r">autoComplete</span> });
 
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(2));
            <span class="c">// UnregisterMessageHandlerAsync should wait up to the provided timeout to finish the message handling tasks</span>
            <b>await</b> <span class="r73 r">messageReceiver</span>.<span class="i">UnregisterMessageHandlerAsync</span>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(20)); 
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r77 r">count</span> == <span class="r74 r">maxConcurrentCalls</span>);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="cb2e73a16f8d631e" href="R/cb2e73a16f8d631e.html" target="n" data-glyph="74,1" class="i method">OnMessageAsyncUnregisterHandlerShortTimeoutTestCase</a>(
            <a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r80 rd" class="r80 r">messageSender</span>,
            <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r81 rd" class="r81 r">messageReceiver</span>,
            <b>int</b> <span id="r82 rd" class="r82 r">maxConcurrentCalls</span>,
            <b>bool</b> <span id="r83 rd" class="r83 r">autoComplete</span>,
            <b>int</b> <span id="r84 rd" class="r84 r">messageCount</span>)
        {
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r85 rd" class="r85 r">count</span> = 0;
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r80 r">messageSender</span>, <span class="r84 r">messageCount</span>);
            <span class="r81 r">messageReceiver</span>.<span class="i">RegisterMessageHandler</span>(
                <b>async</b> (<span id="r86 rd" class="r86 r">message</span>, <span id="r87 rd" class="r87 r">token</span>) =&gt;
                {
                    <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">Received message: SequenceNumber: </span>{<span class="r86 r">message</span>.<span class="i">SystemProperties</span>.<span class="i">SequenceNumber</span>}<span class="s">&quot;</span>);
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(8));
                    <b>if</b> (<span class="r81 r">messageReceiver</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#de85a8b250a9e503" class="i property">ReceiveMode</a> == <a href="/Microsoft.Azure.ServiceBus/A.html#103867a98d0233a8" class="t t">ReceiveMode</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#d43dbf05f584f89c" class="i field">PeekLock</a> &amp;&amp; !<span class="r83 r">autoComplete</span>)
                    {
                        <b>await</b> <span class="r81 r">messageReceiver</span>.<span class="i">CompleteAsync</span>(<span class="r86 r">message</span>.<span class="i">SystemProperties</span>.<span class="i">LockToken</span>);
                    }
                    <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#09bb1e21afd76cf2" class="i method">Increment</a>(<b>ref</b> <span class="r85 r">count</span>);
                },
                <b>new</b> <span class="t">MessageHandlerOptions</span>(<span class="i">ExceptionReceivedHandler</span>) { <a href="/Microsoft.Azure.ServiceBus/A.html#509915be09c76c53" class="i property">MaxConcurrentCalls</a> = <span class="r82 r">maxConcurrentCalls</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#9b4709d2b9e84179" class="i property">AutoComplete</a> = <span class="r83 r">autoComplete</span> });
 
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(2));
            <b>await</b> <span class="r81 r">messageReceiver</span>.<span class="i">UnregisterMessageHandlerAsync</span>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(2)); 
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r85 r">count</span> == 0);
        }
 
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="f9e7d4609e7688e2" href="R/f9e7d4609e7688e2.html" target="n" data-glyph="74,1" class="i method">OnMessageRegistrationWithoutPendingMessagesTestCase</a>(
            <a href="/Microsoft.Azure.ServiceBus/A.html#233b41083166efc5" class="t t">IMessageSender</a> <span id="r88 rd" class="r88 r">messageSender</span>,
            <a href="/Microsoft.Azure.ServiceBus/A.html#d29af89efe5d7233" class="t t">IMessageReceiver</a> <span id="r89 rd" class="r89 r">messageReceiver</span>,
            <b>int</b> <span id="r90 rd" class="r90 r">maxConcurrentCalls</span>,
            <b>bool</b> <span id="r91 rd" class="r91 r">autoComplete</span>)
        {
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r92 rd" class="r92 r">count</span> = 0;
            <span class="r89 r">messageReceiver</span>.<span class="i">RegisterMessageHandler</span>(
                <b>async</b> (<span id="r93 rd" class="r93 r">message</span>, <span id="r94 rd" class="r94 r">token</span>) =&gt;
                {
                    <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">Received message: SequenceNumber: </span>{<span class="r93 r">message</span>.<span class="i">SystemProperties</span>.<span class="i">SequenceNumber</span>}<span class="s">&quot;</span>);
                    <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#09bb1e21afd76cf2" class="i method">Increment</a>(<b>ref</b> <span class="r92 r">count</span>);
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#66f1c3e3e272f591" class="i property">CompletedTask</a>;
                },
                <b>new</b> <span class="t">MessageHandlerOptions</span>(<span class="i">ExceptionReceivedHandler</span>) { <a href="/Microsoft.Azure.ServiceBus/A.html#509915be09c76c53" class="i property">MaxConcurrentCalls</a> = <span class="r90 r">maxConcurrentCalls</span>, <a href="/Microsoft.Azure.ServiceBus/A.html#9b4709d2b9e84179" class="i property">AutoComplete</a> = <span class="r91 r">autoComplete</span> });
 
            <b>await</b> <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#21210fe95a0e49c7" class="i method">SendMessagesAsync</a>(<span class="r88 r">messageSender</span>, 1);
 
            <a href="@0@System/A.html#ceb0ba9cc88de82e" class="k">var</a> <span id="r95 rd" class="r95 r">stopwatch</span> = <a href="@0@System/A.html#ceb0ba9cc88de82e" class="t t">Stopwatch</a>.<a href="@0@System/A.html#dc0a41ceabc92682" class="i method">StartNew</a>();
            <b>while</b> (<span class="r95 r">stopwatch</span>.<a href="@0@System/A.html#60e03fb80c10ec79" class="i property">Elapsed</a>.<a href="@0@mscorlib/A.html#061d7498e3227cfb" class="i property">TotalSeconds</a> &lt;= 20)
            {
                <b>if</b> (<span class="r92 r">count</span> == 1)
                {
                    <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">All messages Received.</span><span class="s">&quot;</span>);
                    <b>break</b>;
                }
                <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(5));
            }
 
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span>{<a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#1cd5dd408a32124f" class="i property">Now</a>}<span class="s">: MessagesReceived: </span>{<span class="r92 r">count</span>}<span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r92 r">count</span> == 1);
        }
 
        <b>private</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="c73dec68d99e7a79" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ExceptionReceivedHandler</a>(<a href="/Microsoft.Azure.ServiceBus/A.html#01e408e41b2c7c71" class="t t">ExceptionReceivedEventArgs</a> <span id="r96 rd" class="r96 r">eventArgs</span>)
        {
            <a href="Infrastructure/TestUtility.cs.html#3d9d7f837b56950e" class="t t">TestUtility</a>.<a href="Infrastructure/TestUtility.cs.html#4a99fa089baf84a7" class="i method">Log</a>(<span class="s">$&quot;</span><span class="s">Exception Received: ClientId: </span>{<span class="r96 r">eventArgs</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#c03d01e831308e8e" class="i property">ExceptionReceivedContext</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#de822b09520d983b" class="i property">ClientId</a>}<span class="s">, EntityPath: </span>{<span class="r96 r">eventArgs</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#c03d01e831308e8e" class="i property">ExceptionReceivedContext</a>.<a href="/Microsoft.Azure.ServiceBus/A.html#d56dff64e63019fa" class="i property">EntityPath</a>}<span class="s">, Exception: </span>{<span class="r96 r">eventArgs</span>.<a href="/Microsoft.Azure.ServiceBus/A.html#280cf45235443910" class="i property">Exception</a>.<span class="i">Message</span>}<span class="s">&quot;</span>);
            <b>return</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#66f1c3e3e272f591" class="i property">CompletedTask</a>;
        }
    }
}</pre></td></tr></table></div></body></html>
