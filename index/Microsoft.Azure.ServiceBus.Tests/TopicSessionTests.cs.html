<!DOCTYPE html>
<html><head><title>TopicSessionTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(298);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.ServiceBus.Tests/TopicSessionTests.cs" target="_top">TopicSessionTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.ServiceBus.Tests" target="_top">Microsoft.Azure.ServiceBus.Tests.csproj</a> (Microsoft.Azure.ServiceBus.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft. All rights reserved.</span>
<span class="c">// Licensed under the MIT license. See LICENSE file in the project root for full license information.</span>
 
<span class="c">// TODO: Commenting the whole file. It will be updated once OnSession() is implemented.</span>
<span class="c">/*
namespace Microsoft.Azure.ServiceBus.UnitTests
{
    using System;
    using System.Collections.Generic;
    using System.Diagnostics;
    using System.IO;
    using System.Text;
    using System.Threading.Tasks;
    using Xunit;
 
    public sealed class TopicSessionTests
    {
        public static IEnumerable&lt;object&gt; TestPermutations =&gt; new object[]
        {
            new object[] { Constants.NonPartitionedSessionTopicName },
            new object[] { Constants.PartitionedSessionTopicName }
        };
 
        string SubscriptionName =&gt; TestConstants.SessionSubscriptionName;
 
        [Theory]
        [MemberData(nameof(TestPermutations))]
        [DisplayTestMethodName]
        async Task SessionTest(string topicName)
        {
            var entityConnectionString = TestUtility.GetEntityConnectionString(topicName);
            var messagingFactory = new ServiceBusClientFactory();
            var topicClient = messagingFactory.CreateTopicClientFromConnectionString(entityConnectionString);
            var subscriptionClient =
                (SubscriptionClient)messagingFactory.CreateSubscriptionClientFromConnectionString(
                    entityConnectionString,
                    this.SubscriptionName);
            try
            {
                var messageId1 = &quot;test-message1&quot;;
                var sessionId1 = &quot;sessionId1&quot;;
                await topicClient.SendAsync(new Message() { MessageId = messageId1, SessionId = sessionId1 });
                TestUtility.Log($&quot;Sent Message: {messageId1} to Session: {sessionId1}&quot;);
 
                var messageId2 = &quot;test-message2&quot;;
                var sessionId2 = &quot;sessionId2&quot;;
                await topicClient.SendAsync(new Message() { MessageId = messageId2, SessionId = sessionId2 });
                TestUtility.Log($&quot;Sent Message: {messageId2} to Session: {sessionId2}&quot;);
 
                // Receive Message, Complete and Close with SessionId - sessionId 1
                await this.AcceptAndCompleteSessionsAsync(subscriptionClient, sessionId1, messageId1);
 
                // Receive Message, Complete and Close with SessionId - sessionId 2
                await this.AcceptAndCompleteSessionsAsync(subscriptionClient, sessionId2, messageId2);
 
                // Receive Message, Complete and Close - With Null SessionId specified
                var messageId3 = &quot;test-message3&quot;;
                var sessionId3 = &quot;sessionId3&quot;;
                await topicClient.SendAsync(new Message() { MessageId = messageId3, SessionId = sessionId3 });
 
                await this.AcceptAndCompleteSessionsAsync(subscriptionClient, null, messageId3);
            }
            finally
            {
                await subscriptionClient.CloseAsync();
                await topicClient.CloseAsync();
            }
        }
 
        [Theory]
        [MemberData(nameof(TestPermutations))]
        [DisplayTestMethodName]
        async Task GetAndSetSessionStateTest(string topicName)
        {
            var entityConnectionString = TestUtility.GetEntityConnectionString(topicName);
            var messagingFactory = new ServiceBusClientFactory();
            var topicClient = messagingFactory.CreateTopicClientFromConnectionString(entityConnectionString);
            var subscriptionClient =
                messagingFactory.CreateSubscriptionClientFromConnectionString(
                    entityConnectionString,
                    this.SubscriptionName);
            try
            {
                var messageId = &quot;test-message1&quot;;
                var sessionId = Guid.NewGuid().ToString();
                await topicClient.SendAsync(new Message() { MessageId = messageId, SessionId = sessionId });
                TestUtility.Log($&quot;Sent Message: {messageId} to Session: {sessionId}&quot;);
 
                var sessionReceiver = await subscriptionClient.AcceptMessageSessionAsync(sessionId);
                Assert.NotNull(sessionReceiver);
                var message = await sessionReceiver.ReceiveAsync();
                TestUtility.Log($&quot;Received Message: {message.MessageId} from Session: {sessionReceiver.SessionId}&quot;);
                Assert.True(message.MessageId == messageId);
 
                var sessionStateString = &quot;Received Message From Session!&quot;;
                var sessionState = new MemoryStream(Encoding.UTF8.GetBytes(sessionStateString));
                await sessionReceiver.SetStateAsync(sessionState);
                TestUtility.Log($&quot;Set Session State: {sessionStateString} for Session: {sessionReceiver.SessionId}&quot;);
 
                var returnedSessionState = await sessionReceiver.GetStateAsync();
                using (var reader = new StreamReader(returnedSessionState, Encoding.UTF8))
                {
                    var returnedSessionStateString = await reader.ReadToEndAsync();
                    TestUtility.Log($&quot;Get Session State Returned: {returnedSessionStateString} for Session: {sessionReceiver.SessionId}&quot;);
                    Assert.Equal(sessionStateString, returnedSessionStateString);
                }
 
                // Complete message using Session Receiver
                await sessionReceiver.CompleteAsync(new Guid[] { message.LockToken });
                TestUtility.Log($&quot;Completed Message: {message.MessageId} for Session: {sessionReceiver.SessionId}&quot;);
 
                sessionStateString = &quot;Completed Message On Session!&quot;;
                sessionState = new MemoryStream(Encoding.UTF8.GetBytes(sessionStateString));
                await sessionReceiver.SetStateAsync(sessionState);
                TestUtility.Log($&quot;Set Session State: {sessionStateString} for Session: {sessionReceiver.SessionId}&quot;);
 
                returnedSessionState = await sessionReceiver.GetStateAsync();
                using (var reader = new StreamReader(returnedSessionState, Encoding.UTF8))
                {
                    var returnedSessionStateString = await reader.ReadToEndAsync();
                    TestUtility.Log($&quot;Get Session State Returned: {returnedSessionStateString} for Session: {sessionReceiver.SessionId}&quot;);
                    Assert.Equal(sessionStateString, returnedSessionStateString);
                }
 
                await sessionReceiver.CloseAsync();
            }
            finally
            {
                await subscriptionClient.CloseAsync();
                await topicClient.CloseAsync();
            }
        }
 
        [Theory]
        [MemberData(nameof(TestPermutations))]
        [DisplayTestMethodName]
        async Task SessionRenewLockTestCase(string topicName)
        {
            var entityConnectionString = TestUtility.GetEntityConnectionString(topicName);
            var messagingFactory = new ServiceBusClientFactory();
            var topicClient = messagingFactory.CreateTopicClientFromConnectionString(entityConnectionString);
            var subscriptionClient =
                messagingFactory.CreateSubscriptionClientFromConnectionString(
                    entityConnectionString,
                    this.SubscriptionName);
            try
            {
                var messageId = &quot;test-message1&quot;;
                var sessionId = Guid.NewGuid().ToString();
                await topicClient.SendAsync(new Message() { MessageId = messageId, SessionId = sessionId });
                TestUtility.Log($&quot;Sent Message: {messageId} to Session: {sessionId}&quot;);
 
                var sessionReceiver = await subscriptionClient.AcceptMessageSessionAsync(sessionId);
                Assert.NotNull(sessionReceiver);
                var initialSessionLockedUntilTime = sessionReceiver.LockedUntilUtc;
                TestUtility.Log($&quot;Session LockedUntilUTC: {initialSessionLockedUntilTime} for Session: {sessionReceiver.SessionId}&quot;);
                var message = await sessionReceiver.ReceiveAsync();
                TestUtility.Log($&quot;Received Message: {message.MessageId} from Session: {sessionReceiver.SessionId}&quot;);
                Assert.True(message.MessageId == messageId);
 
                TestUtility.Log(&quot;Sleeping 10 seconds...&quot;);
                await Task.Delay(TimeSpan.FromSeconds(10));
 
                await sessionReceiver.RenewLockAsync();
                var firstLockedUntilUtcTime = sessionReceiver.LockedUntilUtc;
                TestUtility.Log($&quot;After Renew Session LockedUntilUTC: {firstLockedUntilUtcTime} for Session: {sessionReceiver.SessionId}&quot;);
                Assert.True(firstLockedUntilUtcTime &gt;= initialSessionLockedUntilTime + TimeSpan.FromSeconds(10));
 
                TestUtility.Log(&quot;Sleeping 5 seconds...&quot;);
                await Task.Delay(TimeSpan.FromSeconds(5));
 
                await sessionReceiver.RenewLockAsync();
                TestUtility.Log($&quot;After Second Renew Session LockedUntilUTC: {sessionReceiver.LockedUntilUtc} for Session: {sessionReceiver.SessionId}&quot;);
                Assert.True(sessionReceiver.LockedUntilUtc &gt;= firstLockedUntilUtcTime + TimeSpan.FromSeconds(5));
                await message.CompleteAsync();
                TestUtility.Log($&quot;Completed Message: {message.MessageId} for Session: {sessionReceiver.SessionId}&quot;);
                await sessionReceiver.CloseAsync();
            }
            finally
            {
                await subscriptionClient.CloseAsync();
                await topicClient.CloseAsync();
            }
        }
 
        [Theory]
        [MemberData(nameof(TestPermutations))]
        [DisplayTestMethodName]
        async Task PeekSessionAsyncTest(string topicName, int messageCount = 10)
        {
            var entityConnectionString = TestUtility.GetEntityConnectionString(topicName);
            var messagingFactory = new ServiceBusClientFactory();
            var topicClient = messagingFactory.CreateTopicClientFromConnectionString(entityConnectionString);
            var subscriptionClient =
                (SubscriptionClient)messagingFactory.CreateSubscriptionClientFromConnectionString(
                    entityConnectionString,
                    this.SubscriptionName,
                    ReceiveMode.ReceiveAndDelete);
            try
            {
                var messageId1 = &quot;test-message1&quot;;
                var sessionId1 = &quot;sessionId1&quot;;
                await topicClient.SendAsync(new Message() { MessageId = messageId1, SessionId = sessionId1 });
                TestUtility.Log($&quot;Sent Message: {messageId1} to Session: {sessionId1}&quot;);
 
                var messageId2 = &quot;test-message2&quot;;
                var sessionId2 = &quot;sessionId2&quot;;
                await topicClient.SendAsync(new Message() { MessageId = messageId2, SessionId = sessionId2 });
                TestUtility.Log($&quot;Sent Message: {messageId2} to Session: {sessionId2}&quot;);
 
                // Peek Message, Receive and Delete with SessionId - sessionId 1
                await this.PeekAndDeleteMessageAsync(subscriptionClient, sessionId1, messageId1);
 
                // Peek Message, Receive and Delete with SessionId - sessionId 2
                await this.PeekAndDeleteMessageAsync(subscriptionClient, sessionId2, messageId2);
            }
            finally
            {
                await subscriptionClient.CloseAsync();
                await topicClient.CloseAsync();
            }
        }
 
        [Theory]
        [MemberData(nameof(TestPermutations))]
        [DisplayTestMethodName]
        async Task AcceptSessionShouldReturnNoLaterThanServerWaitTimeTestCase(string topicName, int messageCount = 1)
        {
            var entityConnectionString = TestUtility.GetEntityConnectionString(topicName);
            var messagingFactory = new ServiceBusClientFactory();
            var subscriptionClient =
                (SubscriptionClient)messagingFactory.CreateSubscriptionClientFromConnectionString(
                    entityConnectionString,
                    this.SubscriptionName,
                    ReceiveMode.ReceiveAndDelete);
            try
            {
                Stopwatch timer = Stopwatch.StartNew();
 
                MessageSession sessionReceiver = null;
                try
                {
                    sessionReceiver = await subscriptionClient.AcceptMessageSessionAsync(TimeSpan.FromSeconds(2));
                }
                catch (TimeoutException)
                {
                }
                timer.Stop();
 
                // If sessionId is not null, then the queue needs to be cleaned up before running the timeout test.
                Assert.Null(sessionReceiver?.SessionId);
 
                // Ensuring total time taken is less than 60 seconds, which is the default timeout for AcceptMessageSessionAsync.
                // Keeping the value of 40 to avoid flakiness in test infrastructure which may lead to extended time taken.
                // Todo: Change this value to a lower number once test infra is performant.
                Assert.True(timer.Elapsed.TotalSeconds &lt; 40);
            }
            finally
            {
                await subscriptionClient.CloseAsync();
            }
        }
 
        async Task AcceptAndCompleteSessionsAsync(SubscriptionClient subscriptionClient, string sessionId, string messageId)
        {
            var sessionReceiver = await subscriptionClient.AcceptMessageSessionAsync(sessionId);
            if (sessionId != null)
            {
                Assert.True(sessionReceiver.SessionId == sessionId);
            }
            var message = await sessionReceiver.ReceiveAsync();
            Assert.True(message.MessageId == messageId);
            TestUtility.Log($&quot;Received Message: {message.MessageId} from Session: {sessionReceiver.SessionId}&quot;);
            await message.CompleteAsync();
            TestUtility.Log($&quot;Completed Message: {message.MessageId} for Session: {sessionReceiver.SessionId}&quot;);
        }
 
        async Task PeekAndDeleteMessageAsync(SubscriptionClient queueClient, string sessionId, string messageId)
        {
            var sessionReceiver = await queueClient.AcceptMessageSessionAsync(sessionId);
            if (sessionId != null)
            {
                Assert.True(sessionReceiver.SessionId == sessionId);
            }
 
            var message = await sessionReceiver.PeekAsync();
            Assert.True(message.MessageId == messageId);
            TestUtility.Log($&quot;Peeked Message: {message.MessageId} from Session: {sessionReceiver.SessionId}&quot;);
 
            message = await sessionReceiver.ReceiveAsync();
            Assert.True(message.MessageId == messageId);
            TestUtility.Log($&quot;Received Message: {message.MessageId} from Session: {sessionReceiver.SessionId}&quot;);
 
            await sessionReceiver.CloseAsync();
        }
    }
}
*/</span></pre></td></tr></table></div></body></html>
