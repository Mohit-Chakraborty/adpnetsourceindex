<!DOCTYPE html>
<html><head><title>DatabaseAccountOperationsTests.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(305);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.ResourceManager.CosmosDB.Tests/ScenarioTests/DatabaseAccountOperationsTests.cs" target="_top">ScenarioTests\DatabaseAccountOperationsTests.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/cosmosdb/Azure.ResourceManager.CosmosDB/tests/ScenarioTests/DatabaseAccountOperationsTests.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.ResourceManager.CosmosDB.Tests" target="_top">Azure.ResourceManager.CosmosDB.Tests.csproj</a> (Azure.ResourceManager.CosmosDB.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <b>false</b>
<span class="e">using Azure.Core.TestFramework;
using Azure.ResourceManager.CosmosDB.Models;
using NUnit.Framework;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
 
namespace Azure.ResourceManager.CosmosDB.Tests
{
    [TestFixture]
    public class DatabaseAccountOperationsTests : CosmosDBManagementClientBase
    {
        private string resourceGroupName;
        private const string databaseAccountName = &quot;db4937&quot;;
        private const string location = &quot;WEST US&quot;;
        private const int maxStalenessPrefix = 300;
        private const int maxIntervalInSeconds = 1000;
        private bool setupRun = false;
        public DatabaseAccountOperationsTests() : base(true)
        {
        }
 
        [SetUp]
        public async Task ClearAndInitialize()
        {
            if ((Mode == RecordedTestMode.Record || Mode == RecordedTestMode.Playback) &amp;&amp; !setupRun)
            {
                await InitializeClients();
                this.resourceGroupName = Recording.GenerateAssetName(CosmosDBTestUtilities.ResourceGroupPrefix);
                await CosmosDBTestUtilities.TryRegisterResourceGroupAsync(ResourceGroupsOperations,
                    CosmosDBTestUtilities.Location,
                    this.resourceGroupName);
                setupRun = true;
            }
            else if (setupRun)
            {
                await initNewRecord();
            }
        }
 
        [OneTimeTearDown]
        public async Task CleanupResourceGroup()
        {
            await CleanupResourceGroupsAsync();
        }
 
        [TestCase, Order(1)]
        public async Task DatabaseAccountCreateAndUpdateTest()
        {
            var locations = new List&lt;Location&gt;();
            locations.Add(new Location(id: null, locationName: location, documentEndpoint: null, provisioningState: null, failoverPriority: null, isZoneRedundant: false));
            var databaseAccountCreateOrUpdateParameters = new DatabaseAccountCreateUpdateParameters(locations);
            databaseAccountCreateOrUpdateParameters.Location = location;
            databaseAccountCreateOrUpdateParameters.Tags.Add(&quot;key1&quot;, &quot;value1&quot;);
            databaseAccountCreateOrUpdateParameters.Tags.Add(&quot;key2&quot;, &quot;value2&quot;);
            databaseAccountCreateOrUpdateParameters.Kind = DatabaseAccountKind.MongoDB;
            databaseAccountCreateOrUpdateParameters.ConsistencyPolicy =
                new ConsistencyPolicy(DefaultConsistencyLevel.BoundedStaleness, maxStalenessPrefix, maxIntervalInSeconds);
            databaseAccountCreateOrUpdateParameters.IpRules.Add(new IpAddressOrRange(&quot;23.43.230.120&quot;));
            databaseAccountCreateOrUpdateParameters.IsVirtualNetworkFilterEnabled = true;
            databaseAccountCreateOrUpdateParameters.EnableAutomaticFailover = false;
            databaseAccountCreateOrUpdateParameters.ConnectorOffer = &quot;Small&quot;;
            databaseAccountCreateOrUpdateParameters.DisableKeyBasedMetadataWriteAccess = false;
            DatabaseAccountResource databaseAccount1 =
                await WaitForCompletionAsync(
                    await CosmosDBManagementClient.DatabaseAccounts.StartCreateOrUpdateAsync(resourceGroupName, databaseAccountName, databaseAccountCreateOrUpdateParameters));
            var response = await CosmosDBManagementClient.DatabaseAccounts.CheckNameExistsAsync(databaseAccountName);
            Assert.AreEqual(true, response.Value);
            Assert.AreEqual(200, response.GetRawResponse().Status);
            DatabaseAccountResource databaseAccount2 = await CosmosDBManagementClient.DatabaseAccounts.GetAsync(resourceGroupName, databaseAccountName);
            VerifyCosmosDBAccount(databaseAccount1, databaseAccount2);
 
            var databaseAccountUpdateParameters = new DatabaseAccountUpdateParameters();
            databaseAccountUpdateParameters.Tags.Add(&quot;key3&quot;, &quot;value3&quot;);
            databaseAccountUpdateParameters.Tags.Add(&quot;key4&quot;, &quot;value4&quot;);
            databaseAccountUpdateParameters.IsVirtualNetworkFilterEnabled = false;
            databaseAccountUpdateParameters.EnableAutomaticFailover = true;
            databaseAccountUpdateParameters.DisableKeyBasedMetadataWriteAccess = true;
            await WaitForCompletionAsync(
                await CosmosDBManagementClient.DatabaseAccounts.StartUpdateAsync(resourceGroupName, databaseAccountName, databaseAccountUpdateParameters));
            var failoverPolicyList = new List&lt;FailoverPolicy&gt;();
            failoverPolicyList.Add(new FailoverPolicy()
            {
                LocationName = location,
                FailoverPriority = 0
            });
            FailoverPolicies failoverPolicies = new FailoverPolicies(failoverPolicyList);
            await WaitForCompletionAsync(
                await CosmosDBManagementClient.DatabaseAccounts.StartFailoverPriorityChangeAsync(resourceGroupName, databaseAccountName, failoverPolicies));
            DatabaseAccountResource databaseAccount3 = await CosmosDBManagementClient.DatabaseAccounts.GetAsync(resourceGroupName, databaseAccountName);
            VerifyCosmosDBAccount(databaseAccount3, databaseAccountUpdateParameters);
            VerifyFailoverPolicies(failoverPolicyList, databaseAccount3.FailoverPolicies);
        }
 
        [TestCase, Order(2)]
        public async Task DatabaseAccountListBySubscriptionTest()
        {
            List&lt;DatabaseAccountResource&gt; databaseAccounts = await CosmosDBManagementClient.DatabaseAccounts.ListAsync().ToEnumerableAsync();
            Assert.IsNotNull(databaseAccounts);
            bool databaseAccountFound = false;
            DatabaseAccountResource actualDatabaseAccount = null;
            foreach (DatabaseAccountResource databaseAccount in databaseAccounts)
            {
                if (databaseAccount.Name == databaseAccountName)
                {
                    databaseAccountFound = true;
                    actualDatabaseAccount = databaseAccount;
                }
            }
            Assert.AreEqual(true, databaseAccountFound);
            DatabaseAccountResource expectedDatabaseAccount = await CosmosDBManagementClient.DatabaseAccounts.GetAsync(resourceGroupName, databaseAccountName);
            VerifyCosmosDBAccount(expectedDatabaseAccount, actualDatabaseAccount);
        }
 
        [TestCase, Order(2)]
        public async Task DatabaseAccountListByResourceGroupTest()
        {
            List&lt;DatabaseAccountResource&gt; databaseAccounts = await CosmosDBManagementClient.DatabaseAccounts.ListByResourceGroupAsync(resourceGroupName).ToEnumerableAsync();
            Assert.IsNotNull(databaseAccounts);
            Assert.AreEqual(1, databaseAccounts.Count);
            DatabaseAccountResource expectedDatabaseAccount = await CosmosDBManagementClient.DatabaseAccounts.GetAsync(resourceGroupName, databaseAccountName);
            VerifyCosmosDBAccount(expectedDatabaseAccount, databaseAccounts[0]);
        }
 
        [TestCase, Order(2)]
        [Ignore(&quot;Records keys&quot;)]
        public async Task DatabaseAccountListKeysAndRegenerateKeysTest()
        {
            DatabaseAccountListKeysResult databaseAccountListKeysResult = await CosmosDBManagementClient.DatabaseAccounts.ListKeysAsync(resourceGroupName, databaseAccountName);
            Assert.IsNotNull(databaseAccountListKeysResult.PrimaryMasterKey);
            Assert.IsNotNull(databaseAccountListKeysResult.PrimaryReadonlyMasterKey);
            Assert.IsNotNull(databaseAccountListKeysResult.SecondaryMasterKey);
            Assert.IsNotNull(databaseAccountListKeysResult.SecondaryReadonlyMasterKey);
 
            DatabaseAccountListReadOnlyKeysResult databaseAccountListReadOnlyKeysResult =
                await CosmosDBManagementClient.DatabaseAccounts.ListReadOnlyKeysAsync(resourceGroupName, databaseAccountName);
            Assert.IsNotNull(databaseAccountListReadOnlyKeysResult.PrimaryReadonlyMasterKey);
            Assert.IsNotNull(databaseAccountListReadOnlyKeysResult.SecondaryReadonlyMasterKey);
 
            DatabaseAccountListReadOnlyKeysResult databaseAccountGetReadOnlyKeysResult =
                await CosmosDBManagementClient.DatabaseAccounts.GetReadOnlyKeysAsync(resourceGroupName, databaseAccountName);
            Assert.IsNotNull(databaseAccountGetReadOnlyKeysResult.PrimaryReadonlyMasterKey);
            Assert.IsNotNull(databaseAccountGetReadOnlyKeysResult.SecondaryReadonlyMasterKey);
 
            await WaitForCompletionAsync(
                await CosmosDBManagementClient.DatabaseAccounts.
                StartRegenerateKeyAsync(resourceGroupName, databaseAccountName, new DatabaseAccountRegenerateKeyParameters(new KeyKind(&quot;primary&quot;))));
            await WaitForCompletionAsync(
                await CosmosDBManagementClient.DatabaseAccounts.
                StartRegenerateKeyAsync(resourceGroupName, databaseAccountName, new DatabaseAccountRegenerateKeyParameters(new KeyKind(&quot;secondary&quot;))));
            await WaitForCompletionAsync(
                await CosmosDBManagementClient.DatabaseAccounts.
                StartRegenerateKeyAsync(resourceGroupName, databaseAccountName, new DatabaseAccountRegenerateKeyParameters(new KeyKind(&quot;primaryReadonly&quot;))));
            await WaitForCompletionAsync(
                await CosmosDBManagementClient.DatabaseAccounts.
                StartRegenerateKeyAsync(resourceGroupName, databaseAccountName, new DatabaseAccountRegenerateKeyParameters(new KeyKind(&quot;secondaryReadonly&quot;))));
 
            DatabaseAccountListKeysResult databaseAccountListRegeneratedKeysResult =
                await CosmosDBManagementClient.DatabaseAccounts.ListKeysAsync(resourceGroupName, databaseAccountName);
            Assert.AreNotEqual(databaseAccountListKeysResult.PrimaryMasterKey, databaseAccountListRegeneratedKeysResult.PrimaryMasterKey);
            Assert.AreNotEqual(databaseAccountListKeysResult.PrimaryReadonlyMasterKey, databaseAccountListRegeneratedKeysResult.PrimaryReadonlyMasterKey);
            Assert.AreNotEqual(databaseAccountListKeysResult.SecondaryMasterKey, databaseAccountListRegeneratedKeysResult.SecondaryMasterKey);
            Assert.AreNotEqual(databaseAccountListKeysResult.SecondaryReadonlyMasterKey, databaseAccountListRegeneratedKeysResult.SecondaryReadonlyMasterKey);
        }
 
        [TestCase, Order(2)]
        public async Task DatabaseAccountListConnectionStringsTest()
        {
            DatabaseAccountListConnectionStringsResult databaseAccountListConnectionStringsResult =
                await CosmosDBManagementClient.DatabaseAccounts.ListConnectionStringsAsync(resourceGroupName, databaseAccountName);
            Assert.AreEqual(4, databaseAccountListConnectionStringsResult.ConnectionStrings.Count);
        }
 
        [TestCase, Order(2)]
        public async Task DatabaseAccountListUsageTest()
        {
            List&lt;Usage&gt; usages = await CosmosDBManagementClient.DatabaseAccounts.ListUsagesAsync(resourceGroupName, databaseAccountName).ToEnumerableAsync();
            Assert.IsNotNull(usages);
        }
 
        [TestCase, Order(2)]
        public async Task DatabaseAccountListMetricsDefinitionAndMetricsTest()
        {
            List&lt;MetricDefinition&gt; metricDefinitions =
                await CosmosDBManagementClient.DatabaseAccounts.ListMetricDefinitionsAsync(resourceGroupName, databaseAccountName).ToEnumerableAsync();
            Assert.IsNotNull(metricDefinitions);
 
            string filter = &quot;(name.value eq &#39;Total Requests&#39;) and timeGrain eq duration&#39;PT5M&#39;&quot;;
            var metrics = await CosmosDBManagementClient.DatabaseAccounts.ListMetricsAsync(resourceGroupName, databaseAccountName, filter).ToEnumerableAsync();
            Assert.IsNotNull(metrics);
            var regionMetrics =
                await CosmosDBManagementClient.DatabaseAccountRegion.ListMetricsAsync(resourceGroupName, databaseAccountName, &quot;WEST US&quot;, filter).ToEnumerableAsync();
            Assert.IsNotNull(regionMetrics);
        }
 
        [TestCase, Order(3)]
        public async Task DatabaseAccountDeleteTest()
        {
            await WaitForCompletionAsync(await CosmosDBManagementClient.DatabaseAccounts.StartDeleteAsync(resourceGroupName, databaseAccountName));
            List&lt;DatabaseAccountResource&gt; databaseAccounts = await CosmosDBManagementClient.DatabaseAccounts.ListByResourceGroupAsync(resourceGroupName).ToEnumerableAsync();
            Assert.IsNotNull(databaseAccounts);
            Assert.AreEqual(0, databaseAccounts.Count);
        }
 
        private void VerifyCosmosDBAccount(DatabaseAccountResource expectedValue, DatabaseAccountResource actualValue)
        {
            Assert.AreEqual(expectedValue.Name, actualValue.Name);
            Assert.AreEqual(expectedValue.Location, actualValue.Location);
            Assert.True(expectedValue.Tags.SequenceEqual(actualValue.Tags));
            Assert.AreEqual(expectedValue.Kind, actualValue.Kind);
            Assert.AreEqual(expectedValue.ProvisioningState, actualValue.ProvisioningState);
            Assert.AreEqual(expectedValue.DocumentEndpoint, actualValue.DocumentEndpoint);
            Assert.AreEqual(expectedValue.DatabaseAccountOfferType, actualValue.DatabaseAccountOfferType);
            Assert.AreEqual(expectedValue.IpRules.Count, actualValue.IpRules.Count);
            Assert.AreEqual(expectedValue.IpRules[0].IpAddressOrRangeValue, actualValue.IpRules[0].IpAddressOrRangeValue);
            Assert.AreEqual(expectedValue.IsVirtualNetworkFilterEnabled, actualValue.IsVirtualNetworkFilterEnabled);
            Assert.AreEqual(expectedValue.EnableAutomaticFailover, actualValue.EnableAutomaticFailover);
            VerifyConsistencyPolicy(expectedValue.ConsistencyPolicy, actualValue.ConsistencyPolicy);
            Assert.AreEqual(expectedValue.Capabilities.Count, actualValue.Capabilities.Count);
            VerifyLocations(expectedValue.WriteLocations, actualValue.WriteLocations);
            VerifyLocations(expectedValue.ReadLocations, actualValue.ReadLocations);
            VerifyLocations(expectedValue.Locations, actualValue.Locations);
            VerifyFailoverPolicies(expectedValue.FailoverPolicies, actualValue.FailoverPolicies);
            Assert.AreEqual(expectedValue.VirtualNetworkRules.Count, actualValue.VirtualNetworkRules.Count);
            Assert.AreEqual(expectedValue.PrivateEndpointConnections.Count, actualValue.PrivateEndpointConnections.Count);
            Assert.AreEqual(expectedValue.EnableMultipleWriteLocations, actualValue.EnableMultipleWriteLocations);
            Assert.AreEqual(expectedValue.EnableCassandraConnector, actualValue.EnableCassandraConnector);
            Assert.AreEqual(expectedValue.ConnectorOffer, actualValue.ConnectorOffer);
            Assert.AreEqual(expectedValue.DisableKeyBasedMetadataWriteAccess, actualValue.DisableKeyBasedMetadataWriteAccess);
            Assert.AreEqual(expectedValue.KeyVaultKeyUri, actualValue.KeyVaultKeyUri);
            Assert.AreEqual(expectedValue.PublicNetworkAccess, actualValue.PublicNetworkAccess);
            Assert.AreEqual(expectedValue.EnableFreeTier, actualValue.EnableFreeTier);
            Assert.AreEqual(expectedValue.ApiProperties.ServerVersion.ToString(), actualValue.ApiProperties.ServerVersion.ToString());
            Assert.AreEqual(expectedValue.EnableAnalyticalStorage, actualValue.EnableAnalyticalStorage);
            Assert.AreEqual(expectedValue.Cors.Count, actualValue.Cors.Count);
        }
 
        private void VerifyCosmosDBAccount(DatabaseAccountResource databaseAccount, DatabaseAccountUpdateParameters parameters)
        {
            Assert.True(databaseAccount.Tags.SequenceEqual(parameters.Tags));
            Assert.AreEqual(databaseAccount.IsVirtualNetworkFilterEnabled, parameters.IsVirtualNetworkFilterEnabled);
            Assert.AreEqual(databaseAccount.EnableAutomaticFailover, parameters.EnableAutomaticFailover);
            Assert.AreEqual(databaseAccount.DisableKeyBasedMetadataWriteAccess, parameters.DisableKeyBasedMetadataWriteAccess);
        }
 
        private void VerifyLocations(IReadOnlyList&lt;Location&gt; expectedValue, IReadOnlyList&lt;Location&gt; actualValue)
        {
            Assert.AreEqual(expectedValue.Count, actualValue.Count);
            if (expectedValue.Count != 0)
            {
                foreach (Location expexctedLocation in expectedValue)
                {
                    foreach (Location actualLocation in actualValue)
                    {
                        if (expexctedLocation.Id == actualLocation.Id)
                        {
                            Assert.AreEqual(expexctedLocation.DocumentEndpoint, actualLocation.DocumentEndpoint);
                            Assert.AreEqual(expexctedLocation.FailoverPriority, actualLocation.FailoverPriority);
                            Assert.AreEqual(expexctedLocation.IsZoneRedundant, actualLocation.IsZoneRedundant);
                            Assert.AreEqual(expexctedLocation.LocationName, actualLocation.LocationName);
                            Assert.AreEqual(expexctedLocation.ProvisioningState, actualLocation.ProvisioningState);
                        }
                    }
                }
            }
        }
 
        private void VerifyFailoverPolicies(IReadOnlyList&lt;FailoverPolicy&gt; expectedValue, IReadOnlyList&lt;FailoverPolicy&gt; actualValue)
        {
            Assert.AreEqual(expectedValue.Count, actualValue.Count);
            if (expectedValue.Count != 0)
            {
                foreach (FailoverPolicy expexctedFailoverPolicy in expectedValue)
                {
                    foreach (FailoverPolicy actualFailoverPolicy in actualValue)
                    {
                        if (expexctedFailoverPolicy.Id == actualFailoverPolicy.Id)
                        {
                            Assert.AreEqual(expexctedFailoverPolicy.FailoverPriority, actualFailoverPolicy.FailoverPriority);
                            Assert.AreEqual(expexctedFailoverPolicy.LocationName, actualFailoverPolicy.LocationName);
                        }
                    }
                }
            }
        }
 
        private void VerifyConsistencyPolicy(ConsistencyPolicy expected, ConsistencyPolicy actual)
        {
            Assert.AreEqual(expected.DefaultConsistencyLevel, actual.DefaultConsistencyLevel);
 
            if (actual.DefaultConsistencyLevel == DefaultConsistencyLevel.BoundedStaleness)
            {
                Assert.AreEqual(expected.MaxIntervalInSeconds, actual.MaxIntervalInSeconds);
                Assert.AreEqual(expected.MaxStalenessPrefix, actual.MaxStalenessPrefix);
            }
        }
    }
}
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
</pre></td></tr></table></div></body></html>
