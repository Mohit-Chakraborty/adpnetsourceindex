<!DOCTYPE html>
<html><head><title>JobIdFixture.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(116);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Batch.Conventions.Files.Integration.Tests/JobIdFixture.cs" target="_top">JobIdFixture.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/master//sdk/batch/Microsoft.Azure.Batch.Conventions.Files/tests/IntegrationTests/JobIdFixture.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Batch.Conventions.Files.Integration.Tests" target="_top">Microsoft.Azure.Batch.Conventions.Files.Integration.Tests.csproj</a> (Microsoft.Azure.Batch.Conventions.Files.Integration.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft and contributors.  All rights reserved.</span>
<span class="c">//</span>
<span class="c">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c">// you may not use this file except in compliance with the License.</span>
<span class="c">// You may obtain a copy of the License at</span>
<span class="c">// http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">//</span>
<span class="c">// Unless required by applicable law or agreed to in writing, software</span>
<span class="c">// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c">//</span>
<span class="c">// See the License for the specific language governing permissions and</span>
<span class="c">// limitations under the License.</span>
 
﻿<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>.<span class="i n">Conventions</span>.<span class="i n">Files</span>.<span class="i n">IntegrationTests</span>.<span class="i n">Utilities</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>.<span class="i n">Conventions</span>.<span class="i n">Files</span>.<span class="i n">IntegrationTests</span>.<span class="i n">Xunit</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>.<span class="i n">Conventions</span>.<span class="i n">Files</span>.<span class="i n">Utilities</span>;
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Xunit</span>;
<b>using</b> <span class="i n">Xunit</span>.<span class="i n">Abstractions</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>.<span class="i n">Conventions</span>.<span class="i n">Files</span>.<span class="i n">IntegrationTests</span>
{
    <b>public abstract class</b> <a id="a323cd1fbe860322" href="R/a323cd1fbe860322.html" target="n" data-glyph="0,0" class="t t">JobIdFixture</a> : <span class="t t">IAsyncLifetime</span>, <a href="Xunit/XunitInfrastructure.cs.html#c20c1cfb1d99eabe" class="t t">IReceiveMessages</a>
    {
        <b>private bool</b> <a id="ca8472e20d68d5f4" href="R/ca8472e20d68d5f4.html" target="n" data-glyph="46,1" class="i field">_cancelTeardown</a>;
 
        <b>public string</b> <a id="446ac24017fc3c9d" href="R/446ac24017fc3c9d.html" target="n" data-glyph="102,1" class="i property">JobId</a> { <b>get</b>; }
 
        <b>public</b> <a id="abf260ad33e1063b" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">JobIdFixture</a>()
        {
            <a href="#446ac24017fc3c9d" class="i property">JobId</a> = <a href="#e40ec67ab31ea917" class="i method">CreateRandomJobId</a>(<a href="#b0703325418f049e" class="i property">TestId</a>);
        }
 
        <b>public void</b> <a id="ccac34f4d4b3f45c" href="R/ccac34f4d4b3f45c.html" target="n" data-glyph="72,1" class="i method">CancelTeardown</a>()
        {
            <a href="#ca8472e20d68d5f4" class="i field">_cancelTeardown</a> = <b>true</b>;
        }
 
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="e8e799d43b12d262" href="R/e8e799d43b12d262.html" target="n" data-glyph="72,1" class="i method">InitializeAsync</a>()
        {
            <b>if</b> (<a href="#b51e859973e4633d" class="i property">AutoCreateContainer</a>)
            {
                <b>await</b> <a href="#70c6375bc4beb4e1" class="i method">CreateJobOutputContainerIfNotExistsAsync</a>();
            }
        }
 
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="a65d58505866524b" href="R/a65d58505866524b.html" target="n" data-glyph="72,1" class="i method">DisposeAsync</a>()
        {
            <b>if</b> (!<a href="#ca8472e20d68d5f4" class="i field">_cancelTeardown</a>)
            {
                <b>await</b> <a href="#5a69af56f35e24fe" class="i method">DeleteJobOutputContainerAsync</a>();
            }
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="70c6375bc4beb4e1" href="R/70c6375bc4beb4e1.html" target="n" data-glyph="76,1" class="i method">CreateJobOutputContainerIfNotExistsAsync</a>()
        {
            <b>await</b> <a href="StorageConfiguration.cs.html#81542d676313bf2d" class="t t">StorageConfiguration</a>.<a href="StorageConfiguration.cs.html#bfaade10c49b1e8c" class="i method">GetAccount</a>(<b>null</b>)  <span class="c">// Xunit doesn&#39;t provide a convenient way for shared fixtures to log</span>
                                      .<span class="i method">CreateCloudBlobClient</span>()
                                      .<span class="i method">GetContainerReference</span>(<a href="/Microsoft.Azure.Batch.Conventions.Files/A.html#1d8c75b4846b4dde" class="t t">ContainerNameUtils</a>.<a href="/Microsoft.Azure.Batch.Conventions.Files/A.html#5994df50a816a02b" class="i method">GetSafeContainerName</a>(<a href="#446ac24017fc3c9d" class="i property">JobId</a>))
                                      .<span class="i method">CreateIfNotExistsAsync</span>();
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="5a69af56f35e24fe" href="R/5a69af56f35e24fe.html" target="n" data-glyph="76,1" class="i method">DeleteJobOutputContainerAsync</a>()
        {
            <b>await</b> <a href="StorageConfiguration.cs.html#81542d676313bf2d" class="t t">StorageConfiguration</a>.<a href="StorageConfiguration.cs.html#bfaade10c49b1e8c" class="i method">GetAccount</a>(<b>null</b>)  <span class="c">// Xunit doesn&#39;t provide a convenient way for shared fixtures to log</span>
                                      .<span class="i method">CreateCloudBlobClient</span>()
                                      .<span class="i method">GetContainerReference</span>(<a href="/Microsoft.Azure.Batch.Conventions.Files/A.html#1d8c75b4846b4dde" class="t t">ContainerNameUtils</a>.<a href="/Microsoft.Azure.Batch.Conventions.Files/A.html#5994df50a816a02b" class="i method">GetSafeContainerName</a>(<a href="#446ac24017fc3c9d" class="i property">JobId</a>))
                                      .<span class="i method">DeleteIfExistsAsync</span>();
        }
 
        <b>private static string</b> <a id="e40ec67ab31ea917" href="R/e40ec67ab31ea917.html" target="n" data-glyph="76,1" class="i method">CreateRandomJobId</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r0 rd" class="r0 r">testId</span>)
        {
            <span class="c">// Of the form &quot;mabfc-inttest-joboutput-jan01-010101-1234567890abcdef&quot;</span>
 
            <span class="c">// Require IDs to be short so they don&#39;t push the length over the munging</span>
            <span class="c">// threshold.</span>
            <b>if</b> (<span class="r0 r">testId</span>.<a href="@0@mscorlib/A.html#e13f5829ef28aa07" class="i property">Length</a> &gt; 12)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#4b20cd3790b6426a" class="t constructor">ArgumentException</a>(<span class="s">&quot;testId must be 12 or fewer characters&quot;</span>, <b>nameof</b>(<span class="r0 r">testId</span>));
            }
 
            <span class="c">// Use local time to make it easier to see which is the container for the</span>
            <span class="c">// &quot;current&quot; test run in storage viewers.</span>
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r1 rd" class="r1 r">timestampPart</span> = <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#1cd5dd408a32124f" class="i property">Now</a>.<a href="@0@mscorlib/A.html#1ecc4a05169eccb8" class="i method">ToString</a>(<span class="s">&quot;MMMdd-HHmmss&quot;</span>, <a href="@0@mscorlib/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@0@mscorlib/A.html#26ef1c020f0dbb7a" class="i property">InvariantCulture</a>).<a href="@0@mscorlib/A.html#2d51c212cb09178e" class="i method">ToLowerInvariant</a>();
 
            <span class="c">// Some randomness in case the same test class gets run twice within a</span>
            <span class="c">// second.  We wouldn&#39;t expect this to happen very often, so we don&#39;t</span>
            <span class="c">// need a lot of randomness, and it&#39;s more valuable to keep names below the</span>
            <span class="c">// munging threshold than to reduce the risk of collisions to sub-cosmic-ray levels.</span>
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r2 rd" class="r2 r">randomPart</span> = <a href="Utilities/RandomChars.cs.html#b4ec425230be638e" class="t t">RandomChars</a>.<a href="Utilities/RandomChars.cs.html#be68fa81d366e83e" class="i method">RandomString</a>(16);
 
            <b>return</b> <span class="s">$&quot;</span><span class="s">mabfc-inttest-</span>{<span class="r0 r">testId</span>}<span class="s">-</span>{<span class="r1 r">timestampPart</span>}<span class="s">-</span>{<span class="r2 r">randomPart</span>}<span class="s">&quot;</span>;
        }
 
        <b>public void</b> <a id="d000ed4a0b77d60f" href="R/d000ed4a0b77d60f.html" target="n" data-glyph="72,1" class="i method">OnTestCaseFinished</a>(<span class="t t">ITestCaseFinished</span> <span id="r3 rd" class="r3 r">testCaseFinishedMessage</span>)
        {
            <span class="c">// Uses the extended Xunit infrastructure to preserve the test job output container</span>
            <span class="c">// if any tests failed, to allow post-mortem analysis using a storage viewer.</span>
            <b>if</b> (<span class="r3 r">testCaseFinishedMessage</span>.<span class="i property">TestsFailed</span> &gt; 0)
            {
                <a href="#ca8472e20d68d5f4" class="i field">_cancelTeardown</a> = <b>true</b>;
            }
        }
 
        <b>protected abstract string</b> <a id="b0703325418f049e" href="R/b0703325418f049e.html" target="n" data-glyph="105,1" class="i property">TestId</a> { <b>get</b>; }
 
        <b>protected virtual bool</b> <a id="b51e859973e4633d" href="R/b51e859973e4633d.html" target="n" data-glyph="105,1" class="i property">AutoCreateContainer</a> { <b>get</b>; } = <b>true</b>;
    }
}
</pre></td></tr></table></div></body></html>
