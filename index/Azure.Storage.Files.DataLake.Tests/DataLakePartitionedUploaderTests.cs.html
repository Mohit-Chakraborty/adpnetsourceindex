<!DOCTYPE html>
<html><head><title>DataLakePartitionedUploaderTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(521);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Storage.Files.DataLake.Tests/DataLakePartitionedUploaderTests.cs" target="_top">DataLakePartitionedUploaderTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Storage.Files.DataLake.Tests" target="_top">Azure.Storage.Files.DataLake.Tests.csproj</a> (Azure.Storage.Files.DataLake.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Buffers</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">TestFramework</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Files</span>.<span class="i n">DataLake</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Tests</span>.<span class="i n">Shared</span>;
<b>using</b> <span class="i n">Moq</span>;
<b>using</b> <span class="i n">NUnit</span>.<span class="i n">Framework</span>;
<b>using static</b> <span class="i n">Moq</span>.<span class="t t">It</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Files</span>.<span class="i n">DataLake</span>.<span class="i n">Tests</span>
{
    [<span class="t constructor">TestFixture</span>(<b>true</b>)]
    [<span class="t constructor">TestFixture</span>(<b>false</b>)]
    <b>public class</b> <a id="40387ddfb6f21139" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">DataLakePartitionedUploaderTests</a>
    {
        <b>private readonly bool</b> <a id="47b7b4abdd0ce1a8" href="R/47b7b4abdd0ce1a8.html" target="n" data-glyph="46,1" class="i field">_async</a>;
 
        <span class="c">// Use constants to verify that we flow them everywhere</span>
        <b>private static readonly</b> <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <a id="26aac2e42024fa40" href="R/26aac2e42024fa40.html" target="n" data-glyph="46,1" class="i field">s_cancellationToken</a> = <b>new</b> <a href="@0@mscorlib/A.html#0fd973cb6741d972" class="t constructor">CancellationTokenSource</a>().<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>;
        <b>private static readonly</b> <a href="/Azure.Storage.Files.DataLake/A.html#cc3a1ab0659ac139" class="t t">PathHttpHeaders</a> <a id="33e19c17b56fa347" href="R/33e19c17b56fa347.html" target="n" data-glyph="46,1" class="i field">s_pathHttpHeaders</a> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#56c55abf786c2c9a" class="t constructor">PathHttpHeaders</a>()
        {
            <a href="/Azure.Storage.Files.DataLake/A.html#a002ab03e065c63d" class="i property">CacheControl</a> = <span class="s">&quot;Please do&quot;</span>,
            <a href="/Azure.Storage.Files.DataLake/A.html#fbc2b3dd84e4e0b8" class="i property">ContentEncoding</a> = <span class="s">&quot;Yes&quot;</span>
        };
        <b>private static readonly</b> <a href="/Azure.Storage.Files.DataLake/A.html#4d80583f26ed254a" class="t t">DataLakeRequestConditions</a> <a id="6f437d0f6e3766a9" href="R/6f437d0f6e3766a9.html" target="n" data-glyph="46,1" class="i field">s_conditions</a> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#5cccde30c1ba38a8" class="t constructor">DataLakeRequestConditions</a>()
        {
            <a href="/Azure.Storage.Files.DataLake/A.html#f2f57b6bde1ac3d6" class="i property">LeaseId</a> = <span class="s">&quot;MyImportantLease&quot;</span>
        };
        <b>private static readonly</b> <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <a id="7da2012930233187" href="R/../../0000000000.html" target="n" data-glyph="46,1" class="i field">s_metadata</a> = <b>new</b> <a href="@0@mscorlib/A.html#bf6849e410b43c4c" class="t constructor">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;
        {
            { <span class="s">&quot;key&quot;</span>, <span class="s">&quot;value&quot;</span> }
        };
        <b>private static readonly string</b> <a id="0a40486381805ca2" href="R/0a40486381805ca2.html" target="n" data-glyph="46,1" class="i field">s_permissions</a> = <span class="s">&quot;permissions&quot;</span>;
        <b>private static readonly string</b> <a id="67416794edef5a87" href="R/67416794edef5a87.html" target="n" data-glyph="46,1" class="i field">s_umask</a> = <span class="s">&quot;umask&quot;</span>;
        <b>private static readonly</b> <a href="@0@mscorlib/A.html#d23df0450d3fd0d6" class="t t">Progress</a>&lt;<b>long</b>&gt; <a id="f496990ab820d2f9" href="R/f496990ab820d2f9.html" target="n" data-glyph="46,1" class="i field">s_progress</a> = <b>new</b> <a href="@0@mscorlib/A.html#505fd18cebba3ec1" class="t constructor">Progress</a>&lt;<b>long</b>&gt;();
        <b>private static readonly</b> <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt; <a id="b17e9f740d2c254b" href="R/b17e9f740d2c254b.html" target="n" data-glyph="46,1" class="i field">s_response</a> = <a href="/Azure.Core/A.html#ad97b1910f5ca3eb" class="t t">Response</a>.<a href="/Azure.Core/A.html#ff41acd78201fc1c" class="i method">FromValue</a>(
            <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#4ec04aed13a5472d" class="t constructor">PathInfo</a>(),
            <b>new</b> <a href="/Azure.Core.TestFramework/A.html#ef2adc622c2950d8" class="t constructor">MockResponse</a>(200));
 
        <b>public</b> <a id="4395bbea7ec14799" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">DataLakePartitionedUploaderTests</a>(<b>bool</b> <span id="r0 rd" class="r0 r">async</span>)
        {
            <a href="#47b7b4abdd0ce1a8" class="i field">_async</a> = <span class="r0 r">async</span>;
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="37183994f64daf24" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UploadsStreamInBlocksIfLengthNotAvailable</a>()
        {
            <a href="#e660e488ca8e968e" class="t t">TestStream</a> <span id="r1 rd" class="r1 r">content</span> = <b>new</b> <a href="#d6f1dfaf62caf89e" class="t constructor">TestStream</a>(<a href="#47b7b4abdd0ce1a8" class="i field">_async</a>, <b>null</b>, <a href="#e660e488ca8e968e" class="t t">TestStream</a>.<a href="#352e9c6c7d0892b2" class="i method">Read</a>(0, 10));
            <a href="#22988b05dfec7fca" class="t t">TrackingArrayPool</a> <span id="r2 rd" class="r2 r">testPool</span> = <b>new</b> <a href="#22988b05dfec7fca" class="t constructor">TrackingArrayPool</a>();
            <a href="#747f30871aa170d4" class="t t">AppendSink</a> <span id="r3 rd" class="r3 r">sink</span> = <b>new</b> <a href="#8de9d13da8fd53af" class="t constructor">AppendSink</a>();
 
            <span class="t t">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt; <span id="r4 rd" class="r4 r">clientMock</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt;(
                <span class="t t">MockBehavior</span>.<span class="i field">Strict</span>,
                <b>new</b> <a href="@0@System/A.html#9e1bb2fef0d1159b" class="t constructor">Uri</a>(<span class="s">&quot;http://mock&quot;</span>),
                <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#69de9634982a35cf" class="t constructor">DataLakeClientOptions</a>());
            <span class="r4 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r5 rd" class="r5 r">c</span> =&gt; <span class="r5 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#32cf2458657dd837" class="i property">ClientDiagnostics</a>).<span class="i method">CallBase</span>();
            <span class="r4 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r6 rd" class="r6 r">c</span> =&gt; <span class="r6 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#ed0f0738115fec78" class="i property">Version</a>).<span class="i method">CallBase</span>();
            <a href="#19b3d12614a8f5df" class="i method">SetupInternalStaging</a>(<span class="r4 r">clientMock</span>, <span class="r3 r">sink</span>);
 
            <a href="/Azure.Storage.Files.DataLake/A.html#35188e7929b6e459" class="k">var</a> <span id="r7 rd" class="r7 r">uploader</span> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#050ccd3d4aead9ec" class="t constructor">PartitionedUploader</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#d01943b9b863cede" class="t t">DataLakeFileUploadOptions</a>, <a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt;(
                <a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>.<a href="/Azure.Storage.Files.DataLake/A.html#8d700c9899c78d26" class="i method">GetPartitionedUploaderBehaviors</a>(<span class="r4 r">clientMock</span>.<span class="i property">Object</span>),
                <span class="r8 r">transferOptions</span>: <b>default</b>,
                <span class="r9 r">arrayPool</span>: <span class="r2 r">testPool</span>);
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt; <span id="r10 rd" class="r10 r">info</span> = <b>await</b> <a href="#ad02c695f982db05" class="i method">InvokeUploadAsync</a>(<span class="r7 r">uploader</span>, <span class="r1 r">content</span>);
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(1, <span class="r3 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@mscorlib/A.html#12b9bba2a1f9c3e2" class="i property">Count</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<a href="#b17e9f740d2c254b" class="i field">s_response</a>, <span class="r10 r">info</span>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(2, <span class="r2 r">testPool</span>.<a href="#727f5cc887071202" class="i field">TotalRents</a>); <span class="c">// while conceptually there is one rental, the second rental occurs upon checking for stream end on a Read() call</span>
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(0, <span class="r2 r">testPool</span>.<a href="#7ba8575767c180eb" class="i field">CurrentCount</a>);
            <a href="#fdd66a54c23d030c" class="i method">AssertAppended</a>(<span class="r3 r">sink</span>, <span class="r1 r">content</span>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="e722088989ca86e7" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UploadsStreamInBlocksIfLengthIsOverTheLimit</a>()
        {
            <a href="Shared/PredictableStream.cs.html#6959878b93eb1805" class="t t">PredictableStream</a> <span id="r11 rd" class="r11 r">content</span> = <b>new</b> <a href="Shared/PredictableStream.cs.html#4d0fa8c63001b1e1" class="t constructor">PredictableStream</a>(30);
            <a href="#22988b05dfec7fca" class="t t">TrackingArrayPool</a> <span id="r12 rd" class="r12 r">testPool</span> = <b>new</b> <a href="#22988b05dfec7fca" class="t constructor">TrackingArrayPool</a>();
            <a href="#747f30871aa170d4" class="t t">AppendSink</a> <span id="r13 rd" class="r13 r">sink</span> = <b>new</b> <a href="#8de9d13da8fd53af" class="t constructor">AppendSink</a>();
 
            <span class="t t">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt; <span id="r14 rd" class="r14 r">clientMock</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt;(
                <span class="t t">MockBehavior</span>.<span class="i field">Strict</span>, <b>new</b> <a href="@0@System/A.html#9e1bb2fef0d1159b" class="t constructor">Uri</a>(<span class="s">&quot;http://mock&quot;</span>), <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#69de9634982a35cf" class="t constructor">DataLakeClientOptions</a>());
            <span class="r14 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r15 rd" class="r15 r">c</span> =&gt; <span class="r15 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#32cf2458657dd837" class="i property">ClientDiagnostics</a>).<span class="i method">CallBase</span>();
            <span class="r14 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r16 rd" class="r16 r">c</span> =&gt; <span class="r16 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#ed0f0738115fec78" class="i property">Version</a>).<span class="i method">CallBase</span>();
            <a href="#19b3d12614a8f5df" class="i method">SetupInternalStaging</a>(<span class="r14 r">clientMock</span>, <span class="r13 r">sink</span>);
 
            <a href="/Azure.Storage.Files.DataLake/A.html#35188e7929b6e459" class="k">var</a> <span id="r17 rd" class="r17 r">uploader</span> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#050ccd3d4aead9ec" class="t constructor">PartitionedUploader</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#d01943b9b863cede" class="t t">DataLakeFileUploadOptions</a>, <a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt;(
                <a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>.<a href="/Azure.Storage.Files.DataLake/A.html#8d700c9899c78d26" class="i method">GetPartitionedUploaderBehaviors</a>(<span class="r14 r">clientMock</span>.<span class="i property">Object</span>),
                <b>new</b> <a href="/Azure.Storage.Common/A.html#5906346a5aaad27d" class="t constructor">StorageTransferOptions</a> { <a href="/Azure.Storage.Common/A.html#6c3ac4bff39cdfb2" class="i property">MaximumTransferLength</a> = 20, <a href="/Azure.Storage.Common/A.html#2db18e92623468ec" class="i property">InitialTransferLength</a> = 20 },
                <span class="r9 r">arrayPool</span>: <span class="r12 r">testPool</span>);
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt; <span id="r18 rd" class="r18 r">info</span> = <b>await</b> <a href="#ad02c695f982db05" class="i method">InvokeUploadAsync</a>(<span class="r17 r">uploader</span>, <span class="r11 r">content</span>);
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(2, <span class="r13 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@mscorlib/A.html#12b9bba2a1f9c3e2" class="i property">Count</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<a href="#b17e9f740d2c254b" class="i field">s_response</a>, <span class="r18 r">info</span>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="8462cc473ddd6c2f" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UploadsStreamInBlocksUnderSize</a>()
        {
            <a href="#e660e488ca8e968e" class="t t">TestStream</a> <span id="r19 rd" class="r19 r">content</span> = <b>new</b> <a href="#d6f1dfaf62caf89e" class="t constructor">TestStream</a>(<a href="#47b7b4abdd0ce1a8" class="i field">_async</a>, <b>null</b>,
                <a href="#e660e488ca8e968e" class="t t">TestStream</a>.<a href="#352e9c6c7d0892b2" class="i method">Read</a>(0, 10),
                <a href="#e660e488ca8e968e" class="t t">TestStream</a>.<a href="#352e9c6c7d0892b2" class="i method">Read</a>(1, 10)
            );
            <a href="#22988b05dfec7fca" class="t t">TrackingArrayPool</a> <span id="r20 rd" class="r20 r">testPool</span> = <b>new</b> <a href="#22988b05dfec7fca" class="t constructor">TrackingArrayPool</a>();
            <a href="#747f30871aa170d4" class="t t">AppendSink</a> <span id="r21 rd" class="r21 r">sink</span> = <b>new</b> <a href="#8de9d13da8fd53af" class="t constructor">AppendSink</a>();
 
            <span class="t t">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt; <span id="r22 rd" class="r22 r">clientMock</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt;(
                <span class="t t">MockBehavior</span>.<span class="i field">Strict</span>, <b>new</b> <a href="@0@System/A.html#9e1bb2fef0d1159b" class="t constructor">Uri</a>(<span class="s">&quot;http://mock&quot;</span>), <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#69de9634982a35cf" class="t constructor">DataLakeClientOptions</a>());
            <span class="r22 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r23 rd" class="r23 r">c</span> =&gt; <span class="r23 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#32cf2458657dd837" class="i property">ClientDiagnostics</a>).<span class="i method">CallBase</span>();
            <span class="r22 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r24 rd" class="r24 r">c</span> =&gt; <span class="r24 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#ed0f0738115fec78" class="i property">Version</a>).<span class="i method">CallBase</span>();
            <a href="#19b3d12614a8f5df" class="i method">SetupInternalStaging</a>(<span class="r22 r">clientMock</span>, <span class="r21 r">sink</span>);
 
            <a href="/Azure.Storage.Files.DataLake/A.html#35188e7929b6e459" class="k">var</a> <span id="r25 rd" class="r25 r">uploader</span> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#050ccd3d4aead9ec" class="t constructor">PartitionedUploader</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#d01943b9b863cede" class="t t">DataLakeFileUploadOptions</a>, <a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt;(
                <a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>.<a href="/Azure.Storage.Files.DataLake/A.html#8d700c9899c78d26" class="i method">GetPartitionedUploaderBehaviors</a>(<span class="r22 r">clientMock</span>.<span class="i property">Object</span>),
                <b>new</b> <a href="/Azure.Storage.Common/A.html#5906346a5aaad27d" class="t constructor">StorageTransferOptions</a>() { <a href="/Azure.Storage.Common/A.html#6c3ac4bff39cdfb2" class="i property">MaximumTransferLength</a> = 20 },
                <span class="r9 r">arrayPool</span>: <span class="r20 r">testPool</span>);
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt; <span id="r26 rd" class="r26 r">info</span> = <b>await</b> <a href="#ad02c695f982db05" class="i method">InvokeUploadAsync</a>(<span class="r25 r">uploader</span>, <span class="r19 r">content</span>);
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(2, <span class="r21 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@mscorlib/A.html#12b9bba2a1f9c3e2" class="i property">Count</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<a href="#b17e9f740d2c254b" class="i field">s_response</a>, <span class="r26 r">info</span>);
            <a href="#fdd66a54c23d030c" class="i method">AssertAppended</a>(<span class="r21 r">sink</span>, <span class="r19 r">content</span>);
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(3, <span class="r20 r">testPool</span>.<a href="#727f5cc887071202" class="i field">TotalRents</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(0, <span class="r20 r">testPool</span>.<a href="#7ba8575767c180eb" class="i field">CurrentCount</a>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="7e5b113ea079613c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">MergesLotsOfSmallBlocks</a>()
        {
            <a href="#e660e488ca8e968e" class="t t">TestStream</a> <span id="r27 rd" class="r27 r">content</span> = <b>new</b> <a href="#d6f1dfaf62caf89e" class="t constructor">TestStream</a>(<a href="#47b7b4abdd0ce1a8" class="i field">_async</a>, <b>null</b>,
                <a href="@0@System.Core/A.html#577032c8811e20d3" class="t t">Enumerable</a>.<a href="@0@System.Core/A.html#fda9d378095a6464" class="i method">Range</a>(1, 250).<a href="@0@System.Core/A.html#5c652c53e80df013" class="i method">Select</a>(<span id="r28 rd" class="r28 r">b</span> =&gt; <a href="#e660e488ca8e968e" class="t t">TestStream</a>.<a href="#352e9c6c7d0892b2" class="i method">Read</a>((<b>byte</b>)<span class="r28 r">b</span>, <span class="r28 r">b</span>)).<a href="@0@System.Core/A.html#783a052330e7d48d" class="i method">ToArray</a>()
            );
 
            <a href="#22988b05dfec7fca" class="t t">TrackingArrayPool</a> <span id="r29 rd" class="r29 r">testPool</span> = <b>new</b> <a href="#22988b05dfec7fca" class="t constructor">TrackingArrayPool</a>();
            <a href="#747f30871aa170d4" class="t t">AppendSink</a> <span id="r30 rd" class="r30 r">sink</span> = <b>new</b> <a href="#8de9d13da8fd53af" class="t constructor">AppendSink</a>();
 
            <span class="t t">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt; <span id="r31 rd" class="r31 r">clientMock</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt;(
                <span class="t t">MockBehavior</span>.<span class="i field">Strict</span>, <b>new</b> <a href="@0@System/A.html#9e1bb2fef0d1159b" class="t constructor">Uri</a>(<span class="s">&quot;http://mock&quot;</span>), <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#69de9634982a35cf" class="t constructor">DataLakeClientOptions</a>());
            <span class="r31 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r32 rd" class="r32 r">c</span> =&gt; <span class="r32 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#32cf2458657dd837" class="i property">ClientDiagnostics</a>).<span class="i method">CallBase</span>();
            <span class="r31 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r33 rd" class="r33 r">c</span> =&gt; <span class="r33 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#ed0f0738115fec78" class="i property">Version</a>).<span class="i method">CallBase</span>();
            <a href="#19b3d12614a8f5df" class="i method">SetupInternalStaging</a>(<span class="r31 r">clientMock</span>, <span class="r30 r">sink</span>);
 
            <a href="/Azure.Storage.Files.DataLake/A.html#35188e7929b6e459" class="k">var</a> <span id="r34 rd" class="r34 r">uploader</span> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#050ccd3d4aead9ec" class="t constructor">PartitionedUploader</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#d01943b9b863cede" class="t t">DataLakeFileUploadOptions</a>, <a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt;(
                <a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>.<a href="/Azure.Storage.Files.DataLake/A.html#8d700c9899c78d26" class="i method">GetPartitionedUploaderBehaviors</a>(<span class="r31 r">clientMock</span>.<span class="i property">Object</span>),
                <span class="r8 r">transferOptions</span>: <b>default</b>,
                <span class="r9 r">arrayPool</span>: <span class="r29 r">testPool</span>);
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt; <span id="r35 rd" class="r35 r">info</span> = <b>await</b> <a href="#ad02c695f982db05" class="i method">InvokeUploadAsync</a>(<span class="r34 r">uploader</span>, <span class="r27 r">content</span>);
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(1, <span class="r30 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@mscorlib/A.html#12b9bba2a1f9c3e2" class="i property">Count</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<a href="#b17e9f740d2c254b" class="i field">s_response</a>, <span class="r35 r">info</span>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(2, <span class="r29 r">testPool</span>.<a href="#727f5cc887071202" class="i field">TotalRents</a>); <span class="c">// while conceptually there is one rental, the second rental occurs upon checking for stream end on a Read() call</span>
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(0, <span class="r29 r">testPool</span>.<a href="#7ba8575767c180eb" class="i field">CurrentCount</a>);
            <a href="#fdd66a54c23d030c" class="i method">AssertAppended</a>(<span class="r30 r">sink</span>, <span class="r27 r">content</span>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="eda2b27044002f33" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SmallMaxWriteSize</a>()
        {
            <a href="#e660e488ca8e968e" class="t t">TestStream</a> <span id="r36 rd" class="r36 r">content</span> = <b>new</b> <a href="#d6f1dfaf62caf89e" class="t constructor">TestStream</a>(<a href="#47b7b4abdd0ce1a8" class="i field">_async</a>, <b>null</b>,
                <a href="@0@System.Core/A.html#577032c8811e20d3" class="t t">Enumerable</a>.<a href="@0@System.Core/A.html#fda9d378095a6464" class="i method">Range</a>(1, 1000).<a href="@0@System.Core/A.html#5c652c53e80df013" class="i method">Select</a>(<span id="r37 rd" class="r37 r">b</span> =&gt; <a href="#e660e488ca8e968e" class="t t">TestStream</a>.<a href="#352e9c6c7d0892b2" class="i method">Read</a>((<b>byte</b>)<span class="r37 r">b</span>, 2)).<a href="@0@System.Core/A.html#783a052330e7d48d" class="i method">ToArray</a>()
            );
 
            <a href="#22988b05dfec7fca" class="t t">TrackingArrayPool</a> <span id="r38 rd" class="r38 r">testPool</span> = <b>new</b> <a href="#22988b05dfec7fca" class="t constructor">TrackingArrayPool</a>();
            <a href="#747f30871aa170d4" class="t t">AppendSink</a> <span id="r39 rd" class="r39 r">sink</span> = <b>new</b> <a href="#8de9d13da8fd53af" class="t constructor">AppendSink</a>();
 
            <span class="t t">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt; <span id="r40 rd" class="r40 r">clientMock</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt;(
                <span class="t t">MockBehavior</span>.<span class="i field">Strict</span>, <b>new</b> <a href="@0@System/A.html#9e1bb2fef0d1159b" class="t constructor">Uri</a>(<span class="s">&quot;http://mock&quot;</span>), <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#69de9634982a35cf" class="t constructor">DataLakeClientOptions</a>());
            <span class="r40 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r41 rd" class="r41 r">c</span> =&gt; <span class="r41 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#32cf2458657dd837" class="i property">ClientDiagnostics</a>).<span class="i method">CallBase</span>();
            <span class="r40 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r42 rd" class="r42 r">c</span> =&gt; <span class="r42 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#ed0f0738115fec78" class="i property">Version</a>).<span class="i method">CallBase</span>();
            <a href="#19b3d12614a8f5df" class="i method">SetupInternalStaging</a>(<span class="r40 r">clientMock</span>, <span class="r39 r">sink</span>);
 
            <a href="/Azure.Storage.Files.DataLake/A.html#35188e7929b6e459" class="k">var</a> <span id="r43 rd" class="r43 r">uploader</span> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#050ccd3d4aead9ec" class="t constructor">PartitionedUploader</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#d01943b9b863cede" class="t t">DataLakeFileUploadOptions</a>, <a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt;(
                <a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>.<a href="/Azure.Storage.Files.DataLake/A.html#8d700c9899c78d26" class="i method">GetPartitionedUploaderBehaviors</a>(<span class="r40 r">clientMock</span>.<span class="i property">Object</span>),
                <b>new</b> <a href="/Azure.Storage.Common/A.html#5906346a5aaad27d" class="t constructor">StorageTransferOptions</a>() { <a href="/Azure.Storage.Common/A.html#6c3ac4bff39cdfb2" class="i property">MaximumTransferLength</a> = 100 },
                <span class="r9 r">arrayPool</span>: <span class="r38 r">testPool</span>);
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt; <span id="r44 rd" class="r44 r">info</span> = <b>await</b> <a href="#ad02c695f982db05" class="i method">InvokeUploadAsync</a>(<span class="r43 r">uploader</span>, <span class="r36 r">content</span>);
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<a href="#b17e9f740d2c254b" class="i field">s_response</a>, <span class="r44 r">info</span>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(0, <span class="r38 r">testPool</span>.<a href="#7ba8575767c180eb" class="i field">CurrentCount</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(41, <span class="r38 r">testPool</span>.<a href="#727f5cc887071202" class="i field">TotalRents</a>);
            <a href="#fdd66a54c23d030c" class="i method">AssertAppended</a>(<span class="r39 r">sink</span>, <span class="r36 r">content</span>);
 
            <b>foreach</b> ((<b>byte</b>[] <span id="r45 rd" class="r45 r">bytes</span>, <b>_</b>) <b>in</b> <span class="r39 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@mscorlib/A.html#4367dd1e300ae797" class="i property">Values</a>)
            {
                <span class="t t">Assert</span>.<span class="i method">LessOrEqual</span>(<span class="r45 r">bytes</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>, 100);
                <span class="t t">Assert</span>.<span class="i method">GreaterOrEqual</span>(<span class="r45 r">bytes</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>, 50);
            }
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="5aacff0c86884c2c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">MergesBlocksUntilTheyReachOverHalfMaxSize</a>()
        {
            <a href="#e660e488ca8e968e" class="t t">TestStream</a> <span id="r46 rd" class="r46 r">content</span> = <b>new</b> <a href="#d6f1dfaf62caf89e" class="t constructor">TestStream</a>(<a href="#47b7b4abdd0ce1a8" class="i field">_async</a>, <b>null</b>,
                <a href="#e660e488ca8e968e" class="t t">TestStream</a>.<a href="#352e9c6c7d0892b2" class="i method">Read</a>(0, 5),
                <a href="#e660e488ca8e968e" class="t t">TestStream</a>.<a href="#352e9c6c7d0892b2" class="i method">Read</a>(1, 5),
                <a href="#e660e488ca8e968e" class="t t">TestStream</a>.<a href="#352e9c6c7d0892b2" class="i method">Read</a>(2, 10)
            );
            <a href="#22988b05dfec7fca" class="t t">TrackingArrayPool</a> <span id="r47 rd" class="r47 r">testPool</span> = <b>new</b> <a href="#22988b05dfec7fca" class="t constructor">TrackingArrayPool</a>();
            <a href="#747f30871aa170d4" class="t t">AppendSink</a> <span id="r48 rd" class="r48 r">sink</span> = <b>new</b> <a href="#8de9d13da8fd53af" class="t constructor">AppendSink</a>();
 
            <span class="t t">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt; <span id="r49 rd" class="r49 r">clientMock</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt;(<span class="t t">MockBehavior</span>.<span class="i field">Strict</span>, <b>new</b> <a href="@0@System/A.html#9e1bb2fef0d1159b" class="t constructor">Uri</a>(<span class="s">&quot;http://mock&quot;</span>), <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#69de9634982a35cf" class="t constructor">DataLakeClientOptions</a>());
            <span class="r49 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r50 rd" class="r50 r">c</span> =&gt; <span class="r50 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#32cf2458657dd837" class="i property">ClientDiagnostics</a>).<span class="i method">CallBase</span>();
            <span class="r49 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r51 rd" class="r51 r">c</span> =&gt; <span class="r51 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#ed0f0738115fec78" class="i property">Version</a>).<span class="i method">CallBase</span>();
            <a href="#19b3d12614a8f5df" class="i method">SetupInternalStaging</a>(<span class="r49 r">clientMock</span>, <span class="r48 r">sink</span>);
 
            <a href="/Azure.Storage.Files.DataLake/A.html#35188e7929b6e459" class="k">var</a> <span id="r52 rd" class="r52 r">uploader</span> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#050ccd3d4aead9ec" class="t constructor">PartitionedUploader</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#d01943b9b863cede" class="t t">DataLakeFileUploadOptions</a>, <a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt;(
                <a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>.<a href="/Azure.Storage.Files.DataLake/A.html#8d700c9899c78d26" class="i method">GetPartitionedUploaderBehaviors</a>(<span class="r49 r">clientMock</span>.<span class="i property">Object</span>),
                <b>new</b> <a href="/Azure.Storage.Common/A.html#5906346a5aaad27d" class="t constructor">StorageTransferOptions</a>() { <a href="/Azure.Storage.Common/A.html#6c3ac4bff39cdfb2" class="i property">MaximumTransferLength</a> = 20 },
                <span class="r9 r">arrayPool</span>: <span class="r47 r">testPool</span>);
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt; <span id="r53 rd" class="r53 r">info</span> = <b>await</b> <a href="#ad02c695f982db05" class="i method">InvokeUploadAsync</a>(<span class="r52 r">uploader</span>, <span class="r46 r">content</span>);
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(2, <span class="r48 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@mscorlib/A.html#12b9bba2a1f9c3e2" class="i property">Count</a>);
            <span class="c">// First two should be merged</span>
            <span class="t t">CollectionAssert</span>.<span class="i method">AreEqual</span>(<b>new</b> <b>byte</b>[] { 0, 0, 0, 0, 0, 1, 1, 1, 1, 1 }, <span class="r48 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>[0].<a href="/System.ValueTuple/A.html#16d1b3d03d4e60fa" class="i field">Data</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<a href="#b17e9f740d2c254b" class="i field">s_response</a>, <span class="r53 r">info</span>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(3, <span class="r47 r">testPool</span>.<a href="#727f5cc887071202" class="i field">TotalRents</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(0, <span class="r47 r">testPool</span>.<a href="#7ba8575767c180eb" class="i field">CurrentCount</a>);
            <a href="#fdd66a54c23d030c" class="i method">AssertAppended</a>(<span class="r48 r">sink</span>, <span class="r46 r">content</span>);
        }
 
        [<span class="t constructor">Test</span>]
        [<span class="t constructor">Explicit</span>]
        [<span class="t constructor">Ignore</span>(<span class="s">&quot;https://github.com/Azure/azure-sdk-for-net/issues/12312&quot;</span>)]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="15d2928a85a29967" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CanHandleLongAppendBufferedUpload</a>()
        {
            <b>const long</b> <span id="r54 rd" class="r54 r">blockSize</span> = <b>int</b>.<a href="@0@mscorlib/A.html#c45153c0501d7122" class="i field">MaxValue</a> + 1024L;
            <b>const int</b> <span id="r55 rd" class="r55 r">numBlocks</span> = 2;
            <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r56 rd" class="r56 r">content</span> = <b>new</b> <span class="i n">Storage</span>.<span class="i n">Tests</span>.<span class="i n">Shared</span>.<a href="Shared/PredictableStream.cs.html#4d0fa8c63001b1e1" class="t constructor">PredictableStream</a>(<span class="r55 r">numBlocks</span> * <span class="r54 r">blockSize</span>);
            <a href="#22988b05dfec7fca" class="t t">TrackingArrayPool</a> <span id="r57 rd" class="r57 r">testPool</span> = <b>new</b> <a href="#22988b05dfec7fca" class="t constructor">TrackingArrayPool</a>();
            <a href="#747f30871aa170d4" class="t t">AppendSink</a> <span id="r58 rd" class="r58 r">sink</span> = <b>new</b> <a href="#8de9d13da8fd53af" class="t constructor">AppendSink</a>(<b>false</b>); <span class="c">// sink can&#39;t hold long blocks, and we don&#39;t need to look at their data anyway.</span>
 
            <span class="t t">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt; <span id="r59 rd" class="r59 r">clientMock</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt;(<span class="t t">MockBehavior</span>.<span class="i field">Strict</span>, <b>new</b> <a href="@0@System/A.html#9e1bb2fef0d1159b" class="t constructor">Uri</a>(<span class="s">&quot;http://mock&quot;</span>), <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#69de9634982a35cf" class="t constructor">DataLakeClientOptions</a>());
            <span class="r59 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r60 rd" class="r60 r">c</span> =&gt; <span class="r60 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#32cf2458657dd837" class="i property">ClientDiagnostics</a>).<span class="i method">CallBase</span>();
            <span class="r59 r">clientMock</span>.<span class="i method">SetupGet</span>(<span id="r61 rd" class="r61 r">c</span> =&gt; <span class="r61 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#ed0f0738115fec78" class="i property">Version</a>).<span class="i method">CallBase</span>();
            <a href="#19b3d12614a8f5df" class="i method">SetupInternalStaging</a>(<span class="r59 r">clientMock</span>, <span class="r58 r">sink</span>);
 
            <a href="/Azure.Storage.Files.DataLake/A.html#35188e7929b6e459" class="k">var</a> <span id="r62 rd" class="r62 r">uploader</span> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#050ccd3d4aead9ec" class="t constructor">PartitionedUploader</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#d01943b9b863cede" class="t t">DataLakeFileUploadOptions</a>, <a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt;(
                <a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>.<a href="/Azure.Storage.Files.DataLake/A.html#8d700c9899c78d26" class="i method">GetPartitionedUploaderBehaviors</a>(<span class="r59 r">clientMock</span>.<span class="i property">Object</span>),
                <b>new</b> <a href="/Azure.Storage.Common/A.html#5906346a5aaad27d" class="t constructor">StorageTransferOptions</a>
                {
                    <a href="/Azure.Storage.Common/A.html#ef29544986a37504" class="i property">InitialTransferSize</a> = 1, <span class="c">// forces buffered upload</span>
                    <a href="/Azure.Storage.Common/A.html#e6cf33ac88512449" class="i property">MaximumTransferSize</a> = <span class="r54 r">blockSize</span>,
                    <a href="/Azure.Storage.Common/A.html#9af76c13ed7d72aa" class="i property">MaximumConcurrency</a> = 2
                },
                <span class="r9 r">arrayPool</span>: <span class="r57 r">testPool</span>);
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt; <span id="r63 rd" class="r63 r">info</span> = <b>await</b> <a href="#ad02c695f982db05" class="i method">InvokeUploadAsync</a>(<span class="r62 r">uploader</span>, <span class="r56 r">content</span>);
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<a href="#b17e9f740d2c254b" class="i field">s_response</a>, <span class="r63 r">info</span>);
            <b>foreach</b> (<a href="/System.ValueTuple/A.html#0d3bf0818d69cf43" class="k">var</a> <span id="r64 rd" class="r64 r">block</span> <b>in</b> <span class="r58 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@mscorlib/A.html#4367dd1e300ae797" class="i property">Values</a>)
            {
                <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r54 r">blockSize</span>, <span class="r64 r">block</span>.<a href="/System.ValueTuple/A.html#cb048e791e0f3b45" class="i field">Length</a>);
            }
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt;&gt; <a id="ad02c695f982db05" href="R/ad02c695f982db05.html" target="n" data-glyph="76,1" class="i method">InvokeUploadAsync</a>(<a href="/Azure.Storage.Files.DataLake/A.html#35188e7929b6e459" class="t t">PartitionedUploader</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#d01943b9b863cede" class="t t">DataLakeFileUploadOptions</a>, <a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt; <span id="r65 rd" class="r65 r">uploader</span>, <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r66 rd" class="r66 r">content</span>)
            =&gt; <b>await</b> <span class="r65 r">uploader</span>.<a href="/Azure.Storage.Files.DataLake/A.html#7f3add0cb0a7bb12" class="i method">UploadInternal</a>(
                <span class="r66 r">content</span>,
                <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#9cdc5212a5a3f84b" class="t constructor">DataLakeFileUploadOptions</a>
                {
                    <a href="/Azure.Storage.Files.DataLake/A.html#5ef71113fc8d3373" class="i property">HttpHeaders</a> = <a href="#33e19c17b56fa347" class="i field">s_pathHttpHeaders</a>,
                    <a href="/Azure.Storage.Files.DataLake/A.html#664ef53dc5bb7eae" class="i property">Conditions</a> = <a href="#6f437d0f6e3766a9" class="i field">s_conditions</a>,
                    <a href="/Azure.Storage.Files.DataLake/A.html#8aa494ffa5cab4d6" class="i property">Umask</a> = <a href="#67416794edef5a87" class="i field">s_umask</a>,
                    <a href="/Azure.Storage.Files.DataLake/A.html#8ab2efbc025b4469" class="i property">Permissions</a> = <a href="#0a40486381805ca2" class="i field">s_permissions</a>
                },
                <a href="#f496990ab820d2f9" class="i field">s_progress</a>,
                <a href="#47b7b4abdd0ce1a8" class="i field">_async</a>,
                <a href="#26aac2e42024fa40" class="i field">s_cancellationToken</a>);
 
        <b>private void</b> <a id="19b3d12614a8f5df" href="R/19b3d12614a8f5df.html" target="n" data-glyph="76,1" class="i method">SetupInternalStaging</a>(<span class="t t">Mock</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="t t">DataLakeFileClient</a>&gt; <span id="r67 rd" class="r67 r">clientMock</span>, <a href="#747f30871aa170d4" class="t t">AppendSink</a> <span id="r68 rd" class="r68 r">sink</span>)
        {
            <span class="r67 r">clientMock</span>.<span class="i method">Setup</span>(
                <span id="r69 rd" class="r69 r">c</span> =&gt; <span class="r69 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#2d6a96d73c2eb785" class="i method">CreateInternal</a>(
                    <span class="i method">IsAny</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#668a2b5bb82caf0c" class="t t">PathResourceType</a>&gt;(),
                    <a href="#33e19c17b56fa347" class="i field">s_pathHttpHeaders</a>,
                    <b>default</b>,
                    <a href="#0a40486381805ca2" class="i field">s_permissions</a>,
                    <a href="#67416794edef5a87" class="i field">s_umask</a>,
                    <a href="#6f437d0f6e3766a9" class="i field">s_conditions</a>,
                    <a href="#47b7b4abdd0ce1a8" class="i field">_async</a>,
                    <a href="#26aac2e42024fa40" class="i field">s_cancellationToken</a>
                )).<span class="i method">Returns</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#668a2b5bb82caf0c" class="t t">PathResourceType</a>, <a href="/Azure.Storage.Files.DataLake/A.html#cc3a1ab0659ac139" class="t t">PathHttpHeaders</a>, <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="/Azure.Storage.Files.DataLake/A.html#4d80583f26ed254a" class="t t">DataLakeRequestConditions</a>, <b>bool</b>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>&gt;(<span class="r68 r">sink</span>.<a href="#e142feeeb8e0213c" class="i method">CreateInternal</a>);
 
            <span class="r67 r">clientMock</span>.<span class="i method">Setup</span>(
                <span id="r70 rd" class="r70 r">c</span> =&gt; <span class="r70 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#ebfa48271d1112ef" class="i method">AppendInternal</a>(
                    <span class="i method">IsAny</span>&lt;<a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a>&gt;(),
                    <span class="i method">IsAny</span>&lt;<b>long</b>&gt;(),
                    <span class="i method">IsAny</span>&lt;<b>byte</b>[]&gt;(),
                    <span class="i method">IsAny</span>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(),
                    <span class="i method">IsAny</span>&lt;<a href="@0@mscorlib/A.html#766adb700a2972f5" class="t t">IProgress</a>&lt;<b>long</b>&gt;&gt;(),
                    <a href="#47b7b4abdd0ce1a8" class="i field">_async</a>,
                    <a href="#26aac2e42024fa40" class="i field">s_cancellationToken</a>
                )).<span class="i method">Returns</span>&lt;<a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a>, <b>long</b>, <b>byte</b>[], <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#766adb700a2972f5" class="t t">IProgress</a>&lt;<b>long</b>&gt;, <b>bool</b>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>&gt;(<span class="r68 r">sink</span>.<a href="#a210e8ca8ad9fce7" class="i method">AppendInternal</a>);
 
            <span class="r67 r">clientMock</span>.<span class="i method">Setup</span>(
                <span id="r71 rd" class="r71 r">c</span> =&gt; <span class="r71 r">c</span>.<a href="/Azure.Storage.Files.DataLake/A.html#25b2cb0aebc1a95d" class="i method">FlushInternal</a>(
                    <span class="i method">IsAny</span>&lt;<b>long</b>&gt;(),
                    <span class="i method">IsAny</span>&lt;<b>bool</b>?&gt;(),
                    <span class="i method">IsAny</span>&lt;<b>bool</b>?&gt;(),
                    <a href="#33e19c17b56fa347" class="i field">s_pathHttpHeaders</a>,
                    <span class="i method">IsAny</span>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#4d80583f26ed254a" class="t t">DataLakeRequestConditions</a>&gt;(),
                    <a href="#47b7b4abdd0ce1a8" class="i field">_async</a>,
                    <a href="#26aac2e42024fa40" class="i field">s_cancellationToken</a>
                )).<span class="i method">Returns</span>&lt;<b>long</b>, <b>bool</b>?, <b>bool</b>?, <a href="/Azure.Storage.Files.DataLake/A.html#cc3a1ab0659ac139" class="t t">PathHttpHeaders</a>, <a href="/Azure.Storage.Files.DataLake/A.html#4d80583f26ed254a" class="t t">DataLakeRequestConditions</a>, <b>bool</b>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>&gt;(<span class="r68 r">sink</span>.<a href="#a4909133589be993" class="i method">FlushInternal</a>);
        }
 
        <b>private static void</b> <a id="fdd66a54c23d030c" href="R/fdd66a54c23d030c.html" target="n" data-glyph="76,1" class="i method">AssertAppended</a>(<a href="#747f30871aa170d4" class="t t">AppendSink</a> <span id="r72 rd" class="r72 r">sink</span>, <a href="#e660e488ca8e968e" class="t t">TestStream</a> <span id="r73 rd" class="r73 r">stream</span>)
        {
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r72 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@mscorlib/A.html#12b9bba2a1f9c3e2" class="i property">Count</a>, <span class="r72 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@mscorlib/A.html#12b9bba2a1f9c3e2" class="i property">Count</a>);
 
            <span class="t t">CollectionAssert</span>.<span class="i method">AreEqual</span>(
                <span class="r73 r">stream</span>.<a href="#5135a319c1f38e31" class="i property">AllBytes</a>,
                <span class="r72 r">sink</span>.<a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@System.Core/A.html#e449fbc07f49dc52" class="i method">OrderBy</a>(<span id="r74 rd" class="r74 r">kv</span> =&gt; <span class="r74 r">kv</span>.<a href="@0@mscorlib/A.html#f9d1c04feb1af032" class="i property">Key</a>).<a href="@0@System.Core/A.html#8f3471331178bcb0" class="i method">SelectMany</a>(<span id="r75 rd" class="r75 r">kv</span> =&gt; <span class="r75 r">kv</span>.<a href="@0@mscorlib/A.html#38c0e86cc4b30170" class="i property">Value</a>.<a href="/System.ValueTuple/A.html#16d1b3d03d4e60fa" class="i field">Data</a>));
        }
 
        <b>private class</b> <a id="747f30871aa170d4" href="R/747f30871aa170d4.html" target="n" data-glyph="4,1" class="t t">AppendSink</a>
        {
            <b>private readonly bool</b> <a id="899548a7c8877a73" href="R/899548a7c8877a73.html" target="n" data-glyph="46,2" class="i field">_saveBytes</a>;
 
            <b>public</b> <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<b>long</b>, (<b>byte</b>[] <a id="16d1b3d03d4e60fa" href="R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Data</a>, <b>long</b>? <a id="cb048e791e0f3b45" href="R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Length</a>)&gt; <a id="ee33dc7d01688213" href="R/ee33dc7d01688213.html" target="n" data-glyph="102,2" class="i property">Appended</a> { <b>get</b>; }
 
            <b>public</b> <a id="8de9d13da8fd53af" href="R/8de9d13da8fd53af.html" target="n" data-glyph="72,2" class="t constructor">AppendSink</a>(<b>bool</b> <span id="r76 rd" class="r76 r">saveBytes</span> = <b>true</b>)
            {
                <a href="#899548a7c8877a73" class="i field">_saveBytes</a> = <span class="r76 r">saveBytes</span>;
                <a href="#ee33dc7d01688213" class="i property">Appended</a> = <b>new</b> <a href="@0@mscorlib/A.html#bf6849e410b43c4c" class="t constructor">Dictionary</a>&lt;<b>long</b>, (<b>byte</b>[] <span class="i field">Data</span>, <b>long</b>? <span class="i field">Length</span>)&gt;();
            }
 
            <b>public async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt;&gt; <a id="e142feeeb8e0213c" href="R/e142feeeb8e0213c.html" target="n" data-glyph="72,2" class="i method">CreateInternal</a>(
                <a href="/Azure.Storage.Files.DataLake/A.html#668a2b5bb82caf0c" class="t t">PathResourceType</a> <span id="r77 rd" class="r77 r">type</span>,
                <a href="/Azure.Storage.Files.DataLake/A.html#cc3a1ab0659ac139" class="t t">PathHttpHeaders</a> <span id="r78 rd" class="r78 r">httpHeaders</span>,
                <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <span id="r79 rd" class="r79 r">metadata</span>,
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r80 rd" class="r80 r">permissions</span>,
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r81 rd" class="r81 r">umask</span>,
                <a href="/Azure.Storage.Files.DataLake/A.html#4d80583f26ed254a" class="t t">DataLakeRequestConditions</a> <span id="r82 rd" class="r82 r">conditions</span>,
                <b>bool</b> <span id="r83 rd" class="r83 r">async</span>,
                <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r84 rd" class="r84 r">cancellationToken</span>)
            {
                <b>if</b> (<span class="r83 r">async</span>)
                {
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#34b191a243434f6a" class="i method">Delay</a>(25);
                }
                <b>return</b> <a href="#b17e9f740d2c254b" class="i field">s_response</a>;
            }
 
            <b>public async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Storage.Files.DataLake/A.html#9ae75d96c041af76" class="t t">PathInfo</a>&gt;&gt; <a id="a4909133589be993" href="R/a4909133589be993.html" target="n" data-glyph="72,2" class="i method">FlushInternal</a>(
                <b>long</b> <span id="r85 rd" class="r85 r">position</span>,
                <b>bool</b>? <span id="r86 rd" class="r86 r">retainUncommittedData</span>,
                <b>bool</b>? <span id="r87 rd" class="r87 r">close</span>,
                <a href="/Azure.Storage.Files.DataLake/A.html#cc3a1ab0659ac139" class="t t">PathHttpHeaders</a> <span id="r88 rd" class="r88 r">httpHeaders</span>,
                <a href="/Azure.Storage.Files.DataLake/A.html#4d80583f26ed254a" class="t t">DataLakeRequestConditions</a> <span id="r89 rd" class="r89 r">conditions</span>,
                <b>bool</b> <span id="r90 rd" class="r90 r">async</span>,
                <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r91 rd" class="r91 r">cancellationToken</span>)
            {
                <b>if</b> (<span class="r90 r">async</span>)
                {
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#34b191a243434f6a" class="i method">Delay</a>(25);
                }
                <b>return</b> <a href="#b17e9f740d2c254b" class="i field">s_response</a>;
            }
 
            <b>public async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#ad97b1910f5ca3eb" class="t t">Response</a>&gt; <a id="a210e8ca8ad9fce7" href="R/a210e8ca8ad9fce7.html" target="n" data-glyph="72,2" class="i method">AppendInternal</a>(
                <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r92 rd" class="r92 r">stream</span>,
                <b>long</b> <span id="r93 rd" class="r93 r">offset</span>,
                <b>byte</b>[] <span id="r94 rd" class="r94 r">hash</span>,
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r95 rd" class="r95 r">leaseId</span>,
                <a href="@0@mscorlib/A.html#766adb700a2972f5" class="t t">IProgress</a>&lt;<b>long</b>&gt; <span id="r96 rd" class="r96 r">progress</span>,
                <b>bool</b> <span id="r97 rd" class="r97 r">async</span>,
                <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r98 rd" class="r98 r">cancellationToken</span>)
            {
                <b>if</b> (<span class="r97 r">async</span>)
                {
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#34b191a243434f6a" class="i method">Delay</a>(25);
                }
                <span class="r96 r">progress</span>.<a href="@0@mscorlib/A.html#cd87d052fb216d27" class="i method">Report</a>(<span class="r92 r">stream</span>.<a href="@0@mscorlib/A.html#48b7e39cfd844dc5" class="i property">Length</a>);
 
                <b>byte</b>[] <span id="r99 rd" class="r99 r">data</span> = <b>default</b>;
                <b>if</b> (<a href="#899548a7c8877a73" class="i field">_saveBytes</a>)
                {
                    <a href="@0@mscorlib/A.html#1a4dcb744a23ba6f" class="k">var</a> <span id="r100 rd" class="r100 r">memoryStream</span> = <b>new</b> <a href="@0@mscorlib/A.html#d308091cc690e78d" class="t constructor">MemoryStream</a>();
                    <span class="r92 r">stream</span>.<a href="@0@mscorlib/A.html#295ec16c77d4fafb" class="i method">CopyTo</a>(<span class="r100 r">memoryStream</span>);
                    <span class="r100 r">memoryStream</span>.<a href="@0@mscorlib/A.html#ad08f8ca81a5a763" class="i property">Position</a> = 0;
                    <span class="r99 r">data</span> = <span class="r100 r">memoryStream</span>.<a href="@0@mscorlib/A.html#5df5fc757781f05e" class="i method">ToArray</a>();
                }
                <b>lock</b> (<a href="#ee33dc7d01688213" class="i property">Appended</a>)
                {
                    <a href="#ee33dc7d01688213" class="i property">Appended</a>.<a href="@0@mscorlib/A.html#a7861da7aaa500fe" class="i method">Add</a>(<span class="r93 r">offset</span>, (<span class="r99 r">data</span>, <span class="r92 r">stream</span>.<a href="@0@mscorlib/A.html#48b7e39cfd844dc5" class="i property">Length</a>));
                }
                <b>return</b> <b>new</b> <a href="/Azure.Core.TestFramework/A.html#ef2adc622c2950d8" class="t constructor">MockResponse</a>(200);
            }
        }
 
        <b>public class</b> <a id="22988b05dfec7fca" href="R/22988b05dfec7fca.html" target="n" data-glyph="0,1" class="t t"><span id="1ca19d5ec6979d2c">TrackingArrayPool</span></a> : <span class="t t">ArrayPool</span>&lt;<b>byte</b>&gt;
        {
            <b>private</b> <span class="t t">ArrayPool</span>&lt;<b>byte</b>&gt; <a id="487431ca91d87b9d" href="R/487431ca91d87b9d.html" target="n" data-glyph="46,2" class="i field">_innerPool</a> = <span class="t t">ArrayPool</span>&lt;<b>byte</b>&gt;.<span class="i property">Shared</span>;
            <b>public int</b> <a id="727f5cc887071202" href="R/727f5cc887071202.html" target="n" data-glyph="42,2" class="i field">TotalRents</a>;
 
            <b>public int</b> <a id="7ba8575767c180eb" href="R/7ba8575767c180eb.html" target="n" data-glyph="42,2" class="i field">CurrentCount</a>;
 
            <b>public override byte</b>[] <a id="47372326fbc37fae" href="R/47372326fbc37fae.html" target="n" data-glyph="72,2" class="i method">Rent</a>(<b>int</b> <span id="r101 rd" class="r101 r">minimumLength</span>)
            {
                <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#09bb1e21afd76cf2" class="i method">Increment</a>(<b>ref</b> <a href="#727f5cc887071202" class="i field">TotalRents</a>);
                <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#09bb1e21afd76cf2" class="i method">Increment</a>(<b>ref</b> <a href="#7ba8575767c180eb" class="i field">CurrentCount</a>);
 
                <b>return</b> <a href="#487431ca91d87b9d" class="i field">_innerPool</a>.<span class="i method">Rent</span>(<span class="r101 r">minimumLength</span>);
            }
 
            <b>public override void</b> <a id="619e4d1753feadc7" href="R/619e4d1753feadc7.html" target="n" data-glyph="72,2" class="i method">Return</a>(<b>byte</b>[] <span id="r102 rd" class="r102 r">array</span>, <b>bool</b> <span id="r103 rd" class="r103 r">clearArray</span> = <b>false</b>)
            {
                <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#862b9b279a981510" class="i method">Decrement</a>(<b>ref</b> <a href="#7ba8575767c180eb" class="i field">CurrentCount</a>);
                <a href="#487431ca91d87b9d" class="i field">_innerPool</a>.<span class="i method">Return</span>(<span class="r102 r">array</span>, <b>true</b>);
            }
        }
 
        <b>private class</b> <a id="e660e488ca8e968e" href="R/e660e488ca8e968e.html" target="n" data-glyph="4,1" class="t t">TestStream</a> : <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a>
        {
            <b>private readonly bool</b> <a id="5e6f79d6fb348ffd" href="R/5e6f79d6fb348ffd.html" target="n" data-glyph="46,2" class="i field">_async</a>;
 
            <b>private readonly int</b>? <a id="c16d84438b164335" href="R/c16d84438b164335.html" target="n" data-glyph="46,2" class="i field">_length</a>;
 
            <b>private readonly</b> <a href="#4c3df7ca70e7a9bb" class="t t">TestStreamRead</a>[] <a id="d29ce5bf76d9dfe8" href="R/d29ce5bf76d9dfe8.html" target="n" data-glyph="46,2" class="i field">_reads</a>;
 
            <b>private int</b> <a id="93f20daabcc4e728" href="R/93f20daabcc4e728.html" target="n" data-glyph="46,2" class="i field">_readIndex</a> = 0;
 
            <b>public</b> <a id="d6f1dfaf62caf89e" href="R/d6f1dfaf62caf89e.html" target="n" data-glyph="72,2" class="t constructor">TestStream</a>(<b>bool</b> <span id="r104 rd" class="r104 r">async</span>, <b>int</b>? <span id="r105 rd" class="r105 r">length</span>, <b>params</b> <a href="#4c3df7ca70e7a9bb" class="t t">TestStreamRead</a>[] <span id="r106 rd" class="r106 r">reads</span>)
            {
                <a href="#5e6f79d6fb348ffd" class="i field">_async</a> = <span class="r104 r">async</span>;
                <a href="#c16d84438b164335" class="i field">_length</a> = <span class="r105 r">length</span>;
                <a href="#d29ce5bf76d9dfe8" class="i field">_reads</a> = <span class="r106 r">reads</span>;
            }
 
            <b>public override void</b> <a id="bb75e6bbd069ae67" href="R/bb75e6bbd069ae67.html" target="n" data-glyph="72,2" class="i method">Flush</a>()
            {
                <b>throw</b> <b>new</b> <span class="i n">System</span>.<a href="@0@mscorlib/A.html#085d4139ffb78d13" class="t constructor">NotImplementedException</a>();
            }
 
            <b>public override int</b> <a id="1623dfd8cb72b7f5" href="R/1623dfd8cb72b7f5.html" target="n" data-glyph="72,2" class="i method">Read</a>(<b>byte</b>[] <span id="r107 rd" class="r107 r">buffer</span>, <b>int</b> <span id="r108 rd" class="r108 r">offset</span>, <b>int</b> <span id="r109 rd" class="r109 r">count</span>)
            {
                <b>if</b> (<a href="#5e6f79d6fb348ffd" class="i field">_async</a>)
                    <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#8d6a52a5496ce078" class="t constructor">InvalidOperationException</a>();
 
                <b>return</b> <a href="#195b43a4f5e4ea83" class="i method">ReadCore</a>(<span class="r107 r">buffer</span>, <span class="r108 r">offset</span>);
            }
 
            <b>private int</b> <a id="195b43a4f5e4ea83" href="R/195b43a4f5e4ea83.html" target="n" data-glyph="76,2" class="i method">ReadCore</a>(<b>byte</b>[] <span id="r110 rd" class="r110 r">buffer</span>, <b>int</b> <span id="r111 rd" class="r111 r">offset</span>)
            {
                <b>if</b> (<a href="#93f20daabcc4e728" class="i field">_readIndex</a> == <a href="#d29ce5bf76d9dfe8" class="i field">_reads</a>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>)
                {
                    <b>return</b> 0;
                }
 
                <a href="#4c3df7ca70e7a9bb" class="t t">TestStreamRead</a> <span id="r112 rd" class="r112 r">read</span> = <a href="#d29ce5bf76d9dfe8" class="i field">_reads</a>[<a href="#93f20daabcc4e728" class="i field">_readIndex</a>++];
 
                <span class="r112 r">read</span>.<a href="#d5e6c14f504921a1" class="i property">Data</a>.<a href="@0@mscorlib/A.html#d3c9a3da4e5d9327" class="i method">CopyTo</a>(<span class="r110 r">buffer</span>, <span class="r111 r">offset</span>);
 
                <b>return</b> <span class="r112 r">read</span>.<a href="#a3b993970e952527" class="i property">Length</a>;
            }
 
            <b>public override</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>int</b>&gt; <a id="0a34712680698e08" href="R/0a34712680698e08.html" target="n" data-glyph="72,2" class="i method">ReadAsync</a>(<b>byte</b>[] <span id="r113 rd" class="r113 r">buffer</span>, <b>int</b> <span id="r114 rd" class="r114 r">offset</span>, <b>int</b> <span id="r115 rd" class="r115 r">count</span>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r116 rd" class="r116 r">cancellationToken</span>)
            {
                <b>if</b> (!<a href="#5e6f79d6fb348ffd" class="i field">_async</a>)
                    <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#8d6a52a5496ce078" class="t constructor">InvalidOperationException</a>();
 
                <b>return</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#11a386e7d7cae64a" class="i method">FromResult</a>(<a href="#195b43a4f5e4ea83" class="i method">ReadCore</a>(<span class="r113 r">buffer</span>, <span class="r114 r">offset</span>));
            }
 
            <b>public override long</b> <a id="94c26ca592d6c248" href="R/94c26ca592d6c248.html" target="n" data-glyph="72,2" class="i method">Seek</a>(<b>long</b> <span id="r117 rd" class="r117 r">offset</span>, <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a> <span id="r118 rd" class="r118 r">origin</span>)
            {
                <b>throw</b> <b>new</b> <span class="i n">System</span>.<a href="@0@mscorlib/A.html#085d4139ffb78d13" class="t constructor">NotImplementedException</a>();
            }
 
            <b>public override void</b> <a id="9e66576d0dbe4b29" href="R/9e66576d0dbe4b29.html" target="n" data-glyph="72,2" class="i method">SetLength</a>(<b>long</b> <span id="r119 rd" class="r119 r">value</span>)
            {
                <b>throw</b> <b>new</b> <span class="i n">System</span>.<a href="@0@mscorlib/A.html#085d4139ffb78d13" class="t constructor">NotImplementedException</a>();
            }
 
            <b>public override void</b> <a id="949620f81c9ff1a3" href="R/949620f81c9ff1a3.html" target="n" data-glyph="72,2" class="i method">Write</a>(<b>byte</b>[] <span id="r120 rd" class="r120 r">buffer</span>, <b>int</b> <span id="r121 rd" class="r121 r">offset</span>, <b>int</b> <span id="r122 rd" class="r122 r">count</span>)
            {
                <b>throw</b> <b>new</b> <span class="i n">System</span>.<a href="@0@mscorlib/A.html#085d4139ffb78d13" class="t constructor">NotImplementedException</a>();
            }
 
            <b>public override bool</b> <a id="184114f245de852f" href="R/184114f245de852f.html" target="n" data-glyph="102,2" class="i property">CanRead</a> { <b>get</b>; }
            <b>public override bool</b> <a id="86e64ac5be4797ac" href="R/86e64ac5be4797ac.html" target="n" data-glyph="102,2" class="i property">CanSeek</a> =&gt; <a href="#c16d84438b164335" class="i field">_length</a>.<a href="@0@mscorlib/A.html#7bbe60e33e857298" class="i property">HasValue</a>;
            <b>public override bool</b> <a id="1b6a719d1d46c26e" href="R/1b6a719d1d46c26e.html" target="n" data-glyph="102,2" class="i property">CanWrite</a> { <b>get</b>; }
 
            <b>public override long</b> <a id="a46a06716eeb0d7d" href="R/a46a06716eeb0d7d.html" target="n" data-glyph="102,2" class="i property">Length</a> =&gt; <a href="#c16d84438b164335" class="i field">_length</a>.<a href="@0@mscorlib/A.html#7b38d1fa76071c95" class="i property">Value</a>;
 
            <b>public override long</b> <a id="e594ade80be86cd9" href="R/e594ade80be86cd9.html" target="n" data-glyph="102,2" class="i property">Position</a> { <b>get</b>; <b>set</b>; }
            <b>public</b> <a href="@0@mscorlib/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<b>byte</b>&gt; <a id="5135a319c1f38e31" href="R/5135a319c1f38e31.html" target="n" data-glyph="102,2" class="i property">AllBytes</a> =&gt; <a href="#d29ce5bf76d9dfe8" class="i field">_reads</a>.<a href="@0@System.Core/A.html#8f3471331178bcb0" class="i method">SelectMany</a>(<span id="r123 rd" class="r123 r">r</span> =&gt; <span class="r123 r">r</span>.<a href="#d5e6c14f504921a1" class="i property">Data</a>);
 
            <b>public static</b> <a href="#4c3df7ca70e7a9bb" class="t t">TestStreamRead</a> <a id="352e9c6c7d0892b2" href="R/352e9c6c7d0892b2.html" target="n" data-glyph="72,2" class="i method">Read</a>(<b>byte</b> <span id="r124 rd" class="r124 r">readId</span>, <b>int</b> <span id="r125 rd" class="r125 r">length</span>)
            {
                <b>var</b> <span id="r126 rd" class="r126 r">data</span> = <b>new</b> <b>byte</b>[<span class="r125 r">length</span>];
                <b>for</b> (<b>int</b> <span id="r127 rd" class="r127 r">i</span> = 0; <span class="r127 r">i</span> &lt; <span class="r126 r">data</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>; <span class="r127 r">i</span>++)
                {
                    <span class="r126 r">data</span>[<span class="r127 r">i</span>] = <span class="r124 r">readId</span>;
                }
                <b>return</b> <b>new</b> <a href="#3d90d95ae90407ee" class="t constructor">TestStreamRead</a>(<span class="r125 r">length</span>, <span class="r126 r">data</span>);
            }
 
            <b>public readonly struct</b> <a id="4c3df7ca70e7a9bb" href="R/4c3df7ca70e7a9bb.html" target="n" data-glyph="108,2" class="t t"><span id="53b0d82220ca70c1">TestStreamRead</span></a>
            {
                <b>public int</b> <a id="a3b993970e952527" href="R/a3b993970e952527.html" target="n" data-glyph="102,3" class="i property">Length</a> { <b>get</b>; }
                <b>public byte</b>[] <a id="d5e6c14f504921a1" href="R/d5e6c14f504921a1.html" target="n" data-glyph="102,3" class="i property">Data</a> { <b>get</b>; }
 
                <b>public</b> <a id="3d90d95ae90407ee" href="R/3d90d95ae90407ee.html" target="n" data-glyph="72,3" class="t constructor">TestStreamRead</a>(<b>int</b> <span id="r128 rd" class="r128 r">length</span>, <b>byte</b>[] <span id="r129 rd" class="r129 r">data</span>)
                {
                    <a href="#a3b993970e952527" class="i property">Length</a> = <span class="r128 r">length</span>;
                    <a href="#d5e6c14f504921a1" class="i property">Data</a> = <span class="r129 r">data</span>;
                }
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
