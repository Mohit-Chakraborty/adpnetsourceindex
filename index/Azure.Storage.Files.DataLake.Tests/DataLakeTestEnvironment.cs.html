<!DOCTYPE html>
<html><head><title>DataLakeTestEnvironment.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(113);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Storage.Files.DataLake.Tests/DataLakeTestEnvironment.cs" target="_top">DataLakeTestEnvironment.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/storage/Azure.Storage.Files.DataLake/tests/DataLakeTestEnvironment.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Storage.Files.DataLake.Tests" target="_top">Azure.Storage.Files.DataLake.Tests.csproj</a> (Azure.Storage.Files.DataLake.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Blobs</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Blobs</span>.<span class="i n">Specialized</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Sas</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Test</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Test</span>.<span class="i n">Shared</span>;
<b>using</b> <span class="i n">NUnit</span>.<span class="i n">Framework</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Files</span>.<span class="i n">DataLake</span>.<span class="i n">Tests</span>
{
    <b>public class</b> <a id="bd4c3080c141c3af" href="R/bd4c3080c141c3af.html" target="n" data-glyph="0,0" class="t t"><span id="a669761a23547865">DataLakeTestEnvironment</span></a> : <a href="Shared/StorageTestEnvironment.cs.html#44c664d475d08f1e" class="t t">StorageTestEnvironment</a>
    {
        <b>protected override async</b> <span class="t t">ValueTask</span>&lt;<b>bool</b>&gt; <a id="ea83eaff67ba595e" href="R/ea83eaff67ba595e.html" target="n" data-glyph="75,1" class="i method">IsEnvironmentReadyAsync</a>()
        {
            <b>return</b> <b>await</b> <a href="#9c647bfe36e6a034" class="i method">DoesOAuthWorkAsync</a>();
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>bool</b>&gt; <a id="9c647bfe36e6a034" href="R/9c647bfe36e6a034.html" target="n" data-glyph="76,1" class="i method">DoesOAuthWorkAsync</a>()
        {
            <span class="t t">TestContext</span>.<span class="i field">Error</span>.<a href="@0@mscorlib/A.html#5238cceaebfeaa74" class="i method">WriteLine</a>(<span class="s">$&quot;</span><span class="s">Datalake Probing OAuth </span>{<a href="@0@System/A.html#f8b2e604d6f1fe04" class="t t">Process</a>.<a href="@0@System/A.html#a106ad886675f6a5" class="i method">GetCurrentProcess</a>().<a href="@0@System/A.html#e7bdad2b99a54a87" class="i property">Id</a>}<span class="s">&quot;</span>);
 
            <b>try</b>
            {
                <b>for</b> (<b>int</b> <span id="r0 rd" class="r0 r">i</span> = 0; <span class="r0 r">i</span> &lt; 10; <span class="r0 r">i</span>++)
                {
                    <span class="c">// Check flat account. For some reason we observe failures if that one doesn&#39;t work before we start datalake run.</span>
                    {
                        <a href="/Azure.Storage.Blobs/A.html#5c3c4fe54cdb5868" class="t t">BlobServiceClient</a> <span id="r1 rd" class="r1 r">serviceClient</span> = <b>new</b> <a href="/Azure.Storage.Blobs/A.html#7b70b07883e557d3" class="t constructor">BlobServiceClient</a>(
                            <b>new</b> <a href="@0@System/A.html#9e1bb2fef0d1159b" class="t constructor">Uri</a>(<a href="Shared/TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="Shared/TestConfigurations.cs.html#99e6fd959b52df5b" class="i property">DefaultTargetOAuthTenant</a>.<a href="Shared/TenantConfiguration.cs.html#9c094343c57a64fb" class="i property">BlobServiceEndpoint</a>),
                            <a href="Shared/StorageTestEnvironment.cs.html#e89f059c129e2230" class="i method">GetOAuthCredential</a>(<a href="Shared/TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="Shared/TestConfigurations.cs.html#99e6fd959b52df5b" class="i property">DefaultTargetOAuthTenant</a>));
                        <b>await</b> <span class="r1 r">serviceClient</span>.<a href="/Azure.Storage.Blobs/A.html#84b2da680c276cfd" class="i method">GetPropertiesAsync</a>();
                        <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r2 rd" class="r2 r">containerName</span> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>();
                        <a href="/Azure.Storage.Blobs/A.html#6bb2c165ee95c7d4" class="k">var</a> <span id="r3 rd" class="r3 r">containerClient</span> = <span class="r1 r">serviceClient</span>.<a href="/Azure.Storage.Blobs/A.html#e3b6b5726874c210" class="i method">GetBlobContainerClient</a>(<span class="r2 r">containerName</span>);
                        <b>await</b> <span class="r3 r">containerClient</span>.<a href="/Azure.Storage.Blobs/A.html#bc2496fa7483427d" class="i method">CreateIfNotExistsAsync</a>();
                        <b>try</b>
                        {
                            <b>await</b> <span class="r3 r">containerClient</span>.<a href="/Azure.Storage.Blobs/A.html#78a1f68312f5203b" class="i method">GetPropertiesAsync</a>();
                            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r4 rd" class="r4 r">blobName</span> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>();
                            <a href="/Azure.Storage.Blobs/A.html#ab2a0e921078c272" class="k">var</a> <span id="r5 rd" class="r5 r">blobClient</span> = <span class="r3 r">containerClient</span>.<a href="/Azure.Storage.Blobs/A.html#9b1458a6a968c4e1" class="i method">GetAppendBlobClient</a>(<span class="r4 r">blobName</span>);
                            <b>await</b> <span class="r5 r">blobClient</span>.<a href="/Azure.Storage.Blobs/A.html#515fedd76dafac5e" class="i method">CreateIfNotExistsAsync</a>();
                            <b>await</b> <span class="r5 r">blobClient</span>.<a href="/Azure.Storage.Blobs/A.html#f0505a8f6a46fa3e" class="i method">GetPropertiesAsync</a>();
 
                            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="k">var</a> <span id="r6 rd" class="r6 r">userDelegationKey</span> = <b>await</b> <span class="r1 r">serviceClient</span>.<a href="/Azure.Storage.Blobs/A.html#0e8108c060ec84fc" class="i method">GetUserDelegationKeyAsync</a>(<span class="r7 r">startsOn</span>: <b>null</b>, <span class="r8 r">expiresOn</span>: <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>.<a href="@0@mscorlib/A.html#04abe0cac293ebd0" class="i property">UtcNow</a>.<a href="@0@mscorlib/A.html#f349aa0ae92c3ec6" class="i method">AddHours</a>(1));
                            <a href="/Azure.Storage.Blobs/A.html#494fcdf61457bd9e" class="k">var</a> <span id="r9 rd" class="r9 r">sasBuilder</span> = <b>new</b> <a href="/Azure.Storage.Blobs/A.html#0fa8cbdfa7613015" class="t constructor">BlobSasBuilder</a>(<a href="/Azure.Storage.Blobs/A.html#5722417b7d1ec193" class="t t">BlobSasPermissions</a>.<a href="/Azure.Storage.Blobs/A.html#796b36cb23a40798" class="i field">All</a>, <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>.<a href="@0@mscorlib/A.html#04abe0cac293ebd0" class="i property">UtcNow</a>.<a href="@0@mscorlib/A.html#f349aa0ae92c3ec6" class="i method">AddHours</a>(1))
                            {
                                <a href="/Azure.Storage.Blobs/A.html#ce07251198338797" class="i property">BlobContainerName</a> = <span class="r2 r">containerName</span>,
                                <a href="/Azure.Storage.Blobs/A.html#5faddb946ddd32e7" class="i property">BlobName</a> = <span class="r4 r">blobName</span>,
                            };
                            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r10 rd" class="r10 r">sas</span> = <span class="r9 r">sasBuilder</span>.<a href="/Azure.Storage.Blobs/A.html#dbb27de69fa640c0" class="i method">ToSasQueryParameters</a>(<span class="r6 r">userDelegationKey</span>.<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>, <span class="r1 r">serviceClient</span>.<a href="/Azure.Storage.Blobs/A.html#c986470f7b7901c4" class="i property">AccountName</a>).<a href="/Azure.Storage.Blobs/A.html#ea915fd6ac1b7fb0" class="i method">ToString</a>();
                            <b>await</b> <b>new</b> <a href="/Azure.Storage.Blobs/A.html#44b3c9631ee3d43a" class="t constructor">BlobBaseClient</a>(<span class="r5 r">blobClient</span>.<a href="/Azure.Storage.Blobs/A.html#ae31d23a19240d50" class="i property">Uri</a>, <b>new</b> <a href="/Azure.Core/A.html#7c49a23f7592174a" class="t constructor">AzureSasCredential</a>(<span class="r10 r">sas</span>)).<a href="/Azure.Storage.Blobs/A.html#f0505a8f6a46fa3e" class="i method">GetPropertiesAsync</a>();
                        }
                        <b>finally</b>
                        {
                            <b>await</b> <span class="r3 r">containerClient</span>.<a href="/Azure.Storage.Blobs/A.html#a1e9093d91c6ec6c" class="i method">DeleteIfExistsAsync</a>();
                        }
                    }
 
                    <span class="c">// Check hierarchical account.</span>
                    {
                        <a href="/Azure.Storage.Files.DataLake/A.html#72a3781650abbd16" class="t t">DataLakeServiceClient</a> <span id="r11 rd" class="r11 r">serviceClient</span> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#0b3a9ea26feac612" class="t constructor">DataLakeServiceClient</a>(
                          <b>new</b> <a href="@0@System/A.html#9e1bb2fef0d1159b" class="t constructor">Uri</a>(<a href="Shared/TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="Shared/TestConfigurations.cs.html#c214e3ec17dfa9fe" class="i property">DefaultTargetHierarchicalNamespaceTenant</a>.<a href="Shared/TenantConfiguration.cs.html#9c094343c57a64fb" class="i property">BlobServiceEndpoint</a>),
                          <a href="Shared/StorageTestEnvironment.cs.html#e89f059c129e2230" class="i method">GetOAuthCredential</a>(<a href="Shared/TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="Shared/TestConfigurations.cs.html#c214e3ec17dfa9fe" class="i property">DefaultTargetHierarchicalNamespaceTenant</a>));
                        <b>await</b> <span class="r11 r">serviceClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#5f23ec5d0b85405f" class="i method">GetPropertiesAsync</a>();
                        <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r12 rd" class="r12 r">fileSystemName</span> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>();
                        <a href="/Azure.Storage.Files.DataLake/A.html#ea909608102ce2f0" class="k">var</a> <span id="r13 rd" class="r13 r">fileSystemClient</span> = <span class="r11 r">serviceClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#fe8c42550dcee374" class="i method">GetFileSystemClient</a>(<span class="r12 r">fileSystemName</span>);
                        <b>await</b> <span class="r13 r">fileSystemClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#46acb5cadf05f4ac" class="i method">CreateIfNotExistsAsync</a>();
                        <b>try</b>
                        {
                            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r14 rd" class="r14 r">directoryName</span> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>();
                            <a href="/Azure.Storage.Files.DataLake/A.html#5ca4c2baa105c16a" class="k">var</a> <span id="r15 rd" class="r15 r">directoryClient</span> = <span class="r13 r">fileSystemClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#01112d50758befe8" class="i method">GetDirectoryClient</a>(<span class="r14 r">directoryName</span>);
                            <b>await</b> <span class="r15 r">directoryClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#328dcb4ea9fa87b3" class="i method">CreateIfNotExistsAsync</a>();
                            <b>await</b> <span class="r15 r">directoryClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#d9219fbccddafa13" class="i method">GetPropertiesAsync</a>();
                            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r16 rd" class="r16 r">fileName</span> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>();
                            <a href="/Azure.Storage.Files.DataLake/A.html#665e22cb3cbbd974" class="k">var</a> <span id="r17 rd" class="r17 r">fileClient</span> = <span class="r15 r">directoryClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#e35445cd207ea1c2" class="i method">GetFileClient</a>(<span class="r16 r">fileName</span>);
                            <b>await</b> <span class="r17 r">fileClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#5ca5a5fedbe0d091" class="i method">CreateIfNotExistsAsync</a>();
                            <b>await</b> <span class="r17 r">fileClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#85a0d65d66101285" class="i method">GetPropertiesAsync</a>();
                            <span class="c">// call some APIs that talk to DFS endoint as well.</span>
                            <b>await</b> <span class="r17 r">fileClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#68bcf00d796c7550" class="i method">AppendAsync</a>(<b>new</b> <a href="@0@mscorlib/A.html#f92fa270fda9a82b" class="t constructor">MemoryStream</a>(<b>new</b> <b>byte</b>[] { 1 }), 0);
                            <b>await</b> <span class="r17 r">fileClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#0d9da533c160f919" class="i method">GetAccessControlAsync</a>();
 
                            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="k">var</a> <span id="r18 rd" class="r18 r">userDelegationKey</span> = <b>await</b> <span class="r11 r">serviceClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#4e27d0eb774df58f" class="i method">GetUserDelegationKeyAsync</a>(<span class="r19 r">startsOn</span>: <b>null</b>, <span class="r20 r">expiresOn</span>: <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>.<a href="@0@mscorlib/A.html#04abe0cac293ebd0" class="i property">UtcNow</a>.<a href="@0@mscorlib/A.html#f349aa0ae92c3ec6" class="i method">AddHours</a>(1));
                            <a href="/Azure.Storage.Files.DataLake/A.html#35f26eb8f6a47796" class="k">var</a> <span id="r21 rd" class="r21 r">sasBuilder</span> = <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#24b5bdb5bf4c4547" class="t constructor">DataLakeSasBuilder</a>(<a href="/Azure.Storage.Files.DataLake/A.html#363ea56c8724558f" class="t t">DataLakeSasPermissions</a>.<a href="/Azure.Storage.Files.DataLake/A.html#bb10a1c3cb41a729" class="i field">All</a>, <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>.<a href="@0@mscorlib/A.html#04abe0cac293ebd0" class="i property">UtcNow</a>.<a href="@0@mscorlib/A.html#f349aa0ae92c3ec6" class="i method">AddHours</a>(1))
                            {
                                <a href="/Azure.Storage.Files.DataLake/A.html#bae459f1dd597372" class="i property">FileSystemName</a> = <span class="r12 r">fileSystemName</span>,
                                <a href="/Azure.Storage.Files.DataLake/A.html#d48175253ac48e21" class="i property">Path</a> = <span class="r17 r">fileClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#28125719efb508b6" class="i property">Path</a>,
                            };
                            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r22 rd" class="r22 r">sas</span> = <span class="r21 r">sasBuilder</span>.<a href="/Azure.Storage.Files.DataLake/A.html#4f2f0281ab0eeaf1" class="i method">ToSasQueryParameters</a>(<span class="r18 r">userDelegationKey</span>.<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>, <span class="r11 r">serviceClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#a8b030aff2b0d6f0" class="i property">AccountName</a>).<a href="/Azure.Storage.Files.DataLake/A.html#29e5c06034e2cbb3" class="i method">ToString</a>();
                            <b>await</b> <b>new</b> <a href="/Azure.Storage.Files.DataLake/A.html#91a46b4432f3d6d6" class="t constructor">DataLakeFileClient</a>(<span class="r17 r">fileClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#ddf7026d6dc2b8eb" class="i property">Uri</a>, <b>new</b> <a href="/Azure.Core/A.html#7c49a23f7592174a" class="t constructor">AzureSasCredential</a>(<span class="r22 r">sas</span>)).<a href="/Azure.Storage.Files.DataLake/A.html#85a0d65d66101285" class="i method">GetPropertiesAsync</a>();
                        }
                        <b>finally</b>
                        {
                            <b>await</b> <span class="r13 r">fileSystemClient</span>.<a href="/Azure.Storage.Files.DataLake/A.html#807b4e0f715f64a5" class="i method">DeleteIfExistsAsync</a>();
                        }
                    }
                }
            }
            <b>catch</b> (<a href="/Azure.Core/A.html#253c51f73f5cd67d" class="t t">RequestFailedException</a> <span id="r23 rd" class="r23 r">e</span>) <b>when</b> (<span class="r23 r">e</span>.<a href="/Azure.Core/A.html#2e95914e1b156417" class="i property">Status</a> == 403 &amp;&amp; <span class="r23 r">e</span>.<a href="/Azure.Core/A.html#0f8d8760e8ec9460" class="i property">ErrorCode</a> == <span class="s">&quot;AuthorizationPermissionMismatch&quot;</span>)
            {
                <span class="t t">TestContext</span>.<span class="i field">Error</span>.<a href="@0@mscorlib/A.html#5238cceaebfeaa74" class="i method">WriteLine</a>(<span class="s">$&quot;</span><span class="s">Datalake Probing OAuth - not ready </span>{<a href="@0@System/A.html#f8b2e604d6f1fe04" class="t t">Process</a>.<a href="@0@System/A.html#a106ad886675f6a5" class="i method">GetCurrentProcess</a>().<a href="@0@System/A.html#e7bdad2b99a54a87" class="i property">Id</a>}<span class="s">&quot;</span>);
                <b>return</b> <b>false</b>;
            }
            <span class="t t">TestContext</span>.<span class="i field">Error</span>.<a href="@0@mscorlib/A.html#5238cceaebfeaa74" class="i method">WriteLine</a>(<span class="s">$&quot;</span><span class="s">Datalake Probing OAuth - ready </span>{<a href="@0@System/A.html#f8b2e604d6f1fe04" class="t t">Process</a>.<a href="@0@System/A.html#a106ad886675f6a5" class="i method">GetCurrentProcess</a>().<a href="@0@System/A.html#e7bdad2b99a54a87" class="i property">Id</a>}<span class="s">&quot;</span>);
            <b>return</b> <b>true</b>;
        }
    }
}
</pre></td></tr></table></div></body></html>
