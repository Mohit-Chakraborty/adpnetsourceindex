<!DOCTYPE html>
<html><head><title>SendReceiveTest.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(161);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Sample.Stress/SendReceiveTest.cs" target="_top">SendReceiveTest.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Sample.Stress" target="_top">Azure.Sample.Stress.csproj</a> (Azure.Sample.Stress)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Test</span>.<span class="i n">Stress</span>;
<b>using</b> <span class="i">CommandLine</span>;
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i">Channels</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Sample</span>.<span class="i n">Stress</span>
{
    <b>public class</b> <a id="50ba0ccbe688ed0b" href="R/50ba0ccbe688ed0b.html" target="n" data-glyph="0,0" class="t t">SendReceiveTest</a> : <a href="/Azure.Test.Stress/A.html#5cea36aa9f318a99" class="t t">StressTest</a>&lt;<a href="#50ba0ccbe688ed0b" class="t t">SendReceiveTest</a>.<a href="#f71fc5c9e9bb1f27" class="t t">SendReceiveOptions</a>, <a href="#50ba0ccbe688ed0b" class="t t">SendReceiveTest</a>.<a href="#19813352c73b1023" class="t t">SendReceiveMetrics</a>&gt;
    {
        <b>private</b> <span class="i">Channel</span>&lt;<b>int</b>&gt; <a id="71b04d213436151a" href="R/71b04d213436151a.html" target="n" data-glyph="46,1" class="i field">_channel</a> = <span class="i">Channel</span>.<span class="i">CreateUnbounded</span>&lt;<b>int</b>&gt;();
 
        <b>public</b> <a id="a651fe62079867c8" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">SendReceiveTest</a>(<a href="#f71fc5c9e9bb1f27" class="t t">SendReceiveOptions</a> <span id="r0 rd" class="r0 r">options</span>, <a href="#19813352c73b1023" class="t t">SendReceiveMetrics</a> <span id="r1 rd" class="r1 r">metrics</span>) : <a href="/Azure.Test.Stress/A.html#ecdff7cfdbe359a8" class="k">base</a>(<span class="r0 r">options</span>, <span class="r1 r">metrics</span>)
        {
        }
 
        <b>public override async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="11235d58c746a256" href="R/11235d58c746a256.html" target="n" data-glyph="72,1" class="i method">RunAsync</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r2 rd" class="r2 r">cancellationToken</span>)
        {
            <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="k">var</a> <span id="r3 rd" class="r3 r">senderTask</span> = <a href="#1226782acfb50063" class="i method">Sender</a>(<span class="r2 r">cancellationToken</span>);
 
            <a href="@0@mscorlib/A.html#130a9536ac96b392" class="k">var</a> <span id="r4 rd" class="r4 r">receiverCts</span> = <b>new</b> <a href="@0@mscorlib/A.html#0fd973cb6741d972" class="t constructor">CancellationTokenSource</a>();
 
            <b>var</b> <span id="r5 rd" class="r5 r">receiverTasks</span> = <b>new</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>[<a href="/Azure.Test.Stress/A.html#7d7561751cfa835a" class="i property">Options</a>.<a href="#8ac3a1878b240ad1" class="i property">Receivers</a>];
            <b>for</b> (<a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r6 rd" class="r6 r">i</span> = 0; <span class="r6 r">i</span> &lt; <a href="/Azure.Test.Stress/A.html#7d7561751cfa835a" class="i property">Options</a>.<a href="#8ac3a1878b240ad1" class="i property">Receivers</a>; <span class="r6 r">i</span>++)
            {
                <span class="r5 r">receiverTasks</span>[<span class="r6 r">i</span>] = <a href="#6357828199b63e49" class="i method">Receiver</a>(<span class="r4 r">receiverCts</span>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>);
            }
 
            <b>try</b>
            {
                <b>await</b> <span class="r3 r">senderTask</span>;
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r7 rd" class="r7 r">e</span>) <b>when</b> (<a href="/Azure.Test.Stress/A.html#c3a987f8611f7ffb" class="i method">ContainsOperationCanceledException</a>(<span class="r7 r">e</span>))
            {
            }
 
            <span class="c">// Block until all messages have been received</span>
            <b>await</b> <a href="/Azure.Test.Stress/A.html#19f0511f0507eca0" class="i method">DelayUntil</a>(() =&gt; <a href="/Azure.Test.Stress/A.html#a9a726089bfd0ead" class="i property">Metrics</a>.<a href="#42de76f8b74f8460" class="i property">Unprocessed</a> == 0);
 
            <span class="r4 r">receiverCts</span>.<a href="@0@mscorlib/A.html#93c25ccd0946470f" class="i method">Cancel</a>();
 
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#929d1a3d98d89901" class="i method">WhenAll</a>(<span class="r5 r">receiverTasks</span>);
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="1226782acfb50063" href="R/1226782acfb50063.html" target="n" data-glyph="76,1" class="i method">Sender</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r8 rd" class="r8 r">cancellationToken</span>)
        {
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r9 rd" class="r9 r">index</span> = 0;
            <b>while</b> (!<span class="r8 r">cancellationToken</span>.<a href="@0@mscorlib/A.html#f32abbe8e2f1f6c1" class="i property">IsCancellationRequested</a>)
            {
                <b>try</b>
                {
                    <b>await</b> <a href="#3f0380adefff5300" class="i method">Send</a>(<span class="r9 r">index</span>, <span class="r8 r">cancellationToken</span>);
                    <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#d379c1b796ccdc6f" class="i method">Increment</a>(<b>ref</b> <a href="/Azure.Test.Stress/A.html#a9a726089bfd0ead" class="i property">Metrics</a>.<a href="#8075b2bc6384ac49" class="i field">Sends</a>);
                    <span class="r9 r">index</span>++;
                }
                <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r10 rd" class="r10 r">e</span>) <b>when</b> (!<a href="/Azure.Test.Stress/A.html#c3a987f8611f7ffb" class="i method">ContainsOperationCanceledException</a>(<span class="r10 r">e</span>))
                {
                    <a href="/Azure.Test.Stress/A.html#a9a726089bfd0ead" class="i property">Metrics</a>.<a href="/Azure.Test.Stress/A.html#5dfdebe1f6a54964" class="i property">Exceptions</a>.<a href="@0@mscorlib/A.html#62bea3a8141ed2a9" class="i method">Enqueue</a>(<span class="r10 r">e</span>);
                }
            }
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="6357828199b63e49" href="R/6357828199b63e49.html" target="n" data-glyph="76,1" class="i method">Receiver</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r11 rd" class="r11 r">cancellationToken</span>)
        {
            <b>while</b> (!<span class="r11 r">cancellationToken</span>.<a href="@0@mscorlib/A.html#f32abbe8e2f1f6c1" class="i property">IsCancellationRequested</a>)
            {
                <b>try</b>
                {
                    <b>await</b> <a href="#e44473386931d39a" class="i method">Receive</a>(<span class="r11 r">cancellationToken</span>);
                    <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#d379c1b796ccdc6f" class="i method">Increment</a>(<b>ref</b> <a href="/Azure.Test.Stress/A.html#a9a726089bfd0ead" class="i property">Metrics</a>.<a href="#e041e0373d6582f3" class="i field">Receives</a>);
                }
                <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r12 rd" class="r12 r">e</span>) <b>when</b> (!<a href="/Azure.Test.Stress/A.html#c3a987f8611f7ffb" class="i method">ContainsOperationCanceledException</a>(<span class="r12 r">e</span>))
                {
                    <a href="/Azure.Test.Stress/A.html#a9a726089bfd0ead" class="i property">Metrics</a>.<a href="/Azure.Test.Stress/A.html#5dfdebe1f6a54964" class="i property">Exceptions</a>.<a href="@0@mscorlib/A.html#62bea3a8141ed2a9" class="i method">Enqueue</a>(<span class="r12 r">e</span>);
                }
            }
        }
 
        <span class="c">// Simulates method in SDK</span>
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="3f0380adefff5300" href="R/3f0380adefff5300.html" target="n" data-glyph="76,1" class="i method">Send</a>(<b>int</b> <span id="r13 rd" class="r13 r">index</span>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r14 rd" class="r14 r">cancellationToken</span>)
        {
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#b070ae859dd3f7b7" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#668d91d771bce54b" class="i method">FromMilliseconds</a>(<a href="/Azure.Test.Stress/A.html#c0cb85d57f21d400" class="i property">Random</a>.<a href="@0@mscorlib/A.html#ddd1e9e09c70bab5" class="i method">Next</a>(0, <a href="/Azure.Test.Stress/A.html#7d7561751cfa835a" class="i property">Options</a>.<a href="#bf69db67c9caabd0" class="i property">MaxSendDelayMs</a>)), <span class="r14 r">cancellationToken</span>);
            <a href="@0@mscorlib/A.html#1a65cbdb09544ba1" class="k">var</a> <span id="r15 rd" class="r15 r">d</span> = <a href="/Azure.Test.Stress/A.html#c0cb85d57f21d400" class="i property">Random</a>.<a href="@0@mscorlib/A.html#c467f2953a8d2207" class="i method">NextDouble</a>();
            <b>if</b> (<span class="r15 r">d</span> &lt; <a href="/Azure.Test.Stress/A.html#7d7561751cfa835a" class="i property">Options</a>.<a href="#4019f31c4182f6db" class="i property">SendExceptionRate</a>)
            {
                <b>throw</b> <b>new</b> <a href="#2bbcaddd6f6042e7" class="t constructor">SendException</a>(<span class="r15 r">d</span>.<a href="@0@mscorlib/A.html#de581d5a1a6b2a1a" class="i method">ToString</a>());
            }
            <b>else</b>
            {
                <b>await</b> <a href="#71b04d213436151a" class="i field">_channel</a>.<span class="i">Writer</span>.<span class="i">WriteAsync</span>(<span class="r13 r">index</span>, <span class="r14 r">cancellationToken</span>);
            }
        }
 
        <span class="c">// Simulates method in SDK</span>
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="e44473386931d39a" href="R/e44473386931d39a.html" target="n" data-glyph="76,1" class="i method">Receive</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r16 rd" class="r16 r">cancellationToken</span>)
        {
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#b070ae859dd3f7b7" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#668d91d771bce54b" class="i method">FromMilliseconds</a>(<a href="/Azure.Test.Stress/A.html#c0cb85d57f21d400" class="i property">Random</a>.<a href="@0@mscorlib/A.html#ddd1e9e09c70bab5" class="i method">Next</a>(0, <a href="/Azure.Test.Stress/A.html#7d7561751cfa835a" class="i property">Options</a>.<a href="#0f155d2c3ae58b59" class="i property">MaxReceiveDelayMs</a>)), <span class="r16 r">cancellationToken</span>);
            <a href="@0@mscorlib/A.html#1a65cbdb09544ba1" class="k">var</a> <span id="r17 rd" class="r17 r">d</span> = <a href="/Azure.Test.Stress/A.html#c0cb85d57f21d400" class="i property">Random</a>.<a href="@0@mscorlib/A.html#c467f2953a8d2207" class="i method">NextDouble</a>();
            <b>if</b> (<span class="r17 r">d</span> &lt; <a href="/Azure.Test.Stress/A.html#7d7561751cfa835a" class="i property">Options</a>.<a href="#98b25f78e31e7e29" class="i property">ReceiveExceptionRate</a>)
            {
                <b>throw</b> <b>new</b> <a href="#49b46e05180938ff" class="t constructor">ReceiveException</a>(<span class="r17 r">d</span>.<a href="@0@mscorlib/A.html#de581d5a1a6b2a1a" class="i method">ToString</a>());
            }
            <b>else</b>
            {
                <b>await</b> <a href="#71b04d213436151a" class="i field">_channel</a>.<span class="i">Reader</span>.<span class="i">ReadAsync</span>(<span class="r16 r">cancellationToken</span>);
            }
        }
 
        <b>public class</b> <a id="f71fc5c9e9bb1f27" href="R/f71fc5c9e9bb1f27.html" target="n" data-glyph="0,1" class="t t"><span id="00f681490851c02c">SendReceiveOptions</span></a> : <a href="/Azure.Test.Stress/A.html#c5ef4635f249933f" class="t t">StressOptions</a>
        {
            [<span class="i">Option</span>(<span class="s">&quot;maxSendDelayMs&quot;</span>, <span class="i">Default</span> = 50, <span class="i">HelpText</span> = <span class="s">&quot;Max send delay (in milliseconds)&quot;</span>)]
            <b>public int</b> <a id="bf69db67c9caabd0" href="R/bf69db67c9caabd0.html" target="n" data-glyph="102,2" class="i property">MaxSendDelayMs</a> { <b>get</b>; <b>set</b>; }
 
            [<span class="i">Option</span>(<span class="s">&quot;maxReceiveDelayMs&quot;</span>, <span class="i">Default</span> = 200, <span class="i">HelpText</span> = <span class="s">&quot;Max send delay (in milliseconds)&quot;</span>)]
            <b>public int</b> <a id="0f155d2c3ae58b59" href="R/0f155d2c3ae58b59.html" target="n" data-glyph="102,2" class="i property">MaxReceiveDelayMs</a> { <b>get</b>; <b>set</b>; }
 
            [<span class="i">Option</span>(<span class="s">&quot;receivers&quot;</span>, <span class="i">Default</span> = 3, <span class="i">HelpText</span> = <span class="s">&quot;Number of receivers&quot;</span>)]
            <b>public int</b> <a id="8ac3a1878b240ad1" href="R/8ac3a1878b240ad1.html" target="n" data-glyph="102,2" class="i property">Receivers</a> { <b>get</b>; <b>set</b>; }
 
            [<span class="i">Option</span>(<span class="s">&quot;sendExceptionRate&quot;</span>, <span class="i">Default</span> = .01, <span class="i">HelpText</span> = <span class="s">&quot;Rate of send exceptions&quot;</span>)]
            <b>public double</b> <a id="4019f31c4182f6db" href="R/4019f31c4182f6db.html" target="n" data-glyph="102,2" class="i property">SendExceptionRate</a> { <b>get</b>; <b>set</b>; }
 
            [<span class="i">Option</span>(<span class="s">&quot;receiveExceptionRate&quot;</span>, <span class="i">Default</span> = .02, <span class="i">HelpText</span> = <span class="s">&quot;Rate of receive exceptions&quot;</span>)]
            <b>public double</b> <a id="98b25f78e31e7e29" href="R/98b25f78e31e7e29.html" target="n" data-glyph="102,2" class="i property">ReceiveExceptionRate</a> { <b>get</b>; <b>set</b>; }
        }
 
        <b>public class</b> <a id="19813352c73b1023" href="R/19813352c73b1023.html" target="n" data-glyph="0,1" class="t t"><span id="2ed95c666fb2d600">SendReceiveMetrics</span></a> : <a href="/Azure.Test.Stress/A.html#c4bbf6e1c18460d0" class="t t">StressMetrics</a>
        {
            <b>public long</b> <a id="8075b2bc6384ac49" href="R/8075b2bc6384ac49.html" target="n" data-glyph="42,2" class="i field">Sends</a>;
            <b>public long</b> <a id="e041e0373d6582f3" href="R/e041e0373d6582f3.html" target="n" data-glyph="42,2" class="i field">Receives</a>;
            <b>public long</b> <a id="42de76f8b74f8460" href="R/42de76f8b74f8460.html" target="n" data-glyph="102,2" class="i property">Unprocessed</a> =&gt; (<a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#22e58906412927dc" class="i method">Read</a>(<b>ref</b> <a href="#8075b2bc6384ac49" class="i field">Sends</a>) - <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#22e58906412927dc" class="i method">Read</a>(<b>ref</b> <a href="#e041e0373d6582f3" class="i field">Receives</a>));
        }
 
        <b>public class</b> <a id="1f17da5323cb63cb" href="R/1f17da5323cb63cb.html" target="n" data-glyph="0,1" class="t t">SendException</a> : <a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a>
        {
            <b>public</b> <a id="df4909ef1c3aeacf" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="t constructor">SendException</a>()
            {
            }
 
            <b>public</b> <a id="2bbcaddd6f6042e7" href="R/2bbcaddd6f6042e7.html" target="n" data-glyph="72,2" class="t constructor">SendException</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r18 rd" class="r18 r">message</span>) : <a href="@0@mscorlib/A.html#df2d82d91ca29e40" class="k">base</a>(<span class="r18 r">message</span>)
            {
            }
        }
 
        <b>public class</b> <a id="c16474b5b4a4bbb4" href="R/c16474b5b4a4bbb4.html" target="n" data-glyph="0,1" class="t t">ReceiveException</a> : <a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a>
        {
            <b>public</b> <a id="232a2fc29a438485" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="t constructor">ReceiveException</a>()
            {
            }
 
            <b>public</b> <a id="49b46e05180938ff" href="R/49b46e05180938ff.html" target="n" data-glyph="72,2" class="t constructor">ReceiveException</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r19 rd" class="r19 r">message</span>) : <a href="@0@mscorlib/A.html#df2d82d91ca29e40" class="k">base</a>(<span class="r19 r">message</span>)
            {
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
