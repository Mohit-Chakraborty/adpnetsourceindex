<!DOCTYPE html>
<html><head><title>PartitionedUploader.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(617);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Storage.Blobs/Shared/PartitionedUploader.cs" target="_top">Shared\PartitionedUploader.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Storage.Blobs" target="_top">Azure.Storage.Blobs.csproj</a> (Azure.Storage.Blobs)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Buffers</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Runtime</span>.<span class="i n">CompilerServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">Pipeline</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Shared</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>
{
    <b>internal class</b> <a id="35188e7929b6e459" href="../R/35188e7929b6e459.html" target="n" data-glyph="2,0" class="t t">PartitionedUploader</a>&lt;<span id="r0 rd t" class="r0 r t">TServiceSpecificArgs</span>, <span id="r1 rd t" class="r1 r t">TCompleteUploadReturn</span>&gt;
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Definitions
        <span class="c">// delegte for getting a partition from a stream based on the selected data management stragegy</span>
        <b>private delegate</b> <a href="@1@netstandard/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="SlicedStream.cs.html#1fc0b6cc1bb6f1c0" class="t t">SlicedStream</a>&gt; <a id="9a224007722ed447" href="../R/9a224007722ed447.html" target="n" data-glyph="16,1" class="t t"><span id="83a2bc0d0f2a5d42">GetNextStreamPartition</span></a>(
            <a href="@1@netstandard/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r2 rd" class="r2 r">stream</span>,
            <b>long</b> <span id="r3 rd" class="r3 r">minCount</span>,
            <b>long</b> <span id="r4 rd" class="r4 r">maxCount</span>,
            <b>long</b> <span id="r5 rd" class="r5 r">absolutePosition</span>,
            <b>bool</b> <span id="r6 rd" class="r6 r">async</span>,
            <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r7 rd" class="r7 r">cancellationToken</span>);
 
        <span class="c">// injected behaviors for services to use partitioned uploads</span>
        <b>public delegate</b> <a href="Core/DiagnosticScope.cs.html#df3fc9a09421f052" class="t t">DiagnosticScope</a> <a id="4ce658f9a84d575e" href="../R/4ce658f9a84d575e.html" target="n" data-glyph="12,1" class="t t"><span id="38a0659a214eb453">CreateScope</span></a>(<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r8 rd" class="r8 r">operationName</span>);
        <b>public delegate</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="dff3b0c61680f4d6" href="../R/dff3b0c61680f4d6.html" target="n" data-glyph="12,1" class="t t"><span id="b345dde70d2f4e7f">InitializeDestinationInternal</span></a>(<span class="r0 r t">TServiceSpecificArgs</span> <span id="r9 rd" class="r9 r">args</span>, <b>bool</b> <span id="r10 rd" class="r10 r">async</span>, <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r11 rd" class="r11 r">cancellationToken</span>);
        <b>public delegate</b> <a href="@1@netstandard/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<span class="r1 r t">TCompleteUploadReturn</span>&gt;&gt; <a id="b7e995a557269fdb" href="../R/b7e995a557269fdb.html" target="n" data-glyph="12,1" class="t t"><span id="eab38f314071eef8">SingleUploadInternal</span></a>(
            <a href="@1@netstandard/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r12 rd" class="r12 r">contentStream</span>,
            <span class="r0 r t">TServiceSpecificArgs</span> <span id="r13 rd" class="r13 r">args</span>,
            <a href="@1@netstandard/A.html#766adb700a2972f5" class="t t">IProgress</a>&lt;<b>long</b>&gt; <span id="r14 rd" class="r14 r">progressHandler</span>,
            <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r15 rd" class="r15 r">operationName</span>,
            <b>bool</b> <span id="r16 rd" class="r16 r">async</span>,
            <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r17 rd" class="r17 r">cancellationToken</span>);
        <b>public delegate</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="7777e9ac9e6301b1" href="../R/7777e9ac9e6301b1.html" target="n" data-glyph="12,1" class="t t"><span id="3da6c62aa29e03cc">UploadPartitionInternal</span></a>(<a href="@1@netstandard/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r18 rd" class="r18 r">contentStream</span>,
            <b>long</b> <span id="r19 rd" class="r19 r">offset</span>,
            <span class="r0 r t">TServiceSpecificArgs</span> <span id="r20 rd" class="r20 r">args</span>,
            <a href="@1@netstandard/A.html#766adb700a2972f5" class="t t">IProgress</a>&lt;<b>long</b>&gt; <span id="r21 rd" class="r21 r">progressHandler</span>,
            <b>bool</b> <span id="r22 rd" class="r22 r">async</span>,
            <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r23 rd" class="r23 r">cancellationToken</span>);
        <b>public delegate</b> <a href="@1@netstandard/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<span class="r1 r t">TCompleteUploadReturn</span>&gt;&gt; <a id="679cb1812b21f9f3" href="../R/679cb1812b21f9f3.html" target="n" data-glyph="12,1" class="t t"><span id="03c3b2779869d98c">CommitPartitionedUploadInternal</span></a>(
            <a href="@1@netstandard/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;(<b>long</b> <a id="7596d059e93fa348" href="../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Offset</a>, <b>long</b> <a id="d0275a2862852c8c" href="../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Size</a>)&gt; <span id="r24 rd" class="r24 r">partitions</span>,
            <span class="r0 r t">TServiceSpecificArgs</span> <span id="r25 rd" class="r25 r">args</span>,
            <b>bool</b> <span id="r26 rd" class="r26 r">async</span>,
            <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r27 rd" class="r27 r">cancellationToken</span>);
 
        <b>public struct</b> <a id="3273ff8f0aa703f8" href="../R/3273ff8f0aa703f8.html" target="n" data-glyph="108,1" class="t t"><span id="c91b8cbc92f1e39c">Behaviors</span></a>
        {
            <b>public</b> <a href="#dff3b0c61680f4d6" class="t t">InitializeDestinationInternal</a> <a id="d10cba71ebff246c" href="../R/d10cba71ebff246c.html" target="n" data-glyph="102,2" class="i property">InitializeDestination</a> { <b>get</b>; <b>set</b>; }
            <b>public</b> <a href="#b7e995a557269fdb" class="t t">SingleUploadInternal</a> <a id="28dd0a698af99d90" href="../R/28dd0a698af99d90.html" target="n" data-glyph="102,2" class="i property">SingleUpload</a> { <b>get</b>; <b>set</b>; }
            <b>public</b> <a href="#7777e9ac9e6301b1" class="t t">UploadPartitionInternal</a> <a id="54aec9c67c227fd5" href="../R/54aec9c67c227fd5.html" target="n" data-glyph="102,2" class="i property">UploadPartition</a> { <b>get</b>; <b>set</b>; }
            <b>public</b> <a href="#679cb1812b21f9f3" class="t t">CommitPartitionedUploadInternal</a> <a id="531b4acf5b3a8701" href="../R/531b4acf5b3a8701.html" target="n" data-glyph="102,2" class="i property">CommitPartitionedUpload</a> { <b>get</b>; <b>set</b>; }
            <b>public</b> <a href="#4ce658f9a84d575e" class="t t">CreateScope</a> <a id="ce9c31b040db5986" href="../R/ce9c31b040db5986.html" target="n" data-glyph="102,2" class="i property">Scope</a> { <b>get</b>; <b>set</b>; }
        }
 
        <b>public static readonly</b> <a href="#dff3b0c61680f4d6" class="t t">InitializeDestinationInternal</a> <a id="048ae36d05022391" href="../R/048ae36d05022391.html" target="n" data-glyph="42,1" class="i field">InitializeNoOp</a> = (<span id="r28 rd" class="r28 r">args</span>, <span id="r29 rd" class="r29 r">async</span>, <span id="r30 rd" class="r30 r">cancellationToken</span>) =&gt; <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@netstandard/A.html#66f1c3e3e272f591" class="i property">CompletedTask</a>;
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <b>private readonly</b> <a href="#dff3b0c61680f4d6" class="t t">InitializeDestinationInternal</a> <a id="0c6e2c963656b075" href="../R/0c6e2c963656b075.html" target="n" data-glyph="46,1" class="i field">_initializeDestinationInternal</a>;
        <b>private readonly</b> <a href="#b7e995a557269fdb" class="t t">SingleUploadInternal</a> <a id="f9fbe0a1964cd8db" href="../R/f9fbe0a1964cd8db.html" target="n" data-glyph="46,1" class="i field">_singleUploadInternal</a>;
        <b>private readonly</b> <a href="#7777e9ac9e6301b1" class="t t">UploadPartitionInternal</a> <a id="acccb25f11c52c22" href="../R/acccb25f11c52c22.html" target="n" data-glyph="46,1" class="i field">_uploadPartitionInternal</a>;
        <b>private readonly</b> <a href="#679cb1812b21f9f3" class="t t">CommitPartitionedUploadInternal</a> <a id="bfb4e24263051f79" href="../R/bfb4e24263051f79.html" target="n" data-glyph="46,1" class="i field">_commitPartitionedUploadInternal</a>;
        <b>private readonly</b> <a href="#4ce658f9a84d575e" class="t t">CreateScope</a> <a id="3611a85492f3820e" href="../R/3611a85492f3820e.html" target="n" data-glyph="46,1" class="i field">_createScope</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of simultaneous workers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly int</b> <a id="366771157c8e9336" href="../R/366771157c8e9336.html" target="n" data-glyph="46,1" class="i field">_maxWorkerCount</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A pool of memory we use to partition the stream into blocks.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="t t">ArrayPool</span>&lt;<b>byte</b>&gt; <a id="3c65cb84ba44b09c" href="../R/3c65cb84ba44b09c.html" target="n" data-glyph="46,1" class="i field">_arrayPool</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The size we use to determine whether to upload as a one-off request or</span>
        <span class="c">///</span><span class="c"> a partitioned/committed upload</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly long</b> <a id="6281aea296facdbc" href="../R/6281aea296facdbc.html" target="n" data-glyph="46,1" class="i field">_singleUploadThreshold</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The size of each staged block.  If null, we&#39;ll change between 4MB</span>
        <span class="c">///</span><span class="c"> and 8MB depending on the size of the content.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly long</b>? <a id="1d2976fc216cb22f" href="../R/1d2976fc216cb22f.html" target="n" data-glyph="46,1" class="i field">_blockSize</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The name of the calling operaiton.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly string</b> <a id="5a054b880a5bd036" href="../R/5a054b880a5bd036.html" target="n" data-glyph="46,1" class="i field">_operationName</a>;
 
        <b>public</b> <a id="050ccd3d4aead9ec" href="../R/050ccd3d4aead9ec.html" target="n" data-glyph="72,1" class="t constructor">PartitionedUploader</a>(
            <a href="#3273ff8f0aa703f8" class="t t">Behaviors</a> <span id="r31 rd" class="r31 r">behaviors</span>,
            <a href="/Azure.Storage.Common/A.html#5906346a5aaad27d" class="t t">StorageTransferOptions</a> <span id="r32 rd" class="r32 r">transferOptions</span>,
            <span class="t t">ArrayPool</span>&lt;<b>byte</b>&gt; <span id="r33 rd" class="r33 r">arrayPool</span> = <b>null</b>,
            <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r34 rd" class="r34 r">operationName</span> = <b>null</b>)
        {
            <span class="c">// initialize isn&#39;t required for all services and can use a no-op; rest are required</span>
            <a href="#0c6e2c963656b075" class="i field">_initializeDestinationInternal</a> = <span class="r31 r">behaviors</span>.<a href="#d10cba71ebff246c" class="i property">InitializeDestination</a> ?? <a href="#048ae36d05022391" class="i field">InitializeNoOp</a>;
            <a href="#f9fbe0a1964cd8db" class="i field">_singleUploadInternal</a> = <span class="r31 r">behaviors</span>.<a href="#28dd0a698af99d90" class="i property">SingleUpload</a>
                ?? <b>throw</b> <a href="../P/5ed86f0799b000b6.html#5ed86f0799b000b6" class="t t">Errors</a>.<a href="Errors.cs.html#f89d11b4740d5634" class="i method">ArgumentNull</a>(<b>nameof</b>(<span class="r31 r">behaviors</span>.<a href="#28dd0a698af99d90" class="i property">SingleUpload</a>));
            <a href="#acccb25f11c52c22" class="i field">_uploadPartitionInternal</a> = <span class="r31 r">behaviors</span>.<a href="#54aec9c67c227fd5" class="i property">UploadPartition</a>
                ?? <b>throw</b> <a href="../P/5ed86f0799b000b6.html#5ed86f0799b000b6" class="t t">Errors</a>.<a href="Errors.cs.html#f89d11b4740d5634" class="i method">ArgumentNull</a>(<b>nameof</b>(<span class="r31 r">behaviors</span>.<a href="#54aec9c67c227fd5" class="i property">UploadPartition</a>));
            <a href="#bfb4e24263051f79" class="i field">_commitPartitionedUploadInternal</a> = <span class="r31 r">behaviors</span>.<a href="#531b4acf5b3a8701" class="i property">CommitPartitionedUpload</a>
                ?? <b>throw</b> <a href="../P/5ed86f0799b000b6.html#5ed86f0799b000b6" class="t t">Errors</a>.<a href="Errors.cs.html#f89d11b4740d5634" class="i method">ArgumentNull</a>(<b>nameof</b>(<span class="r31 r">behaviors</span>.<a href="#531b4acf5b3a8701" class="i property">CommitPartitionedUpload</a>));
            <a href="#3611a85492f3820e" class="i field">_createScope</a> = <span class="r31 r">behaviors</span>.<a href="#ce9c31b040db5986" class="i property">Scope</a>
                ?? <b>throw</b> <a href="../P/5ed86f0799b000b6.html#5ed86f0799b000b6" class="t t">Errors</a>.<a href="Errors.cs.html#f89d11b4740d5634" class="i method">ArgumentNull</a>(<b>nameof</b>(<span class="r31 r">behaviors</span>.<a href="#ce9c31b040db5986" class="i property">Scope</a>));
 
            <a href="#3c65cb84ba44b09c" class="i field">_arrayPool</a> = <span class="r33 r">arrayPool</span> ?? <span class="t t">ArrayPool</span>&lt;<b>byte</b>&gt;.<span class="i property">Shared</span>;
 
            <span class="c">// Set _maxWorkerCount</span>
            <b>if</b> (<span class="r32 r">transferOptions</span>.<a href="/Azure.Storage.Common/A.html#9af76c13ed7d72aa" class="i property">MaximumConcurrency</a>.<a href="@1@netstandard/A.html#7bbe60e33e857298" class="i property">HasValue</a>
                &amp;&amp; <span class="r32 r">transferOptions</span>.<a href="/Azure.Storage.Common/A.html#9af76c13ed7d72aa" class="i property">MaximumConcurrency</a> &gt; 0)
            {
                <a href="#366771157c8e9336" class="i field">_maxWorkerCount</a> = <span class="r32 r">transferOptions</span>.<a href="/Azure.Storage.Common/A.html#9af76c13ed7d72aa" class="i property">MaximumConcurrency</a>.<a href="@1@netstandard/A.html#7b38d1fa76071c95" class="i property">Value</a>;
            }
            <b>else</b>
            {
                <a href="#366771157c8e9336" class="i field">_maxWorkerCount</a> = <a href="Constants.cs.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="Constants.cs.html#663c716e897587aa" class="t t">Blob</a>.<a href="Constants.cs.html#0b32ff7568a2e81c" class="t t">Block</a>.<a href="Constants.cs.html#fd3101ae87a984f7" class="i field">DefaultConcurrentTransfersCount</a>;
            }
 
            <span class="c">// Set _singleUploadThreshold</span>
            <b>if</b> (<span class="r32 r">transferOptions</span>.<a href="/Azure.Storage.Common/A.html#ef29544986a37504" class="i property">InitialTransferSize</a>.<a href="@1@netstandard/A.html#7bbe60e33e857298" class="i property">HasValue</a>
                &amp;&amp; <span class="r32 r">transferOptions</span>.<a href="/Azure.Storage.Common/A.html#ef29544986a37504" class="i property">InitialTransferSize</a>.<a href="@1@netstandard/A.html#7b38d1fa76071c95" class="i property">Value</a> &gt; 0)
            {
                <a href="#6281aea296facdbc" class="i field">_singleUploadThreshold</a> = <a href="@1@netstandard/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@1@netstandard/A.html#8cf0c6d1543ff08d" class="i method">Min</a>(<span class="r32 r">transferOptions</span>.<a href="/Azure.Storage.Common/A.html#ef29544986a37504" class="i property">InitialTransferSize</a>.<a href="@1@netstandard/A.html#7b38d1fa76071c95" class="i property">Value</a>, <a href="Constants.cs.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="Constants.cs.html#663c716e897587aa" class="t t">Blob</a>.<a href="Constants.cs.html#0b32ff7568a2e81c" class="t t">Block</a>.<a href="Constants.cs.html#810b8c1fdb24549f" class="i field">MaxUploadBytes</a>);
            }
            <b>else</b>
            {
                <a href="#6281aea296facdbc" class="i field">_singleUploadThreshold</a> = <a href="Constants.cs.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="Constants.cs.html#663c716e897587aa" class="t t">Blob</a>.<a href="Constants.cs.html#0b32ff7568a2e81c" class="t t">Block</a>.<a href="Constants.cs.html#0f80291bd703e3fc" class="i field">Pre_2019_12_12_MaxUploadBytes</a>;
            }
 
            <span class="c">// Set _blockSize</span>
            <b>if</b> (<span class="r32 r">transferOptions</span>.<a href="/Azure.Storage.Common/A.html#e6cf33ac88512449" class="i property">MaximumTransferSize</a>.<a href="@1@netstandard/A.html#7bbe60e33e857298" class="i property">HasValue</a>
                &amp;&amp; <span class="r32 r">transferOptions</span>.<a href="/Azure.Storage.Common/A.html#e6cf33ac88512449" class="i property">MaximumTransferSize</a> &gt; 0)
            {
                <a href="#1d2976fc216cb22f" class="i field">_blockSize</a> = <a href="@1@netstandard/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@1@netstandard/A.html#8cf0c6d1543ff08d" class="i method">Min</a>(
                    <a href="Constants.cs.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="Constants.cs.html#663c716e897587aa" class="t t">Blob</a>.<a href="Constants.cs.html#0b32ff7568a2e81c" class="t t">Block</a>.<a href="Constants.cs.html#6d24e5d886ef5cc1" class="i field">MaxStageBytes</a>,
                    <span class="r32 r">transferOptions</span>.<a href="/Azure.Storage.Common/A.html#e6cf33ac88512449" class="i property">MaximumTransferSize</a>.<a href="@1@netstandard/A.html#7b38d1fa76071c95" class="i property">Value</a>);
            }
 
            <a href="#5a054b880a5bd036" class="i field">_operationName</a> = <span class="r34 r">operationName</span>;
        }
 
        <b>public async</b> <a href="@1@netstandard/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<span class="r1 r t">TCompleteUploadReturn</span>&gt;&gt; <a id="7f3add0cb0a7bb12" href="../R/7f3add0cb0a7bb12.html" target="n" data-glyph="72,1" class="i method">UploadInternal</a>(
            <a href="@1@netstandard/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r35 rd" class="r35 r">content</span>,
            <span class="r0 r t">TServiceSpecificArgs</span> <span id="r36 rd" class="r36 r">args</span>,
            <a href="@1@netstandard/A.html#766adb700a2972f5" class="t t">IProgress</a>&lt;<b>long</b>&gt; <span id="r37 rd" class="r37 r">progressHandler</span>,
            <b>bool</b> <span id="r38 rd" class="r38 r">async</span>,
            <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r39 rd" class="r39 r">cancellationToken</span> = <b>default</b>)
        {
            <b>if</b> (<span class="r35 r">content</span> == <b>default</b>)
            {
                <b>throw</b> <a href="../P/5ed86f0799b000b6.html#5ed86f0799b000b6" class="t t">Errors</a>.<a href="Errors.cs.html#f89d11b4740d5634" class="i method">ArgumentNull</a>(<b>nameof</b>(<span class="r35 r">content</span>));
            }
 
            <a href="../P/5ed86f0799b000b6.html#5ed86f0799b000b6" class="t t">Errors</a>.<a href="Errors.cs.html#8f22db7061d45b0c" class="i method">VerifyStreamPosition</a>(<span class="r35 r">content</span>, <b>nameof</b>(<span class="r35 r">content</span>));
 
            <b>if</b> (<span class="r35 r">content</span>.<a href="@1@netstandard/A.html#73e4413d240b4cee" class="i property">CanSeek</a> &amp;&amp; <span class="r35 r">content</span>.<a href="@1@netstandard/A.html#35112b2a53fb536a" class="i property">Position</a> &gt; 0)
            {
                <span class="r35 r">content</span> = <a href="WindowStream.cs.html#e1bfa7ea983ac09f" class="t t">WindowStream</a>.<a href="WindowStream.cs.html#aaf7b565a92957bb" class="i method">GetWindow</a>(<span class="r35 r">content</span>, <span class="r35 r">content</span>.<a href="@1@netstandard/A.html#48b7e39cfd844dc5" class="i property">Length</a> - <span class="r35 r">content</span>.<a href="@1@netstandard/A.html#35112b2a53fb536a" class="i property">Position</a>, <span class="r35 r">content</span>.<a href="@1@netstandard/A.html#35112b2a53fb536a" class="i property">Position</a>);
            }
 
            <b>await</b> <a href="#0c6e2c963656b075" class="i field">_initializeDestinationInternal</a>(<span class="r36 r">args</span>, <span class="r38 r">async</span>, <span class="r39 r">cancellationToken</span>).<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
 
            <span class="c">// some strategies are unavailable if we don&#39;t know the stream length, and some can still work</span>
            <span class="c">// we may introduce separately provided stream lengths in the future for unseekable streams with</span>
            <span class="c">// an expected length</span>
            <b>long</b>? <span id="r40 rd" class="r40 r">length</span> = <a href="#23fcaf0217fa9968" class="i method">GetLengthOrDefault</a>(<span class="r35 r">content</span>);
 
            <span class="c">// If we know the length and it&#39;s small enough</span>
            <b>if</b> (<span class="r40 r">length</span> &lt; <a href="#6281aea296facdbc" class="i field">_singleUploadThreshold</a>)
            {
                <span class="c">// Upload it in a single request</span>
                <b>return</b> <b>await</b> <a href="#f9fbe0a1964cd8db" class="i field">_singleUploadInternal</a>(
                    <span class="r35 r">content</span>,
                    <span class="r36 r">args</span>,
                    <span class="r37 r">progressHandler</span>,
                    <a href="#5a054b880a5bd036" class="i field">_operationName</a>,
                    <span class="r38 r">async</span>,
                    <span class="r39 r">cancellationToken</span>)
                    .<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
 
            <span class="c">// If the caller provided an explicit block size, we&#39;ll use it.</span>
            <span class="c">// Otherwise we&#39;ll adjust dynamically based on the size of the</span>
            <span class="c">// content.</span>
            <b>long</b> <span id="r41 rd" class="r41 r">blockSize</span> = <a href="#1d2976fc216cb22f" class="i field">_blockSize</a> != <b>null</b>
                ? <a href="#1d2976fc216cb22f" class="i field">_blockSize</a>.<a href="@1@netstandard/A.html#7b38d1fa76071c95" class="i property">Value</a>
                : <span class="r40 r">length</span> &lt; <a href="Constants.cs.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="Constants.cs.html#5f87a0acff697a47" class="i field">LargeUploadThreshold</a> ?
                    <a href="Constants.cs.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="Constants.cs.html#e1c825b9d22231d0" class="i field">DefaultBufferSize</a> :
                    <a href="Constants.cs.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="Constants.cs.html#13b157bc4108eeac" class="i field">LargeBufferSize</a>;
 
            <span class="c">// Otherwise stage individual blocks</span>
 
            <span class="c">/* We only support parallel upload in an async context to avoid issues in our overall sync story.
             * We&#39;re branching on both async and max worker count, where 3 combinations lead to
             * UploadInSequenceInternal and 1 combination leads to UploadInParallelAsync. We are guaranteed
             * to be in an async context when we call UploadInParallelAsync, even though the analyzer can&#39;t
             * detext this, and we properly pass in the async context in the else case when we haven&#39;t
             * explicitly checked.
             */</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">AZC0109</span> <span class="c">// Misuse of &#39;async&#39; parameter.</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">AZC0110</span> <span class="c">// DO NOT use await keyword in possibly synchronous scope.</span>
            <b>if</b> (<span class="r38 r">async</span> &amp;&amp; <a href="#366771157c8e9336" class="i field">_maxWorkerCount</a> &gt; 1)
            {
                <b>return</b> <b>await</b> <a href="#52deed702656ba70" class="i method">UploadInParallelAsync</a>(
                    <span class="r35 r">content</span>,
                    <span class="r40 r">length</span>,
                    <span class="r41 r">blockSize</span>,
                    <span class="r36 r">args</span>,
                    <span class="r37 r">progressHandler</span>,
                    <span class="r39 r">cancellationToken</span>)
                    .<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> <span class="i">AZC0110</span> <span class="c">// DO NOT use await keyword in possibly synchronous scope.</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> <span class="i">AZC0109</span> <span class="c">// Misuse of &#39;async&#39; parameter.</span>
            <b>else</b>
            {
                <b>return</b> <b>await</b> <a href="#c0ec8c1d7df13d43" class="i method">UploadInSequenceInternal</a>(
                    <span class="r35 r">content</span>,
                    <span class="r40 r">length</span>,
                    <span class="r41 r">blockSize</span>,
                    <span class="r36 r">args</span>,
                    <span class="r37 r">progressHandler</span>,
                    <span class="r42 r">async</span>: <span class="r38 r">async</span>,
                    <span class="r39 r">cancellationToken</span>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
        }
 
        <b>private async</b> <a href="@1@netstandard/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<span class="r1 r t">TCompleteUploadReturn</span>&gt;&gt; <a id="c0ec8c1d7df13d43" href="../R/c0ec8c1d7df13d43.html" target="n" data-glyph="76,1" class="i method">UploadInSequenceInternal</a>(
            <a href="@1@netstandard/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r43 rd" class="r43 r">content</span>,
            <b>long</b>? <span id="r44 rd" class="r44 r">contentLength</span>,
            <b>long</b> <span id="r45 rd" class="r45 r">partitionSize</span>,
            <span class="r0 r t">TServiceSpecificArgs</span> <span id="r46 rd" class="r46 r">args</span>,
            <a href="@1@netstandard/A.html#766adb700a2972f5" class="t t">IProgress</a>&lt;<b>long</b>&gt; <span id="r47 rd" class="r47 r">progressHandler</span>,
            <b>bool</b> <span id="r42 rd" class="r42 r">async</span>,
            <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r48 rd" class="r48 r">cancellationToken</span>)
        {
            <span class="c">// Wrap the staging and commit calls in an Upload span for</span>
            <span class="c">// distributed tracing</span>
            <a href="Core/DiagnosticScope.cs.html#df3fc9a09421f052" class="t t">DiagnosticScope</a> <span id="r49 rd" class="r49 r">scope</span> = <a href="#3611a85492f3820e" class="i field">_createScope</a>(<a href="#5a054b880a5bd036" class="i field">_operationName</a>);
            <b>try</b>
            {
                <span class="r49 r">scope</span>.<a href="Core/DiagnosticScope.cs.html#687cad18b595ff81" class="i method">Start</a>();
 
                <span class="c">// Wrap progressHandler in a AggregatingProgressIncrementer to prevent</span>
                <span class="c">// progress from being reset with each stage blob operation.</span>
                <b>if</b> (<span class="r47 r">progressHandler</span> != <b>null</b>)
                {
                    <span class="r47 r">progressHandler</span> = <b>new</b> <a href="AggregatingProgressIncrementer.cs.html#63dd31008ce64717" class="t constructor">AggregatingProgressIncrementer</a>(<span class="r47 r">progressHandler</span>);
                }
 
                <span class="c">// The list tracking blocks IDs we&#39;re going to commit</span>
                <a href="@1@netstandard/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;(<b>long</b> <span class="i field">Offset</span>, <b>long</b> <span class="i field">Size</span>)&gt; <span id="r50 rd" class="r50 r">partitions</span> = <b>new</b> <a href="@1@netstandard/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;(<b>long</b>, <b>long</b>)&gt;();
 
                <span class="c">// Streamed partitions only work if we can seek the stream; we need retries on individual uploads.</span>
                <a href="#9a224007722ed447" class="t t">GetNextStreamPartition</a> <span id="r51 rd" class="r51 r">partitionGetter</span> = <span class="r43 r">content</span>.<a href="@1@netstandard/A.html#73e4413d240b4cee" class="i property">CanSeek</a>
                            ? (<a href="#9a224007722ed447" class="t t">GetNextStreamPartition</a>)<a href="#59064d216c0d0a84" class="i method">GetStreamedPartitionInternal</a>
                            : <span class="c">/*   redundant cast   */</span><a href="#dcc123bac101aa71" class="i method">GetBufferedPartitionInternal</a>;
 
                <span class="c">// Partition the stream into individual blocks and stage them</span>
                <b>if</b> (<span class="r42 r">async</span>)
                {
                    <b>await</b> <b>foreach</b> (<a href="SlicedStream.cs.html#1fc0b6cc1bb6f1c0" class="t t">SlicedStream</a> <span id="r52 rd" class="r52 r">block</span> <b>in</b> <a href="#c50b11ef4141c97d" class="i method">GetPartitionsAsync</a>(
                        <span class="r43 r">content</span>,
                        <span class="r44 r">contentLength</span>,
                        <span class="r45 r">partitionSize</span>,
                        <span class="r51 r">partitionGetter</span>,
                        <span class="r53 r">async</span>: <b>true</b>,
                        <span class="r48 r">cancellationToken</span>).<span class="i method">ConfigureAwait</span>(<b>false</b>))
                    {
                        <b>await</b> <a href="#63b8e73681b2ed85" class="i method">StagePartitionAndDisposeInternal</a>(
                            <span class="r52 r">block</span>,
                            <span class="r52 r">block</span>.<a href="SlicedStream.cs.html#9ca1215e4320e754" class="i property">AbsolutePosition</a>,
                            <span class="r46 r">args</span>,
                            <span class="r47 r">progressHandler</span>,
                            <span class="r54 r">async</span>: <b>true</b>,
                            <span class="r48 r">cancellationToken</span>).<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                        <span class="r50 r">partitions</span>.<a href="@1@netstandard/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="r52 r">block</span>.<a href="SlicedStream.cs.html#9ca1215e4320e754" class="i property">AbsolutePosition</a>, <span class="r52 r">block</span>.<a href="@1@netstandard/A.html#48b7e39cfd844dc5" class="i property">Length</a>));
                    }
                }
                <b>else</b>
                {
                    <b>foreach</b> (<a href="SlicedStream.cs.html#1fc0b6cc1bb6f1c0" class="t t">SlicedStream</a> <span id="r55 rd" class="r55 r">block</span> <b>in</b> <a href="#c50b11ef4141c97d" class="i method">GetPartitionsAsync</a>(
                        <span class="r43 r">content</span>,
                        <span class="r44 r">contentLength</span>,
                        <span class="r45 r">partitionSize</span>,
                        <span class="r51 r">partitionGetter</span>,
                        <span class="r53 r">async</span>: <b>false</b>,
                        <span class="r48 r">cancellationToken</span>).<a href="Core/TaskExtensions.cs.html#fdb4f8a2058b2107" class="i method">EnsureSyncEnumerable</a>())
                    {
                        <a href="#63b8e73681b2ed85" class="i method">StagePartitionAndDisposeInternal</a>(
                            <span class="r55 r">block</span>,
                            <span class="r55 r">block</span>.<a href="SlicedStream.cs.html#9ca1215e4320e754" class="i property">AbsolutePosition</a>,
                            <span class="r46 r">args</span>,
                            <span class="r47 r">progressHandler</span>,
                            <span class="r54 r">async</span>: <b>false</b>,
                            <span class="r48 r">cancellationToken</span>).<a href="Core/TaskExtensions.cs.html#9a35b0afd931dc48" class="i method">EnsureCompleted</a>();
 
                        <span class="r50 r">partitions</span>.<a href="@1@netstandard/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="r55 r">block</span>.<a href="SlicedStream.cs.html#9ca1215e4320e754" class="i property">AbsolutePosition</a>, <span class="r55 r">block</span>.<a href="@1@netstandard/A.html#48b7e39cfd844dc5" class="i property">Length</a>));
                    }
                }
 
                <span class="c">// Commit the block list after everything has been staged to</span>
                <span class="c">// complete the upload</span>
                <b>return</b> <b>await</b> <a href="#bfb4e24263051f79" class="i field">_commitPartitionedUploadInternal</a>(
                    <span class="r50 r">partitions</span>,
                    <span class="r46 r">args</span>,
                    <span class="r42 r">async</span>,
                    <span class="r48 r">cancellationToken</span>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
            <b>catch</b> (<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r56 rd" class="r56 r">ex</span>)
            {
                <span class="r49 r">scope</span>.<a href="Core/DiagnosticScope.cs.html#3d6de3437ae4c961" class="i method">Failed</a>(<span class="r56 r">ex</span>);
                <b>throw</b>;
            }
            <b>finally</b>
            {
                <span class="r49 r">scope</span>.<a href="Core/DiagnosticScope.cs.html#499ad84145f6c35d" class="i method">Dispose</a>();
            }
        }
 
        <b>private async</b> <a href="@1@netstandard/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<span class="r1 r t">TCompleteUploadReturn</span>&gt;&gt; <a id="52deed702656ba70" href="../R/52deed702656ba70.html" target="n" data-glyph="76,1" class="i method">UploadInParallelAsync</a>(
            <a href="@1@netstandard/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r57 rd" class="r57 r">content</span>,
            <b>long</b>? <span id="r58 rd" class="r58 r">contentLength</span>,
            <b>long</b> <span id="r59 rd" class="r59 r">blockSize</span>,
            <span class="r0 r t">TServiceSpecificArgs</span> <span id="r60 rd" class="r60 r">args</span>,
            <a href="@1@netstandard/A.html#766adb700a2972f5" class="t t">IProgress</a>&lt;<b>long</b>&gt; <span id="r61 rd" class="r61 r">progressHandler</span>,
            <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r62 rd" class="r62 r">cancellationToken</span>)
        {
            <span class="c">// Wrap the staging and commit calls in an Upload span for</span>
            <span class="c">// distributed tracing</span>
            <a href="Core/DiagnosticScope.cs.html#df3fc9a09421f052" class="t t">DiagnosticScope</a> <span id="r63 rd" class="r63 r">scope</span> = <a href="#3611a85492f3820e" class="i field">_createScope</a>(<a href="#5a054b880a5bd036" class="i field">_operationName</a>);
            <b>try</b>
            {
                <span class="r63 r">scope</span>.<a href="Core/DiagnosticScope.cs.html#687cad18b595ff81" class="i method">Start</a>();
 
                <span class="c">// Wrap progressHandler in a AggregatingProgressIncrementer to prevent</span>
                <span class="c">// progress from being reset with each stage blob operation.</span>
                <b>if</b> (<span class="r61 r">progressHandler</span> != <b>null</b>)
                {
                    <span class="r61 r">progressHandler</span> = <b>new</b> <a href="AggregatingProgressIncrementer.cs.html#63dd31008ce64717" class="t constructor">AggregatingProgressIncrementer</a>(<span class="r61 r">progressHandler</span>);
                }
 
                <span class="c">// The list tracking blocks IDs we&#39;re going to commit</span>
                <a href="@1@netstandard/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;(<b>long</b> <span class="i field">Offset</span>, <b>long</b> <span class="i field">Size</span>)&gt; <span id="r64 rd" class="r64 r">partitions</span> = <b>new</b> <a href="@1@netstandard/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;(<b>long</b>, <b>long</b>)&gt;();
 
                <span class="c">// A list of tasks that are currently executing which will</span>
                <span class="c">// always be smaller than _maxWorkerCount</span>
                <a href="@1@netstandard/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r65 rd" class="r65 r">runningTasks</span> = <b>new</b> <a href="@1@netstandard/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt;();
 
                <span class="c">// Partition the stream into individual blocks</span>
                <b>await</b> <b>foreach</b> (<a href="SlicedStream.cs.html#1fc0b6cc1bb6f1c0" class="t t">SlicedStream</a> <span id="r66 rd" class="r66 r">block</span> <b>in</b> <a href="#c50b11ef4141c97d" class="i method">GetPartitionsAsync</a>(
                    <span class="r57 r">content</span>,
                    <span class="r58 r">contentLength</span>,
                    <span class="r59 r">blockSize</span>,
                    <a href="#dcc123bac101aa71" class="i method">GetBufferedPartitionInternal</a>, <span class="c">// we always buffer for upload in parallel from stream</span>
                    <span class="r53 r">async</span>: <b>true</b>,
                    <span class="r62 r">cancellationToken</span>).<span class="i method">ConfigureAwait</span>(<b>false</b>))
                {
                    <span class="c">/* We need to do this first! Length is calculated on the fly based on stream buffer
                     * contents; We need to record the partition data first before consuming the stream
                     * asynchronously. */</span>
                    <span class="r64 r">partitions</span>.<a href="@1@netstandard/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="r66 r">block</span>.<a href="SlicedStream.cs.html#9ca1215e4320e754" class="i property">AbsolutePosition</a>, <span class="r66 r">block</span>.<a href="@1@netstandard/A.html#48b7e39cfd844dc5" class="i property">Length</a>));
 
                    <span class="c">// Start staging the next block (but don&#39;t await the Task!)</span>
                    <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <span id="r67 rd" class="r67 r">task</span> = <a href="#63b8e73681b2ed85" class="i method">StagePartitionAndDisposeInternal</a>(
                        <span class="r66 r">block</span>,
                        <span class="r66 r">block</span>.<a href="SlicedStream.cs.html#9ca1215e4320e754" class="i property">AbsolutePosition</a>,
                        <span class="r60 r">args</span>,
                        <span class="r61 r">progressHandler</span>,
                        <span class="r54 r">async</span>: <b>true</b>,
                        <span class="r62 r">cancellationToken</span>);
 
                    <span class="c">// Add the block to our task and commit lists</span>
                    <span class="r65 r">runningTasks</span>.<a href="@1@netstandard/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r67 r">task</span>);
 
                    <span class="c">// If we run out of workers</span>
                    <b>if</b> (<span class="r65 r">runningTasks</span>.<a href="@1@netstandard/A.html#78a69d857716bc68" class="i property">Count</a> &gt;= <a href="#366771157c8e9336" class="i field">_maxWorkerCount</a>)
                    {
                        <span class="c">// Wait for at least one of them to finish</span>
                        <b>await</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@netstandard/A.html#f16158c687359df9" class="i method">WhenAny</a>(<span class="r65 r">runningTasks</span>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                        <span class="c">// Clear any completed blocks from the task list</span>
                        <b>for</b> (<b>int</b> <span id="r68 rd" class="r68 r">i</span> = 0; <span class="r68 r">i</span> &lt; <span class="r65 r">runningTasks</span>.<a href="@1@netstandard/A.html#78a69d857716bc68" class="i property">Count</a>; <span class="r68 r">i</span>++)
                        {
                            <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <span id="r69 rd" class="r69 r">runningTask</span> = <span class="r65 r">runningTasks</span><a href="@1@netstandard/A.html#0c65bec4d3fac21e">[</a><span class="r68 r">i</span>];
                            <b>if</b> (!<span class="r69 r">runningTask</span>.<a href="@1@netstandard/A.html#8d8a16ab86bf7a8a" class="i property">IsCompleted</a>)
                            {
                                <b>continue</b>;
                            }
 
                            <b>await</b> <span class="r69 r">runningTask</span>.<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                            <span class="r65 r">runningTasks</span>.<a href="@1@netstandard/A.html#3d46113cc199059a" class="i method">RemoveAt</a>(<span class="r68 r">i</span>);
                            <span class="r68 r">i</span>--;
                        }
                    }
                }
 
                <span class="c">// Wait for all the remaining blocks to finish staging and then</span>
                <span class="c">// commit the block list to complete the upload</span>
                <b>await</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@netstandard/A.html#69351c6da968e5d1" class="i method">WhenAll</a>(<span class="r65 r">runningTasks</span>).<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                <span class="c">// Calling internal method for easier mocking in PartitionedUploaderTests</span>
                <b>return</b> <b>await</b> <a href="#bfb4e24263051f79" class="i field">_commitPartitionedUploadInternal</a>(
                    <span class="r64 r">partitions</span>,
                    <span class="r60 r">args</span>,
                    <span class="r26 r">async</span>: <b>true</b>,
                    <span class="r62 r">cancellationToken</span>)
                    .<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
            <b>catch</b> (<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r70 rd" class="r70 r">ex</span>)
            {
                <span class="r63 r">scope</span>.<a href="Core/DiagnosticScope.cs.html#3d6de3437ae4c961" class="i method">Failed</a>(<span class="r70 r">ex</span>);
                <b>throw</b>;
            }
            <b>finally</b>
            {
                <span class="r63 r">scope</span>.<a href="Core/DiagnosticScope.cs.html#499ad84145f6c35d" class="i method">Dispose</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wraps both the async method and dispose call in one task.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private async</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="63b8e73681b2ed85" href="../R/63b8e73681b2ed85.html" target="n" data-glyph="76,1" class="i method">StagePartitionAndDisposeInternal</a>(
            <a href="SlicedStream.cs.html#1fc0b6cc1bb6f1c0" class="t t">SlicedStream</a> <span id="r71 rd" class="r71 r">partition</span>,
            <b>long</b> <span id="r72 rd" class="r72 r">offset</span>,
            <span class="r0 r t">TServiceSpecificArgs</span> <span id="r73 rd" class="r73 r">args</span>,
            <a href="@1@netstandard/A.html#766adb700a2972f5" class="t t">IProgress</a>&lt;<b>long</b>&gt; <span id="r74 rd" class="r74 r">progressHandler</span>,
            <b>bool</b> <span id="r54 rd" class="r54 r">async</span>,
            <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r75 rd" class="r75 r">cancellationToken</span>)
        {
            <b>try</b>
            {
                <b>await</b> <a href="#acccb25f11c52c22" class="i field">_uploadPartitionInternal</a>(
                    <span class="r71 r">partition</span>,
                    <span class="r72 r">offset</span>,
                    <span class="r73 r">args</span>,
                    <span class="r74 r">progressHandler</span>,
                    <span class="r54 r">async</span>,
                    <span class="r75 r">cancellationToken</span>)
                    .<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
            <b>finally</b>
            {
                <span class="c">// Return the memory used by the block to our ArrayPool as soon</span>
                <span class="c">// as we&#39;ve staged it</span>
                <span class="r71 r">partition</span>.<a href="@1@netstandard/A.html#f1b4285950a82354" class="i method">Dispose</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Some streams will throw if you try to access their length so we wrap</span>
        <span class="c">///</span><span class="c"> the check in a TryGet helper.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static long</b>? <a id="23fcaf0217fa9968" href="../R/23fcaf0217fa9968.html" target="n" data-glyph="76,1" class="i method">GetLengthOrDefault</a>(<a href="@1@netstandard/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r76 rd" class="r76 r">content</span>)
        {
            <b>try</b>
            {
                <b>if</b> (<span class="r76 r">content</span>.<a href="@1@netstandard/A.html#73e4413d240b4cee" class="i property">CanSeek</a>)
                {
                    <b>return</b> <span class="r76 r">content</span>.<a href="@1@netstandard/A.html#48b7e39cfd844dc5" class="i property">Length</a> - <span class="r76 r">content</span>.<a href="@1@netstandard/A.html#35112b2a53fb536a" class="i property">Position</a>;
                }
            }
            <b>catch</b> (<a href="@1@netstandard/A.html#99ee329017558ada" class="t t">NotSupportedException</a>)
            {
            }
            <b>return</b> <b>default</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Stream Splitters
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Partition a stream into a series of blocks buffered as needed by an array pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static async</b> <span class="t t">IAsyncEnumerable</span>&lt;<a href="SlicedStream.cs.html#1fc0b6cc1bb6f1c0" class="t t">SlicedStream</a>&gt; <a id="c50b11ef4141c97d" href="../R/c50b11ef4141c97d.html" target="n" data-glyph="76,1" class="i method">GetPartitionsAsync</a>(
            <a href="@1@netstandard/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r77 rd" class="r77 r">stream</span>,
            <b>long</b>? <span id="r78 rd" class="r78 r">streamLength</span>,
            <b>long</b> <span id="r79 rd" class="r79 r">blockSize</span>,
            <a href="#9a224007722ed447" class="t t">GetNextStreamPartition</a> <span id="r80 rd" class="r80 r">getNextPartition</span>,
            <b>bool</b> <span id="r53 rd" class="r53 r">async</span>,
            [<span class="t constructor">EnumeratorCancellation</span>] <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r81 rd" class="r81 r">cancellationToken</span>)
        {
            <span class="c">// The minimum amount of data we&#39;ll accept from a stream before</span>
            <span class="c">// splitting another block. Code that sets `blockSize` will always</span>
            <span class="c">// set it to a positive number. Min() only avoids edge case where</span>
            <span class="c">// user sets their block size to 1.</span>
            <b>long</b> <span id="r82 rd" class="r82 r">acceptableBlockSize</span> = <a href="@1@netstandard/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@1@netstandard/A.html#c0288bbe62da07cb" class="i method">Max</a>(1, <span class="r79 r">blockSize</span> / 2);
 
            <span class="c">// if we know the data length, assert boundaries before spending resources uploading beyond service capabilities</span>
            <b>if</b> (<span class="r78 r">streamLength</span>.<a href="@1@netstandard/A.html#7bbe60e33e857298" class="i property">HasValue</a>)
            {
                <span class="c">// service has a max block count per blob</span>
                <span class="c">// block size * block count limit = max data length to upload</span>
                <span class="c">// if stream length is longer than specified max block size allows, can&#39;t upload</span>
                <b>long</b> <span id="r83 rd" class="r83 r">minRequiredBlockSize</span> = (<b>long</b>)<a href="@1@netstandard/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@1@netstandard/A.html#1841a5ce24ed9fb3" class="i method">Ceiling</a>((<b>double</b>)<span class="r78 r">streamLength</span>.<a href="@1@netstandard/A.html#7b38d1fa76071c95" class="i property">Value</a> / <a href="Constants.cs.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="Constants.cs.html#663c716e897587aa" class="t t">Blob</a>.<a href="Constants.cs.html#0b32ff7568a2e81c" class="t t">Block</a>.<a href="Constants.cs.html#59a866828d590d51" class="i field">MaxBlocks</a>);
                <b>if</b> (<span class="r79 r">blockSize</span> &lt; <span class="r83 r">minRequiredBlockSize</span>)
                {
                    <b>throw</b> <a href="../P/5ed86f0799b000b6.html#5ed86f0799b000b6" class="t t">Errors</a>.<a href="Errors.cs.html#434b26205394a689" class="i method">InsufficientStorageTransferOptions</a>(<span class="r78 r">streamLength</span>.<a href="@1@netstandard/A.html#7b38d1fa76071c95" class="i property">Value</a>, <span class="r79 r">blockSize</span>, <span class="r83 r">minRequiredBlockSize</span>);
                }
                <span class="c">// bring min up to our min required by the service</span>
                <span class="r82 r">acceptableBlockSize</span> = <a href="@1@netstandard/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@1@netstandard/A.html#c0288bbe62da07cb" class="i method">Max</a>(<span class="r82 r">acceptableBlockSize</span>, <span class="r83 r">minRequiredBlockSize</span>);
            }
 
            <b>long</b> <span id="r84 rd" class="r84 r">read</span>;
            <b>long</b> <span id="r85 rd" class="r85 r">absolutePosition</span> = 0;
            <b>do</b>
            {
                <a href="SlicedStream.cs.html#1fc0b6cc1bb6f1c0" class="t t">SlicedStream</a> <span id="r86 rd" class="r86 r">partition</span> = <b>await</b> <span class="r80 r">getNextPartition</span>(
                    <span class="r77 r">stream</span>,
                    <span class="r82 r">acceptableBlockSize</span>,
                    <span class="r79 r">blockSize</span>,
                    <span class="r85 r">absolutePosition</span>,
                    <span class="r53 r">async</span>,
                    <span class="r81 r">cancellationToken</span>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
                <span class="r84 r">read</span> = <span class="r86 r">partition</span>.<a href="@1@netstandard/A.html#48b7e39cfd844dc5" class="i property">Length</a>;
                <span class="r85 r">absolutePosition</span> += <span class="r84 r">read</span>;
 
                <span class="c">// If we read anything, turn it into a StreamPartition and</span>
                <span class="c">// return it for staging</span>
                <b>if</b> (<span class="r86 r">partition</span>.<a href="@1@netstandard/A.html#48b7e39cfd844dc5" class="i property">Length</a> != 0)
                {
                    <span class="c">// The StreamParitition is disposable and it&#39;ll be the</span>
                    <span class="c">// user&#39;s responsibility to return the bytes used to our</span>
                    <span class="c">// ArrayPool</span>
                    <b>yield</b> <b>return</b> <span class="r86 r">partition</span>;
                }
 
                <span class="c">// Continue reading blocks until we&#39;ve exhausted the stream</span>
            } <b>while</b> (<span class="r84 r">read</span> != 0);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a partition from the current location of the given stream.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> This partition is buffered and it is safe to get many before using any of them.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r87 r">stream</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Stream to buffer a partition from.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r88 r">minCount</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Minimum amount of data to wait on before finalizing buffer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r89 r">maxCount</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Max amount of data to buffer before cutting off for the next.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r90 r">absolutePosition</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Offset of this stream relative to the large stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r91 r">async</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Whether to buffer this partition asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r92 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cancellation token.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Task containing the buffered stream partition.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private async</b> <a href="@1@netstandard/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="SlicedStream.cs.html#1fc0b6cc1bb6f1c0" class="t t">SlicedStream</a>&gt; <a id="dcc123bac101aa71" href="../R/dcc123bac101aa71.html" target="n" data-glyph="76,1" class="i method">GetBufferedPartitionInternal</a>(
            <a href="@1@netstandard/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r87 rd" class="r87 r">stream</span>,
            <b>long</b> <span id="r88 rd" class="r88 r">minCount</span>,
            <b>long</b> <span id="r89 rd" class="r89 r">maxCount</span>,
            <b>long</b> <span id="r90 rd" class="r90 r">absolutePosition</span>,
            <b>bool</b> <span id="r91 rd" class="r91 r">async</span>,
            <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r92 rd" class="r92 r">cancellationToken</span>)
            =&gt; <b>await</b> <a href="PooledMemoryStream.cs.html#1b57485f6b2784fa" class="t t">PooledMemoryStream</a>.<a href="PooledMemoryStream.cs.html#f61575a4d786e80f" class="i method">BufferStreamPartitionInternal</a>(
                <span class="r87 r">stream</span>,
                <span class="r88 r">minCount</span>,
                <span class="r89 r">maxCount</span>,
                <span class="r90 r">absolutePosition</span>,
                <a href="#3c65cb84ba44b09c" class="i field">_arrayPool</a>,
                <span class="r93 r">maxArrayPoolRentalSize</span>: <b>default</b>,
                <span class="r91 r">async</span>,
                <span class="r92 r">cancellationToken</span>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a partition from the current location of the given stream.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> This partition is a facade over the existing stream, and the</span>
        <span class="c">///</span><span class="c"> previous partition should be consumed before using the next.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r94 r">stream</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Stream to wrap.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r95 r">minCount</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Unused, but part of </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#9a224007722ed447" class="t t">GetNextStreamPartition</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> definition.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r96 r">maxCount</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Length of this facade stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r97 r">absolutePosition</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Offset of this stream relative to the large stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r98 r">async</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Unused, but part of </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#9a224007722ed447" class="t t">GetNextStreamPartition</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> definition.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r99 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Task containing the stream facade.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static</b> <a href="@1@netstandard/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="SlicedStream.cs.html#1fc0b6cc1bb6f1c0" class="t t">SlicedStream</a>&gt; <a id="59064d216c0d0a84" href="../R/59064d216c0d0a84.html" target="n" data-glyph="76,1" class="i method">GetStreamedPartitionInternal</a>(
            <a href="@1@netstandard/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r94 rd" class="r94 r">stream</span>,
            <b>long</b> <span id="r95 rd" class="r95 r">minCount</span>,
            <b>long</b> <span id="r96 rd" class="r96 r">maxCount</span>,
            <b>long</b> <span id="r97 rd" class="r97 r">absolutePosition</span>,
            <b>bool</b> <span id="r98 rd" class="r98 r">async</span>,
            <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r99 rd" class="r99 r">cancellationToken</span>)
            =&gt; <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@netstandard/A.html#11a386e7d7cae64a" class="i method">FromResult</a>((<a href="SlicedStream.cs.html#1fc0b6cc1bb6f1c0" class="t t">SlicedStream</a>)<a href="WindowStream.cs.html#e1bfa7ea983ac09f" class="t t">WindowStream</a>.<a href="WindowStream.cs.html#aaf7b565a92957bb" class="i method">GetWindow</a>(<span class="r94 r">stream</span>, <span class="r96 r">maxCount</span>, <span class="r97 r">absolutePosition</span>));
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
</pre></td></tr></table></div></body></html>
