<!DOCTYPE html>
<html><head><title>Program.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(263);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#ShareLink/Program.cs" target="_top">Program.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#ShareLink" target="_top">ShareLink.csproj</a> (ShareLink)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">Azure</span>.<span class="i">Identity</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Security</span>.<span class="i n">KeyVault</span>.<span class="i">Secrets</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Security</span>.<span class="i n">KeyVault</span>.<span class="i n">Storage</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Security</span>.<span class="i n">KeyVault</span>.<span class="i n">Storage</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">CommandLine</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">CommandLine</span>.<span class="i">Invocation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">CommandLine</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">CommandLine</span>.<span class="i">Parsing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Xml</span>;
 
<b>internal static class</b> <a id="500681445049c26b" href="R/../../0000000000.html" target="n" data-glyph="2,0" class="t t">Program</a>
{
    <b>private static async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>int</b>&gt; <a id="8366499006664b18" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">RunAsync</a>(
        <a href="@1@System.Runtime/A.html#991565dd25f47c90" class="t t">Uri</a> <span id="r0 rd" class="r0 r">vaultUri</span>,
        <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r1 rd" class="r1 r">storageAccountName</span>,
        <b>int</b> <span id="r2 rd" class="r2 r">days</span>,
        <b>bool</b> <span id="r3 rd" class="r3 r">readOnly</span>,
        <span class="i">IConsole</span> <span id="r4 rd" class="r4 r">console</span>)
    {
        <span class="c">// Allow only credentials appropriate for this interactive tool sample.</span>
        <span class="i">DefaultAzureCredential</span> <span id="r5 rd" class="r5 r">credential</span> = <b>new</b> <span class="i">DefaultAzureCredential</span>(
            <b>new</b> <span class="i">DefaultAzureCredentialOptions</span>
            {
                <span class="i">ExcludeEnvironmentCredential</span> = <b>true</b>,
                <span class="i">ExcludeManagedIdentityCredential</span> = <b>true</b>,
            });
 
        <span class="c">// Use the same options for both clients, which allow logging of some other non-PII headers.</span>
        <span class="i">SecretClientOptions</span> <span id="r6 rd" class="r6 r">options</span> = <b>new</b> <span class="i">SecretClientOptions</span>();
 
        <span class="c">// Create the Key Vault-managed Storage client to find the specified managed storage account.</span>
        <a href="P/2a1ee26965681cca.html#2a1ee26965681cca" class="t t">ManagedStorageRestClient</a> <span id="r7 rd" class="r7 r">storageClient</span> = <a href="P/2a1ee26965681cca.html#2a1ee26965681cca" class="t t">ManagedStorageRestClient</a>.<span class="i">Create</span>(<span class="r0 r">vaultUri</span>, <span class="r5 r">credential</span>, <span class="r6 r">options</span>);
 
        <span class="c">// Find the specified manage storage account.</span>
        <a href="P/3e6a65914b8b785a.html#3e6a65914b8b785a" class="t t">StorageAccountItem</a> <span id="r8 rd" class="r8 r">storageAccount</span> = <b>await</b> <a href="#382260bf2313e93b" class="i method">FindStorageAccountAsync</a>(<span class="r7 r">storageClient</span>, <span class="r1 r">storageAccountName</span>);
 
        <b>if</b> (<span class="r8 r">storageAccount</span> <b>is null</b>)
        {
            <span class="r4 r">console</span>.<span class="i">Error</span>.<span class="i">WriteLine</span>(<span class="s">$&quot;</span><span class="s">Error: &#39;</span>{<span class="r1 r">storageAccountName</span>}<span class="s">&#39; is not currently managed by </span>{<span class="r0 r">vaultUri</span>}<span class="s">&quot;</span>);
            <b>return</b> 1;
        }
 
        <span class="c">// Build our SAS template, get an existing SAS definition, or create a new one.</span>
        <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r9 rd" class="r9 r">sasTemplate</span> = <a href="#9bd18b3eea8dd812" class="i method">BuildSasDefinitionTemplate</a>(<span class="r3 r">readOnly</span>);
        <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r10 rd" class="r10 r">sasDefinitionName</span> = <b>await</b> <a href="#c570d5deabddec5f" class="i method">GetOrCreateSasDefinitionAsync</a>(<span class="r7 r">storageClient</span>, <span class="r1 r">storageAccountName</span>, <span class="r9 r">sasTemplate</span>, <span class="r2 r">days</span>, <span class="r3 r">readOnly</span>);
 
        <span class="c">// Now we can create a SecretClient and generate a new SAS token from the storage account and SAS definition names.</span>
        <span class="i">SecretClient</span> <span id="r11 rd" class="r11 r">secretClient</span> = <b>new</b> <span class="i">SecretClient</span>(<span class="r0 r">vaultUri</span>, <span class="r5 r">credential</span>, <span class="r6 r">options</span>);
        <span class="i">KeyVaultSecret</span> <span id="r12 rd" class="r12 r">sasToken</span> = <b>await</b> <span class="r11 r">secretClient</span>.<span class="i">GetSecretAsync</span>(<span class="s">$&quot;</span>{<span class="r1 r">storageAccountName</span>}<span class="s">-</span>{<span class="r10 r">sasDefinitionName</span>}<span class="s">&quot;</span>, <span class="i">cancellationToken</span>: <a href="#c497e833671807cd" class="i field">s_cancellationTokenSource</a>.<span class="i property">Token</span>);
 
        <span class="r4 r">console</span>.<span class="i">Out</span>.<span class="i">WriteLine</span>(<span class="r12 r">sasToken</span>.<span class="i">Value</span>);
        <b>return</b> 0;
    }
 
    <b>private static async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="P/3e6a65914b8b785a.html#3e6a65914b8b785a" class="t t">StorageAccountItem</a>&gt; <a id="382260bf2313e93b" href="R/382260bf2313e93b.html" target="n" data-glyph="76,1" class="i method">FindStorageAccountAsync</a>(
        <a href="P/2a1ee26965681cca.html#2a1ee26965681cca" class="t t">ManagedStorageRestClient</a> <span id="r13 rd" class="r13 r">storageClient</span>,
        <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r14 rd" class="r14 r">storageAccountName</span>)
    {
        <b>for</b> (<a href="P/4e9875dadde0534c.html#4e9875dadde0534c" class="t t">StorageListResult</a> <span id="r15 rd" class="r15 r">result</span> = <b>await</b> <span class="r13 r">storageClient</span>.<a href="Generated/ManagedStorageRestClient.cs.html#1a0e05ce7bd6e4ec" class="i method">GetStorageAccountsAsync</a>(<span class="r16 r">cancellationToken</span>: <a href="#c497e833671807cd" class="i field">s_cancellationTokenSource</a>.<span class="i property">Token</span>); ;
             <span class="r15 r">result</span> = <b>await</b> <span class="r13 r">storageClient</span>.<a href="Generated/ManagedStorageRestClient.cs.html#3339412965851555" class="i method">GetStorageAccountsNextPageAsync</a>(<span class="r15 r">result</span>.<a href="Generated/Models/StorageListResult.cs.html#68b10a0cf8065d71" class="i property">NextLink</a>, <span class="r17 r">cancellationToken</span>: <a href="#c497e833671807cd" class="i field">s_cancellationTokenSource</a>.<span class="i property">Token</span>))
        {
            <b>foreach</b> (<a href="P/3e6a65914b8b785a.html#3e6a65914b8b785a" class="t t">StorageAccountItem</a> <span id="r18 rd" class="r18 r">storageAccount</span> <b>in</b> <span class="r15 r">result</span>.<a href="Generated/Models/StorageListResult.cs.html#2165ace1a2e201f9" class="i property">Value</a>)
            {
                <span class="c">// The storage account name is the segment of the ResourceId.</span>
                <b>int</b> <span id="r19 rd" class="r19 r">pos</span> = <span class="r18 r">storageAccount</span>.<a href="Generated/Models/StorageAccountItem.cs.html#c5f589174496e260" class="i property">ResourceId</a>.<span class="i method">AsSpan</span>().<span class="i method">TrimEnd</span>(<span class="s">&#39;/&#39;</span>).<span class="i method">LastIndexOf</span>(<span class="s">&#39;/&#39;</span>);
                <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r20 rd" class="r20 r">name</span> = <span class="r18 r">storageAccount</span>.<a href="Generated/Models/StorageAccountItem.cs.html#c5f589174496e260" class="i property">ResourceId</a>.<a href="@1@System.Runtime/A.html#882fa7998d6ca35a" class="i method">Substring</a>(<span class="r19 r">pos</span> + 1);
 
                <b>if</b> (<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@System.Runtime/A.html#d47c1f57ad1e1e6e" class="i method">Equals</a>(<span class="r14 r">storageAccountName</span>, <span class="r20 r">name</span>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#eabf4db5f5c52b6a" class="i field">InvariantCultureIgnoreCase</a>))
                {
                    <b>return</b> <span class="r18 r">storageAccount</span>;
                }
            }
 
            <b>if</b> (<span class="r15 r">result</span>.<a href="Generated/Models/StorageListResult.cs.html#68b10a0cf8065d71" class="i property">NextLink</a> <b>is null</b>)
            {
                <span class="c">// No more results.</span>
                <b>return</b> <b>null</b>;
            }
        }
    }
 
    <b>private static string</b> <a id="9bd18b3eea8dd812" href="R/9bd18b3eea8dd812.html" target="n" data-glyph="76,1" class="i method">BuildSasDefinitionTemplate</a>(<b>bool</b> <span id="r21 rd" class="r21 r">readOnly</span>) =&gt;
        <b>new</b> <a href="@1@System.Runtime/A.html#57b9d3a70c2aba34" class="t constructor">StringBuilder</a>(<span class="s">&quot;sv=2018-03-28&quot;</span>)  <span class="c">// service version</span>
            .<a href="@1@System.Runtime/A.html#e8eaef3c361184bc" class="i method">Append</a>(<span class="s">&quot;&amp;spr=https&quot;</span>)           <span class="c">// HTTPS only</span>
            .<a href="@1@System.Runtime/A.html#e8eaef3c361184bc" class="i method">Append</a>(<span class="s">&quot;&amp;ss=bf&quot;</span>)               <span class="c">// blobs and files only</span>
            .<a href="@1@System.Runtime/A.html#e8eaef3c361184bc" class="i method">Append</a>(<span class="s">&quot;&amp;srt=o&quot;</span>)               <span class="c">// applies to objects only</span>
            .<a href="@1@System.Runtime/A.html#e8eaef3c361184bc" class="i method">Append</a>(<span class="r21 r">readOnly</span> ? <span class="s">&quot;&amp;sp=r&quot;</span> : <span class="s">&quot;&amp;sp=rw&quot;</span>)  <span class="c">// read-only or read-write</span>
            .<a href="@1@System.Runtime/A.html#5a97da49a158a3c9" class="i method">ToString</a>();
 
    <b>private static async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <a id="c570d5deabddec5f" href="R/c570d5deabddec5f.html" target="n" data-glyph="76,1" class="i method">GetOrCreateSasDefinitionAsync</a>(
        <a href="P/2a1ee26965681cca.html#2a1ee26965681cca" class="t t">ManagedStorageRestClient</a> <span id="r22 rd" class="r22 r">storageClient</span>,
        <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r23 rd" class="r23 r">storageAccountName</span>,
        <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r24 rd" class="r24 r">sasTemplate</span>,
        <b>int</b> <span id="r25 rd" class="r25 r">days</span>,
        <b>bool</b> <span id="r26 rd" class="r26 r">readOnly</span>)
    {
        <b>const string</b> <span id="r27 rd" class="r27 r">Tag</span> = <span class="s">&quot;ShareLinkSample&quot;</span>;
 
        <span class="c">// Format the duration using ISO 8601.</span>
        <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r28 rd" class="r28 r">duration</span> = <span class="r25 r">days</span> &gt; 0 ? <span class="t t">XmlConvert</span>.<span class="i method">ToString</span>(<a href="@1@System.Runtime/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@1@System.Runtime/A.html#e7c4baa19fa38e8e" class="i method">FromDays</a>(<span class="r25 r">days</span>)) : <b>null</b>;
 
        <span class="c">// Try to find an existing definition based on the template and duration, since the formatted name may have changed.</span>
        <b>for</b> (<a href="P/784a966d1d642805.html#784a966d1d642805" class="t t">SasDefinitionListResult</a> <span id="r29 rd" class="r29 r">result</span> = <b>await</b> <span class="r22 r">storageClient</span>.<a href="Generated/ManagedStorageRestClient.cs.html#10d7ac3f92078ba5" class="i method">GetSasDefinitionsAsync</a>(<span class="r23 r">storageAccountName</span>, <span class="r30 r">cancellationToken</span>: <a href="#c497e833671807cd" class="i field">s_cancellationTokenSource</a>.<span class="i property">Token</span>); ;
             <span class="r29 r">result</span> = <b>await</b> <span class="r22 r">storageClient</span>.<a href="Generated/ManagedStorageRestClient.cs.html#6a8b3e34ef5227b3" class="i method">GetSasDefinitionsNextPageAsync</a>(<span class="r29 r">result</span>.<a href="Generated/Models/SasDefinitionListResult.cs.html#e205cd87d5f6cb64" class="i property">NextLink</a>, <span class="r23 r">storageAccountName</span>, <span class="r31 r">cancellationToken</span>: <a href="#c497e833671807cd" class="i field">s_cancellationTokenSource</a>.<span class="i property">Token</span>))
        {
            <b>foreach</b> (<a href="P/ef1fd850b09673c3.html#ef1fd850b09673c3" class="t t">SasDefinitionItem</a> <span id="r32 rd" class="r32 r">sasDefinitionInfo</span> <b>in</b> <span class="r29 r">result</span>.<a href="Generated/Models/SasDefinitionListResult.cs.html#e990d1cca13c04b1" class="i property">Value</a>.<span class="i method">Where</span>(<span id="r33 rd" class="r33 r">d</span> =&gt; <span class="r33 r">d</span>.<a href="Generated/Models/SasDefinitionItem.cs.html#da92fd16c0140bd3" class="i property">Tags</a>.<a href="@1@System.Runtime/A.html#a5aa59e9bd3078ba" class="i method">ContainsKey</a>(<span class="r27 r">Tag</span>)))
            {
                <span class="c">// The SAS definition name is the segment of the Id.</span>
                <b>int</b> <span id="r34 rd" class="r34 r">pos</span> = <span class="r32 r">sasDefinitionInfo</span>.<a href="Generated/Models/SasDefinitionItem.cs.html#3830e835d379de2a" class="i property">Id</a>.<span class="i method">AsSpan</span>().<span class="i method">TrimEnd</span>(<span class="s">&#39;/&#39;</span>).<span class="i method">LastIndexOf</span>(<span class="s">&#39;/&#39;</span>);
                <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r35 rd" class="r35 r">name</span> = <span class="r32 r">sasDefinitionInfo</span>.<a href="Generated/Models/SasDefinitionItem.cs.html#3830e835d379de2a" class="i property">Id</a>.<a href="@1@System.Runtime/A.html#882fa7998d6ca35a" class="i method">Substring</a>(<span class="r34 r">pos</span> + 1);
 
                <a href="P/feeed8ab8192f7a1.html#feeed8ab8192f7a1" class="t t">SasDefinitionBundle</a> <span id="r36 rd" class="r36 r">foundSasDefinition</span> = <b>await</b> <span class="r22 r">storageClient</span>.<a href="Generated/ManagedStorageRestClient.cs.html#7bf0246001389f82" class="i method">GetSasDefinitionAsync</a>(<span class="r23 r">storageAccountName</span>, <span class="r35 r">name</span>, <span class="r37 r">cancellationToken</span>: <a href="#c497e833671807cd" class="i field">s_cancellationTokenSource</a>.<span class="i property">Token</span>);
                <b>if</b> (<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@System.Runtime/A.html#d47c1f57ad1e1e6e" class="i method">Equals</a>(<span class="r24 r">sasTemplate</span>, <span class="r36 r">foundSasDefinition</span>.<a href="Generated/Models/SasDefinitionBundle.cs.html#2757790cadf8cea7" class="i property">TemplateUri</a>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>) &amp;&amp;
                    <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@System.Runtime/A.html#d47c1f57ad1e1e6e" class="i method">Equals</a>(<span class="r28 r">duration</span>, <span class="r36 r">foundSasDefinition</span>.<a href="Generated/Models/SasDefinitionBundle.cs.html#cd72a263930332ab" class="i property">ValidityPeriod</a>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>))
                {
                    <b>return</b> <span class="r35 r">name</span>;
                }
            }
 
            <b>if</b> (<span class="r29 r">result</span>.<a href="Generated/Models/SasDefinitionListResult.cs.html#e205cd87d5f6cb64" class="i property">NextLink</a> <b>is null</b>)
            {
                <span class="c">// No more results.</span>
                <b>break</b>;
            }
        }
 
        <span class="c">// Create a new SAS definition since we didn&#39;t find an existing definition.</span>
        <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r38 rd" class="r38 r">sasDefinitionName</span> = <a href="#ac4f29abe5afe606" class="i method">BuildSasDefinitionName</a>(<span class="r27 r">Tag</span>, <span class="r26 r">readOnly</span>, <span class="r28 r">duration</span>);
        <a href="P/433e347ec25a5839.html#433e347ec25a5839" class="t t">SasDefinitionAttributes</a> <span id="r39 rd" class="r39 r">sasDefinitionAttributes</span> = <b>new</b> <a href="Generated/Models/SasDefinitionAttributes.cs.html#a96d67775c58f68f" class="t constructor">SasDefinitionAttributes</a>
        {
            <a href="Generated/Models/SasDefinitionAttributes.cs.html#56cad66a72f75c44" class="i property">Enabled</a> = <b>true</b>,
        };
 
        <span class="t t">Dictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <span id="r40 rd" class="r40 r">tags</span> = <b>new</b> <span class="t constructor">Dictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;
        {
            [<span class="r27 r">Tag</span>] = <span class="s">&quot;1&quot;</span>,
        };
 
        <a href="P/feeed8ab8192f7a1.html#feeed8ab8192f7a1" class="t t">SasDefinitionBundle</a> <span id="r41 rd" class="r41 r">createdSasDefinition</span> = <b>await</b> <span class="r22 r">storageClient</span>.<a href="Generated/ManagedStorageRestClient.cs.html#1119b1c30ac82802" class="i method">SetSasDefinitionAsync</a>(
            <span class="r23 r">storageAccountName</span>,
            <span class="r38 r">sasDefinitionName</span>,
            <span class="r24 r">sasTemplate</span>,
            <a href="Generated/Models/SasTokenType.cs.html#ba6f76bcfa5e279e" class="t t">SasTokenType</a>.<a href="Generated/Models/SasTokenType.cs.html#65dcd3da5125e2a0" class="i property">Account</a>,
            <span class="r28 r">duration</span>,
            <span class="r39 r">sasDefinitionAttributes</span>,
            <span class="r40 r">tags</span>,
            <a href="#c497e833671807cd" class="i field">s_cancellationTokenSource</a>.<span class="i property">Token</span>);
 
        <b>return</b> <span class="r38 r">sasDefinitionName</span>;
    }
 
    <b>private static string</b> <a id="ac4f29abe5afe606" href="R/ac4f29abe5afe606.html" target="n" data-glyph="76,1" class="i method">BuildSasDefinitionName</a>(
        <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r42 rd" class="r42 r">prefix</span>,
        <b>bool</b> <span id="r43 rd" class="r43 r">readOnly</span>,
        <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r44 rd" class="r44 r">duration</span>)
    {
        <a href="@1@System.Runtime/A.html#adf60ee46ebd299f" class="t t">StringBuilder</a> <span id="r45 rd" class="r45 r">sb</span> = <b>new</b> <a href="@1@System.Runtime/A.html#57b9d3a70c2aba34" class="t constructor">StringBuilder</a>(<span class="r42 r">prefix</span>)
            .<a href="@1@System.Runtime/A.html#e8eaef3c361184bc" class="i method">Append</a>(<span class="r43 r">readOnly</span> ? <span class="s">&quot;ReadOnly&quot;</span> : <span class="s">&quot;ReadWrite&quot;</span>);
 
        <b>if</b> (<span class="r44 r">duration</span> <b>is</b> { })
        {
            <span class="r45 r">sb</span>.<a href="@1@System.Runtime/A.html#e8eaef3c361184bc" class="i method">Append</a>(<span class="r44 r">duration</span>);
        }
 
        <b>return</b> <span class="r45 r">sb</span>.<a href="@1@System.Runtime/A.html#5a97da49a158a3c9" class="i method">ToString</a>();
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Configuration
    <span class="c">// Expose RootCommand for invoking directly via optional tests.</span>
    <b>internal static readonly</b> <span class="i">RootCommand</span> <a id="fd4e3e55e3af3464" href="R/fd4e3e55e3af3464.html" target="n" data-glyph="44,1" class="i field">Command</a>;
    <b>private static readonly</b> <span class="t t">CancellationTokenSource</span> <a id="c497e833671807cd" href="R/c497e833671807cd.html" target="n" data-glyph="46,1" class="i field">s_cancellationTokenSource</a>;
 
    <b>static</b> <a id="14cec1069e123570" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">Program</a>()
    {
        <a href="#fd4e3e55e3af3464" class="i field">Command</a> = <b>new</b> <span class="i">RootCommand</span>(<span class="s">&quot;Generates a shareable link to a blob or file&quot;</span>)
        {
            <b>new</b> <span class="i">Option</span>&lt;<a href="@1@System.Runtime/A.html#991565dd25f47c90" class="t t">Uri</a>&gt;(
                <span class="i">alias</span>: <span class="s">&quot;--vault-name&quot;</span>,
                <span class="i">description</span>: <span class="s">&quot;Key Vault name or URI, e.g. my-vault or https://my-vault-vault.azure.net&quot;</span>,
                <span class="i">parseArgument</span>: <span id="r46 rd" class="r46 r">result</span> =&gt;
                {
                    <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r47 rd" class="r47 r">value</span> = <span class="r46 r">result</span>.<span class="i">Tokens</span>.<span class="i">Single</span>().<span class="i">Value</span>;
                    <b>if</b> (<a href="@1@System.Runtime/A.html#991565dd25f47c90" class="t t">Uri</a>.<a href="@1@System.Runtime/A.html#49754736d6982eb6" class="i method">TryCreate</a>(<span class="r47 r">value</span>, <a href="@1@System.Runtime/A.html#ac43655101ad74be" class="t t">UriKind</a>.<a href="@1@System.Runtime/A.html#d734108197254429" class="i field">Absolute</a>, <b>out</b> <a href="@1@System.Runtime/A.html#991565dd25f47c90" class="t t">Uri</a> <span id="r48 rd" class="r48 r">vaultUri</span>) ||
                        <a href="@1@System.Runtime/A.html#991565dd25f47c90" class="t t">Uri</a>.<a href="@1@System.Runtime/A.html#49754736d6982eb6" class="i method">TryCreate</a>(<span class="s">$&quot;</span><span class="s">https://</span>{<span class="r47 r">value</span>}<span class="s">.vault.azure.net</span><span class="s">&quot;</span>, <a href="@1@System.Runtime/A.html#ac43655101ad74be" class="t t">UriKind</a>.<a href="@1@System.Runtime/A.html#d734108197254429" class="i field">Absolute</a>, <b>out</b> <span class="r48 r">vaultUri</span>))
                    {
                        <b>return</b> <span class="r48 r">vaultUri</span>;
                    }
 
                    <span class="r46 r">result</span>.<span class="i">ErrorMessage</span> = <span class="s">&quot;Must specify a vault name or URI&quot;</span>;
                    <b>return</b> <b>null</b>!;
                }
            )
            {
                <span class="i">Name</span> = <span class="s">&quot;vaultUri&quot;</span>,
                <span class="i">IsRequired</span> = <b>true</b>,
            },
 
            <b>new</b> <span class="i">Option</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(
                <span class="i">alias</span>: <span class="s">&quot;--storage-account-name&quot;</span>,
                <span class="i">description</span>: <span class="s">&quot;Storage account name managed by Key Vault&quot;</span>
            )
            {
                <span class="i">IsRequired</span> = <b>true</b>,
            },
 
            <b>new</b> <span class="i">Option</span>&lt;<b>int</b>&gt;(
                <span class="i">aliases</span>: <b>new</b>[] { <span class="s">&quot;-d&quot;</span>, <span class="s">&quot;--days&quot;</span> },
                <span class="i">description</span>: <span class="s">&quot;Number of days the link is valid; must be &gt; 0&quot;</span>,
                <span class="i">getDefaultValue</span>: () =&gt; 0
            )
            {
                <span class="i">IsRequired</span> = <b>true</b>,
            }.<a href="#d07d4a397248c33d" class="i method">GreaterThan</a>(0),
 
            <b>new</b> <span class="i">Option</span>&lt;<b>bool</b>&gt;(
                <span class="i">aliases</span>: <b>new</b>[] { <span class="s">&quot;-r&quot;</span>, <span class="s">&quot;--read-only&quot;</span> },
                <span class="i">description</span>: <span class="s">&quot;Make the sharable link read-only&quot;</span>
            ),
        };
 
        <a href="#fd4e3e55e3af3464" class="i field">Command</a>.<span class="i">Handler</span> = <span class="i">CommandHandler</span>.<span class="i">Create</span>&lt;<a href="@1@System.Runtime/A.html#991565dd25f47c90" class="t t">Uri</a>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <b>int</b>, <b>bool</b>, <span class="i">IConsole</span>&gt;(<span class="i">RunAsync</span>);
 
        <a href="#c497e833671807cd" class="i field">s_cancellationTokenSource</a> = <b>new</b> <span class="t constructor">CancellationTokenSource</span>();
    }
 
    <b>private static async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>int</b>&gt; <a id="664b8e57f8129b58" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">Main</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>[] <span id="r49 rd" class="r49 r">args</span>)
    {
        <span class="t t">Console</span>.<span class="i">CancelKeyPress</span> += (<span id="r50 rd" class="r50 r">_</span>, <span id="r51 rd" class="r51 r">args</span>) =&gt;
        {
            <span class="t t">Console</span>.<span class="i property">Error</span>.<span class="i method">WriteLine</span>(<span class="s">&quot;Canceling...&quot;</span>);
            <a href="#c497e833671807cd" class="i field">s_cancellationTokenSource</a>.<span class="i method">Cancel</span>();
 
            <span class="r51 r">args</span>.<span class="i property">Cancel</span> = <b>true</b>;
        };
 
        <b>return</b> <b>await</b> <a href="#fd4e3e55e3af3464" class="i field">Command</a>.<span class="i">InvokeAsync</span>(<span class="r49 r">args</span>);
    }
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Extensions
    <b>internal static</b> <span class="i">Option</span>&lt;<b>int</b>&gt; <a id="d07d4a397248c33d" href="R/d07d4a397248c33d.html" target="n" data-glyph="221,1" class="i method">GreaterThan</a>(<b>this</b> <span class="i">Option</span>&lt;<b>int</b>&gt; <span id="r52 rd" class="r52 r">option</span>, <b>int</b> <span id="r53 rd" class="r53 r">value</span>)
    {
        <span class="r52 r">option</span>.<span class="i">AddValidator</span>(<span id="r54 rd" class="r54 r">r</span> =&gt;
            <span class="r54 r">r</span>.<span class="i">Tokens</span>
                .<span class="i">Select</span>(<span id="r55 rd" class="r55 r">t</span> =&gt; <span class="r55 r">t</span>.<span class="i">Value</span>)
                .<span class="i">Where</span>(<span id="r56 rd" class="r56 r">v</span> =&gt; !<b>int</b>.<span class="i">TryParse</span>(<span class="r56 r">v</span>, <b>out int</b> <span id="r57 rd" class="r57 r">i</span>) || <span class="r57 r">i</span> &lt;= <span class="r53 r">value</span>)
                .<span class="i">Select</span>(<span id="r58 rd" class="r58 r">_</span> =&gt; <span class="s">$&quot;</span><span class="s">Option &#39;</span>{<span class="r54 r">r</span>.<span class="i">Symbol</span>.<span class="i">Name</span>}<span class="s">&#39; must be greater than </span>{<span class="r53 r">value</span>}<span class="s">&quot;</span>)
                .<span class="i">FirstOrDefault</span>());
 
        <b>return</b> <span class="r52 r">option</span>;
    }
   <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
}
</pre></td></tr></table></div></body></html>
