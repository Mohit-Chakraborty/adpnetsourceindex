<!DOCTYPE html>
<html><head><title>EventHubConsumerClient.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(1074);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Messaging.EventHubs/Consumer/EventHubConsumerClient.cs" target="_top">Consumer\EventHubConsumerClient.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Messaging.EventHubs" target="_top">src\Azure.Messaging.EventHubs.csproj</a> (Azure.Messaging.EventHubs)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i">System</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Concurrent</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i">System</span>.<span class="i">ComponentModel</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Runtime</span>.<span class="i">CompilerServices</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Runtime</span>.<span class="i">ExceptionServices</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Threading</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Channels</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">EventHubs</span>.<span class="i n">Core</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">EventHubs</span>.<span class="i n">Diagnostics</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">EventHubs</span>.<span class="i n">Consumer</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">A client responsible for reading </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../EventData.cs.html#557aa370d1369b89" class="t t">EventData</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> from a specific Event Hub</span>
    <span class="c">///</span><span class="c">   as a member of a specific consumer group.</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">A consumer may be exclusive, which asserts ownership over associated partitions for the consumer</span>
    <span class="c">///</span><span class="c">   group to ensure that only one consumer from that group is reading the from the partition.</span>
    <span class="c">///</span><span class="c">   These exclusive consumers are sometimes referred to as &quot;Epoch Consumers.&quot;</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">A consumer may also be non-exclusive, allowing multiple consumers from the same consumer</span>
    <span class="c">///</span><span class="c">   group to be actively reading events from a given partition.  These non-exclusive consumers are</span>
    <span class="c">///</span><span class="c">   sometimes referred to as &quot;Non-Epoch Consumers.&quot;</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c">   The </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> is safe to cache and use for the lifetime of an application, and that is best practice when the application</span>
    <span class="c">///</span><span class="c">   reads events regularly or semi-regularly.  The consumer holds responsibility for efficient resource management, working to keep resource usage low during</span>
    <span class="c">///</span><span class="c">   periods of inactivity and manage health during periods of higher use.  Calling either the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#e8b7a569e700fb42" class="i method">CloseAsync</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> or </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#0ca8ca99c7d44c2a" class="i method">DisposeAsync</a><span class="c">&quot;</span> <span class="c">/&gt;</span>
    <span class="c">///</span><span class="c">   method as the application is shutting down will ensure that network resources and other unmanaged objects are properly cleaned up.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
    <span class="c">///</span>
    <b>public class</b> <a id="f3134c5ddad42173" href="../R/f3134c5ddad42173.html" target="n" data-glyph="0,0" class="t t">EventHubConsumerClient</a> : <span class="i">IAsyncDisposable</span>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">The name of the default consumer group in the Event Hubs service.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const string</b> <a id="8c58318bf9e1254b" href="../R/8c58318bf9e1254b.html" target="n" data-glyph="6,1" class="i field">DefaultConsumerGroupName</a> = <span class="s">&quot;$Default&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">The maximum wait time for receiving an event batch for the background publishing operation used for subscriptions.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="i">TimeSpan</span> <a id="5a47c8f6b37fd141" href="../R/5a47c8f6b37fd141.html" target="n" data-glyph="46,1" class="i field">BackgroundPublishingWaitTime</a> = <span class="i">TimeSpan</span>.<span class="i">FromMilliseconds</span>(250);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Indicates whether or not this instance has been closed.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private volatile bool</b> <a id="295ec5388ba57589" href="../R/295ec5388ba57589.html" target="n" data-glyph="46,1" class="i field">_closed</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The fully qualified Event Hubs namespace that the consumer is associated with.  This is likely</span>
        <span class="c">///</span><span class="c">   to be similar to </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">{yournamespace}.servicebus.windows.net</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public string</b> <a id="e1dfb4e9ca8edb30" href="../R/e1dfb4e9ca8edb30.html" target="n" data-glyph="102,1" class="i property">FullyQualifiedNamespace</a> =&gt; <a href="#81d26e0ee8a01178" class="i property">Connection</a>.<a href="../EventHubConnection.cs.html#42574858f23f2a35" class="i property">FullyQualifiedNamespace</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The name of the Event Hub that the consumer is connected to, specific to the</span>
        <span class="c">///</span><span class="c">   Event Hubs namespace that contains it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public string</b> <a id="4ed514492b08d276" href="../R/4ed514492b08d276.html" target="n" data-glyph="102,1" class="i property">EventHubName</a> =&gt; <a href="#81d26e0ee8a01178" class="i property">Connection</a>.<a href="../EventHubConnection.cs.html#9d66313561b8598d" class="i property">EventHubName</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The name of the consumer group that this consumer is associated with.  Events will be read</span>
        <span class="c">///</span><span class="c">   only in the context of this group.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public string</b> <a id="143cc18e1538c2ca" href="../R/143cc18e1538c2ca.html" target="n" data-glyph="102,1" class="i property">ConsumerGroup</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Indicates whether or not this </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> has been closed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if the client is closed; otherwise, </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public bool</b> <a id="082cfb4c13909f11" href="../R/082cfb4c13909f11.html" target="n" data-glyph="102,1" class="i property">IsClosed</a>
        {
            <b>get</b> =&gt; <a href="#295ec5388ba57589" class="i field">_closed</a>;
            <b>protected set</b> =&gt; <a href="#295ec5388ba57589" class="i field">_closed</a> = <b>value</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Indicates whether the client has ownership of the associated </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../EventHubConnection.cs.html#0646809725209998" class="t t">EventHubConnection</a><span class="c">&quot;</span> <span class="c">/&gt;</span>
        <span class="c">///</span><span class="c">   and should take responsibility for managing its lifespan.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>private bool</b> <a id="b41dc27415095f4d" href="../R/b41dc27415095f4d.html" target="n" data-glyph="106,1" class="i property">OwnsConnection</a> { <b>get</b>; } = <b>true</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The policy to use for determining retry behavior for when an operation fails.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>private</b> <a href="../EventHubsRetryPolicy.cs.html#bc28d871ab581a88" class="t t">EventHubsRetryPolicy</a> <a id="165d9d03b0db6635" href="../R/165d9d03b0db6635.html" target="n" data-glyph="106,1" class="i property">RetryPolicy</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The active connection to the Azure Event Hubs service, enabling client communications for metadata</span>
        <span class="c">///</span><span class="c">   about the associated Event Hub and access to transport-aware consumers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>private</b> <a href="../EventHubConnection.cs.html#0646809725209998" class="t t">EventHubConnection</a> <a id="81d26e0ee8a01178" href="../R/81d26e0ee8a01178.html" target="n" data-glyph="106,1" class="i property">Connection</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The set of active Event Hub transport-specific consumers created by this client for use with</span>
        <span class="c">///</span><span class="c">   delegated operations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>private</b> <span class="i">ConcurrentDictionary</span>&lt;<b>string</b>, <a href="../Core/TransportConsumer.cs.html#265a21c281157aa2" class="t t">TransportConsumer</a>&gt; <a id="c43c2bcac2e2efde" href="../R/c43c2bcac2e2efde.html" target="n" data-glyph="106,1" class="i property">ActiveConsumers</a> { <b>get</b>; } = <b>new</b> <span class="i">ConcurrentDictionary</span>&lt;<b>string</b>, <a href="../Core/TransportConsumer.cs.html#265a21c281157aa2" class="t t">TransportConsumer</a>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">consumerGroup</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the consumer group this consumer is associated with.  Events are read in the context of this group.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">connectionString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The connection string to use for connecting to the Event Hubs namespace; it is expected that the Event Hub name and the shared key properties are contained in this connection string.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   If the connection string is copied from the Event Hubs namespace, it will likely not contain the name of the desired Event Hub,</span>
        <span class="c">///</span><span class="c">   which is needed.  In this case, the name can be added manually by adding &quot;;EntityPath=[[ EVENT HUB NAME ]]&quot; to the end of the</span>
        <span class="c">///</span><span class="c">   connection string.  For example, &quot;;EntityPath=telemetry-hub&quot;.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   If you have defined a shared access policy directly on the Event Hub itself, then copying the connection string from that</span>
        <span class="c">///</span><span class="c">   Event Hub will result in a connection string that contains the name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">href</span><span class="c">=</span><span class="c">&quot;</span><span class="c">https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-get-connection-string</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span>
        <b>public</b> <a id="1580417fdd286a30" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">EventHubConsumerClient</a>(<b>string</b> <span id="r0 rd" class="r0 r">consumerGroup</span>,
                                      <b>string</b> <span id="r1 rd" class="r1 r">connectionString</span>) : <a href="#d90396ec6194ec63" class="k">this</a>(<span class="r0 r">consumerGroup</span>, <span class="r1 r">connectionString</span>, <b>null</b>, <b>null</b>)
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">consumerGroup</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the consumer group this consumer is associated with.  Events are read in the context of this group.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">connectionString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The connection string to use for connecting to the Event Hubs namespace; it is expected that the Event Hub name and the shared key properties are contained in this connection string.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">clientOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The set of options to use for this consumer.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   If the connection string is copied from the Event Hubs namespace, it will likely not contain the name of the desired Event Hub,</span>
        <span class="c">///</span><span class="c">   which is needed.  In this case, the name can be added manually by adding &quot;;EntityPath=[[ EVENT HUB NAME ]]&quot; to the end of the</span>
        <span class="c">///</span><span class="c">   connection string.  For example, &quot;;EntityPath=telemetry-hub&quot;.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   If you have defined a shared access policy directly on the Event Hub itself, then copying the connection string from that</span>
        <span class="c">///</span><span class="c">   Event Hub will result in a connection string that contains the name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">href</span><span class="c">=</span><span class="c">&quot;</span><span class="c">https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-get-connection-string</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span>
        <b>public</b> <a id="9c8a73c092202cc2" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">EventHubConsumerClient</a>(<b>string</b> <span id="r2 rd" class="r2 r">consumerGroup</span>,
                                      <b>string</b> <span id="r3 rd" class="r3 r">connectionString</span>,
                                      <a href="EventHubConsumerClientOptions.cs.html#5e4187ab214609d9" class="t t">EventHubConsumerClientOptions</a> <span id="r4 rd" class="r4 r">clientOptions</span>) : <a href="#d90396ec6194ec63" class="k">this</a>(<span class="r2 r">consumerGroup</span>, <span class="r3 r">connectionString</span>, <b>null</b>, <span class="r4 r">clientOptions</span>)
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">consumerGroup</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the consumer group this consumer is associated with.  Events are read in the context of this group.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">connectionString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The connection string to use for connecting to the Event Hubs namespace; it is expected that the shared key properties are contained in this connection string, but not the Event Hub name.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">eventHubName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the specific Event Hub to associate the consumer with.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   If the connection string is copied from the Event Hub itself, it will contain the name of the desired Event Hub,</span>
        <span class="c">///</span><span class="c">   and can be used directly without passing the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">eventHubName</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">.  The name of the Event Hub should be</span>
        <span class="c">///</span><span class="c">   passed only once, either as part of the connection string or separately.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">href</span><span class="c">=</span><span class="c">&quot;</span><span class="c">https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-get-connection-string</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span>
        <b>public</b> <a id="5c5f4b73152360c4" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">EventHubConsumerClient</a>(<b>string</b> <span id="r5 rd" class="r5 r">consumerGroup</span>,
                                      <b>string</b> <span id="r6 rd" class="r6 r">connectionString</span>,
                                      <b>string</b> <span id="r7 rd" class="r7 r">eventHubName</span>) : <a href="#d90396ec6194ec63" class="k">this</a>(<span class="r5 r">consumerGroup</span>, <span class="r6 r">connectionString</span>, <span class="r7 r">eventHubName</span>, <b>null</b>)
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">consumerGroup</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the consumer group this consumer is associated with.  Events are read in the context of this group.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">connectionString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The connection string to use for connecting to the Event Hubs namespace; it is expected that the shared key properties are contained in this connection string, but not the Event Hub name.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">eventHubName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the specific Event Hub to associate the consumer with.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">clientOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A set of options to apply when configuring the consumer.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   If the connection string is copied from the Event Hub itself, it will contain the name of the desired Event Hub,</span>
        <span class="c">///</span><span class="c">   and can be used directly without passing the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">eventHubName</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">.  The name of the Event Hub should be</span>
        <span class="c">///</span><span class="c">   passed only once, either as part of the connection string or separately.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">href</span><span class="c">=</span><span class="c">&quot;</span><span class="c">https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-get-connection-string</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span>
        <b>public</b> <a id="d90396ec6194ec63" href="../R/d90396ec6194ec63.html" target="n" data-glyph="72,1" class="t constructor">EventHubConsumerClient</a>(<b>string</b> <span id="r8 rd" class="r8 r">consumerGroup</span>,
                                      <b>string</b> <span id="r9 rd" class="r9 r">connectionString</span>,
                                      <b>string</b> <span id="r10 rd" class="r10 r">eventHubName</span>,
                                      <a href="EventHubConsumerClientOptions.cs.html#5e4187ab214609d9" class="t t">EventHubConsumerClientOptions</a> <span id="r11 rd" class="r11 r">clientOptions</span>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#6f15f042abe7f96a" class="i method">AssertNotNullOrEmpty</a>(<span class="r8 r">consumerGroup</span>, <b>nameof</b>(<span class="r8 r">consumerGroup</span>));
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#6f15f042abe7f96a" class="i method">AssertNotNullOrEmpty</a>(<span class="r9 r">connectionString</span>, <b>nameof</b>(<span class="r9 r">connectionString</span>));
 
            <span class="r11 r">clientOptions</span> = <span class="r11 r">clientOptions</span>?.<a href="EventHubConsumerClientOptions.cs.html#06a9dead1eec1d78" class="i method">Clone</a>() ?? <b>new</b> <span class="t">EventHubConsumerClientOptions</span>();
 
            <a href="#b41dc27415095f4d" class="i property">OwnsConnection</a> = <b>true</b>;
            <a href="#81d26e0ee8a01178" class="i property">Connection</a> = <b>new</b> <a href="../EventHubConnection.cs.html#298a945ee13156f2" class="t constructor">EventHubConnection</a>(<span class="r9 r">connectionString</span>, <span class="r10 r">eventHubName</span>, <span class="r11 r">clientOptions</span>.<a href="EventHubConsumerClientOptions.cs.html#313a6933bd8895f1" class="i property">ConnectionOptions</a>);
            <a href="#143cc18e1538c2ca" class="i property">ConsumerGroup</a> = <span class="r8 r">consumerGroup</span>;
            <a href="#165d9d03b0db6635" class="i property">RetryPolicy</a> = <span class="r11 r">clientOptions</span>.<a href="EventHubConsumerClientOptions.cs.html#4fe40e60b7012a4b" class="i property">RetryOptions</a>.<a href="../SharedSource/Core/EventHubsRetryOptionsExtensions.cs.html#f1a0f56e5cda073f" class="i method">ToRetryPolicy</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">consumerGroup</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the consumer group this consumer is associated with.  Events are read in the context of this group.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">fullyQualifiedNamespace</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The fully qualified Event Hubs namespace to connect to.  This is likely to be similar to </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">{yournamespace}.servicebus.windows.net</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">eventHubName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the specific Event Hub to associate the consumer with.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">credential</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The Event Hubs shared access key credential to use for authorization.  Access controls may be specified by the Event Hubs namespace or the requested Event Hub, depending on Azure configuration.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">clientOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A set of options to apply when configuring the consumer.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>internal</b> <a id="8f91d37d90e37aaa" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="t constructor">EventHubConsumerClient</a>(<b>string</b> <span id="r12 rd" class="r12 r">consumerGroup</span>,
                                        <b>string</b> <span id="r13 rd" class="r13 r">fullyQualifiedNamespace</span>,
                                        <b>string</b> <span id="r14 rd" class="r14 r">eventHubName</span>,
                                        <a href="../Authorization/EventHubsSharedAccessKeyCredential.cs.html#fedd60277cbbbc1c" class="t t">EventHubsSharedAccessKeyCredential</a> <span id="r15 rd" class="r15 r">credential</span>,
                                        <a href="EventHubConsumerClientOptions.cs.html#5e4187ab214609d9" class="t t">EventHubConsumerClientOptions</a> <span id="r16 rd" class="r16 r">clientOptions</span> = <b>default</b>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#6f15f042abe7f96a" class="i method">AssertNotNullOrEmpty</a>(<span class="r12 r">consumerGroup</span>, <b>nameof</b>(<span class="r12 r">consumerGroup</span>));
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Core/Argument.cs.html#4b3e3f504d747537" class="i method">AssertWellFormedEventHubsNamespace</a>(<span class="r13 r">fullyQualifiedNamespace</span>, <b>nameof</b>(<span class="r13 r">fullyQualifiedNamespace</span>));
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#6f15f042abe7f96a" class="i method">AssertNotNullOrEmpty</a>(<span class="r14 r">eventHubName</span>, <b>nameof</b>(<span class="r14 r">eventHubName</span>));
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#208d023d6fa23d33" class="i method">AssertNotNull</a>(<span class="r15 r">credential</span>, <b>nameof</b>(<span class="r15 r">credential</span>));
 
            <span class="r16 r">clientOptions</span> = <span class="r16 r">clientOptions</span>?.<a href="EventHubConsumerClientOptions.cs.html#06a9dead1eec1d78" class="i method">Clone</a>() ?? <b>new</b> <span class="t">EventHubConsumerClientOptions</span>();
 
            <a href="#b41dc27415095f4d" class="i property">OwnsConnection</a> = <b>true</b>;
            <a href="#81d26e0ee8a01178" class="i property">Connection</a> = <b>new</b> <a href="../EventHubConnection.cs.html#99fd244d7decbc90" class="t constructor">EventHubConnection</a>(<span class="r13 r">fullyQualifiedNamespace</span>, <span class="r14 r">eventHubName</span>, <span class="r15 r">credential</span>, <span class="r16 r">clientOptions</span>.<a href="EventHubConsumerClientOptions.cs.html#313a6933bd8895f1" class="i property">ConnectionOptions</a>);
            <a href="#143cc18e1538c2ca" class="i property">ConsumerGroup</a> = <span class="r12 r">consumerGroup</span>;
            <a href="#165d9d03b0db6635" class="i property">RetryPolicy</a> = <span class="r16 r">clientOptions</span>.<a href="EventHubConsumerClientOptions.cs.html#4fe40e60b7012a4b" class="i property">RetryOptions</a>.<a href="../SharedSource/Core/EventHubsRetryOptionsExtensions.cs.html#f1a0f56e5cda073f" class="i method">ToRetryPolicy</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">consumerGroup</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the consumer group this consumer is associated with.  Events are read in the context of this group.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">fullyQualifiedNamespace</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The fully qualified Event Hubs namespace to connect to.  This is likely to be similar to </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">{yournamespace}.servicebus.windows.net</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">eventHubName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the specific Event Hub to associate the consumer with.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">credential</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The Azure managed identity credential to use for authorization.  Access controls may be specified by the Event Hubs namespace or the requested Event Hub, depending on Azure configuration.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r21 r">clientOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A set of options to apply when configuring the consumer.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public</b> <a id="aedebafe39118677" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">EventHubConsumerClient</a>(<b>string</b> <span id="r17 rd" class="r17 r">consumerGroup</span>,
                                      <b>string</b> <span id="r18 rd" class="r18 r">fullyQualifiedNamespace</span>,
                                      <b>string</b> <span id="r19 rd" class="r19 r">eventHubName</span>,
                                      <span class="i">TokenCredential</span> <span id="r20 rd" class="r20 r">credential</span>,
                                      <a href="EventHubConsumerClientOptions.cs.html#5e4187ab214609d9" class="t t">EventHubConsumerClientOptions</a> <span id="r21 rd" class="r21 r">clientOptions</span> = <b>default</b>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#6f15f042abe7f96a" class="i method">AssertNotNullOrEmpty</a>(<span class="r17 r">consumerGroup</span>, <b>nameof</b>(<span class="r17 r">consumerGroup</span>));
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Core/Argument.cs.html#4b3e3f504d747537" class="i method">AssertWellFormedEventHubsNamespace</a>(<span class="r18 r">fullyQualifiedNamespace</span>, <b>nameof</b>(<span class="r18 r">fullyQualifiedNamespace</span>));
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#6f15f042abe7f96a" class="i method">AssertNotNullOrEmpty</a>(<span class="r19 r">eventHubName</span>, <b>nameof</b>(<span class="r19 r">eventHubName</span>));
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<span class="r20 r">credential</span>, <b>nameof</b>(<span class="r20 r">credential</span>));
 
            <span class="r21 r">clientOptions</span> = <span class="r21 r">clientOptions</span>?.<a href="EventHubConsumerClientOptions.cs.html#06a9dead1eec1d78" class="i method">Clone</a>() ?? <b>new</b> <span class="t">EventHubConsumerClientOptions</span>();
 
            <a href="#b41dc27415095f4d" class="i property">OwnsConnection</a> = <b>true</b>;
            <a href="#81d26e0ee8a01178" class="i property">Connection</a> = <b>new</b> <a href="../EventHubConnection.cs.html#ef4fd1a74911ddaa" class="t constructor">EventHubConnection</a>(<span class="r18 r">fullyQualifiedNamespace</span>, <span class="r19 r">eventHubName</span>, <span class="r20 r">credential</span>, <span class="r21 r">clientOptions</span>.<a href="EventHubConsumerClientOptions.cs.html#313a6933bd8895f1" class="i property">ConnectionOptions</a>);
            <a href="#143cc18e1538c2ca" class="i property">ConsumerGroup</a> = <span class="r17 r">consumerGroup</span>;
            <a href="#165d9d03b0db6635" class="i property">RetryPolicy</a> = <span class="r21 r">clientOptions</span>.<a href="EventHubConsumerClientOptions.cs.html#4fe40e60b7012a4b" class="i property">RetryOptions</a>.<a href="../SharedSource/Core/EventHubsRetryOptionsExtensions.cs.html#f1a0f56e5cda073f" class="i method">ToRetryPolicy</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">consumerGroup</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the consumer group this consumer is associated with.  Events are read in the context of this group.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r23 r">connection</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../EventHubConnection.cs.html#0646809725209998" class="t t">EventHubConnection</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> connection to use for communication with the Event Hubs service.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r24 r">clientOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A set of options to apply when configuring the consumer.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public</b> <a id="15a86a0af432cb38" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">EventHubConsumerClient</a>(<b>string</b> <span id="r22 rd" class="r22 r">consumerGroup</span>,
                                      <a href="../EventHubConnection.cs.html#0646809725209998" class="t t">EventHubConnection</a> <span id="r23 rd" class="r23 r">connection</span>,
                                      <a href="EventHubConsumerClientOptions.cs.html#5e4187ab214609d9" class="t t">EventHubConsumerClientOptions</a> <span id="r24 rd" class="r24 r">clientOptions</span> = <b>default</b>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#6f15f042abe7f96a" class="i method">AssertNotNullOrEmpty</a>(<span class="r22 r">consumerGroup</span>, <b>nameof</b>(<span class="r22 r">consumerGroup</span>));
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#208d023d6fa23d33" class="i method">AssertNotNull</a>(<span class="r23 r">connection</span>, <b>nameof</b>(<span class="r23 r">connection</span>));
 
            <span class="r24 r">clientOptions</span> = <span class="r24 r">clientOptions</span>?.<a href="EventHubConsumerClientOptions.cs.html#06a9dead1eec1d78" class="i method">Clone</a>() ?? <b>new</b> <span class="t">EventHubConsumerClientOptions</span>();
 
            <a href="#b41dc27415095f4d" class="i property">OwnsConnection</a> = <b>false</b>;
            <a href="#81d26e0ee8a01178" class="i property">Connection</a> = <span class="r23 r">connection</span>;
            <a href="#143cc18e1538c2ca" class="i property">ConsumerGroup</a> = <span class="r22 r">consumerGroup</span>;
            <a href="#165d9d03b0db6635" class="i property">RetryPolicy</a> = <span class="r24 r">clientOptions</span>.<a href="EventHubConsumerClientOptions.cs.html#4fe40e60b7012a4b" class="i property">RetryOptions</a>.<a href="../SharedSource/Core/EventHubsRetryOptionsExtensions.cs.html#f1a0f56e5cda073f" class="i method">ToRetryPolicy</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>protected</b> <a id="5e742626a04de016" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="t constructor">EventHubConsumerClient</a>()
        {
            <a href="#b41dc27415095f4d" class="i property">OwnsConnection</a> = <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Retrieves information about the Event Hub that the connection is associated with, including</span>
        <span class="c">///</span><span class="c">   the number of partitions present and their identifiers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r25 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An optional </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The set of information for the Event Hub that this client is associated with.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public virtual async</b> <span class="i">Task</span>&lt;<a href="../EventHubProperties.cs.html#6ee60bd5de616192" class="t t">EventHubProperties</a>&gt; <a id="3b7ea8f86cf4280c" href="../R/3b7ea8f86cf4280c.html" target="n" data-glyph="72,1" class="i method">GetEventHubPropertiesAsync</a>(<span class="i">CancellationToken</span> <span id="r25 rd" class="r25 r">cancellationToken</span> = <b>default</b>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Core/Argument.cs.html#eda8ff4d51bf8b3e" class="i method">AssertNotClosed</a>(<a href="#082cfb4c13909f11" class="i property">IsClosed</a>, <b>nameof</b>(<a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a>));
            <b>return</b> <b>await</b> <a href="#81d26e0ee8a01178" class="i property">Connection</a>.<a href="../EventHubConnection.cs.html#46fd9439be893b6a" class="i method">GetPropertiesAsync</a>(<a href="#165d9d03b0db6635" class="i property">RetryPolicy</a>, <span class="r25 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Retrieves the set of identifiers for the partitions of an Event Hub.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r26 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An optional </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The set of identifiers for the partitions within the Event Hub that this client is associated with.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   This method is synonymous with invoking </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#3b7ea8f86cf4280c" class="i method">GetEventHubPropertiesAsync</a>(<span class="i">CancellationToken</span>)<span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> and reading the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../EventHubProperties.cs.html#6ee60bd5de616192" class="t t">EventHubProperties</a>.<a href="../EventHubProperties.cs.html#8f4d5f8630f084c0" class="i property">PartitionIds</a><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c">   property that is returned. It is offered as a convenience for quick access to the set of partition identifiers for the associated Event Hub.</span>
        <span class="c">///</span><span class="c">   No new or extended information is presented.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public virtual async</b> <span class="i">Task</span>&lt;<b>string</b>[]&gt; <a id="ba8292b55896d4bd" href="../R/ba8292b55896d4bd.html" target="n" data-glyph="72,1" class="i method">GetPartitionIdsAsync</a>(<span class="i">CancellationToken</span> <span id="r26 rd" class="r26 r">cancellationToken</span> = <b>default</b>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Core/Argument.cs.html#eda8ff4d51bf8b3e" class="i method">AssertNotClosed</a>(<a href="#082cfb4c13909f11" class="i property">IsClosed</a>, <b>nameof</b>(<a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a>));
            <b>return</b> <b>await</b> <a href="#81d26e0ee8a01178" class="i property">Connection</a>.<a href="../EventHubConnection.cs.html#bb16debc2789e9bc" class="i method">GetPartitionIdsAsync</a>(<a href="#165d9d03b0db6635" class="i property">RetryPolicy</a>, <span class="r26 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Retrieves information about a specific partition for an Event Hub, including elements that describe the available</span>
        <span class="c">///</span><span class="c">   events in the partition event stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r">partitionId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The unique identifier of a partition associated with the Event Hub.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r28 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An optional </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The set of information for the requested partition under the Event Hub this client is associated with.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public virtual async</b> <span class="i">Task</span>&lt;<a href="../PartitionProperties.cs.html#9311a292681a1af8" class="t t">PartitionProperties</a>&gt; <a id="623babd90acb1c63" href="../R/623babd90acb1c63.html" target="n" data-glyph="72,1" class="i method">GetPartitionPropertiesAsync</a>(<b>string</b> <span id="r27 rd" class="r27 r">partitionId</span>,
                                                                                   <span class="i">CancellationToken</span> <span id="r28 rd" class="r28 r">cancellationToken</span> = <b>default</b>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Core/Argument.cs.html#eda8ff4d51bf8b3e" class="i method">AssertNotClosed</a>(<a href="#082cfb4c13909f11" class="i property">IsClosed</a>, <b>nameof</b>(<a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a>));
            <b>return</b> <b>await</b> <a href="#81d26e0ee8a01178" class="i property">Connection</a>.<a href="../EventHubConnection.cs.html#66202595647feb89" class="i method">GetPartitionPropertiesAsync</a>(<span class="r27 r">partitionId</span>, <a href="#165d9d03b0db6635" class="i property">RetryPolicy</a>, <span class="r28 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Reads events from the requested partition as an asynchronous enumerable, allowing events to be iterated as they</span>
        <span class="c">///</span><span class="c">   become available on the partition, waiting as necessary should there be no events available.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   This enumerator may block for an indeterminate amount of time for an </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">await</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if events are not available on the partition, requiring</span>
        <span class="c">///</span><span class="c">   cancellation via the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">cancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be requested in order to return control.  It is recommended to call the overload</span>
        <span class="c">///</span><span class="c">   which accepts a set of options for configuring read behavior for scenarios where a more deterministic maximum waiting period is desired.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">partitionId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The identifier of the Event Hub partition from which events will be received.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">startingPosition</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The position within the partition where the consumer should begin reading events.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An optional </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">IAsyncEnumerable</span>{<span class="r32 r t">T</span>}<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be used for iterating over events in the partition.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Each reader of events is presented with an independent iterator; if there are multiple readers, each receive their own copy of an event to</span>
        <span class="c">///</span><span class="c">   process, rather than competing for them.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#ed7c7b2bede5a3d1" class="i method">ReadEventsFromPartitionAsync</a>(<b>string</b>, <a href="EventPosition.cs.html#97742fa7b7b6b68f" class="t t">EventPosition</a>, <a href="ReadEventOptions.cs.html#897fd8591f87ab3a" class="t t">ReadEventOptions</a>, <span class="i">CancellationToken</span>)<span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span>
        <b>public virtual</b> <span class="i">IAsyncEnumerable</span>&lt;<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>&gt; <a id="ef001af2fbc41986" href="../R/ef001af2fbc41986.html" target="n" data-glyph="72,1" class="i method">ReadEventsFromPartitionAsync</a>(<b>string</b> <span id="r30 rd" class="r30 r">partitionId</span>,
                                                                                     <a href="EventPosition.cs.html#97742fa7b7b6b68f" class="t t">EventPosition</a> <span id="r31 rd" class="r31 r">startingPosition</span>,
                                                                                     <span class="i">CancellationToken</span> <span id="r29 rd" class="r29 r">cancellationToken</span> = <b>default</b>) =&gt; <a href="#ed7c7b2bede5a3d1" class="i method">ReadEventsFromPartitionAsync</a>(<span class="r30 r">partitionId</span>, <span class="r31 r">startingPosition</span>, <b>null</b>, <span class="r29 r">cancellationToken</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Reads events from the requested partition as an asynchronous enumerable, allowing events to be iterated as they</span>
        <span class="c">///</span><span class="c">   become available on the partition, waiting as necessary should there be no events available.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   This enumerator may block for an indeterminate amount of time for an </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">await</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if events are not available on the partition, requiring</span>
        <span class="c">///</span><span class="c">   cancellation via the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r33 r">cancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be requested in order to return control.  It is recommended to set the</span>
        <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ReadEventOptions.cs.html#897fd8591f87ab3a" class="t t">ReadEventOptions</a>.<a href="ReadEventOptions.cs.html#9787815b907d6173" class="i property">MaximumWaitTime</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> for scenarios where a more deterministic maximum waiting period is desired.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r34 r">partitionId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The identifier of the Event Hub partition from which events will be received.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">startingPosition</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The position within the partition where the consumer should begin reading events.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">readOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The set of options to use for configuring read behavior; if not specified the defaults will be used.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r33 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An optional </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">IAsyncEnumerable</span>{<span class="r37 r t">T</span>}<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be used for iterating over events in the partition.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Each reader of events is presented with an independent iterator; if there are multiple readers, each receive their own copy of an event to</span>
        <span class="c">///</span><span class="c">   process, rather than competing for them.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#ef001af2fbc41986" class="i method">ReadEventsFromPartitionAsync</a>(<b>string</b>, <a href="EventPosition.cs.html#97742fa7b7b6b68f" class="t t">EventPosition</a>, <span class="i">CancellationToken</span>)<span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span>
        <b>public virtual async</b> <span class="i">IAsyncEnumerable</span>&lt;<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>&gt; <a id="ed7c7b2bede5a3d1" href="../R/ed7c7b2bede5a3d1.html" target="n" data-glyph="72,1" class="i method">ReadEventsFromPartitionAsync</a>(<b>string</b> <span id="r34 rd" class="r34 r">partitionId</span>,
                                                                                           <a href="EventPosition.cs.html#97742fa7b7b6b68f" class="t t">EventPosition</a> <span id="r35 rd" class="r35 r">startingPosition</span>,
                                                                                           <a href="ReadEventOptions.cs.html#897fd8591f87ab3a" class="t t">ReadEventOptions</a> <span id="r36 rd" class="r36 r">readOptions</span>,
                                                                                           [<span class="i">EnumeratorCancellation</span>] <span class="i">CancellationToken</span> <span id="r33 rd" class="r33 r">cancellationToken</span> = <b>default</b>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Core/Argument.cs.html#eda8ff4d51bf8b3e" class="i method">AssertNotClosed</a>(<a href="#082cfb4c13909f11" class="i property">IsClosed</a>, <b>nameof</b>(<a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a>));
            <span class="r33 r">cancellationToken</span>.<a href="../SharedSource/Core/CancellationTokenExtensions.cs.html#b1bf96f66d5d14e6" class="i method">ThrowIfCancellationRequested</a>&lt;<span class="i">TaskCanceledException</span>&gt;();
 
            <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#6d81137a1ae4b6c5" class="i method">ReadEventsFromPartitionStart</a>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r34 r">partitionId</span>);
            <span class="r36 r">readOptions</span> = <span class="r36 r">readOptions</span>?.<a href="ReadEventOptions.cs.html#990a338ec3f051ab" class="i method">Clone</a>() ?? <b>new</b> <span class="t">ReadEventOptions</span>();
 
            <a href="../Core/TransportConsumer.cs.html#265a21c281157aa2" class="k">var</a> <span id="r38 rd" class="r38 r">transportConsumer</span> = <b>default</b>(<a href="../Core/TransportConsumer.cs.html#265a21c281157aa2" class="t t">TransportConsumer</a>);
            <a href="PartitionContext.cs.html#224668d23057d29b" class="k">var</a> <span id="r39 rd" class="r39 r">partitionContext</span> = <b>default</b>(<a href="PartitionContext.cs.html#224668d23057d29b" class="t t">PartitionContext</a>);
            <a href="PartitionEvent.cs.html#7f843e772d695dd3" class="k">var</a> <span id="r40 rd" class="r40 r">emptyPartitionEvent</span> = <b>default</b>(<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>);
            <b>var</b> <span id="r41 rd" class="r41 r">closeException</span> = <b>default</b>(<span class="i">Exception</span>);
 
            <b>try</b>
            {
                <span class="c">// Attempt to initialize the common objects. These will be used during the read and emit operations</span>
                <span class="c">// that follow.  Because catch blocks cannot be used when yielding items, this step is wrapped individual</span>
                <span class="c">// to ensure that any exceptions are logged.</span>
 
                <b>try</b>
                {
                    <span class="r38 r">transportConsumer</span> = <a href="#81d26e0ee8a01178" class="i property">Connection</a>.<a href="../EventHubConnection.cs.html#8da5d70f281c7142" class="i method">CreateTransportConsumer</a>(<a href="#143cc18e1538c2ca" class="i property">ConsumerGroup</a>, <span class="r34 r">partitionId</span>, <span class="r35 r">startingPosition</span>, <a href="#165d9d03b0db6635" class="i property">RetryPolicy</a>, <span class="r36 r">readOptions</span>.<a href="ReadEventOptions.cs.html#43c7feb4920f033f" class="i property">TrackLastEnqueuedEventProperties</a>, <span class="r36 r">readOptions</span>.<a href="ReadEventOptions.cs.html#ec8d477d0ce90630" class="i property">OwnerLevel</a>, (<b>uint</b>)<span class="r36 r">readOptions</span>.<a href="ReadEventOptions.cs.html#fb6641616b07a3f8" class="i property">PrefetchCount</a>);
                    <span class="r39 r">partitionContext</span> = <b>new</b> <a href="PartitionContext.cs.html#c1e8ded3a7b6846a" class="t constructor">PartitionContext</a>(<span class="r34 r">partitionId</span>, <span class="r38 r">transportConsumer</span>);
                    <span class="r40 r">emptyPartitionEvent</span> = <b>new</b> <a href="PartitionEvent.cs.html#5faa1f3f4ea021b8" class="t constructor">PartitionEvent</a>(<span class="r39 r">partitionContext</span>, <b>null</b>);
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r42 rd" class="r42 r">ex</span>)
                {
                    <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<span class="i">ReadEventsFromPartitionError</span>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r34 r">partitionId</span>, <span class="r42 r">ex</span>.<span class="i">Message</span>);
                    <b>throw</b>;
                }
 
                <span class="c">// Process items.  Because catch blocks cannot be used when yielding items, ensure that any exceptions during</span>
                <span class="c">// the receive operation are caught in an independent try/catch block.</span>
 
                <b>var</b> <span id="r43 rd" class="r43 r">emptyBatch</span> = <b>true</b>;
                <b>var</b> <span id="r44 rd" class="r44 r">eventBatch</span> = <b>default</b>(<span class="i">IReadOnlyList</span>&lt;<a href="../EventData.cs.html#557aa370d1369b89" class="t t">EventData</a>&gt;);
 
                <b>while</b> (!<span class="r33 r">cancellationToken</span>.<span class="i">IsCancellationRequested</span>)
                {
                    <b>try</b>
                    {
                        <span class="r43 r">emptyBatch</span> = <b>true</b>;
                        <span class="r44 r">eventBatch</span> = <b>await</b> <span class="r38 r">transportConsumer</span>.<a href="../Core/TransportConsumer.cs.html#7a8e7538f82719de" class="i method">ReceiveAsync</a>(<span class="r36 r">readOptions</span>.<a href="ReadEventOptions.cs.html#76f373ffd7175d96" class="i property">CacheEventCount</a>, <span class="r36 r">readOptions</span>.<a href="ReadEventOptions.cs.html#9787815b907d6173" class="i property">MaximumWaitTime</a>, <span class="r33 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                    }
                    <b>catch</b> (<span class="i">TaskCanceledException</span>)
                    {
                        <b>throw</b>;
                    }
                    <b>catch</b> (<span class="i">OperationCanceledException</span> <span id="r45 rd" class="r45 r">ex</span>)
                    {
                        <b>throw</b> <b>new</b> <span class="i">TaskCanceledException</span>(<span class="r45 r">ex</span>.<span class="i">Message</span>, <span class="r45 r">ex</span>);
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r46 rd" class="r46 r">ex</span>)
                    {
                        <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<span class="i">ReadEventsFromPartitionError</span>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r34 r">partitionId</span>, <span class="r46 r">ex</span>.<span class="i">Message</span>);
                        <b>throw</b>;
                    }
 
                    <span class="c">// The batch will be available after the receive operation, regardless of whether there were events</span>
                    <span class="c">// available or not; if there are any events in the set to yield, then mark the batch as non-empty.</span>
 
                    <b>foreach</b> (<b>var</b> <span id="r47 rd" class="r47 r">eventData</span> <b>in</b> <span class="r44 r">eventBatch</span>)
                    {
                        <span class="r33 r">cancellationToken</span>.<a href="../SharedSource/Core/CancellationTokenExtensions.cs.html#b1bf96f66d5d14e6" class="i method">ThrowIfCancellationRequested</a>&lt;<span class="i">TaskCanceledException</span>&gt;();
 
                        <span class="r43 r">emptyBatch</span> = <b>false</b>;
                        <b>yield</b> <b>return</b> <b>new</b> <span class="t">PartitionEvent</span>(<span class="r39 r">partitionContext</span>, <span class="r47 r">eventData</span>);
                    }
 
                    <span class="c">// If there were no events received, only emit an empty event if there was a maximum wait time</span>
                    <span class="c">// explicitly requested, otherwise, continue attempting to receive without emitting any value</span>
                    <span class="c">// to the enumerable.</span>
 
                    <b>if</b> ((<span class="r43 r">emptyBatch</span>) &amp;&amp; (<span class="r36 r">readOptions</span>.<a href="ReadEventOptions.cs.html#9787815b907d6173" class="i property">MaximumWaitTime</a>.<span class="i">HasValue</span>))
                    {
                        <b>yield</b> <b>return</b> <span class="r40 r">emptyPartitionEvent</span>;
                    }
                }
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r38 r">transportConsumer</span> != <b>null</b>)
                {
                    <b>try</b>
                    {
                        <b>await</b> <span class="r38 r">transportConsumer</span>.<span class="i">CloseAsync</span>(<span class="i">CancellationToken</span>.<span class="i">None</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r48 rd" class="r48 r">ex</span>)
                    {
                        <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<span class="i">ReadEventsFromPartitionError</span>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r34 r">partitionId</span>, <span class="r48 r">ex</span>.<span class="i">Message</span>);
                        <span class="r41 r">closeException</span> = <span class="r48 r">ex</span>;
                    }
                }
 
                <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#ac4ca76ceae40a00" class="i method">ReadEventsFromPartitionComplete</a>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r34 r">partitionId</span>);
            }
 
            <span class="c">// If an exception was captured when closing the transport consumer, surface it.</span>
 
            <b>if</b> (<span class="r41 r">closeException</span> != <b>default</b>)
            {
                <span class="i">ExceptionDispatchInfo</span>.<span class="i">Capture</span>(<span class="r41 r">closeException</span>).<span class="i">Throw</span>();
            }
 
            <span class="c">// If cancellation was requested, then surface the expected exception.</span>
 
            <span class="r33 r">cancellationToken</span>.<a href="../SharedSource/Core/CancellationTokenExtensions.cs.html#b1bf96f66d5d14e6" class="i method">ThrowIfCancellationRequested</a>&lt;<span class="i">TaskCanceledException</span>&gt;();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Reads events from all partitions of the event hub as an asynchronous enumerable, allowing events to be iterated as they</span>
        <span class="c">///</span><span class="c">   become available on the partition, waiting as necessary should there be no events available.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   This enumerator may block for an indeterminate amount of time for an </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">await</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if events are not available on the partition, requiring</span>
        <span class="c">///</span><span class="c">   cancellation via the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r49 r">cancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be requested in order to return control.  It is recommended to set the</span>
        <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ReadEventOptions.cs.html#897fd8591f87ab3a" class="t t">ReadEventOptions</a>.<a href="ReadEventOptions.cs.html#9787815b907d6173" class="i property">MaximumWaitTime</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> for scenarios where a more deterministic maximum waiting period is desired.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r49 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An optional </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">IAsyncEnumerable</span>{<span class="r50 r t">T</span>}<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be used for iterating over events in the partition.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   This method is not recommended for production use; the </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">EventProcessorClient</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> should be used for reading events from all partitions in a</span>
        <span class="c">///</span><span class="c">   production scenario, as it offers a much more robust experience with higher throughput.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   It is important to note that this method does not guarantee fairness amongst the partitions during iteration; each of the partitions compete to publish</span>
        <span class="c">///</span><span class="c">   events to be read by the enumerator.  Depending on service communication, there may be a clustering of events per partition and/or there may be a noticeable</span>
        <span class="c">///</span><span class="c">   bias for a given partition or subset of partitions.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   Each reader of events is presented with an independent iterator; if there are multiple readers, each receive their own copy of an event to</span>
        <span class="c">///</span><span class="c">   process, rather than competing for them.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">href</span><span class="c">=</span><span class="c">&quot;</span><span class="c">https://www.nuget.org/packages/Azure.Messaging.EventHubs.Processor</span><span class="c">&quot;</span> <span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#18e64d377def4059" class="i method">ReadEventsAsync</a>(<a href="ReadEventOptions.cs.html#897fd8591f87ab3a" class="t t">ReadEventOptions</a>, <span class="i">CancellationToken</span>)<span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span>
        <b>public virtual</b> <span class="i">IAsyncEnumerable</span>&lt;<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>&gt; <a id="88ee05c1ee53268a" href="../R/88ee05c1ee53268a.html" target="n" data-glyph="72,1" class="i method">ReadEventsAsync</a>(<span class="i">CancellationToken</span> <span id="r49 rd" class="r49 r">cancellationToken</span> = <b>default</b>) =&gt; <a href="#18e64d377def4059" class="i method">ReadEventsAsync</a>(<b>null</b>, <span class="r49 r">cancellationToken</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Reads events from all partitions of the event hub as an asynchronous enumerable, allowing events to be iterated as they</span>
        <span class="c">///</span><span class="c">   become available on the partition, waiting as necessary should there be no events available.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   This enumerator may block for an indeterminate amount of time for an </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">await</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if events are not available on the partition, requiring</span>
        <span class="c">///</span><span class="c">   cancellation via the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r51 r">cancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be requested in order to return control.  It is recommended to set the</span>
        <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ReadEventOptions.cs.html#897fd8591f87ab3a" class="t t">ReadEventOptions</a>.<a href="ReadEventOptions.cs.html#9787815b907d6173" class="i property">MaximumWaitTime</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> for scenarios where a more deterministic maximum waiting period is desired.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r52 r">readOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The set of options to use for configuring read behavior; if not specified the defaults will be used.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r51 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An optional </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">IAsyncEnumerable</span>{<span class="r53 r t">T</span>}<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be used for iterating over events in the partition.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   This method is not recommended for production use; the </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">EventProcessorClient</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> should be used for reading events from all partitions in a</span>
        <span class="c">///</span><span class="c">   production scenario, as it offers a much more robust experience with higher throughput.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   It is important to note that this method does not guarantee fairness amongst the partitions during iteration; each of the partitions compete to publish</span>
        <span class="c">///</span><span class="c">   events to be read by the enumerator.  Depending on service communication, there may be a clustering of events per partition and/or there may be a noticeable</span>
        <span class="c">///</span><span class="c">   bias for a given partition or subset of partitions.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   Each reader of events is presented with an independent iterator; if there are multiple readers, each receive their own copy of an event to</span>
        <span class="c">///</span><span class="c">   process, rather than competing for them.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">href</span><span class="c">=</span><span class="c">&quot;</span><span class="c">https://www.nuget.org/packages/Azure.Messaging.EventHubs.Processor</span><span class="c">&quot;</span> <span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#88ee05c1ee53268a" class="i method">ReadEventsAsync</a>(<span class="i">CancellationToken</span>)<span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span>
        <b>public virtual</b> <span class="i">IAsyncEnumerable</span>&lt;<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>&gt; <a id="18e64d377def4059" href="../R/18e64d377def4059.html" target="n" data-glyph="72,1" class="i method">ReadEventsAsync</a>(<a href="ReadEventOptions.cs.html#897fd8591f87ab3a" class="t t">ReadEventOptions</a> <span id="r52 rd" class="r52 r">readOptions</span>,
                                                                        <span class="i">CancellationToken</span> <span id="r51 rd" class="r51 r">cancellationToken</span> = <b>default</b>) =&gt; <a href="#dff451e8f6048956" class="i method">ReadEventsAsync</a>(<b>true</b>, <span class="r52 r">readOptions</span>, <span class="r51 r">cancellationToken</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Reads events from all partitions of the event hub as an asynchronous enumerable, allowing events to be iterated as they</span>
        <span class="c">///</span><span class="c">   become available on the partition, waiting as necessary should there be no events available.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   This enumerator may block for an indeterminate amount of time for an </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">await</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if events are not available on the partition, requiring</span>
        <span class="c">///</span><span class="c">   cancellation via the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r54 r">cancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be requested in order to return control.  It is recommended to set the</span>
        <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ReadEventOptions.cs.html#897fd8591f87ab3a" class="t t">ReadEventOptions</a>.<a href="ReadEventOptions.cs.html#9787815b907d6173" class="i property">MaximumWaitTime</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> for scenarios where a more deterministic maximum waiting period is desired.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r55 r">startReadingAtEarliestEvent</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> to begin reading at the first events available in each partition; otherwise, reading will begin at the end of each partition seeing only new events as they are published.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r56 r">readOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The set of options to use for configuring read behavior; if not specified the defaults will be used.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r54 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An optional </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">IAsyncEnumerable</span>{<span class="r57 r t">T</span>}<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be used for iterating over events in the partition.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   This method is not recommended for production use; the </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">EventProcessorClient</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> should be used for reading events from all partitions in a</span>
        <span class="c">///</span><span class="c">   production scenario, as it offers a much more robust experience with higher throughput.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   It is important to note that this method does not guarantee fairness amongst the partitions during iteration; each of the partitions competes to publish</span>
        <span class="c">///</span><span class="c">   events to be read by the enumerator.  Depending on service communication, there may be a clustering of events per partition and/or there may be a noticeable</span>
        <span class="c">///</span><span class="c">   bias for a given partition or subset of partitions.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   Each reader of events is presented with an independent iterator; if there are multiple readers, each receive their own copy of an event to</span>
        <span class="c">///</span><span class="c">   process, rather than competing for them.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">href</span><span class="c">=</span><span class="c">&quot;</span><span class="c">https://www.nuget.org/packages/Azure.Messaging.EventHubs.Processor</span><span class="c">&quot;</span> <span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#88ee05c1ee53268a" class="i method">ReadEventsAsync</a>(<span class="i">CancellationToken</span>)<span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#18e64d377def4059" class="i method">ReadEventsAsync</a>(<a href="ReadEventOptions.cs.html#897fd8591f87ab3a" class="t t">ReadEventOptions</a>, <span class="i">CancellationToken</span>)<span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span>
        <b>public virtual async</b> <span class="i">IAsyncEnumerable</span>&lt;<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>&gt; <a id="dff451e8f6048956" href="../R/dff451e8f6048956.html" target="n" data-glyph="72,1" class="i method">ReadEventsAsync</a>(<b>bool</b> <span id="r55 rd" class="r55 r">startReadingAtEarliestEvent</span>,
                                                                              <a href="ReadEventOptions.cs.html#897fd8591f87ab3a" class="t t">ReadEventOptions</a> <span id="r56 rd" class="r56 r">readOptions</span> = <b>default</b>,
                                                                              [<span class="i">EnumeratorCancellation</span>] <span class="i">CancellationToken</span> <span id="r54 rd" class="r54 r">cancellationToken</span> = <b>default</b>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Core/Argument.cs.html#eda8ff4d51bf8b3e" class="i method">AssertNotClosed</a>(<a href="#082cfb4c13909f11" class="i property">IsClosed</a>, <b>nameof</b>(<a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a>));
            <span class="r54 r">cancellationToken</span>.<a href="../SharedSource/Core/CancellationTokenExtensions.cs.html#b1bf96f66d5d14e6" class="i method">ThrowIfCancellationRequested</a>&lt;<span class="i">TaskCanceledException</span>&gt;();
 
            <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#450c7454a5d06625" class="i method">ReadAllEventsStart</a>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>);
 
            <b>var</b> <span id="r58 rd" class="r58 r">cancelPublishingAsync</span> = <b>default</b>(<span class="i">Func</span>&lt;<span class="i">Task</span>&gt;);
            <b>var</b> <span id="r59 rd" class="r59 r">eventChannel</span> = <b>default</b>(<span class="i">Channel</span>&lt;<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>&gt;);
            <b>var</b> <span id="r60 rd" class="r60 r">options</span> = <span class="r56 r">readOptions</span>?.<a href="ReadEventOptions.cs.html#990a338ec3f051ab" class="i method">Clone</a>() ?? <b>new</b> <span class="t">ReadEventOptions</span>();
            <a href="EventPosition.cs.html#97742fa7b7b6b68f" class="k">var</a> <span id="r61 rd" class="r61 r">startingPosition</span> = <span class="r55 r">startReadingAtEarliestEvent</span> ? <a href="EventPosition.cs.html#97742fa7b7b6b68f" class="t t">EventPosition</a>.<a href="EventPosition.cs.html#b013e57545f70f5a" class="i property">Earliest</a> : <a href="EventPosition.cs.html#97742fa7b7b6b68f" class="t t">EventPosition</a>.<a href="EventPosition.cs.html#e9f0512d4e1b5ab4" class="i property">Latest</a>;
 
            <b>using</b> <b>var</b> <span id="r62 rd" class="r62 r">cancellationSource</span> = <span class="i">CancellationTokenSource</span>.<span class="i">CreateLinkedTokenSource</span>(<span class="r54 r">cancellationToken</span>);
 
            <b>try</b>
            {
                <span class="c">// Determine the partitions for the Event Hub and create the shared channel.</span>
 
                <b>var</b> <span id="r63 rd" class="r63 r">partitions</span> = <b>await</b> <a href="#ba8292b55896d4bd" class="i method">GetPartitionIdsAsync</a>(<span class="r54 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                <b>var</b> <span id="r64 rd" class="r64 r">channelSize</span> = <span class="r60 r">options</span>.<span class="i">CacheEventCount</span> * <span class="r63 r">partitions</span>.<span class="i">Length</span> * 2L;
                <span class="r59 r">eventChannel</span> = <a href="#49bb060c74fcf405" class="i method">CreateEventChannel</a>((<b>int</b>)<span class="i">Math</span>.<span class="i">Min</span>(<span class="r64 r">channelSize</span>, <b>int</b>.<span class="i">MaxValue</span>));
 
                <span class="c">// Start publishing for all partitions.</span>
 
                <b>var</b> <span id="r65 rd" class="r65 r">publishingTasks</span> = <b>new</b> <span class="i">Task</span>&lt;<span class="i">Func</span>&lt;<span class="i">Task</span>&gt;&gt;[<span class="r63 r">partitions</span>.<span class="i">Length</span>];
 
                <b>for</b> (<b>var</b> <span id="r66 rd" class="r66 r">index</span> = 0; <span class="r66 r">index</span> &lt; <span class="r63 r">partitions</span>.<span class="i">Length</span>; ++<span class="r66 r">index</span>)
                {
                    <span class="r65 r">publishingTasks</span>[<span class="r66 r">index</span>] = <span class="i">PublishPartitionEventsToChannelAsync</span>(<span class="r63 r">partitions</span>[<span class="r66 r">index</span>], <span class="r61 r">startingPosition</span>, <span class="r60 r">options</span>.<span class="i">TrackLastEnqueuedEventProperties</span>, <span class="r60 r">options</span>.<span class="i">CacheEventCount</span>, <span class="r60 r">options</span>.<span class="i">OwnerLevel</span>, (<b>uint</b>)<span class="r60 r">options</span>.<span class="i">PrefetchCount</span>, <span class="r59 r">eventChannel</span>, <span class="r62 r">cancellationSource</span>);
                }
 
                <span class="c">// Capture the callbacks to cancel publishing for all events.</span>
 
                <b>var</b> <span id="r67 rd" class="r67 r">cancelPublishingCallbacks</span> = <b>await</b> <span class="i">Task</span>.<span class="i">WhenAll</span>(<span class="r65 r">publishingTasks</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                <span class="r58 r">cancelPublishingAsync</span> = () =&gt; <span class="i">Task</span>.<span class="i">WhenAll</span>(<span class="r67 r">cancelPublishingCallbacks</span>.<span class="i">Select</span>(<span id="r68 rd" class="r68 r">cancelCallback</span> =&gt; <span class="r68 r">cancelCallback</span>()));
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r69 rd" class="r69 r">ex</span>)
            {
                <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<span class="i">ReadAllEventsError</span>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r69 r">ex</span>.<span class="i">Message</span>);
                <span class="r62 r">cancellationSource</span>?.<span class="i">Cancel</span>();
 
                <b>if</b> (<span class="r58 r">cancelPublishingAsync</span> != <b>null</b>)
                {
                    <b>await</b> <span class="r58 r">cancelPublishingAsync</span>().<span class="i">ConfigureAwait</span>(<b>false</b>);
                }
 
                <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#61f4ed8a84f8f7de" class="i method">ReadAllEventsComplete</a>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>);
                <b>throw</b>;
            }
 
            <span class="c">// Iterate the events from the channel.</span>
 
            <b>try</b>
            {
                <b>await</b> <b>foreach</b> (<b>var</b> <span id="r70 rd" class="r70 r">partitionEvent</span> <b>in</b> <span class="r59 r">eventChannel</span>.<span class="i">Reader</span>.<span class="i">EnumerateChannel</span>(<span class="r60 r">options</span>.<span class="i">MaximumWaitTime</span>, <span class="r54 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>))
                {
                    <b>yield</b> <b>return</b> <span class="r70 r">partitionEvent</span>;
                }
            }
            <b>finally</b>
            {
                <span class="r62 r">cancellationSource</span>?.<span class="i">Cancel</span>();
                <b>await</b> <span class="r58 r">cancelPublishingAsync</span>().<span class="i">ConfigureAwait</span>(<b>false</b>);
                <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#61f4ed8a84f8f7de" class="i method">ReadAllEventsComplete</a>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>);
            }
 
            <span class="c">// If cancellation was requested, then surface the expected exception.</span>
 
            <span class="r54 r">cancellationToken</span>.<a href="../SharedSource/Core/CancellationTokenExtensions.cs.html#b1bf96f66d5d14e6" class="i method">ThrowIfCancellationRequested</a>&lt;<span class="i">TaskCanceledException</span>&gt;();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Closes the consumer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r71 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An optional </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A task to be resolved on when the operation has completed.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public virtual async</b> <span class="i">Task</span> <a id="e8b7a569e700fb42" href="../R/e8b7a569e700fb42.html" target="n" data-glyph="72,1" class="i method">CloseAsync</a>(<span class="i">CancellationToken</span> <span id="r71 rd" class="r71 r">cancellationToken</span> = <b>default</b>)
        {
            <span class="r71 r">cancellationToken</span>.<a href="../SharedSource/Core/CancellationTokenExtensions.cs.html#b1bf96f66d5d14e6" class="i method">ThrowIfCancellationRequested</a>&lt;<span class="i">TaskCanceledException</span>&gt;();
 
            <b>if</b> (<a href="#082cfb4c13909f11" class="i property">IsClosed</a>)
            {
                <b>return</b>;
            }
 
            <a href="#082cfb4c13909f11" class="i property">IsClosed</a> = <b>true</b>;
 
            <b>var</b> <span id="r72 rd" class="r72 r">clientHash</span> = <a href="#b0f9f98526c05348" class="i method">GetHashCode</a>().<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>);
            <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<span class="i">ClientCloseStart</span>(<b>nameof</b>(<a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a>), <a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r72 r">clientHash</span>);
 
            <span class="c">// Attempt to close the active transport consumers.  In the event that an exception is encountered,</span>
            <span class="c">// it should not impact the attempt to close the connection, assuming ownership.</span>
 
            <b>var</b> <span id="r73 rd" class="r73 r">transportConsumerException</span> = <b>default</b>(<span class="i">Exception</span>);
 
            <b>try</b>
            {
                <b>var</b> <span id="r74 rd" class="r74 r">pendingCloses</span> = <b>new</b> <span class="i">List</span>&lt;<span class="i">Task</span>&gt;();
 
                <b>foreach</b> (<b>var</b> <span id="r75 rd" class="r75 r">consumer</span> <b>in</b> <a href="#c43c2bcac2e2efde" class="i property">ActiveConsumers</a>.<span class="i">Values</span>)
                {
                    <span class="r74 r">pendingCloses</span>.<span class="i">Add</span>(<span class="r75 r">consumer</span>.<span class="i">CloseAsync</span>(<span class="i">CancellationToken</span>.<span class="i">None</span>));
                }
 
                <a href="#c43c2bcac2e2efde" class="i property">ActiveConsumers</a>.<span class="i">Clear</span>();
                <b>await</b> <span class="i">Task</span>.<span class="i">WhenAll</span>(<span class="r74 r">pendingCloses</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r76 rd" class="r76 r">ex</span>)
            {
                <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<span class="i">ClientCloseError</span>(<b>nameof</b>(<a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a>), <a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r72 r">clientHash</span>, <span class="r76 r">ex</span>.<span class="i">Message</span>);
                <span class="r73 r">transportConsumerException</span> = <span class="r76 r">ex</span>;
            }
 
            <span class="c">// An exception when closing the connection supersedes one observed when closing the</span>
            <span class="c">// individual transport clients.</span>
 
            <b>try</b>
            {
                <b>if</b> (<a href="#b41dc27415095f4d" class="i property">OwnsConnection</a>)
                {
                    <b>await</b> <a href="#81d26e0ee8a01178" class="i property">Connection</a>.<span class="i">CloseAsync</span>(<span class="i">CancellationToken</span>.<span class="i">None</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                }
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r77 rd" class="r77 r">ex</span>)
            {
                <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<span class="i">ClientCloseError</span>(<b>nameof</b>(<a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a>), <a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r72 r">clientHash</span>, <span class="r77 r">ex</span>.<span class="i">Message</span>);
                <span class="r73 r">transportConsumerException</span> = <b>null</b>;
                <b>throw</b>;
            }
            <b>finally</b>
            {
                <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<span class="i">ClientCloseComplete</span>(<b>nameof</b>(<a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a>), <a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r72 r">clientHash</span>);
            }
 
            <span class="c">// If there was an active exception pending from closing the individual</span>
            <span class="c">// transport consumers, surface it now.</span>
 
            <b>if</b> (<span class="r73 r">transportConsumerException</span> != <b>default</b>)
            {
                <span class="i">ExceptionDispatchInfo</span>.<span class="i">Capture</span>(<span class="r73 r">transportConsumerException</span>).<span class="i">Throw</span>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Performs the task needed to clean up resources used by the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#f3134c5ddad42173" class="t t">EventHubConsumerClient</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">,</span>
        <span class="c">///</span><span class="c">   including ensuring that the client itself has been closed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A task to be resolved on when the operation has completed.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0002:Ensure all service methods take an optional CancellationToken parameter.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;This signature must match the IAsyncDisposable interface.&quot;</span>)]
        <b>public virtual async</b> <span class="i">ValueTask</span> <a id="0ca8ca99c7d44c2a" href="../R/0ca8ca99c7d44c2a.html" target="n" data-glyph="72,1" class="i method">DisposeAsync</a>()
        {
            <b>await</b> <a href="#e8b7a569e700fb42" class="i method">CloseAsync</a>().<span class="i">ConfigureAwait</span>(<b>false</b>);
            <span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#f3134c5ddad42173" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Determines whether the specified </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">System</span>.<span class="i">Object</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> is equal to this instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r78 r">obj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">System</span>.<span class="i">Object</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> to compare with this instance.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if the specified </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">System</span>.<span class="i">Object</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> is equal to this instance; otherwise, </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        [<span class="i">EditorBrowsable</span>(<span class="i">EditorBrowsableState</span>.<span class="i">Never</span>)]
        <b>public override bool</b> <a id="4880168817ca4ec3" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Equals</a>(<b>object</b> <span id="r78 rd" class="r78 r">obj</span>) =&gt; <b>base</b>.<span class="i">Equals</span>(<span class="r78 r">obj</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Returns a hash code for this instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A hash code for this instance, suitable for use in hashing algorithms and data structures like a hash table.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        [<span class="i">EditorBrowsable</span>(<span class="i">EditorBrowsableState</span>.<span class="i">Never</span>)]
        <b>public override int</b> <a id="b0f9f98526c05348" href="../R/b0f9f98526c05348.html" target="n" data-glyph="72,1" class="i method">GetHashCode</a>() =&gt; <b>base</b>.<span class="i">GetHashCode</span>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Converts the instance to string representation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">System</span>.<span class="i">String</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> that represents this instance.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        [<span class="i">EditorBrowsable</span>(<span class="i">EditorBrowsableState</span>.<span class="i">Never</span>)]
        <b>public override string</b> <a id="d7d00ffb5fe6730b" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ToString</a>() =&gt; <b>base</b>.<span class="i">ToString</span>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Publishes events for the requested </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r79 r">partitionId</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to the provided</span>
        <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r80 r">channel</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> in the background, using a dedicated transport consumer</span>
        <span class="c">///</span><span class="c">   instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r79 r">partitionId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The identifier of the partition from which events should be read.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r81 r">startingPosition</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The position within the partition&#39;s event stream that reading should begin from.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r82 r">trackLastEnqueuedEventProperties</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Indicates whether information on the last enqueued event on the partition is sent as events are received.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r83 r">receiveBatchSize</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The batch size to use when receiving events.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r84 r">ownerLevel</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The relative priority to associate with the link; for a non-exclusive link, this value should be </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">null</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r85 r">prefetchCount</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The count of events requested eagerly and queued without regard to whether a read was requested.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r80 r">channel</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The channel to which events should be published.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r86 r">publishingCancellationSource</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A cancellation source which can be used for signaling publication to stop.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A function to invoke when publishing should stop; once complete, background publishing is no longer taking place and the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r80 r">channel</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> has been marked as final.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   This method assumes co-ownership of the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r80 r">channel</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">, marking its writer as completed</span>
        <span class="c">///</span><span class="c">   when publishing is complete or when an exception is encountered.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>private async</b> <span class="i">Task</span>&lt;<span class="i">Func</span>&lt;<span class="i">Task</span>&gt;&gt; <a id="9a81ae3f2a821b9b" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">PublishPartitionEventsToChannelAsync</a>(<b>string</b> <span id="r79 rd" class="r79 r">partitionId</span>,
                                                                            <a href="EventPosition.cs.html#97742fa7b7b6b68f" class="t t">EventPosition</a> <span id="r81 rd" class="r81 r">startingPosition</span>,
                                                                            <b>bool</b> <span id="r82 rd" class="r82 r">trackLastEnqueuedEventProperties</span>,
                                                                            <b>int</b> <span id="r83 rd" class="r83 r">receiveBatchSize</span>,
                                                                            <b>long</b>? <span id="r84 rd" class="r84 r">ownerLevel</span>,
                                                                            <b>uint</b> <span id="r85 rd" class="r85 r">prefetchCount</span>,
                                                                            <span class="i">Channel</span>&lt;<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>&gt; <span id="r80 rd" class="r80 r">channel</span>,
                                                                            <span class="i">CancellationTokenSource</span> <span id="r86 rd" class="r86 r">publishingCancellationSource</span>)
        {
            <span class="r86 r">publishingCancellationSource</span>.<span class="i">Token</span>.<span class="i">ThrowIfCancellationRequested</span>&lt;<span class="i">TaskCanceledException</span>&gt;();
            <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#06a686b4e8c8de61" class="i method">PublishPartitionEventsToChannelStart</a>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r79 r">partitionId</span>);
 
            <a href="../Core/TransportConsumer.cs.html#265a21c281157aa2" class="k">var</a> <span id="r87 rd" class="r87 r">transportConsumer</span> = <b>default</b>(<a href="../Core/TransportConsumer.cs.html#265a21c281157aa2" class="t t">TransportConsumer</a>);
            <b>var</b> <span id="r88 rd" class="r88 r">publishingTask</span> = <b>default</b>(<span class="i">Task</span>);
            <b>var</b> <span id="r89 rd" class="r89 r">observedException</span> = <b>default</b>(<span class="i">Exception</span>);
            <b>var</b> <span id="r90 rd" class="r90 r">publisherId</span> = <span class="i">Guid</span>.<span class="i">NewGuid</span>().<span class="i">ToString</span>();
 
            <span class="c">// Termination must take place in multiple places due to the a catch block being</span>
            <span class="c">// disallowed with the use of &quot;yield return&quot;.  Create a local function that encapsulates</span>
            <span class="c">// the cleanup tasks needed.</span>
 
            <b>async</b> <span class="i">Task</span> <a id="b1a3c7f5c7d80612" href="../R/b1a3c7f5c7d80612.html" target="n" data-glyph="76,2" class="i method">performCleanup</a>()
            {
                <span class="r86 r">publishingCancellationSource</span>?.<span class="i">Cancel</span>();
 
                <b>if</b> (<span class="r88 r">publishingTask</span> != <b>null</b>)
                {
                    <b>try</b>
                    {
                        <b>await</b> <span class="r88 r">publishingTask</span>.<span class="i">ConfigureAwait</span>(<b>false</b>);
                        <span class="r80 r">channel</span>.<span class="i">Writer</span>.<span class="i">TryComplete</span>();
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r91 rd" class="r91 r">ex</span>) <b>when</b> ((<span class="r91 r">ex</span> <b>is</b> <span class="i">TaskCanceledException</span>) || (<span class="r91 r">ex</span> <b>is</b> <span class="i">ChannelClosedException</span>))
                    {
                        <span class="c">// Due to the non-determinism when requesting cancellation of the background</span>
                        <span class="c">// publishing, it may surface as the expected cancellation or may result in</span>
                        <span class="c">// an attempt to write to the shared channel after another publisher has</span>
                        <span class="c">// marked it as final.</span>
                        <span class="c">//</span>
                        <span class="c">// These are expected scenarios; no action is needed.</span>
                    }
                }
 
                <b>if</b> (<span class="r87 r">transportConsumer</span> != <b>null</b>)
                {
                    <a href="#c43c2bcac2e2efde" class="i property">ActiveConsumers</a>.<span class="i">TryRemove</span>(<span class="r90 r">publisherId</span>, <b>out</b> <b>var</b> <b>_</b>);
                    <b>await</b> <span class="r87 r">transportConsumer</span>.<span class="i">CloseAsync</span>(<span class="i">CancellationToken</span>.<span class="i">None</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                }
 
                <b>try</b>
                {
                    <b>if</b> (<span class="r89 r">observedException</span> != <b>default</b>)
                    {
                        <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<span class="i">PublishPartitionEventsToChannelError</span>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r79 r">partitionId</span>, <span class="r89 r">observedException</span>.<span class="i">Message</span>);
                        <span class="i">ExceptionDispatchInfo</span>.<span class="i">Capture</span>(<span class="r89 r">observedException</span>).<span class="i">Throw</span>();
                    }
                }
                <b>finally</b>
                {
                    <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#2970bfa712d5bbd2" class="i method">PublishPartitionEventsToChannelComplete</a>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r79 r">partitionId</span>);
                }
            }
 
            <span class="c">// Setup the publishing context and begin publishing to the channel in the background.</span>
 
            <b>try</b>
            {
                <span class="r87 r">transportConsumer</span> = <a href="#81d26e0ee8a01178" class="i property">Connection</a>.<a href="../EventHubConnection.cs.html#8da5d70f281c7142" class="i method">CreateTransportConsumer</a>(<a href="#143cc18e1538c2ca" class="i property">ConsumerGroup</a>, <span class="r79 r">partitionId</span>, <span class="r81 r">startingPosition</span>, <a href="#165d9d03b0db6635" class="i property">RetryPolicy</a>, <span class="r82 r">trackLastEnqueuedEventProperties</span>, <span class="r84 r">ownerLevel</span>, <span class="r85 r">prefetchCount</span>);
 
                <b>if</b> (!<a href="#c43c2bcac2e2efde" class="i property">ActiveConsumers</a>.<span class="i">TryAdd</span>(<span class="r90 r">publisherId</span>, <span class="r87 r">transportConsumer</span>))
                {
                    <b>await</b> <span class="r87 r">transportConsumer</span>.<span class="i">CloseAsync</span>(<span class="i">CancellationToken</span>.<span class="i">None</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                    <span class="r87 r">transportConsumer</span> = <b>null</b>;
                    <b>throw</b> <b>new</b> <span class="t">EventHubsException</span>(<b>false</b>, <a href="#4ed514492b08d276" class="i property">EventHubName</a>, <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <a href="../Resources.Designer.cs.html#0f60eafa1a3b4f36" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#81c153490d3bfa70" class="i property">FailedToCreateReader</a>, <a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r79 r">partitionId</span>, <a href="#143cc18e1538c2ca" class="i property">ConsumerGroup</a>));
                }
 
                <b>void</b> <a id="fbb6b7d928bbd564" href="../R/../../0000000000.html" target="n" data-glyph="76,2" class="i method">exceptionCallback</a>(<span class="i">Exception</span> <span id="r92 rd" class="r92 r">ex</span>)
                {
                    <span class="c">// Ignore the known exception cases that present during cancellation across</span>
                    <span class="c">// background publishing for multiple partitions.</span>
 
                    <b>if</b> ((<span class="r92 r">ex</span> <b>is</b> <span class="i">ChannelClosedException</span>) || (<span class="r92 r">ex</span> <b>is</b> <span class="i">TaskCanceledException</span>))
                    {
                        <b>return</b>;
                    }
 
                    <span class="r89 r">observedException</span> = <span class="r92 r">ex</span>;
                }
 
                <span class="r88 r">publishingTask</span> = <span class="i">StartBackgroundChannelPublishingAsync</span>
                (
                    <span class="r87 r">transportConsumer</span>,
                    <span class="r80 r">channel</span>,
                    <b>new</b> <a href="PartitionContext.cs.html#c1e8ded3a7b6846a" class="t constructor">PartitionContext</a>(<span class="r79 r">partitionId</span>, <span class="r87 r">transportConsumer</span>),
                    <span class="r83 r">receiveBatchSize</span>,
                    <span class="i">exceptionCallback</span>,
                    <span class="r86 r">publishingCancellationSource</span>.<span class="i">Token</span>
                );
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r93 rd" class="r93 r">ex</span>)
            {
                <a href="../Diagnostics/EventHubsEventSource.cs.html#88bca2b6f3cfd5f2" class="t t">EventHubsEventSource</a>.<a href="../Diagnostics/EventHubsEventSource.cs.html#c960e5896e4dd589" class="i property">Log</a>.<span class="i">PublishPartitionEventsToChannelError</span>(<a href="#4ed514492b08d276" class="i property">EventHubName</a>, <span class="r79 r">partitionId</span>, <span class="r93 r">ex</span>.<span class="i">Message</span>);
                <b>await</b> <a href="#b1a3c7f5c7d80612" class="i method">performCleanup</a>().<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                <b>throw</b>;
            }
 
            <b>return</b> <span class="i">performCleanup</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Begins the background process responsible for receiving from the specified </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Core/TransportConsumer.cs.html#265a21c281157aa2" class="t t">TransportConsumer</a><span class="c">&quot;</span> <span class="c">/&gt;</span>
        <span class="c">///</span><span class="c">   and publishing to the requested </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">Channel</span>{<span class="r94 r t">PartitionEvent</span>}<span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r95 r">transportConsumer</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The consumer to use for receiving events.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r96 r">channel</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The channel to which received events should be published.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r97 r">partitionContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The context that represents the partition from which events being received.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r98 r">receiveBatchSize</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The batch size to use when receiving events.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r99 r">notifyException</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An action to be invoked when an exception is encountered during publishing.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r100 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to signal the request to cancel the background publishing.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A task to be resolved on when the operation has completed.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>private</b> <span class="i">Task</span> <a id="ea049699c7ddaa17" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">StartBackgroundChannelPublishingAsync</a>(<a href="../Core/TransportConsumer.cs.html#265a21c281157aa2" class="t t">TransportConsumer</a> <span id="r95 rd" class="r95 r">transportConsumer</span>,
                                                           <span class="i">Channel</span>&lt;<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>&gt; <span id="r96 rd" class="r96 r">channel</span>,
                                                           <a href="PartitionContext.cs.html#224668d23057d29b" class="t t">PartitionContext</a> <span id="r97 rd" class="r97 r">partitionContext</span>,
                                                           <b>int</b> <span id="r98 rd" class="r98 r">receiveBatchSize</span>,
                                                           <span class="i">Action</span>&lt;<span class="i">Exception</span>&gt; <span id="r99 rd" class="r99 r">notifyException</span>,
                                                           <span class="i">CancellationToken</span> <span id="r100 rd" class="r100 r">cancellationToken</span>) =&gt;
            <span class="i">Task</span>.<span class="i">Run</span>(<b>async</b> () =&gt;
            {
                <b>var</b> <span id="r101 rd" class="r101 r">failedAttemptCount</span> = 0;
                <b>var</b> <span id="r102 rd" class="r102 r">writtenItems</span> = 0;
                <b>var</b> <span id="r103 rd" class="r103 r">receivedItems</span> = <b>default</b>(<span class="i">IReadOnlyList</span>&lt;<a href="../EventData.cs.html#557aa370d1369b89" class="t t">EventData</a>&gt;);
                <b>var</b> <span id="r104 rd" class="r104 r">retryDelay</span> = <b>default</b>(<span class="i">TimeSpan</span>?);
                <b>var</b> <span id="r105 rd" class="r105 r">activeException</span> = <b>default</b>(<span class="i">Exception</span>);
 
                <b>while</b> (!<span class="r100 r">cancellationToken</span>.<span class="i">IsCancellationRequested</span>)
                {
                    <b>try</b>
                    {
                        <span class="c">// Receive items in batches and then write them to the subscribed channels.  The channels will naturally</span>
                        <span class="c">// block if they reach their maximum queue size, so there is no need to throttle publishing.</span>
 
                        <b>if</b> (<span class="r103 r">receivedItems</span> == <b>default</b>)
                        {
                            <span class="r103 r">receivedItems</span> = <b>await</b> <span class="r95 r">transportConsumer</span>.<span class="i">ReceiveAsync</span>(<span class="r98 r">receiveBatchSize</span>, <a href="#5a47c8f6b37fd141" class="i field">BackgroundPublishingWaitTime</a>, <span class="r100 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                        }
 
                        <b>foreach</b> (<a href="../EventData.cs.html#557aa370d1369b89" class="t t">EventData</a> <span id="r106 rd" class="r106 r">item</span> <b>in</b> <span class="r103 r">receivedItems</span>)
                        {
                            <b>await</b> <span class="r96 r">channel</span>.<span class="i">Writer</span>.<span class="i">WriteAsync</span>(<b>new</b> <a href="PartitionEvent.cs.html#5faa1f3f4ea021b8" class="t constructor">PartitionEvent</a>(<span class="r97 r">partitionContext</span>, <span class="r106 r">item</span>), <span class="r100 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                            ++<span class="r102 r">writtenItems</span>;
                        }
 
                        <span class="r103 r">receivedItems</span> = <b>default</b>;
                        <span class="r102 r">writtenItems</span> = 0;
                        <span class="r101 r">failedAttemptCount</span> = 0;
                    }
                    <b>catch</b> (<span class="i">TaskCanceledException</span> <span id="r107 rd" class="r107 r">ex</span>)
                    {
                        <span class="c">// In the case that a task was canceled, if cancellation was requested, then publishing should</span>
                        <span class="c">// is already terminating.  Otherwise, something unexpected canceled the operation and it should</span>
                        <span class="c">// be treated as an exception to ensure that the channels are marked final and consumers are made</span>
                        <span class="c">// aware.</span>
 
                        <span class="r105 r">activeException</span> = (<span class="r100 r">cancellationToken</span>.<span class="i">IsCancellationRequested</span>) ? <b>null</b> : <span class="r107 r">ex</span>;
                        <b>break</b>;
                    }
                    <b>catch</b> (<span class="i">OperationCanceledException</span> <span id="r108 rd" class="r108 r">ex</span>)
                    {
                        <span class="r105 r">activeException</span> = <b>new</b> <span class="i">TaskCanceledException</span>(<span class="r108 r">ex</span>.<span class="i">Message</span>, <span class="r108 r">ex</span>);
                        <b>break</b>;
                    }
                    <b>catch</b> (<a href="../EventHubsException.cs.html#fe9b3d9ffc64177d" class="t t">EventHubsException</a> <span id="r109 rd" class="r109 r">ex</span>) <b>when</b>
                        (<span class="r109 r">ex</span>.<a href="../EventHubsException.cs.html#efdefeb5416905cd" class="i property">Reason</a> == <a href="../EventHubsException.cs.html#fe9b3d9ffc64177d" class="t t">EventHubsException</a>.<a href="../EventHubsException.cs.html#e5210b418cdfe2fd" class="t t">FailureReason</a>.<a href="../EventHubsException.cs.html#491dc70ef31d93b8" class="i field">ConsumerDisconnected</a>
                        || <span class="r109 r">ex</span>.<a href="../EventHubsException.cs.html#efdefeb5416905cd" class="i property">Reason</a> == <a href="../EventHubsException.cs.html#fe9b3d9ffc64177d" class="t t">EventHubsException</a>.<a href="../EventHubsException.cs.html#e5210b418cdfe2fd" class="t t">FailureReason</a>.<a href="../EventHubsException.cs.html#6a47ff45e3ab3874" class="i field">ClientClosed</a>)
                    {
                        <span class="c">// If the consumer was disconnected or closed, it is known to be unrecoverable; do not offer the chance to retry.</span>
 
                        <span class="r105 r">activeException</span> = <span class="r109 r">ex</span>;
                        <b>break</b>;
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r110 rd" class="r110 r">ex</span>) <b>when</b> (<span class="r110 r">ex</span>.<a href="../Core/ExceptionExtensions.cs.html#41fdeb8347fb2f2f" class="i method">IsFatalException</a>())
                    {
                        <span class="r96 r">channel</span>.<span class="i">Writer</span>.<span class="i">TryComplete</span>(<span class="r110 r">ex</span>);
                        <b>throw</b>;
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r111 rd" class="r111 r">ex</span>)
                    {
                        <span class="c">// Determine if there should be a retry for the next attempt; if so enforce the delay but do not quit the loop.</span>
                        <span class="c">// Otherwise, mark the exception as active and break out of the loop.</span>
 
                        ++<span class="r101 r">failedAttemptCount</span>;
                        <span class="r104 r">retryDelay</span> = <a href="#165d9d03b0db6635" class="i property">RetryPolicy</a>.<a href="../EventHubsRetryPolicy.cs.html#349133cec7633979" class="i method">CalculateRetryDelay</a>(<span class="r111 r">ex</span>, <span class="r101 r">failedAttemptCount</span>);
 
                        <b>if</b> (<span class="r104 r">retryDelay</span>.<span class="i">HasValue</span>)
                        {
                            <span class="c">// If items were being emitted at the time of the exception, skip to the</span>
                            <span class="c">// last active item that was published to the channel so that publishing</span>
                            <span class="c">// resumes at the next event in sequence and duplicates are not written.</span>
 
                            <b>if</b> ((<span class="r103 r">receivedItems</span> != <b>default</b>) &amp;&amp; (<span class="r102 r">writtenItems</span> &gt; 0))
                            {
                                <span class="r103 r">receivedItems</span> = <span class="r103 r">receivedItems</span>.<span class="i">Skip</span>(<span class="r102 r">writtenItems</span>).<span class="i">ToList</span>();
                            }
 
                            <b>await</b> <span class="i">Task</span>.<span class="i">Delay</span>(<span class="r104 r">retryDelay</span>.<span class="i">Value</span>, <span class="r100 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                            <span class="r105 r">activeException</span> = <b>null</b>;
                        }
                        <b>else</b>
                        {
                            <span class="r105 r">activeException</span> = <span class="r111 r">ex</span>;
                            <b>break</b>;
                        }
                    }
                }
 
                <span class="c">// Publishing has terminated; if there was an active exception, then take the necessary steps to mark publishing as aborted rather</span>
                <span class="c">// than completed normally.</span>
 
                <b>if</b> (<span class="r105 r">activeException</span> != <b>null</b>)
                {
                    <span class="r96 r">channel</span>.<span class="i">Writer</span>.<span class="i">TryComplete</span>(<span class="r105 r">activeException</span>);
                    <span class="r99 r">notifyException</span>(<span class="r105 r">activeException</span>);
                }
            }, <span class="r100 r">cancellationToken</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Creates a channel for publishing events to local subscribers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r112 r">capacity</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The maximum amount of events that can be queued in the channel.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A bounded channel, configured for 1:many read/write usage.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>private static</b> <span class="i">Channel</span>&lt;<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>&gt; <a id="49bb060c74fcf405" href="../R/49bb060c74fcf405.html" target="n" data-glyph="76,1" class="i method">CreateEventChannel</a>(<b>int</b> <span id="r112 rd" class="r112 r">capacity</span>) =&gt;
            <span class="i">Channel</span>.<span class="i">CreateBounded</span>&lt;<a href="PartitionEvent.cs.html#7f843e772d695dd3" class="t t">PartitionEvent</a>&gt;(<b>new</b> <span class="i">BoundedChannelOptions</span>(<span class="r112 r">capacity</span>)
            {
                <span class="i">FullMode</span> = <span class="i">BoundedChannelFullMode</span>.<span class="i">Wait</span>,
                <span class="i">SingleWriter</span> = <b>false</b>,
                <span class="i">SingleReader</span> = <b>true</b>
            });
    }
}
</pre></td></tr></table></div></body></html>
