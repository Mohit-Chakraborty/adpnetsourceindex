<!DOCTYPE html>
<html><head><title>StorageTestBase.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(551);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Storage.Blobs.ChangeFeed.Tests/Shared/StorageTestBase.cs" target="_top">Shared\StorageTestBase.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Storage.Blobs.ChangeFeed.Tests" target="_top">Azure.Storage.Blobs.ChangeFeed.Tests.csproj</a> (Azure.Storage.Blobs.ChangeFeed.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Net</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Net</span>.<span class="i n">Http</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">Pipeline</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">TestFramework</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Identity</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Sas</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Tests</span>.<span class="i n">Shared</span>;
<b>using</b> <span class="i n">NUnit</span>.<span class="i n">Framework</span>;
 
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">SA1402</span> <span class="c">// File may only contain a single type</span>
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Test</span>.<span class="i n">Shared</span>
{
    <b>public abstract class</b> <a id="4cf3a44c88ec627c" href="../R/4cf3a44c88ec627c.html" target="n" data-glyph="0,0" class="t t">StorageTestBase</a> : <a href="/Azure.Core.TestFramework/A.html#37d56504090a0d7b" class="t t">RecordedTestBase</a>
    {
        <b>static</b> <a id="fa55cb8c7f1881e4" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">StorageTestBase</a>()
        {
            <span class="c">// .NET framework defaults to 2, which causes issues for the parallel upload/download tests. Go out of bound like .NET Core does.</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">NETCOREAPP</span>
            <a href="@0@System/A.html#86ab68f9e9462330" class="t t">ServicePointManager</a>.<a href="@0@System/A.html#4a219b1bfef6af65" class="i property">DefaultConnectionLimit</a> = <b>int</b>.<a href="@0@mscorlib/A.html#c45153c0501d7122" class="i field">MaxValue</a>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <span class="c">// To avoid threadpool starvation when we run live tests in parallel.</span>
            <a href="@0@mscorlib/A.html#8449b4bfef11bfa3" class="t t">ThreadPool</a>.<a href="@0@mscorlib/A.html#f94313747d0456f8" class="i method">SetMinThreads</a>(100, 100);
        }
 
        <b>public</b> <a id="9a40ee544017b0f7" href="../R/9a40ee544017b0f7.html" target="n" data-glyph="72,1" class="t constructor">StorageTestBase</a>(<b>bool</b> <span id="r0 rd" class="r0 r">async</span>, <a href="/Azure.Core.TestFramework/A.html#d7d5cc97dd76217f" class="t t">RecordedTestMode</a>? <span id="r1 rd" class="r1 r">mode</span> = <b>null</b>)
            : <a href="/Azure.Core.TestFramework/A.html#1dd772f5a68378bc" class="k">base</a>(<span class="r0 r">async</span>, <span class="r1 r">mode</span> ?? <a href="/Azure.Core.TestFramework/A.html#690df1c0bd3cbc0b" class="t t">RecordedTestUtilities</a>.<a href="/Azure.Core.TestFramework/A.html#2e41f249ca30b26e" class="i method">GetModeFromEnvironment</a>())
        {
            <a href="/Azure.Core.TestFramework/A.html#2800a862b6d5bdce" class="i property">Sanitizer</a> = <b>new</b> <a href="StorageRecordedTestSanitizer.cs.html#9f964b528d7d5ce0" class="t constructor">StorageRecordedTestSanitizer</a>();
            <a href="/Azure.Core.TestFramework/A.html#3d05f3daa03d7f89" class="i property">Matcher</a> = <b>new</b> <a href="StorageRecordMatcher.cs.html#672df0029fcde296" class="t constructor">StorageRecordMatcher</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the tenant to use by default for our tests.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <a id="7f0dfee92e48882d" href="../R/7f0dfee92e48882d.html" target="n" data-glyph="102,1" class="i property">TestConfigDefault</a> =&gt; <a href="#a217723f2d0b8e06" class="i method">GetTestConfig</a>(
                <span class="s">&quot;Storage_TestConfigDefault&quot;</span>,
                () =&gt; <a href="TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="TestConfigurations.cs.html#de1cfb0ab2714ebc" class="i property">DefaultTargetTenant</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the tenant to use for any tests that require Read Access</span>
        <span class="c">///</span><span class="c"> Geo-Redundant Storage to be setup.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <a id="2e8d6507934ce06d" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">TestConfigSecondary</a> =&gt; <a href="#a217723f2d0b8e06" class="i method">GetTestConfig</a>(
                <span class="s">&quot;Storage_TestConfigSecondary&quot;</span>,
                () =&gt; <a href="TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="TestConfigurations.cs.html#feffc9bc1860e759" class="i property">DefaultSecondaryTargetTenant</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the tenant to use for any tests that require Premium SSDs.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <a id="6047bcc369bb47d3" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">TestConfigPremiumBlob</a> =&gt; <a href="#a217723f2d0b8e06" class="i method">GetTestConfig</a>(
                <span class="s">&quot;Storage_TestConfigPremiumBlob&quot;</span>,
                () =&gt; <a href="TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="TestConfigurations.cs.html#8b5972f8c7f9f810" class="i property">DefaultTargetPremiumBlobTenant</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the tenant to use for any tests that require preview features.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <a id="80479c5b87716aeb" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">TestConfigPreviewBlob</a> =&gt; <a href="#a217723f2d0b8e06" class="i method">GetTestConfig</a>(
                <span class="s">&quot;Storage_TestConfigPreviewBlob&quot;</span>,
                () =&gt; <a href="TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="TestConfigurations.cs.html#26ca17c08deb6203" class="i property">DefaultTargetPreviewBlobTenant</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the tenant to use for any tests that require authentication</span>
        <span class="c">///</span><span class="c"> with Azure AD.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <a id="73d6cc93aeb0f3a9" href="../R/73d6cc93aeb0f3a9.html" target="n" data-glyph="102,1" class="i property">TestConfigOAuth</a> =&gt; <a href="#a217723f2d0b8e06" class="i method">GetTestConfig</a>(
                <span class="s">&quot;Storage_TestConfigOAuth&quot;</span>,
                () =&gt; <a href="TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="TestConfigurations.cs.html#99e6fd959b52df5b" class="i property">DefaultTargetOAuthTenant</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the tenant to use for any tests that require authentication</span>
        <span class="c">///</span><span class="c"> with Azure AD.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <a id="6614def632ace15e" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">TestConfigHierarchicalNamespace</a> =&gt; <a href="#a217723f2d0b8e06" class="i method">GetTestConfig</a>(
                <span class="s">&quot;Storage_TestConfigHierarchicalNamespace&quot;</span>,
                () =&gt; <a href="TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="TestConfigurations.cs.html#c214e3ec17dfa9fe" class="i property">DefaultTargetHierarchicalNamespaceTenant</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the tenant to use for any tests that require authentication</span>
        <span class="c">///</span><span class="c"> with Azure AD.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <a id="0de8dc10c2d14d94" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">TestConfigManagedDisk</a> =&gt; <a href="#a217723f2d0b8e06" class="i method">GetTestConfig</a>(
                <span class="s">&quot;Storage_TestConfigManagedDisk&quot;</span>,
                () =&gt; <a href="TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="TestConfigurations.cs.html#5923b6fe9ee27d19" class="i property">DefaultTargetManagedDiskTenant</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the tenant to use for any tests that require authentication</span>
        <span class="c">///</span><span class="c"> with Azure AD.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <a id="08b9c8b49e6f2091" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">TestConfigSoftDelete</a> =&gt; <a href="#a217723f2d0b8e06" class="i method">GetTestConfig</a>(
                <span class="s">&quot;Storage_TestConfigSoftDelete&quot;</span>,
                () =&gt; <a href="TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="TestConfigurations.cs.html#62edb02a7432aa44" class="i property">DefaultTargetSoftDeleteTenant</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the tenant to use for any tests premium files.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <a id="cbd622269a97d420" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">TestConfigPremiumFile</a> =&gt; <a href="#a217723f2d0b8e06" class="i method">GetTestConfig</a>(
                <span class="s">&quot;Storage_TestConfigPremiumFile&quot;</span>,
                () =&gt; <a href="TestConfigurations.cs.html#09c438cc2df2e17f" class="t t">TestConfigurations</a>.<a href="TestConfigurations.cs.html#723d27e52ecc6e05" class="i property">DefaultPremiumFileTenant</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a cache used for storing serialized tenant configurations.  Do</span>
        <span class="c">///</span><span class="c"> not get values from this directly; use GetTestConfig.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <a id="932e84fe45ebc585" href="../R/932e84fe45ebc585.html" target="n" data-glyph="46,1" class="i field">_recordingConfigCache</a> =
            <b>new</b> <a href="@0@mscorlib/A.html#bf6849e410b43c4c" class="t constructor">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a cache used for storing deserialized tenant configurations.</span>
        <span class="c">///</span><span class="c"> Do not get values from this directly; use GetTestConfig.</span>
        <b>private readonly</b> <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a>&gt; <a id="7291c319d5d89554" href="../R/7291c319d5d89554.html" target="n" data-glyph="46,1" class="i field">_playbackConfigCache</a> =
            <b>new</b> <a href="@0@mscorlib/A.html#bf6849e410b43c4c" class="t constructor">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> We need to clear the playback cache before every test because</span>
        <span class="c">///</span><span class="c"> different recordings might have used different tenant</span>
        <span class="c">///</span><span class="c"> configurations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">SetUp</span>]
        <b>public virtual void</b> <a id="27f3602e7c9048b6" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ClearCaches</a>() =&gt;
            <a href="#7291c319d5d89554" class="i field">_playbackConfigCache</a>.<a href="@0@mscorlib/A.html#36b30e4c0708a88c" class="i method">Clear</a>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get or create a test configuration tenant to use with our tests.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> If we&#39;re recording, we&#39;ll save a sanitized version of the test</span>
        <span class="c">///</span><span class="c"> configuarion.  If we&#39;re playing recorded tests, we&#39;ll use the</span>
        <span class="c">///</span><span class="c"> serialized test configuration.  If we&#39;re running the tests live,</span>
        <span class="c">///</span><span class="c"> we&#39;ll just return the value.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> While we cache things internally, DO NOT cache them elsewhere</span>
        <span class="c">///</span><span class="c"> because we need each test to have its configuration recorded.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the session record variable.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">getTenant</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A function to get the tenant.  This is wrapped in a Func becuase</span>
        <span class="c">///</span><span class="c"> we&#39;ll throw Assert.Inconclusive if you try to access a tenant with</span>
        <span class="c">///</span><span class="c"> an invalid config file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A test tenant to use with our tests.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <a id="a217723f2d0b8e06" href="../R/a217723f2d0b8e06.html" target="n" data-glyph="76,1" class="i method">GetTestConfig</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r2 rd" class="r2 r">name</span>, <a href="@0@mscorlib/A.html#87d60abb7092d5a4" class="t t">Func</a>&lt;<a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a>&gt; <span id="r3 rd" class="r3 r">getTenant</span>)
        {
            <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <span id="r4 rd" class="r4 r">config</span>;
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r5 rd" class="r5 r">text</span>;
            <b>switch</b> (<a href="/Azure.Core.TestFramework/A.html#eb077c11a09b6b1e" class="i property">Mode</a>)
            {
                <b>case</b> <a href="/Azure.Core.TestFramework/A.html#d7d5cc97dd76217f" class="t t">RecordedTestMode</a>.<a href="/Azure.Core.TestFramework/A.html#bde4663b03b59b85" class="i field">Playback</a>:
                    <b>if</b> (!<a href="#7291c319d5d89554" class="i field">_playbackConfigCache</a>.<a href="@0@mscorlib/A.html#2e5bc6d8c0f21e67" class="i method">TryGetValue</a>(<span class="r2 r">name</span>, <b>out</b> <span class="r4 r">config</span>))
                    {
                        <span class="r5 r">text</span> = <a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#c25963307db75929" class="i method">GetVariable</a>(<span class="r2 r">name</span>, <b>null</b>);
                        <span class="r4 r">config</span> = <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a>.<a href="TenantConfiguration.cs.html#d419a315278535a6" class="i method">Parse</a>(<span class="r5 r">text</span>);
                        <a href="#7291c319d5d89554" class="i field">_playbackConfigCache</a><a href="@0@mscorlib/A.html#49962975508e2d83">[</a><span class="r2 r">name</span>] = <span class="r4 r">config</span>;
                    }
                    <b>break</b>;
                <b>case</b> <a href="/Azure.Core.TestFramework/A.html#d7d5cc97dd76217f" class="t t">RecordedTestMode</a>.<a href="/Azure.Core.TestFramework/A.html#62f98a4a2b1d56c3" class="i field">Record</a>:
                    <span class="r4 r">config</span> = <span class="r3 r">getTenant</span>();
                    <b>if</b> (!<a href="#932e84fe45ebc585" class="i field">_recordingConfigCache</a>.<a href="@0@mscorlib/A.html#2e5bc6d8c0f21e67" class="i method">TryGetValue</a>(<span class="r2 r">name</span>, <b>out</b> <span class="r5 r">text</span>))
                    {
                        <span class="r5 r">text</span> = <a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a>.<a href="TenantConfiguration.cs.html#a9248d385a9e9722" class="i method">Serialize</a>(<span class="r4 r">config</span>, <b>true</b>);
                        <a href="#932e84fe45ebc585" class="i field">_recordingConfigCache</a><a href="@0@mscorlib/A.html#49962975508e2d83">[</a><span class="r2 r">name</span>] = <span class="r5 r">text</span>;
                    }
                    <a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#c25963307db75929" class="i method">GetVariable</a>(<span class="r2 r">name</span>, <span class="r5 r">text</span>);
                    <b>break</b>;
                <b>case</b> <a href="/Azure.Core.TestFramework/A.html#d7d5cc97dd76217f" class="t t">RecordedTestMode</a>.<a href="/Azure.Core.TestFramework/A.html#6de2da8c848daf8b" class="i field">Live</a>:
                <b>default</b>:
                    <span class="r4 r">config</span> = <span class="r3 r">getTenant</span>();
                    <b>break</b>;
            }
            <b>return</b> <span class="r4 r">config</span>;
        }
 
        <b>public</b> <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a> <a id="1a2068983c3f194c" href="../R/1a2068983c3f194c.html" target="n" data-glyph="72,1" class="i method">GetUtcNow</a>() =&gt; <a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#121ddf7990f13459" class="i property">UtcNow</a>;
 
        <b>protected</b> <a href="/Azure.Core/A.html#744d0090cb2d4e15" class="t t">HttpPipelineTransport</a> <a id="8bce4430a1e52687" href="../R/8bce4430a1e52687.html" target="n" data-glyph="75,1" class="i method">GetTransport</a>() =&gt;
            <b>new</b> <a href="/Azure.Core/A.html#2f786ba6530ee31f" class="t constructor">HttpClientTransport</a>(
                <b>new</b> <span class="t constructor">HttpClient</span>()
                {
                    <span class="i property">Timeout</span> = <a href="TestConstants.cs.html#9775587e7faf076b" class="t t">TestConstants</a>.<a href="TestConstants.cs.html#160ddd328de5ff5d" class="i property">HttpTimeoutDuration</a>
                });
 
        <b>public byte</b>[] <a id="a85b47f94c91bf6b" href="../R/a85b47f94c91bf6b.html" target="n" data-glyph="72,1" class="i method">GetRandomBuffer</a>(<b>long</b> <span id="r6 rd" class="r6 r">size</span>)
            =&gt; <a href="TestHelper.cs.html#1425737f2a386c6e" class="t t">TestHelper</a>.<a href="TestHelper.cs.html#f5b415e23fcccc1d" class="i method">GetRandomBuffer</a>(<span class="r6 r">size</span>, <a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#b9828ff8817e7824" class="i property">Random</a>);
 
        <b>public string</b> <a id="8901680507e20275" href="../R/8901680507e20275.html" target="n" data-glyph="72,1" class="i method">GetNewString</a>(<b>int</b> <span id="r7 rd" class="r7 r">length</span> = 20)
        {
            <b>var</b> <span id="r8 rd" class="r8 r">buffer</span> = <b>new</b> <b>char</b>[<span class="r7 r">length</span>];
            <b>for</b> (<a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r9 rd" class="r9 r">i</span> = 0; <span class="r9 r">i</span> &lt; <span class="r7 r">length</span>; <span class="r9 r">i</span>++)
            {
                <span class="r8 r">buffer</span>[<span class="r9 r">i</span>] = (<b>char</b>)(<span class="s">&#39;a&#39;</span> + <a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#b9828ff8817e7824" class="i property">Random</a>.<a href="@0@mscorlib/A.html#ddd1e9e09c70bab5" class="i method">Next</a>(0, 25));
            }
            <b>return</b> <b>new</b> <a href="@0@mscorlib/A.html#ec408439366007e6" class="k">string</a>(<span class="r8 r">buffer</span>);
        }
 
        <b>public string</b> <a id="0be7ff76f751a338" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetNewMetadataName</a>() =&gt; <span class="s">$&quot;</span><span class="s">test_metadata_</span>{<a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#b9828ff8817e7824" class="i property">Random</a>.<a href="/Azure.Core.TestFramework/A.html#d4b1f5d1badb844e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>().<a href="@0@mscorlib/A.html#69fc1d0aa6df8a90" class="i method">Replace</a>(<span class="s">&quot;-&quot;</span>, <span class="s">&quot;_&quot;</span>)}<span class="s">&quot;</span>;
 
        <b>public</b> <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <a id="13c3e824a1627efc" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">BuildMetadata</a>()
            =&gt; <b>new</b> <a href="@0@mscorlib/A.html#05d4a216235a779c" class="t constructor">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<a href="@0@mscorlib/A.html#a1c3d85bbf4ae20e" class="t t">StringComparer</a>.<a href="@0@mscorlib/A.html#59b9c33842417944" class="i property">OrdinalIgnoreCase</a>)
                {
                    { <span class="s">&quot;foo&quot;</span>, <span class="s">&quot;bar&quot;</span> },
                    { <span class="s">&quot;meta&quot;</span>, <span class="s">&quot;data&quot;</span> },
                    { <span class="s">&quot;Capital&quot;</span>, <span class="s">&quot;letter&quot;</span> },
                    { <span class="s">&quot;UPPER&quot;</span>, <span class="s">&quot;case&quot;</span> }
                };
 
        <b>public</b> <a href="@0@System/A.html#966bd1c3b2dc55c7" class="t t">IPAddress</a> <a id="8663723ca5f53988" href="../R/8663723ca5f53988.html" target="n" data-glyph="72,1" class="i method">GetIPAddress</a>()
        {
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r10 rd" class="r10 r">a</span> = <a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#b9828ff8817e7824" class="i property">Random</a>.<a href="@0@mscorlib/A.html#ddd1e9e09c70bab5" class="i method">Next</a>(0, 256);
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r11 rd" class="r11 r">b</span> = <a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#b9828ff8817e7824" class="i property">Random</a>.<a href="@0@mscorlib/A.html#ddd1e9e09c70bab5" class="i method">Next</a>(0, 256);
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r12 rd" class="r12 r">c</span> = <a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#b9828ff8817e7824" class="i property">Random</a>.<a href="@0@mscorlib/A.html#ddd1e9e09c70bab5" class="i method">Next</a>(0, 256);
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r13 rd" class="r13 r">d</span> = <a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#b9828ff8817e7824" class="i property">Random</a>.<a href="@0@mscorlib/A.html#ddd1e9e09c70bab5" class="i method">Next</a>(0, 256);
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r14 rd" class="r14 r">ipString</span> = <span class="s">$&quot;</span>{<span class="r10 r">a</span>}<span class="s">.</span>{<span class="r11 r">b</span>}<span class="s">.</span>{<span class="r12 r">c</span>}<span class="s">.</span>{<span class="r13 r">d</span>}<span class="s">&quot;</span>;
            <b>return</b> <a href="@0@System/A.html#966bd1c3b2dc55c7" class="t t">IPAddress</a>.<a href="@0@System/A.html#b281f2ccedf6c111" class="i method">Parse</a>(<span class="r14 r">ipString</span>);
        }
 
        <b>public</b> <a href="/Azure.Core/A.html#d93a9ffee404e938" class="t t">TokenCredential</a> <a id="893138ee58eb3109" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetOAuthCredential</a>() =&gt;
            <a href="#6ee5d3102ae3bfe8" class="i method">GetOAuthCredential</a>(<a href="#73d6cc93aeb0f3a9" class="i property">TestConfigOAuth</a>);
 
        <b>public</b> <a href="/Azure.Core/A.html#d93a9ffee404e938" class="t t">TokenCredential</a> <a id="6ee5d3102ae3bfe8" href="../R/6ee5d3102ae3bfe8.html" target="n" data-glyph="72,1" class="i method">GetOAuthCredential</a>(<a href="TenantConfiguration.cs.html#62e7bd508929cb2a" class="t t">TenantConfiguration</a> <span id="r15 rd" class="r15 r">config</span>) =&gt;
            <a href="#d2dfa7fbb05c0142" class="i method">GetOAuthCredential</a>(
                <span class="r15 r">config</span>.<a href="TenantConfiguration.cs.html#d72ba81aa21dc3da" class="i property">ActiveDirectoryTenantId</a>,
                <span class="r15 r">config</span>.<a href="TenantConfiguration.cs.html#ef0208c1bf9abb2d" class="i property">ActiveDirectoryApplicationId</a>,
                <span class="r15 r">config</span>.<a href="TenantConfiguration.cs.html#3aadf1cb6a096062" class="i property">ActiveDirectoryApplicationSecret</a>,
                <b>new</b> <a href="@0@System/A.html#9e1bb2fef0d1159b" class="t constructor">Uri</a>(<span class="r15 r">config</span>.<a href="TenantConfiguration.cs.html#311958644c80c625" class="i property">ActiveDirectoryAuthEndpoint</a>));
 
        <b>public</b> <a href="/Azure.Core/A.html#d93a9ffee404e938" class="t t">TokenCredential</a> <a id="d2dfa7fbb05c0142" href="../R/d2dfa7fbb05c0142.html" target="n" data-glyph="72,1" class="i method">GetOAuthCredential</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r16 rd" class="r16 r">tenantId</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r17 rd" class="r17 r">appId</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r18 rd" class="r18 r">secret</span>, <a href="@0@System/A.html#991565dd25f47c90" class="t t">Uri</a> <span id="r19 rd" class="r19 r">authorityHost</span>) =&gt;
            <a href="/Azure.Core.TestFramework/A.html#eb077c11a09b6b1e" class="i property">Mode</a> == <a href="/Azure.Core.TestFramework/A.html#d7d5cc97dd76217f" class="t t">RecordedTestMode</a>.<a href="/Azure.Core.TestFramework/A.html#bde4663b03b59b85" class="i field">Playback</a> ?
                (<a href="/Azure.Core/A.html#d93a9ffee404e938" class="t t">TokenCredential</a>) <b>new</b> <a href="#8b87c02a92adc989" class="t constructor">StorageTestTokenCredential</a>() :
                <b>new</b> <a href="/Azure.Identity/A.html#7466e0943cd6ed0f" class="t constructor">ClientSecretCredential</a>(
                    <span class="r16 r">tenantId</span>,
                    <span class="r17 r">appId</span>,
                    <span class="r18 r">secret</span>,
                    <b>new</b> <a href="/Azure.Identity/A.html#b897d34e43e8b601" class="t constructor">TokenCredentialOptions</a>() { <a href="/Azure.Identity/A.html#de3193120ff3a2f6" class="i property">AuthorityHost</a> = <span class="r19 r">authorityHost</span> });
 
        <b>internal</b> <a href="/Azure.Storage.Blobs.ChangeFeed/A.html#f41ea190d83f57ce" class="t t">SharedAccessSignatureCredentials</a> <a id="9cabe476d549aa59" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetAccountSasCredentials</a>(
            <a href="/Azure.Storage.Common/A.html#0a5d24da836f2db6" class="t t">AccountSasServices</a> <span id="r20 rd" class="r20 r">services</span> = <a href="/Azure.Storage.Common/A.html#0a5d24da836f2db6" class="t t">AccountSasServices</a>.<a href="/Azure.Storage.Common/A.html#a89597092c8f735f" class="i field">All</a>,
            <a href="/Azure.Storage.Common/A.html#1e2952f573dd64b0" class="t t">AccountSasResourceTypes</a> <span id="r21 rd" class="r21 r">resourceTypes</span> = <a href="/Azure.Storage.Common/A.html#1e2952f573dd64b0" class="t t">AccountSasResourceTypes</a>.<a href="/Azure.Storage.Common/A.html#fb06b0ba251e75ec" class="i field">All</a>,
            <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a> <span id="r22 rd" class="r22 r">permissions</span> = <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#dec433cd96ddae14" class="i field">All</a>)
        {
            <a href="/Azure.Storage.Common/A.html#9ce56d23198efd7e" class="k">var</a> <span id="r23 rd" class="r23 r">sasBuilder</span> = <b>new</b> <a href="/Azure.Storage.Common/A.html#f12e731e35413cd6" class="t constructor">AccountSasBuilder</a>
            {
                <a href="/Azure.Storage.Common/A.html#42dc66dc8a568375" class="i property">ExpiresOn</a> = <a href="/Azure.Core.TestFramework/A.html#9fc34d8f596ca70c" class="i property">Recording</a>.<a href="/Azure.Core.TestFramework/A.html#121ddf7990f13459" class="i property">UtcNow</a>.<a href="@0@mscorlib/A.html#f349aa0ae92c3ec6" class="i method">AddHours</a>(1),
                <a href="/Azure.Storage.Common/A.html#cc25051703a160b5" class="i property">Services</a> = <span class="r20 r">services</span>,
                <a href="/Azure.Storage.Common/A.html#b595ea5c6b07ce36" class="i property">ResourceTypes</a> = <span class="r21 r">resourceTypes</span>,
                <a href="/Azure.Storage.Common/A.html#9c188c8afa2f76a8" class="i property">Protocol</a> = <a href="/Azure.Storage.Common/A.html#0acd3b9b8aa8ffc2" class="t t">SasProtocol</a>.<a href="/Azure.Storage.Common/A.html#294304a2b90553a6" class="i field">Https</a>,
            };
            <span class="r23 r">sasBuilder</span>.<a href="/Azure.Storage.Common/A.html#a4e6daa13f62ce35" class="i method">SetPermissions</a>(<span class="r22 r">permissions</span>);
            <a href="/Azure.Storage.Common/A.html#6b51bf09188ec1c0" class="k">var</a> <span id="r24 rd" class="r24 r">cred</span> = <b>new</b> <a href="/Azure.Storage.Common/A.html#5886b33715fef501" class="t constructor">StorageSharedKeyCredential</a>(<a href="#7f0dfee92e48882d" class="i property">TestConfigDefault</a>.<a href="TenantConfiguration.cs.html#774d8fba75d6b5dd" class="i property">AccountName</a>, <a href="#7f0dfee92e48882d" class="i property">TestConfigDefault</a>.<a href="TenantConfiguration.cs.html#fc6c2fe34872ce46" class="i property">AccountKey</a>);
            <b>return</b> <b>new</b> <a href="/Azure.Storage.Blobs.ChangeFeed/A.html#ac47587023459590" class="t constructor">SharedAccessSignatureCredentials</a>(<span class="r23 r">sasBuilder</span>.<a href="/Azure.Storage.Common/A.html#09d1ecf8b33816fc" class="i method">ToSasQueryParameters</a>(<span class="r24 r">cred</span>).<a href="/Azure.Storage.Common/A.html#8ceacb8907eb221e" class="i method">ToString</a>());
        }
 
        <b>public virtual void</b> <a id="799883587afd54d4" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">AssertDictionaryEquality</a>(<a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <span id="r25 rd" class="r25 r">expected</span>, <a href="@0@mscorlib/A.html#20343df0c96b629b" class="t t">IDictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <span id="r26 rd" class="r26 r">actual</span>)
        {
            <span class="t t">Assert</span>.<span class="i method">IsNotNull</span>(<span class="r25 r">expected</span>, <span class="s">&quot;Expected metadata is null&quot;</span>);
            <span class="t t">Assert</span>.<span class="i method">IsNotNull</span>(<span class="r26 r">actual</span>, <span class="s">&quot;Actual metadata is null&quot;</span>);
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r25 r">expected</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a>, <span class="r26 r">actual</span>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a>, <span class="s">&quot;Metadata counts are not equal&quot;</span>);
 
            <b>foreach</b> (<a href="@0@mscorlib/A.html#8585965bb176a426" class="t t">KeyValuePair</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <span id="r27 rd" class="r27 r">kvp</span> <b>in</b> <span class="r25 r">expected</span>)
            {
                <b>if</b> (!<span class="r26 r">actual</span>.<a href="@0@mscorlib/A.html#6b9f9049901aacea" class="i method">TryGetValue</a>(<span class="r27 r">kvp</span>.<a href="@0@mscorlib/A.html#f9d1c04feb1af032" class="i property">Key</a>, <b>out</b> <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r28 rd" class="r28 r">value</span>) ||
                    <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#0be9474bc8e160b6" class="i method">Compare</a>(<span class="r27 r">kvp</span>.<a href="@0@mscorlib/A.html#38c0e86cc4b30170" class="i property">Value</a>, <span class="r28 r">value</span>, <a href="@0@mscorlib/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@0@mscorlib/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>) != 0)
                {
                    <span class="t t">Assert</span>.<span class="i method">Fail</span>(<span class="s">$&quot;</span><span class="s">Expected key &lt;</span>{<span class="r27 r">kvp</span>.<a href="@0@mscorlib/A.html#f9d1c04feb1af032" class="i property">Key</a>}<span class="s">&gt; with value &lt;</span>{<span class="r27 r">kvp</span>.<a href="@0@mscorlib/A.html#38c0e86cc4b30170" class="i property">Value</a>}<span class="s">&gt; not found</span><span class="s">&quot;</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> To prevent test flakiness, we simply warn when certain timing sensitive</span>
        <span class="c">///</span><span class="c"> tests don&#39;t appear to work as expected.  However, we will ask you to run</span>
        <span class="c">///</span><span class="c"> it again if you&#39;re recording a test because it should work correctly at</span>
        <span class="c">///</span><span class="c"> least then.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="55405a7586b4dc0a" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">WarnCopyCompletedTooQuickly</a>()
        {
            <b>if</b> (<a href="/Azure.Core.TestFramework/A.html#eb077c11a09b6b1e" class="i property">Mode</a> == <a href="/Azure.Core.TestFramework/A.html#d7d5cc97dd76217f" class="t t">RecordedTestMode</a>.<a href="/Azure.Core.TestFramework/A.html#62f98a4a2b1d56c3" class="i field">Record</a>)
            {
                <span class="t t">Assert</span>.<span class="i method">Fail</span>(<span class="s">&quot;Copy may have completed too quickly to abort.  Please record again.&quot;</span>);
            }
            <b>else</b>
            {
                <span class="t t">Assert</span>.<span class="i method">Inconclusive</span>(<span class="s">&quot;Copy may have completed too quickly to abort.&quot;</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A number of our tests have built in delays while we wait an expected</span>
        <span class="c">///</span><span class="c"> amount of time for a service operation to complete and this method</span>
        <span class="c">///</span><span class="c"> allows us to wait (unless we&#39;re playing back recordings, which can</span>
        <span class="c">///</span><span class="c"> complete immediately).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">milliseconds</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The number of milliseconds to wait.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">playbackDelayMilliseconds</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An optional number of milliseconds to wait if we&#39;re playing back a</span>
        <span class="c">///</span><span class="c"> recorded test.  This is useful for allowing client side events to</span>
        <span class="c">///</span><span class="c"> get processed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A task that will (optionally) delay.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="308d9c9b984182fe" href="../R/308d9c9b984182fe.html" target="n" data-glyph="72,1" class="i method">Delay</a>(<b>int</b> <span id="r29 rd" class="r29 r">milliseconds</span> = 1000, <b>int</b>? <span id="r30 rd" class="r30 r">playbackDelayMilliseconds</span> = <b>null</b>) =&gt;
            <b>await</b> <a href="#33a3b3f54c1d1ee8" class="i method">Delay</a>(<a href="/Azure.Core.TestFramework/A.html#eb077c11a09b6b1e" class="i property">Mode</a>, <span class="r29 r">milliseconds</span>, <span class="r30 r">playbackDelayMilliseconds</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A number of our tests have built in delays while we wait an expected</span>
        <span class="c">///</span><span class="c"> amount of time for a service operation to complete and this method</span>
        <span class="c">///</span><span class="c"> allows us to wait (unless we&#39;re playing back recordings, which can</span>
        <span class="c">///</span><span class="c"> complete immediately).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">milliseconds</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The number of milliseconds to wait.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r32 r">playbackDelayMilliseconds</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An optional number of milliseconds to wait if we&#39;re playing back a</span>
        <span class="c">///</span><span class="c"> recorded test.  This is useful for allowing client side events to</span>
        <span class="c">///</span><span class="c"> get processed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A task that will (optionally) delay.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="33a3b3f54c1d1ee8" href="../R/33a3b3f54c1d1ee8.html" target="n" data-glyph="72,1" class="i method">Delay</a>(<a href="/Azure.Core.TestFramework/A.html#d7d5cc97dd76217f" class="t t">RecordedTestMode</a> <span id="r33 rd" class="r33 r">mode</span>, <b>int</b> <span id="r31 rd" class="r31 r">milliseconds</span> = 1000, <b>int</b>? <span id="r32 rd" class="r32 r">playbackDelayMilliseconds</span> = <b>null</b>)
        {
            <b>if</b> (<span class="r33 r">mode</span> != <a href="/Azure.Core.TestFramework/A.html#d7d5cc97dd76217f" class="t t">RecordedTestMode</a>.<a href="/Azure.Core.TestFramework/A.html#bde4663b03b59b85" class="i field">Playback</a>)
            {
                <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#34b191a243434f6a" class="i method">Delay</a>(<span class="r31 r">milliseconds</span>);
            }
            <b>else</b> <b>if</b> (<span class="r32 r">playbackDelayMilliseconds</span> != <b>null</b>)
            {
                <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#34b191a243434f6a" class="i method">Delay</a>(<span class="r32 r">playbackDelayMilliseconds</span>.<a href="@0@mscorlib/A.html#7b38d1fa76071c95" class="i property">Value</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wait for the progress notifications to complete.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="i">progressList</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The list of progress notifications being updated by the Progress handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r34 r">totalSize</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The total size we should eventually see.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A task that will (optionally) delay.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="deeefa98faa67d54" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">WaitForProgressAsync</a>(<span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Concurrent</span>.<a href="@0@System/A.html#2b70243adbcbdb40" class="t t">ConcurrentBag</a>&lt;<b>long</b>&gt; <span id="r35 rd" class="r35 r">progressBag</span>, <b>long</b> <span id="r34 rd" class="r34 r">totalSize</span>)
        {
            <b>for</b> (<a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r36 rd" class="r36 r">attempts</span> = 0; <span class="r36 r">attempts</span> &lt; 10; <span class="r36 r">attempts</span>++)
            {
                <span class="c">// ConcurrentBag.GetEnumerator() returns a snapshot in time; we can safely use linq queries</span>
                <b>if</b> (<span class="r35 r">progressBag</span>.<a href="@0@System/A.html#8a5d65bdd22235fb" class="i property">Count</a> &gt; 0 &amp;&amp; <span class="r35 r">progressBag</span>.<a href="@0@System.Core/A.html#20754b69f550f826" class="i method">Max</a>() &gt;= <span class="r34 r">totalSize</span>)
                {
                    <b>return</b>;
                }
 
                <span class="c">// Wait for lingering progress events</span>
                <b>await</b> <a href="#308d9c9b984182fe" class="i method">Delay</a>(500, 100).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
 
            <span class="c">// TODO: #7077 - These are too flaky/noisy so I&#39;m changing to Warn</span>
            <span class="t t">Assert</span>.<span class="i method">Warn</span>(<span class="s">&quot;Progress notifications never completed!&quot;</span>);
        }
 
        <b>protected void</b> <a id="104b330e8835ba2a" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">AssertSecondaryStorageFirstRetrySuccessful</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r37 rd" class="r37 r">primaryHost</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r38 rd" class="r38 r">secondaryHost</span>, <a href="TestExceptionPolicy.cs.html#0d68b3a20bb1a76e" class="t t">TestExceptionPolicy</a> <span id="r39 rd" class="r39 r">testExceptionPolicy</span>)
        {
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r37 r">primaryHost</span>, <span class="r39 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[0]);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r38 r">secondaryHost</span>, <span class="r39 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[1]);
        }
 
        <b>protected void</b> <a id="9624dfeafc04c404" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">AssertSecondaryStorageSecondRetrySuccessful</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r40 rd" class="r40 r">primaryHost</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r41 rd" class="r41 r">secondaryHost</span>, <a href="TestExceptionPolicy.cs.html#0d68b3a20bb1a76e" class="t t">TestExceptionPolicy</a> <span id="r42 rd" class="r42 r">testExceptionPolicy</span>)
        {
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r40 r">primaryHost</span>, <span class="r42 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[0]);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r41 r">secondaryHost</span>, <span class="r42 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[1]);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r40 r">primaryHost</span>, <span class="r42 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[2]);
        }
 
        <b>protected void</b> <a id="9c4462032de816f4" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">AssertSecondaryStorageThirdRetrySuccessful</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r43 rd" class="r43 r">primaryHost</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r44 rd" class="r44 r">secondaryHost</span>, <a href="TestExceptionPolicy.cs.html#0d68b3a20bb1a76e" class="t t">TestExceptionPolicy</a> <span id="r45 rd" class="r45 r">testExceptionPolicy</span>)
        {
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r43 r">primaryHost</span>, <span class="r45 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[0]);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r44 r">secondaryHost</span>, <span class="r45 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[1]);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r43 r">primaryHost</span>, <span class="r45 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[2]);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r44 r">secondaryHost</span>, <span class="r45 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[3]);
        }
 
        <b>protected void</b> <a id="1632af95d62bc5f2" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">AssertSecondaryStorage404OnSecondary</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r46 rd" class="r46 r">primaryHost</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r47 rd" class="r47 r">secondaryHost</span>, <a href="TestExceptionPolicy.cs.html#0d68b3a20bb1a76e" class="t t">TestExceptionPolicy</a> <span id="r48 rd" class="r48 r">testExceptionPolicy</span>)
        {
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r46 r">primaryHost</span>, <span class="r48 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[0]);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r47 r">secondaryHost</span>, <span class="r48 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[1]);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r46 r">primaryHost</span>, <span class="r48 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[2]);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r46 r">primaryHost</span>, <span class="r48 r">testExceptionPolicy</span>.<a href="TestExceptionPolicy.cs.html#150340088532dcec" class="i property">HostsSetInRequests</a>[3]);
        }
 
        <b>protected async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="r49 r t">T</span>&gt; <a id="dbc0dd8130ca83b4" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">EnsurePropagatedAsync</a>&lt;<span id="r49 rd t" class="r49 r t">T</span>&gt;(
            <a href="@0@mscorlib/A.html#87d60abb7092d5a4" class="t t">Func</a>&lt;<a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="r49 r t">T</span>&gt;&gt; <span id="r50 rd" class="r50 r">getResponse</span>,
            <a href="@0@mscorlib/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<span class="r49 r t">T</span>, <b>bool</b>&gt; <span id="r51 rd" class="r51 r">hasResponse</span>)
        {
            <b>bool</b> <span id="r52 rd" class="r52 r">responseReceived</span> = <b>false</b>;
            <span class="r49 r t">T</span> <span id="r53 rd" class="r53 r">response</span> = <b>default</b>;
            <span class="c">// end time of 16 minutes from now to allow for propagation to secondary host</span>
            <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a> <span id="r54 rd" class="r54 r">endTime</span> = <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>.<a href="@0@mscorlib/A.html#c6573f48ac6bd630" class="i property">Now</a>.<a href="@0@mscorlib/A.html#4658bd43b97f915c" class="i method">AddMinutes</a>(16);
            <b>while</b> (!<span class="r52 r">responseReceived</span> &amp;&amp; <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>.<a href="@0@mscorlib/A.html#c6573f48ac6bd630" class="i property">Now</a> &lt; <span class="r54 r">endTime</span>)
            {
                <span class="r53 r">response</span> = <b>await</b> <span class="r50 r">getResponse</span>();
                <b>if</b> (!<span class="r51 r">hasResponse</span>(<span class="r53 r">response</span>))
                {
                    <b>await</b> <a href="#308d9c9b984182fe" class="i method">Delay</a>(<a href="TestConstants.cs.html#9775587e7faf076b" class="t t">TestConstants</a>.<a href="TestConstants.cs.html#79f1a2923697aa3c" class="i field">RetryDelay</a>);
                }
                <b>else</b>
                {
                    <span class="r52 r">responseReceived</span> = <b>true</b>;
                }
            }
            <b>return</b> <span class="r53 r">response</span>;
        }
 
        <b>internal void</b> <a id="5f0641bfde1a2207" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">AssertResponseHeaders</a>(<a href="TestConstants.cs.html#9775587e7faf076b" class="t t">TestConstants</a> <span id="r55 rd" class="r55 r">constants</span>, <a href="/Azure.Storage.Common/A.html#6d8135d9673080f5" class="t t">SasQueryParameters</a> <span id="r56 rd" class="r56 r">sasQueryParameters</span>)
        {
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r55 r">constants</span>.<a href="TestConstants.cs.html#268d664916096044" class="i property">Sas</a>.<a href="TestConstants.cs.html#bbc71dee1d50a765" class="i property">CacheControl</a>, <span class="r56 r">sasQueryParameters</span>.<a href="/Azure.Storage.Common/A.html#a6a71e196ca3fa9e" class="i property">CacheControl</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r55 r">constants</span>.<a href="TestConstants.cs.html#268d664916096044" class="i property">Sas</a>.<a href="TestConstants.cs.html#379b953a87f02180" class="i property">ContentDisposition</a>, <span class="r56 r">sasQueryParameters</span>.<a href="/Azure.Storage.Common/A.html#c012c20484133600" class="i property">ContentDisposition</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r55 r">constants</span>.<a href="TestConstants.cs.html#268d664916096044" class="i property">Sas</a>.<a href="TestConstants.cs.html#afcd0cf5f0deb5f0" class="i property">ContentEncoding</a>, <span class="r56 r">sasQueryParameters</span>.<a href="/Azure.Storage.Common/A.html#e68856007b12e65e" class="i property">ContentEncoding</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r55 r">constants</span>.<a href="TestConstants.cs.html#268d664916096044" class="i property">Sas</a>.<a href="TestConstants.cs.html#9be8810adf65cd6b" class="i property">ContentLanguage</a>, <span class="r56 r">sasQueryParameters</span>.<a href="/Azure.Storage.Common/A.html#61b6f5193e88a54d" class="i property">ContentLanguage</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r55 r">constants</span>.<a href="TestConstants.cs.html#268d664916096044" class="i property">Sas</a>.<a href="TestConstants.cs.html#7ca571e56fa5a11d" class="i property">ContentType</a>, <span class="r56 r">sasQueryParameters</span>.<a href="/Azure.Storage.Common/A.html#cb7f5755e1fd7e84" class="i property">ContentType</a>);
        }
 
        <b>protected async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="r57 r t">T</span>&gt; <a id="8544ff9c30526bce" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">RetryAsync</a>&lt;<span id="r57 rd t" class="r57 r t">T</span>&gt;(
            <a href="@0@mscorlib/A.html#87d60abb7092d5a4" class="t t">Func</a>&lt;<a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="r57 r t">T</span>&gt;&gt; <span id="r58 rd" class="r58 r">operation</span>,
            <a href="@0@mscorlib/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="/Azure.Core/A.html#253c51f73f5cd67d" class="t t">RequestFailedException</a>, <b>bool</b>&gt; <span id="r59 rd" class="r59 r">shouldRetry</span>,
            <b>int</b> <span id="r60 rd" class="r60 r">retryDelay</span> = <a href="TestConstants.cs.html#9775587e7faf076b" class="t t">TestConstants</a>.<a href="TestConstants.cs.html#79f1a2923697aa3c" class="i field">RetryDelay</a>,
            <b>int</b> <span id="r61 rd" class="r61 r">retryAttempts</span> = <a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#c66b0e31ad263065" class="i field">MaxReliabilityRetries</a>) =&gt;
            <b>await</b> <a href="#75aed020d4347b8b" class="i method">RetryAsync</a>(<a href="/Azure.Core.TestFramework/A.html#eb077c11a09b6b1e" class="i property">Mode</a>, <span class="r58 r">operation</span>, <span class="r59 r">shouldRetry</span>, <span class="r60 r">retryDelay</span>, <span class="r61 r">retryAttempts</span>);
 
        <b>public static async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="r62 r t">T</span>&gt; <a id="75aed020d4347b8b" href="../R/75aed020d4347b8b.html" target="n" data-glyph="72,1" class="i method">RetryAsync</a>&lt;<span id="r62 rd t" class="r62 r t">T</span>&gt;(
            <a href="/Azure.Core.TestFramework/A.html#d7d5cc97dd76217f" class="t t">RecordedTestMode</a> <span id="r63 rd" class="r63 r">mode</span>,
            <a href="@0@mscorlib/A.html#87d60abb7092d5a4" class="t t">Func</a>&lt;<a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="r62 r t">T</span>&gt;&gt; <span id="r64 rd" class="r64 r">operation</span>,
            <a href="@0@mscorlib/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="/Azure.Core/A.html#253c51f73f5cd67d" class="t t">RequestFailedException</a>, <b>bool</b>&gt; <span id="r65 rd" class="r65 r">shouldRetry</span>,
            <b>int</b> <span id="r66 rd" class="r66 r">retryDelay</span> = <a href="TestConstants.cs.html#9775587e7faf076b" class="t t">TestConstants</a>.<a href="TestConstants.cs.html#79f1a2923697aa3c" class="i field">RetryDelay</a>,
            <b>int</b> <span id="r67 rd" class="r67 r">retryAttempts</span> = <a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#c66b0e31ad263065" class="i field">MaxReliabilityRetries</a>)
        {
            <b>for</b> (<b>int</b> <span id="r68 rd" class="r68 r">attempt</span> = 0; ;)
            {
                <b>try</b>
                {
                    <b>return</b> <b>await</b> <span class="r64 r">operation</span>();
                }
                <b>catch</b> (<a href="/Azure.Core/A.html#253c51f73f5cd67d" class="t t">RequestFailedException</a> <span id="r69 rd" class="r69 r">ex</span>)
                    <b>when</b> (<span class="r68 r">attempt</span>++ &lt; <span class="r67 r">retryAttempts</span> &amp;&amp; <span class="r65 r">shouldRetry</span>(<span class="r69 r">ex</span>))
                {
                    <b>await</b> <a href="#33a3b3f54c1d1ee8" class="i method">Delay</a>(<span class="r63 r">mode</span>, <span class="r66 r">retryDelay</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a stream of a given size that will not use more than maxMemory memory.</span>
        <span class="c">///</span><span class="c"> If the size is greater than maxMemory, a TemporaryFileStream will be used that</span>
        <span class="c">///</span><span class="c"> will delete the file in its Dispose method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a>&gt; <a id="afbd8f50c33abee4" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">CreateLimitedMemoryStream</a>(<b>long</b> <span id="r70 rd" class="r70 r">size</span>, <b>long</b> <span id="r71 rd" class="r71 r">maxMemory</span> = <a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#f083580f332431a9" class="i field">MB</a> * 100)
        {
            <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r72 rd" class="r72 r">stream</span>;
            <b>if</b> (<span class="r70 r">size</span> &lt; <span class="r71 r">maxMemory</span>)
            {
                <b>var</b> <span id="r73 rd" class="r73 r">data</span> = <a href="#a85b47f94c91bf6b" class="i method">GetRandomBuffer</a>(<span class="r70 r">size</span>);
                <span class="r72 r">stream</span> = <b>new</b> <a href="@0@mscorlib/A.html#f92fa270fda9a82b" class="t constructor">MemoryStream</a>(<span class="r73 r">data</span>);
            }
            <b>else</b>
            {
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r74 rd" class="r74 r">path</span> = <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#3f28ce894873de0a" class="i method">GetTempFileName</a>();
                <span class="r72 r">stream</span> = <b>new</b> <a href="TemporaryFileStream.cs.html#0125cc4605cb5e68" class="t constructor">TemporaryFileStream</a>(<span class="r74 r">path</span>, <a href="@0@mscorlib/A.html#c0cb6ba6af625b3a" class="t t">FileMode</a>.<a href="@0@mscorlib/A.html#17684d43e30dc120" class="i field">Create</a>);
                <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r75 rd" class="r75 r">bufferSize</span> = 4 * <a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#4240fd6a2382c38e" class="i field">KB</a>;
 
                <b>while</b> (<span class="r72 r">stream</span>.<a href="@0@mscorlib/A.html#35112b2a53fb536a" class="i property">Position</a> + <span class="r75 r">bufferSize</span> &lt; <span class="r70 r">size</span>)
                {
                    <b>await</b> <span class="r72 r">stream</span>.<a href="@0@mscorlib/A.html#da66045de943643c" class="i method">WriteAsync</a>(<a href="#a85b47f94c91bf6b" class="i method">GetRandomBuffer</a>(<span class="r75 r">bufferSize</span>), 0, <span class="r75 r">bufferSize</span>);
                }
                <b>if</b> (<span class="r72 r">stream</span>.<a href="@0@mscorlib/A.html#35112b2a53fb536a" class="i property">Position</a> &lt; <span class="r70 r">size</span>)
                {
                    <b>await</b> <span class="r72 r">stream</span>.<a href="@0@mscorlib/A.html#da66045de943643c" class="i method">WriteAsync</a>(<a href="#a85b47f94c91bf6b" class="i method">GetRandomBuffer</a>(<span class="r70 r">size</span> - <span class="r72 r">stream</span>.<a href="@0@mscorlib/A.html#35112b2a53fb536a" class="i property">Position</a>), 0, (<b>int</b>)(<span class="r70 r">size</span> - <span class="r72 r">stream</span>.<a href="@0@mscorlib/A.html#35112b2a53fb536a" class="i property">Position</a>));
                }
                <span class="c">// reset the stream</span>
                <span class="r72 r">stream</span>.<a href="@0@mscorlib/A.html#eb5599035c4388ce" class="i method">Seek</a>(0, <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>.<a href="@0@mscorlib/A.html#c29481af7c617299" class="i field">Begin</a>);
            }
            <b>return</b> <span class="r72 r">stream</span>;
        }
 
        <b>private class</b> <a id="8b87c02a92adc989" href="../R/8b87c02a92adc989.html" target="n" data-glyph="4,1" class="t t"><span id="df42ffa7af3b0a7d">StorageTestTokenCredential</span></a> : <a href="/Azure.Core/A.html#d93a9ffee404e938" class="t t">TokenCredential</a>
        {
            <b>public override</b> <span class="t t">ValueTask</span>&lt;<a href="/Azure.Core/A.html#b9cb398886850745" class="t t">AccessToken</a>&gt; <a id="d63d066dc76f3f64" href="../R/d63d066dc76f3f64.html" target="n" data-glyph="72,2" class="i method">GetTokenAsync</a>(<a href="/Azure.Core/A.html#9d9eb2813d5fd899" class="t t">TokenRequestContext</a> <span id="r76 rd" class="r76 r">requestContext</span>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r77 rd" class="r77 r">cancellationToken</span>)
            {
                <b>return</b> <b>new</b> <span class="t constructor">ValueTask</span>&lt;<a href="/Azure.Core/A.html#b9cb398886850745" class="t t">AccessToken</a>&gt;(<a href="#68ef6a92829e2ca0" class="i method">GetToken</a>(<span class="r76 r">requestContext</span>, <span class="r77 r">cancellationToken</span>));
            }
 
            <b>public override</b> <a href="/Azure.Core/A.html#b9cb398886850745" class="t t">AccessToken</a> <a id="68ef6a92829e2ca0" href="../R/68ef6a92829e2ca0.html" target="n" data-glyph="72,2" class="i method">GetToken</a>(<a href="/Azure.Core/A.html#9d9eb2813d5fd899" class="t t">TokenRequestContext</a> <span id="r78 rd" class="r78 r">requestContext</span>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r79 rd" class="r79 r">cancellationToken</span>)
            {
                <b>return</b> <b>new</b> <a href="/Azure.Core/A.html#68b2c442cd1f3537" class="t constructor">AccessToken</a>(<span class="s">&quot;TEST TOKEN &quot;</span> + <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#881354baa56fc358" class="i method">Join</a>(<span class="s">&quot; &quot;</span>, <span class="r78 r">requestContext</span>.<a href="/Azure.Core/A.html#c2d39696789a7847" class="i property">Scopes</a>), <a href="@0@mscorlib/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>.<a href="@0@mscorlib/A.html#371fa431c6a3a817" class="i field">MaxValue</a>);
            }
        }
 
        <b>public string</b> <a id="f5f2455fd2414cc0" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">AccountSasPermissionsToPermissionsString</a>(<a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a> <span id="r80 rd" class="r80 r">permissions</span>)
        {
            <a href="@0@mscorlib/A.html#adf60ee46ebd299f" class="k">var</a> <span id="r81 rd" class="r81 r">sb</span> = <b>new</b> <a href="@0@mscorlib/A.html#6e631639c1e2746b" class="t constructor">StringBuilder</a>();
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#9a7c879d31375fb6" class="i field">Read</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#9a7c879d31375fb6" class="i field">Read</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#8d1d6c3c3c823331" class="i field">Read</a>);
            }
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#7ff3fe0ed71db607" class="i field">Write</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#7ff3fe0ed71db607" class="i field">Write</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#b81b0961bee6c8de" class="i field">Write</a>);
            }
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#04f3efd6e13c7752" class="i field">Delete</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#04f3efd6e13c7752" class="i field">Delete</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#9fcd20a5626a7d8d" class="i field">Delete</a>);
            }
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#66e10e98f8787a95" class="i field">DeleteVersion</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#66e10e98f8787a95" class="i field">DeleteVersion</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#4d4e205f61178c3d" class="i field">DeleteBlobVersion</a>);
            }
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#cdb269708444ef8d" class="i field">List</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#cdb269708444ef8d" class="i field">List</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#0ad0ab7bc5f31d3f" class="i field">List</a>);
            }
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#f681b93438653534" class="i field">Add</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#f681b93438653534" class="i field">Add</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#761fd62c893b24ed" class="i field">Add</a>);
            }
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#d080f3419e8510a5" class="i field">Create</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#d080f3419e8510a5" class="i field">Create</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#8dc4bcb02fea5391" class="i field">Create</a>);
            }
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#4a39996eafb6c070" class="i field">Update</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#4a39996eafb6c070" class="i field">Update</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#d11661b76c29db2e" class="i field">Update</a>);
            }
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#837d62524e045331" class="i field">Process</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#837d62524e045331" class="i field">Process</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#88981d1036dfee16" class="i field">Process</a>);
            }
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#8b50232c883692f0" class="i field">Tag</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#8b50232c883692f0" class="i field">Tag</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#fa38c43094a4081c" class="i field">Tag</a>);
            }
            <b>if</b> ((<span class="r80 r">permissions</span> &amp; <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#33f9215022fc4638" class="i field">Filter</a>) == <a href="/Azure.Storage.Common/A.html#ac762c6c5829d9cc" class="t t">AccountSasPermissions</a>.<a href="/Azure.Storage.Common/A.html#33f9215022fc4638" class="i field">Filter</a>)
            {
                <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#3a326aeeff2329fb" class="t t">Sas</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#1b5e08d0d1f3a0d2" class="t t">Permissions</a>.<a href="/Azure.Storage.Blobs.ChangeFeed/A.html#4b02bd559ecbcb48" class="i field">FilterByTags</a>);
            }
            <b>return</b> <span class="r81 r">sb</span>.<a href="@0@mscorlib/A.html#5a97da49a158a3c9" class="i method">ToString</a>();
        }
    }
}
</pre></td></tr></table></div></body></html>
