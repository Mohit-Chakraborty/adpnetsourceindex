<!DOCTYPE html>
<html><head><title>AttestationToken.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(154);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Security.Attestation/AttestationToken.cs" target="_top">AttestationToken.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Security.Attestation" target="_top">src\Azure.Security.Attestation.csproj</a> (Azure.Security.Attestation)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i">System</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Text</span>.<span class="i">Json</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Text</span>.<span class="i">Json</span>.<span class="i">Serialization</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Security</span>.<span class="i n">Attestation</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">X509Certificates</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Text</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Security</span>.<span class="i n">Attestation</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Represents an Attestation Token object.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="fe59844e2c351bcf" href="R/fe59844e2c351bcf.html" target="n" data-glyph="0,0" class="t t">AttestationToken</a>
    {
        <b>protected private string</b> <a id="6470bbe9ad3e1a22" href="R/6470bbe9ad3e1a22.html" target="n" data-glyph="45,1" class="i field">_token</a>;
        <b>private</b> <span class="i">JsonSerializerOptions</span> <a id="78b0f76cb0f27d49" href="R/78b0f76cb0f27d49.html" target="n" data-glyph="46,1" class="i field">_options</a> = <b>new</b> <span class="i">JsonSerializerOptions</span>();
 
        <b>private object</b> <a id="b3276bbea4ab52a1" href="R/b3276bbea4ab52a1.html" target="n" data-glyph="46,1" class="i field">_deserializedBody</a>;
        <b>private object</b> <a id="ef4dd56a81bb8ac4" href="R/ef4dd56a81bb8ac4.html" target="n" data-glyph="46,1" class="i field">_statelock</a> = <b>new</b> <b>object</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#fe59844e2c351bcf" class="t t">AttestationToken</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">token</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">string JWT to initialize.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="23e0c37f55381f64" href="R/23e0c37f55381f64.html" target="n" data-glyph="74,1" class="t constructor">AttestationToken</a>(<b>string</b> <span id="r0 rd" class="r0 r">token</span>)
        {
            <a href="#6470bbe9ad3e1a22" class="i field">_token</a> = <span class="r0 r">token</span>;
            <b>string</b>[] <span id="r1 rd" class="r1 r">decomposedToken</span> = <span class="r0 r">token</span>.<span class="i">Split</span>(<span class="s">&#39;.&#39;</span>);
            <b>if</b> (<span class="r1 r">decomposedToken</span>.<span class="i">Length</span> != 3)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<span class="s">&quot;JSON Web Tokens must have 3 components delimited by &#39;.&#39; characters.&quot;</span>);
            }
            <a href="#120bea08946b4e17" class="i property">TokenHeaderBytes</a> = <a href="Shared/Base64Url.cs.html#d513fc35e4933439" class="t t">Base64Url</a>.<a href="Shared/Base64Url.cs.html#e4d686f215244ecd" class="i method">Decode</a>(<span class="r1 r">decomposedToken</span>[0]);
            <a href="#fc7c2e7cbc755662" class="i property">TokenBodyBytes</a> = <a href="Shared/Base64Url.cs.html#d513fc35e4933439" class="t t">Base64Url</a>.<a href="Shared/Base64Url.cs.html#e4d686f215244ecd" class="i method">Decode</a>(<span class="r1 r">decomposedToken</span>[1]);
            <a href="#f9bba601c50664cd" class="i property">TokenSignatureBytes</a> = <a href="Shared/Base64Url.cs.html#d513fc35e4933439" class="t t">Base64Url</a>.<a href="Shared/Base64Url.cs.html#e4d686f215244ecd" class="i method">Decode</a>(<span class="r1 r">decomposedToken</span>[2]);
 
            <a href="#78b0f76cb0f27d49" class="i field">_options</a>.<span class="i">Converters</span>.<span class="i">Add</span>(<b>new</b> <span class="t">PolicyResultConverter</span>());
            <a href="#78b0f76cb0f27d49" class="i field">_options</a>.<span class="i">Converters</span>.<span class="i">Add</span>(<b>new</b> <a href="Models/AttestationResultConverter.cs.html#fea82b1f18808e50" class="t constructor">AttestationResultConverter</a>());
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Protected token for mocking.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected</b> <a id="ad815cd78ff21e44" href="R/../../0000000000.html" target="n" data-glyph="75,1" class="t constructor">AttestationToken</a>()
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the thumbprint of the X.509 certificate which was used to verify the attestation token.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Null until the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#fe59844e2c351bcf" class="t t">AttestationToken</a>.<a href="#7e9bbfc484893188" class="i method">ValidateToken</a>(<span class="i">IReadOnlyList</span>{<a href="Models/AttestationSigner.cs.html#f9ef2caf091b7259" class="t t">AttestationSigner</a>}, <span class="i">Func</span>{<a href="#fe59844e2c351bcf" class="t t">AttestationToken</a>, <a href="Models/AttestationSigner.cs.html#f9ef2caf091b7259" class="t t">AttestationSigner</a>, <b>bool</b>})<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> method has been called.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="52a17ae5ad4c7be4" href="R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">CertificateThumbprint</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decoded header for the attestation token. See https://tools.ietf.org/html/rfc7515 for more details.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">ReadOnlyMemory</span>&lt;<b>byte</b>&gt; <a id="120bea08946b4e17" href="R/120bea08946b4e17.html" target="n" data-glyph="102,1" class="i property">TokenHeaderBytes</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decoded body for the attestation token. See https://tools.ietf.org/html/rfc7515 for more details.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">ReadOnlyMemory</span>&lt;<b>byte</b>&gt; <a id="fc7c2e7cbc755662" href="R/fc7c2e7cbc755662.html" target="n" data-glyph="102,1" class="i property">TokenBodyBytes</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decoded signature for the attestation token. See https://tools.ietf.org/html/rfc7515 for more details.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">ReadOnlyMemory</span>&lt;<b>byte</b>&gt; <a id="f9bba601c50664cd" href="R/f9bba601c50664cd.html" target="n" data-glyph="102,1" class="i property">TokenSignatureBytes</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the standard properties in the JSON Web Token header. See https://tools.ietf.org/html/rfc7515 for more details.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="Models/JsonWebTokenHeader.cs.html#df12bac9fed6d487" class="t t">JsonWebTokenHeader</a> <a id="102f81f6bca7e1dc" href="R/../../0000000000.html" target="n" data-glyph="106,1" class="i property">Header</a> { <b>get</b> =&gt; <span class="i">JsonSerializer</span>.<span class="i">Deserialize</span>&lt;<a href="Models/JsonWebTokenHeader.cs.html#df12bac9fed6d487" class="t t">JsonWebTokenHeader</a>&gt;(<a href="#120bea08946b4e17" class="i property">TokenHeaderBytes</a>.<span class="i">ToArray</span>()); }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the standard properties in the JSON Web Token header. See https://tools.ietf.org/html/rfc7515 for more details.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="Models/JsonWebTokenBody.cs.html#bde4b8e0c1f46143" class="t t">JsonWebTokenBody</a> <a id="75f090098da859d4" href="R/75f090098da859d4.html" target="n" data-glyph="106,1" class="i property">Payload</a> { <b>get</b> =&gt; <span class="i">JsonSerializer</span>.<span class="i">Deserialize</span>&lt;<a href="Models/JsonWebTokenBody.cs.html#bde4b8e0c1f46143" class="t t">JsonWebTokenBody</a>&gt;(<a href="#fc7c2e7cbc755662" class="i property">TokenBodyBytes</a>.<span class="i">ToArray</span>()); }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Expiration time for the token.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">DateTimeOffset</span> <a id="4794edf81fd0cd80" href="R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">ExpirationTime</a> { <b>get</b> =&gt; <span class="i">DateTimeOffset</span>.<span class="i">FromUnixTimeSeconds</span>(<a href="#75f090098da859d4" class="i property">Payload</a>.<a href="Models/JsonWebTokenBody.cs.html#9c20977b222dd63b" class="i property">ExpirationTime</a>); }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Time before which this token is not valid.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">DateTimeOffset</span> <a id="b152cf38b91fc04e" href="R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">NotBeforeTime</a> { <b>get</b> =&gt; <span class="i">DateTimeOffset</span>.<span class="i">FromUnixTimeSeconds</span>(<a href="#75f090098da859d4" class="i property">Payload</a>.<a href="Models/JsonWebTokenBody.cs.html#4c2b05bc7a4e31e6" class="i property">NotBeforeTime</a>); }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Time at which this token was issued.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">DateTimeOffset</span> <a id="ff10f40733375384" href="R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">IssuedAtTime</a> { <b>get</b> =&gt; <span class="i">DateTimeOffset</span>.<span class="i">FromUnixTimeSeconds</span>(<a href="#75f090098da859d4" class="i property">Payload</a>.<a href="Models/JsonWebTokenBody.cs.html#a8bd25efcf58ad0c" class="i property">IssuedAtTime</a>); }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Represents the body of the token encoded as a string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="66a76bf06b2e2675" href="R/66a76bf06b2e2675.html" target="n" data-glyph="102,1" class="i property">TokenBody</a>  { <b>get</b> =&gt; <span class="i">Encoding</span>.<span class="i">UTF8</span>.<span class="i">GetString</span>(<a href="#fc7c2e7cbc755662" class="i property">TokenBodyBytes</a>.<span class="i">ToArray</span>()); }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Represents the body of the token encoded as a string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="11f0681b2ace6882" href="R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">TokenHeader</a> { <b>get</b> =&gt; <span class="i">Encoding</span>.<span class="i">UTF8</span>.<span class="i">GetString</span>(<a href="#120bea08946b4e17" class="i property">TokenHeaderBytes</a>.<span class="i">ToArray</span>()); }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Validate a JSON Web Token returned by the MAA.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">attestationSigningCertificates</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Signing Certificates used to validate the token.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">validationCallback</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">User provided callback which allows the customer to validate the token.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public virtual bool</b> <a id="7e9bbfc484893188" href="R/7e9bbfc484893188.html" target="n" data-glyph="72,1" class="i method">ValidateToken</a>(<span class="i">IReadOnlyList</span>&lt;<a href="Models/AttestationSigner.cs.html#f9ef2caf091b7259" class="t t">AttestationSigner</a>&gt; <span id="r2 rd" class="r2 r">attestationSigningCertificates</span>, <span class="i">Func</span>&lt;<a href="#fe59844e2c351bcf" class="t t">AttestationToken</a>, <a href="Models/AttestationSigner.cs.html#f9ef2caf091b7259" class="t t">AttestationSigner</a>, <b>bool</b>&gt; <span id="r3 rd" class="r3 r">validationCallback</span> = <b>default</b>)
        {
            <a href="Shared/Argument.cs.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<span class="r2 r">attestationSigningCertificates</span>, <b>nameof</b>(<span class="r2 r">attestationSigningCertificates</span>));
            <a href="Shared/Argument.cs.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<span class="r2 r">attestationSigningCertificates</span>[0], <b>nameof</b>(<span class="r2 r">attestationSigningCertificates</span>));
            <a href="Shared/Argument.cs.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNullOrEmpty</span>(<span class="r2 r">attestationSigningCertificates</span>, <b>nameof</b>(<span class="r2 r">attestationSigningCertificates</span>));
 
            <b>if</b> (<span class="r3 r">validationCallback</span> != <b>null</b>)
            {
                <b>return</b> <span class="r3 r">validationCallback</span>(<a href="#fe59844e2c351bcf" class="k">this</a>, <span class="r2 r">attestationSigningCertificates</span>[0]);
            }
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieves the body of the AttestationToken as the specified type.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">typeparam</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r t">T</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Underlying type for the token body.</span><span class="c">&lt;/</span><span class="c">typeparam</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public</b> <span class="r4 r t">T</span> <a id="8cd93a322ee575d5" href="R/8cd93a322ee575d5.html" target="n" data-glyph="72,1" class="i method">GetBody</a>&lt;<span id="r4 rd t" class="r4 r t">T</span>&gt;()
            <b>where</b> <span class="r4 r t">T</span>: <b>class</b>
        {
            <b>lock</b> (<a href="#ef4dd56a81bb8ac4" class="i field">_statelock</a>)
            {
                <b>if</b> (<a href="#b3276bbea4ab52a1" class="i field">_deserializedBody</a> == <b>null</b> || <a href="#b3276bbea4ab52a1" class="i field">_deserializedBody</a>.<span class="i">GetType</span>() != <b>typeof</b>(<span class="r4 r t">T</span>))
                {
                    <a href="#b3276bbea4ab52a1" class="i field">_deserializedBody</a> = <span class="i">JsonSerializer</span>.<span class="i">Deserialize</span>&lt;<span class="r4 r t">T</span>&gt;(<a href="#fc7c2e7cbc755662" class="i property">TokenBodyBytes</a>.<span class="i">ToArray</span>(), <a href="#78b0f76cb0f27d49" class="i field">_options</a>);
                }
                <b>return</b> (<span class="r4 r t">T</span>)<a href="#b3276bbea4ab52a1" class="i field">_deserializedBody</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">inheritdoc</span><span class="c">/&gt;</span>
        <b>public override string</b> <a id="60b26ef333128ae4" href="R/60b26ef333128ae4.html" target="n" data-glyph="72,1" class="i method">ToString</a>()
        {
            <b>return</b> <a href="#6470bbe9ad3e1a22" class="i field">_token</a> ??  <span class="i">GetType</span>().<span class="i">Name</span>;
        }
    }
}
</pre></td></tr></table></div></body></html>
