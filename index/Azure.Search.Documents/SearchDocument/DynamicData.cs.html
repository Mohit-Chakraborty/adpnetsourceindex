<!DOCTYPE html>
<html><head><title>DynamicData.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(110);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Search.Documents/SearchDocument/DynamicData.cs" target="_top">SearchDocument\DynamicData.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Search.Documents" target="_top">Azure.Search.Documents.csproj</a> (Azure.Search.Documents)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">EXPERIMENTAL_DYNAMIC</span>
<span class="e">
using System;
using System.Collections.Generic;
using System.Dynamic;
using System.Linq.Expressions;
using System.Reflection;
 
namespace Azure.Core
{
    /// &lt;summary&gt;
    /// Represents an untyped, structured document returned from or provided to
    /// service operations.  It can be accessed as either a dynamic object or a
    /// dictionary.
    /// &lt;/summary&gt;
    public partial class DynamicData : IDynamicMetaObjectProvider
    {
        /// &lt;summary&gt;
        /// Initializes a new instance of the DynamicData class.
        /// &lt;/summary&gt;
        public DynamicData() : this(null) { }
 
        /// &lt;summary&gt;
        /// Initializes a new instance of the DynamicData class with initial
        /// values.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;values&quot;&gt;Initial values of the document.&lt;/param&gt;
        public DynamicData(IDictionary&lt;string, object&gt; values) =&gt;
            _values = values != null ?
                new Dictionary&lt;string, object&gt;(values) :
                new Dictionary&lt;string, object&gt;();
 
        /// &lt;inheritdoc /&gt;
        DynamicMetaObject IDynamicMetaObjectProvider.GetMetaObject(Expression parameter) =&gt;
            new MetaObject(parameter, this);
 
        /// &lt;summary&gt;
        /// Meta-object wrapping &lt;see cref=&quot;DynamicData.GetValue(string, Type)&quot;/&gt;
        /// and &lt;see cref=&quot;DynamicData.SetValue(string, object)&quot;/&gt;.
        ///
        /// Read &quot;Implementing Dynamic Interfaces&quot; by Bill Wagner for more
        /// information about what these meta-objects are doing.
        /// &lt;/summary&gt;
        private class MetaObject : DynamicMetaObject
        {
            /// &lt;summary&gt;
            /// Reference to &lt;see cref=&quot;DynamicData.GetValue(string, Type)&quot;/&gt;.
            /// &lt;/summary&gt;
            private static readonly MethodInfo s_getter =
                typeof(DynamicData).GetMethod(
                    nameof(GetValue),
                    BindingFlags.NonPublic | BindingFlags.Instance,
                    null,
                    new Type[] { typeof(string), typeof(Type) },
                    null);
 
            /// &lt;summary&gt;
            /// Reference to &lt;see cref=&quot;DynamicData.SetValue(string, object)&quot;/&gt;.
            /// &lt;/summary&gt;
            private static readonly MethodInfo s_setter =
                typeof(DynamicData).GetMethod(
                    nameof(SetValue),
                    BindingFlags.NonPublic | BindingFlags.Instance);
 
            /// &lt;summary&gt;
            /// Creates a new MetaObject.
            /// &lt;/summary&gt;
            /// &lt;param name=&quot;expression&quot;&gt;The expression invoking the dynamic operation.&lt;/param&gt;
            /// &lt;param name=&quot;value&quot;&gt;The &lt;see cref=&quot;DynamicData&quot;/&gt; instance.&lt;/param&gt;
            public MetaObject(Expression expression, IDynamicMetaObjectProvider value) :
                base(expression, BindingRestrictions.Empty, value)
            {
            }
 
            /// &lt;summary&gt;
            /// Build a dynamic meta-object that represents calling either
            /// GetValue(name, type) or SetValue(name, value).
            /// &lt;/summary&gt;
            /// &lt;param name=&quot;method&quot;&gt;The method to invoke.&lt;/param&gt;
            /// &lt;param name=&quot;arguments&quot;&gt;The argument expressions.&lt;/param&gt;
            /// &lt;returns&gt;The meta-object for the invocation.&lt;/returns&gt;
            private DynamicMetaObject BuildMetaObject(MethodInfo method, params Expression[] arguments) =&gt;
                new DynamicMetaObject(
                    Expression.Call(
                        Expression.Convert(Expression, LimitType),
                        method,
                        arguments),
                    BindingRestrictions.GetTypeRestriction(Expression, LimitType));
 
            /// &lt;inheritdoc /&gt;
            public override DynamicMetaObject BindGetMember(GetMemberBinder binder) =&gt;
                BuildMetaObject(
                    s_getter,
                    Expression.Constant(binder.Name),
                    Expression.Constant(binder.ReturnType ?? typeof(object)));
 
            /// &lt;inheritdoc /&gt;
            public override DynamicMetaObject BindSetMember(SetMemberBinder binder, DynamicMetaObject value) =&gt;
                BuildMetaObject(
                    s_setter,
                    Expression.Constant(binder.Name),
                    Expression.Convert(value.Expression, typeof(object)));
        }
    }
}
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
</pre></td></tr></table></div></body></html>
