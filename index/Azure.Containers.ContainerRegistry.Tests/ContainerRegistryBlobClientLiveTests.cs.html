<!DOCTYPE html>
<html><head><title>ContainerRegistryBlobClientLiveTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(274);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Containers.ContainerRegistry.Tests/ContainerRegistryBlobClientLiveTests.cs" target="_top">ContainerRegistryBlobClientLiveTests.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/containerregistry/Azure.Containers.ContainerRegistry/tests/ContainerRegistryBlobClientLiveTests.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Containers.ContainerRegistry.Tests" target="_top">Azure.Containers.ContainerRegistry.Tests.csproj</a> (Azure.Containers.ContainerRegistry.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Containers</span>.<span class="i n">ContainerRegistry</span>.<span class="i n">Specialized</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">TestFramework</span>;
<b>using</b> <span class="i n">NUnit</span>.<span class="i n">Framework</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Containers</span>.<span class="i n">ContainerRegistry</span>.<span class="i n">Tests</span>
{
    [<span class="t constructor">NonParallelizable</span>]
    <b>public class</b> <a id="861ea2e027f3f0bd" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">ContainerRegistryBlobClientLiveTests</a> : <a href="ContainerRegistryRecordedTestBase.cs.html#f6040f484d80ebb4" class="t t">ContainerRegistryRecordedTestBase</a>
    {
        <b>public</b> <a id="40ad9bf9948b8f8d" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">ContainerRegistryBlobClientLiveTests</a>(<b>bool</b> <span id="r0 rd" class="r0 r">isAsync</span>) : <a href="ContainerRegistryRecordedTestBase.cs.html#34ee171011c31570" class="k">base</a>(<span class="r0 r">isAsync</span>)
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create an OciManifest type that matches the contents of the manifest.json test data file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static</b> <a href="/Azure.Containers.ContainerRegistry/A.html#48b540296bf207ec" class="t t">OciManifest</a> <a id="d4e6fb1363116515" href="R/d4e6fb1363116515.html" target="n" data-glyph="76,1" class="i method">CreateManifest</a>()
        {
            <a href="/Azure.Containers.ContainerRegistry/A.html#48b540296bf207ec" class="t t">OciManifest</a> <span id="r1 rd" class="r1 r">manifest</span> = <b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#ffd3e8a098f14791" class="t constructor">OciManifest</a>()
            {
                <a href="/Azure.Containers.ContainerRegistry/A.html#6bf07b6e2bb3d361" class="i property">SchemaVersion</a> = 2,
                <a href="/Azure.Containers.ContainerRegistry/A.html#1788522791a0ad7a" class="i property">Config</a> = <b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#f4cbf9ba2c954f4e" class="t constructor">OciBlobDescriptor</a>()
                {
                    <a href="/Azure.Containers.ContainerRegistry/A.html#201a9576f6cf5cc1" class="i property">MediaType</a> = <span class="s">&quot;application/vnd.acme.rocket.config&quot;</span>,
                    <a href="/Azure.Containers.ContainerRegistry/A.html#a437b6d4dda7b43d" class="i property">Digest</a> = <span class="s">&quot;sha256:d25b42d3dbad5361ed2d909624d899e7254a822c9a632b582ebd3a44f9b0dbc8&quot;</span>,
                    <a href="/Azure.Containers.ContainerRegistry/A.html#8b9f0940063cf77a" class="i property">Size</a> = 171
                }
            };
            <span class="r1 r">manifest</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#a83d67ce65273d41" class="i property">Layers</a>.<a href="@0@mscorlib/A.html#a9319db8c62ae453" class="i method">Add</a>(<b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#f4cbf9ba2c954f4e" class="t constructor">OciBlobDescriptor</a>()
            {
                <a href="/Azure.Containers.ContainerRegistry/A.html#201a9576f6cf5cc1" class="i property">MediaType</a> = <span class="s">&quot;application/vnd.oci.image.layer.v1.tar&quot;</span>,
                <a href="/Azure.Containers.ContainerRegistry/A.html#a437b6d4dda7b43d" class="i property">Digest</a> = <span class="s">&quot;sha256:654b93f61054e4ce90ed203bb8d556a6200d5f906cf3eca0620738d6dc18cbed&quot;</span>,
                <a href="/Azure.Containers.ContainerRegistry/A.html#8b9f0940063cf77a" class="i property">Size</a> = 28,
                <a href="/Azure.Containers.ContainerRegistry/A.html#76bfa27fb196aa1e" class="i property">Annotations</a> = <b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#0802a412ec547871" class="t constructor">OciAnnotations</a>()
                {
                    <a href="/Azure.Containers.ContainerRegistry/A.html#15f9568637661a8a" class="i property">Name</a> = <span class="s">&quot;artifact.txt&quot;</span>
                }
            });
 
            <b>return</b> <span class="r1 r">manifest</span>;
        }
 
        [<a href="/Azure.Core.TestFramework/A.html#6f14c3950ca7dafb" class="t constructor">RecordedTest</a>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="034fdf155d51328b" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CanUploadOciManifest</a>()
        {
            <span class="c">// Arrange</span>
            <a href="/Azure.Containers.ContainerRegistry/A.html#2eebe0f269372ffa" class="k">var</a> <span id="r2 rd" class="r2 r">client</span> = <a href="ContainerRegistryRecordedTestBase.cs.html#3dd77ca85af74020" class="i method">CreateBlobClient</a>(<span class="s">&quot;oci-artifact&quot;</span>);
 
            <span class="c">// Act</span>
            <a href="/Azure.Containers.ContainerRegistry/A.html#48b540296bf207ec" class="k">var</a> <span id="r3 rd" class="r3 r">manifest</span> = <a href="#d4e6fb1363116515" class="i method">CreateManifest</a>();
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="k">var</a> <span id="r4 rd" class="r4 r">uploadResult</span> = <b>await</b> <span class="r2 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#6d31343c485a40a1" class="i method">UploadManifestAsync</a>(<span class="r3 r">manifest</span>);
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r5 rd" class="r5 r">digest</span> = <span class="r4 r">uploadResult</span>.<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>.<a href="/Azure.Containers.ContainerRegistry/A.html#551dbd822bf96bf4" class="i property">Digest</a>;
 
            <span class="c">// Assert</span>
            <a href="/Azure.Containers.ContainerRegistry/A.html#946ae6105ea9f07d" class="t t">DownloadManifestOptions</a> <span id="r6 rd" class="r6 r">downloadOptions</span> = <b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#0a721029d5e94b89" class="t constructor">DownloadManifestOptions</a>(<b>null</b>, <span class="r5 r">digest</span>);
            <b>using</b> <a href="/Azure.Containers.ContainerRegistry/A.html#8a2932cca4447e57" class="k">var</a> <span id="r7 rd" class="r7 r">downloadResultValue</span> = (<b>await</b> <span class="r2 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#85bb329d4913b9fe" class="i method">DownloadManifestAsync</a>(<span class="r6 r">downloadOptions</span>)).<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>;
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(0, <span class="r7 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#d3b907d31679f197" class="i property">ManifestStream</a>.<a href="@0@mscorlib/A.html#35112b2a53fb536a" class="i property">Position</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r5 r">digest</span>, <span class="r7 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#afdbf08f61956ec9" class="i property">Digest</a>);
            <a href="#1b27e8d295a75557" class="i method">ValidateManifest</a>(<span class="r7 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#3fb11a1c2ef3a594" class="i property">Manifest</a>);
 
            <span class="c">// Clean up</span>
            <b>await</b> <span class="r2 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#ece8d41888d8f0dd" class="i method">DeleteManifestAsync</a>(<span class="r5 r">digest</span>);
        }
 
        [<a href="/Azure.Core.TestFramework/A.html#6f14c3950ca7dafb" class="t constructor">RecordedTest</a>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="b171de35ce72f218" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CanUploadOciManifestStream</a>()
        {
            <span class="c">// Arrange</span>
            <a href="/Azure.Containers.ContainerRegistry/A.html#2eebe0f269372ffa" class="k">var</a> <span id="r8 rd" class="r8 r">client</span> = <a href="ContainerRegistryRecordedTestBase.cs.html#3dd77ca85af74020" class="i method">CreateBlobClient</a>(<span class="s">&quot;oci-artifact&quot;</span>);
 
            <span class="c">// Act</span>
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r9 rd" class="r9 r">payload</span> = <span class="s">&quot;&quot;</span> +
                <span class="s">&quot;{&quot;</span> +
                    <span class="s">&quot;\&quot;schemaVersion\&quot;:2,&quot;</span> +
                    <span class="s">&quot;\&quot;config\&quot;:&quot;</span> +
                    <span class="s">&quot;{&quot;</span> +
                        <span class="s">&quot;\&quot;mediaType\&quot;:\&quot;application/vnd.acme.rocket.config\&quot;,&quot;</span> +
                        <span class="s">&quot;\&quot;size\&quot;:171,&quot;</span> +
                        <span class="s">&quot;\&quot;digest\&quot;:\&quot;sha256:d25b42d3dbad5361ed2d909624d899e7254a822c9a632b582ebd3a44f9b0dbc8\&quot;&quot;</span> +
                    <span class="s">&quot;},&quot;</span> +
                    <span class="s">&quot;\&quot;layers\&quot;:&quot;</span> +
                    <span class="s">&quot;[&quot;</span> +
                        <span class="s">&quot;{&quot;</span> +
                            <span class="s">&quot;\&quot;mediaType\&quot;:\&quot;application/vnd.oci.image.layer.v1.tar\&quot;,&quot;</span> +
                            <span class="s">&quot;\&quot;size\&quot;:28,&quot;</span> +
                            <span class="s">&quot;\&quot;digest\&quot;:\&quot;sha256:654b93f61054e4ce90ed203bb8d556a6200d5f906cf3eca0620738d6dc18cbed\&quot;&quot;</span> +
                        <span class="s">&quot;}&quot;</span> +
                    <span class="s">&quot;]&quot;</span> +
                <span class="s">&quot;}&quot;</span>;
 
            <b>using</b> <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r10 rd" class="r10 r">manifest</span> = <b>new</b> <a href="@0@mscorlib/A.html#f92fa270fda9a82b" class="t constructor">MemoryStream</a>(<a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#65768102b7ace585" class="i property">ASCII</a>.<a href="@0@mscorlib/A.html#83f2d2c6f22db1a9" class="i method">GetBytes</a>(<span class="r9 r">payload</span>));
 
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="k">var</a> <span id="r11 rd" class="r11 r">uploadResult</span> = <b>await</b> <span class="r8 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#325983c5a466b8b4" class="i method">UploadManifestAsync</a>(<span class="r10 r">manifest</span>);
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r12 rd" class="r12 r">digest</span> = <span class="r11 r">uploadResult</span>.<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>.<a href="/Azure.Containers.ContainerRegistry/A.html#551dbd822bf96bf4" class="i property">Digest</a>;
 
            <span class="c">// Assert</span>
            <a href="/Azure.Containers.ContainerRegistry/A.html#946ae6105ea9f07d" class="t t">DownloadManifestOptions</a> <span id="r13 rd" class="r13 r">downloadOptions</span> = <b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#0a721029d5e94b89" class="t constructor">DownloadManifestOptions</a>(<b>null</b>, <span class="r12 r">digest</span>);
            <b>using</b> <a href="/Azure.Containers.ContainerRegistry/A.html#8a2932cca4447e57" class="k">var</a> <span id="r14 rd" class="r14 r">downloadResultValue</span> = (<b>await</b> <span class="r8 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#85bb329d4913b9fe" class="i method">DownloadManifestAsync</a>(<span class="r13 r">downloadOptions</span>)).<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>;
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(0, <span class="r14 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#d3b907d31679f197" class="i property">ManifestStream</a>.<a href="@0@mscorlib/A.html#35112b2a53fb536a" class="i property">Position</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r12 r">digest</span>, <span class="r14 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#afdbf08f61956ec9" class="i property">Digest</a>);
            <a href="#1b27e8d295a75557" class="i method">ValidateManifest</a>(<span class="r14 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#3fb11a1c2ef3a594" class="i property">Manifest</a>);
 
            <span class="c">// Clean up</span>
            <b>await</b> <span class="r8 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#ece8d41888d8f0dd" class="i method">DeleteManifestAsync</a>(<span class="r12 r">digest</span>);
        }
 
        [<a href="/Azure.Core.TestFramework/A.html#6f14c3950ca7dafb" class="t constructor">RecordedTest</a>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="0400b401b1a51a19" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CanUploadOciManifestWithTag</a>()
        {
            <span class="c">// Arrange</span>
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r15 rd" class="r15 r">repository</span> = <span class="s">&quot;oci-artifact&quot;</span>;
            <a href="/Azure.Containers.ContainerRegistry/A.html#2eebe0f269372ffa" class="k">var</a> <span id="r16 rd" class="r16 r">client</span> = <a href="ContainerRegistryRecordedTestBase.cs.html#3dd77ca85af74020" class="i method">CreateBlobClient</a>(<span class="r15 r">repository</span>);
            <a href="/Azure.Containers.ContainerRegistry/A.html#179d6e019bb1f0da" class="k">var</a> <span id="r17 rd" class="r17 r">metadataClient</span> = <a href="ContainerRegistryRecordedTestBase.cs.html#21483bc7152543a2" class="i method">CreateClient</a>();
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r18 rd" class="r18 r">tag</span> = <span class="s">&quot;v1&quot;</span>;
 
            <b>await</b> <a href="#ff9ae22624783a72" class="i method">UploadManifestPrerequisites</a>(<span class="r16 r">client</span>);
 
            <span class="c">// Act</span>
            <a href="/Azure.Containers.ContainerRegistry/A.html#48b540296bf207ec" class="k">var</a> <span id="r19 rd" class="r19 r">manifest</span> = <a href="#d4e6fb1363116515" class="i method">CreateManifest</a>();
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="k">var</a> <span id="r20 rd" class="r20 r">uploadResult</span> = <b>await</b> <span class="r16 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#6d31343c485a40a1" class="i method">UploadManifestAsync</a>(<span class="r19 r">manifest</span>, <b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#4b7e7854c4b44af7" class="t constructor">UploadManifestOptions</a>(<span class="r18 r">tag</span>));
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r21 rd" class="r21 r">digest</span> = <span class="r20 r">uploadResult</span>.<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>.<a href="/Azure.Containers.ContainerRegistry/A.html#551dbd822bf96bf4" class="i property">Digest</a>;
 
            <span class="c">// Assert</span>
            <a href="/Azure.Containers.ContainerRegistry/A.html#946ae6105ea9f07d" class="t t">DownloadManifestOptions</a> <span id="r22 rd" class="r22 r">downloadOptions</span> = <b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#0a721029d5e94b89" class="t constructor">DownloadManifestOptions</a>(<b>null</b>, <span class="r21 r">digest</span>);
            <b>using</b> <a href="/Azure.Containers.ContainerRegistry/A.html#8a2932cca4447e57" class="k">var</a> <span id="r23 rd" class="r23 r">downloadResultValue</span> = (<b>await</b> <span class="r16 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#85bb329d4913b9fe" class="i method">DownloadManifestAsync</a>(<span class="r22 r">downloadOptions</span>)).<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>;
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(0, <span class="r23 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#d3b907d31679f197" class="i property">ManifestStream</a>.<a href="@0@mscorlib/A.html#35112b2a53fb536a" class="i property">Position</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r21 r">digest</span>, <span class="r23 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#afdbf08f61956ec9" class="i property">Digest</a>);
            <a href="#1b27e8d295a75557" class="i method">ValidateManifest</a>(<span class="r23 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#3fb11a1c2ef3a594" class="i property">Manifest</a>);
 
            <a href="/Azure.Containers.ContainerRegistry/A.html#597bc43d7801e0bd" class="k">var</a> <span id="r24 rd" class="r24 r">artifact</span> = <span class="r17 r">metadataClient</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#adbc26fb6ac34b6f" class="i method">GetArtifact</a>(<span class="r15 r">repository</span>, <span class="r21 r">digest</span>);
            <a href="/Azure.Core/A.html#ce6e47443d11533b" class="k">var</a> <span id="r25 rd" class="r25 r">tags</span> = <span class="r24 r">artifact</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#1c654a2d9b354cf8" class="i method">GetTagPropertiesCollectionAsync</a>();
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r26 rd" class="r26 r">count</span> = <b>await</b> <span class="r25 r">tags</span>.<span class="i method">CountAsync</span>();
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(1, <span class="r26 r">count</span>);
            <a href="/Azure.Containers.ContainerRegistry/A.html#6999f31275fc7ca2" class="k">var</a> <span id="r27 rd" class="r27 r">firstTag</span> = <b>await</b> <span class="r25 r">tags</span>.<span class="i method">FirstAsync</span>();
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r18 r">tag</span>, <span class="r27 r">firstTag</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#02a93b03dba10520" class="i property">Name</a>);
 
            <span class="c">// Clean up</span>
            <b>await</b> <span class="r16 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#ece8d41888d8f0dd" class="i method">DeleteManifestAsync</a>(<span class="r21 r">digest</span>);
        }
 
        [<a href="/Azure.Core.TestFramework/A.html#6f14c3950ca7dafb" class="t constructor">RecordedTest</a>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="b219954826a7b49b" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CanUploadOciManifestStreamWithTag</a>()
        {
            <span class="c">// Arrange</span>
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r28 rd" class="r28 r">repository</span> = <span class="s">&quot;oci-artifact&quot;</span>;
            <a href="/Azure.Containers.ContainerRegistry/A.html#2eebe0f269372ffa" class="k">var</a> <span id="r29 rd" class="r29 r">client</span> = <a href="ContainerRegistryRecordedTestBase.cs.html#3dd77ca85af74020" class="i method">CreateBlobClient</a>(<span class="r28 r">repository</span>);
            <a href="/Azure.Containers.ContainerRegistry/A.html#179d6e019bb1f0da" class="k">var</a> <span id="r30 rd" class="r30 r">metadataClient</span> = <a href="ContainerRegistryRecordedTestBase.cs.html#21483bc7152543a2" class="i method">CreateClient</a>();
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r31 rd" class="r31 r">tag</span> = <span class="s">&quot;v1&quot;</span>;
 
            <b>await</b> <a href="#ff9ae22624783a72" class="i method">UploadManifestPrerequisites</a>(<span class="r29 r">client</span>);
 
            <span class="c">// Act</span>
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r32 rd" class="r32 r">payload</span> = <span class="s">&quot;&quot;</span> +
                <span class="s">&quot;{&quot;</span> +
                    <span class="s">&quot;\&quot;schemaVersion\&quot;:2,&quot;</span> +
                    <span class="s">&quot;\&quot;config\&quot;:&quot;</span> +
                    <span class="s">&quot;{&quot;</span> +
                        <span class="s">&quot;\&quot;mediaType\&quot;:\&quot;application/vnd.acme.rocket.config\&quot;,&quot;</span> +
                        <span class="s">&quot;\&quot;size\&quot;:171,&quot;</span> +
                        <span class="s">&quot;\&quot;digest\&quot;:\&quot;sha256:d25b42d3dbad5361ed2d909624d899e7254a822c9a632b582ebd3a44f9b0dbc8\&quot;&quot;</span> +
                    <span class="s">&quot;},&quot;</span> +
                    <span class="s">&quot;\&quot;layers\&quot;:&quot;</span> +
                    <span class="s">&quot;[&quot;</span> +
                        <span class="s">&quot;{&quot;</span> +
                            <span class="s">&quot;\&quot;mediaType\&quot;:\&quot;application/vnd.oci.image.layer.v1.tar\&quot;,&quot;</span> +
                            <span class="s">&quot;\&quot;size\&quot;:28,&quot;</span> +
                            <span class="s">&quot;\&quot;digest\&quot;:\&quot;sha256:654b93f61054e4ce90ed203bb8d556a6200d5f906cf3eca0620738d6dc18cbed\&quot;&quot;</span> +
                        <span class="s">&quot;}&quot;</span> +
                    <span class="s">&quot;]&quot;</span> +
                <span class="s">&quot;}&quot;</span>;
 
            <b>using</b> <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r33 rd" class="r33 r">manifest</span> = <b>new</b> <a href="@0@mscorlib/A.html#f92fa270fda9a82b" class="t constructor">MemoryStream</a>(<a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#65768102b7ace585" class="i property">ASCII</a>.<a href="@0@mscorlib/A.html#83f2d2c6f22db1a9" class="i method">GetBytes</a>(<span class="r32 r">payload</span>));
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="k">var</a> <span id="r34 rd" class="r34 r">uploadResult</span> = <b>await</b> <span class="r29 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#325983c5a466b8b4" class="i method">UploadManifestAsync</a>(<span class="r33 r">manifest</span>, <b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#4b7e7854c4b44af7" class="t constructor">UploadManifestOptions</a>(<span class="r31 r">tag</span>));
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r35 rd" class="r35 r">digest</span> = <span class="r34 r">uploadResult</span>.<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>.<a href="/Azure.Containers.ContainerRegistry/A.html#551dbd822bf96bf4" class="i property">Digest</a>;
 
            <span class="c">// Assert</span>
            <a href="/Azure.Containers.ContainerRegistry/A.html#946ae6105ea9f07d" class="t t">DownloadManifestOptions</a> <span id="r36 rd" class="r36 r">downloadOptions</span> = <b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#0a721029d5e94b89" class="t constructor">DownloadManifestOptions</a>(<b>null</b>, <span class="r35 r">digest</span>);
            <b>using</b> <a href="/Azure.Containers.ContainerRegistry/A.html#8a2932cca4447e57" class="k">var</a> <span id="r37 rd" class="r37 r">downloadResultValue</span> = (<b>await</b> <span class="r29 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#85bb329d4913b9fe" class="i method">DownloadManifestAsync</a>(<span class="r36 r">downloadOptions</span>)).<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>;
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(0, <span class="r37 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#d3b907d31679f197" class="i property">ManifestStream</a>.<a href="@0@mscorlib/A.html#35112b2a53fb536a" class="i property">Position</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r35 r">digest</span>, <span class="r37 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#afdbf08f61956ec9" class="i property">Digest</a>);
            <a href="#1b27e8d295a75557" class="i method">ValidateManifest</a>(<span class="r37 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#3fb11a1c2ef3a594" class="i property">Manifest</a>);
 
            <a href="/Azure.Containers.ContainerRegistry/A.html#597bc43d7801e0bd" class="k">var</a> <span id="r38 rd" class="r38 r">artifact</span> = <span class="r30 r">metadataClient</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#adbc26fb6ac34b6f" class="i method">GetArtifact</a>(<span class="r28 r">repository</span>, <span class="r35 r">digest</span>);
            <a href="/Azure.Core/A.html#ce6e47443d11533b" class="k">var</a> <span id="r39 rd" class="r39 r">tags</span> = <span class="r38 r">artifact</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#1c654a2d9b354cf8" class="i method">GetTagPropertiesCollectionAsync</a>();
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r40 rd" class="r40 r">count</span> = <b>await</b> <span class="r39 r">tags</span>.<span class="i method">CountAsync</span>();
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(1, <span class="r40 r">count</span>);
            <a href="/Azure.Containers.ContainerRegistry/A.html#6999f31275fc7ca2" class="k">var</a> <span id="r41 rd" class="r41 r">firstTag</span> = <b>await</b> <span class="r39 r">tags</span>.<span class="i method">FirstAsync</span>();
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r31 r">tag</span>, <span class="r41 r">firstTag</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#02a93b03dba10520" class="i property">Name</a>);
 
            <span class="r36 r">downloadOptions</span> = <b>new</b> <a href="/Azure.Containers.ContainerRegistry/A.html#0a721029d5e94b89" class="t constructor">DownloadManifestOptions</a>(<span class="r31 r">tag</span>, <b>null</b>);
            <b>using</b> <a href="/Azure.Containers.ContainerRegistry/A.html#8a2932cca4447e57" class="k">var</a> <span id="r42 rd" class="r42 r">downloadResultValue2</span> = (<b>await</b> <span class="r29 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#85bb329d4913b9fe" class="i method">DownloadManifestAsync</a>(<span class="r36 r">downloadOptions</span>)).<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>;
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(0, <span class="r37 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#d3b907d31679f197" class="i property">ManifestStream</a>.<a href="@0@mscorlib/A.html#35112b2a53fb536a" class="i property">Position</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r35 r">digest</span>, <span class="r37 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#afdbf08f61956ec9" class="i property">Digest</a>);
            <a href="#1b27e8d295a75557" class="i method">ValidateManifest</a>(<span class="r37 r">downloadResultValue</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#3fb11a1c2ef3a594" class="i property">Manifest</a>);
 
            <span class="c">// Clean up</span>
            <b>await</b> <span class="r29 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#ece8d41888d8f0dd" class="i method">DeleteManifestAsync</a>(<span class="r35 r">digest</span>);
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="ff9ae22624783a72" href="R/ff9ae22624783a72.html" target="n" data-glyph="76,1" class="i method">UploadManifestPrerequisites</a>(<a href="/Azure.Containers.ContainerRegistry/A.html#2eebe0f269372ffa" class="t t">ContainerRegistryBlobClient</a> <span id="r43 rd" class="r43 r">client</span>)
        {
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r44 rd" class="r44 r">layer</span> = <span class="s">&quot;654b93f61054e4ce90ed203bb8d556a6200d5f906cf3eca0620738d6dc18cbed&quot;</span>;
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r45 rd" class="r45 r">config</span> = <span class="s">&quot;config.json&quot;</span>;
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r46 rd" class="r46 r">basePath</span> = <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#b24651eb14e8aa68" class="i method">Combine</a>(<span class="t t">TestContext</span>.<span class="i property">CurrentContext</span>.<span class="i property">TestDirectory</span>, <span class="s">&quot;Data&quot;</span>, <span class="s">&quot;oci-artifact&quot;</span>);
 
            <span class="c">// Upload config</span>
            <b>using</b> (<a href="@0@mscorlib/A.html#e23a38af5d11ddd3" class="k">var</a> <span id="r47 rd" class="r47 r">fs</span> = <a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#7a7d1c864bec521e" class="i method">OpenRead</a>(<a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#2d7263f86a526264" class="i method">Combine</a>(<span class="r46 r">basePath</span>, <span class="r45 r">config</span>)))
            {
                <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="k">var</a> <span id="r48 rd" class="r48 r">uploadResult</span> = <b>await</b> <span class="r43 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#8a6a4399a11f651f" class="i method">UploadBlobAsync</a>(<span class="r47 r">fs</span>);
            }
 
            <span class="c">// Upload layer</span>
            <b>using</b> (<a href="@0@mscorlib/A.html#e23a38af5d11ddd3" class="k">var</a> <span id="r49 rd" class="r49 r">fs</span> = <a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#7a7d1c864bec521e" class="i method">OpenRead</a>(<a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#2d7263f86a526264" class="i method">Combine</a>(<span class="r46 r">basePath</span>, <span class="r44 r">layer</span>)))
            {
                <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="k">var</a> <span id="r50 rd" class="r50 r">uploadResult</span> = <b>await</b> <span class="r43 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#8a6a4399a11f651f" class="i method">UploadBlobAsync</a>(<span class="r49 r">fs</span>);
            }
        }
 
        <b>private static void</b> <a id="1b27e8d295a75557" href="R/1b27e8d295a75557.html" target="n" data-glyph="76,1" class="i method">ValidateManifest</a>(<a href="/Azure.Containers.ContainerRegistry/A.html#48b540296bf207ec" class="t t">OciManifest</a> <span id="r51 rd" class="r51 r">manifest</span>)
        {
            <span class="c">// These are from the values in the Data\oci-artifact\manifest.json file.</span>
            <span class="t t">Assert</span>.<span class="i method">IsNotNull</span>(<span class="r51 r">manifest</span>);
 
            <span class="t t">Assert</span>.<span class="i method">IsNotNull</span>(<span class="r51 r">manifest</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#1788522791a0ad7a" class="i property">Config</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;application/vnd.acme.rocket.config&quot;</span>, <span class="r51 r">manifest</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#1788522791a0ad7a" class="i property">Config</a>.<a href="/Azure.Containers.ContainerRegistry/A.html#201a9576f6cf5cc1" class="i property">MediaType</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;sha256:d25b42d3dbad5361ed2d909624d899e7254a822c9a632b582ebd3a44f9b0dbc8&quot;</span>, <span class="r51 r">manifest</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#1788522791a0ad7a" class="i property">Config</a>.<a href="/Azure.Containers.ContainerRegistry/A.html#a437b6d4dda7b43d" class="i property">Digest</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(171, <span class="r51 r">manifest</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#1788522791a0ad7a" class="i property">Config</a>.<a href="/Azure.Containers.ContainerRegistry/A.html#8b9f0940063cf77a" class="i property">Size</a>);
 
            <span class="t t">Assert</span>.<span class="i method">IsNotNull</span>(<span class="r51 r">manifest</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#a83d67ce65273d41" class="i property">Layers</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(1, <span class="r51 r">manifest</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#a83d67ce65273d41" class="i property">Layers</a>.<a href="@0@mscorlib/A.html#3d6c21c4e9bd5f63" class="i property">Count</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;application/vnd.oci.image.layer.v1.tar&quot;</span>, <span class="r51 r">manifest</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#a83d67ce65273d41" class="i property">Layers</a>[0].<a href="/Azure.Containers.ContainerRegistry/A.html#201a9576f6cf5cc1" class="i property">MediaType</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;sha256:654b93f61054e4ce90ed203bb8d556a6200d5f906cf3eca0620738d6dc18cbed&quot;</span>, <span class="r51 r">manifest</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#a83d67ce65273d41" class="i property">Layers</a>[0].<a href="/Azure.Containers.ContainerRegistry/A.html#a437b6d4dda7b43d" class="i property">Digest</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(28, <span class="r51 r">manifest</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#a83d67ce65273d41" class="i property">Layers</a>[0].<a href="/Azure.Containers.ContainerRegistry/A.html#8b9f0940063cf77a" class="i property">Size</a>);
        }
 
        [<a href="/Azure.Core.TestFramework/A.html#6f14c3950ca7dafb" class="t constructor">RecordedTest</a>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="c7ef943e200c912c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CanUploadBlob</a>()
        {
            <span class="c">// Arrange</span>
            <a href="/Azure.Containers.ContainerRegistry/A.html#2eebe0f269372ffa" class="k">var</a> <span id="r52 rd" class="r52 r">client</span> = <a href="ContainerRegistryRecordedTestBase.cs.html#3dd77ca85af74020" class="i method">CreateBlobClient</a>(<span class="s">&quot;oci-artifact&quot;</span>);
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r53 rd" class="r53 r">blob</span> = <span class="s">&quot;654b93f61054e4ce90ed203bb8d556a6200d5f906cf3eca0620738d6dc18cbed&quot;</span>;
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r54 rd" class="r54 r">path</span> = <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#cf9ce66cb2a6d407" class="i method">Combine</a>(<span class="t t">TestContext</span>.<span class="i property">CurrentContext</span>.<span class="i property">TestDirectory</span>, <span class="s">&quot;Data&quot;</span>, <span class="s">&quot;oci-artifact&quot;</span>, <span class="r53 r">blob</span>);
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r55 rd" class="r55 r">digest</span> = <b>default</b>;
            <b>long</b> <span id="r56 rd" class="r56 r">streamLength</span>;
            <span class="c">// Act</span>
            <b>using</b> (<a href="@0@mscorlib/A.html#e23a38af5d11ddd3" class="k">var</a> <span id="r57 rd" class="r57 r">fs</span> = <a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#7a7d1c864bec521e" class="i method">OpenRead</a>(<span class="r54 r">path</span>))
            {
                <span class="r56 r">streamLength</span> = <span class="r57 r">fs</span>.<a href="@0@mscorlib/A.html#fa88edfdb51ed91c" class="i property">Length</a>;
                <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="k">var</a> <span id="r58 rd" class="r58 r">uploadResult</span> = <b>await</b> <span class="r52 r">client</span>.<a href="/Azure.Containers.ContainerRegistry/A.html#8a6a4399a11f651f" class="i method">UploadBlobAsync</a>(<span class="r57 r">fs</span>);
                <span class="r55 r">digest</span> = <span class="r58 r">uploadResult</span>.<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>.<a href="/Azure.Containers.ContainerRegistry/A.html#6229deb87ac72b84" class="i property">Digest</a>;
            }
 
            <span class="c">// Enable download code once Test proxy SSL issue is resolved [https://github.com/Azure/azure-sdk-tools/issues/2982]</span>
            <span class="c">// Assert</span>
            <span class="c">//var downloadResult = await client.DownloadBlobAsync(digest);</span>
            <span class="c">//Assert.AreEqual(digest, downloadResult.Value.Digest);</span>
            <span class="c">//Assert.AreEqual(streamLength, downloadResult.Value.Content.Length);</span>
 
            <span class="c">//// Clean up</span>
            <span class="c">//await client.DeleteBlobAsync(digest);</span>
            <span class="c">//downloadResult.Value.Dispose();</span>
        }
    }
}
</pre></td></tr></table></div></body></html>
