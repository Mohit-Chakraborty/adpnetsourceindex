<!DOCTYPE html>
<html><head><title>SearchServiceFixture.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(113);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Search.Management.Tests/Utilities/SearchServiceFixture.cs" target="_top">Utilities\SearchServiceFixture.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Search.Management.Tests" target="_top">tests\Microsoft.Azure.Management.Search.Tests.csproj</a> (Search.Management.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for</span>
<span class="c">// license information.</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Search</span>.<span class="i n">Tests</span>.<span class="i n">Utilities</span>
{
    <b>using</b> <span class="i n">System</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i">Linq</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">Search</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">Search</span>.<span class="i n">Models</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i">Test</span>.<span class="i">HttpRecorder</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Rest</span>.<span class="i n">ClientRuntime</span>.<span class="i n">Azure</span>.<span class="i n">TestFramework</span>;
    <b>using</b> <span class="i">Xunit</span>;
 
    <b>public class</b> <a id="37bd6f3c822b3996" href="../R/37bd6f3c822b3996.html" target="n" data-glyph="0,0" class="t t"><span id="be6cb189e360a22a">SearchServiceFixture</span></a> : <a href="ResourceGroupFixture.cs.html#a7b270d558aa3a4d" class="t t">ResourceGroupFixture</a>
    {
        <b>public string</b> <a id="b95156714542bc3e" href="../R/b95156714542bc3e.html" target="n" data-glyph="102,1" class="i property">SearchServiceName</a> { <b>get</b>; <b>private set</b>; }
 
        <b>public string</b> <a id="35310cb3b8e5937d" href="../R/35310cb3b8e5937d.html" target="n" data-glyph="102,1" class="i property">PrimaryApiKey</a> { <b>get</b>; <b>private set</b>; }
 
        <b>public string</b> <a id="3bde75648f041975" href="../R/3bde75648f041975.html" target="n" data-glyph="102,1" class="i property">QueryApiKey</a> { <b>get</b>; <b>private set</b>; }
 
        <b>public</b> <span class="i">MockContext</span> <a id="9729295cc0b0702f" href="../R/9729295cc0b0702f.html" target="n" data-glyph="102,1" class="i property">MockContext</a> { <b>get</b>; <b>private set</b>; }
 
        <b>public override void</b> <a id="385d7c7b564fb3a0" href="../R/385d7c7b564fb3a0.html" target="n" data-glyph="72,1" class="i method">Initialize</a>(<span class="i">MockContext</span> <span id="r0 rd" class="r0 r">context</span>)
        {
            <a href="ResourceGroupFixture.cs.html#a7b270d558aa3a4d" class="k">base</a>.<a href="ResourceGroupFixture.cs.html#af669e9a05ff61e4" class="i method">Initialize</a>(<span class="r0 r">context</span>);
            
            <a href="#9729295cc0b0702f" class="i property">MockContext</a> = <span class="r0 r">context</span>;
 
            <a href="/Microsoft.Azure.Management.Search/A.html#aa2f95dd02840cb7" class="t t">SearchManagementClient</a> <span id="r1 rd" class="r1 r">client</span> = <span class="r0 r">context</span>.<span class="i">GetServiceClient</span>&lt;<a href="/Microsoft.Azure.Management.Search/A.html#aa2f95dd02840cb7" class="t t">SearchManagementClient</a>&gt;();
 
            <a href="#b95156714542bc3e" class="i property">SearchServiceName</a> = <a href="#e859c3a5dfa8752c" class="i method">EnsureSearchService</a>(<span class="r1 r">client</span>);
 
            <a href="/Microsoft.Azure.Management.Search/A.html#f6a75e645173eb1b" class="t t">AdminKeyResult</a> <span id="r2 rd" class="r2 r">adminKeyResult</span> = <span class="r1 r">client</span>.<a href="/Microsoft.Azure.Management.Search/A.html#cad2a697dbaa85fd" class="i property">AdminKeys</a>.<span class="i">Get</span>(<a href="ResourceGroupFixture.cs.html#9f83d7f1d773be1c" class="i property">ResourceGroupName</a>, <a href="#b95156714542bc3e" class="i property">SearchServiceName</a>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r2 r">adminKeyResult</span>);
 
            <a href="#35310cb3b8e5937d" class="i property">PrimaryApiKey</a> = <span class="r2 r">adminKeyResult</span>.<a href="/Microsoft.Azure.Management.Search/A.html#3efe80c5e15c23b0" class="i property">PrimaryKey</a>;
 
            <b>var</b> <span id="r3 rd" class="r3 r">queryKeys</span> = <span class="r1 r">client</span>.<a href="/Microsoft.Azure.Management.Search/A.html#855e9a26a1a536ca" class="i property">QueryKeys</a>.<span class="i">ListBySearchService</span>(<a href="ResourceGroupFixture.cs.html#9f83d7f1d773be1c" class="i property">ResourceGroupName</a>, <a href="#b95156714542bc3e" class="i property">SearchServiceName</a>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r3 r">queryKeys</span>);
            <span class="i">Assert</span>.<span class="i">Single</span>(<span class="r3 r">queryKeys</span>);
 
            <a href="#3bde75648f041975" class="i property">QueryApiKey</a> = <span class="r3 r">queryKeys</span>.<span class="i">First</span>().<span class="i">Key</span>;
        }
 
        <b>public override void</b> <a id="efdfe02790500dd1" href="../R/efdfe02790500dd1.html" target="n" data-glyph="72,1" class="i method">Cleanup</a>()
        {
            <span class="c">// Normally we could just rely on resource group deletion to clean things up for us. However, resource</span>
            <span class="c">// group deletion is asynchronous and can be slow, especially when we&#39;re running in test environments that</span>
            <span class="c">// aren&#39;t 100% reliable. To avoid interfering with other tests by exhausting free service quota, we</span>
            <span class="c">// eagerly delete the search service here.</span>
            <b>if</b> (<a href="ResourceGroupFixture.cs.html#9f83d7f1d773be1c" class="i property">ResourceGroupName</a> != <b>null</b> &amp;&amp; <a href="#b95156714542bc3e" class="i property">SearchServiceName</a> != <b>null</b>)
            {
                <a href="/Microsoft.Azure.Management.Search/A.html#aa2f95dd02840cb7" class="t t">SearchManagementClient</a> <span id="r4 rd" class="r4 r">client</span> = <a href="#9729295cc0b0702f" class="i property">MockContext</a>.<span class="i">GetServiceClient</span>&lt;<a href="/Microsoft.Azure.Management.Search/A.html#aa2f95dd02840cb7" class="t t">SearchManagementClient</a>&gt;();
                <span class="r4 r">client</span>.<a href="/Microsoft.Azure.Management.Search/A.html#bc972d2be33a1001" class="i property">Services</a>.<span class="i">Delete</span>(<a href="ResourceGroupFixture.cs.html#9f83d7f1d773be1c" class="i property">ResourceGroupName</a>, <a href="#b95156714542bc3e" class="i property">SearchServiceName</a>);
            }
 
            <a href="ResourceGroupFixture.cs.html#a7b270d558aa3a4d" class="k">base</a>.<a href="ResourceGroupFixture.cs.html#3b4f2345eb59ffec" class="i method">Cleanup</a>();
        }
 
        <b>private string</b> <a id="e859c3a5dfa8752c" href="../R/e859c3a5dfa8752c.html" target="n" data-glyph="76,1" class="i method">EnsureSearchService</a>(<a href="/Microsoft.Azure.Management.Search/A.html#aa2f95dd02840cb7" class="t t">SearchManagementClient</a> <span id="r5 rd" class="r5 r">client</span>)
        {
            <span class="c">// Ensuring a search service involves creating it, and then waiting until its DNS resolves. The approach</span>
            <span class="c">// we take depends on what kind of test run this is. If it&#39;s a Record or Playback run, we need determinism</span>
            <span class="c">// since the mock server has no clue how many times we retried DNS lookup in the original test run. In</span>
            <span class="c">// this case, we can&#39;t just delete and re-create the search service if DNS doesn&#39;t resolve in a timely</span>
            <span class="c">// manner. However, we do fail fast in the interests of speeding up interactive dev cycles.</span>
            <span class="c">//</span>
            <span class="c">// If we&#39;re in None mode (i.e. -- no mock recording or playback), we assume we&#39;re running automated tests</span>
            <span class="c">// in batch. In this case, non-determinism is not a problem (because mocks aren&#39;t involved), and</span>
            <span class="c">// reliability is paramount. For this reason, we retry the entire sequence several times, deleting and</span>
            <span class="c">// trying to re-create the service each time.</span>
            <b>int</b> <span id="r6 rd" class="r6 r">maxAttempts</span> = (<span class="i">HttpMockServer</span>.<span class="i">Mode</span> == <span class="i">HttpRecorderMode</span>.<span class="i">None</span>) ? 10 : 1;
 
            <b>for</b> (<b>int</b> <span id="r7 rd" class="r7 r">attempt</span> = 0; <span class="r7 r">attempt</span> &lt; <span class="r6 r">maxAttempts</span>; <span class="r7 r">attempt</span>++)
            {
                <b>string</b> <span id="r8 rd" class="r8 r">searchServiceName</span> = <a href="SearchTestUtilities.cs.html#43c89287078aeb50" class="t t">SearchTestUtilities</a>.<a href="SearchTestUtilities.cs.html#7e1245a4596c7178" class="i method">GenerateServiceName</a>();
 
                <a href="/Microsoft.Azure.Management.Search/A.html#831c13fe7fbd9003" class="k">var</a> <span id="r9 rd" class="r9 r">service</span> =
                    <b>new</b> <span class="t">SearchService</span>()
                    {
                        <a href="/Microsoft.Azure.Management.Search/A.html#8bfe9d09aeefc491" class="i property">Location</a> = <a href="ResourceGroupFixture.cs.html#e1f429a2f452ddfc" class="i property">Location</a>,
                        <span class="i">Sku</span> = <b>new</b> <span class="t">Sku</span>() { <a href="/Microsoft.Azure.Management.Search/A.html#d9d9149c2f710603" class="i property">Name</a> = <a href="/Microsoft.Azure.Management.Search/A.html#8ba852f89b51891c" class="t t">SkuName</a>.<a href="/Microsoft.Azure.Management.Search/A.html#21536b26e17e92a4" class="i field">Free</a> }
                    };
 
                <span class="r5 r">client</span>.<a href="/Microsoft.Azure.Management.Search/A.html#bc972d2be33a1001" class="i property">Services</a>.<span class="i">CreateOrUpdate</span>(<a href="ResourceGroupFixture.cs.html#9f83d7f1d773be1c" class="i property">ResourceGroupName</a>, <span class="r8 r">searchServiceName</span>, <span class="r9 r">service</span>);
 
                <span class="c">// In the common case, DNS propagation happens in less than 15 seconds. In the uncommon case, it can</span>
                <span class="c">// take many minutes. The timeout we use depends on the mock mode. If we&#39;re in Playback, the delay is</span>
                <span class="c">// irrelevant. If we&#39;re in Record mode, we can&#39;t delete and re-create the service, so we get more</span>
                <span class="c">// reliable results if we wait longer. In &quot;None&quot; mode, we can delete and re-create, which is often</span>
                <span class="c">// faster than waiting a long time for DNS propagation. In that case, rather than force all tests to</span>
                <span class="c">// wait several minutes, we fail fast here.</span>
                <span class="i">TimeSpan</span> <span id="r10 rd" class="r10 r">maxDelay</span> = 
                    (<span class="i">HttpMockServer</span>.<span class="i">Mode</span> == <span class="i">HttpRecorderMode</span>.<span class="i">Record</span>) ? 
                        <span class="i">TimeSpan</span>.<span class="i">FromMinutes</span>(1) : <span class="i">TimeSpan</span>.<span class="i">FromSeconds</span>(15);
                
                <b>if</b> (<a href="SearchTestUtilities.cs.html#43c89287078aeb50" class="t t">SearchTestUtilities</a>.<a href="SearchTestUtilities.cs.html#165dd0037d9c585b" class="i method">WaitForSearchServiceDns</a>(<span class="r8 r">searchServiceName</span>, <span class="r10 r">maxDelay</span>))
                {
                    <b>return</b> <span class="r8 r">searchServiceName</span>;
                }
 
                <span class="c">// If the service DNS isn&#39;t resolvable in a timely manner, delete it and try to create another one.</span>
                <span class="c">// We need to delete it since there can be only one free service per subscription.</span>
                <span class="r5 r">client</span>.<a href="/Microsoft.Azure.Management.Search/A.html#bc972d2be33a1001" class="i property">Services</a>.<span class="i">Delete</span>(<a href="ResourceGroupFixture.cs.html#9f83d7f1d773be1c" class="i property">ResourceGroupName</a>, <span class="r8 r">searchServiceName</span>);
            }
 
            <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<span class="s">&quot;Failed to provision a search service in a timely manner.&quot;</span>);
        }
    }
}
</pre></td></tr></table></div></body></html>
