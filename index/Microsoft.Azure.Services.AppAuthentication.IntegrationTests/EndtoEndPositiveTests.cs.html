<!DOCTYPE html>
<html><head><title>EndtoEndPositiveTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(309);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Services.AppAuthentication.IntegrationTests/EndtoEndPositiveTests.cs" target="_top">EndtoEndPositiveTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Services.AppAuthentication.IntegrationTests" target="_top">Azure.Services.AppAuthentication.IntegrationTests\Microsoft.Azure.Services.AppAuthentication.IntegrationTests.csproj</a> (Microsoft.Azure.Services.AppAuthentication.IntegrationTests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i">Xunit</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Security</span>.<span class="i n">Cryptography</span>.<span class="i n">X509Certificates</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i">KeyVault</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Services</span>.<span class="i n">AppAuthentication</span>.<span class="i n">IntegrationTests</span>.<span class="i n">Helpers</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Services</span>.<span class="i n">AppAuthentication</span>.<span class="i n">IntegrationTests</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Services</span>.<span class="i n">AppAuthentication</span>.<span class="i n">TestCommon</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">net472</span>
<b>using</b> <span class="i n">System</span>.<span class="i n">Data</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Data</span>.<span class="i n">SqlClient</span>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Services</span>.<span class="i n">AppAuthentication</span>.<span class="i n">IntegrationTests</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> End to end test cases for AzureServiceTokenProvider class. MSI cases are not covered. </span>
    <span class="c">///</span><span class="c"> One must be logged in using Azure CLI to run these tests for Azure CLI cases, and for client secret, and certificate cases. </span>
    <span class="c">///</span><span class="c"> AppAuthenticationTestCertUrl must be set to a secret URL For a certificate in Key Vault. </span>
    <span class="c">///</span><span class="c"> The Integrated Windows Authentication test can only be run on a domain joined machine, where domain is synced with Azure AD. </span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="63913c8914bc5bbe" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="75296a3a52a4cff4">EndtoEndPositiveTests</span></a> : <span class="i">IAsyncLifetime</span>
    {
        <b>private string</b> <a id="09d6b5de57f6eb7e" href="R/09d6b5de57f6eb7e.html" target="n" data-glyph="46,1" class="i field">_tenantId</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Set the tenantid based on developer running the test cases. </span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="ef95395701df2ad2" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">InitializeAsync</a>()
        {
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r0 rd" class="r0 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f894e642da0e9791" class="t constructor">AzureServiceTokenProvider</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4f99f8d18c3e270c" class="i field">AzureCliConnectionString</a>);
            <b>await</b> <span class="r0 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#b95320f220b53662" class="i field">ArmResourceId</a>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
            <a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a> = <span class="r0 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b78f2d4fcc0556c1" class="i property">PrincipalUsed</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#64e7621ee7fb4766" class="i field">TenantId</a>;
        }
 
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="7f12f9ffe70f0bd5" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">DisposeAsync</a>()
        {
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#34b191a243434f6a" class="i method">Delay</a>(0);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test cases where tokens are fetched using Azure CLI or Visual Studio for local development. </span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="057321586e69afd4" href="R/057321586e69afd4.html" target="n" data-glyph="76,1" class="i method">GetTokenUsingDeveloperTool</a>(<b>bool</b> <span id="r1 rd" class="r1 r">isAzureCli</span>)
        {
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r2 rd" class="r2 r">connectionString</span> = <span class="r1 r">isAzureCli</span>
                ? <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4f99f8d18c3e270c" class="i field">AzureCliConnectionString</a>
                : <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#80ea6543f30b04b0" class="i field">VisualStudioConnectionString</a>;
 
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r3 rd" class="r3 r">astp1</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f894e642da0e9791" class="t constructor">AzureServiceTokenProvider</a>(<span class="r2 r">connectionString</span>);
 
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;&gt; <span id="r4 rd" class="r4 r">tasks</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;&gt;();
 
            <b>for</b> (<b>int</b> <span id="r5 rd" class="r5 r">i</span> = 0; <span class="r5 r">i</span> &lt; 5; <span class="r5 r">i</span>++)
            {
                <span class="r4 r">tasks</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r3 r">astp1</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#7b6734a08b7c1752" class="i field">SqlAzureResourceId</a>));
            }
 
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#b6d43f186de3a867" class="i method">WhenAll</a>(<span class="r4 r">tasks</span>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r6 rd" class="r6 r">astp</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f894e642da0e9791" class="t constructor">AzureServiceTokenProvider</a>(<span class="r2 r">connectionString</span>);
 
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <span id="r7 rd" class="r7 r">resourceIdList</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;
            {
                <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#7b6734a08b7c1752" class="i field">SqlAzureResourceId</a>,
                <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4a71aea8e3c7400f" class="i field">GraphResourceId</a>,
                <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#b95320f220b53662" class="i field">ArmResourceId</a>,
                <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#7ca7ff6c842b0252" class="i field">DataLakeResourceId</a>,
                <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>
            };
 
            <b>for</b> (<b>int</b> <span id="r8 rd" class="r8 r">i</span> = 0; <span class="r8 r">i</span> &lt; 10; <span class="r8 r">i</span>++)
            {
                <b>foreach</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r9 rd" class="r9 r">resourceId</span> <b>in</b> <span class="r7 r">resourceIdList</span>)
                {
                    <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="k">var</a> <span id="r10 rd" class="r10 r">authResult</span> =
                        <b>await</b>
                            <span class="r6 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ad9af5c20bd48ea2" class="i method">GetAuthenticationResultAsync</a>(<span class="r9 r">resourceId</span>);
 
                    <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r10 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#bac23240ee26a0c7" class="i property">AccessToken</a>, <span class="r6 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b78f2d4fcc0556c1" class="i property">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#09b5e3eb5fba719b" class="i field">UserType</a>, <a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>, <span class="r11 r">expiresOn</span>: <span class="r10 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0bd6af7f6ac59d37" class="i property">ExpiresOn</a>);
                }
 
                <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#09994c56808fbb5a" class="k">var</a> <span id="r12 rd" class="r12 r">callback</span> = <span class="r6 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#fc3e2628440da92e" class="i property">KeyVaultTokenCallback</a>;
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r13 rd" class="r13 r">tokenForKeyVault</span> = <b>await</b> <span class="r12 r">callback</span>(<span class="s">$&quot;</span>{<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#f1bb27f5e85b39ba" class="i field">AzureAdInstance</a>}{<a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>}<span class="s">&quot;</span>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#c9f70a27facb27cf" class="i field">Empty</a>);
 
                <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r13 r">tokenForKeyVault</span>, <span class="r6 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b78f2d4fcc0556c1" class="i property">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#09b5e3eb5fba719b" class="i field">UserType</a>, <a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>);
            }
        }
 
 
        [<span class="i">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="083640630c495b21" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTokenUsingAzCliTest</a>()
        {
            <b>await</b> <a href="#057321586e69afd4" class="i method">GetTokenUsingDeveloperTool</a>(<b>true</b>);
        }
 
        [<span class="i">RunOnWindowsFact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="acde0ef066f509f4" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTokenUsingVisualStudio</a>()
        {
            <b>await</b> <a href="#057321586e69afd4" class="i method">GetTokenUsingDeveloperTool</a>(<b>false</b>);
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">FullNetFx</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test case where token is fetched using Integrated Windows Authentication. </span>
        <span class="c">///</span><span class="c"> Person running the test must be using domain joined machine, where domain is federated with Azure AD. </span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="17655f6e1f916e6d" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTokenUsingIntegratedWindowsAuthenticationTest</a>()
        {
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r14 rd" class="r14 r">astp</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f894e642da0e9791" class="t constructor">AzureServiceTokenProvider</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#ecd8818329a9cc85" class="i field">IntegratedAuthConnectionString</a>);
 
            <b>for</b> (<b>int</b> <span id="r15 rd" class="r15 r">i</span> = 0; <span class="r15 r">i</span> &lt; 100; <span class="r15 r">i</span>++)
            {
                <span class="c">// Get token using active directory integrated authentication</span>
                <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="k">var</a> <span id="r16 rd" class="r16 r">authResult</span> =
                    <b>await</b>
                        <span class="r14 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ad9af5c20bd48ea2" class="i method">GetAuthenticationResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4a71aea8e3c7400f" class="i field">GraphResourceId</a>);
 
                <span class="c">// This will not cause IWA. Token for SQL will be used to get token for Graph API (MRRT)</span>
                <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r17 rd" class="r17 r">astp1</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f894e642da0e9791" class="t constructor">AzureServiceTokenProvider</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#ecd8818329a9cc85" class="i field">IntegratedAuthConnectionString</a>);
                <b>await</b> <span class="r17 r">astp1</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#7b6734a08b7c1752" class="i field">SqlAzureResourceId</a>);
 
                <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r16 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#bac23240ee26a0c7" class="i property">AccessToken</a>, <span class="r14 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b78f2d4fcc0556c1" class="i property">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#09b5e3eb5fba719b" class="i field">UserType</a>, <span class="r17 r">astp1</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b78f2d4fcc0556c1" class="i property">PrincipalUsed</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#64e7621ee7fb4766" class="i field">TenantId</a>, <span class="r11 r">expiresOn</span>: <span class="r16 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0bd6af7f6ac59d37" class="i property">ExpiresOn</a>);
            }
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">net472</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> One must be logged in using Azure CLI and set AppAuthenticationTestSqlServerEndpoint to a SQL Azure database endpoint before running this test.</span>
        <span class="c">///</span><span class="c"> The test validates that it can open a connection with the SQL database using SqlAzureAuthProvider, which implements the SqlAuthenticationProvider interface.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="44348166c2b02d0b" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ConnectToSqlDbWithSqlAppAuthProvider</a>()
        {
            <span class="c">// register SqlAzureAppAuthProvider and create the connection string</span>
            <a href="@0@System.Data/A.html#7f1299fa6aad6ff0" class="t t">SqlAuthenticationProvider</a>.<a href="@0@System.Data/A.html#dea52f81a28e1ea4" class="i method">SetProvider</a>(<a href="@0@System.Data/A.html#668536f92292f5b5" class="t t">SqlAuthenticationMethod</a>.<a href="@0@System.Data/A.html#0fc8706533275c42" class="i field">ActiveDirectoryInteractive</a>, <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#31b9ebf7dfd25738" class="t constructor">SqlAppAuthenticationProvider</a>());
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r18 rd" class="r18 r">connectionString</span> = <span class="s">$&quot;</span><span class="s">server=</span>{<a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#3956c71d4fc09576" class="i method">GetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6f043fde9cda1c57" class="i field">TestSqlServerEndpoint</a>)}<span class="s">;Authentication=Active Directory Interactive;UID=AnyString</span><span class="s">&quot;</span>;
 
            <span class="c">// verify the connection can be successfully opened</span>
            <a href="@0@System.Data/A.html#48932d2b804ed473" class="k">var</a> <span id="r19 rd" class="r19 r">sqlConnection</span> = <b>new</b> <a href="@0@System.Data/A.html#5bfcbd0806b49ca2" class="t constructor">SqlConnection</a>(<span class="r18 r">connectionString</span>);
            <b>await</b> <span class="r19 r">sqlConnection</span>.<a href="@0@System.Data/A.html#a63bd58b52f1872e" class="i method">OpenAsync</a>();
            <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="@0@System.Data/A.html#1dae67e12c572852" class="t t">ConnectionState</a>.<a href="@0@System.Data/A.html#2b291ca60b251364" class="i field">Open</a>, <span class="r19 r">sqlConnection</span>.<a href="@0@System.Data/A.html#8120b88d92ab1c5f" class="i property">State</a>);
 
            <span class="c">// verify connection can be successfully closed</span>
            <span class="r19 r">sqlConnection</span>.<a href="@0@System.Data/A.html#9414944f8fe487ef" class="i method">Close</a>();
            <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="@0@System.Data/A.html#1dae67e12c572852" class="t t">ConnectionState</a>.<a href="@0@System.Data/A.html#d482408df082bfdc" class="i field">Closed</a>, <span class="r19 r">sqlConnection</span>.<a href="@0@System.Data/A.html#8120b88d92ab1c5f" class="i property">State</a>);
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <b>private enum</b> <a id="ea053e60fc849549" href="R/ea053e60fc849549.html" target="n" data-glyph="22,1" class="t t"><span id="1e75f33df32258d3">CertIdentifierType</span></a>
        {
            <a id="4a93faaa5744dde1" href="R/4a93faaa5744dde1.html" target="n" data-glyph="24,2" class="i field">SubjectName</a>,
            <a id="7cb0251ced288775" href="R/7cb0251ced288775.html" target="n" data-glyph="24,2" class="i field">Thumbprint</a>,
            <a id="f199fe79eaef8aa0" href="R/f199fe79eaef8aa0.html" target="n" data-glyph="24,2" class="i field">KeyVaultCertificateSecretIdentifier</a>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> One must be logged in using Azure CLI and set AppAuthenticationTestCertUrl to a secret URL for a certificate in Key Vault before running this test.</span>
        <span class="c">///</span><span class="c"> The test creates a new Azure AD application and service principal, uses the cert as the credential, and then uses the library to authenticate to it, using the cert. </span>
        <span class="c">///</span><span class="c"> After the cert, the Azure AD application is deleted. Cert is removed from current user store on the machine. </span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">certIdentifierType</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">Theory</span>]
        [<span class="i">InlineData</span>(<a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#f199fe79eaef8aa0" class="i field">KeyVaultCertificateSecretIdentifier</a>, <b>false</b>)]
        [<span class="i">InlineData</span>(<a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#f199fe79eaef8aa0" class="i field">KeyVaultCertificateSecretIdentifier</a>, <b>true</b>)]
        [<span class="i">InlineData</span>(<a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#4a93faaa5744dde1" class="i field">SubjectName</a>)]
        [<span class="i">InlineData</span>(<a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#7cb0251ced288775" class="i field">Thumbprint</a>)]
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="fd0d378ae46d0b6e" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">GetTokenUsingServicePrincipalWithCertTest</a>(<a href="#ea053e60fc849549" class="t t">CertIdentifierType</a> <span id="r20 rd" class="r20 r">certIdentifierType</span>, <b>bool</b> <span id="r21 rd" class="r21 r">useUserAssignedMsi</span> = <b>false</b>)
        {
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r22 rd" class="r22 r">testCertUrl</span> = <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#3956c71d4fc09576" class="i method">GetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#83362d16ab7b5024" class="i field">TestCertUrlEnv</a>);
 
            <span class="c">// Get a certificate from key vault. </span>
            <span class="c">// For security, this certificate is not hard coded in the test case, since it gets added as app credential in Azure AD, and may not get removed. </span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r23 rd" class="r23 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f894e642da0e9791" class="t constructor">AzureServiceTokenProvider</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4f99f8d18c3e270c" class="i field">AzureCliConnectionString</a>);
            <a href="Helpers/KeyVaultHelper.cs.html#2d3f4cdc25c35b6e" class="t t">KeyVaultHelper</a> <span id="r24 rd" class="r24 r">keyVaultHelper</span> = <b>new</b> <a href="Helpers/KeyVaultHelper.cs.html#967e4a8478f12373" class="t constructor">KeyVaultHelper</a>(<b>new</b> <span class="i">KeyVaultClient</span>(<b>new</b> <span class="i">KeyVaultClient</span>.<span class="i">AuthenticationCallback</span>(<span class="r23 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#fc3e2628440da92e" class="i property">KeyVaultTokenCallback</a>)));
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r25 rd" class="r25 r">certAsString</span> = <b>await</b> <span class="r24 r">keyVaultHelper</span>.<a href="Helpers/KeyVaultHelper.cs.html#1b7f4e24ecf63400" class="i method">ExportCertificateAsBlob</a>(<span class="r22 r">testCertUrl</span>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
            <a href="@0@System/A.html#2e8ad9e6007798e5" class="t t">X509Certificate2</a> <span id="r26 rd" class="r26 r">cert</span> = <b>new</b> <a href="@0@System/A.html#fcd8edbba14897bb" class="t constructor">X509Certificate2</a>(<a href="@0@mscorlib/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@0@mscorlib/A.html#08c34f52087ba624" class="i method">FromBase64String</a>(<span class="r25 r">certAsString</span>), <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#c9f70a27facb27cf" class="i field">Empty</a>);
 
            <span class="c">// Create an application</span>
            <a href="Helpers/GraphHelper.cs.html#3b7b53031168e5ba" class="t t">GraphHelper</a> <span id="r27 rd" class="r27 r">graphHelper</span> = <b>new</b> <a href="Helpers/GraphHelper.cs.html#42440f5fa658750e" class="t constructor">GraphHelper</a>(<a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>);
            <a href="Models/Application.cs.html#5422a18bee141126" class="t t">Application</a> <span id="r28 rd" class="r28 r">app</span> = <b>await</b> <span class="r27 r">graphHelper</span>.<a href="Helpers/GraphHelper.cs.html#ee3b61a1d0ec1258" class="i method">CreateApplicationAsync</a>(<span class="r26 r">cert</span>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
            <span class="c">// Get token using service principal, this will cache the cert</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="t t">AppAuthenticationResult</a> <span id="r29 rd" class="r29 r">authResult</span> = <b>null</b>;
            <b>int</b> <span id="r30 rd" class="r30 r">count</span> = 5;
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r31 rd" class="r31 r">thumbprint</span> = <span class="r26 r">cert</span>.<a href="@0@System/A.html#6313394a0155d4d0" class="i property">Thumbprint</a>?.<a href="@0@mscorlib/A.html#0b5a1ee33618e0b3" class="i method">ToLower</a>();
 
            <span class="c">// Construct connection string using client id and cert info</span>
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r32 rd" class="r32 r">connectionString</span> = <b>null</b>;
            <b>switch</b> (<span class="r20 r">certIdentifierType</span>)
            {
                <b>case</b> <a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#4a93faaa5744dde1" class="i field">SubjectName</a>:
                <b>case</b> <a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#7cb0251ced288775" class="i field">Thumbprint</a>:
                    <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r33 rd" class="r33 r">thumbprintOrSubjectName</span> = (<span class="r20 r">certIdentifierType</span> == <a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#7cb0251ced288775" class="i field">Thumbprint</a>) ? <span class="s">$&quot;</span><span class="s">CertificateThumbprint=</span>{<span class="r31 r">thumbprint</span>}<span class="s">&quot;</span> : <span class="s">$&quot;</span><span class="s">CertificateSubjectName=</span>{<span class="r26 r">cert</span>.<a href="@0@mscorlib/A.html#ab0ff5e07f224a7a" class="i property">Subject</a>}<span class="s">&quot;</span>;
                    <span class="r32 r">connectionString</span> = <span class="s">$&quot;</span><span class="s">RunAs=App;AppId=</span>{<span class="r28 r">app</span>.<a href="Models/Application.cs.html#2592c149f5c1e450" class="i property">AppId</a>}<span class="s">;TenantId=</span>{<a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>}<span class="s">;</span>{<span class="r33 r">thumbprintOrSubjectName</span>}<span class="s">;CertificateStoreLocation=</span>{<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#5d8681d5b0e7af6b" class="i field">CurrentUserStore</a>}<span class="s">;</span><span class="s">&quot;</span>;
                    <b>break</b>;
                <b>case</b> <a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#f199fe79eaef8aa0" class="i field">KeyVaultCertificateSecretIdentifier</a>:
                    <span class="r32 r">connectionString</span> = <span class="r21 r">useUserAssignedMsi</span>
                        ? <span class="s">$&quot;</span><span class="s">RunAs=App;AppId=</span>{<span class="r28 r">app</span>.<a href="Models/Application.cs.html#2592c149f5c1e450" class="i property">AppId</a>}<span class="s">;KeyVaultCertificateSecretIdentifier=</span>{<span class="r22 r">testCertUrl</span>}<span class="s">;KeyVaultUserAssignedManagedIdentityId=</span>{<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#f93cd6d1bd30210e" class="i field">TestUserAssignedManagedIdentityId</a>}<span class="s">&quot;</span> <span class="c">//TODO: figure out real MSI to use here. Also, does the test really use MSI or does it rely on the fallback?</span>
                        : <span class="s">$&quot;</span><span class="s">RunAs=App;AppId=</span>{<span class="r28 r">app</span>.<a href="Models/Application.cs.html#2592c149f5c1e450" class="i property">AppId</a>}<span class="s">;KeyVaultCertificateSecretIdentifier=</span>{<span class="r22 r">testCertUrl</span>}<span class="s">;</span><span class="s">&quot;</span>;
                    <b>break</b>;
            }
 
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r34 rd" class="r34 r">astp</span> =
                <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f894e642da0e9791" class="t constructor">AzureServiceTokenProvider</a>(<span class="r32 r">connectionString</span>);
 
            <b>if</b> (<span class="r20 r">certIdentifierType</span> == <a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#4a93faaa5744dde1" class="i field">SubjectName</a> ||
                <span class="r20 r">certIdentifierType</span> == <a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#7cb0251ced288775" class="i field">Thumbprint</a>)
            {
                <span class="c">// Import the certificate</span>
                <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4f56934b1c8acdd1" class="t t">CertUtil</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#e68681d7de6188c6" class="i method">ImportCertificate</a>(<span class="r26 r">cert</span>);
            }
 
            <b>while</b> (<span class="r29 r">authResult</span> == <b>null</b> &amp;&amp; <span class="r30 r">count</span> &gt; 0)
            {
                <b>try</b>
                {
                    <b>await</b> <span class="r34 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>);
 
                    <span class="r29 r">authResult</span> = <b>await</b> <span class="r34 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#8f928677f047687d" class="i method">GetAuthenticationResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#7b6734a08b7c1752" class="i field">SqlAzureResourceId</a>, <a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>);
                }
                <b>catch</b>
                {
                    <span class="c">// It takes time for Azure AD to realize a new application has been added. </span>
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#34b191a243434f6a" class="i method">Delay</a>(20000);
 
                    <span class="r30 r">count</span>--;
                }
            }
 
            <b>if</b> (<span class="r20 r">certIdentifierType</span> == <a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#4a93faaa5744dde1" class="i field">SubjectName</a> ||
               <span class="r20 r">certIdentifierType</span> == <a href="#ea053e60fc849549" class="t t">CertIdentifierType</a>.<a href="#7cb0251ced288775" class="i field">Thumbprint</a>)
            {
                <span class="c">// Delete the cert</span>
                <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4f56934b1c8acdd1" class="t t">CertUtil</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#dc05e1dcd0389d1e" class="i method">DeleteCertificate</a>(<span class="r26 r">cert</span>.<a href="@0@System/A.html#6313394a0155d4d0" class="i property">Thumbprint</a>);
 
                <a href="@0@System/A.html#2e8ad9e6007798e5" class="k">var</a> <span id="r35 rd" class="r35 r">deletedCert</span> = <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4f56934b1c8acdd1" class="t t">CertUtil</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#0a48f55f0c4baa1c" class="i method">GetCertificate</a>(<span class="r26 r">cert</span>.<a href="@0@System/A.html#6313394a0155d4d0" class="i property">Thumbprint</a>);
                <span class="i">Assert</span>.<span class="i">Null</span>(<span class="r35 r">deletedCert</span>);
            }
 
            <span class="c">// Get token again using a cert which is deleted, but in the cache</span>
            <b>await</b> <span class="r34 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7440141aa26f324a" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#7b6734a08b7c1752" class="i field">SqlAzureResourceId</a>, <a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>);
 
            <span class="c">// Delete the application and service principal</span>
            <b>await</b> <span class="r27 r">graphHelper</span>.<a href="Helpers/GraphHelper.cs.html#58db0aeae030bd6e" class="i method">DeleteApplicationAsync</a>(<span class="r28 r">app</span>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r29 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#bac23240ee26a0c7" class="i property">AccessToken</a>, <span class="r34 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b78f2d4fcc0556c1" class="i property">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#bd2c3b58b4413596" class="i field">AppType</a>, <a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>,
                <span class="r28 r">app</span>.<a href="Models/Application.cs.html#2592c149f5c1e450" class="i property">AppId</a>, <span class="r26 r">cert</span>.<a href="@0@System/A.html#6313394a0155d4d0" class="i property">Thumbprint</a>, <span class="r11 r">expiresOn</span>: <span class="r29 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0bd6af7f6ac59d37" class="i property">ExpiresOn</a>);
        }
 
        [<span class="i">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="c8c7f4e9258ef86c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTokenUsingServicePrincipalWithClientSecretTest</a>()
        {
            <a href="Helpers/GraphHelper.cs.html#3b7b53031168e5ba" class="t t">GraphHelper</a> <span id="r36 rd" class="r36 r">graphHelper</span> = <b>new</b> <a href="Helpers/GraphHelper.cs.html#42440f5fa658750e" class="t constructor">GraphHelper</a>(<a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>);
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r37 rd" class="r37 r">secret</span> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>();
            <a href="Models/Application.cs.html#5422a18bee141126" class="t t">Application</a> <span id="r38 rd" class="r38 r">app</span> = <b>await</b> <span class="r36 r">graphHelper</span>.<a href="Helpers/GraphHelper.cs.html#e0b63637e5478c68" class="i method">CreateApplicationAsync</a>(<span class="r37 r">secret</span>);
 
            <span class="c">// Get token using service principal</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="t t">AppAuthenticationResult</a> <span id="r39 rd" class="r39 r">authResult</span> = <b>null</b>;
            <b>int</b> <span id="r40 rd" class="r40 r">count</span> = 5;
 
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#185973ff56b44120" class="i field">ConnectionStringEnvironmentVariableName</a>, <span class="s">$&quot;</span><span class="s">RunAs=App;TenantId=</span>{<a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>}<span class="s">;AppId=</span>{<span class="r38 r">app</span>.<a href="Models/Application.cs.html#2592c149f5c1e450" class="i property">AppId</a>}<span class="s">;AppKey=</span>{<span class="r37 r">secret</span>}<span class="s">&quot;</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r41 rd" class="r41 r">astp</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f894e642da0e9791" class="t constructor">AzureServiceTokenProvider</a>();
 
            <b>while</b> (<span class="r39 r">authResult</span> == <b>null</b> &amp;&amp; <span class="r40 r">count</span> &gt; 0)
            {
                <b>try</b>
                {
                    <span class="r39 r">authResult</span> = <b>await</b> <span class="r41 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#8f928677f047687d" class="i method">GetAuthenticationResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#7b6734a08b7c1752" class="i field">SqlAzureResourceId</a>, <a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>);
 
                    <b>await</b> <span class="r41 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>);
 
                }
                <b>catch</b>
                {
                    <span class="c">// It takes time for Azure AD to realize a new application has been added. </span>
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#34b191a243434f6a" class="i method">Delay</a>(15000);
 
                    <span class="r40 r">count</span>--;
                }
 
            }
 
            <span class="c">// Delete the application</span>
            <b>await</b> <span class="r36 r">graphHelper</span>.<a href="Helpers/GraphHelper.cs.html#58db0aeae030bd6e" class="i method">DeleteApplicationAsync</a>(<span class="r38 r">app</span>);
 
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#185973ff56b44120" class="i field">ConnectionStringEnvironmentVariableName</a>, <b>null</b>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r39 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#bac23240ee26a0c7" class="i property">AccessToken</a>, <span class="r41 r">astp</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b78f2d4fcc0556c1" class="i property">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#bd2c3b58b4413596" class="i field">AppType</a>, <a href="#09d6b5de57f6eb7e" class="i field">_tenantId</a>, <span class="r38 r">app</span>.<a href="Models/Application.cs.html#2592c149f5c1e450" class="i property">AppId</a>, <span class="r11 r">expiresOn</span>: <span class="r39 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0bd6af7f6ac59d37" class="i property">ExpiresOn</a>);
        }
 
 
    }
}
</pre></td></tr></table></div></body></html>
