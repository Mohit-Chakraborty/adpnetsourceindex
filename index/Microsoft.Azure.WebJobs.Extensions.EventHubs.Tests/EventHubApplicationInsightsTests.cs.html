<!DOCTYPE html>
<html><head><title>EventHubApplicationInsightsTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(427);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.WebJobs.Extensions.EventHubs.Tests/EventHubApplicationInsightsTests.cs" target="_top">EventHubApplicationInsightsTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.WebJobs.Extensions.EventHubs.Tests" target="_top">tests\Microsoft.Azure.WebJobs.Extensions.EventHubs.Tests.csproj</a> (Microsoft.Azure.WebJobs.Extensions.EventHubs.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) .NET Foundation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Concurrent</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">TestFramework</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">EventHubs</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">EventHubs</span>.<span class="i">Producer</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">EventHubs</span>.<span class="i n">Tests</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">ApplicationInsights</span>.<span class="i">Channel</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">ApplicationInsights</span>.<span class="i">DataContracts</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">ApplicationInsights</span>.<span class="i">Extensibility</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">ApplicationInsights</span>.<span class="i">Extensibility</span>.<span class="i">Implementation</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">WebJobs</span>.<span class="i">Logging</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i">DependencyInjection</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Hosting</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i">Logging</span>;
<b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>;
<b>using</b> <span class="i">NUnit</span>.<span class="i">Framework</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">WebJobs</span>.<span class="i n">Host</span>.<span class="i n">EndToEndTests</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This test effectively validates that logic from</span>
    <span class="c">///</span><span class="c"> https://github.com/microsoft/ApplicationInsights-dotnet/blob/004dbd78cecd9a380688288d8a89e152e2e819c6/WEB/Src/DependencyCollector/DependencyCollector/Implementation/AzureSdk/AzureSdkDiagnosticsEventHandler.cs</span>
    <span class="c">///</span><span class="c"> and</span>
    <span class="c">///</span><span class="c"> https://github.com/Azure/azure-webjobs-sdk/blob/f0c9d0998ced69c8baf02fedb4e7f9184e0e05c9/src/Microsoft.Azure.WebJobs.Logging.ApplicationInsights/ApplicationInsightsLogger.cs</span>
    <span class="c">///</span><span class="c"> work correctly together in addition to DiagnosticScope logic inside Azure.Messaging.EventHubs</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">NonParallelizable</span>]
    [<span class="i">LiveOnly</span>]
    <b>public class</b> <a id="490676834ece9513" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="55e1387c3a7d25a8">EventHubApplicationInsightsTests</span></a> : <a href="WebJobsEventHubTestBase.cs.html#306be03bb0b01b08" class="t t">WebJobsEventHubTestBase</a>
    {
        <b>private static</b> <a href="@0@mscorlib/A.html#29b8a907100112ba" class="t t">EventWaitHandle</a> <a id="bb94e8c1b5221e79" href="R/bb94e8c1b5221e79.html" target="n" data-glyph="46,1" class="i field">_eventWait</a>;
        <b>private</b> <a href="#5f74a470da85bcf7" class="t t">TestTelemetryChannel</a> <a id="0756031eb11f1d8d" href="R/0756031eb11f1d8d.html" target="n" data-glyph="46,1" class="i field">_channel</a>;
 
        [<span class="i">SetUp</span>]
        <b>public void</b> <a id="d31a902f3c3a79e7" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SetUp</a>()
        {
            <a href="#bb94e8c1b5221e79" class="i field">_eventWait</a> = <b>new</b> <a href="@0@mscorlib/A.html#3f1e8fec681dd775" class="t constructor">ManualResetEvent</a>(<span class="r0 r">initialState</span>: <b>false</b>);
            <a href="#0756031eb11f1d8d" class="i field">_channel</a> = <b>new</b> <a href="#5f74a470da85bcf7" class="t constructor">TestTelemetryChannel</a>();
 
            <a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>.<a href="#0614ed875437cec0" class="i field">LinksCount</a>.<a href="@0@mscorlib/A.html#ca7bce81a50b0aeb" class="i method">Clear</a>();
            <a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>.<a href="#ddbe2432f8297e0b" class="i field">MessagesCount</a> = 0;
        }
 
        <b>private readonly</b> <span class="i">JsonSerializerSettings</span> <a id="36362d1fdcd17489" href="R/36362d1fdcd17489.html" target="n" data-glyph="46,1" class="i field">jsonSettingThrowOnError</a> = <b>new</b> <span class="i">JsonSerializerSettings</span>
        {
            <span class="i">MissingMemberHandling</span> = <span class="i">MissingMemberHandling</span>.<span class="i">Error</span>,
            <span class="i">ReferenceLoopHandling</span> = <span class="i">ReferenceLoopHandling</span>.<span class="i">Error</span>,
            <span class="i">NullValueHandling</span> = <span class="i">NullValueHandling</span>.<span class="i">Include</span>,
            <span class="i">DefaultValueHandling</span> = <span class="i">DefaultValueHandling</span>.<span class="i">Include</span>,
        };
 
        [<span class="i">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="c1b0eb1eba47e00f" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">EventHub_SingleDispatch</a>()
        {
            <b>var</b> (<span id="r1 rd" class="r1 r">jobHost</span>, <span id="r2 rd" class="r2 r">host</span>) = <a href="#f83795d625280bbf" class="i method">BuildHost</a>&lt;<a href="#bfd4b36fbdd8bcf8" class="t t">EventHubTestSingleDispatchJobs</a>&gt;();
            <b>using</b> (<span class="r2 r">host</span>)
            {
                <b>await</b> <span class="r1 r">jobHost</span>.<span class="i">CallAsync</span>(<b>nameof</b>(<a href="#bfd4b36fbdd8bcf8" class="t t">EventHubTestSingleDispatchJobs</a>.<span class="i">SendEvent_TestHub</span>), <b>new</b> { <a href="#f87ef7e7ef3633b7" class="i property">input</a> = <span class="s">&quot;data&quot;</span> });
                <b>bool</b> <span id="r3 rd" class="r3 r">result</span> = <a href="#bb94e8c1b5221e79" class="i field">_eventWait</a>.<a href="@0@mscorlib/A.html#4b231a1c8efbe5a7" class="i method">WaitOne</a>(<a href="WebJobsEventHubTestBase.cs.html#20167c2fd3c1928c" class="i field">Timeout</a>);
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r3 r">result</span>);
            }
 
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<span class="i">RequestTelemetry</span>&gt; <span id="r4 rd" class="r4 r">requests</span> = <a href="#0756031eb11f1d8d" class="i field">_channel</a>.<a href="#ffcd79b1cc16eb3c" class="i field">Telemetries</a>.<a href="@0@System.Core/A.html#4ba4a3f8a5530e33" class="i method">OfType</a>&lt;<span class="i">RequestTelemetry</span>&gt;().<a href="@0@System.Core/A.html#e276d6892241255b" class="i method">ToList</a>();
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<span class="i">DependencyTelemetry</span>&gt; <span id="r5 rd" class="r5 r">dependencies</span> = <a href="#0756031eb11f1d8d" class="i field">_channel</a>.<a href="#ffcd79b1cc16eb3c" class="i field">Telemetries</a>.<a href="@0@System.Core/A.html#4ba4a3f8a5530e33" class="i method">OfType</a>&lt;<span class="i">DependencyTelemetry</span>&gt;().<a href="@0@System.Core/A.html#e276d6892241255b" class="i method">ToList</a>();
 
            <span class="c">// We expect 1 message span and 1 send span</span>
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r6 rd" class="r6 r">messageDependencies</span> = <span class="r5 r">dependencies</span>.<a href="@0@System.Core/A.html#e73922753675387a" class="i method">Where</a>(<span id="r7 rd" class="r7 r">d</span> =&gt; <span class="r7 r">d</span>.<span class="i">Name</span> == <span class="s">&quot;EventHubs.Message&quot;</span>).<a href="@0@System.Core/A.html#e276d6892241255b" class="i method">ToList</a>();
            <b>var</b> <span id="r8 rd" class="r8 r">sendDependency</span> = <span class="r5 r">dependencies</span>.<a href="@0@System.Core/A.html#226beadd4e521229" class="i method">Single</a>(<span id="r9 rd" class="r9 r">d</span> =&gt; <span class="r9 r">d</span>.<span class="i">Name</span> == <span class="s">&quot;EventHubProducerClient.Send&quot;</span>);
 
            <b>var</b> <span id="r10 rd" class="r10 r">sendRequest</span> = <span class="r4 r">requests</span>.<a href="@0@System.Core/A.html#226beadd4e521229" class="i method">Single</a>(<span id="r11 rd" class="r11 r">r</span> =&gt; <span class="r11 r">r</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Name</span> == <b>nameof</b>(<a href="#bfd4b36fbdd8bcf8" class="t t">EventHubTestSingleDispatchJobs</a>.<span class="i">SendEvent_TestHub</span>));
            <b>var</b> <span id="r12 rd" class="r12 r">sendRequestOperationId</span> = <span class="r10 r">sendRequest</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Id</span>;
 
            <b>var</b> <span id="r13 rd" class="r13 r">processRequest</span> = <span class="r4 r">requests</span>.<a href="@0@System.Core/A.html#226beadd4e521229" class="i method">Single</a>(<span id="r14 rd" class="r14 r">r</span> =&gt; <span class="r14 r">r</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Name</span> == <b>nameof</b>(<a href="#bfd4b36fbdd8bcf8" class="t t">EventHubTestSingleDispatchJobs</a>.<span class="i">ProcessSingleEvent</span>));
 
            <span class="i">ValidateEventHubDependency</span>(
                <span class="r8 r">sendDependency</span>,
                <a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#2eb9434a1448d776" class="t t">EventHubsTestEnvironment</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#71524bf9ff4cebd2" class="i property">Instance</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#87ec54fcb2db1491" class="i property">FullyQualifiedNamespace</a>,
                <a href="WebJobsEventHubTestBase.cs.html#41395d9dc926fcf1" class="i field">_eventHubScope</a>.<a href="SharedSource/Testing/EventHubScope.cs.html#c426e0cce2f6622b" class="i property">EventHubName</a>,
                <span class="s">&quot;EventHubProducerClient.Send&quot;</span>,
                <b>nameof</b>(<a href="#bfd4b36fbdd8bcf8" class="t t">EventHubTestSingleDispatchJobs</a>.<span class="i">SendEvent_TestHub</span>),
                <span class="r12 r">sendRequestOperationId</span>,
                <span class="r10 r">sendRequest</span>.<span class="i">Id</span>,
                <span class="i">LogCategories</span>.<span class="i">Bindings</span>);
 
            <a href="#f0255c14a3ec4625" class="i method">ValidateEventHubRequest</a>(
                <span class="r13 r">processRequest</span>,
                <b>true</b>,
                <a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#2eb9434a1448d776" class="t t">EventHubsTestEnvironment</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#71524bf9ff4cebd2" class="i property">Instance</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#87ec54fcb2db1491" class="i property">FullyQualifiedNamespace</a>,
                <a href="WebJobsEventHubTestBase.cs.html#41395d9dc926fcf1" class="i field">_eventHubScope</a>.<a href="SharedSource/Testing/EventHubScope.cs.html#c426e0cce2f6622b" class="i property">EventHubName</a>,
                <b>nameof</b>(<a href="#bfd4b36fbdd8bcf8" class="t t">EventHubTestSingleDispatchJobs</a>.<span class="i">ProcessSingleEvent</span>),
                <b>null</b>,
                <b>null</b>);
 
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(1, <span class="r6 r">messageDependencies</span>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a>);
            <b>foreach</b> (<b>var</b> <span id="r15 rd" class="r15 r">messageDependency</span> <b>in</b> <span class="r6 r">messageDependencies</span>)
            {
                <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r12 r">sendRequestOperationId</span>, <span class="r15 r">messageDependency</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Id</span>);
            }
 
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r13 r">processRequest</span>.<span class="i">Properties</span>.<span class="i">TryGetValue</span>(<span class="s">&quot;_MS.links&quot;</span>, <b>out</b> <b>var</b> <span id="r16 rd" class="r16 r">linksStr</span>));
            <b>var</b> <span id="r17 rd" class="r17 r">links</span> = <span class="i">JsonConvert</span>.<span class="i">DeserializeObject</span>&lt;<a href="#d1873f2dfd17bbdf" class="t t">TestLink</a>[]&gt;(<span class="r16 r">linksStr</span>, <a href="#36362d1fdcd17489" class="i field">jsonSettingThrowOnError</a>).<span class="i">ToArray</span>();
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(1, <span class="r17 r">links</span>.<span class="i">Length</span>);
            <b>foreach</b> (<b>var</b> <span id="r18 rd" class="r18 r">link</span> <b>in</b> <span class="r17 r">links</span>)
            {
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r6 r">messageDependencies</span>.<a href="@0@System.Core/A.html#6a1af7c3d17845e3" class="i method">Any</a>(<span id="r19 rd" class="r19 r">m</span> =&gt; <span class="r19 r">m</span>.<span class="i">Id</span> == <span class="r18 r">link</span>.<span class="i">id</span> &amp;&amp; <span class="r19 r">m</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Id</span> == <span class="r18 r">link</span>.<span class="i">operation_Id</span>));
            }
        }
 
        [<span class="i">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="ae3b0f16352c9c16" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">EventHub_MultipleDispatch_BatchSend</a>()
        {
            <b>var</b> (<span id="r20 rd" class="r20 r">jobHost</span>, <span id="r21 rd" class="r21 r">host</span>) = <a href="#f83795d625280bbf" class="i method">BuildHost</a>&lt;<a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>&gt;();
            <b>using</b> (<span class="r21 r">host</span>)
            {
                <b>await</b> <span class="r20 r">jobHost</span>.<span class="i">CallAsync</span>(<b>nameof</b>(<a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>.<span class="i">SendEvents_TestHub</span>), <b>new</b> { <a href="#f87ef7e7ef3633b7" class="i property">input</a> = <span class="s">&quot;data&quot;</span> });
 
                <b>bool</b> <span id="r22 rd" class="r22 r">result</span> = <a href="#bb94e8c1b5221e79" class="i field">_eventWait</a>.<a href="@0@mscorlib/A.html#4b231a1c8efbe5a7" class="i method">WaitOne</a>(<a href="WebJobsEventHubTestBase.cs.html#20167c2fd3c1928c" class="i field">Timeout</a>);
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r22 r">result</span>);
            }
 
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<span class="i">RequestTelemetry</span>&gt; <span id="r23 rd" class="r23 r">requests</span> = <a href="#0756031eb11f1d8d" class="i field">_channel</a>.<a href="#ffcd79b1cc16eb3c" class="i field">Telemetries</a>.<a href="@0@System.Core/A.html#4ba4a3f8a5530e33" class="i method">OfType</a>&lt;<span class="i">RequestTelemetry</span>&gt;().<a href="@0@System.Core/A.html#e276d6892241255b" class="i method">ToList</a>();
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<span class="i">DependencyTelemetry</span>&gt; <span id="r24 rd" class="r24 r">dependencies</span> = <a href="#0756031eb11f1d8d" class="i field">_channel</a>.<a href="#ffcd79b1cc16eb3c" class="i field">Telemetries</a>.<a href="@0@System.Core/A.html#4ba4a3f8a5530e33" class="i method">OfType</a>&lt;<span class="i">DependencyTelemetry</span>&gt;().<a href="@0@System.Core/A.html#e276d6892241255b" class="i method">ToList</a>();
 
            <span class="c">// We expect 5 message spans and 1 send span</span>
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r25 rd" class="r25 r">messageDependencies</span> = <span class="r24 r">dependencies</span>.<a href="@0@System.Core/A.html#e73922753675387a" class="i method">Where</a>(<span id="r26 rd" class="r26 r">d</span> =&gt; <span class="r26 r">d</span>.<span class="i">Name</span> == <span class="s">&quot;EventHubs.Message&quot;</span>).<a href="@0@System.Core/A.html#e276d6892241255b" class="i method">ToList</a>();
            <b>var</b> <span id="r27 rd" class="r27 r">sendDependency</span> = <span class="r24 r">dependencies</span>.<a href="@0@System.Core/A.html#226beadd4e521229" class="i method">Single</a>(<span id="r28 rd" class="r28 r">d</span> =&gt; <span class="r28 r">d</span>.<span class="i">Name</span> == <span class="s">&quot;EventHubProducerClient.Send&quot;</span>);
 
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(5, <span class="r25 r">messageDependencies</span>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a>);
 
            <b>var</b> <span id="r29 rd" class="r29 r">manualCallRequest</span> = <span class="r23 r">requests</span>.<a href="@0@System.Core/A.html#226beadd4e521229" class="i method">Single</a>(<span id="r30 rd" class="r30 r">r</span> =&gt; <span class="r30 r">r</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Name</span> == <b>nameof</b>(<a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>.<span class="i">SendEvents_TestHub</span>));
            <b>var</b> <span id="r31 rd" class="r31 r">manualOperationId</span> = <span class="r29 r">manualCallRequest</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Id</span>;
 
            <span class="i">ValidateEventHubDependency</span>(
                <span class="r27 r">sendDependency</span>,
                <a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#2eb9434a1448d776" class="t t">EventHubsTestEnvironment</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#71524bf9ff4cebd2" class="i property">Instance</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#87ec54fcb2db1491" class="i property">FullyQualifiedNamespace</a>,
                <a href="WebJobsEventHubTestBase.cs.html#41395d9dc926fcf1" class="i field">_eventHubScope</a>.<a href="SharedSource/Testing/EventHubScope.cs.html#c426e0cce2f6622b" class="i property">EventHubName</a>,
                <span class="s">&quot;EventHubProducerClient.Send&quot;</span>,
                <b>nameof</b>(<a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>.<span class="i">SendEvents_TestHub</span>),
                <span class="r31 r">manualOperationId</span>,
                <span class="r29 r">manualCallRequest</span>.<span class="i">Id</span>,
                <span class="i">LogCategories</span>.<span class="i">Bindings</span>);
 
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r32 rd" class="r32 r">ehTriggerRequests</span> = <span class="r23 r">requests</span>.<a href="@0@System.Core/A.html#e73922753675387a" class="i method">Where</a>(<span id="r33 rd" class="r33 r">r</span> =&gt; <span class="r33 r">r</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Name</span> == <b>nameof</b>(<a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>.<span class="i">ProcessMultipleEvents</span>)).<a href="@0@System.Core/A.html#e276d6892241255b" class="i method">ToList</a>();
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="#d1873f2dfd17bbdf" class="t t">TestLink</a>&gt; <span id="r34 rd" class="r34 r">allLinks</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="#d1873f2dfd17bbdf" class="t t">TestLink</a>&gt;();
 
            <span class="c">// EventHub can batch events in a different ways</span>
            <b>foreach</b> (<b>var</b> <span id="r35 rd" class="r35 r">ehTriggerRequest</span> <b>in</b> <span class="r32 r">ehTriggerRequests</span>)
            {
                <a href="#f0255c14a3ec4625" class="i method">ValidateEventHubRequest</a>(
                     <span class="r35 r">ehTriggerRequest</span>,
                     <b>true</b>,
                     <a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#2eb9434a1448d776" class="t t">EventHubsTestEnvironment</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#71524bf9ff4cebd2" class="i property">Instance</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#87ec54fcb2db1491" class="i property">FullyQualifiedNamespace</a>,
                     <a href="WebJobsEventHubTestBase.cs.html#41395d9dc926fcf1" class="i field">_eventHubScope</a>.<a href="SharedSource/Testing/EventHubScope.cs.html#c426e0cce2f6622b" class="i property">EventHubName</a>,
                     <b>nameof</b>(<a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>.<span class="i">ProcessMultipleEvents</span>),
                     <b>null</b>,
                     <b>null</b>);
 
                <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r35 r">ehTriggerRequest</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Id</span>);
                <span class="i">Assert</span>.<span class="i">Null</span>(<span class="r35 r">ehTriggerRequest</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">ParentId</span>);
 
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r35 r">ehTriggerRequest</span>.<span class="i">Properties</span>.<span class="i">TryGetValue</span>(<span class="s">&quot;_MS.links&quot;</span>, <b>out</b> <b>var</b> <span id="r36 rd" class="r36 r">linksStr</span>));
                <b>var</b> <span id="r37 rd" class="r37 r">currentRequestAndTestLinks</span> = <span class="i">JsonConvert</span>.<span class="i">DeserializeObject</span>&lt;<a href="#d1873f2dfd17bbdf" class="t t">TestLink</a>[]&gt;(<span class="r36 r">linksStr</span>, <a href="#36362d1fdcd17489" class="i field">jsonSettingThrowOnError</a>).<span class="i">ToArray</span>();
                <span class="r34 r">allLinks</span>.<span class="i">AddRange</span>(<span class="r37 r">currentRequestAndTestLinks</span>);
 
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r35 r">ehTriggerRequest</span>.<span class="i">Properties</span>.<span class="i">TryGetValue</span>(<span class="s">&quot;receivedMessages&quot;</span>, <b>out</b> <b>var</b> <span id="r38 rd" class="r38 r">receivedMessagesPropStr</span>));
                <span class="i">Assert</span>.<span class="i">AreEqual</span>(<b>int</b>.<span class="i">Parse</span>(<span class="r38 r">receivedMessagesPropStr</span>), <span class="r37 r">currentRequestAndTestLinks</span>.<span class="i">Length</span>);
            }
 
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>.<a href="#0614ed875437cec0" class="i field">LinksCount</a>.<a href="@0@System.Core/A.html#17ae8142727f08ee" class="i method">Sum</a>(), <span class="r34 r">allLinks</span>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a>);
            <b>foreach</b> (<a href="#d1873f2dfd17bbdf" class="k">var</a> <span id="r39 rd" class="r39 r">link</span> <b>in</b> <span class="r34 r">allLinks</span>)
            {
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r25 r">messageDependencies</span>.<a href="@0@System.Core/A.html#6a1af7c3d17845e3" class="i method">Any</a>(<span id="r40 rd" class="r40 r">m</span> =&gt; <span class="r40 r">m</span>.<span class="i">Id</span> == <span class="r39 r">link</span>.<a href="#8901c2c62ff736a5" class="i property">id</a> &amp;&amp; <span class="r40 r">m</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Id</span> == <span class="r39 r">link</span>.<a href="#6e6032d512fb165b" class="i property">operation_Id</a>));
            }
        }
 
        [<span class="i">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="99ceae28b15411aa" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">EventHub_MultipleDispatch_IndependentMessages</a>()
        {
            <span class="c">// send individual messages via EventHub client, process batch by host</span>
            <b>await using</b> <b>var</b> <span id="r41 rd" class="r41 r">ehClient</span> = <b>new</b> <span class="i">EventHubProducerClient</span>(<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#2eb9434a1448d776" class="t t">EventHubsTestEnvironment</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#71524bf9ff4cebd2" class="i property">Instance</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#2b1a580bf71837be" class="i property">EventHubsConnectionString</a>, <a href="WebJobsEventHubTestBase.cs.html#41395d9dc926fcf1" class="i field">_eventHubScope</a>.<a href="SharedSource/Testing/EventHubScope.cs.html#c426e0cce2f6622b" class="i property">EventHubName</a>);
 
            <b>var</b> <span id="r42 rd" class="r42 r">messages</span> = <b>new</b> <span class="i">EventData</span>[5];
            <b>var</b> <span id="r43 rd" class="r43 r">expectedLinks</span> = <b>new</b> <a href="#d1873f2dfd17bbdf" class="t t">TestLink</a>[<span class="r42 r">messages</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>];
 
            <b>for</b> (<b>int</b> <span id="r44 rd" class="r44 r">i</span> = 0; <span class="r44 r">i</span> &lt; <span class="r42 r">messages</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>; <span class="r44 r">i</span>++)
            {
                <b>var</b> <span id="r45 rd" class="r45 r">operationId</span> = <span class="i">ActivityTraceId</span>.<span class="i">CreateRandom</span>().<span class="i">ToHexString</span>();
                <b>var</b> <span id="r46 rd" class="r46 r">spanId</span> = <span class="i">ActivitySpanId</span>.<span class="i">CreateRandom</span>().<span class="i">ToHexString</span>();
                <span class="r43 r">expectedLinks</span>[<span class="r44 r">i</span>] = <b>new</b> <a href="#d1873f2dfd17bbdf" class="t constructor">TestLink</a>
                {
                    <a href="#6e6032d512fb165b" class="i property">operation_Id</a> = <span class="r45 r">operationId</span>,
                    <a href="#8901c2c62ff736a5" class="i property">id</a> = <span class="r46 r">spanId</span>
                };
 
                <span class="r42 r">messages</span>[<span class="r44 r">i</span>] = <b>new</b> <span class="i">EventData</span>(<a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#a10eb90a3d884500" class="i property">UTF8</a>.<a href="@0@mscorlib/A.html#83f2d2c6f22db1a9" class="i method">GetBytes</a>(<span class="r44 r">i</span>.<a href="@0@mscorlib/A.html#8d6f2d8bc0589463" class="i method">ToString</a>()))
                {
                    <span class="i">Properties</span> = { [<span class="s">&quot;Diagnostic-Id&quot;</span>] = <span class="s">$&quot;</span><span class="s">00-</span>{<span class="r45 r">operationId</span>}<span class="s">-</span>{<span class="r46 r">spanId</span>}<span class="s">-01</span><span class="s">&quot;</span> }
                };
            }
 
            <b>await</b> <span class="r41 r">ehClient</span>.<span class="i">SendAsync</span>(<span class="r42 r">messages</span>);
 
            <b>var</b> (<span id="r47 rd" class="r47 r">jobHost</span>, <span id="r48 rd" class="r48 r">host</span>) = <a href="#f83795d625280bbf" class="i method">BuildHost</a>&lt;<a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>&gt;();
            <b>using</b> (<span class="r48 r">host</span>)
            {
                <b>bool</b> <span id="r49 rd" class="r49 r">result</span> = <a href="#bb94e8c1b5221e79" class="i field">_eventWait</a>.<a href="@0@mscorlib/A.html#4b231a1c8efbe5a7" class="i method">WaitOne</a>(<a href="WebJobsEventHubTestBase.cs.html#20167c2fd3c1928c" class="i field">Timeout</a>);
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r49 r">result</span>);
            }
 
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<span class="i">RequestTelemetry</span>&gt; <span id="r50 rd" class="r50 r">requests</span> = <a href="#0756031eb11f1d8d" class="i field">_channel</a>.<a href="#ffcd79b1cc16eb3c" class="i field">Telemetries</a>.<a href="@0@System.Core/A.html#4ba4a3f8a5530e33" class="i method">OfType</a>&lt;<span class="i">RequestTelemetry</span>&gt;().<a href="@0@System.Core/A.html#e276d6892241255b" class="i method">ToList</a>();
 
            <a href="@0@mscorlib/A.html#3acf01620172c7f0" class="k">var</a> <span id="r51 rd" class="r51 r">ehTriggerRequests</span> = <span class="r50 r">requests</span>.<a href="@0@System.Core/A.html#e73922753675387a" class="i method">Where</a>(<span id="r52 rd" class="r52 r">r</span> =&gt; <span class="r52 r">r</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Name</span> == <b>nameof</b>(<a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>.<span class="i">ProcessMultipleEvents</span>));
 
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="#d1873f2dfd17bbdf" class="t t">TestLink</a>&gt; <span id="r53 rd" class="r53 r">actualLinks</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="#d1873f2dfd17bbdf" class="t t">TestLink</a>&gt;();
            <b>foreach</b> (<b>var</b> <span id="r54 rd" class="r54 r">ehTriggerRequest</span> <b>in</b> <span class="r51 r">ehTriggerRequests</span>)
            {
                <a href="#f0255c14a3ec4625" class="i method">ValidateEventHubRequest</a>(
                    <span class="r54 r">ehTriggerRequest</span>,
                    <b>true</b>,
                    <a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#2eb9434a1448d776" class="t t">EventHubsTestEnvironment</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#71524bf9ff4cebd2" class="i property">Instance</a>.<a href="SharedSource/Testing/EventHubsTestEnvironment.cs.html#87ec54fcb2db1491" class="i property">FullyQualifiedNamespace</a>,
                    <a href="WebJobsEventHubTestBase.cs.html#41395d9dc926fcf1" class="i field">_eventHubScope</a>.<a href="SharedSource/Testing/EventHubScope.cs.html#c426e0cce2f6622b" class="i property">EventHubName</a>,
                    <b>nameof</b>(<a href="#240ac7513b8f66b7" class="t t">EventHubTestMultipleDispatchJobs</a>.<span class="i">ProcessMultipleEvents</span>),
                    <b>null</b>,
                    <b>null</b>);
 
                <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r54 r">ehTriggerRequest</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Id</span>);
                <span class="i">Assert</span>.<span class="i">Null</span>(<span class="r54 r">ehTriggerRequest</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">ParentId</span>);
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r54 r">ehTriggerRequest</span>.<span class="i">Properties</span>.<span class="i">TryGetValue</span>(<span class="s">&quot;_MS.links&quot;</span>, <b>out</b> <b>var</b> <span id="r55 rd" class="r55 r">linksStr</span>));
                <span class="r53 r">actualLinks</span>.<span class="i">AddRange</span>(<span class="i">JsonConvert</span>.<span class="i">DeserializeObject</span>&lt;<a href="#d1873f2dfd17bbdf" class="t t">TestLink</a>[]&gt;(<span class="r55 r">linksStr</span>, <a href="#36362d1fdcd17489" class="i field">jsonSettingThrowOnError</a>));
            }
 
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r43 r">expectedLinks</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>, <span class="r53 r">actualLinks</span>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a>);
            <b>foreach</b> (<a href="#d1873f2dfd17bbdf" class="k">var</a> <span id="r56 rd" class="r56 r">link</span> <b>in</b> <span class="r53 r">actualLinks</span>)
            {
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r43 r">expectedLinks</span>.<a href="@0@System.Core/A.html#6a1af7c3d17845e3" class="i method">Any</a>(<span id="r57 rd" class="r57 r">l</span> =&gt; <span class="r57 r">l</span>.<a href="#6e6032d512fb165b" class="i property">operation_Id</a> == <span class="r56 r">link</span>.<a href="#6e6032d512fb165b" class="i property">operation_Id</a> &amp;&amp; <span class="r57 r">l</span>.<a href="#8901c2c62ff736a5" class="i property">id</a> == <span class="r56 r">link</span>.<a href="#8901c2c62ff736a5" class="i property">id</a>));
            }
        }
 
        <b>private void</b> <a id="f0255c14a3ec4625" href="R/f0255c14a3ec4625.html" target="n" data-glyph="76,1" class="i method">ValidateEventHubRequest</a>(
            <span class="i">RequestTelemetry</span> <span id="r58 rd" class="r58 r">request</span>,
            <b>bool</b> <span id="r59 rd" class="r59 r">success</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r60 rd" class="r60 r">endpoint</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r61 rd" class="r61 r">entityName</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r62 rd" class="r62 r">operationName</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r63 rd" class="r63 r">operationId</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r64 rd" class="r64 r">parentId</span>)
        {
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r58 r">request</span>.<span class="i">Source</span>, <span class="s">$&quot;</span>{<span class="r60 r">endpoint</span>}<span class="s">/</span>{<span class="r61 r">entityName</span>}<span class="s">&quot;</span>);
            <span class="i">Assert</span>.<span class="i">Null</span>(<span class="r58 r">request</span>.<span class="i">Url</span>);
 
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r58 r">request</span>.<span class="i">Properties</span>.<span class="i">ContainsKey</span>(<span class="i">LogConstants</span>.<span class="i">FunctionExecutionTimeKey</span>));
            <span class="i">Assert</span>.<span class="i">True</span>(<b>double</b>.<span class="i">TryParse</span>(<span class="r58 r">request</span>.<span class="i">Properties</span>[<span class="i">LogConstants</span>.<span class="i">FunctionExecutionTimeKey</span>], <b>out double</b> <span id="r65 rd" class="r65 r">functionDuration</span>));
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r58 r">request</span>.<span class="i">Duration</span>.<span class="i">TotalMilliseconds</span> &gt;= <span class="r65 r">functionDuration</span>);
 
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="i">LogCategories</span>.<span class="i">Results</span>, <span class="r58 r">request</span>.<span class="i">Properties</span>[<span class="i">LogConstants</span>.<span class="i">CategoryNameKey</span>]);
            <span class="i">Assert</span>.<span class="i">AreEqual</span>((<span class="r59 r">success</span> ? <span class="i">LogLevel</span>.<span class="i">Information</span> : <span class="i">LogLevel</span>.<span class="i">Error</span>).<span class="i">ToString</span>(), <span class="r58 r">request</span>.<span class="i">Properties</span>[<span class="i">LogConstants</span>.<span class="i">LogLevelKey</span>]);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r58 r">request</span>.<span class="i">Name</span>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r58 r">request</span>.<span class="i">Id</span>);
 
            <b>if</b> (<span class="r63 r">operationId</span> != <b>null</b>)
            {
                <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r63 r">operationId</span>, <span class="r58 r">request</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Id</span>);
            }
 
            <b>if</b> (<span class="r64 r">parentId</span> != <b>null</b>)
            {
                <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r64 r">parentId</span>, <span class="r58 r">request</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">ParentId</span>);
            }
 
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r62 r">operationName</span>, <span class="r58 r">request</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Name</span>);
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r62 r">operationName</span>, <span class="r58 r">request</span>.<span class="i">Name</span>);
 
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r58 r">request</span>.<span class="i">Properties</span>.<span class="i">ContainsKey</span>(<span class="i">LogConstants</span>.<span class="i">InvocationIdKey</span>));
 
            <span class="c">// EventHub does not populate Trigger reason</span>
            <span class="i">Assert</span>.<span class="i">False</span>(<span class="r58 r">request</span>.<span class="i">Properties</span>.<span class="i">ContainsKey</span>(<span class="i">LogConstants</span>.<span class="i">TriggerReasonKey</span>));
 
            <span class="i">StringAssert</span>.<span class="i">StartsWith</span>(<span class="s">&quot;webjobs:&quot;</span>, <span class="r58 r">request</span>.<span class="i">Context</span>.<span class="i">GetInternalContext</span>().<span class="i">SdkVersion</span>);
 
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r59 r">success</span>, <span class="r58 r">request</span>.<span class="i">Success</span>);
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="s">&quot;0&quot;</span>, <span class="r58 r">request</span>.<span class="i">ResponseCode</span>);
 
            <span class="i">Assert</span>.<span class="i">False</span>(<span class="r58 r">request</span>.<span class="i">Properties</span>.<span class="i">Any</span>(<span id="r66 rd" class="r66 r">p</span> =&gt; <span class="r66 r">p</span>.<span class="i">Key</span> == <span class="i">LogConstants</span>.<span class="i">SucceededKey</span>));
        }
 
        <b>private void</b> <a id="82c2282a3630636d" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ValidateEventHubDependency</a>(
            <span class="i">DependencyTelemetry</span> <span id="r67 rd" class="r67 r">dependency</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r68 rd" class="r68 r">endpoint</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r69 rd" class="r69 r">entityName</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r70 rd" class="r70 r">name</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r71 rd" class="r71 r">operationName</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r72 rd" class="r72 r">operationId</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r73 rd" class="r73 r">parentId</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r74 rd" class="r74 r">category</span>)
        {
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="s">$&quot;</span>{<span class="r68 r">endpoint</span>}<span class="s">/</span>{<span class="r69 r">entityName</span>}<span class="s">&quot;</span>, <span class="r67 r">dependency</span>.<span class="i">Target</span>);
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="s">&quot;Azure Event Hubs&quot;</span>, <span class="r67 r">dependency</span>.<span class="i">Type</span>);
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r70 r">name</span>, <span class="r67 r">dependency</span>.<span class="i">Name</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r67 r">dependency</span>.<span class="i">Success</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<span class="i">IsNullOrEmpty</span>(<span class="r67 r">dependency</span>.<span class="i">Data</span>));
 
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r74 r">category</span>, <span class="r67 r">dependency</span>.<span class="i">Properties</span>[<span class="i">LogConstants</span>.<span class="i">CategoryNameKey</span>]);
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="i">LogLevel</span>.<span class="i">Information</span>.<span class="i">ToString</span>(), <span class="r67 r">dependency</span>.<span class="i">Properties</span>[<span class="i">LogConstants</span>.<span class="i">LogLevelKey</span>]);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r67 r">dependency</span>.<span class="i">Target</span>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r67 r">dependency</span>.<span class="i">Name</span>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r67 r">dependency</span>.<span class="i">Id</span>);
 
            <b>if</b> (<span class="r72 r">operationId</span> != <b>null</b>)
            {
                <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r72 r">operationId</span>, <span class="r67 r">dependency</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Id</span>);
            }
 
            <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r71 r">operationName</span>, <span class="r67 r">dependency</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">Name</span>);
 
            <b>if</b> (<span class="r73 r">parentId</span> != <b>null</b>)
            {
                <span class="i">Assert</span>.<span class="i">AreEqual</span>(<span class="r73 r">parentId</span>, <span class="r67 r">dependency</span>.<span class="i">Context</span>.<span class="i">Operation</span>.<span class="i">ParentId</span>);
            }
 
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r67 r">dependency</span>.<span class="i">Properties</span>.<span class="i">ContainsKey</span>(<span class="i">LogConstants</span>.<span class="i">InvocationIdKey</span>));
        }
 
        <b>public class</b> <a id="bfd4b36fbdd8bcf8" href="R/bfd4b36fbdd8bcf8.html" target="n" data-glyph="0,1" class="t t"><span id="bb700d8c7b58154a">EventHubTestSingleDispatchJobs</span></a>
        {
            <b>public static void</b> <a id="f878e8fb7697f86d" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">SendEvent_TestHub</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r75 rd" class="r75 r">input</span>, [<span class="i">EventHub</span>(<a href="WebJobsEventHubTestBase.cs.html#b5c77c2843a98e52" class="i field">TestHubName</a>)] <b>out</b> <span class="i">EventData</span> <span id="r76 rd" class="r76 r">evt</span>)
            {
                <span class="r76 r">evt</span> = <b>new</b> <span class="i">EventData</span>(<a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#a10eb90a3d884500" class="i property">UTF8</a>.<a href="@0@mscorlib/A.html#83f2d2c6f22db1a9" class="i method">GetBytes</a>(<span class="r75 r">input</span>));
            }
 
            <b>public static void</b> <a id="44137e0144bf5e18" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">ProcessSingleEvent</a>([<span class="i">EventHubTrigger</span>(<a href="WebJobsEventHubTestBase.cs.html#b5c77c2843a98e52" class="i field">TestHubName</a>)] <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r77 rd" class="r77 r">evt</span>)
            {
                <a href="#bb94e8c1b5221e79" class="i field">_eventWait</a>.<a href="@0@mscorlib/A.html#63f3d76fa45ccc3d" class="i method">Set</a>();
            }
        }
 
        <b>public class</b> <a id="240ac7513b8f66b7" href="R/240ac7513b8f66b7.html" target="n" data-glyph="0,1" class="t t"><span id="33825c5b99df3577">EventHubTestMultipleDispatchJobs</span></a>
        {
            <b>public static</b> <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<b>int</b>&gt; <a id="0614ed875437cec0" href="R/0614ed875437cec0.html" target="n" data-glyph="42,2" class="i field">LinksCount</a> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<b>int</b>&gt;();
            <b>public static int</b> <a id="ddbe2432f8297e0b" href="R/ddbe2432f8297e0b.html" target="n" data-glyph="42,2" class="i field">MessagesCount</a> = 0;
 
            <b>private const int</b> <a id="f0fda2f3532d195c" href="R/f0fda2f3532d195c.html" target="n" data-glyph="10,2" class="i field">EventCount</a> = 5;
            <b>private static readonly object</b> <a id="3e1f4afa60a8b64a" href="R/3e1f4afa60a8b64a.html" target="n" data-glyph="46,2" class="i field">MessageLock</a> = <b>new</b> <b>object</b>();
            <b>public static void</b> <a id="e5c325956d94e996" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">SendEvents_TestHub</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r78 rd" class="r78 r">input</span>, [<span class="i">EventHub</span>(<a href="WebJobsEventHubTestBase.cs.html#b5c77c2843a98e52" class="i field">TestHubName</a>)] <b>out</b> <span class="i">EventData</span>[] <span id="r79 rd" class="r79 r">events</span>)
            {
                <a href="#0614ed875437cec0" class="i field">LinksCount</a>.<a href="@0@mscorlib/A.html#ca7bce81a50b0aeb" class="i method">Clear</a>();
                <a href="#ddbe2432f8297e0b" class="i field">MessagesCount</a> = 0;
                <span class="r79 r">events</span> = <b>new</b> <span class="i">EventData</span>[<a href="#f0fda2f3532d195c" class="i field">EventCount</a>];
                <b>for</b> (<b>int</b> <span id="r80 rd" class="r80 r">i</span> = 0; <span class="r80 r">i</span> &lt; <a href="#f0fda2f3532d195c" class="i field">EventCount</a>; <span class="r80 r">i</span>++)
                {
                    <b>var</b> <span id="r81 rd" class="r81 r">evt</span> = <b>new</b> <span class="i">EventData</span>(<a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#a10eb90a3d884500" class="i property">UTF8</a>.<a href="@0@mscorlib/A.html#83f2d2c6f22db1a9" class="i method">GetBytes</a>(<span class="r78 r">input</span> + <span class="r80 r">i</span>));
                    <span class="r79 r">events</span>[<span class="r80 r">i</span>] = <span class="r81 r">evt</span>;
                }
            }
 
            <b>public static void</b> <a id="3677c20b52a4a08f" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">ProcessMultipleEvents</a>([<span class="i">EventHubTrigger</span>(<a href="WebJobsEventHubTestBase.cs.html#b5c77c2843a98e52" class="i field">TestHubName</a>)] <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>[] <span id="r82 rd" class="r82 r">events</span>)
            {
                <span class="i">Activity</span>.<span class="i">Current</span>.<span class="i">AddTag</span>(<span class="s">&quot;receivedMessages&quot;</span>, <span class="r82 r">events</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>.<a href="@0@mscorlib/A.html#8d6f2d8bc0589463" class="i method">ToString</a>());
                <b>lock</b> (<a href="#3e1f4afa60a8b64a" class="i field">MessageLock</a>)
                {
                    <a href="#ddbe2432f8297e0b" class="i field">MessagesCount</a> += <span class="r82 r">events</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>;
 
                    <b>if</b> (<span class="r82 r">events</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> &gt; 0)
                    {
                        <a href="#0614ed875437cec0" class="i field">LinksCount</a>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r82 r">events</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>);
                    }
 
                    <b>if</b> (<a href="#ddbe2432f8297e0b" class="i field">MessagesCount</a> &gt;= <a href="#f0fda2f3532d195c" class="i field">EventCount</a>)
                    {
                        <a href="#bb94e8c1b5221e79" class="i field">_eventWait</a>.<a href="@0@mscorlib/A.html#63f3d76fa45ccc3d" class="i method">Set</a>();
                    }
                }
            }
        }
 
        <b>private</b> (<span class="i">JobHost</span>, <span class="i">IHost</span>) <a id="f83795d625280bbf" href="R/f83795d625280bbf.html" target="n" data-glyph="76,1" class="i method">BuildHost</a>&lt;<span id="r83 rd t" class="r83 r t">T</span>&gt;()
        {
            <b>var</b> (<span id="r84 rd" class="r84 r">jobHost</span>, <span id="r85 rd" class="r85 r">host</span>) = <a href="WebJobsEventHubTestBase.cs.html#306be03bb0b01b08" class="k">base</a>.<span class="i">BuildHost</span>&lt;<span class="r83 r t">T</span>&gt;(<span id="r86 rd" class="r86 r">builder</span> =&gt;
            {
                <span class="r86 r">builder</span>.<span class="i">ConfigureLogging</span>(<span id="r87 rd" class="r87 r">b</span> =&gt; <span class="r87 r">b</span>.<span class="i">AddApplicationInsightsWebJobs</span>(<span id="r88 rd" class="r88 r">o</span> =&gt; <span class="r88 r">o</span>.<span class="i">InstrumentationKey</span> = <span class="s">&quot;mock ikey&quot;</span>));
                <a href="WebJobsEventHubTestBase.cs.html#32223f6004cdaca7" class="i method">ConfigureTestEventHub</a>(<span class="r86 r">builder</span>);
            }, <span id="r89 rd" class="r89 r">h</span> =&gt; <span class="r89 r">h</span>.<span class="i">Services</span>.<span class="i">GetService</span>&lt;<span class="i">TelemetryConfiguration</span>&gt;().<span class="i">TelemetryChannel</span> = <a href="#0756031eb11f1d8d" class="i field">_channel</a>);
 
            <b>return</b> (<span class="r84 r">jobHost</span>, <span class="r85 r">host</span>);
        }
 
        <b>private class</b> <a id="5f74a470da85bcf7" href="R/5f74a470da85bcf7.html" target="n" data-glyph="4,1" class="t t"><span id="7d12dec0d5a65239">TestTelemetryChannel</span></a> : <span class="i">ITelemetryChannel</span>, <span class="i">ITelemetryModule</span>
        {
            <b>public</b> <a href="@0@System/A.html#2b70243adbcbdb40" class="t t">ConcurrentBag</a>&lt;<span class="i">ITelemetry</span>&gt; <a id="ffcd79b1cc16eb3c" href="R/ffcd79b1cc16eb3c.html" target="n" data-glyph="42,2" class="i field">Telemetries</a> = <b>new</b> <a href="@0@System/A.html#d7c19e4f8f3adffb" class="t constructor">ConcurrentBag</a>&lt;<span class="i">ITelemetry</span>&gt;();
 
            <b>public bool</b>? <a id="c8bb07bf33081c7c" href="R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">DeveloperMode</a> { <b>get</b>; <b>set</b>; }
 
            <b>public string</b> <a id="dc68b6dcdfbc7626" href="R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">EndpointAddress</a> { <b>get</b>; <b>set</b>; }
 
            <b>public void</b> <a id="a57dc657d04d974e" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">Dispose</a>()
            {
            }
 
            <b>public void</b> <a id="75c98c9b6bb9d4cd" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">Flush</a>()
            {
            }
 
            <b>public void</b> <a id="e5a1c2d0c51a1b5a" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">Send</a>(<span class="i">ITelemetry</span> <span id="r90 rd" class="r90 r">item</span>)
            {
                <a href="#ffcd79b1cc16eb3c" class="i field">Telemetries</a>.<a href="@0@System/A.html#ef482ba238e37447" class="i method">Add</a>(<span class="r90 r">item</span>);
            }
 
            <b>public void</b> <a id="cdcb136354a646a3" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">Initialize</a>(<span class="i">TelemetryConfiguration</span> <span id="r91 rd" class="r91 r">configuration</span>)
            {
            }
        }
 
        <b>private class</b> <a id="d1873f2dfd17bbdf" href="R/d1873f2dfd17bbdf.html" target="n" data-glyph="4,1" class="t t"><span id="eb4f5f9747f0edb0">TestLink</span></a>
        {
            <b>public string</b> <a id="6e6032d512fb165b" href="R/6e6032d512fb165b.html" target="n" data-glyph="102,2" class="i property">operation_Id</a> { <b>get</b>; <b>set</b>; }
            <b>public string</b> <a id="8901c2c62ff736a5" href="R/8901c2c62ff736a5.html" target="n" data-glyph="102,2" class="i property">id</a> { <b>get</b>; <b>set</b>; }
        }
    }
}
</pre></td></tr></table></div></body></html>
