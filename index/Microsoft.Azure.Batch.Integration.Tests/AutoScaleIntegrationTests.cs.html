<!DOCTYPE html>
<html><head><title>AutoScaleIntegrationTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(113);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Batch.Integration.Tests/AutoScaleIntegrationTests.cs" target="_top">AutoScaleIntegrationTests.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/batch/Microsoft.Azure.Batch/tests/IntegrationTests/AutoScaleIntegrationTests.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Batch.Integration.Tests" target="_top">Microsoft.Azure.Batch.Integration.Tests.csproj</a> (Microsoft.Azure.Batch.Integration.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>namespace</b> <span class="i n">BatchClientIntegrationTests</span>
{
    <b>using</b> <span class="i n">System</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>.<span class="i n">Common</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>.<span class="i n">Integration</span>.<span class="i n">Tests</span>.<span class="i n">Infrastructure</span>;
    <b>using</b> <span class="i n">Xunit</span>;
    <b>using</b> <span class="i n">Xunit</span>.<span class="i n">Abstractions</span>;
 
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>;
    <b>using</b> <span class="i n">BatchTestCommon</span>;
    <b>using</b> <span class="i n">IntegrationTestUtilities</span>;
    <b>using</b> <span class="i n">Fixtures</span>;
 
    <b>public class</b> <a id="73e11439bf1e1f9e" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">AutoScaleIntegrationTests</a>
    {
        <b>private readonly</b> <span class="t t">ITestOutputHelper</span> <a id="e6a7ce5322f64de9" href="R/e6a7ce5322f64de9.html" target="n" data-glyph="46,1" class="i field">testOutputHelper</a>;
        <b>private static readonly</b> <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <a id="78c5b4e06a0a9a3d" href="R/78c5b4e06a0a9a3d.html" target="n" data-glyph="46,1" class="i field">TestTimeout</a> = <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#ae74be5264df78d8" class="i method">FromMinutes</a>(1);
 
        <b>public</b> <a id="2d4d5bf15b1846ca" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">AutoScaleIntegrationTests</a>(<span class="t t">ITestOutputHelper</span> <span id="r0 rd" class="r0 r">testOutputHelper</span>)
        {
            <a href="#73e11439bf1e1f9e" class="k">this</a>.<a href="#e6a7ce5322f64de9" class="i field">testOutputHelper</a> = <span class="r0 r">testOutputHelper</span>;
            <span class="c">//Note -- this class does not and should not need a pool fixture</span>
        }
 
        [<span class="t constructor">Fact</span>]
        [<a href="Infrastructure/LiveTestAttribute.cs.html#a1847f7966bb21d7" class="t constructor">LiveTest</a>]
        [<span class="t constructor">Trait</span>(<a href="/Microsoft.Azure.Batch.Common/A.html#f12b116e0e4623de" class="t t">TestTraits</a>.<a href="/Microsoft.Azure.Batch.Common/A.html#8972788bc05b4b9f" class="t t">Duration</a>.<a href="/Microsoft.Azure.Batch.Common/A.html#9c1513f600f7ef29" class="i field">TraitName</a>, <a href="/Microsoft.Azure.Batch.Common/A.html#f12b116e0e4623de" class="t t">TestTraits</a>.<a href="/Microsoft.Azure.Batch.Common/A.html#8972788bc05b4b9f" class="t t">Duration</a>.<a href="/Microsoft.Azure.Batch.Common/A.html#3192e26026a08a2c" class="t t">Values</a>.<a href="/Microsoft.Azure.Batch.Common/A.html#1ede27a5c32e7e21" class="i field">MediumDuration</a>)]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="8ca0de0ad4c1caf1" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">AutoScaleEvaluationIntervalTest</a>()
        {
            <b>await</b> <a href="IntegrationTestUtilities/SynchronizationContextHelper.cs.html#6ab3759e02709037" class="t t">SynchronizationContextHelper</a>.<a href="IntegrationTestUtilities/SynchronizationContextHelper.cs.html#1694a9aa5f940c26" class="i method">RunTestAsync</a>(<b>async</b> () =&gt;
                {
                    <b>using</b> <a href="/Microsoft.Azure.Batch/A.html#a93c5701bdd04ea3" class="t t">BatchClient</a> <span id="r1 rd" class="r1 r">batchCli</span> = <a href="IntegrationTestUtilities/TestUtilities.cs.html#f71534b6d265a791" class="t t">TestUtilities</a>.<a href="IntegrationTestUtilities/TestUtilities.cs.html#70323b9a3f92692c" class="i method">OpenBatchClient</a>(<a href="IntegrationTestUtilities/TestUtilities.cs.html#f71534b6d265a791" class="t t">TestUtilities</a>.<a href="IntegrationTestUtilities/TestUtilities.cs.html#554e2d8347b023b3" class="i method">GetCredentialsFromEnvironment</a>(), <span class="r2 r">addDefaultRetryPolicy</span>: <b>false</b>);
                    <b>const string</b> <span id="r3 rd" class="r3 r">poolASFormulaOrig</span> = <span class="s">&quot;$TargetDedicated = 0;&quot;</span>;
                    <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <span id="r4 rd" class="r4 r">evalInterval</span> = <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#ae74be5264df78d8" class="i method">FromMinutes</a>(6);
                    <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r5 rd" class="r5 r">poolId0</span> = <span class="s">&quot;AutoScaleEvalInterval0-&quot;</span> + <a href="IntegrationTestUtilities/TestUtilities.cs.html#f71534b6d265a791" class="t t">TestUtilities</a>.<a href="IntegrationTestUtilities/TestUtilities.cs.html#71e76a83fc8dd577" class="i method">GetMyName</a>();
 
                    <b>try</b>
                    {
                        <span class="c">// create an empty pool with autoscale and an eval interval</span>
                        <a href="/Microsoft.Azure.Batch/A.html#348428da8aca4006" class="t t">CloudServiceConfiguration</a> <span id="r6 rd" class="r6 r">cloudServiceConfiguration</span> = <b>new</b> <a href="/Microsoft.Azure.Batch/A.html#99eda79b1aa9b49e" class="t constructor">CloudServiceConfiguration</a>(<a href="Fixtures/PoolFixture.cs.html#adc4366cd44e6b53" class="t t">PoolFixture</a>.<a href="Fixtures/PoolFixture.cs.html#5e861f85d74e2aa6" class="i field">OSFamily</a>);
                        <a href="/Microsoft.Azure.Batch/A.html#683271aa06e0dd76" class="t t">CloudPool</a> <span id="r7 rd" class="r7 r">ubPool</span> = <span class="r1 r">batchCli</span>.<a href="/Microsoft.Azure.Batch/A.html#1eaf767b0e49d294" class="i property">PoolOperations</a>.<a href="/Microsoft.Azure.Batch/A.html#8522fa1b29bc304c" class="i method">CreatePool</a>(
                            <span class="r5 r">poolId0</span>,
                            <span class="r8 r">cloudServiceConfiguration</span>: <span class="r6 r">cloudServiceConfiguration</span>,
                            <span class="r9 r">virtualMachineSize</span>: <a href="Fixtures/PoolFixture.cs.html#adc4366cd44e6b53" class="t t">PoolFixture</a>.<a href="Fixtures/PoolFixture.cs.html#6eb501a39afe1d1d" class="i field">VMSize</a>);
                        <span class="r7 r">ubPool</span>.<a href="/Microsoft.Azure.Batch/A.html#f72324cb755c2f62" class="i property">AutoScaleEnabled</a> = <b>true</b>;
                        <span class="r7 r">ubPool</span>.<a href="/Microsoft.Azure.Batch/A.html#40202541a1c2be96" class="i property">AutoScaleEvaluationInterval</a> = <span class="r4 r">evalInterval</span>;
                        <span class="r7 r">ubPool</span>.<a href="/Microsoft.Azure.Batch/A.html#8c4048d5ce60ac51" class="i property">AutoScaleFormula</a> = <span class="r3 r">poolASFormulaOrig</span>;
 
                        <span class="r7 r">ubPool</span>.<a href="/Microsoft.Azure.Batch/A.html#9b3e5d9dcbf43906" class="i method">Commit</a>();
 
                        <span class="c">// confirm values are returned</span>
                        <a href="/Microsoft.Azure.Batch/A.html#683271aa06e0dd76" class="t t">CloudPool</a> <span id="r10 rd" class="r10 r">bndPool</span> = <span class="r1 r">batchCli</span>.<a href="/Microsoft.Azure.Batch/A.html#1eaf767b0e49d294" class="i property">PoolOperations</a>.<a href="/Microsoft.Azure.Batch/A.html#8a4e4d4ecc0ced75" class="i method">GetPool</a>(<span class="r5 r">poolId0</span>);
 
                        <span class="t t">Assert</span>.<span class="i method">True</span>(<span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#f72324cb755c2f62" class="i property">AutoScaleEnabled</a>.<a href="@0@mscorlib/A.html#7bbe60e33e857298" class="i property">HasValue</a> &amp;&amp; <span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#f72324cb755c2f62" class="i property">AutoScaleEnabled</a>.<a href="@0@mscorlib/A.html#7b38d1fa76071c95" class="i property">Value</a>);
                        <span class="t t">Assert</span>.<span class="i method">Equal</span>(<span class="r4 r">evalInterval</span>, <span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#40202541a1c2be96" class="i property">AutoScaleEvaluationInterval</a>);
 
                        <span class="c">// change eval interval</span>
                        <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <span id="r11 rd" class="r11 r">newEvalInterval</span> = <span class="r4 r">evalInterval</span> + <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#ae74be5264df78d8" class="i method">FromMinutes</a>(1);
 
                        <span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#d0f85fc7277cb39d" class="i method">EnableAutoScale</a>(<span class="r12 r">autoscaleEvaluationInterval</span>: <span class="r11 r">newEvalInterval</span>);
 
                        <b>int</b> <span id="r13 rd" class="r13 r">enableCallCounter</span> = 1; <span class="c">// count these to validate server throttle</span>
                        <b>const int</b> <span id="r14 rd" class="r14 r">expectedEnableCallToFail</span> = 2;
 
                        <span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#7dcf531d15e6aeec" class="i method">Refresh</a>();
 
                        <span class="t t">Assert</span>.<span class="i method">True</span>(<span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#f72324cb755c2f62" class="i property">AutoScaleEnabled</a>.<a href="@0@mscorlib/A.html#7bbe60e33e857298" class="i property">HasValue</a> &amp;&amp; <span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#f72324cb755c2f62" class="i property">AutoScaleEnabled</a>.<a href="@0@mscorlib/A.html#7b38d1fa76071c95" class="i property">Value</a>);
                        <span class="t t">Assert</span>.<span class="i method">True</span>(<span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#40202541a1c2be96" class="i property">AutoScaleEvaluationInterval</a>.<a href="@0@mscorlib/A.html#7bbe60e33e857298" class="i property">HasValue</a>);
                        <span class="t t">Assert</span>.<span class="i method">Equal</span>(<span class="r11 r">newEvalInterval</span>, <span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#40202541a1c2be96" class="i property">AutoScaleEvaluationInterval</a>.<a href="@0@mscorlib/A.html#7b38d1fa76071c95" class="i property">Value</a>);
 
                        <span class="c">// check the interval floor assert</span>
                        <a href="/Microsoft.Azure.Batch/A.html#11968400ddac5a84" class="k">var</a> <span id="r15 rd" class="r15 r">batchException</span> = <a href="IntegrationTestUtilities/TestUtilities.cs.html#f71534b6d265a791" class="t t">TestUtilities</a>.<a href="IntegrationTestUtilities/TestUtilities.cs.html#42ba7df8348907b0" class="i method">AssertThrows</a>&lt;<a href="/Microsoft.Azure.Batch/A.html#11968400ddac5a84" class="t t">BatchException</a>&gt;(
                            () =&gt; <span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#d0f85fc7277cb39d" class="i method">EnableAutoScale</a>(<span class="r12 r">autoscaleEvaluationInterval</span>: <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#ae74be5264df78d8" class="i method">FromMinutes</a>(1)));
                        <span class="t t">Assert</span>.<span class="i method">Equal</span>(<span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>.<span class="i n">Common</span>.<a href="/Microsoft.Azure.Batch/A.html#9e1a4b502b6f243d" class="t t">BatchErrorCodeStrings</a>.<a href="/Microsoft.Azure.Batch/A.html#61493f2e43ec1ce7" class="i field">InvalidPropertyValue</a>, <span class="r15 r">batchException</span>.<a href="/Microsoft.Azure.Batch/A.html#14692f6c736a59f8" class="i property">RequestInformation</a>.<a href="/Microsoft.Azure.Batch/A.html#616fe870d8f90f19" class="i property">BatchError</a>.<a href="/Microsoft.Azure.Batch/A.html#210224cd41cb90de" class="i property">Code</a>);
 
                        <span class="c">// check for AutoScaleTooManyRequestsToEnable</span>
                        <b>try</b>
                        {
                            <span class="c">// spam the server</span>
                            <b>for</b> (<b>int</b> <span id="r16 rd" class="r16 r">i</span> = 0; <span class="r16 r">i</span> &lt; 99; <span class="r16 r">i</span>++)  <span class="c">// remember there was already one (1) call made above</span>
                            {
                                <span class="r13 r">enableCallCounter</span>++; <span class="c">// one more call</span>
                                <span class="r10 r">bndPool</span>.<a href="/Microsoft.Azure.Batch/A.html#d0f85fc7277cb39d" class="i method">EnableAutoScale</a>(<span class="r12 r">autoscaleEvaluationInterval</span>: <span class="r11 r">newEvalInterval</span> + <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(<span class="r16 r">i</span>));
                            }
 
                            <span class="c">// server never pushed back on the spam.  this is a bug</span>
                            <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#df2d82d91ca29e40" class="t constructor">Exception</a>(<span class="s">&quot;AutoScaleEvaluationIntervalTest: unable to force AutoScaleTooManyRequestsToEnable&quot;</span>);
                        }
                        <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r17 rd" class="r17 r">ex</span>)
                        {
                            <a href="IntegrationTestUtilities/TestUtilities.cs.html#f71534b6d265a791" class="t t">TestUtilities</a>.<a href="IntegrationTestUtilities/TestUtilities.cs.html#8a82a6304e74934f" class="i method">AssertIsBatchExceptionAndHasCorrectAzureErrorCode</a>(<span class="r17 r">ex</span>, <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>.<span class="i n">Common</span>.<a href="/Microsoft.Azure.Batch/A.html#9e1a4b502b6f243d" class="t t">BatchErrorCodeStrings</a>.<a href="/Microsoft.Azure.Batch/A.html#3cd3dfbf228d9801" class="i field">AutoScaleTooManyRequestsToEnable</a>, <a href="#e6a7ce5322f64de9" class="i field">testOutputHelper</a>);
 
                            <span class="c">// if we get here the exception passed.</span>
 
                            <span class="c">// confirm that the expected call fails</span>
                            <span class="t t">Assert</span>.<span class="i method">Equal</span>(<span class="r14 r">expectedEnableCallToFail</span>, <span class="r13 r">enableCallCounter</span>);
                        }
                    }
                    <b>finally</b>
                    {
                        <span class="c">// cleanup</span>
                        <a href="IntegrationTestUtilities/TestUtilities.cs.html#f71534b6d265a791" class="t t">TestUtilities</a>.<a href="IntegrationTestUtilities/TestUtilities.cs.html#648fc0c65fd08c29" class="i method">DeletePoolIfExistsAsync</a>(<span class="r1 r">batchCli</span>, <span class="r5 r">poolId0</span>).<a href="@0@mscorlib/A.html#1bfe9e19e44f4cfa" class="i method">Wait</a>();
                    }
                },
                <a href="#78c5b4e06a0a9a3d" class="i field">TestTimeout</a>);
        }
    }
}
</pre></td></tr></table></div></body></html>
