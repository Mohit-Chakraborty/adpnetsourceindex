<!DOCTYPE html>
<html><head><title>AzureKeyVaultXmlEncryptor.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(80);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Extensions.AspNetCore.DataProtection.Keys/AzureKeyVaultXmlEncryptor.cs" target="_top">AzureKeyVaultXmlEncryptor.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Extensions.AspNetCore.DataProtection.Keys" target="_top">Azure.Extensions.AspNetCore.DataProtection.Keys\src\Azure.Extensions.AspNetCore.DataProtection.Keys.csproj</a> (Azure.Extensions.AspNetCore.DataProtection.Keys)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i">System</span>;
<b>using</b> <span class="i">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Xml</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i">Cryptography</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i">Security</span>.<span class="i">KeyVault</span>.<span class="i">Keys</span>.<span class="i">Cryptography</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">DataProtection</span>.<span class="i">XmlEncryption</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Extensions</span>.<span class="i n">AspNetCore</span>.<span class="i n">DataProtection</span>.<span class="i n">Keys</span>
{
    <b>internal class</b> <a id="64f3d5eb9725dfc7" href="R/64f3d5eb9725dfc7.html" target="n" data-glyph="2,0" class="t t">AzureKeyVaultXmlEncryptor</a> : <span class="i">IXmlEncryptor</span>
    {
        <b>internal static readonly string</b> <a id="2e57a5d3d8a18008" href="R/2e57a5d3d8a18008.html" target="n" data-glyph="44,1" class="i field">DefaultKeyEncryption</a> = <span class="i">KeyWrapAlgorithm</span>.<span class="i">RsaOaep</span>.<span class="i">ToString</span>();
        <b>internal static readonly</b> <span class="i">Func</span>&lt;<span class="i">SymmetricAlgorithm</span>&gt; <a id="953fc77dc57321fb" href="R/../../0000000000.html" target="n" data-glyph="44,1" class="i field">DefaultSymmetricAlgorithmFactory</a> = <span class="i">Aes</span>.<span class="i">Create</span>;
 
        <b>private readonly</b> <span class="i">RandomNumberGenerator</span> <a id="c84403d1edf8ed09" href="R/c84403d1edf8ed09.html" target="n" data-glyph="46,1" class="i field">_randomNumberGenerator</a>;
        <b>private readonly</b> <span class="i">IKeyEncryptionKeyResolver</span> <a id="7712e488d65fc8a2" href="R/7712e488d65fc8a2.html" target="n" data-glyph="46,1" class="i field">_client</a>;
        <b>private readonly string</b> <a id="0908951f4ac0b91e" href="R/0908951f4ac0b91e.html" target="n" data-glyph="46,1" class="i field">_keyId</a>;
 
        <b>public</b> <a id="7fe36ce50c3ad450" href="R/7fe36ce50c3ad450.html" target="n" data-glyph="72,1" class="t constructor">AzureKeyVaultXmlEncryptor</a>(<span class="i">IKeyEncryptionKeyResolver</span> <span id="r0 rd" class="r0 r">client</span>, <b>string</b> <span id="r1 rd" class="r1 r">keyId</span>)
            : <b>this</b>(<span class="r0 r">client</span>, <span class="r1 r">keyId</span>, <span class="i">RandomNumberGenerator</span>.<span class="i">Create</span>())
        {
        }
 
        <b>internal</b> <a id="ce3bfec047604029" href="R/../../0000000000.html" target="n" data-glyph="74,1" class="t constructor">AzureKeyVaultXmlEncryptor</a>(<span class="i">IKeyEncryptionKeyResolver</span> <span id="r2 rd" class="r2 r">client</span>, <b>string</b> <span id="r3 rd" class="r3 r">keyId</span>,
            <span class="i">RandomNumberGenerator</span> <span id="r4 rd" class="r4 r">randomNumberGenerator</span>)
        {
            <a href="#7712e488d65fc8a2" class="i field">_client</a> = <span class="r2 r">client</span>;
            <a href="#0908951f4ac0b91e" class="i field">_keyId</a> = <span class="r3 r">keyId</span>;
            <a href="#c84403d1edf8ed09" class="i field">_randomNumberGenerator</a> = <span class="r4 r">randomNumberGenerator</span>;
        }
 
        <b>public</b> <span class="i">EncryptedXmlInfo</span> <a id="0178fd9648bcbcb7" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Encrypt</a>(<span class="i">XElement</span> <span id="r5 rd" class="r5 r">plaintextElement</span>)
        {
            <b>return</b> <span class="i">Task</span>.<span class="i">Run</span>(() =&gt; <a href="#a874035784c7b504" class="i method">EncryptAsync</a>(<span class="r5 r">plaintextElement</span>)).<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>();
        }
 
        <b>private async</b> <span class="i">Task</span>&lt;<span class="i">EncryptedXmlInfo</span>&gt; <a id="a874035784c7b504" href="R/a874035784c7b504.html" target="n" data-glyph="76,1" class="i method">EncryptAsync</a>(<span class="i">XElement</span> <span id="r6 rd" class="r6 r">plaintextElement</span>)
        {
            <b>byte</b>[] <span id="r7 rd" class="r7 r">value</span>;
            <b>using</b> (<b>var</b> <span id="r8 rd" class="r8 r">memoryStream</span> = <b>new</b> <span class="i">MemoryStream</span>())
            {
                <span class="r6 r">plaintextElement</span>.<span class="i">Save</span>(<span class="r8 r">memoryStream</span>, <span class="i">SaveOptions</span>.<span class="i">DisableFormatting</span>);
                <span class="r7 r">value</span> = <span class="r8 r">memoryStream</span>.<span class="i">ToArray</span>();
            }
 
            <b>using</b> (<b>var</b> <span id="r9 rd" class="r9 r">symmetricAlgorithm</span> = <span class="i">DefaultSymmetricAlgorithmFactory</span>())
            {
                <b>var</b> <span id="r10 rd" class="r10 r">symmetricBlockSize</span> = <span class="r9 r">symmetricAlgorithm</span>.<span class="i">BlockSize</span> / 8;
                <b>var</b> <span id="r11 rd" class="r11 r">symmetricKey</span> = <b>new</b> <b>byte</b>[<span class="r10 r">symmetricBlockSize</span>];
                <b>var</b> <span id="r12 rd" class="r12 r">symmetricIV</span> = <b>new</b> <b>byte</b>[<span class="r10 r">symmetricBlockSize</span>];
                <a href="#c84403d1edf8ed09" class="i field">_randomNumberGenerator</a>.<span class="i">GetBytes</span>(<span class="r11 r">symmetricKey</span>);
                <a href="#c84403d1edf8ed09" class="i field">_randomNumberGenerator</a>.<span class="i">GetBytes</span>(<span class="r12 r">symmetricIV</span>);
 
                <b>byte</b>[] <span id="r13 rd" class="r13 r">encryptedValue</span>;
                <b>using</b> (<b>var</b> <span id="r14 rd" class="r14 r">encryptor</span> = <span class="r9 r">symmetricAlgorithm</span>.<span class="i">CreateEncryptor</span>(<span class="r11 r">symmetricKey</span>, <span class="r12 r">symmetricIV</span>))
                {
                    <span class="r13 r">encryptedValue</span> = <span class="r14 r">encryptor</span>.<span class="i">TransformFinalBlock</span>(<span class="r7 r">value</span>, 0, <span class="r7 r">value</span>.<span class="i">Length</span>);
                }
 
                <b>var</b> <span id="r15 rd" class="r15 r">key</span> = <b>await</b> <a href="#7712e488d65fc8a2" class="i field">_client</a>.<span class="i">ResolveAsync</span>(<a href="#0908951f4ac0b91e" class="i field">_keyId</a>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                <b>var</b> <span id="r16 rd" class="r16 r">wrappedKey</span> = <b>await</b> <span class="r15 r">key</span>.<span class="i">WrapKeyAsync</span>(<a href="#2e57a5d3d8a18008" class="i field">DefaultKeyEncryption</a>, <span class="r11 r">symmetricKey</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                <b>var</b> <span id="r17 rd" class="r17 r">element</span> = <b>new</b> <span class="i">XElement</span>(<span class="s">&quot;encryptedKey&quot;</span>,
                    <b>new</b> <span class="i">XComment</span>(<span class="s">&quot; This key is encrypted with Azure Key Vault. &quot;</span>),
                    <b>new</b> <span class="i">XElement</span>(<span class="s">&quot;kid&quot;</span>, <span class="r15 r">key</span>.<span class="i">KeyId</span>),
                    <b>new</b> <span class="i">XElement</span>(<span class="s">&quot;key&quot;</span>, <span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r16 r">wrappedKey</span>)),
                    <b>new</b> <span class="i">XElement</span>(<span class="s">&quot;iv&quot;</span>, <span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r12 r">symmetricIV</span>)),
                    <b>new</b> <span class="i">XElement</span>(<span class="s">&quot;value&quot;</span>, <span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r13 r">encryptedValue</span>)));
 
                <b>return</b> <b>new</b> <span class="i">EncryptedXmlInfo</span>(<span class="r17 r">element</span>, <b>typeof</b>(<a href="AzureKeyVaultXmlDecryptor.cs.html#1d50bcdcd559e68f" class="t t">AzureKeyVaultXmlDecryptor</a>));
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
