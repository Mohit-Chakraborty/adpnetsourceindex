<!DOCTYPE html>
<html><head><title>AADClientHelper.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(349);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Management.Intune.Tests/Helpers/AADClientHelper.cs" target="_top">Helpers\AADClientHelper.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Management.Intune.Tests" target="_top">Intune.Tests\Intune.Tests.csproj</a> (Microsoft.Azure.Management.Intune.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">Intune</span>.<span class="i n">Tests</span>.<span class="i n">Helpers</span>
{
    <b>using</b> <span class="i">System</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">IO</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Linq</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Net</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Net</span>.<span class="i">Http</span>.<span class="i">Headers</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i">IdentityModel</span>.<span class="i">Clients</span>.<span class="i">ActiveDirectory</span>;
    <b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>;    
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Types of environment in Intune</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public enum</b> <a id="b9704e54e91ff6ea" href="../R/b9704e54e91ff6ea.html" target="n" data-glyph="18,0" class="t t"><span id="8702d251be01a2c3">EnvironmentType</span></a>
    {
        <a id="bcb4d221c0e6de63" href="../R/bcb4d221c0e6de63.html" target="n" data-glyph="24,1" class="i field">OneBox</a>,
        <a id="a0ffa49861de1aff" href="../R/a0ffa49861de1aff.html" target="n" data-glyph="24,1" class="i field">Dogfood</a>,
        <a id="d7788e01d616d167" href="../R/d7788e01d616d167.html" target="n" data-glyph="24,1" class="i field">CTIP</a>,
        <a id="1c6a9baf847298b4" href="../R/1c6a9baf847298b4.html" target="n" data-glyph="24,1" class="i field">Prod</a>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Azure Active directory related operations helper class.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="0e15bf29a6fce6e9" href="../R/0e15bf29a6fce6e9.html" target="n" data-glyph="0,0" class="t t">AADClientHelper</a>
    {
        <b>public const string</b> <a id="56b794ecd15a1f5a" href="../R/56b794ecd15a1f5a.html" target="n" data-glyph="6,1" class="i field">AadAuthDogfoodEnpoint</a> = <span class="s">&quot;https://login.windows-ppe.net/&quot;</span>;
 
        <b>public const string</b> <a id="cd2b5f8dc6103227" href="../R/cd2b5f8dc6103227.html" target="n" data-glyph="6,1" class="i field">AadAuthProductionEnpoint</a> = <span class="s">&quot;https://login.microsoftonline.com/&quot;</span>;
 
        <b>public const string</b> <a id="c4b96b1ff1fb6ee3" href="../R/c4b96b1ff1fb6ee3.html" target="n" data-glyph="6,1" class="i field">AadGraphDogfoodEnpoint</a> = <span class="s">&quot;https://graph.ppe.windows.net/&quot;</span>;
 
        <b>public const string</b> <a id="54b2f534400a9eeb" href="../R/54b2f534400a9eeb.html" target="n" data-glyph="6,1" class="i field">AadGraphProductionEnpoint</a> = <span class="s">&quot;https://graph.windows.net/&quot;</span>;
 
        <b>public const string</b> <a id="64bc74dda6281cc2" href="../R/64bc74dda6281cc2.html" target="n" data-glyph="6,1" class="i field">ARMClientIdForUserAuth</a> = <a href="../../GuidAssembly/R/1950a258-227b-4e31-a9cf-717495945fc2.html" target="n" class="s">&quot;1950a258-227b-4e31-a9cf-717495945fc2&quot;</a>;
 
        <b>public const string</b> <a id="ee3112b9b0d34cae" href="../R/ee3112b9b0d34cae.html" target="n" data-glyph="6,1" class="i field">ARMResourceUrl</a> = <span class="s">&quot;https://management.azure.com/&quot;</span>;
 
        <b>private string</b> <a id="07fa816fc14fb405" href="../R/07fa816fc14fb405.html" target="n" data-glyph="46,1" class="i field">userName</a>;
        <b>private string</b> <a id="d3e59cc5285ab393" href="../R/d3e59cc5285ab393.html" target="n" data-glyph="46,1" class="i field">password</a>;
        <b>private string</b> <a id="ae8ef8e984086f13" href="../R/ae8ef8e984086f13.html" target="n" data-glyph="46,1" class="i field">tenantName</a>;
        <b>private</b> <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a> <a id="051625496e27b349" href="../R/051625496e27b349.html" target="n" data-glyph="46,1" class="i field">environment</a>;
        <b>private string</b> <a id="035f29e4070d0bba" href="../R/035f29e4070d0bba.html" target="n" data-glyph="46,1" class="i field">novaSessionId</a>;
        <b>private</b> <span class="i">UserCredential</span> <a id="be35a72462e3aea6" href="../R/be35a72462e3aea6.html" target="n" data-glyph="46,1" class="i field">userCredential</a>;
        <b>private string</b> <a id="0d1365344f8ac3a8" href="../R/0d1365344f8ac3a8.html" target="n" data-glyph="46,1" class="i field">authEndpoint</a>;
        <b>private string</b> <a id="b0209123208c74a9" href="../R/b0209123208c74a9.html" target="n" data-glyph="46,1" class="i field">graphEndpoint</a>;
        <b>private string</b> <a id="10a6b9902ae10598" href="../R/10a6b9902ae10598.html" target="n" data-glyph="46,1" class="i field">aadTokenForArm</a>;
        <b>private</b> <span class="i">DateTimeOffset</span> <a id="bdb1c4fc2db3d950" href="../R/bdb1c4fc2db3d950.html" target="n" data-glyph="46,1" class="i field">nextTokenRenewal</a>;
 
        <b>public string</b> <a id="f4f1d35919c1a017" href="../R/f4f1d35919c1a017.html" target="n" data-glyph="102,1" class="i property">TenantId</a> { <b>get</b>; <b>private set</b>; }
 
        <b>public string</b> <a id="55c95a914cae7435" href="../R/55c95a914cae7435.html" target="n" data-glyph="102,1" class="i property">UserId</a> { <b>get</b>; <b>private set</b>; }
 
        <b>public string</b> <a id="696063890b2e7f75" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">AADTokenForARM</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#10a6b9902ae10598" class="i field">aadTokenForArm</a> == <b>null</b> || <span class="i">DateTime</span>.<span class="i">UtcNow</span>.<span class="i">AddMinutes</span>(3) &gt; <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#bdb1c4fc2db3d950" class="i field">nextTokenRenewal</a>)
                {
                    <span class="i">AuthenticationResult</span> <span id="r0 rd" class="r0 r">authActionResult</span> = <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#429e35f790a31453" class="i method">AuthenticateUser</a>(<a href="#ee3112b9b0d34cae" class="i field">ARMResourceUrl</a>);
                    <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#10a6b9902ae10598" class="i field">aadTokenForArm</a> = <span class="r0 r">authActionResult</span>.<span class="i">AccessToken</span>;
                    <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#bdb1c4fc2db3d950" class="i field">nextTokenRenewal</a> = <span class="r0 r">authActionResult</span>.<span class="i">ExpiresOn</span>;
                }
 
                <b>return</b> <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#10a6b9902ae10598" class="i field">aadTokenForArm</a>;
            }
 
            <b>private set</b>
            {
                <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#10a6b9902ae10598" class="i field">aadTokenForArm</a> = <b>value</b>;
            }
        }
 
        <b>public</b> <a id="f7fa00112bf25c8c" href="../R/f7fa00112bf25c8c.html" target="n" data-glyph="72,1" class="t constructor">AADClientHelper</a>()
        {
            <b>var</b> <span id="r1 rd" class="r1 r">orgIdAuth</span> = <span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<span class="s">&quot;TEST_CSM_ORGID_AUTHENTICATION&quot;</span>);
            <b>var</b> <span id="r2 rd" class="r2 r">parts</span> = <span class="r1 r">orgIdAuth</span>.<span class="i">Split</span>(<b>new</b> <b>char</b>[] { <span class="s">&#39;;&#39;</span> }).<span class="i">ToList</span>();
            <b>var</b> <span id="r3 rd" class="r3 r">authParams</span> = <b>new</b> <span class="i">Dictionary</span>&lt;<b>string</b>, <b>string</b>&gt;();
            <span class="r2 r">parts</span>.<span class="i">ForEach</span>(<span id="r4 rd" class="r4 r">a</span> =&gt; { <b>var</b> <span id="r5 rd" class="r5 r">splitVal</span> = <span class="r4 r">a</span>.<span class="i">Split</span>(<b>new</b> <b>char</b>[] { <span class="s">&#39;=&#39;</span> }); <span class="r3 r">authParams</span>.<span class="i">Add</span>(<span class="r5 r">splitVal</span>[0], <span class="r5 r">splitVal</span>[1]); });
            <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a> <span id="r6 rd" class="r6 r">enType</span> = <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#a0ffa49861de1aff" class="i field">Dogfood</a>;
            <b>if</b> (<span class="r3 r">authParams</span>[<span class="s">&quot;Environment&quot;</span>] == <span class="s">&quot;Dogfood&quot;</span>)
            {
                <span class="r6 r">enType</span> = <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#a0ffa49861de1aff" class="i field">Dogfood</a>;
            }
            <b>else</b> <b>if</b> (<span class="r3 r">authParams</span>[<span class="s">&quot;Environment&quot;</span>] == <span class="s">&quot;Prod&quot;</span>)
            {
                <span class="r6 r">enType</span> = <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#1c6a9baf847298b4" class="i field">Prod</a>;
            }
 
            <span class="i">InitializeAADClient</span>(<span class="r3 r">authParams</span>[<span class="s">&quot;UserId&quot;</span>], <span class="r3 r">authParams</span>[<span class="s">&quot;Password&quot;</span>], <span class="r6 r">enType</span>);
        }
        <b>private void</b> <a id="a4e71c81493204b4" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">InitializeAADClient</a>(<b>string</b> <span id="r7 rd" class="r7 r">userName</span>, <b>string</b> <span id="r8 rd" class="r8 r">password</span>, <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a> <span id="r9 rd" class="r9 r">env</span>)
        {
            <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#07fa816fc14fb405" class="i field">userName</a> = <span class="r7 r">userName</span>;
            <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#d3e59cc5285ab393" class="i field">password</a> = <span class="r8 r">password</span>;
            <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#051625496e27b349" class="i field">environment</a> = <span class="r9 r">env</span>;
            <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#ae8ef8e984086f13" class="i field">tenantName</a> = <span class="r7 r">userName</span>.<span class="i">Split</span>(<b>new</b> <b>char</b>[] { <span class="s">&#39;@&#39;</span> })[1];
            <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#be35a72462e3aea6" class="i field">userCredential</a> = <b>new</b> <span class="i">UserCredential</span>(<a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#07fa816fc14fb405" class="i field">userName</a>, <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#d3e59cc5285ab393" class="i field">password</a>);
 
            <b>if</b> (<span class="r9 r">env</span> == <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#bcb4d221c0e6de63" class="i field">OneBox</a>)
            {
                <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#035f29e4070d0bba" class="i field">novaSessionId</a> = <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#66ba3f88fd288f17" class="i method">GetNovaSessionId</a>();
            }
 
            <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#0d1365344f8ac3a8" class="i field">authEndpoint</a> = <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#e4a6e46e0db151ad" class="i method">GetAadAuthEndpoint</a>();
            <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#b0209123208c74a9" class="i field">graphEndpoint</a> = <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#67d34421606a31b8" class="i method">GetAadGraphEndpoint</a>();
 
            <span class="c">// we don&#39;t need aad token for ARM in one box.</span>
            <b>if</b> (<span class="r9 r">env</span> != <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#bcb4d221c0e6de63" class="i field">OneBox</a>)
            {
                <span class="i">AuthenticationResult</span> <span id="r10 rd" class="r10 r">authActionResult</span> = <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#429e35f790a31453" class="i method">AuthenticateUser</a>(<a href="#ee3112b9b0d34cae" class="i field">ARMResourceUrl</a>);
                <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#10a6b9902ae10598" class="i field">aadTokenForArm</a> = <span class="r10 r">authActionResult</span>.<span class="i">AccessToken</span>;
                <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#bdb1c4fc2db3d950" class="i field">nextTokenRenewal</a> = <span class="r10 r">authActionResult</span>.<span class="i">ExpiresOn</span>;
                <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#f4f1d35919c1a017" class="i property">TenantId</a> = <span class="r10 r">authActionResult</span>.<span class="i">TenantId</span>;
                <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#55c95a914cae7435" class="i property">UserId</a> = <span class="r10 r">authActionResult</span>.<span class="i">UserInfo</span>.<span class="i">UniqueId</span>;
            }
        }
 
        <b>private string</b> <a id="66ba3f88fd288f17" href="../R/66ba3f88fd288f17.html" target="n" data-glyph="76,1" class="i method">GetNovaSessionId</a>()
        {
            <span class="c">// ItPro.20.msods.msol-nova.com</span>
            <b>var</b> <span id="r11 rd" class="r11 r">segments</span> = <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#ae8ef8e984086f13" class="i field">tenantName</a>.<span class="i">Split</span>(<b>new</b> <b>char</b>[] { <span class="s">&#39;.&#39;</span> });
            <b>if</b> (<span class="r11 r">segments</span>.<span class="i">Length</span> == 5)
            {
                <b>return</b> <span class="r11 r">segments</span>[1];
            }
            <b>else</b>
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<span class="s">&quot;Given oneBox tenant doesn&#39;t have Nova tenant pattern.&quot;</span>);
            }
        }
 
        <b>private string</b> <a id="e4a6e46e0db151ad" href="../R/e4a6e46e0db151ad.html" target="n" data-glyph="76,1" class="i method">GetAadAuthEndpoint</a>()
        {
            <b>string</b> <span id="r12 rd" class="r12 r">baseEndpoint</span> = <b>string</b>.<span class="i">Empty</span>;
 
            <b>switch</b> (<a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#051625496e27b349" class="i field">environment</a>)
            {
                <b>case</b> <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#a0ffa49861de1aff" class="i field">Dogfood</a>:
                    {
                        <span class="r12 r">baseEndpoint</span> = <a href="#56b794ecd15a1f5a" class="i field">AadAuthDogfoodEnpoint</a>;
                        <b>break</b>;
                    }
                <b>case</b> <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#d7788e01d616d167" class="i field">CTIP</a>:
                <b>case</b> <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#1c6a9baf847298b4" class="i field">Prod</a>:
                    {
                        <span class="r12 r">baseEndpoint</span> = <a href="#cd2b5f8dc6103227" class="i field">AadAuthProductionEnpoint</a>;
                        <b>break</b>;
                    }
                <b>case</b> <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#bcb4d221c0e6de63" class="i field">OneBox</a>:
                    {
                        <span class="r12 r">baseEndpoint</span> = <b>string</b>.<span class="i">Format</span>(<span class="s">&quot;https://{0}.ests.msol-nova.com/&quot;</span>, <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#035f29e4070d0bba" class="i field">novaSessionId</a>);
                        <b>break</b>;
                    }
                <b>default</b>:
                    {
                        <b>throw</b> <b>new</b> <span class="i">Exception</span>(<span class="s">&quot;No supported AAD Auth endpoint for Environment:&quot;</span> + <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#051625496e27b349" class="i field">environment</a>);
                    }
            }
 
            <b>return</b> <span class="r12 r">baseEndpoint</span> + <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#ae8ef8e984086f13" class="i field">tenantName</a>;
        }
 
        <b>private string</b> <a id="67d34421606a31b8" href="../R/67d34421606a31b8.html" target="n" data-glyph="76,1" class="i method">GetAadGraphEndpoint</a>()
        {
            <b>string</b> <span id="r13 rd" class="r13 r">endpoint</span>;
 
            <b>switch</b> (<a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#051625496e27b349" class="i field">environment</a>)
            {
                <b>case</b> <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#a0ffa49861de1aff" class="i field">Dogfood</a>:
                    {
                        <span class="r13 r">endpoint</span> = <a href="#c4b96b1ff1fb6ee3" class="i field">AadGraphDogfoodEnpoint</a>;
                        <b>break</b>;
                    }
                <b>case</b> <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#d7788e01d616d167" class="i field">CTIP</a>:
                <b>case</b> <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#1c6a9baf847298b4" class="i field">Prod</a>:
                    {
                        <span class="r13 r">endpoint</span> = <a href="#54b2f534400a9eeb" class="i field">AadGraphProductionEnpoint</a>;
                        <b>break</b>;
                    }
                <b>case</b> <a href="#b9704e54e91ff6ea" class="t t">EnvironmentType</a>.<a href="#bcb4d221c0e6de63" class="i field">OneBox</a>:
                    {
                        <span class="r13 r">endpoint</span> = <b>string</b>.<span class="i">Format</span>(<span class="s">&quot;https://graph.{0}.msods.msol-nova.com/&quot;</span>, <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#035f29e4070d0bba" class="i field">novaSessionId</a>);
                        <b>break</b>;
                    }
                <b>default</b>:
                    {
                        <b>throw</b> <b>new</b> <span class="i">Exception</span>(<span class="s">&quot;No supported AAD Graph endpoint for Environment:&quot;</span> + <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#051625496e27b349" class="i field">environment</a>);
                    }
            }
 
            <b>return</b> <span class="r13 r">endpoint</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get Token for User Async.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Token for user.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private async</b> <span class="i">Task</span>&lt;<b>string</b>&gt; <a id="7d39f30fe36ebdf8" href="../R/7d39f30fe36ebdf8.html" target="n" data-glyph="76,1" class="i method">GetAccessTokenForUserAsync</a>(<b>string</b> <span id="r14 rd" class="r14 r">targetResource</span>)
        {
            <b>var</b> <span id="r15 rd" class="r15 r">authenticationContext</span> = <b>new</b> <span class="i">AuthenticationContext</span>(<a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#0d1365344f8ac3a8" class="i field">authEndpoint</a>, <b>false</b>);
 
            <b>var</b> <span id="r16 rd" class="r16 r">authResult</span> = <b>await</b> <span class="r15 r">authenticationContext</span>.<span class="i">AcquireTokenAsync</span>(
                <span class="r14 r">targetResource</span>,
                <a href="#64bc74dda6281cc2" class="i field">ARMClientIdForUserAuth</a>,
                <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#be35a72462e3aea6" class="i field">userCredential</a>);
 
            <b>return</b> <span class="r16 r">authResult</span>.<span class="i">AccessToken</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get Token for User.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Token for user.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <span class="i">AuthenticationResult</span> <a id="429e35f790a31453" href="../R/429e35f790a31453.html" target="n" data-glyph="76,1" class="i method">AuthenticateUser</a>(<b>string</b> <span id="r17 rd" class="r17 r">targetResourceUrl</span>)
        {
            <b>var</b> <span id="r18 rd" class="r18 r">authenticationContext</span> = <b>new</b> <span class="i">AuthenticationContext</span>(<a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#0d1365344f8ac3a8" class="i field">authEndpoint</a>, <b>false</b>);
 
            <b>return</b> <span class="r18 r">authenticationContext</span>.<span class="i">AcquireToken</span>(
                <span class="r17 r">targetResourceUrl</span>,
                <a href="#64bc74dda6281cc2" class="i field">ARMClientIdForUserAuth</a>,
                <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#be35a72462e3aea6" class="i field">userCredential</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the UserGroups from AAD Graph.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">List with Group Ids and DisplayNames</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public async</b> <span class="i">Task</span>&lt;<span class="i">List</span>&lt;<span class="i">Dictionary</span>&lt;<b>string</b>, <b>string</b>&gt;&gt;&gt; <a id="568c09bb515ebfe5" href="../R/568c09bb515ebfe5.html" target="n" data-glyph="72,1" class="i method">GetUserGroups</a>()
        {
            <b>return</b> <b>await</b> <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#54aa1540c00a9b9f" class="i method">GetUserGroups</a>(<b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the UserGroups from AAD Graph.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">List with Group Ids and DisplayNames</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public async</b> <span class="i">Task</span>&lt;<span class="i">List</span>&lt;<span class="i">Dictionary</span>&lt;<b>string</b>, <b>string</b>&gt;&gt;&gt; <a id="54aa1540c00a9b9f" href="../R/54aa1540c00a9b9f.html" target="n" data-glyph="72,1" class="i method">GetUserGroups</a>(<b>bool</b> <span id="r19 rd" class="r19 r">getAll</span>)
        {
            <b>string</b> <span id="r20 rd" class="r20 r">responseContent</span>;
            <a href="#00e6b5451f8f7592" class="t t">ODataResponse</a> <span id="r21 rd" class="r21 r">odataResponse</span>;
            <span class="i">List</span>&lt;<span class="i">Dictionary</span>&lt;<b>string</b>, <b>string</b>&gt;&gt; <span id="r22 rd" class="r22 r">groupList</span> = <b>new</b> <span class="i">List</span>&lt;<span class="i">Dictionary</span>&lt;<b>string</b>, <b>string</b>&gt;&gt;();
            <b>string</b> <span id="r23 rd" class="r23 r">graphServicePricipalId</span> = <a href="../../GuidAssembly/R/00000002-0000-0000-c000-000000000000.html" target="n" class="s">&quot;00000002-0000-0000-c000-000000000000&quot;</a>;
            <b>string</b> <span id="r24 rd" class="r24 r">accessToken</span> = <b>await</b> <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#7d39f30fe36ebdf8" class="i method">GetAccessTokenForUserAsync</a>(<span class="r23 r">graphServicePricipalId</span>);
            <b>string</b> <span id="r25 rd" class="r25 r">skipToken</span> = <b>string</b>.<span class="i">Empty</span>;
 
            <b>do</b>
            {
                <span class="r20 r">responseContent</span> = <b>await</b> <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#0f8df13bf07433c6" class="i method">ExecuteGraphRequest</a>(<span class="r24 r">accessToken</span>, <span class="r25 r">skipToken</span>);
 
                <span class="r21 r">odataResponse</span> = <span class="i">JsonConvert</span>.<span class="i">DeserializeObject</span>&lt;<a href="#00e6b5451f8f7592" class="t t">ODataResponse</a>&gt;(<span class="r20 r">responseContent</span>);
 
                <b>foreach</b> (<b>var</b> <span id="r26 rd" class="r26 r">group</span> <b>in</b> <span class="r21 r">odataResponse</span>.<a href="#9d165e13697410ed" class="i property">Value</a>.<span class="i">Where</span>(<span id="r27 rd" class="r27 r">x</span> =&gt; <span class="r27 r">x</span>.<span class="i">SecurityEnabled</span>))
                {
                    <span class="i">Dictionary</span>&lt;<b>string</b>, <b>string</b>&gt; <span id="r28 rd" class="r28 r">dict</span> = <b>new</b> <span class="i">Dictionary</span>&lt;<b>string</b>, <b>string</b>&gt;();
                    <span class="r28 r">dict</span>.<span class="i">Add</span>(<span class="s">&quot;DisplayName&quot;</span>, <span class="r26 r">group</span>.<span class="i">DisplayName</span>);
                    <span class="r28 r">dict</span>.<span class="i">Add</span>(<span class="s">&quot;ID&quot;</span>, <span class="r26 r">group</span>.<span class="i">ObjectId</span>);
                    <span class="r22 r">groupList</span>.<span class="i">Add</span>(<span class="r28 r">dict</span>);
                }
 
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r21 r">odataResponse</span>.<a href="#f4e8dc5edf52f03e" class="i property">NextLink</a>))
                {
                    <span class="r25 r">skipToken</span> = <span class="r21 r">odataResponse</span>.<a href="#f4e8dc5edf52f03e" class="i property">NextLink</a>.<span class="i">Substring</span>(<span class="r21 r">odataResponse</span>.<a href="#f4e8dc5edf52f03e" class="i property">NextLink</a>.<span class="i">IndexOf</span>(<span class="s">&quot;?&quot;</span>) + 1);
                }
                <b>else</b>
                {
                    <span class="r25 r">skipToken</span> = <b>string</b>.<span class="i">Empty</span>;
                }
            }
            <b>while</b> (<span class="r19 r">getAll</span> &amp;&amp; !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r25 r">skipToken</span>));
 
            <b>return</b> <span class="r22 r">groupList</span>;
        }
 
        <b>private async</b> <span class="i">Task</span>&lt;<b>string</b>&gt; <a id="0f8df13bf07433c6" href="../R/0f8df13bf07433c6.html" target="n" data-glyph="76,1" class="i method">ExecuteGraphRequest</a>(<b>string</b> <span id="r29 rd" class="r29 r">token</span>, <b>string</b> <span id="r30 rd" class="r30 r">skipToken</span> = <b>null</b>)
        {
            <b>string</b> <span id="r31 rd" class="r31 r">responseContent</span>;
            <b>string</b> <span id="r32 rd" class="r32 r">noSkipTokenFormatString</span> = <span class="s">&quot;{0}{1}/groups?api-version=1.6&quot;</span>;
            <b>string</b> <span id="r33 rd" class="r33 r">withSkipTokenformatString</span> = <span class="s">&quot;{0}{1}/groups?api-version=1.6&amp;{2}&quot;</span>;
            <span class="i">HttpWebRequest</span> <span id="r34 rd" class="r34 r">request</span>;
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r30 r">skipToken</span>))
            {
                <span class="r34 r">request</span> = <span class="i">WebRequest</span>.<span class="i">Create</span>(<b>string</b>.<span class="i">Format</span>(<span class="r32 r">noSkipTokenFormatString</span>, <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#b0209123208c74a9" class="i field">graphEndpoint</a>, <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#ae8ef8e984086f13" class="i field">tenantName</a>)) <b>as</b> <span class="i">HttpWebRequest</span>;
            }
            <b>else</b>
            {
                <span class="r34 r">request</span> = <span class="i">WebRequest</span>.<span class="i">Create</span>(<b>string</b>.<span class="i">Format</span>(<span class="r33 r">withSkipTokenformatString</span>, <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#b0209123208c74a9" class="i field">graphEndpoint</a>, <a href="#0e15bf29a6fce6e9" class="k">this</a>.<a href="#ae8ef8e984086f13" class="i field">tenantName</a>, <span class="r30 r">skipToken</span>)) <b>as</b> <span class="i">HttpWebRequest</span>;
            }
            <span class="r34 r">request</span>.<span class="i">Accept</span> = <span class="s">&quot;application/json;&quot;</span>;
            <span class="r34 r">request</span>.<span class="i">Headers</span>.<span class="i">Add</span>(<span class="i">HttpRequestHeader</span>.<span class="i">Authorization</span>, (<b>new</b> <span class="i">AuthenticationHeaderValue</span>(<span class="s">&quot;Bearer&quot;</span>, <span class="r29 r">token</span>)).<span class="i">ToString</span>());
 
            <span class="i">WebResponse</span> <span id="r35 rd" class="r35 r">response</span> = <b>await</b> <span class="r34 r">request</span>.<span class="i">GetResponseAsync</span>();
            <b>using</b> (<span class="i">StreamReader</span> <span id="r36 rd" class="r36 r">streamReader</span> = <b>new</b> <span class="i">StreamReader</span>(<span class="r35 r">response</span>.<span class="i">GetResponseStream</span>()))
            {
                <span class="r31 r">responseContent</span> = <b>await</b> <span class="r36 r">streamReader</span>.<span class="i">ReadToEndAsync</span>();
            }
 
            <b>return</b> <span class="r31 r">responseContent</span>;
        }
    }
 
    <b>internal class</b> <a id="d83ca50b079e8751" href="../R/d83ca50b079e8751.html" target="n" data-glyph="2,0" class="t t">UserGroup</a>
    {
        [<span class="i">JsonProperty</span>(<span class="s">&quot;objectId&quot;</span>)]
        <b>public string</b> <a id="c08906c1f2da4461" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">ObjectId</a> { <b>get</b>; <b>set</b>; }
 
        [<span class="i">JsonProperty</span>(<span class="s">&quot;displayName&quot;</span>, <span class="i">Required</span> = <span class="i">Required</span>.<span class="i">Always</span>)]
        <b>public string</b> <a id="54c0739f250f78ed" href="../R/54c0739f250f78ed.html" target="n" data-glyph="102,1" class="i property">DisplayName</a> { <b>get</b>; <b>set</b>; }
 
        [<span class="i">JsonProperty</span>(<span class="s">&quot;securityEnabled&quot;</span>, <span class="i">Required</span> = <span class="i">Required</span>.<span class="i">Always</span>)]
        <b>public bool</b> <a id="f55b1cb2c1a1fe36" href="../R/f55b1cb2c1a1fe36.html" target="n" data-glyph="102,1" class="i property">SecurityEnabled</a> { <b>get</b>; <b>set</b>; }
 
        [<span class="i">JsonProperty</span>(<span class="s">&quot;description&quot;</span>)]
        <b>public string</b> <a id="18bc910bb7961a15" href="../R/18bc910bb7961a15.html" target="n" data-glyph="102,1" class="i property">Description</a> { <b>get</b>; <b>set</b>; }
 
        [<span class="i">JsonProperty</span>(<span class="s">&quot;mailNickname&quot;</span>)]
        <b>public string</b> <a id="094dc68859ff72f2" href="../R/094dc68859ff72f2.html" target="n" data-glyph="102,1" class="i property">MailNickname</a> { <b>get</b>; <b>set</b>; }
 
        [<span class="i">JsonProperty</span>(<span class="s">&quot;mailEnabled&quot;</span>)]
        <b>public bool</b> <a id="f7550dc0d39346c4" href="../R/f7550dc0d39346c4.html" target="n" data-glyph="102,1" class="i property">MailEnabled</a> { <b>get</b>; <b>set</b>; }
 
        <b>public</b> <a id="086871a6dc716d1b" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">UserGroup</a>(<b>string</b> <span id="r37 rd" class="r37 r">groupName</span>)
        {
            <a href="#d83ca50b079e8751" class="k">this</a>.<a href="#18bc910bb7961a15" class="i property">Description</a> = <span class="r37 r">groupName</span>;
            <a href="#d83ca50b079e8751" class="k">this</a>.<a href="#54c0739f250f78ed" class="i property">DisplayName</a> = <span class="r37 r">groupName</span>;
            <a href="#d83ca50b079e8751" class="k">this</a>.<a href="#f7550dc0d39346c4" class="i property">MailEnabled</a> = <b>true</b>;
            <a href="#d83ca50b079e8751" class="k">this</a>.<a href="#f55b1cb2c1a1fe36" class="i property">SecurityEnabled</a> = <b>true</b>;
            <a href="#d83ca50b079e8751" class="k">this</a>.<a href="#094dc68859ff72f2" class="i property">MailNickname</a> = <span class="r37 r">groupName</span>;
        }
    }
 
    <b>internal class</b> <a id="00e6b5451f8f7592" href="../R/00e6b5451f8f7592.html" target="n" data-glyph="2,0" class="t t"><span id="671b269da791adb6">ODataResponse</span></a>
    {
        [<span class="i">JsonProperty</span>(<span class="s">&quot;odata.metadata&quot;</span>)]
        <b>public string</b> <a id="7702bda7cb6097f5" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Metadata</a> { <b>get</b>; <b>set</b>; }
 
        [<span class="i">JsonProperty</span>(<span class="s">&quot;odata.nextlink&quot;</span>)]
        <b>public string</b> <a id="f4e8dc5edf52f03e" href="../R/f4e8dc5edf52f03e.html" target="n" data-glyph="102,1" class="i property">NextLink</a> { <b>get</b>; <b>set</b>; }
 
        <b>public</b> <span class="i">List</span>&lt;<a href="#d83ca50b079e8751" class="t t">UserGroup</a>&gt; <a id="9d165e13697410ed" href="../R/9d165e13697410ed.html" target="n" data-glyph="102,1" class="i property">Value</a> { <b>get</b>; <b>set</b>; }
    }
}
</pre></td></tr></table></div></body></html>
