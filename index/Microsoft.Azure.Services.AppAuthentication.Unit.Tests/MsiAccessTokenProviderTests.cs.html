<!DOCTYPE html>
<html><head><title>MsiAccessTokenProviderTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(376);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Services.AppAuthentication.Unit.Tests/MsiAccessTokenProviderTests.cs" target="_top">MsiAccessTokenProviderTests.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/master//sdk/mgmtcommon/AppAuthentication/Azure.Services.AppAuthentication.Unit.Tests/MsiAccessTokenProviderTests.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Services.AppAuthentication.Unit.Tests" target="_top">Microsoft.Azure.Services.AppAuthentication.Unit.Tests.csproj</a> (Microsoft.Azure.Services.AppAuthentication.Unit.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Net</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Net</span>.<span class="i n">Http</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Services</span>.<span class="i n">AppAuthentication</span>.<span class="i n">TestCommon</span>;
<b>using</b> <span class="i n">Xunit</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Services</span>.<span class="i n">AppAuthentication</span>.<span class="i n">Unit</span>.<span class="i n">Tests</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Test cases for MsiAccessTokenProvider class. MsiAccessTokenProvider is an internal class.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="1f97e77ac01ba820" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="605eb437406d458a">MsiAccessTokenProviderTests</span></a> : <a href="@0@mscorlib/A.html#1f55292c3174123d" class="t t">IDisposable</a>
    {
        <b>public void</b> <a id="9debc792b79cfd85" href="R/9debc792b79cfd85.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <span class="c">// Delete the environment variables</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <b>null</b>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <b>null</b>);
 
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#9e1c16b840e60ca9" class="i field">MsiServiceFabricEndpointEnv</a>, <b>null</b>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d7ff2b48ae1da01b" class="i field">MsiServiceFabricHeaderEnv</a>, <b>null</b>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#521122e1beefd718" class="i field">MsiServiceFabricThumbprintEnv</a>, <b>null</b>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#37a45fb556f37aac" class="i field">MsiServiceFabricApiVersionEnv</a>, <b>null</b>);
        }
 
        [<span class="t constructor">Theory</span>]
        [<span class="t constructor">InlineData</span>(<b>true</b>)]
        [<span class="t constructor">InlineData</span>(<b>false</b>)]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="90929b82a9a3945d" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTokenUsingManagedIdentityAzureVm</a>(<b>bool</b> <span id="r0 rd" class="r0 r">specifyUserAssignedManagedIdentity</span>)
        {
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r1 rd" class="r1 r">expectedAppId</span>;
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r2 rd" class="r2 r">managedIdentityArgument</span>;
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a> <span id="r3 rd" class="r3 r">msiTestType</span>;
 
            <span class="c">// Determine arguments and expected values based whether user-assigned managed identity is used</span>
            <b>if</b> (<span class="r0 r">specifyUserAssignedManagedIdentity</span>)
            {
                <span class="r2 r">managedIdentityArgument</span> = <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#f93cd6d1bd30210e" class="i field">TestUserAssignedManagedIdentityId</a>;
                <span class="r3 r">msiTestType</span> = <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#ed81752620c463f2" class="i field">MsiUserAssignedIdentityAzureVmSuccess</a>;
                <span class="r1 r">expectedAppId</span> = <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#f93cd6d1bd30210e" class="i field">TestUserAssignedManagedIdentityId</a>;
            }
            <b>else</b>
            {
                <span class="r2 r">managedIdentityArgument</span> = <b>null</b>;
                <span class="r3 r">msiTestType</span> = <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#a06f2410c87d01d9" class="i field">MsiAzureVmSuccess</a>;
                <span class="r1 r">expectedAppId</span> = <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#cd1270a9579cf0f4" class="i field">TestAppId</a>;
            }
 
            <span class="c">// MockMsi is being asked to act like response from Azure VM MSI succeeded.</span>
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r4 rd" class="r4 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<span class="r3 r">msiTestType</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r5 rd" class="r5 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r4 r">mockMsi</span>, <span class="r6 r">managedIdentityClientId</span>: <span class="r2 r">managedIdentityArgument</span>);
 
            <span class="c">// Get token.</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="k">var</a> <span id="r7 rd" class="r7 r">authResult</span> = <b>await</b> <span class="r5 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
            <span class="c">// Check if the principalused and type are as expected.</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r7 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#bac23240ee26a0c7" class="i property">AccessToken</a>, <span class="r5 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#675f5f5e0e11c4d7" class="i field">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#bd2c3b58b4413596" class="i field">AppType</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>, <span class="r1 r">expectedAppId</span>, <span class="r8 r">expiresOn</span>: <span class="r7 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0bd6af7f6ac59d37" class="i property">ExpiresOn</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If json parse error when aquiring token, an exception should be thrown.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="8e1330d35e02f8de" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ParseErrorMsiGetTokenTest</a>()
        {
            <span class="c">// MockMsi is being asked to act like response from Azure VM MSI suceeded.</span>
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r9 rd" class="r9 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#b3d6349c0b991550" class="i field">MsiAppJsonParseFailure</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r10 rd" class="r10 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r9 r">mockMsi</span>);
 
            <span class="c">// Ensure exception is thrown when getting the token</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r11 rd" class="r11 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <span class="r10 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#1f4f88aa6c6cf80e" class="i field">TokenResponseFormatExceptionMessage</a>, <span class="r11 r">exception</span>.<a href="@0@mscorlib/A.html#e2e19f4ed8da81aa" class="i method">ToString</a>());
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#10f05066567b134e" class="i field">JsonParseErrorException</a>, <span class="r11 r">exception</span>.<a href="@0@mscorlib/A.html#e2e19f4ed8da81aa" class="i method">ToString</a>());
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If MSI response if missing the token, an exception should be thrown.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="3c2f054b1b38991e" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">MsiResponseMissingTokenTest</a>()
        {
            <span class="c">// MockMsi is being asked to act like response from Azure VM MSI failed.</span>
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r12 rd" class="r12 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#eb789f2898a0d39e" class="i field">MsiMissingToken</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r13 rd" class="r13 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r12 r">mockMsi</span>);
 
            <span class="c">// Ensure exception is thrown when getting the token</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r14 rd" class="r14 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <span class="r13 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#74c51a6320d16d98" class="i field">GenericErrorMessage</a>, <span class="r14 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#075d845f31401c6f" class="i field">CannotBeNullError</a>, <span class="r14 r">exception</span>.<a href="@0@mscorlib/A.html#e2e19f4ed8da81aa" class="i method">ToString</a>());
        }
 
        [<span class="t constructor">Theory</span>]
        [<span class="t constructor">InlineData</span>(<b>true</b>)]
        [<span class="t constructor">InlineData</span>(<b>false</b>)]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="efc6c5522928a24b" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTokenUsingManagedIdentityAppServices</a>(<b>bool</b> <span id="r15 rd" class="r15 r">specifyUserAssignedManagedIdentity</span>)
        {
            <span class="c">// Setup the environment variables that App Service MSI would setup.</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#944a6a91e03153c9" class="i field">MsiEndpoint</a>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#87e40afca17f877b" class="i field">ClientSecret</a>);
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r16 rd" class="r16 r">expectedAppId</span>;
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r17 rd" class="r17 r">managedIdentityArgument</span>;
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a> <span id="r18 rd" class="r18 r">msiTestType</span>;
 
            <span class="c">// Determine arguments and expected values based whether user-assigned managed identity is used</span>
            <b>if</b> (<span class="r15 r">specifyUserAssignedManagedIdentity</span>)
            {
                <span class="r17 r">managedIdentityArgument</span> = <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#f93cd6d1bd30210e" class="i field">TestUserAssignedManagedIdentityId</a>;
                <span class="r18 r">msiTestType</span> = <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#60aafd31e8fa7270" class="i field">MsiUserAssignedIdentityAppServicesSuccess</a>;
                <span class="r16 r">expectedAppId</span> = <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#f93cd6d1bd30210e" class="i field">TestUserAssignedManagedIdentityId</a>;
            }
            <b>else</b>
            {
                <span class="r17 r">managedIdentityArgument</span> = <b>null</b>;
                <span class="r18 r">msiTestType</span> = <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#beaa2f4135c37722" class="i field">MsiAppServicesSuccess</a>;
                <span class="r16 r">expectedAppId</span> = <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#cd1270a9579cf0f4" class="i field">TestAppId</a>;
            }
 
            <span class="c">// MockMsi is being asked to act like response from App Service MSI suceeded.</span>
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r19 rd" class="r19 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<span class="r18 r">msiTestType</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r20 rd" class="r20 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r19 r">mockMsi</span>, <span class="r6 r">managedIdentityClientId</span>: <span class="r17 r">managedIdentityArgument</span>);
 
            <span class="c">// Get token. This confirms that the environment variables are being read.</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="k">var</a> <span id="r21 rd" class="r21 r">authResult</span> = <b>await</b> <span class="r20 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r21 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#bac23240ee26a0c7" class="i property">AccessToken</a>, <span class="r20 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#675f5f5e0e11c4d7" class="i field">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#bd2c3b58b4413596" class="i field">AppType</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>, <span class="r16 r">expectedAppId</span>, <span class="r8 r">expiresOn</span>: <span class="r21 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0bd6af7f6ac59d37" class="i property">ExpiresOn</a>);
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">net452</span>
<span class="e">        [Fact]
        public async Task ServiceFabricNet452Unsupported()
        {
            // Setup the environment variables that App Service MSI would setup. 
            Environment.SetEnvironmentVariable(Constants.MsiServiceFabricEndpointEnv, &quot;https://10.0.0.4:2377/metadata/identity/oauth2/token&quot;);
            Environment.SetEnvironmentVariable(Constants.MsiServiceFabricHeaderEnv, &quot;f8c33594-3eea-46de-8888-d3d258f054e0&quot;);
            Environment.SetEnvironmentVariable(Constants.MsiServiceFabricThumbprintEnv, &quot;e9c25f41a4d8b430201b32918fb3a86d5325b69f&quot;);
            Environment.SetEnvironmentVariable(Constants.MsiServiceFabricApiVersionEnv, &quot;2020-05-01&quot;);
 
            MockMsi mockMsi = new MockMsi(MockMsi.MsiTestType.MsiServiceFabricSuccess);
            MsiAccessTokenProvider msiAccessTokenProvider = new MsiAccessTokenProvider(mockMsi);
 
            var exception = await Assert.ThrowsAsync&lt;AzureServiceTokenProviderException&gt;(() =&gt; Task.Run(() =&gt; msiAccessTokenProvider.GetAuthResultAsync(Constants.KeyVaultResourceId, Constants.TenantId)));
 
            Assert.Contains(&quot;not supported&quot;, exception.Message);
        }
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
        [<span class="t constructor">Theory</span>]
        [<span class="t constructor">InlineData</span>(<b>true</b>)]
        [<span class="t constructor">InlineData</span>(<b>false</b>)]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="176e706dc5d4212c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTokenUsingManagedIdentityServiceFabric</a>(<b>bool</b> <span id="r22 rd" class="r22 r">specifyUserAssignedManagedIdentity</span>)
        {
            <span class="c">// Setup the environment variables that App Service MSI would setup. </span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#9e1c16b840e60ca9" class="i field">MsiServiceFabricEndpointEnv</a>, <span class="s">&quot;https://10.0.0.4:2377/metadata/identity/oauth2/token&quot;</span>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d7ff2b48ae1da01b" class="i field">MsiServiceFabricHeaderEnv</a>, <a href="../GuidAssembly/R/f8c33594-3eea-46de-8888-d3d258f054e0.html" target="n" class="s">&quot;f8c33594-3eea-46de-8888-d3d258f054e0&quot;</a>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#521122e1beefd718" class="i field">MsiServiceFabricThumbprintEnv</a>, <span class="s">&quot;e9c25f41a4d8b430201b32918fb3a86d5325b69f&quot;</span>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#37a45fb556f37aac" class="i field">MsiServiceFabricApiVersionEnv</a>, <span class="s">&quot;2020-05-01&quot;</span>);
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r23 rd" class="r23 r">expectedAppId</span>;
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r24 rd" class="r24 r">managedIdentityArgument</span>;
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a> <span id="r25 rd" class="r25 r">msiTestType</span>;
 
            <span class="c">// Determine arguments and expected values based whether user-assigned managed identity is used</span>
            <span class="c">// Service Fabric backend is IMDS, so responses will be similar to Azure VM responses</span>
            <b>if</b> (<span class="r22 r">specifyUserAssignedManagedIdentity</span>)
            {
                <span class="r24 r">managedIdentityArgument</span> = <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#f93cd6d1bd30210e" class="i field">TestUserAssignedManagedIdentityId</a>;
                <span class="r25 r">msiTestType</span> = <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#5f33edadee13e4f3" class="i field">MsiUserAssignedIdentityServiceFabricSuccess</a>;
                <span class="r23 r">expectedAppId</span> = <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#f93cd6d1bd30210e" class="i field">TestUserAssignedManagedIdentityId</a>;
            }
            <b>else</b>
            {
                <span class="r24 r">managedIdentityArgument</span> = <b>null</b>;
                <span class="r25 r">msiTestType</span> = <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#62986cb44b8d338d" class="i field">MsiServiceFabricSuccess</a>;
                <span class="r23 r">expectedAppId</span> = <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#cd1270a9579cf0f4" class="i field">TestAppId</a>;
            }
 
            <span class="c">// MockMsi is being asked to act like response from App Service MSI suceeded. </span>
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r26 rd" class="r26 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<span class="r25 r">msiTestType</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r27 rd" class="r27 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r26 r">mockMsi</span>, <span class="r6 r">managedIdentityClientId</span>: <span class="r24 r">managedIdentityArgument</span>);
 
            <span class="c">// Get token. This confirms that the environment variables are being read. </span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="k">var</a> <span id="r28 rd" class="r28 r">authResult</span> = <b>await</b> <span class="r27 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r28 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#bac23240ee26a0c7" class="i property">AccessToken</a>, <span class="r27 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#675f5f5e0e11c4d7" class="i field">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#bd2c3b58b4413596" class="i field">AppType</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>, <span class="r23 r">expectedAppId</span>, <span class="r8 r">expiresOn</span>: <span class="r28 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0bd6af7f6ac59d37" class="i property">ExpiresOn</a>);
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test response when IDENTITY_HEADER in AppServices MSI is invalid.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="56929adcd9de1c4c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UnauthorizedTest</a>()
        {
            <span class="c">// Setup the environment variables</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#944a6a91e03153c9" class="i field">MsiEndpoint</a>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#87e40afca17f877b" class="i field">ClientSecret</a>);
 
            <span class="c">// MockMsi is being asked to act like response from App Service MSI failed (unauthorized).</span>
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r29 rd" class="r29 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#6177fe76fc626fcc" class="i field">MsiAppServicesUnauthorized</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r30 rd" class="r30 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r29 r">mockMsi</span>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r31 rd" class="r31 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <span class="r30 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>)));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#5a05f15bf3bb65af" class="i field">IncorrectSecretError</a>, <span class="r31 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="@0@System/A.html#9b95c882b40ef96e" class="t t">HttpStatusCode</a>.<a href="@0@System/A.html#ef112b6f49d0fa51" class="i field">Forbidden</a>.<a href="@0@mscorlib/A.html#1365cfeffd45409d" class="i method">ToString</a>(), <span class="r31 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test that response when MSI request is not valid is as expected.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="55c7da4a30cdabc6" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">IncorrectFormatTest</a>()
        {
            <span class="c">// Setup the environment variables</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#944a6a91e03153c9" class="i field">MsiEndpoint</a>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#87e40afca17f877b" class="i field">ClientSecret</a>);
 
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r32 rd" class="r32 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#bed9f11abf5b21e4" class="i field">MsiAppServicesIncorrectRequest</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r33 rd" class="r33 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r32 r">mockMsi</span>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r34 rd" class="r34 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <span class="r33 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>)));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d0042260cddd156a" class="i field">IncorrectFormatError</a>, <span class="r34 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="@0@System/A.html#9b95c882b40ef96e" class="t t">HttpStatusCode</a>.<a href="@0@System/A.html#813537f308d3a0ef" class="i field">BadRequest</a>.<a href="@0@mscorlib/A.html#1365cfeffd45409d" class="i method">ToString</a>(), <span class="r34 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If an unexpected http response has been received, ensure exception is thrown.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="810303f26d8ceebd" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">HttpResponseExceptionTest</a>()
        {
            <span class="c">// Setup the environment variables</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#944a6a91e03153c9" class="i field">MsiEndpoint</a>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#87e40afca17f877b" class="i field">ClientSecret</a>);
 
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r35 rd" class="r35 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#18009152ce9dbc54" class="i field">MsiAppServicesFailure</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r36 rd" class="r36 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r35 r">mockMsi</span>);
 
            <span class="c">// use test hook to expedite test</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#1ae00cb41271ba3c" class="t t">MsiRetryHelper</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#54719ae550375fa0" class="i field">WaitBeforeRetry</a> = <b>false</b>;
 
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r37 rd" class="r37 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <span class="r36 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>)));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#cb6dbdb6f895d63a" class="i field">MsiEndpointNotListening</a>, <span class="r37 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
        }
 
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="affa917b0d3d8b5c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">AzureVmImdsTimeoutTest</a>()
        {
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <b>null</b>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <b>null</b>);
 
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r38 rd" class="r38 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#74e52aed0039c6ce" class="i field">MsiAzureVmImdsTimeout</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r39 rd" class="r39 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r38 r">mockMsi</span>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r40 rd" class="r40 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <span class="r39 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>)));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9a932234bd062946" class="i field">MetadataEndpointNotListening</a>, <span class="r40 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
            <span class="t t">Assert</span>.<span class="i method">DoesNotContain</span>(<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#8e0c139d3005d1a3" class="i field">RetryFailure</a>, <span class="r40 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
        }
 
        [<span class="t constructor">Theory</span>]
        [<span class="t constructor">InlineData</span>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#cbc9c8ae35e21f85" class="i field">MsiUnresponsive</a>)]
        [<span class="t constructor">InlineData</span>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#ae37fcaa202eed57" class="i field">MsiThrottled</a>)]
        [<span class="t constructor">InlineData</span>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#864efdd2b7068c9f" class="i field">MsiTransientServerError</a>)]
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="f01af1264ffc5882" href="R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">TransientErrorRetryTest</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a> <span id="r41 rd" class="r41 r">testType</span>)
        {
            <span class="c">// To simplify tests, mock as MSI App Services to skip Azure VM IDMS probe request by</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#944a6a91e03153c9" class="i field">MsiEndpoint</a>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#87e40afca17f877b" class="i field">ClientSecret</a>);
 
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r42 rd" class="r42 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<span class="r41 r">testType</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r43 rd" class="r43 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r42 r">mockMsi</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#1ae00cb41271ba3c" class="t t">MsiRetryHelper</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#54719ae550375fa0" class="i field">WaitBeforeRetry</a> = <b>false</b>;
 
            <span class="c">// Get token, requests will fail several times before success</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="k">var</a> <span id="r44 rd" class="r44 r">authResult</span> = <b>await</b> <span class="r43 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r44 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#bac23240ee26a0c7" class="i property">AccessToken</a>, <span class="r43 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#675f5f5e0e11c4d7" class="i field">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#bd2c3b58b4413596" class="i field">AppType</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#cd1270a9579cf0f4" class="i field">TestAppId</a>, <span class="r8 r">expiresOn</span>: <span class="r44 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0bd6af7f6ac59d37" class="i property">ExpiresOn</a>);
 
            <span class="c">// Request for token again, subsequent requests will all fail</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r45 rd" class="r45 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <span class="r43 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>)));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#8e0c139d3005d1a3" class="i field">RetryFailure</a>, <span class="r45 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
 
            <b>if</b> (<span class="r41 r">testType</span> == <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#cbc9c8ae35e21f85" class="i field">MsiUnresponsive</a>)
            {
                <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#cb6dbdb6f895d63a" class="i field">MsiEndpointNotListening</a>, <span class="r45 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
            }
            <b>else</b>
            {
                <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#74c51a6320d16d98" class="i field">GenericErrorMessage</a>, <span class="r45 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
                <span class="t t">Assert</span>.<span class="i method">Contains</span>(<span class="r41 r">testType</span>.<a href="@0@mscorlib/A.html#1365cfeffd45409d" class="i method">ToString</a>(), <span class="r45 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
            }
        }
 
        [<span class="t constructor">Theory</span>]
        [<span class="t constructor">InlineData</span>(<b>false</b>)]
        [<span class="t constructor">InlineData</span>(<b>true</b>)]
        <b>internal async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="2c7701c98a519818" href="R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">MsiRetryTimeoutTest</a>(<b>bool</b> <span id="r46 rd" class="r46 r">isAppServices</span>)
        {
            <b>if</b> (<span class="r46 r">isAppServices</span>)
            {
                <span class="c">// Mock as MSI App Services to skip Azure VM IDMS probe request</span>
                <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#944a6a91e03153c9" class="i field">MsiEndpoint</a>);
                <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#87e40afca17f877b" class="i field">ClientSecret</a>);
            }
 
            <b>int</b> <span id="r47 rd" class="r47 r">timeoutInSeconds</span> = (<b>new</b> <a href="@0@mscorlib/A.html#5d22f8880fc9f8d9" class="t constructor">Random</a>()).<a href="@0@mscorlib/A.html#ddd1e9e09c70bab5" class="i method">Next</a>(1, 4);
 
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r48 rd" class="r48 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#cbc9c8ae35e21f85" class="i field">MsiUnresponsive</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r49 rd" class="r49 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r48 r">mockMsi</span>, <span class="r50 r">retryTimeoutInSeconds</span>: <span class="r47 r">timeoutInSeconds</span>);
 
            <span class="c">// Do not use test hook to skip wait, test should timeout while waiting</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#1ae00cb41271ba3c" class="t t">MsiRetryHelper</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#54719ae550375fa0" class="i field">WaitBeforeRetry</a> = <b>true</b>;
 
            <a href="@0@System/A.html#ceb0ba9cc88de82e" class="t t">Stopwatch</a> <span id="r51 rd" class="r51 r">timer</span> = <b>new</b> <a href="@0@System/A.html#e0a8bcc83e66a717" class="t constructor">Stopwatch</a>();
            <span class="r51 r">timer</span>.<a href="@0@System/A.html#f56fda03f3c59486" class="i method">Start</a>();
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r52 rd" class="r52 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <span class="r49 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>)));
            <span class="r51 r">timer</span>.<a href="@0@System/A.html#9dd6cac7fc1e2117" class="i method">Stop</a>();
 
            <span class="c">// validate correct error message and and that total elapsed time is (roughly) the retry timeout specified</span>
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#1ae00cb41271ba3c" class="t t">MsiRetryHelper</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#1f84dcedf2cfee61" class="i field">RetryTimeoutError</a>, <span class="r52 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
            <span class="t t">Assert</span>.<span class="i method">True</span>(<span class="r51 r">timer</span>.<a href="@0@System/A.html#60e03fb80c10ec79" class="i property">Elapsed</a>.<a href="@0@mscorlib/A.html#061d7498e3227cfb" class="i property">TotalSeconds</a> - <span class="r47 r">timeoutInSeconds</span> &lt; 1.0);
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">NETCOREAPP1_1</span>
        [<span class="t constructor">Fact</span>]
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="ba8e9d5b77b545f3" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">AppServicesDifferentCultureTest</a>()
        {
            <a href="@0@mscorlib/A.html#e319c6636909012f" class="k">var</a> <span id="r53 rd" class="r53 r">defaultCulture</span> = <a href="@0@mscorlib/A.html#3980e012bae82e96" class="t t">Thread</a>.<a href="@0@mscorlib/A.html#89653a7faafd4d23" class="i property">CurrentThread</a>.<a href="@0@mscorlib/A.html#d90337144e718b0f" class="i property">CurrentCulture</a>;
 
            <b>try</b>
            {
                <span class="c">// ensure thread culture is NOT using en-US culture (App Services MSI endpoint always uses en-US DateTime format)</span>
                <a href="@0@mscorlib/A.html#3980e012bae82e96" class="t t">Thread</a>.<a href="@0@mscorlib/A.html#89653a7faafd4d23" class="i property">CurrentThread</a>.<a href="@0@mscorlib/A.html#d90337144e718b0f" class="i property">CurrentCulture</a> = <b>new</b> <a href="@0@mscorlib/A.html#cb4dd1c3262abd32" class="t constructor">CultureInfo</a>(<span class="s">&quot;en-GB&quot;</span>);
 
                <span class="c">// Setup the environment variables that App Service MSI would setup.</span>
                <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#944a6a91e03153c9" class="i field">MsiEndpoint</a>);
                <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#87e40afca17f877b" class="i field">ClientSecret</a>);
 
                <span class="c">// MockMsi is being asked to act like response from App Service MSI suceeded.</span>
                <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r54 rd" class="r54 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#beaa2f4135c37722" class="i field">MsiAppServicesSuccess</a>);
                <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r55 rd" class="r55 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r54 r">mockMsi</span>);
 
                <span class="c">// Get token.</span>
                <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="k">var</a> <span id="r56 rd" class="r56 r">authResult</span> = <b>await</b> <span class="r55 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#46c3afd96415a0bd" class="i method">GetAuthResultAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                <span class="c">// Check if the principalused and type are as expected.</span>
                <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r56 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#bac23240ee26a0c7" class="i property">AccessToken</a>, <span class="r55 r">msiAccessTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#675f5f5e0e11c4d7" class="i field">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#bd2c3b58b4413596" class="i field">AppType</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#cd1270a9579cf0f4" class="i field">TestAppId</a>, <span class="r8 r">expiresOn</span>: <span class="r56 r">authResult</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0bd6af7f6ac59d37" class="i property">ExpiresOn</a>);
            }
            <b>finally</b>
            {
                <span class="c">// revert back to default thread culture</span>
                <a href="@0@mscorlib/A.html#3980e012bae82e96" class="t t">Thread</a>.<a href="@0@mscorlib/A.html#89653a7faafd4d23" class="i property">CurrentThread</a>.<a href="@0@mscorlib/A.html#d90337144e718b0f" class="i property">CurrentCulture</a> = <span class="r53 r">defaultCulture</span>;
            }
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
    }
}
</pre></td></tr></table></div></body></html>
