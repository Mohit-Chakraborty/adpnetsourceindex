<!DOCTYPE html>
<html><head><title>AzureServiceTokenProviderTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(427);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Services.AppAuthentication.Unit.Tests/AzureServiceTokenProviderTests.cs" target="_top">AzureServiceTokenProviderTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Services.AppAuthentication.Unit.Tests" target="_top">Microsoft.Azure.Services.AppAuthentication.Unit.Tests.csproj</a> (Microsoft.Azure.Services.AppAuthentication.Unit.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Net</span>.<span class="i n">Http</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Reflection</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Services</span>.<span class="i n">AppAuthentication</span>.<span class="i n">TestCommon</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Services</span>.<span class="i n">AppAuthentication</span>.<span class="i n">Unit</span>.<span class="i n">Tests</span>.<span class="i n">Mocks</span>;
<b>using</b> <span class="i n">Xunit</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Services</span>.<span class="i n">AppAuthentication</span>.<span class="i n">Unit</span>.<span class="i n">Tests</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Test cases for AzureServiceTokenProvider class. </span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="8d1b5ad65f9de11a" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="061c29fac167ea75">AzureServiceTokenProviderTests</span></a> : <a href="@0@mscorlib/A.html#1f55292c3174123d" class="t t">IDisposable</a>
    {
        <b>public void</b> <a id="32a1ab4d39212512" href="R/32a1ab4d39212512.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <span class="c">// Clear the cache after running each test.</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b0bec67bcef26262" class="t t">AppAuthResultCache</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#3463f03b9e508fd1" class="i method">Clear</a>();
 
            <span class="c">// Delete environment variables</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#83362d16ab7b5024" class="i field">TestCertUrlEnv</a>, <b>null</b>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <b>null</b>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <b>null</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test that the cache works as expected. </span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="056877b08f1ee7ca" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetAppAuthResultCacheTest</a>()
        {
            <span class="c">// Create two instances of AzureServiceTokenProvider based on AzureCliAccessTokenProvider. </span>
            <a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a> <span id="r0 rd" class="r0 r">mockProcessManager</span> = <b>new</b> <a href="Mocks/MockProcessManager.cs.html#4d877b9a3fd31c4d" class="t constructor">MockProcessManager</a>(<a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a>.<a href="Mocks/MockProcessManager.cs.html#63eab5ffad89bf6a" class="t t">MockProcessManagerRequestType</a>.<a href="Mocks/MockProcessManager.cs.html#4f98645886f70b18" class="i field">Success</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#39a62be243139361" class="t t">AzureCliAccessTokenProvider</a> <span id="r1 rd" class="r1 r">azureCliAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0815045b687aff66" class="t constructor">AzureCliAccessTokenProvider</a>(<span class="r0 r">mockProcessManager</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r2 rd" class="r2 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#962ab7eabd1964a6" class="t constructor">AzureServiceTokenProvider</a>(<span class="r1 r">azureCliAccessTokenProvider</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r3 rd" class="r3 r">azureServiceTokenProvider1</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#962ab7eabd1964a6" class="t constructor">AzureServiceTokenProvider</a>(<span class="r1 r">azureCliAccessTokenProvider</span>);
 
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r4 rd" class="r4 r">tasks</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt;();
 
            <span class="c">// ManualResetEvent will enable testing of SemaphoreSlim used in AzureServiceTokenProvider.</span>
            <a href="@0@mscorlib/A.html#797f9a2c1f6fe76f" class="t t">ManualResetEvent</a> <span id="r5 rd" class="r5 r">manualResetEvent</span> = <b>new</b> <a href="@0@mscorlib/A.html#3f1e8fec681dd775" class="t constructor">ManualResetEvent</a>(<b>false</b>);
 
            <span class="c">// Use AzureServiceTokenProviders to get tokens in parallel.</span>
            <b>for</b> (<b>int</b> <span id="r6 rd" class="r6 r">i</span> = 0; <span class="r6 r">i</span> &lt; 5; <span class="r6 r">i</span>++)
            {
                <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <span id="r7 rd" class="r7 r">task</span> = <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#101f1757fbbf2575" class="i method">Run</a>(<b>async delegate</b>
                {
                    <span class="c">// This will prevent the next line from running, until manualResetEvent.Set() is called. </span>
                    <span class="c">// This will ensure all GetAccessTokenAsync calls are made at once.</span>
                    <span class="r5 r">manualResetEvent</span>.<a href="@0@mscorlib/A.html#8f366147dd3f5f63" class="i method">WaitOne</a>();
 
                    <b>await</b> <span class="r2 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>);
                });
 
                <span class="r4 r">tasks</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r7 r">task</span>);
 
                <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <span id="r8 rd" class="r8 r">task1</span> = <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#101f1757fbbf2575" class="i method">Run</a>(<b>async delegate</b>
                {
                    <span class="r5 r">manualResetEvent</span>.<a href="@0@mscorlib/A.html#8f366147dd3f5f63" class="i method">WaitOne</a>();
 
                    <span class="c">// This is using the other instance of AzureServiceTokenProvider.</span>
                    <b>await</b> <span class="r3 r">azureServiceTokenProvider1</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>);
                });
 
                <span class="r4 r">tasks</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r8 r">task1</span>);
            }
 
            <span class="c">// This will cause GetAccessTokenAsync calls to be made concurrently. </span>
            <span class="r5 r">manualResetEvent</span>.<a href="@0@mscorlib/A.html#63f3d76fa45ccc3d" class="i method">Set</a>();
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#69351c6da968e5d1" class="i method">WhenAll</a>(<span class="r4 r">tasks</span>);
 
            <span class="c">// Even though multiple calls are made to get token concurrently, using two different instances, the process manager should only be called once. </span>
            <span class="c">// This test tells us that the cache is working as intended. </span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(1, <span class="r0 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>);
 
            <span class="c">// Get the token again. This will test if the cache call before semaphore use is working as intended.</span>
            <b>for</b> (<b>int</b> <span id="r9 rd" class="r9 r">i</span> = 0; <span class="r9 r">i</span> &lt; 5; <span class="r9 r">i</span>++)
            {
                <span class="r4 r">tasks</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r2 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>));
            }
 
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#69351c6da968e5d1" class="i method">WhenAll</a>(<span class="r4 r">tasks</span>);
 
            <span class="c">// The hit count should still be 1, since the token should be fetched from cache. </span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(1, <span class="r0 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>);
 
            <span class="c">// Update the cache entry, to simulate token expiration. This updated token will expire in just less than 5 minutes. </span>
            <span class="c">// In a real scenario, the token will expire after some time. </span>
            <span class="c">// AppAuthResultCache should not return this, since it is about to expire. </span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#e4a748da6aaba4d8" class="k">var</a> <span id="r10 rd" class="r10 r">tokenResponse</span> = <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#e4a748da6aaba4d8" class="t t">TokenResponse</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#d9d834fc9b291968" class="i method">Parse</a>(<a href="TokenHelper.cs.html#64e990d10d0ee934" class="t t">TokenHelper</a>.<a href="TokenHelper.cs.html#98dad03fefb5fd69" class="i method">GetUserTokenResponse</a>(5 * 60 - 2));
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="k">var</a> <span id="r11 rd" class="r11 r">authResult</span> = <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="t t">AppAuthenticationResult</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#d3763f80b01ec6b9" class="i method">Create</a>(<span class="r10 r">tokenResponse</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b0bec67bcef26262" class="t t">AppAuthResultCache</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#30cb42c56c0d2204" class="i method">AddOrUpdate</a>(<span class="s">&quot;ConnectionString:;Authority:;Resource:https://vault.azure.net/&quot;</span>,
                <b>new</b> <a href="@0@mscorlib/A.html#ee1efa9bd0176f36" class="t constructor">Tuple</a>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#f4c4ab1f6d870222" class="t t">AppAuthenticationResult</a>, <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ee98ea95591837a0" class="t t">Principal</a>&gt;(<span class="r11 r">authResult</span>, <b>null</b>));
 
            <span class="c">// Get the token again. </span>
            <b>for</b> (<b>int</b> <span id="r12 rd" class="r12 r">i</span> = 0; <span class="r12 r">i</span> &lt; 5; <span class="r12 r">i</span>++)
            {
                <span class="r4 r">tasks</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r2 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>));
            }
 
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#69351c6da968e5d1" class="i method">WhenAll</a>(<span class="r4 r">tasks</span>);
 
            <span class="c">// Hit count should be 2 now, since new token should have been aquired. </span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(2, <span class="r0 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test that the force refresh works as expected.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="994fb4fe936a3305" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetAppAuthResultForceRefreshTest</a>()
        {
            <span class="c">// Create two instances of AzureServiceTokenProvider based on AzureCliAccessTokenProvider. </span>
            <a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a> <span id="r13 rd" class="r13 r">mockProcessManager</span> = <b>new</b> <a href="Mocks/MockProcessManager.cs.html#4d877b9a3fd31c4d" class="t constructor">MockProcessManager</a>(<a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a>.<a href="Mocks/MockProcessManager.cs.html#63eab5ffad89bf6a" class="t t">MockProcessManagerRequestType</a>.<a href="Mocks/MockProcessManager.cs.html#4f98645886f70b18" class="i field">Success</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#39a62be243139361" class="t t">AzureCliAccessTokenProvider</a> <span id="r14 rd" class="r14 r">azureCliAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0815045b687aff66" class="t constructor">AzureCliAccessTokenProvider</a>(<span class="r13 r">mockProcessManager</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r15 rd" class="r15 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#962ab7eabd1964a6" class="t constructor">AzureServiceTokenProvider</a>(<span class="r14 r">azureCliAccessTokenProvider</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r16 rd" class="r16 r">azureServiceTokenProvider1</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#962ab7eabd1964a6" class="t constructor">AzureServiceTokenProvider</a>(<span class="r14 r">azureCliAccessTokenProvider</span>);
 
            <span class="c">// Part 1: Verify force refresh of sequential requests will request new tokens.</span>
            <b>await</b> <span class="r15 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>);
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(1, <span class="r13 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>);
 
            <b>await</b> <span class="r15 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>);
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(1, <span class="r13 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>); <span class="c">// cache hit.</span>
 
            <b>await</b> <span class="r15 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#43b4280a97d80925" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <span class="r17 r">forceRefresh</span>: <b>true</b>);
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(2, <span class="r13 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>); <span class="c">// force refresh hit.</span>
 
            <b>await</b> <span class="r16 r">azureServiceTokenProvider1</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#145481867d18d338" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>);
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(2, <span class="r13 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>); <span class="c">// cache hit.</span>
 
            <b>await</b> <span class="r16 r">azureServiceTokenProvider1</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#43b4280a97d80925" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4c2c0370afa0a59e" class="i field">KeyVaultResourceId</a>, <span class="r17 r">forceRefresh</span>: <b>true</b>);
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(3, <span class="r13 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>); <span class="c">// force refresh hit.</span>
 
            <span class="c">// Part 2: Verify parallel force-refreshes re-use the same fetched token.</span>
            <span class="c">// TODO: current system does not allow for controlling this flow, test would be non-deterministic and intermitently fail.</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check that the exception thrown by the AzureServiceTokenProvider is as expected. </span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="ab06d8357b1b18df" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTokenExceptionTest</a>()
        {
            <span class="c">// Mock ProcessManager is being asked to act like Azure CLI is not installed. </span>
            <a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a> <span id="r18 rd" class="r18 r">mockProcessManager</span> = <b>new</b> <a href="Mocks/MockProcessManager.cs.html#4d877b9a3fd31c4d" class="t constructor">MockProcessManager</a>(<a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a>.<a href="Mocks/MockProcessManager.cs.html#63eab5ffad89bf6a" class="t t">MockProcessManagerRequestType</a>.<a href="Mocks/MockProcessManager.cs.html#5081daaeca7a3db4" class="i field">ProcessNotFound</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#39a62be243139361" class="t t">AzureCliAccessTokenProvider</a> <span id="r19 rd" class="r19 r">azureCliAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0815045b687aff66" class="t constructor">AzureCliAccessTokenProvider</a>(<span class="r18 r">mockProcessManager</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r20 rd" class="r20 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#962ab7eabd1964a6" class="t constructor">AzureServiceTokenProvider</a>(<span class="r19 r">azureCliAccessTokenProvider</span>);
 
            <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <span class="r20 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7440141aa26f324a" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4a71aea8e3c7400f" class="i field">GraphResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>)));
 
            <span class="c">// Hit count should be 1, since we called Get Token once. </span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(1, <span class="r18 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r21 rd" class="r21 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <span class="r20 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7440141aa26f324a" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4a71aea8e3c7400f" class="i field">GraphResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>)));
 
            <span class="c">// Hit count is 2, since token could not be fetched, and so was not in cache. </span>
            <span class="c">// This tells us that tokens are only cached if they are aquired. </span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(2, <span class="r18 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>);
 
            <span class="c">// Exception should contain the resource and tenant</span>
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4a71aea8e3c7400f" class="i field">GraphResourceId</a>, <span class="r21 r">exception</span>.<a href="@0@mscorlib/A.html#e2e19f4ed8da81aa" class="i method">ToString</a>());
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>, <span class="r21 r">exception</span>.<a href="@0@mscorlib/A.html#e2e19f4ed8da81aa" class="i method">ToString</a>());
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If azureAdInstance does not start with https, an exception should be thrown. </span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public void</b> <a id="f2e9b50cb54b7aa2" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">InvalidAzureAdInstanceTest</a>()
        {
            <a href="@0@mscorlib/A.html#109b3ef6299ef9df" class="k">var</a> <span id="r22 rd" class="r22 r">exception</span> = <span class="t t">Assert</span>.<span class="i method">Throws</span>&lt;<a href="@0@mscorlib/A.html#109b3ef6299ef9df" class="t t">ArgumentException</a>&gt;(() =&gt; <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#78632484199b0ed0" class="t constructor">AzureServiceTokenProvider</a>(<span class="r23 r">azureAdInstance</span>: <span class="s">&quot;http://aadinstance/&quot;</span>));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d68523427e2d724a" class="i field">MustUseHttpsError</a>, <span class="r22 r">exception</span>.<a href="@0@mscorlib/A.html#e2e19f4ed8da81aa" class="i method">ToString</a>());
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If resource id is null or empty, an exception should be thrown. </span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="cf9fef9268d0262a" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ResourceNullOrEmptyWhenGettingTokenTest</a>()
        {
            <span class="c">// Mock ProcessManager is being asked to act like Azure CLI is not installed. </span>
            <a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a> <span id="r24 rd" class="r24 r">mockProcessManager</span> = <b>new</b> <a href="Mocks/MockProcessManager.cs.html#4d877b9a3fd31c4d" class="t constructor">MockProcessManager</a>(<a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a>.<a href="Mocks/MockProcessManager.cs.html#63eab5ffad89bf6a" class="t t">MockProcessManagerRequestType</a>.<a href="Mocks/MockProcessManager.cs.html#5081daaeca7a3db4" class="i field">ProcessNotFound</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#39a62be243139361" class="t t">AzureCliAccessTokenProvider</a> <span id="r25 rd" class="r25 r">azureCliAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0815045b687aff66" class="t constructor">AzureCliAccessTokenProvider</a>(<span class="r24 r">mockProcessManager</span>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r26 rd" class="r26 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#962ab7eabd1964a6" class="t constructor">AzureServiceTokenProvider</a>(<span class="r25 r">azureCliAccessTokenProvider</span>);
 
            <a href="@0@mscorlib/A.html#c742289497493bb8" class="k">var</a> <span id="r27 rd" class="r27 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="@0@mscorlib/A.html#c742289497493bb8" class="t t">ArgumentNullException</a>&gt;(() =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <span class="r26 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7440141aa26f324a" class="i method">GetAccessTokenAsync</a>(<b>null</b>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>)));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#075d845f31401c6f" class="i field">CannotBeNullError</a>, <span class="r27 r">exception</span>.<a href="@0@mscorlib/A.html#e2e19f4ed8da81aa" class="i method">ToString</a>());
 
            <span class="r27 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="@0@mscorlib/A.html#c742289497493bb8" class="t t">ArgumentNullException</a>&gt;(() =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <span class="r26 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7440141aa26f324a" class="i method">GetAccessTokenAsync</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#c9f70a27facb27cf" class="i field">Empty</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>)));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#075d845f31401c6f" class="i field">CannotBeNullError</a>, <span class="r27 r">exception</span>.<a href="@0@mscorlib/A.html#e2e19f4ed8da81aa" class="i method">ToString</a>());
 
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If azureAdInstance is null or empty, an exception should be thrown. </span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public void</b> <a id="26a4799aea513f58" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">NullOrEmptyAzureAdInstanceTest</a>()
        {
            <a href="@0@mscorlib/A.html#c742289497493bb8" class="k">var</a> <span id="r28 rd" class="r28 r">exception</span> = <span class="t t">Assert</span>.<span class="i method">Throws</span>&lt;<a href="@0@mscorlib/A.html#c742289497493bb8" class="t t">ArgumentNullException</a>&gt;(() =&gt; <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#78632484199b0ed0" class="t constructor">AzureServiceTokenProvider</a>(<span class="r23 r">azureAdInstance</span>: <b>null</b>));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#075d845f31401c6f" class="i field">CannotBeNullError</a>, <span class="r28 r">exception</span>.<a href="@0@mscorlib/A.html#e2e19f4ed8da81aa" class="i method">ToString</a>());
 
            <span class="r28 r">exception</span> = <span class="t t">Assert</span>.<span class="i method">Throws</span>&lt;<a href="@0@mscorlib/A.html#c742289497493bb8" class="t t">ArgumentNullException</a>&gt;(() =&gt; <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#78632484199b0ed0" class="t constructor">AzureServiceTokenProvider</a>(<span class="r23 r">azureAdInstance</span>: <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#c9f70a27facb27cf" class="i field">Empty</a>));
 
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#075d845f31401c6f" class="i field">CannotBeNullError</a>, <span class="r28 r">exception</span>.<a href="@0@mscorlib/A.html#e2e19f4ed8da81aa" class="i method">ToString</a>());
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If connectionstring is not specified in AzureServiceTokenProvider, ensure connection string is assigned from </span>
        <span class="c">///</span><span class="c"> AzureServicesAuthConnectionString environment variable.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public void</b> <a id="bcdd15959f82a615" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UnspecifiedConnectionStringTest</a>()
        {
            <span class="c">// Set environment variable AzureServicesAuthConnectionString</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#185973ff56b44120" class="i field">ConnectionStringEnvironmentVariableName</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4f99f8d18c3e270c" class="i field">AzureCliConnectionString</a>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="k">var</a> <span id="r29 rd" class="r29 r">provider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#78632484199b0ed0" class="t constructor">AzureServiceTokenProvider</a>();
 
            <span class="t t">Assert</span>.<span class="i method">NotNull</span>(<span class="r29 r">provider</span>);
            <span class="t t">Assert</span>.<span class="i method">IsType</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a>&gt;(<span class="r29 r">provider</span>);
 
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#185973ff56b44120" class="i field">ConnectionStringEnvironmentVariableName</a>, <b>null</b>);
        }
 
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="dd3f1baafcb67c6a" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">DiscoveryTestFirstSuccess</a>()
        {
            <span class="c">// Mock process manager is being asked to act like Azure CLI was able to get the token. </span>
            <a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a> <span id="r30 rd" class="r30 r">mockProcessManager</span> = <b>new</b> <a href="Mocks/MockProcessManager.cs.html#4d877b9a3fd31c4d" class="t constructor">MockProcessManager</a>(<a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a>.<a href="Mocks/MockProcessManager.cs.html#63eab5ffad89bf6a" class="t t">MockProcessManagerRequestType</a>.<a href="Mocks/MockProcessManager.cs.html#4f98645886f70b18" class="i field">Success</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#39a62be243139361" class="t t">AzureCliAccessTokenProvider</a> <span id="r31 rd" class="r31 r">azureCliAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0815045b687aff66" class="t constructor">AzureCliAccessTokenProvider</a>(<span class="r30 r">mockProcessManager</span>);
 
            <span class="c">// Mock MSI is being asked to act like MSI was able to get token. </span>
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r32 rd" class="r32 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#beaa2f4135c37722" class="i field">MsiAppServicesSuccess</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r33 rd" class="r33 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r32 r">mockMsi</span>);
 
            <span class="c">// set env vars so MsiAccessTokenProvider assumes App Service environment and not VM environment</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#944a6a91e03153c9" class="i field">MsiEndpoint</a>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#87e40afca17f877b" class="i field">ClientSecret</a>);
 
            <span class="c">// AzureServiceTokenProvider is being asked to use two providers, and return token from the first that succeeds.  </span>
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r34 rd" class="r34 r">providers</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#49fd7e94c4cb40c3" class="t t">NonInteractiveAzureServiceTokenProviderBase</a>&gt; { <span class="r31 r">azureCliAccessTokenProvider</span>, <span class="r33 r">msiAccessTokenProvider</span> };
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r35 rd" class="r35 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#87a6cbde804e5dd4" class="t constructor">AzureServiceTokenProvider</a>(<span class="r34 r">providers</span>);
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r36 rd" class="r36 r">token</span> = <b>await</b> <span class="r35 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7440141aa26f324a" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4a71aea8e3c7400f" class="i field">GraphResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>);
 
            <span class="c">// Mock process manager will be hit first, and so the hit count should be 1.</span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(1, <span class="r30 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>);
 
            <span class="c">// Msi handler will not be hit, since AzureCliAccessTokenProvider was able to return token. So this hit count should be 0. </span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(0, <span class="r32 r">mockMsi</span>.<a href="Mocks/MockMsi.cs.html#a32b2c2152304581" class="i field">HitCount</a>);
 
            <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r36 r">token</span>, <span class="r35 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b78f2d4fcc0556c1" class="i property">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#09b5e3eb5fba719b" class="i field">UserType</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>);
        }
 
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="2ffd048d6ff44792" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">DiscoveryTestFirstFail</a>()
        {
            <span class="c">// Mock process manager is being asked to act like Azure CLI was NOT able to get the token. </span>
            <a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a> <span id="r37 rd" class="r37 r">mockProcessManager</span> = <b>new</b> <a href="Mocks/MockProcessManager.cs.html#4d877b9a3fd31c4d" class="t constructor">MockProcessManager</a>(<a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a>.<a href="Mocks/MockProcessManager.cs.html#63eab5ffad89bf6a" class="t t">MockProcessManagerRequestType</a>.<a href="Mocks/MockProcessManager.cs.html#5081daaeca7a3db4" class="i field">ProcessNotFound</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#39a62be243139361" class="t t">AzureCliAccessTokenProvider</a> <span id="r38 rd" class="r38 r">azureCliAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0815045b687aff66" class="t constructor">AzureCliAccessTokenProvider</a>(<span class="r37 r">mockProcessManager</span>);
 
            <span class="c">// Mock MSI is being asked to act like MSI was able to get token. </span>
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r39 rd" class="r39 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#beaa2f4135c37722" class="i field">MsiAppServicesSuccess</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r40 rd" class="r40 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r39 r">mockMsi</span>);
 
            <span class="c">// set env vars so MsiAccessTokenProvider assumes App Service environment and not VM environment</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#944a6a91e03153c9" class="i field">MsiEndpoint</a>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#87e40afca17f877b" class="i field">ClientSecret</a>);
 
            <span class="c">// AzureServiceTokenProvider is being asked to use two providers, and return token from the first that succeeds.  </span>
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r41 rd" class="r41 r">providers</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#49fd7e94c4cb40c3" class="t t">NonInteractiveAzureServiceTokenProviderBase</a>&gt; { <span class="r38 r">azureCliAccessTokenProvider</span>, <span class="r40 r">msiAccessTokenProvider</span> };
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r42 rd" class="r42 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#87a6cbde804e5dd4" class="t constructor">AzureServiceTokenProvider</a>(<span class="r41 r">providers</span>);
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r43 rd" class="r43 r">token</span> = <b>await</b> <span class="r42 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7440141aa26f324a" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4a71aea8e3c7400f" class="i field">GraphResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>);
 
            <span class="c">// Mock process manager will be hit first, and so hit count will be 1. </span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(1, <span class="r37 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>);
 
            <span class="c">// AzureCliAccessTokenProvider will fail, and so Msi handler will be hit next. So hit count is 1 here.</span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(1, <span class="r39 r">mockMsi</span>.<a href="Mocks/MockMsi.cs.html#a32b2c2152304581" class="i field">HitCount</a>);
 
            <span class="c">// MsiAccessTokenProvider should succeed, and we should get a valid token. </span>
            <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#6b22e9ee44dd0d4d" class="t t">Validator</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d429827173fe6bdc" class="i method">ValidateToken</a>(<span class="r43 r">token</span>, <span class="r42 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#b78f2d4fcc0556c1" class="i property">PrincipalUsed</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#bd2c3b58b4413596" class="i field">AppType</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#cd1270a9579cf0f4" class="i field">TestAppId</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If token could not be acquired through any of the specified providers, an exception should be thrown</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public void</b> <a id="2888a41ae7b1257a" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">DiscoveryTestBothFail</a>()
        {
            <span class="c">// Mock process manager is being asked to act like Azure CLI was NOT able to get the token. </span>
            <a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a> <span id="r44 rd" class="r44 r">mockProcessManager</span> = <b>new</b> <a href="Mocks/MockProcessManager.cs.html#4d877b9a3fd31c4d" class="t constructor">MockProcessManager</a>(<a href="Mocks/MockProcessManager.cs.html#b9248edd920a9c3d" class="t t">MockProcessManager</a>.<a href="Mocks/MockProcessManager.cs.html#63eab5ffad89bf6a" class="t t">MockProcessManagerRequestType</a>.<a href="Mocks/MockProcessManager.cs.html#5081daaeca7a3db4" class="i field">ProcessNotFound</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#39a62be243139361" class="t t">AzureCliAccessTokenProvider</a> <span id="r45 rd" class="r45 r">azureCliAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#0815045b687aff66" class="t constructor">AzureCliAccessTokenProvider</a>(<span class="r44 r">mockProcessManager</span>);
 
            <span class="c">// Mock MSI is being asked to act like MSI was NOT able to get token. </span>
            <a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a> <span id="r46 rd" class="r46 r">mockMsi</span> = <b>new</b> <a href="Mocks/MockMsi.cs.html#f0d9afe808445f01" class="t constructor">MockMsi</a>(<a href="Mocks/MockMsi.cs.html#15c5409709361ec5" class="t t">MockMsi</a>.<a href="Mocks/MockMsi.cs.html#3ddf7a34a01093f9" class="t t">MsiTestType</a>.<a href="Mocks/MockMsi.cs.html#18009152ce9dbc54" class="i field">MsiAppServicesFailure</a>);
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#a03cb7a938cc3c56" class="t t">MsiAccessTokenProvider</a> <span id="r47 rd" class="r47 r">msiAccessTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7699ac12df884788" class="t constructor">MsiAccessTokenProvider</a>(<span class="r46 r">mockMsi</span>);
 
            <span class="c">// set env vars so MsiAccessTokenProvider assumes App Service environment and not VM environment</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#944a6a91e03153c9" class="i field">MsiEndpoint</a>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#87e40afca17f877b" class="i field">ClientSecret</a>);
 
            <span class="c">// use test hook to expedite test</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#1ae00cb41271ba3c" class="t t">MsiRetryHelper</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#54719ae550375fa0" class="i field">WaitBeforeRetry</a> = <b>false</b>;
 
            <span class="c">// AzureServiceTokenProvider is being asked to use two providers, and and both should fail to get token.  </span>
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r48 rd" class="r48 r">providers</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#49fd7e94c4cb40c3" class="t t">NonInteractiveAzureServiceTokenProviderBase</a>&gt; { <span class="r45 r">azureCliAccessTokenProvider</span>, <span class="r47 r">msiAccessTokenProvider</span> };
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a> <span id="r49 rd" class="r49 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#87a6cbde804e5dd4" class="t constructor">AzureServiceTokenProvider</a>(<span class="r48 r">providers</span>);
 
            <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="k">var</a> <span id="r50 rd" class="r50 r">exception</span> = <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt; <span class="r49 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7440141aa26f324a" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4a71aea8e3c7400f" class="i field">GraphResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>));
            <span class="t t">Assert</span>.<span class="i method">Contains</span>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#68cf6b8d8b9a7f96" class="i field">NoMethodWorkedToGetTokenError</a>, <span class="r50 r">exception</span>.<a href="@0@mscorlib/A.html#826690b09f24e719" class="i property">Result</a>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
 
            <span class="c">// Mock process manager will fail, and so hit count will be 1. </span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(1, <span class="r44 r">mockProcessManager</span>.<a href="Mocks/MockProcessManager.cs.html#a0642ea23884430f" class="i field">HitCount</a>);
 
            <span class="c">// AzureCliAccessTokenProvider will fail, and so MSI handler will be hit next. MSI retry count is 5 so hit count is 5 here.</span>
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(5, <span class="r46 r">mockMsi</span>.<a href="Mocks/MockMsi.cs.html#a32b2c2152304581" class="i field">HitCount</a>);
 
            <span class="c">// Clean up environment variables</span>
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#8288c9e8e3d9640b" class="i field">MsiAppServiceEndpointEnv</a>, <b>null</b>);
            <a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#ba34dd21d0c53ff4" class="i method">SetEnvironmentVariable</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#21b225bb885f750c" class="i field">MsiAppServiceHeaderEnv</a>, <b>null</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Ensure that all public methods are marked virtual to maintain mockability</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public void</b> <a id="4e4f7cd0b9119255" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">RemainMockable</a>()
        {
            <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#d6e277de881aefb5" class="t t">MockUtil</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#9491d942ebf56b8d" class="i method">AssertPublicMethodsAreVirtual</a>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a>&gt;();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Injects an HTTP factory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="b0764db885c3b564" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">InjectHttpFactory</a>()
        {
            <a href="Mocks/MockHttpClientFactory.cs.html#e69ac2e1aaa2ac24" class="k">var</a> <span id="r51 rd" class="r51 r">factory</span> = <b>new</b> <a href="Mocks/MockHttpClientFactory.cs.html#e69ac2e1aaa2ac24" class="t constructor">MockHttpClientFactory</a>();
 
            <span class="c">// create a client secret token provider</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="k">var</a> <span id="r52 rd" class="r52 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#78632484199b0ed0" class="t constructor">AzureServiceTokenProvider</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a07e1f9cb0d6051e" class="i field">ClientSecretConnString</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#f1bb27f5e85b39ba" class="i field">AzureAdInstance</a>, <span class="r51 r">factory</span>);
 
            <span class="c">// trying to use the provider should fail because the http factory isn&#39;t implemented. We can verify it was used though.</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r53 rd" class="r53 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt;
                <span class="r52 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7440141aa26f324a" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4a71aea8e3c7400f" class="i field">GraphResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>));
 
            <span class="t t">Assert</span>.<span class="i method">EndsWith</span>(<a href="Mocks/MockHttpClientFactory.cs.html#e69ac2e1aaa2ac24" class="t t">MockHttpClientFactory</a>.<a href="Mocks/MockHttpClientFactory.cs.html#8b38d577273100be" class="i field">ExceptionMessage</a>, <span class="r53 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Side load an HTTP factory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="4fdf38632c7c8649" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SideLoadHttpFactory</a>()
        {
            <a href="Mocks/MockHttpClientFactory.cs.html#e69ac2e1aaa2ac24" class="t t">MockHttpClientFactory</a> <span id="r54 rd" class="r54 r">factory</span> = <b>new</b> <a href="Mocks/MockHttpClientFactory.cs.html#e69ac2e1aaa2ac24" class="t constructor">MockHttpClientFactory</a>();
 
            <span class="c">// create a client secret token provider</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#dcd2104945f1a831" class="i property">HttpClientFactory</a> = <span class="r54 r">factory</span>;
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="k">var</a> <span id="r55 rd" class="r55 r">azureServiceTokenProvider</span> = <b>new</b> <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#54507b306bcfc8b8" class="t constructor">AzureServiceTokenProvider</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a07e1f9cb0d6051e" class="i field">ClientSecretConnString</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#f1bb27f5e85b39ba" class="i field">AzureAdInstance</a>);
 
            <span class="c">// trying to use the provider should fail because the http factory isn&#39;t implemented. We can verify it was used though.</span>
            <a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="k">var</a> <span id="r56 rd" class="r56 r">exception</span> = <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#9d8ad69856076643" class="t t">AzureServiceTokenProviderException</a>&gt;(() =&gt;
                <span class="r55 r">azureServiceTokenProvider</span>.<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#7440141aa26f324a" class="i method">GetAccessTokenAsync</a>(<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#4a71aea8e3c7400f" class="i field">GraphResourceId</a>, <a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#552fe1d84947f9ce" class="t t">Constants</a>.<a href="/Microsoft.Azure.Services.AppAuthentication.TestCommon/A.html#a4a1e2aa50f7f9c1" class="i field">TenantId</a>));
 
            <span class="t t">Assert</span>.<span class="i method">EndsWith</span>(<a href="Mocks/MockHttpClientFactory.cs.html#e69ac2e1aaa2ac24" class="t t">MockHttpClientFactory</a>.<a href="Mocks/MockHttpClientFactory.cs.html#8b38d577273100be" class="i field">ExceptionMessage</a>, <span class="r56 r">exception</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Verify backwards compatibility with constructor and method signatures</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Fact</span>]
        <b>public void</b> <a id="5da4c51c42ca7fa7" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">VerifyPublicSignatures</a>()
        {
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r57 rd" class="r57 r">KnownPublicCtors</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;()
            {
                <span class="s">&quot;Void .ctor(System.String, System.String)&quot;</span>,
                <span class="s">&quot;Void .ctor(System.String, System.String, Microsoft.IdentityModel.Clients.ActiveDirectory.IHttpClientFactory)&quot;</span>
            };
 
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r58 rd" class="r58 r">KnownPublicMethods</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;()
            {
                <span class="s">&quot;Microsoft.IdentityModel.Clients.ActiveDirectory.IHttpClientFactory get_HttpClientFactory()&quot;</span>,
                <span class="s">&quot;Void set_HttpClientFactory(Microsoft.IdentityModel.Clients.ActiveDirectory.IHttpClientFactory)&quot;</span>,
                <span class="s">&quot;TokenCallback get_KeyVaultTokenCallback()&quot;</span>,
                <span class="s">&quot;Microsoft.Azure.Services.AppAuthentication.Principal get_PrincipalUsed()&quot;</span>,
                <span class="s">&quot;System.Threading.Tasks.Task`1[System.String] GetAccessTokenAsync(System.String, System.String, Boolean, System.Threading.CancellationToken)&quot;</span>,
                <span class="s">&quot;System.Threading.Tasks.Task`1[System.String] GetAccessTokenAsync(System.String, Boolean, System.Threading.CancellationToken)&quot;</span>,
                <span class="s">&quot;System.Threading.Tasks.Task`1[System.String] GetAccessTokenAsync(System.String, System.String, System.Threading.CancellationToken)&quot;</span>,
                <span class="s">&quot;System.Threading.Tasks.Task`1[System.String] GetAccessTokenAsync(System.String, System.String)&quot;</span>,
                <span class="s">&quot;System.Threading.Tasks.Task`1[Microsoft.Azure.Services.AppAuthentication.AppAuthenticationResult] GetAuthenticationResultAsync(System.String, System.String, Boolean, System.Threading.CancellationToken)&quot;</span>,
                <span class="s">&quot;System.Threading.Tasks.Task`1[Microsoft.Azure.Services.AppAuthentication.AppAuthenticationResult] GetAuthenticationResultAsync(System.String, Boolean, System.Threading.CancellationToken)&quot;</span>,
                <span class="s">&quot;System.Threading.Tasks.Task`1[Microsoft.Azure.Services.AppAuthentication.AppAuthenticationResult] GetAuthenticationResultAsync(System.String, System.String, System.Threading.CancellationToken)&quot;</span>,
                <span class="s">&quot;System.Threading.Tasks.Task`1[Microsoft.Azure.Services.AppAuthentication.AppAuthenticationResult] GetAuthenticationResultAsync(System.String, System.String)&quot;</span>,
                <span class="s">&quot;Boolean Equals(System.Object)&quot;</span>,
                <span class="s">&quot;Int32 GetHashCode()&quot;</span>,
                <span class="s">&quot;System.Type GetType()&quot;</span>,
                <span class="s">&quot;System.String ToString()&quot;</span>
            };
 
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r59 rd" class="r59 r">publicCtorSignatures</span> = <b>typeof</b>(<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a>).<a href="@0@mscorlib/A.html#8eecc08aa656293a" class="i method">GetConstructors</a>().<a href="@0@System.Core/A.html#5c652c53e80df013" class="i method">Select</a>(<span id="r60 rd" class="r60 r">o</span> =&gt; <span class="r60 r">o</span>.<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>()).<a href="@0@System.Core/A.html#e276d6892241255b" class="i method">ToList</a>();
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r61 rd" class="r61 r">publicMethodSignatures</span> = <b>typeof</b>(<a href="/Microsoft.Azure.Services.AppAuthentication/A.html#ea6a1ef5cdeceae1" class="t t">AzureServiceTokenProvider</a>).<a href="@0@mscorlib/A.html#7c091fc4114614b5" class="i method">GetMethods</a>().<a href="@0@System.Core/A.html#5c652c53e80df013" class="i method">Select</a>(<span id="r62 rd" class="r62 r">o</span> =&gt; <span class="r62 r">o</span>.<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>()).<a href="@0@System.Core/A.html#e276d6892241255b" class="i method">ToList</a>();
 
            <span class="t t">Assert</span>.<span class="i method">True</span>(<a href="@0@System.Core/A.html#577032c8811e20d3" class="t t">Enumerable</a>.<a href="@0@System.Core/A.html#9bdd6ef7ba6a5615" class="i method">SequenceEqual</a>(<span class="r57 r">KnownPublicCtors</span>.<a href="@0@System.Core/A.html#e449fbc07f49dc52" class="i method">OrderBy</a>(<span id="r63 rd" class="r63 r">i</span> =&gt; <span class="r63 r">i</span>), <span class="r59 r">publicCtorSignatures</span>.<a href="@0@System.Core/A.html#e449fbc07f49dc52" class="i method">OrderBy</a>(<span id="r64 rd" class="r64 r">i</span> =&gt; <span class="r64 r">i</span>)));
            <span class="t t">Assert</span>.<span class="i method">True</span>(<a href="@0@System.Core/A.html#577032c8811e20d3" class="t t">Enumerable</a>.<a href="@0@System.Core/A.html#9bdd6ef7ba6a5615" class="i method">SequenceEqual</a>(<span class="r58 r">KnownPublicMethods</span>.<a href="@0@System.Core/A.html#e449fbc07f49dc52" class="i method">OrderBy</a>(<span id="r65 rd" class="r65 r">i</span> =&gt; <span class="r65 r">i</span>), <span class="r61 r">publicMethodSignatures</span>.<a href="@0@System.Core/A.html#e449fbc07f49dc52" class="i method">OrderBy</a>(<span id="r66 rd" class="r66 r">i</span> =&gt; <span class="r66 r">i</span>)));
        }
    }
}
</pre></td></tr></table></div></body></html>
