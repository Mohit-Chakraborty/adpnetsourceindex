<!DOCTYPE html>
<html><head><title>FileEncryptionTransform.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(244);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Management.Media/Customizations/FileEncryptionTransform.cs" target="_top">Customizations\FileEncryptionTransform.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Management.Media" target="_top">Microsoft.Azure.Management.Media.csproj</a> (Microsoft.Azure.Management.Media)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Security</span>.<span class="i n">Cryptography</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">Media</span>.<span class="i n">StorageEncryption</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Provides a file encryption transformation.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<a href="@0@mscorlib/A.html#66ed4e142f4e14e7" class="t constructor">Obsolete</a>(<span class="s">&quot;The Azure Media Services StorageEncryption feature has been deprecated in favor of Azure Storage Server Side Encryption.  Existing Asset files with StorageEncryption applied can be decrypted but new Assets cannot use StorageEncryption.&quot;</span>)]
    <b>public class</b> <a id="5de4e6373ccd7122" href="../R/5de4e6373ccd7122.html" target="n" data-glyph="0,0" class="t t">FileEncryptionTransform</a> : <a href="@0@mscorlib/A.html#1580d78b8a5ac0c8" class="t t">ICryptoTransform</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The AES block size.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const int</b> <a id="797ade750d2666b0" href="../R/797ade750d2666b0.html" target="n" data-glyph="8,1" class="i field">AesBlockSize</a> = 16;
 
        <b>private readonly ulong</b> <a id="3842cfd587f33843" href="../R/3842cfd587f33843.html" target="n" data-glyph="46,1" class="i field">_initializationVector</a>;
 
        <b>private</b> <a href="@0@mscorlib/A.html#1580d78b8a5ac0c8" class="t t">ICryptoTransform</a> <a id="e1e23e1a108d66d8" href="../R/e1e23e1a108d66d8.html" target="n" data-glyph="46,1" class="i field">_transform</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#5de4e6373ccd7122" class="t t">FileEncryptionTransform</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">transform</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The transform.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">iv</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The initialization vector.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">fileOffset</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The file offset.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="b5d6a1959f1d539c" href="../R/b5d6a1959f1d539c.html" target="n" data-glyph="74,1" class="t constructor">FileEncryptionTransform</a>(<a href="@0@mscorlib/A.html#1580d78b8a5ac0c8" class="t t">ICryptoTransform</a> <span id="r0 rd" class="r0 r">transform</span>, <b>ulong</b> <span id="r1 rd" class="r1 r">iv</span>, <b>long</b> <span id="r2 rd" class="r2 r">fileOffset</span>)
        {
            <b>if</b> (<span class="r0 r">transform</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<span class="s">&quot;transform&quot;</span>);
            }
 
            <b>if</b> (<span class="r2 r">fileOffset</span> &lt; 0)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#27138d3b17d5ff6b" class="t constructor">ArgumentOutOfRangeException</a>(<span class="s">&quot;fileOffset&quot;</span>, <span class="s">&quot;fileOffset cannot be less than zero&quot;</span>);
            }
 
            <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#3842cfd587f33843" class="i field">_initializationVector</a> = <span class="r1 r">iv</span>;
            <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#e1e23e1a108d66d8" class="i field">_transform</a> = <span class="r0 r">transform</span>;
            <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#e09a2eddd4efc70e" class="i property">FileOffset</a> = <span class="r2 r">fileOffset</span>;
        }
 
        <b>private delegate void</b> <a id="90bb11039328a00a" href="../R/../../0000000000.html" target="n" data-glyph="16,1" class="t t"><span id="30fb91c63dc602d5">AsyncAesDelegate</span></a>(<b>byte</b>[] <span id="r3 rd" class="r3 r">data</span>, <b>int</b> <span id="r4 rd" class="r4 r">offset</span>, <b>int</b> <span id="r5 rd" class="r5 r">length</span>, <b>long</b> <span id="r6 rd" class="r6 r">fileOffset</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the file offset.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The file offset.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>public long</b> <a id="e09a2eddd4efc70e" href="../R/e09a2eddd4efc70e.html" target="n" data-glyph="102,1" class="i property">FileOffset</a> { <b>get</b>; <b>set</b>; }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ICryptoTransformMembers
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the input block size.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The size of the input data blocks in bytes.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public int</b> <a id="4fe0c80e7a70751b" href="../R/4fe0c80e7a70751b.html" target="n" data-glyph="102,1" class="i property">InputBlockSize</a>
        {
            <b>get</b> { <b>return</b> 1; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the output block size.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The size of the output data blocks in bytes.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public int</b> <a id="1097f8ae470d904c" href="../R/1097f8ae470d904c.html" target="n" data-glyph="102,1" class="i property">OutputBlockSize</a>
        {
            <b>get</b> { <b>return</b> 1; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a value indicating whether multiple blocks can be transformed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">true if multiple blocks can be transformed; otherwise, false.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="1417d3ce7431ba98" href="../R/1417d3ce7431ba98.html" target="n" data-glyph="102,1" class="i property">CanTransformMultipleBlocks</a>
        {
            <b>get</b> { <b>return</b> <b>true</b>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a value indicating whether the current transform can be reused.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">true if the current transform can be reused; otherwise, false.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="59fd8918cc10d2f4" href="../R/59fd8918cc10d2f4.html" target="n" data-glyph="102,1" class="i property">CanReuseTransform</a>
        {
            <b>get</b> { <b>return</b> <b>false</b>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Transforms the specified region of the input byte array and copies the resulting transform to the specified region of the output byte array.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">inputBuffer</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The input for which to compute the transform.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">inputOffset</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The offset into the input byte array from which to begin using data.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">inputCount</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The number of bytes in the input byte array to use as data.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">outputBuffer</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The output to which to write the transform.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">outputOffset</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The offset into the output byte array from which to begin writing data.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The number of bytes written.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public int</b> <a id="253f417ac20ac37a" href="../R/253f417ac20ac37a.html" target="n" data-glyph="72,1" class="i method">TransformBlock</a>(<b>byte</b>[] <span id="r7 rd" class="r7 r">inputBuffer</span>, <b>int</b> <span id="r8 rd" class="r8 r">inputOffset</span>, <b>int</b> <span id="r9 rd" class="r9 r">inputCount</span>, <b>byte</b>[] <span id="r10 rd" class="r10 r">outputBuffer</span>, <b>int</b> <span id="r11 rd" class="r11 r">outputOffset</span>)
        {
            <a href="@0@mscorlib/A.html#156e066ecc4ccedf" class="t t">Array</a>.<a href="@0@mscorlib/A.html#7441c6721593042c" class="i method">Copy</a>(<span class="r7 r">inputBuffer</span>, <span class="r8 r">inputOffset</span>, <span class="r10 r">outputBuffer</span>, <span class="r11 r">outputOffset</span>, <span class="r9 r">inputCount</span>);
            <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#0bda88e8a049370f" class="i method">AesCtr</a>(<span class="r10 r">outputBuffer</span>, <span class="r11 r">outputOffset</span>, <span class="r9 r">inputCount</span>, <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#e09a2eddd4efc70e" class="i property">FileOffset</a>);
            <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#e09a2eddd4efc70e" class="i property">FileOffset</a> += <span class="r9 r">inputCount</span>;
 
            <b>return</b> <span class="r9 r">inputCount</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Transforms the specified region of the specified byte array.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">inputBuffer</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The input for which to compute the transform.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">inputOffset</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The offset into the byte array from which to begin using data.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">inputCount</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The number of bytes in the byte array to use as data.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The computed transform.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public byte</b>[] <a id="aefb236190553ae5" href="../R/aefb236190553ae5.html" target="n" data-glyph="72,1" class="i method">TransformFinalBlock</a>(<b>byte</b>[] <span id="r12 rd" class="r12 r">inputBuffer</span>, <b>int</b> <span id="r13 rd" class="r13 r">inputOffset</span>, <b>int</b> <span id="r14 rd" class="r14 r">inputCount</span>)
        {
            <b>byte</b>[] <span id="r15 rd" class="r15 r">tempOutputBuffer</span> = <b>new</b> <b>byte</b>[<span class="r14 r">inputCount</span>];
 
            <b>if</b> (<span class="r14 r">inputCount</span> != 0)
            {
                <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#253f417ac20ac37a" class="i method">TransformBlock</a>(<span class="r12 r">inputBuffer</span>, <span class="r13 r">inputOffset</span>, <span class="r14 r">inputCount</span>, <span class="r15 r">tempOutputBuffer</span>, 0);
            }
 
            <b>return</b> <span class="r15 r">tempOutputBuffer</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposeMembers
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Performs application-defined tasks associated with freeing, releasing, or resetting unmanaged resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="1ba487512cde549c" href="../R/1ba487512cde549c.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#9425562e64f26c04" class="i method">Dispose</a>(<b>true</b>);
 
            <span class="c">// Take this object off the finalization queue and prevent the finalization</span>
            <span class="c">// code from running a second time.</span>
            <a href="@0@mscorlib/A.html#25d9c1e022317a99" class="t t">GC</a>.<a href="@0@mscorlib/A.html#2673f5220a565bf2" class="i method">SuppressFinalize</a>(<a href="#5de4e6373ccd7122" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Releases unmanaged and - optionally - managed resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> to release both managed and unmanaged resources; </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> to release only unmanaged resources.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected virtual void</b> <a id="9425562e64f26c04" href="../R/9425562e64f26c04.html" target="n" data-glyph="75,1" class="i method">Dispose</a>(<b>bool</b> <span id="r16 rd" class="r16 r">disposing</span>)
        {
            <b>if</b> (<span class="r16 r">disposing</span>)
            {
                <b>if</b> (<a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#e1e23e1a108d66d8" class="i field">_transform</a> != <b>null</b>)
                {
                    <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#e1e23e1a108d66d8" class="i field">_transform</a>.<a href="@0@mscorlib/A.html#4e23fed29bd598fa" class="i method">Dispose</a>();
                    <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#e1e23e1a108d66d8" class="i field">_transform</a> = <b>null</b>;
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <b>private static void</b> <a id="6d4e92b6d9174a84" href="../R/6d4e92b6d9174a84.html" target="n" data-glyph="76,1" class="i method">ConvertToBigEndianBytes</a>(<b>ulong</b> <span id="r17 rd" class="r17 r">original</span>, <b>byte</b>[] <span id="r18 rd" class="r18 r">outputBuffer</span>, <b>int</b> <span id="r19 rd" class="r19 r">indexToWriteTo</span>)
        {
            <b>byte</b>[] <span id="r20 rd" class="r20 r">originalAsBytes</span> = <a href="@0@mscorlib/A.html#8640d8adfffb155b" class="t t">BitConverter</a>.<a href="@0@mscorlib/A.html#1109603c73042929" class="i method">GetBytes</a>(<span class="r17 r">original</span>);
 
            <b>int</b> <span id="r21 rd" class="r21 r">destIndex</span> = <span class="r19 r">indexToWriteTo</span>;
            <b>for</b> (<b>int</b> <span id="r22 rd" class="r22 r">sourceIndex</span> = <span class="r20 r">originalAsBytes</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> - 1; <span class="r22 r">sourceIndex</span> &gt;= 0; <span class="r22 r">sourceIndex</span>--)
            {
                <span class="r18 r">outputBuffer</span>[<span class="r21 r">destIndex</span>] = <span class="r20 r">originalAsBytes</span>[<span class="r22 r">sourceIndex</span>];
                <span class="r21 r">destIndex</span>++;
            }
        }
 
        <b>private void</b> <a id="0bda88e8a049370f" href="../R/0bda88e8a049370f.html" target="n" data-glyph="76,1" class="i method">AesCtr</a>(<b>byte</b>[] <span id="r23 rd" class="r23 r">data</span>, <b>int</b> <span id="r24 rd" class="r24 r">offset</span>, <b>int</b> <span id="r25 rd" class="r25 r">length</span>, <b>long</b> <span id="r26 rd" class="r26 r">fileOffset</span>)
        {
            <b>if</b> (<span class="r23 r">data</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<span class="s">&quot;data&quot;</span>);
            }
 
            <b>if</b> (<span class="r24 r">offset</span> &lt; 0)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#c524af42f1a5665e" class="t constructor">ArgumentOutOfRangeException</a>(<span class="s">&quot;offset&quot;</span>, <span class="r24 r">offset</span>, <span class="s">&quot;Negative values are not allowed for offset.&quot;</span>);
            }
 
            <b>if</b> (<span class="r25 r">length</span> &lt; 0)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#c524af42f1a5665e" class="t constructor">ArgumentOutOfRangeException</a>(<span class="s">&quot;length&quot;</span>, <span class="r25 r">length</span>, <span class="s">&quot;Negative values are not allowed for length.&quot;</span>);
            }
 
            <b>if</b> (<span class="r26 r">fileOffset</span> &lt; 0)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#c524af42f1a5665e" class="t constructor">ArgumentOutOfRangeException</a>(<span class="s">&quot;fileOffset&quot;</span>, <span class="r26 r">fileOffset</span>, <span class="s">&quot;Negative values are not allowed for fileOffset.&quot;</span>);
            }
 
            <span class="c">// The fileOffset represents the number of bytes from the start of the file that</span>
            <span class="c">// data[offset] was copied from.  We need to convert this byte offset into a block</span>
            <span class="c">// offset (number of 16 byte blocks from the front of the file) and the byte offset </span>
            <span class="c">// within the block.</span>
            <b>long</b> <span id="r27 rd" class="r27 r">offsetFromStartOfFileToFirstByteToProcess</span> = <span class="r26 r">fileOffset</span>;
            <b>ulong</b> <span id="r28 rd" class="r28 r">currentBlock</span> = <a href="@0@mscorlib/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@0@mscorlib/A.html#57b0b18c28a89db2" class="i method">ToUInt64</a>(<span class="r27 r">offsetFromStartOfFileToFirstByteToProcess</span>) / <a href="#797ade750d2666b0" class="i field">AesBlockSize</a>;
            <b>int</b> <span id="r29 rd" class="r29 r">startByteInFirstBlock</span> = <a href="@0@mscorlib/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@0@mscorlib/A.html#bdb2bfd045e3633e" class="i method">ToInt32</a>(<span class="r27 r">offsetFromStartOfFileToFirstByteToProcess</span> % <a href="#797ade750d2666b0" class="i field">AesBlockSize</a>);
 
            <span class="c">// Calculate the byte length of the cryptostream.</span>
            <b>int</b> <span id="r30 rd" class="r30 r">totalLength</span> = <span class="r29 r">startByteInFirstBlock</span> + <span class="r25 r">length</span>;
            <b>int</b> <span id="r31 rd" class="r31 r">totalBlockCount</span> = (<span class="r30 r">totalLength</span> / <a href="#797ade750d2666b0" class="i field">AesBlockSize</a>) + ((<span class="r30 r">totalLength</span> % <a href="#797ade750d2666b0" class="i field">AesBlockSize</a> &gt; 0) ? 1 : 0);
            <b>int</b> <span id="r32 rd" class="r32 r">cryptoStreamLength</span> = <span class="r31 r">totalBlockCount</span> * <a href="#797ade750d2666b0" class="i field">AesBlockSize</a>;
 
            <span class="c">// Write the data to encrypt to the cryptostream.</span>
            <b>byte</b>[] <span id="r33 rd" class="r33 r">initializationVectorAsBigEndianBytes</span> = <b>new</b> <b>byte</b>[8];
            <b>byte</b>[] <span id="r34 rd" class="r34 r">cryptoStream</span> = <b>new</b> <b>byte</b>[<span class="r32 r">cryptoStreamLength</span>];
            <a href="#6d4e92b6d9174a84" class="i method">ConvertToBigEndianBytes</a>(<a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#3842cfd587f33843" class="i field">_initializationVector</a>, <span class="r33 r">initializationVectorAsBigEndianBytes</span>, 0);
 
            <b>for</b> (<b>int</b> <span id="r35 rd" class="r35 r">i</span> = 0; <span class="r35 r">i</span> &lt; <span class="r31 r">totalBlockCount</span>; <span class="r35 r">i</span>++)
            {
                <a href="@0@mscorlib/A.html#156e066ecc4ccedf" class="t t">Array</a>.<a href="@0@mscorlib/A.html#7441c6721593042c" class="i method">Copy</a>(<span class="r33 r">initializationVectorAsBigEndianBytes</span>, 0, <span class="r34 r">cryptoStream</span>, <span class="r35 r">i</span> * 16, <span class="r33 r">initializationVectorAsBigEndianBytes</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>);
                <a href="#6d4e92b6d9174a84" class="i method">ConvertToBigEndianBytes</a>(<span class="r28 r">currentBlock</span>, <span class="r34 r">cryptoStream</span>, (<span class="r35 r">i</span> * 16) + 8);
                <span class="r28 r">currentBlock</span>++;
            }
 
            <a href="#5de4e6373ccd7122" class="k">this</a>.<a href="#e1e23e1a108d66d8" class="i field">_transform</a>.<a href="@0@mscorlib/A.html#56281a9018425d8b" class="i method">TransformBlock</a>(<span class="r34 r">cryptoStream</span>, 0, <span class="r34 r">cryptoStream</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>, <span class="r34 r">cryptoStream</span>, 0);
 
            <b>int</b> <span id="r36 rd" class="r36 r">cryptoStreamIndex</span> = <span class="r29 r">startByteInFirstBlock</span>;
            <b>int</b> <span id="r37 rd" class="r37 r">dataIndex</span> = <span class="r24 r">offset</span>;
            <b>while</b> (<span class="r37 r">dataIndex</span> &lt; (<span class="r24 r">offset</span> + <span class="r25 r">length</span>))
            {
                <span class="r23 r">data</span>[<span class="r37 r">dataIndex</span>] ^= <span class="r34 r">cryptoStream</span>[<span class="r36 r">cryptoStreamIndex</span>];
 
                <span class="c">// increment our indexes</span>
                <span class="r36 r">cryptoStreamIndex</span>++;
                <span class="r37 r">dataIndex</span>++;
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
