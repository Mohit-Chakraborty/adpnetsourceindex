<!DOCTYPE html>
<html><head><title>FileEncryption.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(266);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Management.Media/Customizations/FileEncryption.cs" target="_top">Customizations\FileEncryption.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Management.Media" target="_top">Microsoft.Azure.Management.Media.csproj</a> (Microsoft.Azure.Management.Media)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Security</span>.<span class="i n">Cryptography</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">Media</span>.<span class="i n">StorageEncryption</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Provides file encryption.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<a href="@0@mscorlib/A.html#66ed4e142f4e14e7" class="t constructor">Obsolete</a>(<span class="s">&quot;The Azure Media Services StorageEncryption feature has been deprecated in favor of Azure Storage Server Side Encryption.  Existing Asset files with StorageEncryption applied can be decrypted but new Assets cannot use StorageEncryption.&quot;</span>)]
    <b>public class</b> <a id="b5dceb0f2d3ac13a" href="../R/b5dceb0f2d3ac13a.html" target="n" data-glyph="0,0" class="t t">FileEncryption</a> : <a href="@0@mscorlib/A.html#1f55292c3174123d" class="t t">IDisposable</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The version of the encryption scheme.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static readonly string</b> <a id="9b0b69b5f311b4e7" href="../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">SchemeVersion</a> = <span class="s">&quot;1.0&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The key size for AES 256.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const int</b> <a id="3a623ab858d9266f" href="../R/3a623ab858d9266f.html" target="n" data-glyph="6,1" class="i field">KeySizeInBytesForAes256</a> = 32;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The key size for AES 256 in bits.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const int</b> <a id="af6348efb0a78f94" href="../R/af6348efb0a78f94.html" target="n" data-glyph="6,1" class="i field">KeySizeInBitsForAes256</a> = 256;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The name of the encryption scheme.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static readonly string</b> <a id="e2c5d4fff270a698" href="../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">SchemeName</a> = <span class="s">&quot;StorageEncryption&quot;</span>;
 
        <b>private object</b> <a id="a57e87b2488701b1" href="../R/a57e87b2488701b1.html" target="n" data-glyph="46,1" class="i field">_lockObject</a> = <b>new</b> <b>object</b>();
        <b>private</b> <a href="@0@mscorlib/A.html#97c6f2476150a40d" class="t t">SymmetricAlgorithm</a> <a id="3a183904e17056c0" href="../R/3a183904e17056c0.html" target="n" data-glyph="46,1" class="i field">_key</a>;
        <b>private</b> <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <b>ulong</b>&gt; <a id="e74b6a2acfb9365c" href="../R/e74b6a2acfb9365c.html" target="n" data-glyph="46,1" class="i field">_initializationVectorListByFileName</a> = <b>new</b> <a href="@0@mscorlib/A.html#bf6849e410b43c4c" class="t constructor">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <b>ulong</b>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#b5dceb0f2d3ac13a" class="t t">FileEncryption</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">contentKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The content key.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">keyIdentifier</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The key identifier.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="df031adf16b0ed21" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">FileEncryption</a>(<b>byte</b>[] <span id="r0 rd" class="r0 r">contentKey</span>, <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a> <span id="r1 rd" class="r1 r">keyIdentifier</span>)
        {
            <b>if</b> (<span class="r1 r">keyIdentifier</span> == <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#13baca63417ef924" class="i field">Empty</a>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#eb98012a74461437" class="t constructor">ArgumentException</a>(<span class="s">&quot;Guid.Empty is not a valid keyIdentifier&quot;</span>);
            }
 
            <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#e4f083a368d915d7" class="i method">InternalInit</a>(<span class="r0 r">contentKey</span>, <span class="r1 r">keyIdentifier</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the key identifier.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a> <a id="8626647e2094e3c4" href="../R/8626647e2094e3c4.html" target="n" data-glyph="102,1" class="i property">KeyIdentifier</a> { <b>get</b>; <b>private set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the content key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The content key.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public byte</b>[] <a id="35f3679d8e089396" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetContentKey</a>()
        {
            <b>return</b> <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#3a183904e17056c0" class="i field">_key</a>.<a href="@0@mscorlib/A.html#d12a38c78f5c3174" class="i property">Key</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines whether an initialization vector is present for the specified file name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">fileName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Name of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if an initialization vector is present for the specified file name; otherwise, </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="61399100b6f1ba4c" href="../R/61399100b6f1ba4c.html" target="n" data-glyph="72,1" class="i method">IsInitializationVectorPresent</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r2 rd" class="r2 r">fileName</span>)
        {
            <b>bool</b> <span id="r3 rd" class="r3 r">returnValue</span> = <b>false</b>;
 
            <b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r2 r">fileName</span>))
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#4b20cd3790b6426a" class="t constructor">ArgumentException</a>(<span class="s">&quot;Cannot be null or empty&quot;</span>, <span class="s">&quot;fileName&quot;</span>);
            }
 
            <b>lock</b>(<a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#a57e87b2488701b1" class="i field">_lockObject</a>)
            {
                <span class="r3 r">returnValue</span> = <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#e74b6a2acfb9365c" class="i field">_initializationVectorListByFileName</a>.<a href="@0@mscorlib/A.html#22fd7cd7408aed6e" class="i method">ContainsKey</a>(<span class="r2 r">fileName</span>);
            }
 
            <b>return</b> <span class="r3 r">returnValue</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the initialization vector for file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">fileName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Name of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The initialization vector.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public ulong</b> <a id="66041c48d34208ac" href="../R/66041c48d34208ac.html" target="n" data-glyph="72,1" class="i method">GetInitializationVectorForFile</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r4 rd" class="r4 r">fileName</span>)
        {
            <b>ulong</b> <span id="r5 rd" class="r5 r">returnValue</span> = 0;
 
            <b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r4 r">fileName</span>))
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#4b20cd3790b6426a" class="t constructor">ArgumentException</a>(<span class="s">&quot;Cannot be null or empty&quot;</span>, <span class="s">&quot;fileName&quot;</span>);
            }
 
            <b>lock</b>(<a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#a57e87b2488701b1" class="i field">_lockObject</a>)
            {
                <span class="r5 r">returnValue</span> = <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#e74b6a2acfb9365c" class="i field">_initializationVectorListByFileName</a><a href="@0@mscorlib/A.html#49962975508e2d83">[</a><span class="r4 r">fileName</span>];
            }
 
            <b>return</b> <span class="r5 r">returnValue</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets the initialization vector for file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">fileName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Name of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">initializationVectorToSet</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The initialization vector to set.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public void</b> <a id="dfa6565372f7a1c1" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SetInitializationVectorForFile</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r6 rd" class="r6 r">fileName</span>, <b>ulong</b> <span id="r7 rd" class="r7 r">initializationVectorToSet</span>)
        {
            <b>ulong</b> <span id="r8 rd" class="r8 r">temp</span> = 0;
 
            <b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r6 r">fileName</span>))
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#4b20cd3790b6426a" class="t constructor">ArgumentException</a>(<span class="s">&quot;Cannot be null or empty&quot;</span>, <span class="s">&quot;fileName&quot;</span>);
            }
 
            <b>lock</b>(<a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#a57e87b2488701b1" class="i field">_lockObject</a>)
            {
                <b>if</b> (!<a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#e74b6a2acfb9365c" class="i field">_initializationVectorListByFileName</a>.<a href="@0@mscorlib/A.html#2e5bc6d8c0f21e67" class="i method">TryGetValue</a>(<span class="r6 r">fileName</span>, <b>out</b> <span class="r8 r">temp</span>))
                {
                    <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#e74b6a2acfb9365c" class="i field">_initializationVectorListByFileName</a>.<a href="@0@mscorlib/A.html#a7861da7aaa500fe" class="i method">Add</a>(<span class="r6 r">fileName</span>, <span class="r7 r">initializationVectorToSet</span>);
                }
                <b>else</b> <b>if</b> (<a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#e74b6a2acfb9365c" class="i field">_initializationVectorListByFileName</a><a href="@0@mscorlib/A.html#49962975508e2d83">[</a><span class="r6 r">fileName</span>] != <span class="r7 r">initializationVectorToSet</span>)
                {
                    <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r9 rd" class="r9 r">message</span> = <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#691a34e179b91fdb" class="i method">Format</a>(<a href="@0@mscorlib/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@0@mscorlib/A.html#1f5907384ac6bb55" class="i property">CurrentCulture</a>, <span class="s">&quot;An initialization vector is already set for {0}.&quot;</span>, <span class="r6 r">fileName</span>);
                    <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="r9 r">message</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the file encryption transform.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">fileName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Name of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The transform.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public</b> <a href="FileEncryptionTransform.cs.html#5de4e6373ccd7122" class="t t">FileEncryptionTransform</a> <a id="0aac970c8beec480" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTransform</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r10 rd" class="r10 r">fileName</span>)
        {
            <b>return</b> <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#dc956adea000f234" class="i method">GetTransform</a>(<span class="r10 r">fileName</span>, 0);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the file encryption transform.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">fileName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Name of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">fileOffset</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The file offset.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The transform.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public</b> <a href="FileEncryptionTransform.cs.html#5de4e6373ccd7122" class="t t">FileEncryptionTransform</a> <a id="dc956adea000f234" href="../R/dc956adea000f234.html" target="n" data-glyph="72,1" class="i method">GetTransform</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r11 rd" class="r11 r">fileName</span>, <b>long</b> <span id="r12 rd" class="r12 r">fileOffset</span>)
        {
            <b>ulong</b> <span id="r13 rd" class="r13 r">iv</span> = 0;
 
            <b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r11 r">fileName</span>))
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#4b20cd3790b6426a" class="t constructor">ArgumentException</a>(<span class="s">&quot;Cannot be null or empty&quot;</span>, <span class="s">&quot;fileName&quot;</span>);
            }
 
            <b>if</b> (<a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#61399100b6f1ba4c" class="i method">IsInitializationVectorPresent</a>(<span class="r11 r">fileName</span>))
            {
                <span class="r13 r">iv</span> = <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#66041c48d34208ac" class="i method">GetInitializationVectorForFile</a>(<span class="r11 r">fileName</span>);
            }
            <b>else</b>
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#eb98012a74461437" class="t constructor">ArgumentException</a>(<span class="s">$&quot;</span><span class="s">No initialization vector is present for </span>{<span class="r11 r">fileName</span>}<span class="s">.  Please add one using the SetInitializationVectorForFile method.</span><span class="s">&quot;</span>);
            }
 
            <b>return</b> <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#e8e40f4284ab6a67" class="i method">GetTransform</a>(<span class="r13 r">iv</span>, <span class="r12 r">fileOffset</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the file encryption transform.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">initializationVector</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The initialization vector.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The transform.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public</b> <a href="FileEncryptionTransform.cs.html#5de4e6373ccd7122" class="t t">FileEncryptionTransform</a> <a id="596d94e642982d5f" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTransform</a>(<b>ulong</b> <span id="r14 rd" class="r14 r">initializationVector</span>)
        {
            <b>return</b> <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#e8e40f4284ab6a67" class="i method">GetTransform</a>(<span class="r14 r">initializationVector</span>, 0);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the file encryption transform.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">initializationVector</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The initialization vector.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">fileOffset</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The file offset.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The transform.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public</b> <a href="FileEncryptionTransform.cs.html#5de4e6373ccd7122" class="t t">FileEncryptionTransform</a> <a id="e8e40f4284ab6a67" href="../R/e8e40f4284ab6a67.html" target="n" data-glyph="72,1" class="i method">GetTransform</a>(<b>ulong</b> <span id="r15 rd" class="r15 r">initializationVector</span>, <b>long</b> <span id="r16 rd" class="r16 r">fileOffset</span>)
        {
            <a href="@0@mscorlib/A.html#1580d78b8a5ac0c8" class="t t">ICryptoTransform</a> <span id="r17 rd" class="r17 r">transform</span> = <b>null</b>;
 
            <b>lock</b>(<a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#a57e87b2488701b1" class="i field">_lockObject</a>)
            {
                <span class="c">// Note that ECB encrypt is always used for AES-CTR whether doing encryption or decryption.</span>
                <span class="r17 r">transform</span> = <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#3a183904e17056c0" class="i field">_key</a>.<a href="@0@mscorlib/A.html#ecc386f5b1ba494d" class="i method">CreateEncryptor</a>();
            }
 
            <b>return</b> <b>new</b> <a href="FileEncryptionTransform.cs.html#b5d6a1959f1d539c" class="t constructor">FileEncryptionTransform</a>(<span class="r17 r">transform</span>, <span class="r15 r">initializationVector</span>, <span class="r16 r">fileOffset</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Performs application-defined tasks associated with freeing, releasing, or resetting unmanaged resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="617faa1d26b84e4d" href="../R/617faa1d26b84e4d.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#21b24cc60e06c14c" class="i method">Dispose</a>(<b>true</b>);
 
            <span class="c">// Take this object off the finalization queue and prevent the finalization</span>
            <span class="c">// code from running a second time.</span>
            <a href="@0@mscorlib/A.html#25d9c1e022317a99" class="t t">GC</a>.<a href="@0@mscorlib/A.html#2673f5220a565bf2" class="i method">SuppressFinalize</a>(<a href="#b5dceb0f2d3ac13a" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Releases unmanaged and - optionally - managed resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> to release both managed and unmanaged resources; </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> to release only unmanaged resources.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected virtual void</b> <a id="21b24cc60e06c14c" href="../R/21b24cc60e06c14c.html" target="n" data-glyph="75,1" class="i method">Dispose</a>(<b>bool</b> <span id="r18 rd" class="r18 r">disposing</span>)
        {
            <b>if</b> (<span class="r18 r">disposing</span>)
            {
                <b>if</b> (<a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#3a183904e17056c0" class="i field">_key</a> != <b>null</b>)
                {
                    <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#3a183904e17056c0" class="i field">_key</a>.<a href="@0@mscorlib/A.html#f98d3fdf9c55ca0c" class="i method">Dispose</a>();
                    <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#3a183904e17056c0" class="i field">_key</a> = <b>null</b>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Intializes this instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">contentKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The content key.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">keyIdentifier</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The key identifier.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="e4f083a368d915d7" href="../R/e4f083a368d915d7.html" target="n" data-glyph="76,1" class="i method">InternalInit</a>(<b>byte</b>[] <span id="r19 rd" class="r19 r">contentKey</span>, <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a> <span id="r20 rd" class="r20 r">keyIdentifier</span>)
        {
            <b>if</b> ((<span class="r19 r">contentKey</span> != <b>null</b>) &amp;&amp; (<span class="r19 r">contentKey</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> != <a href="#3a623ab858d9266f" class="i field">KeySizeInBytesForAes256</a>))
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#27138d3b17d5ff6b" class="t constructor">ArgumentOutOfRangeException</a>(<span class="s">&quot;contentKey&quot;</span>, <span class="s">&quot;StorageEncryption content keys are 256-bits in length.&quot;</span>);
            }
 
            <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#8626647e2094e3c4" class="i property">KeyIdentifier</a> = <span class="r20 r">keyIdentifier</span>;
 
            <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#3a183904e17056c0" class="i field">_key</a> = <a href="@0@mscorlib/A.html#ddb5f33f82818174" class="t t">Aes</a>.<a href="@0@mscorlib/A.html#f7c32038963e5062" class="i method">Create</a>();
            <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#3a183904e17056c0" class="i field">_key</a>.<a href="@0@mscorlib/A.html#32a109b1873cd140" class="i property">Mode</a> = <a href="@0@mscorlib/A.html#39e49c67cc43c846" class="t t">CipherMode</a>.<a href="@0@mscorlib/A.html#07e67bed5fcc275a" class="i field">ECB</a>;
            <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#3a183904e17056c0" class="i field">_key</a>.<a href="@0@mscorlib/A.html#5ed32cf1d4686f68" class="i property">Padding</a> = <a href="@0@mscorlib/A.html#78e6983a4b4595dc" class="t t">PaddingMode</a>.<a href="@0@mscorlib/A.html#fc70985b2abe8ddf" class="i field">None</a>;
            <b>if</b> (<span class="r19 r">contentKey</span> != <b>null</b>)
            {
                <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#3a183904e17056c0" class="i field">_key</a>.<a href="@0@mscorlib/A.html#d12a38c78f5c3174" class="i property">Key</a> = <span class="r19 r">contentKey</span>;
            }
            <b>else</b>
            {
                <a href="#b5dceb0f2d3ac13a" class="k">this</a>.<a href="#3a183904e17056c0" class="i field">_key</a>.<a href="@0@mscorlib/A.html#b0986bbe2e716b70" class="i property">KeySize</a> = <a href="#af6348efb0a78f94" class="i field">KeySizeInBitsForAes256</a>;
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
