<!DOCTYPE html>
<html><head><title>QueryTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(163);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Iot.Hub.Service.Tests/QueryTests.cs" target="_top">QueryTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Iot.Hub.Service.Tests" target="_top">Azure.Iot.Hub.Service.Tests.csproj</a> (Azure.Iot.Hub.Service.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Iot</span>.<span class="i n">Hub</span>.<span class="i n">Service</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">FluentAssertions</span>;
<b>using</b> <span class="i n">NUnit</span>.<span class="i n">Framework</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Iot</span>.<span class="i n">Hub</span>.<span class="i n">Service</span>.<span class="i n">Tests</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Test the query API. This API is a query on Twins only.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> All API calls are wrapped in a try catch block so we can clean up resources regardless of the test outcome.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
    <b>public class</b> <a id="baa1c115653232b9" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">QueryTests</a> : <a href="E2eTestBase.cs.html#d53765939fd1d5ae" class="t t">E2eTestBase</a>
    {
        <b>private const int</b> <a id="f2c5ce8c4bb00a8c" href="R/f2c5ce8c4bb00a8c.html" target="n" data-glyph="10,1" class="i field">_maxTryCount</a> = 10;
 
        <b>public</b> <a id="795fb8990aa5e391" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">QueryTests</a>(<b>bool</b> <span id="r0 rd" class="r0 r">isAsync</span>)
            : <a href="E2eTestBase.cs.html#3820a5dfb09a47ea" class="k">base</a>(<span class="r0 r">isAsync</span>)
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test querying all device twins in the IoTHub.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="107dc36db6cde3c9" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">QueryClient_GetAllDevicesTwinsWithTag</a>()
        {
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r1 rd" class="r1 r">testDeviceId</span> = <span class="s">$&quot;</span><span class="s">QueryDevice</span>{<a href="E2eTestBase.cs.html#6fd0e1ca80ce2587" class="i method">GetRandom</a>()}<span class="s">&quot;</span>;
 
            <a href="/Azure.Iot.Hub.Service/A.html#bc1a96485b297694" class="t t">DeviceIdentity</a> <span id="r2 rd" class="r2 r">device</span> = <b>null</b>;
            <a href="/Azure.Iot.Hub.Service/A.html#67c801a9737d6a9e" class="t t">IotHubServiceClient</a> <span id="r3 rd" class="r3 r">client</span> = <a href="E2eTestBase.cs.html#2364b25a51255cdc" class="i method">GetClient</a>();
 
            <b>try</b>
            {
                <span class="c">// Create a device.</span>
                <span class="r2 r">device</span> = (<b>await</b> <span class="r3 r">client</span>.<a href="/Azure.Iot.Hub.Service/A.html#85718ad4beb520f1" class="i property">Devices</a>
                    .<a href="/Azure.Iot.Hub.Service/A.html#d341dd739efdfb39" class="i method">CreateOrUpdateIdentityAsync</a>(
                        <b>new</b> <a href="/Azure.Iot.Hub.Service/A.html#c717c667fdd18fc2" class="t constructor">DeviceIdentity</a>
                        {
                            <a href="/Azure.Iot.Hub.Service/A.html#a4231de1934fea41" class="i property">DeviceId</a> = <span class="r1 r">testDeviceId</span>
                        })
                    .<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>))
                    .<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>;
 
                <b>int</b> <span id="r4 rd" class="r4 r">tryCount</span> = 0;
                <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r5 rd" class="r5 r">twinsFound</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="/Azure.Iot.Hub.Service/A.html#e0dbf6e06c8a474b" class="t t">TwinData</a>&gt;();
                <span class="c">// A new device may not return immediately from a query, so give it some time and some retries to appear.</span>
                <b>while</b> (<span class="r4 r">tryCount</span> &lt; <a href="#f2c5ce8c4bb00a8c" class="i field">_maxTryCount</a> &amp;&amp; !<span class="r5 r">twinsFound</span>.<a href="@0@System.Core/A.html#8788153112b7ffd0" class="i method">Any</a>())
                {
                    <span class="c">// Query for device twins with a specific tag.</span>
                    <a href="/Azure.Core/A.html#ce6e47443d11533b" class="t t">AsyncPageable</a>&lt;<a href="/Azure.Iot.Hub.Service/A.html#e0dbf6e06c8a474b" class="t t">TwinData</a>&gt; <span id="r6 rd" class="r6 r">queryResponse</span> = <span class="r3 r">client</span>.<a href="/Azure.Iot.Hub.Service/A.html#874dc997aed94e5b" class="i property">Query</a>.<a href="/Azure.Iot.Hub.Service/A.html#40dc01bf5585b614" class="i method">QueryAsync</a>(<span class="s">$&quot;</span><span class="s">SELECT * FROM devices WHERE deviceId = &#39;</span>{<span class="r1 r">testDeviceId</span>}<span class="s">&#39;</span><span class="s">&quot;</span>);
                    <b>await</b> <b>foreach</b> (<a href="/Azure.Iot.Hub.Service/A.html#e0dbf6e06c8a474b" class="t t">TwinData</a> <span id="r7 rd" class="r7 r">item</span> <b>in</b> <span class="r6 r">queryResponse</span>)
                    {
                        <span class="r5 r">twinsFound</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r7 r">item</span>);
                    }
 
                    <span class="r4 r">tryCount</span>++;
 
                    <span class="c">// Adding a delay to account for query cache sync.</span>
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(5)).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                }
 
                <span class="r5 r">twinsFound</span>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a>.<span class="i method">Should</span>().<span class="i method">Be</span>(1);
                <span class="r5 r">twinsFound</span>.<a href="@0@System.Core/A.html#bc8ae402a61dd9d6" class="i method">First</a>().<a href="/Azure.Iot.Hub.Service/A.html#09cb7aee1cc10c5f" class="i property">DeviceId</a>.<span class="i method">Should</span>().<span class="i method">Be</span>(<span class="r1 r">testDeviceId</span>);
 
                <span class="c">// Delete the device</span>
                <span class="c">// Deleting the device happens in the finally block as cleanup.</span>
            }
            <b>finally</b>
            {
                <b>await</b> <a href="#3063abcb91d57192" class="i method">CleanupAsync</a>(<span class="r3 r">client</span>, <span class="r2 r">device</span>).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test querying all module twins in the IoTHub.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="775a64746e11a768" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">QueryClient_GetAllModulesTwinsWithTag</a>()
        {
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r8 rd" class="r8 r">testDeviceId</span> = <span class="s">$&quot;</span><span class="s">QueryDevice</span>{<a href="E2eTestBase.cs.html#6fd0e1ca80ce2587" class="i method">GetRandom</a>()}<span class="s">&quot;</span>;
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r9 rd" class="r9 r">testModuleId</span> = <span class="s">$&quot;</span><span class="s">QueryModule</span>{<a href="E2eTestBase.cs.html#6fd0e1ca80ce2587" class="i method">GetRandom</a>()}<span class="s">&quot;</span>;
 
            <a href="/Azure.Iot.Hub.Service/A.html#bc1a96485b297694" class="t t">DeviceIdentity</a> <span id="r10 rd" class="r10 r">device</span> = <b>null</b>;
            <a href="/Azure.Iot.Hub.Service/A.html#67c801a9737d6a9e" class="t t">IotHubServiceClient</a> <span id="r11 rd" class="r11 r">client</span> = <a href="E2eTestBase.cs.html#2364b25a51255cdc" class="i method">GetClient</a>();
 
            <b>try</b>
            {
                <span class="c">// Create a device to house the module</span>
                <span class="r10 r">device</span> = (<b>await</b> <span class="r11 r">client</span>.<a href="/Azure.Iot.Hub.Service/A.html#85718ad4beb520f1" class="i property">Devices</a>
                    .<a href="/Azure.Iot.Hub.Service/A.html#d341dd739efdfb39" class="i method">CreateOrUpdateIdentityAsync</a>(
                        <b>new</b> <a href="/Azure.Iot.Hub.Service/A.html#c717c667fdd18fc2" class="t constructor">DeviceIdentity</a>
                        {
                            <a href="/Azure.Iot.Hub.Service/A.html#a4231de1934fea41" class="i property">DeviceId</a> = <span class="r8 r">testDeviceId</span>
                        })
                    .<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>))
                    .<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>;
 
                <span class="c">// Create a module on the device</span>
                <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="/Azure.Iot.Hub.Service/A.html#b2f1cba546c88e4e" class="t t">ModuleIdentity</a>&gt; <span id="r12 rd" class="r12 r">createResponse</span> = <b>await</b> <span class="r11 r">client</span>.<a href="/Azure.Iot.Hub.Service/A.html#e7605237731dc417" class="i property">Modules</a>
                    .<a href="/Azure.Iot.Hub.Service/A.html#0a6196e3512b72c4" class="i method">CreateOrUpdateIdentityAsync</a>(
                        <b>new</b> <a href="/Azure.Iot.Hub.Service/A.html#32073fd64f2a7b04" class="t constructor">ModuleIdentity</a>
                        {
                            <a href="/Azure.Iot.Hub.Service/A.html#2486450428f26697" class="i property">DeviceId</a> = <span class="r8 r">testDeviceId</span>,
                            <a href="/Azure.Iot.Hub.Service/A.html#8da9ceeb3ad6f5c3" class="i property">ModuleId</a> = <span class="r9 r">testModuleId</span>
                        })
                    .<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                <b>int</b> <span id="r13 rd" class="r13 r">tryCount</span> = 0;
                <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r14 rd" class="r14 r">twinsFound</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="/Azure.Iot.Hub.Service/A.html#e0dbf6e06c8a474b" class="t t">TwinData</a>&gt;();
                <span class="c">// A new device may not return immediately from a query, so give it some time and some retries to appear.</span>
                <b>while</b> (<span class="r13 r">tryCount</span> &lt; <a href="#f2c5ce8c4bb00a8c" class="i field">_maxTryCount</a> &amp;&amp; !<span class="r14 r">twinsFound</span>.<a href="@0@System.Core/A.html#8788153112b7ffd0" class="i method">Any</a>())
                {
                    <span class="c">// Query for module twins with a specific tag.</span>
                    <a href="/Azure.Core/A.html#ce6e47443d11533b" class="t t">AsyncPageable</a>&lt;<a href="/Azure.Iot.Hub.Service/A.html#e0dbf6e06c8a474b" class="t t">TwinData</a>&gt; <span id="r15 rd" class="r15 r">queryResponse</span> = <span class="r11 r">client</span>.<a href="/Azure.Iot.Hub.Service/A.html#874dc997aed94e5b" class="i property">Query</a>.<a href="/Azure.Iot.Hub.Service/A.html#40dc01bf5585b614" class="i method">QueryAsync</a>(<span class="s">$&quot;</span><span class="s">SELECT * FROM devices.modules WHERE moduleId = &#39;</span>{<span class="r9 r">testModuleId</span>}<span class="s">&#39;</span><span class="s">&quot;</span>);
                    <b>await</b> <b>foreach</b> (<a href="/Azure.Iot.Hub.Service/A.html#e0dbf6e06c8a474b" class="t t">TwinData</a> <span id="r16 rd" class="r16 r">item</span> <b>in</b> <span class="r15 r">queryResponse</span>)
                    {
                        <span class="r14 r">twinsFound</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r16 r">item</span>);
                    }
 
                    <span class="r13 r">tryCount</span>++;
 
                    <span class="c">// Adding a delay to account for query cache sync.</span>
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#87a671fb5b9b4384" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(5)).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                }
 
                <span class="r14 r">twinsFound</span>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a>.<span class="i method">Should</span>().<span class="i method">Be</span>(1);
                <span class="r14 r">twinsFound</span>.<a href="@0@System.Core/A.html#bc8ae402a61dd9d6" class="i method">First</a>().<a href="/Azure.Iot.Hub.Service/A.html#a3d17aa6c42f7c84" class="i property">ModuleId</a>.<span class="i method">Should</span>().<span class="i method">Be</span>(<span class="r9 r">testModuleId</span>);
 
                <span class="c">// Delete the device</span>
                <span class="c">// Deleting the device happens in the finally block as cleanup.</span>
            }
            <b>finally</b>
            {
                <b>await</b> <a href="#3063abcb91d57192" class="i method">CleanupAsync</a>(<span class="r11 r">client</span>, <span class="r10 r">device</span>).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="3063abcb91d57192" href="R/3063abcb91d57192.html" target="n" data-glyph="76,1" class="i method">CleanupAsync</a>(<a href="/Azure.Iot.Hub.Service/A.html#67c801a9737d6a9e" class="t t">IotHubServiceClient</a> <span id="r17 rd" class="r17 r">client</span>, <a href="/Azure.Iot.Hub.Service/A.html#bc1a96485b297694" class="t t">DeviceIdentity</a> <span id="r18 rd" class="r18 r">device</span>)
        {
            <span class="c">// cleanup</span>
            <b>try</b>
            {
                <b>if</b> (<span class="r18 r">device</span> != <b>null</b>)
                {
                    <b>await</b> <span class="r17 r">client</span>.<a href="/Azure.Iot.Hub.Service/A.html#85718ad4beb520f1" class="i property">Devices</a>.<a href="/Azure.Iot.Hub.Service/A.html#ca52cb4ff106f3b0" class="i method">DeleteIdentityAsync</a>(<span class="r18 r">device</span>, <a href="/Azure.Iot.Hub.Service/A.html#30f5053b90113e47" class="t t">IfMatchPrecondition</a>.<a href="/Azure.Iot.Hub.Service/A.html#2faf7a83682d9334" class="i field">UnconditionalIfMatch</a>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
                }
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r19 rd" class="r19 r">ex</span>)
            {
                <span class="t t">Assert</span>.<span class="i method">Fail</span>(<span class="s">$&quot;</span><span class="s">Test clean up failed: </span>{<span class="r19 r">ex</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>}<span class="s">&quot;</span>);
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
