<!DOCTYPE html>
<html><head><title>TransferMetadata.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(602);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Management.DataLake.Store/Customizations/DataTransfer/Common/TransferMetadata.cs" target="_top">Customizations\DataTransfer\Common\TransferMetadata.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Management.DataLake.Store" target="_top">Microsoft.Azure.Management.DataLake.Store.csproj</a> (Microsoft.Azure.Management.DataLake.Store)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
<b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>;
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Runtime</span>.<span class="i n">Serialization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Xml</span>.<span class="i n">Serialization</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">DataLake</span>.<span class="i n">Store</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Represents general metadata pertaining to an transfer.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<a href="@0@mscorlib/A.html#761078d4519dc54e" class="t constructor">DebuggerDisplay</a>(<span class="s">&quot;Segments = {SegmentCount}, SegmentLength = {SegmentLength}, TransferId = {TransferId}, FileLength = {FileLength}, FilePath = {FilePath}, EncodingCodePage = {EncodingCodePage}, Delimiter = {Delimiter}&quot;</span>)]
    <b>public class</b> <a id="3c08d873a58fc637" href="../../../R/3c08d873a58fc637.html" target="n" data-glyph="0,0" class="t t">TransferMetadata</a>
    {
        
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private
 
        <b>private static readonly</b> <span class="i">JsonSerializer</span> <a id="96d7ce6f9648f4d3" href="../../../R/96d7ce6f9648f4d3.html" target="n" data-glyph="46,1" class="i field">MetadataSerializer</a> = <b>new</b> <span class="i">JsonSerializer</span>();
        <b>private static readonly object</b> <a id="f41085446c1fb49a" href="../../../R/f41085446c1fb49a.html" target="n" data-glyph="46,1" class="i field">SaveSync</a> = <b>new</b> <b>object</b>();
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructor
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Required by JsonSerializer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">JsonConstructor</span>]
        <b>internal</b> <a id="751c5c09f5726119" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="t constructor">TransferMetadata</a>()
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructs a new TransferMetadata from the given parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">metadataFilePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The file path to assign to this metadata file (for saving purposes).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">transferParameters</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The parameters to use for constructing this metadata.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">frontEnd</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The front end. This is used only in the constructor for determining file length</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="4f6ab963e7073440" href="../../../R/4f6ab963e7073440.html" target="n" data-glyph="74,1" class="t constructor">TransferMetadata</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r0 rd" class="r0 r">metadataFilePath</span>, <a href="TransferParameters.cs.html#9d54476a1d8187dd" class="t t">TransferParameters</a> <span id="r1 rd" class="r1 r">transferParameters</span>, <a href="IFrontEndAdapter.cs.html#d503d7a60084fa22" class="t t">IFrontEndAdapter</a> <span id="r2 rd" class="r2 r">frontEnd</span>, <b>long</b> <span id="r3 rd" class="r3 r">fileSize</span> = -1)
        {
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#ba793ae1940ac477" class="i property">MetadataFilePath</a> = <span class="r0 r">metadataFilePath</span>;
           
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#94ead8daa60a5847" class="i property">TransferId</a> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#8015cb30da6ca742" class="i method">ToString</a>(<span class="s">&quot;N&quot;</span>);
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#190138f2a84df06b" class="i property">InputFilePath</a> = <span class="r1 r">transferParameters</span>.<a href="TransferParameters.cs.html#13433c7d7aa99dc0" class="i property">InputFilePath</a>;
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#fdcb0ca156a2a7cb" class="i property">TargetStreamPath</a> = <span class="r1 r">transferParameters</span>.<a href="TransferParameters.cs.html#71c8ba3b11d5aeee" class="i property">TargetStreamPath</a>;
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#bff991c0ada527f8" class="i property">IsDownload</a> = <span class="r1 r">transferParameters</span>.<a href="TransferParameters.cs.html#a8e3927f643da125" class="i property">IsDownload</a>;
 
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#cacb71b2d39d682c" class="i property">SegmentStreamDirectory</a> = <a href="#49208d6a6859bbf4" class="i method">GetSegmentStreamDirectory</a>();
 
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#ffdbb867506e256b" class="i property">IsBinary</a> = <span class="r1 r">transferParameters</span>.<a href="TransferParameters.cs.html#ebfa48b5610ab87e" class="i property">IsBinary</a>;
 
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#c2f4b2ebd90b6cb3" class="i property">FileLength</a> = <span class="r3 r">fileSize</span> &lt; 0 ? <span class="r2 r">frontEnd</span>.<a href="IFrontEndAdapter.cs.html#84a396ab34116429" class="i method">GetStreamLength</a>(<span class="r1 r">transferParameters</span>.<a href="TransferParameters.cs.html#13433c7d7aa99dc0" class="i property">InputFilePath</a>, !<a href="#bff991c0ada527f8" class="i property">IsDownload</a>) : <span class="r3 r">fileSize</span>;
 
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#7c9968d38fc350f1" class="i property">EncodingCodePage</a> = <span class="r1 r">transferParameters</span>.<a href="TransferParameters.cs.html#1cb8cd7c6d8ddd6a" class="i property">FileEncoding</a>.<a href="@0@mscorlib/A.html#1e599edcae1cf995" class="i property">CodePage</a>;
 
            <span class="c">// we are taking the smaller number of segments between segment lengths of 256 and the segment growth logic.</span>
            <span class="c">// this protects us against agressive increase of thread count resulting in far more segments than</span>
            <span class="c">// is reasonable for a given file size. We also ensure that each segment is at least 256mb in size.</span>
            <span class="c">// This is the size that ensures we have the optimal storage creation in the store.</span>
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r4 rd" class="r4 r">preliminarySegmentCount</span> = (<b>int</b>)<a href="@0@mscorlib/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@0@mscorlib/A.html#1841a5ce24ed9fb3" class="i method">Ceiling</a>((<b>double</b>)<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#c2f4b2ebd90b6cb3" class="i property">FileLength</a> / <span class="r1 r">transferParameters</span>.<a href="TransferParameters.cs.html#c51c389eb8642a8c" class="i property">MaxSegementLength</a>);
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#9131b8fdd074a557" class="i property">SegmentCount</a> = <a href="@0@mscorlib/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@0@mscorlib/A.html#f441d55c88d635ad" class="i method">Min</a>(<span class="r4 r">preliminarySegmentCount</span>, <a href="TransferSegmentMetadata.cs.html#4a50ebae0a9351d2" class="t t">TransferSegmentMetadata</a>.<a href="TransferSegmentMetadata.cs.html#8f2f9bd27552bc57" class="i method">CalculateSegmentCount</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#c2f4b2ebd90b6cb3" class="i property">FileLength</a>));
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#3409e7af196dbe90" class="i property">SegmentLength</a> = <a href="TransferSegmentMetadata.cs.html#4a50ebae0a9351d2" class="t t">TransferSegmentMetadata</a>.<a href="TransferSegmentMetadata.cs.html#0a3d612acfd85def" class="i method">CalculateSegmentLength</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#c2f4b2ebd90b6cb3" class="i property">FileLength</a>, <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#9131b8fdd074a557" class="i property">SegmentCount</a>);
 
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#982540b694e3af39" class="i property">Segments</a> = <b>new</b> <a href="TransferSegmentMetadata.cs.html#4a50ebae0a9351d2" class="t t">TransferSegmentMetadata</a>[<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#9131b8fdd074a557" class="i property">SegmentCount</a>];
            <b>for</b> (<b>int</b> <span id="r5 rd" class="r5 r">i</span> = 0; <span class="r5 r">i</span> &lt; <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#9131b8fdd074a557" class="i property">SegmentCount</a>; <span class="r5 r">i</span>++)
            {
                <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#982540b694e3af39" class="i property">Segments</a>[<span class="r5 r">i</span>] = <b>new</b> <a href="TransferSegmentMetadata.cs.html#55afc598cadfacc0" class="t constructor">TransferSegmentMetadata</a>(<span class="r5 r">i</span>, <a href="#3c08d873a58fc637" class="k">this</a>);
            }
 
            <b>if</b> (!<span class="r1 r">transferParameters</span>.<a href="TransferParameters.cs.html#ebfa48b5610ab87e" class="i property">IsBinary</a> &amp;&amp; <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#9131b8fdd074a557" class="i property">SegmentCount</a> &gt; 1 &amp;&amp; !<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#bff991c0ada527f8" class="i property">IsDownload</a>)
            {
                <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#ad88d9175027878e" class="i method">AlignSegmentsToRecordBoundaries</a>();
                
                <span class="c">// ensure that nothing strange happened during alignment</span>
                <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#aa80bf2889ef06fc" class="i method">ValidateConsistency</a>();
            }
 
            <span class="c">// initialize the status to pending, since it is not yet done.</span>
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#a9be239c5fd0d8d5" class="i property">Status</a> = <a href="SegmentTransferStatus.cs.html#f871cd80cd9814cc" class="t t">SegmentTransferStatus</a>.<a href="SegmentTransferStatus.cs.html#e8c6f082f267929a" class="i field">Pending</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a value indicating the unique identifier associated with this transfer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The transfer identifier.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;TransferId&quot;</span>)]
        <b>public string</b> <a id="94ead8daa60a5847" href="../../../R/94ead8daa60a5847.html" target="n" data-glyph="102,1" class="i property">TransferId</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> /Gets or sets a value indicating the full path to the file to be transferred.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The input file path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;InputFilePath&quot;</span>)]
        <b>public string</b> <a id="190138f2a84df06b" href="../../../R/190138f2a84df06b.html" target="n" data-glyph="102,1" class="i property">InputFilePath</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a value indicating the length (in bytes) of the file to be transferred.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The length of the file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;FileLength&quot;</span>)]
        <b>public long</b> <a id="c2f4b2ebd90b6cb3" href="../../../R/c2f4b2ebd90b6cb3.html" target="n" data-glyph="102,1" class="i property">FileLength</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a value indicating the full stream path where the file will be transferred to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The target stream path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;TargetStreamPath&quot;</span>)]
        <b>public string</b> <a id="fdcb0ca156a2a7cb" href="../../../R/fdcb0ca156a2a7cb.html" target="n" data-glyph="102,1" class="i property">TargetStreamPath</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a value indicating the directory path where intermediate segment streams will be stored.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The target stream path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;SegmentStreamDirectory&quot;</span>)]
        <b>public string</b> <a id="cacb71b2d39d682c" href="../../../R/cacb71b2d39d682c.html" target="n" data-glyph="102,1" class="i property">SegmentStreamDirectory</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a value indicating the number of segments this file is split into for purposes of transfering it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The segment count.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;SegmentCount&quot;</span>)]
        <b>public int</b> <a id="9131b8fdd074a557" href="../../../R/9131b8fdd074a557.html" target="n" data-glyph="102,1" class="i property">SegmentCount</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a value indicating the length (in bytes) of each segment of the file (except the last one, which may be less).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The length of the segment.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;SegmentLength&quot;</span>)]
        <b>public long</b> <a id="3409e7af196dbe90" href="../../../R/3409e7af196dbe90.html" target="n" data-glyph="102,1" class="i property">SegmentLength</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a pointer to an array of segment metadata. The segments are ordered by their segment number (sequence).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The segments.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;Segments&quot;</span>)]
        <b>public</b> <a href="TransferSegmentMetadata.cs.html#4a50ebae0a9351d2" class="t t">TransferSegmentMetadata</a>[] <a id="982540b694e3af39" href="../../../R/982540b694e3af39.html" target="n" data-glyph="102,1" class="i property">Segments</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a value indicating whether the transfer file should be treated as a binary file or not.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if this instance is binary; otherwise, </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;IsBinary&quot;</span>)]
        <b>public bool</b> <a id="ffdbb867506e256b" href="../../../R/ffdbb867506e256b.html" target="n" data-glyph="102,1" class="i property">IsBinary</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a value indicating whether this instance is a download instead of an transfer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if this instance is download; otherwise, </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;IsDownload&quot;</span>)]
        <b>public bool</b> <a id="bff991c0ada527f8" href="../../../R/bff991c0ada527f8.html" target="n" data-glyph="102,1" class="i property">IsDownload</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the CodePage of the current encoding being used.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">  The CodePage of the current encoding.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;EncodingCodePage&quot;</span>)]
        <b>public int</b> <a id="7c9968d38fc350f1" href="../../../R/7c9968d38fc350f1.html" target="n" data-glyph="102,1" class="i property">EncodingCodePage</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a value indicating the record boundary delimiter for the file, if any.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The record boundary delimiter</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;Delimiter&quot;</span>)]
        <b>public string</b> <a id="8e7f770985aedd51" href="../../../R/8e7f770985aedd51.html" target="n" data-glyph="102,1" class="i property">Delimiter</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a value indicating the current transfer status for this file transfer.</span>
        <span class="c">///</span><span class="c"> This value is checked for folder transfer progress and resuming. </span>
        <span class="c">///</span><span class="c"> Single file transfers use segment status for tracking.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The status.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;Status&quot;</span>)]
        <b>public</b> <a href="SegmentTransferStatus.cs.html#f871cd80cd9814cc" class="t t">SegmentTransferStatus</a> <a id="a9be239c5fd0d8d5" href="../../../R/a9be239c5fd0d8d5.html" target="n" data-glyph="102,1" class="i property">Status</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a value indicating the path where this metadata file is located.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The metadata file path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>internal string</b> <a id="ba793ae1940ac477" href="../../../R/ba793ae1940ac477.html" target="n" data-glyph="104,1" class="i property">MetadataFilePath</a> { <b>get</b>; <b>set</b>; }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> File Operations
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Attempts to load an TransferMetadata object from the given file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">filePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The full path to the file where to load the metadata from</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">IO</span>.<a href="@0@mscorlib/A.html#fd582974d1f75ac7" class="t t">FileNotFoundException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Could not find metadata file</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">DataLake</span>.<span class="i n">Store</span>.<a href="InvalidMetadataException.cs.html#9dfcbe20582bb796" class="t t">InvalidMetadataException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Unable to parse metadata file</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="#3c08d873a58fc637" class="t t">TransferMetadata</a> <a id="d1999552eaeca1b2" href="../../../R/d1999552eaeca1b2.html" target="n" data-glyph="74,1" class="i method">LoadFrom</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r6 rd" class="r6 r">filePath</span>)
        {
            <b>if</b> (!<a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#3360368484a9f131" class="i method">Exists</a>(<span class="r6 r">filePath</span>))
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#e49034af96bf20b2" class="t constructor">FileNotFoundException</a>(<span class="s">&quot;Could not find metadata file&quot;</span>, <span class="r6 r">filePath</span>);
            }
 
            <b>try</b>
            {
                <b>using</b> (<a href="@0@mscorlib/A.html#b5fe1efcec14de32" class="t t">StreamReader</a> <span id="r7 rd" class="r7 r">stream</span> = <b>new</b> <a href="@0@mscorlib/A.html#72447927169f6b77" class="t constructor">StreamReader</a>(<b>new</b> <a href="@0@mscorlib/A.html#756b978acfa47bc7" class="t constructor">FileStream</a>(<span class="r6 r">filePath</span>, <a href="@0@mscorlib/A.html#c0cb6ba6af625b3a" class="t t">FileMode</a>.<a href="@0@mscorlib/A.html#f4421e1d202f76fa" class="i field">Open</a>, <a href="@0@mscorlib/A.html#5cc5644ae3acd24b" class="t t">FileAccess</a>.<a href="@0@mscorlib/A.html#0f1c68c756d0636b" class="i field">Read</a>, <a href="@0@mscorlib/A.html#2bfafb4d44a4f126" class="t t">FileShare</a>.<a href="@0@mscorlib/A.html#581aa2ff4e59056b" class="i field">Read</a>)))
                {
                    <a href="#3c08d873a58fc637" class="k">var</a> <span id="r8 rd" class="r8 r">result</span> = <a href="#96d7ce6f9648f4d3" class="i field">MetadataSerializer</a>.<span class="i">Deserialize</span>(<span class="r7 r">stream</span>, <b>typeof</b>(<a href="#3c08d873a58fc637" class="t t">TransferMetadata</a>)) <b>as</b> <a href="#3c08d873a58fc637" class="t t">TransferMetadata</a>;
                    <b>if</b> (<span class="r8 r">result</span> != <b>null</b>)
                    {
                        <span class="r8 r">result</span>.<a href="#ba793ae1940ac477" class="i property">MetadataFilePath</a> = <span class="r6 r">filePath</span>;
                    }
 
                    <b>return</b> <span class="r8 r">result</span>;
                }
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r9 rd" class="r9 r">ex</span>)
            {
                <b>throw</b> <b>new</b> <a href="InvalidMetadataException.cs.html#31c4192a650b4c6f" class="t constructor">InvalidMetadataException</a>(<span class="s">&quot;Unable to parse metadata file&quot;</span>, <span class="r9 r">ex</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Saves the given metadata to its canonical location. This method is thread-safe.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="f0e950a431f9279e" href="../../../R/f0e950a431f9279e.html" target="n" data-glyph="74,1" class="i method">Save</a>()
        {
            <b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#ba793ae1940ac477" class="i property">MetadataFilePath</a>))
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">&quot;Null or empty MetadataFilePath. Cannot save metadata until this property is set.&quot;</span>);
            }
 
            <span class="c">//quick check to ensure that the metadata we constructed is sane</span>
            <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#aa80bf2889ef06fc" class="i method">ValidateConsistency</a>();
 
            <b>lock</b> (<a href="#f41085446c1fb49a" class="i field">SaveSync</a>)
            {
                <b>if</b> (<a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#3360368484a9f131" class="i method">Exists</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#ba793ae1940ac477" class="i property">MetadataFilePath</a>))
                {
                    <a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#c4e7406e837331d5" class="i method">Delete</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#ba793ae1940ac477" class="i property">MetadataFilePath</a>);
                }
 
                <b>using</b> (<a href="@0@mscorlib/A.html#9e38cb1c84769eba" class="k">var</a> <span id="r10 rd" class="r10 r">stream</span> = <b>new</b> <a href="@0@mscorlib/A.html#c73af21c3340883d" class="t constructor">StreamWriter</a>(<b>new</b> <a href="@0@mscorlib/A.html#756b978acfa47bc7" class="t constructor">FileStream</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#ba793ae1940ac477" class="i property">MetadataFilePath</a>, <a href="@0@mscorlib/A.html#c0cb6ba6af625b3a" class="t t">FileMode</a>.<a href="@0@mscorlib/A.html#17684d43e30dc120" class="i field">Create</a>, <a href="@0@mscorlib/A.html#5cc5644ae3acd24b" class="t t">FileAccess</a>.<a href="@0@mscorlib/A.html#4715fa16da583c25" class="i field">Write</a>, <a href="@0@mscorlib/A.html#2bfafb4d44a4f126" class="t t">FileShare</a>.<a href="@0@mscorlib/A.html#4b58afdb477c6bbe" class="i field">None</a>)))
                {
                    <a href="#96d7ce6f9648f4d3" class="i field">MetadataSerializer</a>.<span class="i">Serialize</span>(<span class="r10 r">stream</span>, <a href="#3c08d873a58fc637" class="k">this</a>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Deletes the metadata file from disk.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<a href="@0@mscorlib/A.html#beac22dfca574cd4" class="t t">InvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Null or empty MetadataFilePath. Cannot delete metadata until this property is set.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public void</b> <a id="8df9131a57201660" href="../../../R/8df9131a57201660.html" target="n" data-glyph="72,1" class="i method">DeleteFile</a>()
        {
            <b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#ba793ae1940ac477" class="i property">MetadataFilePath</a>))
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">&quot;Null or empty MetadataFilePath. Cannot delete metadata until this property is set.&quot;</span>);
            }
 
            <b>if</b> (<a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#3360368484a9f131" class="i method">Exists</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#ba793ae1940ac477" class="i property">MetadataFilePath</a>))
            {
                <a href="@0@mscorlib/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@0@mscorlib/A.html#c4e7406e837331d5" class="i method">Delete</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#ba793ae1940ac477" class="i property">MetadataFilePath</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Verifies the given metadata for consistency. Checks include:</span>
        <span class="c">///</span><span class="c"> * Completeness</span>
        <span class="c">///</span><span class="c"> * Existence and consistency with local file</span>
        <span class="c">///</span><span class="c"> * Segment data consistency</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="aa80bf2889ef06fc" href="../../../R/aa80bf2889ef06fc.html" target="n" data-glyph="74,1" class="i method">ValidateConsistency</a>()
        {
            <b>if</b> (<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#982540b694e3af39" class="i property">Segments</a> == <b>null</b> || <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#982540b694e3af39" class="i property">Segments</a>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> != <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#9131b8fdd074a557" class="i property">SegmentCount</a>)
            {
                <b>throw</b> <b>new</b> <a href="InvalidMetadataException.cs.html#e32fd5e363519e9f" class="t constructor">InvalidMetadataException</a>(<span class="s">&quot;Inconsistent number of segments&quot;</span>);
            }
 
            <b>long</b> <span id="r11 rd" class="r11 r">sum</span> = 0;
            <b>int</b> <span id="r12 rd" class="r12 r">lastSegmentNumber</span> = -1;
            <a href="@0@mscorlib/A.html#19ad3f494f0dc7f6" class="k">var</a> <span id="r13 rd" class="r13 r">segments</span> = <b>new</b> <a href="@0@mscorlib/A.html#e69bd3d92b1bf17a" class="t constructor">BitArray</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#9131b8fdd074a557" class="i property">SegmentCount</a>);
 
            <b>foreach</b> (<a href="TransferSegmentMetadata.cs.html#4a50ebae0a9351d2" class="k">var</a> <span id="r14 rd" class="r14 r">segment</span> <b>in</b> <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#982540b694e3af39" class="i property">Segments</a>)
            {
                <b>if</b> (<span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a> &lt; 0 || <span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a> &gt;= <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#9131b8fdd074a557" class="i property">SegmentCount</a>)
                {
                    <b>throw</b> <b>new</b> <a href="InvalidMetadataException.cs.html#e32fd5e363519e9f" class="t constructor">InvalidMetadataException</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#7432dab173fae5fc" class="i method">Format</a>(<span class="s">&quot;Segment numbers must be at least 0 and less than {0}. Found segment number {1}.&quot;</span>, <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#9131b8fdd074a557" class="i property">SegmentCount</a>, <span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a>));
                }
 
                <b>if</b> (<span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a> &lt;= <span class="r12 r">lastSegmentNumber</span>)
                {
                    <b>throw</b> <b>new</b> <a href="InvalidMetadataException.cs.html#e32fd5e363519e9f" class="t constructor">InvalidMetadataException</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#9d5604d4425b216f" class="i method">Format</a>(<span class="s">&quot;Segment number {0} appears out of order.&quot;</span>, <span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a>));
                }
 
                <b>if</b> (<span class="r13 r">segments</span><a href="@0@mscorlib/A.html#b54e22f64bfc473e">[</a><span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a>])
                {
                    <b>throw</b> <b>new</b> <a href="InvalidMetadataException.cs.html#e32fd5e363519e9f" class="t constructor">InvalidMetadataException</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#9d5604d4425b216f" class="i method">Format</a>(<span class="s">&quot;Segment number {0} appears twice&quot;</span>, <span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a>));
                }
 
                <b>if</b> (<span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#df08bf689d04aaad" class="i property">Offset</a> != <span class="r11 r">sum</span>)
                {
                    <b>throw</b> <b>new</b> <a href="InvalidMetadataException.cs.html#e32fd5e363519e9f" class="t constructor">InvalidMetadataException</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#6e5f254563fed78e" class="i method">Format</a>(<span class="s">&quot;Segment number {0} has an invalid starting offset ({1}). Expected {2}.&quot;</span>, <span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a>, <span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#df08bf689d04aaad" class="i property">Offset</a>, <span class="r11 r">sum</span>));
                }
 
                <span class="r13 r">segments</span><a href="@0@mscorlib/A.html#b54e22f64bfc473e">[</a><span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a>] = <b>true</b>;
                <span class="r11 r">sum</span> += <span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#d35d9c4278e3e239" class="i property">Length</a>;
                <span class="r12 r">lastSegmentNumber</span> = <span class="r14 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a>;
            }
 
            <b>if</b> (<span class="r11 r">sum</span> != <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#c2f4b2ebd90b6cb3" class="i property">FileLength</a>)
            {
                <b>throw</b> <b>new</b> <a href="InvalidMetadataException.cs.html#e32fd5e363519e9f" class="t constructor">InvalidMetadataException</a>(<span class="s">&quot;The individual segment lengths do not add up to the input File Length&quot;</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Splits the target stream path, returning the name of the stream and storing the full directory path (if any) in an out variable.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">targetStreamDirectory</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The target stream directory, or null of the stream is at the root.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal string</b> <a id="1b91f3ca2f8a399b" href="../../../R/1b91f3ca2f8a399b.html" target="n" data-glyph="74,1" class="i method">SplitTargetStreamPathByName</a>(<b>out string</b> <span id="r15 rd" class="r15 r">targetStreamDirectory</span>)
        {
            <b>if</b> (<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#bff991c0ada527f8" class="i property">IsDownload</a>)
            {
                <span class="r15 r">targetStreamDirectory</span> = <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#f9128b02ffd0d3ea" class="i method">GetDirectoryName</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#fdcb0ca156a2a7cb" class="i property">TargetStreamPath</a>);
                <b>return</b> <a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#95facc58d06cadd0" class="i method">GetFileName</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#fdcb0ca156a2a7cb" class="i property">TargetStreamPath</a>);
            }
            <b>else</b>
            {
                <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r16 rd" class="r16 r">numFoldersInPath</span> = <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#fdcb0ca156a2a7cb" class="i property">TargetStreamPath</a>.<a href="@0@mscorlib/A.html#1c4a9dc78ba38999" class="i method">Split</a>(<span class="s">&#39;/&#39;</span>).<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>;
                <b>if</b> (<span class="r16 r">numFoldersInPath</span> - 1 == 0 || (<span class="r16 r">numFoldersInPath</span> - 1 == 1 &amp;&amp; <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#fdcb0ca156a2a7cb" class="i property">TargetStreamPath</a>.<a href="@0@mscorlib/A.html#23804789ea4c9c0e" class="i method">StartsWith</a>(<span class="s">&quot;/&quot;</span>)))
                {
                    <span class="c">// the scenario where the file is being transferred at the root</span>
                    <span class="r15 r">targetStreamDirectory</span> = <b>null</b>;
                    <b>return</b> <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#fdcb0ca156a2a7cb" class="i property">TargetStreamPath</a>.<a href="@0@mscorlib/A.html#5137a6065a1c1234" class="i method">TrimStart</a>(<span class="s">&#39;/&#39;</span>);
                }
                <b>else</b>
                {
                    <span class="c">// the scenario where the file is being transferred in a sub folder</span>
                    <span class="r15 r">targetStreamDirectory</span> = <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#fdcb0ca156a2a7cb" class="i property">TargetStreamPath</a>.<a href="@0@mscorlib/A.html#8124961f027d9ac9" class="i method">Substring</a>(0,
                        <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#fdcb0ca156a2a7cb" class="i property">TargetStreamPath</a>.<a href="@0@mscorlib/A.html#43ea090a2243545e" class="i method">LastIndexOf</a>(<span class="s">&#39;/&#39;</span>));
                    <b>return</b> <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#fdcb0ca156a2a7cb" class="i property">TargetStreamPath</a>.<a href="@0@mscorlib/A.html#882fa7998d6ca35a" class="i method">Substring</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#fdcb0ca156a2a7cb" class="i property">TargetStreamPath</a>.<a href="@0@mscorlib/A.html#43ea090a2243545e" class="i method">LastIndexOf</a>(<span class="s">&#39;/&#39;</span>) + 1);
                }
            }
        }
 
 
        <b>internal string</b> <a id="49208d6a6859bbf4" href="../../../R/49208d6a6859bbf4.html" target="n" data-glyph="74,1" class="i method">GetSegmentStreamDirectory</a>()
        {
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r17 rd" class="r17 r">streamDirectory</span>;
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r18 rd" class="r18 r">streamName</span> = <a href="#1b91f3ca2f8a399b" class="i method">SplitTargetStreamPathByName</a>(<b>out</b> <span class="r17 r">streamDirectory</span>);
 
            <b>if</b>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#bff991c0ada527f8" class="i property">IsDownload</a>)
            {
                <span class="c">// for downloads, there is always a &quot;folder&quot; (such as &#39;C:\&#39;).</span>
                <b>return</b> <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#6e5f254563fed78e" class="i method">Format</a>(<span class="s">@&quot;{0}\{1}.segments.{2}&quot;</span>,
                    <span class="r17 r">streamDirectory</span>,
                    <span class="r18 r">streamName</span>, <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>());
            }
            <b>else</b>
            {
                <b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r17 r">streamDirectory</span>))
                {
                    <span class="c">// the scenario where the file is being transferred at the root</span>
                    <b>return</b> <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#7432dab173fae5fc" class="i method">Format</a>(<span class="s">&quot;/{0}.segments.{1}&quot;</span>, <span class="r18 r">streamName</span>, <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>());
                }
                <b>else</b>
                {
                    <span class="c">// the scenario where the file is being transferred in a sub folder</span>
                    <b>return</b> <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#6e5f254563fed78e" class="i method">Format</a>(<span class="s">&quot;{0}/{1}.segments.{2}&quot;</span>,
                        <span class="r17 r">streamDirectory</span>,
                        <span class="r18 r">streamName</span>, <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>());
                }
            }
            
        }
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Aligns segments to match record boundaries (where a record boundary = a new line).</span>
        <span class="c">///</span><span class="c"> If not possible (max record size = 4MB), throws an exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="ad88d9175027878e" href="../../../R/ad88d9175027878e.html" target="n" data-glyph="76,1" class="i method">AlignSegmentsToRecordBoundaries</a>()
        {
            <b>int</b> <span id="r19 rd" class="r19 r">remainingSegments</span> = 0;
 
            <b>using</b> (<a href="@0@mscorlib/A.html#e23a38af5d11ddd3" class="k">var</a> <span id="r20 rd" class="r20 r">stream</span> = <b>new</b> <a href="@0@mscorlib/A.html#756b978acfa47bc7" class="t constructor">FileStream</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#190138f2a84df06b" class="i property">InputFilePath</a>, <a href="@0@mscorlib/A.html#c0cb6ba6af625b3a" class="t t">FileMode</a>.<a href="@0@mscorlib/A.html#f4421e1d202f76fa" class="i field">Open</a>, <a href="@0@mscorlib/A.html#5cc5644ae3acd24b" class="t t">FileAccess</a>.<a href="@0@mscorlib/A.html#0f1c68c756d0636b" class="i field">Read</a>, <a href="@0@mscorlib/A.html#2bfafb4d44a4f126" class="t t">FileShare</a>.<a href="@0@mscorlib/A.html#581aa2ff4e59056b" class="i field">Read</a>))
            {
                <b>long</b> <span id="r21 rd" class="r21 r">offset</span> = 0;
                <b>for</b> (<b>int</b> <span id="r22 rd" class="r22 r">i</span> = 0; <span class="r22 r">i</span> &lt; <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#982540b694e3af39" class="i property">Segments</a>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>; <span class="r22 r">i</span>++)
                {
                    <a href="TransferSegmentMetadata.cs.html#4a50ebae0a9351d2" class="k">var</a> <span id="r23 rd" class="r23 r">segment</span> = <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#982540b694e3af39" class="i property">Segments</a>[<span class="r22 r">i</span>];
 
                    <span class="c">//updating segment lengths means that both the offset and the length of the next segment needs to be recalculated, to keep the segment lengths somewhat balanced</span>
                    <b>long</b> <span id="r24 rd" class="r24 r">diff</span> = <span class="r23 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#df08bf689d04aaad" class="i property">Offset</a> - <span class="r21 r">offset</span>;
                    <span class="r23 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#df08bf689d04aaad" class="i property">Offset</a> = <span class="r21 r">offset</span>;
                    <span class="r23 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#d35d9c4278e3e239" class="i property">Length</a> += <span class="r24 r">diff</span>;
                    <b>if</b> (<span class="r23 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#df08bf689d04aaad" class="i property">Offset</a> &gt;= <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#c2f4b2ebd90b6cb3" class="i property">FileLength</a>)
                    {
                        <b>continue</b>;
                    }
 
                    <b>if</b> (<span class="r23 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a> == <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#982540b694e3af39" class="i property">Segments</a>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> - 1)
                    {
                        <span class="c">//last segment picks up the slack</span>
                        <span class="r23 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#d35d9c4278e3e239" class="i property">Length</a> = <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#c2f4b2ebd90b6cb3" class="i property">FileLength</a> - <span class="r23 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#df08bf689d04aaad" class="i property">Offset</a>;
                    }
                    <b>else</b>
                    {
                        <span class="c">//figure out how much do we need to adjust the length of the segment so it ends on a record boundary (this can be negative or positive)</span>
                        <b>int</b> <span id="r25 rd" class="r25 r">lengthAdjustment</span> = <a href="#2356b3a3bb58eaed" class="i method">DetermineLengthAdjustment</a>(<span class="r23 r">segment</span>, <span class="r20 r">stream</span>, <a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#d8ca9f7c66a5e85e" class="i method">GetEncoding</a>(<a href="#3c08d873a58fc637" class="k">this</a>.<a href="#7c9968d38fc350f1" class="i property">EncodingCodePage</a>), <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#8e7f770985aedd51" class="i property">Delimiter</a>) + 1;
 
                        <span class="c">//adjust segment length and offset</span>
                        <span class="r23 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#d35d9c4278e3e239" class="i property">Length</a> += <span class="r25 r">lengthAdjustment</span>;
                    }
                    <span class="r21 r">offset</span> += <span class="r23 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#d35d9c4278e3e239" class="i property">Length</a>;
                    <span class="r19 r">remainingSegments</span>++;
                }
            }
 
            <span class="c">//since we adjusted the segment lengths, it&#39;s possible that the last segment(s) became of zero length; so remove it</span>
            <b>var</b> <span id="r26 rd" class="r26 r">segments</span> = <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#982540b694e3af39" class="i property">Segments</a>;
            <b>if</b> (<span class="r19 r">remainingSegments</span> &lt; <span class="r26 r">segments</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>)
            {
                <a href="@0@mscorlib/A.html#156e066ecc4ccedf" class="t t">Array</a>.<a href="@0@mscorlib/A.html#71074deaf111c4e3" class="i method">Resize</a>(<b>ref</b> <span class="r26 r">segments</span>, <span class="r19 r">remainingSegments</span>);
                <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#982540b694e3af39" class="i property">Segments</a> = <span class="r26 r">segments</span>;
                <a href="#3c08d873a58fc637" class="k">this</a>.<a href="#9131b8fdd074a557" class="i property">SegmentCount</a> = <span class="r26 r">segments</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>;
            }
 
            <span class="c">//NOTE: we are not validating consistency here; this method is called by CreateNewMetadata which calls Save() after this, which validates consistency anyway.</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Calculates the value by which we&#39;d need to adjust the length of the given segment, by searching for the nearest newline around it (before and after), </span>
        <span class="c">///</span><span class="c"> and returning the distance to it (which can be positive, if after, or negative, if before).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r">segment</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r28 r">stream</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">encoding</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">delimiter</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">DataLake</span>.<span class="i n">Store</span>.<a href="TransferFailedException.cs.html#020a0db52cedc36b" class="t t">TransferFailedException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If no record boundary could be located on either side of the segment end offset within the allowed distance.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private int</b> <a id="2356b3a3bb58eaed" href="../../../R/2356b3a3bb58eaed.html" target="n" data-glyph="76,1" class="i method">DetermineLengthAdjustment</a>(<a href="TransferSegmentMetadata.cs.html#4a50ebae0a9351d2" class="t t">TransferSegmentMetadata</a> <span id="r27 rd" class="r27 r">segment</span>, <a href="@0@mscorlib/A.html#e23a38af5d11ddd3" class="t t">FileStream</a> <span id="r28 rd" class="r28 r">stream</span>, <a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a> <span id="r29 rd" class="r29 r">encoding</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r30 rd" class="r30 r">delimiter</span> = <b>null</b>)
        {
            <b>long</b> <span id="r31 rd" class="r31 r">referenceFileOffset</span> = <span class="r27 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#df08bf689d04aaad" class="i property">Offset</a> + <span class="r27 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#d35d9c4278e3e239" class="i property">Length</a>;
            <b>byte</b>[] <span id="r32 rd" class="r32 r">buffer</span> = <b>new</b> <b>byte</b>[<a href="../Upload/SingleSegmentUploader.cs.html#62b7b26e3b4d119f" class="t t">SingleSegmentUploader</a>.<a href="../Upload/SingleSegmentUploader.cs.html#8e8bbe2ca2eaa3d5" class="i field">MaxRecordLength</a>];
 
            <span class="c">//read 2MB before the segment boundary and 2MB after (for a total of 4MB = max append length)</span>
            <b>int</b> <span id="r33 rd" class="r33 r">bytesRead</span> = <a href="#2046b0f229f9efff" class="i method">ReadIntoBufferAroundReference</a>(<span class="r28 r">stream</span>, <span class="r32 r">buffer</span>, <span class="r31 r">referenceFileOffset</span>);
            <b>if</b> (<span class="r33 r">bytesRead</span> &gt; 0)
            {
                <b>int</b> <span id="r34 rd" class="r34 r">middlePoint</span> = <span class="r33 r">bytesRead</span> / 2;
                <span class="c">//search for newline in it</span>
                <b>int</b> <span id="r35 rd" class="r35 r">newLinePosBefore</span> = <a href="StringExtensions.cs.html#2e10c3c8474c5c94" class="t t">StringExtensions</a>.<a href="StringExtensions.cs.html#e58ca4853b85aa06" class="i method">FindNewline</a>(<span class="r32 r">buffer</span>, <span class="r34 r">middlePoint</span> + 1, <span class="r34 r">middlePoint</span> + 1, <b>true</b>, <span class="r29 r">encoding</span>, <span class="r30 r">delimiter</span>);
 
                <span class="c">//in some cases, we may have a newline that is 2 characters long, and it occurrs exactly on the midpoint, which means we won&#39;t be able to find its end.</span>
                <span class="c">//see if that&#39;s the case, and then search for a new candidate before it.</span>
                <b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r30 r">delimiter</span>) &amp;&amp; <span class="r35 r">newLinePosBefore</span> == <span class="r34 r">middlePoint</span> + 1 &amp;&amp; <span class="r32 r">buffer</span>[<span class="r35 r">newLinePosBefore</span>] == (<b>byte</b>)<span class="s">&#39;\r&#39;</span>)
                {
                    <b>int</b> <span id="r36 rd" class="r36 r">newNewLinePosBefore</span> = <a href="StringExtensions.cs.html#2e10c3c8474c5c94" class="t t">StringExtensions</a>.<a href="StringExtensions.cs.html#e58ca4853b85aa06" class="i method">FindNewline</a>(<span class="r32 r">buffer</span>, <span class="r34 r">middlePoint</span>, <span class="r34 r">middlePoint</span>, <b>true</b>, <span class="r29 r">encoding</span>);
                    <b>if</b> (<span class="r36 r">newNewLinePosBefore</span> &gt;= 0)
                    {
                        <span class="r35 r">newLinePosBefore</span> = <span class="r36 r">newNewLinePosBefore</span>;
                    }
                }
 
                <b>int</b> <span id="r37 rd" class="r37 r">newLinePosAfter</span> = <a href="StringExtensions.cs.html#2e10c3c8474c5c94" class="t t">StringExtensions</a>.<a href="StringExtensions.cs.html#e58ca4853b85aa06" class="i method">FindNewline</a>(<span class="r32 r">buffer</span>, <span class="r34 r">middlePoint</span>, <span class="r34 r">middlePoint</span>, <b>false</b>, <span class="r29 r">encoding</span>, <span class="r30 r">delimiter</span>);
                <b>if</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r30 r">delimiter</span>) &amp;&amp; <span class="r37 r">newLinePosAfter</span> == <span class="r32 r">buffer</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> - 1 &amp;&amp; <span class="r32 r">buffer</span>[<span class="r37 r">newLinePosAfter</span>] == (<b>byte</b>)<span class="s">&#39;\r&#39;</span> &amp;&amp; <span class="r35 r">newLinePosBefore</span> &gt;= 0)
                {
                    <span class="r37 r">newLinePosAfter</span> = -1;
                }
 
                <b>int</b> <span id="r38 rd" class="r38 r">closestNewLinePos</span> = <a href="#bf2d3c8ecbc7b89f" class="i method">FindClosestToCenter</a>(<span class="r35 r">newLinePosBefore</span>, <span class="r37 r">newLinePosAfter</span>, <span class="r34 r">middlePoint</span>);
 
                <span class="c">//middle point of the buffer corresponds to the reference file offset, so all we need to do is return the difference between the closest newline and the center of the buffer</span>
                <b>if</b> (<span class="r38 r">closestNewLinePos</span> &gt;= 0)
                {
                    <b>return</b> <span class="r38 r">closestNewLinePos</span> - <span class="r34 r">middlePoint</span>;
                }
            }
 
            <span class="c">//if we get this far, we were unable to find a record boundary within our limits =&gt; fail the upload</span>
            <b>throw</b> <b>new</b> <a href="TransferFailedException.cs.html#0257d7104f85f50a" class="t constructor">TransferFailedException</a>(
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#ad9f5b0b214ae8f3" class="i method">Format</a>(
                    <span class="s">&quot;Unable to locate a record boundary within {0}MB on either side of segment {1} (offset {2}). This means the record at that offset is larger than {0}MB.&quot;</span>,
                    <a href="../Upload/SingleSegmentUploader.cs.html#62b7b26e3b4d119f" class="t t">SingleSegmentUploader</a>.<a href="../Upload/SingleSegmentUploader.cs.html#8e8bbe2ca2eaa3d5" class="i field">MaxRecordLength</a> / 1024 / 1024 / 2,
                    <span class="r27 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#b23a7e7d251e39e8" class="i property">SegmentNumber</a>,
                    <span class="r27 r">segment</span>.<a href="TransferSegmentMetadata.cs.html#df08bf689d04aaad" class="i property">Offset</a>,
                    <a href="../Upload/SingleSegmentUploader.cs.html#62b7b26e3b4d119f" class="t t">SingleSegmentUploader</a>.<a href="../Upload/SingleSegmentUploader.cs.html#8e8bbe2ca2eaa3d5" class="i field">MaxRecordLength</a> / 1024 / 1024));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the value (of the given two) that is closest in absolute terms to the center value.</span>
        <span class="c">///</span><span class="c"> Values that are negative are ignored (since these are assumed to represent array indices).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r39 r">value1</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r40 r">value2</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r41 r">centerValue</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static int</b> <a id="bf2d3c8ecbc7b89f" href="../../../R/bf2d3c8ecbc7b89f.html" target="n" data-glyph="76,1" class="i method">FindClosestToCenter</a>(<b>int</b> <span id="r39 rd" class="r39 r">value1</span>, <b>int</b> <span id="r40 rd" class="r40 r">value2</span>, <b>int</b> <span id="r41 rd" class="r41 r">centerValue</span>)
        {
            <b>if</b> (<span class="r39 r">value1</span> &gt;= 0)
            {
                <b>if</b> (<span class="r40 r">value2</span> &gt;= 0)
                {
                    <b>return</b> <a href="@0@mscorlib/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@0@mscorlib/A.html#1c02e346de90ef5a" class="i method">Abs</a>(<span class="r40 r">value2</span> - <span class="r41 r">centerValue</span>) &gt; <a href="@0@mscorlib/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@0@mscorlib/A.html#1c02e346de90ef5a" class="i method">Abs</a>(<span class="r39 r">value1</span> - <span class="r41 r">centerValue</span>) ? <span class="r39 r">value1</span> : <span class="r40 r">value2</span>;
                }
                <b>else</b>
                {
                    <b>return</b> <span class="r39 r">value1</span>;
                }
            }
            <b>else</b>
            {
                <b>return</b> <span class="r40 r">value2</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Reads data from the given file into the given buffer, centered around the given file offset. The first half of the buffer will be </span>
        <span class="c">///</span><span class="c"> filled with data right before the given offset, while the remainder of the buffer will contain data right after it (of course, containing the byte at the given offset).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r42 r">stream</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">buffer</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r44 r">fileReferenceOffset</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The number of bytes reads, which could be less than the length of the input buffer if we can&#39;t read due to the beginning or the end of the file.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static int</b> <a id="2046b0f229f9efff" href="../../../R/2046b0f229f9efff.html" target="n" data-glyph="76,1" class="i method">ReadIntoBufferAroundReference</a>(<a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r42 rd" class="r42 r">stream</span>, <b>byte</b>[] <span id="r43 rd" class="r43 r">buffer</span>, <b>long</b> <span id="r44 rd" class="r44 r">fileReferenceOffset</span>)
        {
            <b>int</b> <span id="r45 rd" class="r45 r">length</span> = <span class="r43 r">buffer</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>;
            <span class="c">//calculate start offset</span>
            <b>long</b> <span id="r46 rd" class="r46 r">fileStartOffset</span> = <span class="r44 r">fileReferenceOffset</span> - <span class="r45 r">length</span> / 2;
 
            <b>if</b> (<span class="r46 r">fileStartOffset</span> &lt; 0)
            {
                <span class="c">//offset is less than zero, adjust it, as well as the length we want to read</span>
                <span class="r45 r">length</span> += (<b>int</b>)<span class="r46 r">fileStartOffset</span>;
                <span class="r46 r">fileStartOffset</span> = 0;
                <b>if</b> (<span class="r45 r">length</span> &lt;= 0)
                {
                    <b>return</b> 0;
                }
            }
 
            <b>if</b> (<span class="r46 r">fileStartOffset</span> + <span class="r45 r">length</span> &gt; <span class="r42 r">stream</span>.<a href="@0@mscorlib/A.html#48b7e39cfd844dc5" class="i property">Length</a>)
            {
                <span class="c">//startOffset + length is beyond the end of the stream, adjust the length accordingly</span>
                <span class="r45 r">length</span> = (<b>int</b>)(<span class="r42 r">stream</span>.<a href="@0@mscorlib/A.html#48b7e39cfd844dc5" class="i property">Length</a> - <span class="r46 r">fileStartOffset</span>);
                <b>if</b> (<span class="r45 r">length</span> &lt;= 0)
                {
                    <b>return</b> 0;
                }
            }
 
            <span class="c">//read the appropriate block of the file into the buffer, using symmetry with respect to its midpoint</span>
            <span class="r42 r">stream</span>.<a href="@0@mscorlib/A.html#eb5599035c4388ce" class="i method">Seek</a>(<span class="r46 r">fileStartOffset</span>, <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>.<a href="@0@mscorlib/A.html#c29481af7c617299" class="i field">Begin</a>);
            <b>int</b> <span id="r47 rd" class="r47 r">bufferOffset</span> = 0;
            <b>while</b> (<span class="r47 r">bufferOffset</span> &lt; <span class="r45 r">length</span>)
            {
                <b>int</b> <span id="r48 rd" class="r48 r">bytesRead</span> = <span class="r42 r">stream</span>.<a href="@0@mscorlib/A.html#6fb9c001d7524ba2" class="i method">Read</a>(<span class="r43 r">buffer</span>, <span class="r47 r">bufferOffset</span>, <span class="r45 r">length</span> - <span class="r47 r">bufferOffset</span>);
                <span class="r47 r">bufferOffset</span> += <span class="r48 r">bytesRead</span>;
            }
            <b>return</b> <span class="r45 r">length</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    }
}
</pre></td></tr></table></div></body></html>
