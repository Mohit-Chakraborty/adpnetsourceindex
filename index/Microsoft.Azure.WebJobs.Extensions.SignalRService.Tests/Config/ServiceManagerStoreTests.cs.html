<!DOCTYPE html>
<html><head><title>ServiceManagerStoreTests.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(98);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.WebJobs.Extensions.SignalRService.Tests/Config/ServiceManagerStoreTests.cs" target="_top">Config\ServiceManagerStoreTests.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/signalr/Microsoft.Azure.WebJobs.Extensions.SignalRService/tests/Config/ServiceManagerStoreTests.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.WebJobs.Extensions.SignalRService.Tests" target="_top">Microsoft.Azure.WebJobs.Extensions.SignalRService.Tests.csproj</a> (Microsoft.Azure.WebJobs.Extensions.SignalRService.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>.<span class="i n">RegularExpressions</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">Serialization</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">SignalR</span>.<span class="i n">Common</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">SignalR</span>.<span class="i n">Management</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">SignalR</span>.<span class="i n">Tests</span>.<span class="i n">Common</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">WebJobs</span>.<span class="i n">Extensions</span>.<span class="i n">SignalRService</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Azure</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Configuration</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">DependencyInjection</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Hosting</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Logging</span>.<span class="i n">Abstractions</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Options</span>;
<b>using</b> <span class="i n">Xunit</span>;
 
<b>namespace</b> <span class="i n">SignalRServiceExtension</span>.<span class="i n">Tests</span>
{
    <b>public class</b> <a id="13bdef4361b02b1c" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="e92de53d49cd8a1a">ServiceManagerStoreTests</span></a>
    {
        [<span class="t constructor">Fact</span>]
        <b>public void</b> <a id="eeea6db7ad913782" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetServiceManager_WithSingleEndpoint</a>()
        {
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r0 rd" class="r0 r">connectionString</span> = <a href="../Utils/FakeEndpointUtils.cs.html#2774a3252a946811" class="t t">FakeEndpointUtils</a>.<a href="../Utils/FakeEndpointUtils.cs.html#8dccc8721af4ea85" class="i method">GetFakeConnectionString</a>(1).<a href="@0@System.Core/A.html#35e2ff5965cb4b7e" class="i method">Single</a>();
            <b>var</b> <span id="r1 rd" class="r1 r">configuration</span> = <b>new</b> <span class="t constructor">ConfigurationBuilder</span>().<span class="i method">AddInMemoryCollection</span>().<span class="i method">Build</span>();
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r2 rd" class="r2 r">connectionStringKey</span> = <span class="s">&quot;key&quot;</span>;
            <span class="r1 r">configuration</span>[<span class="r2 r">connectionStringKey</span>] = <span class="r0 r">connectionString</span>;
 
            <a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#41a3347443737d34" class="k">var</a> <span id="r3 rd" class="r3 r">managerStore</span> = <b>new</b> <a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#5cd20a0d2ac18693" class="t constructor">ServiceManagerStore</a>(<span class="r1 r">configuration</span>, <span class="t t">NullLoggerFactory</span>.<span class="i field">Instance</span>, <b>null</b>, <span class="t t">Options</span>.<span class="i method">Create</span>(<b>new</b> <a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#aeb9cefee1881074" class="t constructor">SignalROptions</a>()));
            <a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#989d91bee5fb16f0" class="k">var</a> <span id="r4 rd" class="r4 r">hubContextStore</span> = <span class="r3 r">managerStore</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#62a5e11f59a14192" class="i method">GetOrAddByConnectionStringKey</a>(<span class="r2 r">connectionStringKey</span>);
            <b>var</b> <span id="r5 rd" class="r5 r">manager</span> = <span class="r4 r">hubContextStore</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#3f69828a369e1e1b" class="i property">ServiceManager</a>;
        }
 
        [<span class="t constructor">Fact</span>]
        <b>public void</b> <a id="d267c8085c5fcc0e" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ProductInfoValid</a>()
        {
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r6 rd" class="r6 r">connectionString</span> = <a href="../Utils/FakeEndpointUtils.cs.html#2774a3252a946811" class="t t">FakeEndpointUtils</a>.<a href="../Utils/FakeEndpointUtils.cs.html#8dccc8721af4ea85" class="i method">GetFakeConnectionString</a>(1).<a href="@0@System.Core/A.html#35e2ff5965cb4b7e" class="i method">Single</a>();
            <b>var</b> <span id="r7 rd" class="r7 r">configuration</span> = <b>new</b> <span class="t constructor">ConfigurationBuilder</span>().<span class="i method">AddInMemoryCollection</span>().<span class="i method">Build</span>();
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r8 rd" class="r8 r">connectionStringKey</span> = <span class="s">&quot;key&quot;</span>;
            <span class="r7 r">configuration</span>[<span class="r8 r">connectionStringKey</span>] = <span class="r6 r">connectionString</span>;
            <span class="r7 r">configuration</span>[<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#2a8c172e6bf1aff3" class="t t">Constants</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#6ea09c1fa9d03de0" class="i field">FunctionsWorkerRuntime</a>] = <a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#2a8c172e6bf1aff3" class="t t">Constants</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#ccad0697a2778310" class="i field">DotnetWorker</a>;
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r9 rd" class="r9 r">productInfo</span> = <b>new</b> <span class="t constructor">ServiceCollection</span>()
                .<span class="i method">AddSignalRServiceManager</span>(<b>new</b> <a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#b56da665cf29ba92" class="t constructor">OptionsSetup</a>(<span class="r7 r">configuration</span>, <a href="../Utils/SingletonAzureComponentFactory.cs.html#5189a5f744c9bb55" class="t t">SingletonAzureComponentFactory</a>.<a href="../Utils/SingletonAzureComponentFactory.cs.html#6edaff24d78bb0ae" class="i field">Instance</a>, <span class="r8 r">connectionStringKey</span>))
                .<span class="i method">BuildServiceProvider</span>()
                .<span class="i method">GetRequiredService</span>&lt;<span class="t t">IOptions</span>&lt;<span class="t t">ServiceManagerOptions</span>&gt;&gt;()
                .<span class="i property">Value</span>.<span class="i property">ProductInfo</span>;
 
            <span class="t t">Assert</span>.<span class="i method">NotNull</span>(<span class="r9 r">productInfo</span>);
            <a href="@0@System/A.html#bbe3b2eb80ae5526" class="k">var</a> <span id="r10 rd" class="r10 r">reg</span> = <b>new</b> <a href="@0@System/A.html#71b5945bb883860b" class="t constructor">Regex</a>(<span class="s">@&quot;\[(\w*)=(\w*)\]&quot;</span>);
            <a href="@0@System/A.html#d8a604d3af777b1c" class="k">var</a> <span id="r11 rd" class="r11 r">match</span> = <span class="r10 r">reg</span>.<a href="@0@System/A.html#7ef0f10a0d96f10f" class="i method">Match</a>(<span class="r9 r">productInfo</span>);
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#2a8c172e6bf1aff3" class="t t">Constants</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#99fa132364fc78c8" class="i field">FunctionsWorkerProductInfoKey</a>, <span class="r11 r">match</span>.<a href="@0@System/A.html#882064d8e42ed216" class="i property">Groups</a>[1].<a href="@0@System/A.html#5cf0d171c91c6cc1" class="i property">Value</a>);
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#2a8c172e6bf1aff3" class="t t">Constants</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#ccad0697a2778310" class="i field">DotnetWorker</a>, <span class="r11 r">match</span>.<a href="@0@System/A.html#882064d8e42ed216" class="i property">Groups</a>[2].<a href="@0@System/A.html#5cf0d171c91c6cc1" class="i property">Value</a>);
        }
 
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="2a4e3f24204cca2a" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">DefaultRouterExists</a>()
        {
            <b>var</b> <span id="r12 rd" class="r12 r">builder</span> = <b>new</b> <span class="t constructor">HostBuilder</span>();
            <b>var</b> <span id="r13 rd" class="r13 r">host</span> = <span class="r12 r">builder</span>
                .<span class="i method">ConfigureAppConfiguration</span>(<span id="r14 rd" class="r14 r">b</span> =&gt; <span class="r14 r">b</span>.<span class="i method">AddInMemoryCollection</span>(
                    <b>new</b> <a href="@0@mscorlib/A.html#bf6849e410b43c4c" class="t constructor">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; {
                                { <span class="s">&quot;Azure:SignalR:Endpoints:A&quot;</span>, <a href="../Utils/FakeEndpointUtils.cs.html#2774a3252a946811" class="t t">FakeEndpointUtils</a>.<a href="../Utils/FakeEndpointUtils.cs.html#8dccc8721af4ea85" class="i method">GetFakeConnectionString</a>(1).<a href="@0@System.Core/A.html#35e2ff5965cb4b7e" class="i method">Single</a>() },
                                { <span class="s">&quot;Azure:SignalR:Endpoints:B&quot;</span>, <a href="../Utils/FakeEndpointUtils.cs.html#2774a3252a946811" class="t t">FakeEndpointUtils</a>.<a href="../Utils/FakeEndpointUtils.cs.html#8dccc8721af4ea85" class="i method">GetFakeConnectionString</a>(1).<a href="@0@System.Core/A.html#35e2ff5965cb4b7e" class="i method">Single</a>() },
                                { <a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#2a8c172e6bf1aff3" class="t t">Constants</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#1d123b41ac34d20f" class="i field">ServiceTransportTypeName</a>, <span class="t t">ServiceTransportType</span>.<span class="i field">Persistent</span>.<a href="@0@mscorlib/A.html#1365cfeffd45409d" class="i method">ToString</a>() }
                            }))
                .<span class="i method">ConfigureWebJobs</span>(<span id="r15 rd" class="r15 r">b</span> =&gt; <span class="r15 r">b</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#e9e3c47a027c31f5" class="i method">AddSignalR</a>().<span class="i property">Services</span>.<a href="/Microsoft.Extensions.Azure/A.html#bdd787cfacc4ec82" class="i method">AddAzureClientsCore</a>()).<span class="i method">Build</span>();
            <b>var</b> <span id="r16 rd" class="r16 r">hubContext</span> = <b>await</b> <span class="r13 r">host</span>.<span class="i property">Services</span>.<span class="i method">GetRequiredService</span>&lt;<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#518cb3648929bf77" class="t t">IServiceManagerStore</a>&gt;().<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#2d148b803e907b5b" class="i method">GetOrAddByConnectionStringKey</a>(<span class="s">&quot;key&quot;</span>).<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#dfe4e17bbfd2b4f4" class="i method">GetAsync</a>(<span class="s">&quot;hubName&quot;</span>) <b>as</b> <span class="t t">ServiceHubContext</span>;
            <b>await</b> <span class="t t">Assert</span>.<span class="i method">ThrowsAsync</span>&lt;<span class="t t">AzureSignalRNotConnectedException</span>&gt;(() =&gt; <span class="r16 r">hubContext</span>.<span class="i method">NegotiateAsync</span>().<span class="i method">AsTask</span>());
        }
 
        [<span class="t constructor">Fact</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="917e3142dcedd9f6" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TestConfigureSignalROptions</a>()
        {
            <b>var</b> <span id="r17 rd" class="r17 r">builder</span> = <b>new</b> <span class="t constructor">HostBuilder</span>();
            <b>var</b> <span id="r18 rd" class="r18 r">host</span> = <span class="r17 r">builder</span>
                .<span class="i method">ConfigureWebJobs</span>(<span id="r19 rd" class="r19 r">b</span> =&gt; <span class="r19 r">b</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#e9e3c47a027c31f5" class="i method">AddSignalR</a>())
                .<span class="i method">ConfigureServices</span>(<span id="r20 rd" class="r20 r">services</span> =&gt; <span class="r20 r">services</span>.<span class="i method">Configure</span>&lt;<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#75136dcc5c8b2653" class="t t">SignalROptions</a>&gt;(<span id="r21 rd" class="r21 r">o</span> =&gt;
                {
                    <b>foreach</b> (<b>var</b> <span id="r22 rd" class="r22 r">endpoint</span> <b>in</b> <a href="../Utils/FakeEndpointUtils.cs.html#2774a3252a946811" class="t t">FakeEndpointUtils</a>.<a href="../Utils/FakeEndpointUtils.cs.html#b4bc1a8f91a4f1f8" class="i method">GetFakeEndpoint</a>(3))
                    {
                        <span class="r21 r">o</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#dfb13e241ce1b2c3" class="i property">ServiceEndpoints</a>.<a href="@0@mscorlib/A.html#a9319db8c62ae453" class="i method">Add</a>(<span class="r22 r">endpoint</span>);
                    }
                    <span class="r21 r">o</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#1678ece2c31956c5" class="i property">ServiceTransportType</a> = <span class="t t">ServiceTransportType</span>.<span class="i field">Persistent</span>;
                    <span class="r21 r">o</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#e44146daaf019e85" class="i method">UseJsonObjectSerializer</a>(<b>new</b> <a href="/Microsoft.Azure.Core.NewtonsoftJson/A.html#627ee383a2aa1739" class="t constructor">NewtonsoftJsonObjectSerializer</a>());
                })).<span class="i method">Build</span>();
            <b>var</b> <span id="r23 rd" class="r23 r">hubContext</span> = <b>await</b> <span class="r18 r">host</span>.<span class="i property">Services</span>.<span class="i method">GetRequiredService</span>&lt;<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#518cb3648929bf77" class="t t">IServiceManagerStore</a>&gt;().<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#2d148b803e907b5b" class="i method">GetOrAddByConnectionStringKey</a>(<span class="s">&quot;key&quot;</span>).<a href="/Microsoft.Azure.WebJobs.Extensions.SignalRService/A.html#dfe4e17bbfd2b4f4" class="i method">GetAsync</a>(<span class="s">&quot;hubName&quot;</span>) <b>as</b> <span class="t t">ServiceHubContext</span>;
            <b>var</b> <span id="r24 rd" class="r24 r">resultOptions</span> = (<span class="r23 r">hubContext</span> <b>as</b> <span class="t t">ServiceHubContextImpl</span>).<span class="i property">ServiceProvider</span>.<span class="i method">GetRequiredService</span>&lt;<span class="t t">IOptions</span>&lt;<span class="t t">ServiceManagerOptions</span>&gt;&gt;().<span class="i property">Value</span>;
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(3, <span class="r24 r">resultOptions</span>.<span class="i property">ServiceEndpoints</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>);
            <span class="t t">Assert</span>.<span class="i method">Equal</span>(<span class="t t">ServiceTransportType</span>.<span class="i field">Persistent</span>, <span class="r24 r">resultOptions</span>.<span class="i property">ServiceTransportType</span>);
            <span class="t t">Assert</span>.<span class="i method">IsType</span>&lt;<a href="/Microsoft.Azure.Core.NewtonsoftJson/A.html#762d661349f8692d" class="t t">NewtonsoftJsonObjectSerializer</a>&gt;(<span class="r24 r">resultOptions</span>.<span class="i property">ObjectSerializer</span>);
        }
    }
}</pre></td></tr></table></div></body></html>
