<!DOCTYPE html>
<html><head><title>LazyLoadingReadOnlyStream.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(450);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Storage.Common.Tests/Shared/LazyLoadingReadOnlyStream.cs" target="_top">Shared\LazyLoadingReadOnlyStream.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/storage/Azure.Storage.Common/src/Shared/LazyLoadingReadOnlyStream.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Storage.Common.Tests" target="_top">Azure.Storage.Common.Tests.csproj</a> (Azure.Storage.Common.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Buffers</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">Pipeline</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Shared</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Used for Open Read APIs.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="668efc132d76b6c5" href="../R/668efc132d76b6c5.html" target="n" data-glyph="2,0" class="t t">LazyLoadingReadOnlyStream</a>&lt;<span id="r0 rd t" class="r0 r t">TProperties</span>&gt; : <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Delegate for a resource&#39;s direct REST download method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">range</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Content range to download.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">hashingOptions</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Options for transactional hashing on downloads.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">async</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Whether to perform the operation asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cancellation token for cancelling the download request.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Downloaded resource content.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public delegate</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="IDownloadedContent.cs.html#69a48c99dccf0ffd" class="t t">IDownloadedContent</a>&gt;&gt; <a id="719fb6c09b5a56e8" href="../R/719fb6c09b5a56e8.html" target="n" data-glyph="12,1" class="t t"><span id="70156fca271055ee">DownloadInternalAsync</span></a>(
            <a href="/Azure.Core/A.html#d6f9b3aba6783671" class="t t">HttpRange</a> <span id="r1 rd" class="r1 r">range</span>,
            <a href="/Azure.Storage.Common/A.html#73cd37b24a10f6d5" class="t t">DownloadTransactionalHashingOptions</a> <span id="r2 rd" class="r2 r">hashingOptions</span>,
            <b>bool</b> <span id="r3 rd" class="r3 r">async</span>,
            <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r4 rd" class="r4 r">cancellationToken</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Delegate for getting properties for the target resource.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">async</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Whether to perform the operation asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cancellation token for cancelling the download request.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Resource properties.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public delegate</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<span class="r0 r t">TProperties</span>&gt;&gt; <a id="be4daa7f7d130f56" href="../R/be4daa7f7d130f56.html" target="n" data-glyph="12,1" class="t t"><span id="2e9efc7377049450">GetPropertiesAsync</span></a>(<b>bool</b> <span id="r5 rd" class="r5 r">async</span>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r6 rd" class="r6 r">cancellationToken</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The current position within the blob or file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private long</b> <a id="ae078711711fcb0f" href="../R/ae078711711fcb0f.html" target="n" data-glyph="46,1" class="i field">_position</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Last known length of underlying blob or file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private long</b> <a id="9329098edd7e36e7" href="../R/9329098edd7e36e7.html" target="n" data-glyph="46,1" class="i field">_length</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The number of bytes to download per call.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly int</b> <a id="efa03ea9beb60029" href="../R/efa03ea9beb60029.html" target="n" data-glyph="46,1" class="i field">_bufferSize</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The backing buffer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private byte</b>[] <a id="22c55b6b4e5df580" href="../R/22c55b6b4e5df580.html" target="n" data-glyph="46,1" class="i field">_buffer</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The current position within the buffer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private int</b> <a id="66227b39ae5d579b" href="../R/66227b39ae5d579b.html" target="n" data-glyph="46,1" class="i field">_bufferPosition</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The current length of the buffer that is populated.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private int</b> <a id="2698b322739f1c85" href="../R/2698b322739f1c85.html" target="n" data-glyph="46,1" class="i field">_bufferLength</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If we are allowing the blob to be modifed while we read it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly bool</b> <a id="4422213dd3fda319" href="../R/4422213dd3fda319.html" target="n" data-glyph="46,1" class="i field">_allowBlobModifications</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicated the user has called Seek() since the last Read() call, and the new position is outside _buffer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="eb9fd1e74a9cfd90" href="../R/eb9fd1e74a9cfd90.html" target="n" data-glyph="46,1" class="i field">_bufferInvalidated</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Download() function.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <a href="#719fb6c09b5a56e8" class="t t">DownloadInternalAsync</a> <a id="0dede69bc5f64862" href="../R/0dede69bc5f64862.html" target="n" data-glyph="46,1" class="i field">_downloadInternalFunc</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Function to get properties.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <a href="#be4daa7f7d130f56" class="t t">GetPropertiesAsync</a> <a id="b51f25109d3be347" href="../R/b51f25109d3be347.html" target="n" data-glyph="46,1" class="i field">_getPropertiesInternalFunc</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Hashing options to use with </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#0dede69bc5f64862" class="i field">_downloadInternalFunc</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <a href="/Azure.Storage.Common/A.html#73cd37b24a10f6d5" class="t t">DownloadTransactionalHashingOptions</a> <a id="c899d2c535e2a892" href="../R/c899d2c535e2a892.html" target="n" data-glyph="46,1" class="i field">_hashingOptions</a>;
 
        <b>public</b> <a id="a641b49112fc59be" href="../R/a641b49112fc59be.html" target="n" data-glyph="72,1" class="t constructor">LazyLoadingReadOnlyStream</a>(
            <a href="#719fb6c09b5a56e8" class="t t">DownloadInternalAsync</a> <span id="r7 rd" class="r7 r">downloadInternalFunc</span>,
            <a href="#be4daa7f7d130f56" class="t t">GetPropertiesAsync</a> <span id="r8 rd" class="r8 r">getPropertiesFunc</span>,
            <a href="/Azure.Storage.Common/A.html#73cd37b24a10f6d5" class="t t">DownloadTransactionalHashingOptions</a> <span id="r9 rd" class="r9 r">hashingOptions</span>,
            <b>bool</b> <span id="r10 rd" class="r10 r">allowModifications</span>,
            <b>long</b> <span id="r11 rd" class="r11 r">initialLenght</span>,
            <b>long</b> <span id="r12 rd" class="r12 r">position</span> = 0,
            <b>int</b>? <span id="r13 rd" class="r13 r">bufferSize</span> = <b>default</b>)
        {
            <a href="#0dede69bc5f64862" class="i field">_downloadInternalFunc</a> = <span class="r7 r">downloadInternalFunc</span>;
            <a href="#b51f25109d3be347" class="i field">_getPropertiesInternalFunc</a> = <span class="r8 r">getPropertiesFunc</span>;
            <a href="#ae078711711fcb0f" class="i field">_position</a> = <span class="r12 r">position</span>;
            <a href="#efa03ea9beb60029" class="i field">_bufferSize</a> = <span class="r13 r">bufferSize</span> ?? <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#ef58a0aaf269f428" class="i field">DefaultStreamingDownloadSize</a>;
            <a href="#22c55b6b4e5df580" class="i field">_buffer</a> = <span class="t t">ArrayPool</span>&lt;<b>byte</b>&gt;.<span class="i property">Shared</span>.<span class="i method">Rent</span>(<a href="#efa03ea9beb60029" class="i field">_bufferSize</a>);
            <a href="#4422213dd3fda319" class="i field">_allowBlobModifications</a> = <span class="r10 r">allowModifications</span>;
            <a href="#66227b39ae5d579b" class="i field">_bufferPosition</a> = 0;
            <a href="#2698b322739f1c85" class="i field">_bufferLength</a> = 0;
            <a href="#9329098edd7e36e7" class="i field">_length</a> = <span class="r11 r">initialLenght</span>;
            <a href="#eb9fd1e74a9cfd90" class="i field">_bufferInvalidated</a> = <b>false</b>;
 
            <span class="c">// the caller to this stream cannot defer validation, as they cannot access a returned hash</span>
            <b>if</b> (!(<span class="r9 r">hashingOptions</span>?.<a href="/Azure.Storage.Common/A.html#1043ac07103a717f" class="i property">Validate</a> ?? <b>true</b>))
            {
                <b>throw</b> <a href="/Azure.Storage.Common/A.html#5ed86f0799b000b6" class="t t">Errors</a>.<a href="/Azure.Storage.Common/A.html#227f91016e7ded64" class="i method">CannotDeferTransactionalHashVerification</a>();
            }
            <span class="c">// we defer hash validation on download calls to validate in-place with our existing buffer</span>
            <a href="#c899d2c535e2a892" class="i field">_hashingOptions</a> = <span class="r9 r">hashingOptions</span> == <b>default</b>
                ? <b>default</b>
                : <b>new</b> <a href="/Azure.Storage.Common/A.html#5c99d1a7c6610650" class="t constructor">DownloadTransactionalHashingOptions</a>
                {
                    <a href="/Azure.Storage.Common/A.html#de4613b92c62bbf5" class="i property">Algorithm</a> = <span class="r9 r">hashingOptions</span>.<a href="/Azure.Storage.Common/A.html#de4613b92c62bbf5" class="i property">Algorithm</a>,
                    <a href="/Azure.Storage.Common/A.html#1043ac07103a717f" class="i property">Validate</a> = <b>false</b>
                };
        }
 
        <b>public override int</b> <a id="16fb99c2f13f17fb" href="../R/16fb99c2f13f17fb.html" target="n" data-glyph="72,1" class="i method">Read</a>(<b>byte</b>[] <span id="r14 rd" class="r14 r">buffer</span>, <b>int</b> <span id="r15 rd" class="r15 r">offset</span>, <b>int</b> <span id="r16 rd" class="r16 r">count</span>)
            =&gt; <a href="#3b7a5044b5b42ca5" class="i method">ReadInternal</a>(
                <span class="r14 r">buffer</span>,
                <span class="r15 r">offset</span>,
                <span class="r16 r">count</span>,
                <span class="r17 r">async</span>: <b>false</b>,
                <b>default</b>)
            .<a href="/Azure.Storage.Common/A.html#c5b047e3cbfab399" class="i method">EnsureCompleted</a>();
 
        <b>public override async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>int</b>&gt; <a id="c2841dd14d8bf6cd" href="../R/c2841dd14d8bf6cd.html" target="n" data-glyph="72,1" class="i method">ReadAsync</a>(<b>byte</b>[] <span id="r18 rd" class="r18 r">buffer</span>, <b>int</b> <span id="r19 rd" class="r19 r">offset</span>, <b>int</b> <span id="r20 rd" class="r20 r">count</span>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r21 rd" class="r21 r">cancellationToken</span>)
            =&gt; <b>await</b> <a href="#3b7a5044b5b42ca5" class="i method">ReadInternal</a>(
                <span class="r18 r">buffer</span>,
                <span class="r19 r">offset</span>,
                <span class="r20 r">count</span>,
                <span class="r17 r">async</span>: <b>true</b>,
                <span class="r21 r">cancellationToken</span>)
                .<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
        <b>public async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>int</b>&gt; <a id="3b7a5044b5b42ca5" href="../R/3b7a5044b5b42ca5.html" target="n" data-glyph="72,1" class="i method">ReadInternal</a>(<b>byte</b>[] <span id="r22 rd" class="r22 r">buffer</span>, <b>int</b> <span id="r23 rd" class="r23 r">offset</span>, <b>int</b> <span id="r24 rd" class="r24 r">count</span>, <b>bool</b> <span id="r17 rd" class="r17 r">async</span>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r25 rd" class="r25 r">cancellationToken</span>)
        {
            <a href="#a52f8fa6bdf9ba7e" class="i method">ValidateReadParameters</a>(<span class="r22 r">buffer</span>, <span class="r23 r">offset</span>, <span class="r24 r">count</span>);
 
            <b>if</b> (<a href="#ae078711711fcb0f" class="i field">_position</a> == <a href="#9329098edd7e36e7" class="i field">_length</a>)
            {
                <b>if</b> (<a href="#4422213dd3fda319" class="i field">_allowBlobModifications</a>)
                {
                    <span class="c">// In case the blob grow since our last download call.</span>
                    <a href="#9329098edd7e36e7" class="i field">_length</a> = <b>await</b> <a href="#09faf0c3d67ab9cb" class="i method">GetBlobLengthInternal</a>(<span class="r17 r">async</span>, <span class="r25 r">cancellationToken</span>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                    <b>if</b> (<a href="#ae078711711fcb0f" class="i field">_position</a> == <a href="#9329098edd7e36e7" class="i field">_length</a>)
                    {
                        <b>return</b> 0;
                    }
                }
                <b>else</b>
                {
                    <b>return</b> 0;
                }
            }
 
            <b>if</b> (<a href="#66227b39ae5d579b" class="i field">_bufferPosition</a> == <a href="#2698b322739f1c85" class="i field">_bufferLength</a> || <a href="#eb9fd1e74a9cfd90" class="i field">_bufferInvalidated</a>)
            {
                <b>int</b> <span id="r26 rd" class="r26 r">lastDownloadedBytes</span> = <b>await</b> <a href="#060de855830480e1" class="i method">DownloadInternal</a>(<span class="r17 r">async</span>, <span class="r25 r">cancellationToken</span>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
                <b>if</b> (<span class="r26 r">lastDownloadedBytes</span> == 0)
                {
                    <b>return</b> 0;
                }
                <a href="#eb9fd1e74a9cfd90" class="i field">_bufferInvalidated</a> = <b>false</b>;
            }
 
            <b>int</b> <span id="r27 rd" class="r27 r">remainingBytesInBuffer</span> = <a href="#2698b322739f1c85" class="i field">_bufferLength</a> - <a href="#66227b39ae5d579b" class="i field">_bufferPosition</a>;
 
            <span class="c">// We will return the minimum of remainingBytesInBuffer and the count provided by the user</span>
            <b>int</b> <span id="r28 rd" class="r28 r">bytesToWrite</span> = <a href="@0@mscorlib/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@0@mscorlib/A.html#f441d55c88d635ad" class="i method">Min</a>(<span class="r27 r">remainingBytesInBuffer</span>, <span class="r24 r">count</span>);
 
            <a href="@0@mscorlib/A.html#156e066ecc4ccedf" class="t t">Array</a>.<a href="@0@mscorlib/A.html#7441c6721593042c" class="i method">Copy</a>(<a href="#22c55b6b4e5df580" class="i field">_buffer</a>, <a href="#66227b39ae5d579b" class="i field">_bufferPosition</a>, <span class="r22 r">buffer</span>, <span class="r23 r">offset</span>, <span class="r28 r">bytesToWrite</span>);
 
            <a href="#ae078711711fcb0f" class="i field">_position</a> += <span class="r28 r">bytesToWrite</span>;
            <a href="#66227b39ae5d579b" class="i field">_bufferPosition</a> += <span class="r28 r">bytesToWrite</span>;
 
            <b>return</b> <span class="r28 r">bytesToWrite</span>;
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>int</b>&gt; <a id="060de855830480e1" href="../R/060de855830480e1.html" target="n" data-glyph="76,1" class="i method">DownloadInternal</a>(<b>bool</b> <span id="r29 rd" class="r29 r">async</span>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r30 rd" class="r30 r">cancellationToken</span>)
        {
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="IDownloadedContent.cs.html#69a48c99dccf0ffd" class="t t">IDownloadedContent</a>&gt; <span id="r31 rd" class="r31 r">response</span>;
 
            <a href="/Azure.Core/A.html#d6f9b3aba6783671" class="t t">HttpRange</a> <span id="r32 rd" class="r32 r">range</span> = <b>new</b> <a href="/Azure.Core/A.html#6ed33a49a04456b8" class="t constructor">HttpRange</a>(<a href="#ae078711711fcb0f" class="i field">_position</a>, <a href="#efa03ea9beb60029" class="i field">_bufferSize</a>);
 
            <span class="r31 r">response</span> = <b>await</b> <a href="#0dede69bc5f64862" class="i field">_downloadInternalFunc</a>(<span class="r32 r">range</span>, <a href="#c899d2c535e2a892" class="i field">_hashingOptions</a>, <span class="r29 r">async</span>, <span class="r30 r">cancellationToken</span>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
            <b>using</b> <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r33 rd" class="r33 r">networkStream</span> = <span class="r31 r">response</span>.<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>.<a href="IDownloadedContent.cs.html#2c408d0f791d9a78" class="i property">Content</a>;
 
            <span class="c">// The number of bytes we just downloaded.</span>
            <b>long</b> <span id="r34 rd" class="r34 r">downloadSize</span> = <a href="#7799ed3d2f3b7122" class="i method">GetResponseRange</a>(<span class="r31 r">response</span>.<a href="/Azure.Core/A.html#959994a72d6ef38a" class="i method">GetRawResponse</a>()).<a href="/Azure.Core/A.html#3cef4dbf2165d8c2" class="i property">Length</a>.<a href="@0@mscorlib/A.html#7b38d1fa76071c95" class="i property">Value</a>;
 
            <span class="c">// The number of bytes we copied in the last loop.</span>
            <b>int</b> <span id="r35 rd" class="r35 r">copiedBytes</span>;
 
            <span class="c">// Bytes we have copied so far.</span>
            <b>int</b> <span id="r36 rd" class="r36 r">totalCopiedBytes</span> = 0;
 
            <span class="c">// Bytes remaining to copy.  It is save to truncate the long because we asked for a max of int _buffer size bytes.</span>
            <b>int</b> <span id="r37 rd" class="r37 r">remainingBytes</span> = (<b>int</b>)<span class="r34 r">downloadSize</span>;
 
            <b>do</b>
            {
                <b>if</b> (<span class="r29 r">async</span>)
                {
                    <span class="r35 r">copiedBytes</span> = <b>await</b> <span class="r33 r">networkStream</span>.<a href="@0@mscorlib/A.html#e224b4bec8748849" class="i method">ReadAsync</a>(
                        <span class="r38 r">buffer</span>: <a href="#22c55b6b4e5df580" class="i field">_buffer</a>,
                        <span class="r39 r">offset</span>: <span class="r36 r">totalCopiedBytes</span>,
                        <span class="r40 r">count</span>: <span class="r37 r">remainingBytes</span>,
                        <span class="r41 r">cancellationToken</span>: <span class="r30 r">cancellationToken</span>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
                }
                <b>else</b>
                {
                    <span class="r35 r">copiedBytes</span> = <span class="r33 r">networkStream</span>.<a href="@0@mscorlib/A.html#6fb9c001d7524ba2" class="i method">Read</a>(
                        <span class="r42 r">buffer</span>: <a href="#22c55b6b4e5df580" class="i field">_buffer</a>,
                        <span class="r43 r">offset</span>: <span class="r36 r">totalCopiedBytes</span>,
                        <span class="r44 r">count</span>: <span class="r37 r">remainingBytes</span>);
                }
 
                <span class="r36 r">totalCopiedBytes</span> += <span class="r35 r">copiedBytes</span>;
                <span class="r37 r">remainingBytes</span> -= <span class="r35 r">copiedBytes</span>;
            }
            <b>while</b> (<span class="r35 r">copiedBytes</span> != 0);
 
            <a href="#66227b39ae5d579b" class="i field">_bufferPosition</a> = 0;
            <a href="#2698b322739f1c85" class="i field">_bufferLength</a> = <span class="r36 r">totalCopiedBytes</span>;
            <a href="#9329098edd7e36e7" class="i field">_length</a> = <a href="#38fd3fb6df18093b" class="i method">GetBlobLengthFromResponse</a>(<span class="r31 r">response</span>.<a href="/Azure.Core/A.html#959994a72d6ef38a" class="i method">GetRawResponse</a>());
 
            <span class="c">// if we deferred transactional hash validation on download, validate now</span>
            <span class="c">// currently we always do but that may change</span>
            <b>if</b> (<a href="#c899d2c535e2a892" class="i field">_hashingOptions</a> != <b>default</b> &amp;&amp; !<a href="#c899d2c535e2a892" class="i field">_hashingOptions</a>.<a href="/Azure.Storage.Common/A.html#1043ac07103a717f" class="i property">Validate</a>)
            {
                <a href="ContentHasher.cs.html#e6946fb62554c419" class="t t">ContentHasher</a>.<a href="ContentHasher.cs.html#9c49db64da6a6e71" class="i method">AssertResponseHashMatch</a>(<a href="#22c55b6b4e5df580" class="i field">_buffer</a>, <a href="#66227b39ae5d579b" class="i field">_bufferPosition</a>, <a href="#2698b322739f1c85" class="i field">_bufferLength</a>, <a href="#c899d2c535e2a892" class="i field">_hashingOptions</a>.<a href="/Azure.Storage.Common/A.html#de4613b92c62bbf5" class="i property">Algorithm</a>, <span class="r31 r">response</span>.<a href="/Azure.Core/A.html#959994a72d6ef38a" class="i method">GetRawResponse</a>());
            }
 
            <b>return</b> <span class="r36 r">totalCopiedBytes</span>;
        }
 
        <b>private static void</b> <a id="a52f8fa6bdf9ba7e" href="../R/a52f8fa6bdf9ba7e.html" target="n" data-glyph="76,1" class="i method">ValidateReadParameters</a>(<b>byte</b>[] <span id="r45 rd" class="r45 r">buffer</span>, <b>int</b> <span id="r46 rd" class="r46 r">offset</span>, <b>int</b> <span id="r47 rd" class="r47 r">count</span>)
        {
            <b>if</b> (<span class="r45 r">buffer</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#b50c77b2acc23eca" class="t constructor">ArgumentNullException</a>(<span class="s">$&quot;</span>{<b>nameof</b>(<span class="r45 r">buffer</span>)}<span class="s">&quot;</span>, <span class="s">$&quot;</span>{<b>nameof</b>(<span class="r45 r">buffer</span>)}<span class="s"> cannot be null.</span><span class="s">&quot;</span>);
            }
 
            <b>if</b> (<span class="r46 r">offset</span> &lt; 0)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#27138d3b17d5ff6b" class="t constructor">ArgumentOutOfRangeException</a>(<b>nameof</b>(<span class="r46 r">offset</span>), <span class="s">$&quot;</span>{<b>nameof</b>(<span class="r46 r">offset</span>)}<span class="s"> cannot be less than 0.</span><span class="s">&quot;</span>);
            }
 
            <b>if</b> (<span class="r46 r">offset</span> &gt; <span class="r45 r">buffer</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#27138d3b17d5ff6b" class="t constructor">ArgumentOutOfRangeException</a>(<b>nameof</b>(<span class="r46 r">offset</span>), <span class="s">$&quot;</span>{<b>nameof</b>(<span class="r46 r">offset</span>)}<span class="s"> cannot exceed </span>{<b>nameof</b>(<span class="r45 r">buffer</span>)}<span class="s"> length.</span><span class="s">&quot;</span>);
            }
 
            <b>if</b> (<span class="r47 r">count</span> &lt; 0)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#27138d3b17d5ff6b" class="t constructor">ArgumentOutOfRangeException</a>(<b>nameof</b>(<span class="r47 r">count</span>), <span class="s">$&quot;</span>{<b>nameof</b>(<span class="r47 r">count</span>)}<span class="s"> cannot be less than 0.</span><span class="s">&quot;</span>);
            }
        }
 
        <b>protected override void</b> <a id="cea368c7b3f8742b" href="../R/cea368c7b3f8742b.html" target="n" data-glyph="75,1" class="i method">Dispose</a>(<b>bool</b> <span id="r48 rd" class="r48 r">disposing</span>)
        {
            <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="k">base</a>.<a href="@0@mscorlib/A.html#f35c7d226df4a465" class="i method">Dispose</a>(<span class="r48 r">disposing</span>);
            <span class="c">// Return the buffer to the pool if we&#39;re called from Dispose or a finalizer</span>
            <b>if</b> (<a href="#22c55b6b4e5df580" class="i field">_buffer</a> != <b>null</b>)
            {
                <span class="t t">ArrayPool</span>&lt;<b>byte</b>&gt;.<span class="i property">Shared</span>.<span class="i method">Return</span>(<a href="#22c55b6b4e5df580" class="i field">_buffer</a>, <span class="r49 r">clearArray</span>: <b>true</b>);
                <a href="#22c55b6b4e5df580" class="i field">_buffer</a> = <b>null</b>;
            }
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>long</b>&gt; <a id="09faf0c3d67ab9cb" href="../R/09faf0c3d67ab9cb.html" target="n" data-glyph="76,1" class="i method">GetBlobLengthInternal</a>(<b>bool</b> <span id="r50 rd" class="r50 r">async</span>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r51 rd" class="r51 r">cancellationToken</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">AZC0110</span> <span class="c">// DO NOT use await keyword in possibly synchronous scope.</span>
            <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<span class="r0 r t">TProperties</span>&gt; <span id="r52 rd" class="r52 r">response</span> = <b>await</b> <a href="#b51f25109d3be347" class="i field">_getPropertiesInternalFunc</a>(<span class="r50 r">async</span>, <span class="r51 r">cancellationToken</span>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> <span class="i">AZC0110</span> <span class="c">// DO NOT use await keyword in possibly synchronous scope.</span>
 
            <span class="r52 r">response</span>.<a href="/Azure.Core/A.html#959994a72d6ef38a" class="i method">GetRawResponse</a>().<a href="/Azure.Core/A.html#9f6adbd7e81f8000" class="i property">Headers</a>.<a href="/Azure.Core/A.html#b9e2782d1af92ede" class="i method">TryGetValue</a>(<span class="s">&quot;Content-Length&quot;</span>, <b>out string</b> <span id="r53 rd" class="r53 r">lengthString</span>);
 
            <b>if</b> (<span class="r53 r">lengthString</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#eb98012a74461437" class="t constructor">ArgumentException</a>(<span class="s">$&quot;</span>{<a href="/Azure.Core/A.html#c33e005b997e77ad" class="t t">HttpHeader</a>.<a href="/Azure.Core/A.html#9d4171ae0141e914" class="t t">Names</a>.<a href="/Azure.Core/A.html#20578a044d469e8a" class="i property">ContentLength</a>}<span class="s"> header is missing on get properties response.</span><span class="s">&quot;</span>);
            }
 
            <b>return</b> <a href="@0@mscorlib/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@0@mscorlib/A.html#ef0d0adeba9ac3dc" class="i method">ToInt64</a>(<span class="r53 r">lengthString</span>, <a href="@0@mscorlib/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@0@mscorlib/A.html#26ef1c020f0dbb7a" class="i property">InvariantCulture</a>);
        }
 
        <b>private static long</b> <a id="38fd3fb6df18093b" href="../R/38fd3fb6df18093b.html" target="n" data-glyph="76,1" class="i method">GetBlobLengthFromResponse</a>(<a href="/Azure.Core/A.html#ad97b1910f5ca3eb" class="t t">Response</a> <span id="r54 rd" class="r54 r">response</span>)
        {
            <span class="r54 r">response</span>.<a href="/Azure.Core/A.html#9f6adbd7e81f8000" class="i property">Headers</a>.<a href="/Azure.Core/A.html#b9e2782d1af92ede" class="i method">TryGetValue</a>(<span class="s">&quot;Content-Range&quot;</span>, <b>out string</b> <span id="r55 rd" class="r55 r">lengthString</span>);
 
            <b>if</b> (<span class="r55 r">lengthString</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#eb98012a74461437" class="t constructor">ArgumentException</a>(<span class="s">&quot;Content-Range header is missing on download response.&quot;</span>);
            }
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>[] <span id="r56 rd" class="r56 r">split</span> = <span class="r55 r">lengthString</span>.<a href="@0@mscorlib/A.html#1c4a9dc78ba38999" class="i method">Split</a>(<span class="s">&#39;/&#39;</span>);
            <b>return</b> <a href="@0@mscorlib/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@0@mscorlib/A.html#ef0d0adeba9ac3dc" class="i method">ToInt64</a>(<span class="r56 r">split</span>[1], <a href="@0@mscorlib/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@0@mscorlib/A.html#26ef1c020f0dbb7a" class="i property">InvariantCulture</a>);
        }
 
        <b>private static</b> <a href="/Azure.Core/A.html#d6f9b3aba6783671" class="t t">HttpRange</a> <a id="7799ed3d2f3b7122" href="../R/7799ed3d2f3b7122.html" target="n" data-glyph="76,1" class="i method">GetResponseRange</a>(<a href="/Azure.Core/A.html#ad97b1910f5ca3eb" class="t t">Response</a> <span id="r57 rd" class="r57 r">response</span>)
        {
            <span class="r57 r">response</span>.<a href="/Azure.Core/A.html#9f6adbd7e81f8000" class="i property">Headers</a>.<a href="/Azure.Core/A.html#b9e2782d1af92ede" class="i method">TryGetValue</a>(<span class="s">&quot;Content-Range&quot;</span>, <b>out string</b> <span id="r58 rd" class="r58 r">rangeString</span>);
 
            <b>if</b> (<span class="r58 r">rangeString</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">&quot;Content-Range header is missing on download response.&quot;</span>);
            }
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>[] <span id="r59 rd" class="r59 r">split</span> = <span class="r58 r">rangeString</span>.<a href="@0@mscorlib/A.html#1c4a9dc78ba38999" class="i method">Split</a>(<span class="s">&#39;/&#39;</span>);
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>[] <span id="r60 rd" class="r60 r">rangeSplit</span> = <span class="r59 r">split</span>[0].<a href="@0@mscorlib/A.html#1c4a9dc78ba38999" class="i method">Split</a>(<span class="s">&#39;-&#39;</span>);
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>[] <span id="r61 rd" class="r61 r">firstbyteSplit</span> = <span class="r60 r">rangeSplit</span>[0].<a href="@0@mscorlib/A.html#1c4a9dc78ba38999" class="i method">Split</a>(<span class="s">&#39; &#39;</span>);
 
            <b>long</b> <span id="r62 rd" class="r62 r">firstByte</span> = <a href="@0@mscorlib/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@0@mscorlib/A.html#ef0d0adeba9ac3dc" class="i method">ToInt64</a>(<span class="r61 r">firstbyteSplit</span>[1], <a href="@0@mscorlib/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@0@mscorlib/A.html#26ef1c020f0dbb7a" class="i property">InvariantCulture</a>);
            <b>long</b> <span id="r63 rd" class="r63 r">lastByte</span> = <a href="@0@mscorlib/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@0@mscorlib/A.html#ef0d0adeba9ac3dc" class="i method">ToInt64</a>(<span class="r60 r">rangeSplit</span>[1], <a href="@0@mscorlib/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@0@mscorlib/A.html#26ef1c020f0dbb7a" class="i property">InvariantCulture</a>);
 
            <b>return</b> <b>new</b> <a href="/Azure.Core/A.html#6ed33a49a04456b8" class="t constructor">HttpRange</a>(<span class="r62 r">firstByte</span>, <span class="r63 r">lastByte</span> - <span class="r62 r">firstByte</span> + 1);
        }
 
        <b>public override bool</b> <a id="da7c5141dd4da14b" href="../R/da7c5141dd4da14b.html" target="n" data-glyph="102,1" class="i property">CanRead</a> =&gt; <b>true</b>;
 
        <b>public override bool</b> <a id="06cf95946b7aeb91" href="../R/06cf95946b7aeb91.html" target="n" data-glyph="102,1" class="i property">CanSeek</a> =&gt; <b>true</b>;
 
        <b>public override bool</b> <a id="d1ed3196aaa07f97" href="../R/d1ed3196aaa07f97.html" target="n" data-glyph="102,1" class="i property">CanWrite</a> =&gt; <b>false</b>;
 
        <b>public override long</b> <a id="9bb0f21cb8128ad5" href="../R/9bb0f21cb8128ad5.html" target="n" data-glyph="102,1" class="i property">Length</a> =&gt; <a href="#9329098edd7e36e7" class="i field">_length</a>;
 
        <b>public override long</b> <a id="96830a8f9d9f6334" href="../R/96830a8f9d9f6334.html" target="n" data-glyph="102,1" class="i property">Position</a>
        {
            <b>get</b> =&gt; <a href="#ae078711711fcb0f" class="i field">_position</a>;
            <b>set</b> =&gt; <a href="#52bf2087d6e1deb5" class="i method">Seek</a>(<b>value</b>, <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>.<a href="@0@mscorlib/A.html#c29481af7c617299" class="i field">Begin</a>);
        }
 
        <b>public override long</b> <a id="52bf2087d6e1deb5" href="../R/52bf2087d6e1deb5.html" target="n" data-glyph="72,1" class="i method">Seek</a>(<b>long</b> <span id="r64 rd" class="r64 r">offset</span>, <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a> <span id="r65 rd" class="r65 r">origin</span>)
        {
            <b>long</b> <span id="r66 rd" class="r66 r">newPosition</span> = <a href="#c76cac0f892f5138" class="i method">CalculateNewPosition</a>(<span class="r64 r">offset</span>, <span class="r65 r">origin</span>);
 
            <b>if</b> (<span class="r66 r">newPosition</span> == <a href="#ae078711711fcb0f" class="i field">_position</a>)
            {
                <b>return</b> <a href="#ae078711711fcb0f" class="i field">_position</a>;
            }
 
            <span class="c">// newPosition &lt; 0</span>
            <b>if</b> (<span class="r66 r">newPosition</span> &lt; 0)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#4b20cd3790b6426a" class="t constructor">ArgumentException</a>(<span class="s">$&quot;</span><span class="s">New </span>{<b>nameof</b>(<span class="r64 r">offset</span>)}<span class="s"> cannot be less than 0.  Value was </span>{<span class="r66 r">newPosition</span>}<span class="s">&quot;</span>, <b>nameof</b>(<span class="r64 r">offset</span>));
            }
 
            <span class="c">// newPosition &gt; _length</span>
            <b>if</b> (<span class="r66 r">newPosition</span> &gt; <a href="#9329098edd7e36e7" class="i field">_length</a>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#4b20cd3790b6426a" class="t constructor">ArgumentException</a>(<span class="s">&quot;You cannot seek past the last known length of the underlying blob or file.&quot;</span>, <b>nameof</b>(<span class="r64 r">offset</span>));
            }
 
            <span class="c">// newPosition is less than _position, but within _buffer.</span>
            <b>long</b> <span id="r67 rd" class="r67 r">beginningOfBuffer</span> = <a href="#ae078711711fcb0f" class="i field">_position</a> - <a href="#66227b39ae5d579b" class="i field">_bufferPosition</a>;
            <b>if</b> (<span class="r66 r">newPosition</span> &lt; <a href="#ae078711711fcb0f" class="i field">_position</a> &amp;&amp; <span class="r66 r">newPosition</span> &gt;= <span class="r67 r">beginningOfBuffer</span>)
            {
                <a href="#66227b39ae5d579b" class="i field">_bufferPosition</a> = (<b>int</b>)(<span class="r66 r">newPosition</span> - <span class="r67 r">beginningOfBuffer</span>);
                <a href="#ae078711711fcb0f" class="i field">_position</a> = <span class="r66 r">newPosition</span>;
                <b>return</b> <span class="r66 r">newPosition</span>;
            }
 
            <span class="c">// newPosition is greater than _position, but within _buffer.</span>
            <b>long</b> <span id="r68 rd" class="r68 r">endOfBuffer</span> = <a href="#ae078711711fcb0f" class="i field">_position</a> + (<a href="#2698b322739f1c85" class="i field">_bufferLength</a> - <a href="#66227b39ae5d579b" class="i field">_bufferPosition</a>);
            <b>if</b> (<span class="r66 r">newPosition</span> &gt; <a href="#ae078711711fcb0f" class="i field">_position</a> &amp;&amp; <span class="r66 r">newPosition</span> &lt; <span class="r68 r">endOfBuffer</span>)
            {
                <a href="#66227b39ae5d579b" class="i field">_bufferPosition</a> = (<b>int</b>)(<span class="r66 r">newPosition</span> - <span class="r67 r">beginningOfBuffer</span>);
                <a href="#ae078711711fcb0f" class="i field">_position</a> = <span class="r66 r">newPosition</span>;
                <b>return</b> <span class="r66 r">newPosition</span>;
            }
 
            <span class="c">// newPosition is outside of _buffer, we will need to re-download.</span>
            <a href="#eb9fd1e74a9cfd90" class="i field">_bufferInvalidated</a> = <b>true</b>;
            <a href="#ae078711711fcb0f" class="i field">_position</a> = <span class="r66 r">newPosition</span>;
            <b>return</b> <span class="r66 r">newPosition</span>;
        }
 
        <b>internal long</b> <a id="c76cac0f892f5138" href="../R/c76cac0f892f5138.html" target="n" data-glyph="74,1" class="i method">CalculateNewPosition</a>(<b>long</b> <span id="r69 rd" class="r69 r">offset</span>, <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a> <span id="r70 rd" class="r70 r">origin</span>)
        {
            <b>switch</b> (<span class="r70 r">origin</span>)
            {
                <b>case</b> <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>.<a href="@0@mscorlib/A.html#c29481af7c617299" class="i field">Begin</a>:
                    <b>return</b> <span class="r69 r">offset</span>;
                <b>case</b> <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>.<a href="@0@mscorlib/A.html#efa75a72affe543f" class="i field">Current</a>:
                    <b>return</b> <a href="#ae078711711fcb0f" class="i field">_position</a> + <span class="r69 r">offset</span>;
                <b>case</b> <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>.<a href="@0@mscorlib/A.html#b6e266c635b89485" class="i field">End</a>:
                    <b>if</b> (<a href="#4422213dd3fda319" class="i field">_allowBlobModifications</a>)
                    {
                        <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#4b20cd3790b6426a" class="t constructor">ArgumentException</a>(<span class="s">$&quot;</span><span class="s">Cannot </span>{<b>nameof</b>(<span class="i">Seek</span>)}<span class="s"> with </span>{<b>nameof</b>(<a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>)}<span class="s">.</span>{<b>nameof</b>(<a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>.<a href="@0@mscorlib/A.html#b6e266c635b89485" class="i field">End</a>)}<span class="s"> on a growing blob or file.  Call Stream.Seek(Stream.Length, SeekOrigin.Begin) to get to the end of known data.</span><span class="s">&quot;</span>, <b>nameof</b>(<span class="r70 r">origin</span>));
                    }
                    <b>else</b>
                    {
                        <b>return</b> <a href="#9329098edd7e36e7" class="i field">_length</a> + <span class="r69 r">offset</span>;
                    }
                <b>default</b>:
                    <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#4b20cd3790b6426a" class="t constructor">ArgumentException</a>(<span class="s">$&quot;</span><span class="s">Unknown $</span>{<b>nameof</b>(<a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>)}<span class="s"> value</span><span class="s">&quot;</span>, <b>nameof</b>(<span class="r70 r">origin</span>));
            }
        }
 
        <b>public override void</b> <a id="4830dd4e4665f4c8" href="../R/4830dd4e4665f4c8.html" target="n" data-glyph="72,1" class="i method">SetLength</a>(<b>long</b> <span id="r71 rd" class="r71 r">value</span>)
        {
            <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#ab0acd5f99886747" class="t constructor">NotSupportedException</a>();
        }
 
        <b>public override void</b> <a id="b8e27c53443e8679" href="../R/b8e27c53443e8679.html" target="n" data-glyph="72,1" class="i method">Write</a>(<b>byte</b>[] <span id="r72 rd" class="r72 r">buffer</span>, <b>int</b> <span id="r73 rd" class="r73 r">offset</span>, <b>int</b> <span id="r74 rd" class="r74 r">count</span>)
        {
            <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#ab0acd5f99886747" class="t constructor">NotSupportedException</a>();
        }
 
        <b>public override void</b> <a id="8897d23956ed6bb4" href="../R/8897d23956ed6bb4.html" target="n" data-glyph="72,1" class="i method">Flush</a>() { }
 
        <b>public override</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="26621d1ce8ea9fdb" href="../R/26621d1ce8ea9fdb.html" target="n" data-glyph="72,1" class="i method">FlushAsync</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r75 rd" class="r75 r">cancellationToken</span>)
            =&gt; <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#66f1c3e3e272f591" class="i property">CompletedTask</a>;
    }
}
</pre></td></tr></table></div></body></html>
