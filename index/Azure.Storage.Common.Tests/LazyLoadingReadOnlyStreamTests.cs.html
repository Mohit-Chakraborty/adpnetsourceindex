<!DOCTYPE html>
<html><head><title>LazyLoadingReadOnlyStreamTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(105);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Storage.Common.Tests/LazyLoadingReadOnlyStreamTests.cs" target="_top">LazyLoadingReadOnlyStreamTests.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/storage/Azure.Storage.Common/tests/LazyLoadingReadOnlyStreamTests.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Storage.Common.Tests" target="_top">Azure.Storage.Common.Tests.csproj</a> (Azure.Storage.Common.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">TestFramework</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Shared</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Test</span>;
<b>using</b> <span class="i n">Moq</span>;
<b>using</b> <span class="i n">NUnit</span>.<span class="i n">Framework</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Tests</span>
{
    <b>public class</b> <a id="9912d68482d77177" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="a29b3b26aaa93177">LazyLoadingReadOnlyStreamTests</span></a>
    {
        <b>private class</b> <a id="24cf334a6497cb42" href="R/24cf334a6497cb42.html" target="n" data-glyph="4,1" class="t t">DownloadedContent</a> : <a href="Shared/IDownloadedContent.cs.html#69a48c99dccf0ffd" class="t t">IDownloadedContent</a>
        {
            <b>private readonly</b> <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <a id="f694616815721b8e" href="R/f694616815721b8e.html" target="n" data-glyph="46,2" class="i field">_content</a>;
            <b>public</b> <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <a id="76b5b7979fa62470" href="R/76b5b7979fa62470.html" target="n" data-glyph="102,2" class="i property">Content</a> =&gt; <a href="#f694616815721b8e" class="i field">_content</a>;
 
            <b>public</b> <a id="6f923db827cfc8b6" href="R/6f923db827cfc8b6.html" target="n" data-glyph="72,2" class="t constructor">DownloadedContent</a>(<a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <span id="r0 rd" class="r0 r">stream</span>)
            {
                <a href="#f694616815721b8e" class="i field">_content</a> = <span class="r0 r">stream</span>;
            }
        }
 
        <span class="c">// int just fills the generic requirements, we don&#39;t care about data type and go straight for the raw response</span>
        <b>private static</b> <span class="t t">Mock</span>&lt;<a href="Shared/LazyLoadingReadOnlyStream.cs.html#668efc132d76b6c5" class="t t">LazyLoadingReadOnlyStream</a>&lt;<b>int</b>&gt;.<a href="Shared/LazyLoadingReadOnlyStream.cs.html#719fb6c09b5a56e8" class="t t">DownloadInternalAsync</a>&gt; <a id="0e10087313b86d9c" href="R/0e10087313b86d9c.html" target="n" data-glyph="76,1" class="i method">GetDownloadBehavior</a>(<b>byte</b>[] <span id="r1 rd" class="r1 r">data</span>)
        {
            <span class="c">// just mocking a response from injectable behavior</span>
            <b>var</b> <span id="r2 rd" class="r2 r">downloadMock</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="Shared/LazyLoadingReadOnlyStream.cs.html#668efc132d76b6c5" class="t t">LazyLoadingReadOnlyStream</a>&lt;<b>int</b>&gt;.<a href="Shared/LazyLoadingReadOnlyStream.cs.html#719fb6c09b5a56e8" class="t t">DownloadInternalAsync</a>&gt;();
            <span class="r2 r">downloadMock</span>.<span class="i method">Setup</span>(<span id="r3 rd" class="r3 r">_</span> =&gt; <span class="r3 r">_</span>(<span class="t t">It</span>.<span class="i method">IsAny</span>&lt;<a href="/Azure.Core/A.html#d6f9b3aba6783671" class="t t">HttpRange</a>&gt;(), <span class="t t">It</span>.<span class="i method">IsAny</span>&lt;<a href="/Azure.Storage.Common/A.html#73cd37b24a10f6d5" class="t t">DownloadTransactionalHashingOptions</a>&gt;(), <span class="t t">It</span>.<span class="i method">IsAny</span>&lt;<b>bool</b>&gt;(), <span class="t t">It</span>.<span class="i method">IsAny</span>&lt;<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>&gt;()))
                .<span class="i method">Returns</span>&lt;<a href="/Azure.Core/A.html#d6f9b3aba6783671" class="t t">HttpRange</a>, <a href="/Azure.Storage.Common/A.html#73cd37b24a10f6d5" class="t t">DownloadTransactionalHashingOptions</a>, <b>bool</b>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>&gt;((<span id="r4 rd" class="r4 r">range</span>, <span id="r5 rd" class="r5 r">hashOptions</span>, <span id="r6 rd" class="r6 r">async</span>, <span id="r7 rd" class="r7 r">CancellationToken</span>) =&gt;
                {
                    <b>var</b> <span id="r8 rd" class="r8 r">mockResponse</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<a href="Shared/IDownloadedContent.cs.html#69a48c99dccf0ffd" class="t t">IDownloadedContent</a>&gt;&gt;(<span class="t t">MockBehavior</span>.<span class="i field">Strict</span>);
                    <span class="r8 r">mockResponse</span>.<span class="i method">SetupGet</span>(<span id="r9 rd" class="r9 r">r</span> =&gt; <span class="r9 r">r</span>.<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>)
                        .<span class="i method">Returns</span>(<b>new</b> <a href="#6f923db827cfc8b6" class="t constructor">DownloadedContent</a>(<b>new</b> <a href="@0@mscorlib/A.html#69899d25df5de6e1" class="t constructor">MemoryStream</a>(<span class="r1 r">data</span>, (<b>int</b>)<span class="r4 r">range</span>.<a href="/Azure.Core/A.html#3ba10765d491d4ed" class="i property">Offset</a>, (<b>int</b>)(<span class="r4 r">range</span>.<a href="/Azure.Core/A.html#3cef4dbf2165d8c2" class="i property">Length</a> ?? (<span class="r1 r">data</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> - <span class="r4 r">range</span>.<a href="/Azure.Core/A.html#3ba10765d491d4ed" class="i property">Offset</a>)))));
                    <span class="r8 r">mockResponse</span>.<span class="i method">Setup</span>(<span id="r10 rd" class="r10 r">r</span> =&gt; <span class="r10 r">r</span>.<a href="/Azure.Core/A.html#959994a72d6ef38a" class="i method">GetRawResponse</a>())
                        .<span class="i method">Returns</span>(() =&gt; <b>new</b> <a href="/Azure.Core.TestFramework/A.html#ef2adc622c2950d8" class="t constructor">MockResponse</a>(201).<a href="/Azure.Core.TestFramework/A.html#bfef8e4c220ca463" class="i method">AddHeader</a>(<span class="s">&quot;Content-Range&quot;</span>, <span class="s">$&quot;</span><span class="s">bytes </span>{<span class="r4 r">range</span>.<a href="/Azure.Core/A.html#3ba10765d491d4ed" class="i property">Offset</a>}<span class="s">-</span>{<span class="r4 r">range</span>.<a href="/Azure.Core/A.html#3ba10765d491d4ed" class="i property">Offset</a> + <span class="r4 r">range</span>.<a href="/Azure.Core/A.html#3cef4dbf2165d8c2" class="i property">Length</a> - 1}<span class="s">/</span>{<span class="r1 r">data</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>}<span class="s">&quot;</span>));
                    <b>return</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#11a386e7d7cae64a" class="i method">FromResult</a>(<span class="r8 r">mockResponse</span>.<span class="i property">Object</span>);
                });
 
            <b>return</b> <span class="r2 r">downloadMock</span>;
        }
 
        <span class="c">// int just fills the generic requirements, we don&#39;t care about data type and go straight for the raw response</span>
        <b>private static</b> <span class="t t">Mock</span>&lt;<a href="Shared/LazyLoadingReadOnlyStream.cs.html#668efc132d76b6c5" class="t t">LazyLoadingReadOnlyStream</a>&lt;<b>int</b>&gt;.<a href="Shared/LazyLoadingReadOnlyStream.cs.html#be4daa7f7d130f56" class="t t">GetPropertiesAsync</a>&gt; <a id="db37c04648578234" href="R/db37c04648578234.html" target="n" data-glyph="76,1" class="i method">GetPropertiesBehavior</a>(<b>int</b> <span id="r11 rd" class="r11 r">totalResourceLength</span>)
        {
            <span class="c">// just mocking a response from injectable behavior</span>
            <b>var</b> <span id="r12 rd" class="r12 r">propertiesMock</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="Shared/LazyLoadingReadOnlyStream.cs.html#668efc132d76b6c5" class="t t">LazyLoadingReadOnlyStream</a>&lt;<b>int</b>&gt;.<a href="Shared/LazyLoadingReadOnlyStream.cs.html#be4daa7f7d130f56" class="t t">GetPropertiesAsync</a>&gt;();
            <span class="r12 r">propertiesMock</span>.<span class="i method">Setup</span>(<span id="r13 rd" class="r13 r">_</span> =&gt; <span class="r13 r">_</span>(<span class="t t">It</span>.<span class="i method">IsAny</span>&lt;<b>bool</b>&gt;(), <span class="t t">It</span>.<span class="i method">IsAny</span>&lt;<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>&gt;()))
                .<span class="i method">Returns</span>&lt;<b>bool</b>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>&gt;((<span id="r14 rd" class="r14 r">value</span>, <span id="r15 rd" class="r15 r">cancellationToken</span>) =&gt;
                {
                    <b>var</b> <span id="r16 rd" class="r16 r">mockResponse</span> = <b>new</b> <span class="t constructor">Mock</span>&lt;<a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="t t">Response</a>&lt;<b>int</b>&gt;&gt;(<span class="t t">MockBehavior</span>.<span class="i field">Strict</span>);
                    <span class="r16 r">mockResponse</span>.<span class="i method">Setup</span>(<span id="r17 rd" class="r17 r">r</span> =&gt; <span class="r17 r">r</span>.<a href="/Azure.Core/A.html#959994a72d6ef38a" class="i method">GetRawResponse</a>())
                        .<span class="i method">Returns</span>(() =&gt; <b>new</b> <a href="/Azure.Core.TestFramework/A.html#ef2adc622c2950d8" class="t constructor">MockResponse</a>(200).<a href="/Azure.Core.TestFramework/A.html#bfef8e4c220ca463" class="i method">AddHeader</a>(<span class="s">&quot;Content-Length&quot;</span>, <span class="r11 r">totalResourceLength</span>.<a href="@0@mscorlib/A.html#8d6f2d8bc0589463" class="i method">ToString</a>()));
                    <b>return</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#11a386e7d7cae64a" class="i method">FromResult</a>(<span class="r16 r">mockResponse</span>.<span class="i property">Object</span>);
                });
 
            <b>return</b> <span class="r12 r">propertiesMock</span>;
        }
 
        [<span class="t constructor">TestCase</span>(0, <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>, <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>)]
        [<span class="t constructor">TestCase</span>(0 * <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>, <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>, 3 * <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>)]
        [<span class="t constructor">TestCase</span>(1 * <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>, <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>, 3 * <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>)]
        [<span class="t constructor">TestCase</span>(2 * <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>, <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>, 3 * <a href="/Azure.Storage.Common/A.html#732c01506b3b1b85" class="t t">Constants</a>.<a href="/Azure.Storage.Common/A.html#4240fd6a2382c38e" class="i field">KB</a>)]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="62894b325a09d801" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">AvoidRebuffer</a>(<b>int</b> <span id="r18 rd" class="r18 r">offset</span>, <b>int</b> <span id="r19 rd" class="r19 r">bufferSize</span>, <b>int</b> <span id="r20 rd" class="r20 r">dataSize</span>)
        {
            <b>if</b> (<span class="r18 r">offset</span> &lt; 0 || <span class="r18 r">offset</span> + <span class="r19 r">bufferSize</span> &gt; <span class="r20 r">dataSize</span>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#eb98012a74461437" class="t constructor">ArgumentException</a>(<span class="s">&quot;Bad test definition.&quot;</span>);
            }
 
            <span class="c">// Arrange</span>
            <b>byte</b>[] <span id="r21 rd" class="r21 r">data</span> = <a href="Shared/TestHelper.cs.html#1425737f2a386c6e" class="t t">TestHelper</a>.<a href="Shared/TestHelper.cs.html#f5b415e23fcccc1d" class="i method">GetRandomBuffer</a>(<span class="r20 r">dataSize</span>);
 
            <b>var</b> <span id="r22 rd" class="r22 r">downloadMock</span> = <a href="#0e10087313b86d9c" class="i method">GetDownloadBehavior</a>(<span class="r21 r">data</span>);
            <b>var</b> <span id="r23 rd" class="r23 r">propertiesMock</span> = <a href="#db37c04648578234" class="i method">GetPropertiesBehavior</a>(<span class="r21 r">data</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>);
            <a href="Shared/LazyLoadingReadOnlyStream.cs.html#668efc132d76b6c5" class="k">var</a> <span id="r24 rd" class="r24 r">readStream</span> = <b>new</b> <a href="Shared/LazyLoadingReadOnlyStream.cs.html#a641b49112fc59be" class="t constructor">LazyLoadingReadOnlyStream</a>&lt;<b>int</b>&gt;(
                <span class="r22 r">downloadMock</span>.<span class="i property">Object</span>,
                <span class="r23 r">propertiesMock</span>.<span class="i property">Object</span>,
                <span class="r25 r">hashingOptions</span>: <b>default</b>,
                <span class="r26 r">allowModifications</span>: <b>false</b>,
                <span class="r27 r">initialLenght</span>: <span class="r20 r">dataSize</span>,
                <span class="r28 r">position</span>: <span class="r18 r">offset</span>,
                <span class="r29 r">bufferSize</span>: <span class="r19 r">bufferSize</span>);
 
            <span class="c">// Act</span>
            <b>var</b> <span id="r30 rd" class="r30 r">readTest</span> = <b>new</b> <b>byte</b>[<span class="r19 r">bufferSize</span>];
            <b>foreach</b> (<a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r31 rd" class="r31 r">_</span> <b>in</b> <a href="@0@System.Core/A.html#577032c8811e20d3" class="t t">Enumerable</a>.<a href="@0@System.Core/A.html#fda9d378095a6464" class="i method">Range</a>(0, 10))
            {
                <b>await</b> <span class="r24 r">readStream</span>.<a href="@0@mscorlib/A.html#63db0f8d08c54a3e" class="i method">ReadAsync</a>(<span class="r30 r">readTest</span>, 0, <span class="r30 r">readTest</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>);
                <span class="c">// seek back to exact start of current buffer</span>
                <span class="r24 r">readStream</span>.<a href="Shared/LazyLoadingReadOnlyStream.cs.html#96830a8f9d9f6334" class="i property">Position</a> = <span class="r18 r">offset</span>;
            }
 
            <span class="c">// Assert</span>
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(1, <span class="r22 r">downloadMock</span>.<span class="i property">Invocations</span>.<a href="@0@mscorlib/A.html#6f182bb82f68780e" class="i property">Count</a>);
        }
    }
}
</pre></td></tr></table></div></body></html>
