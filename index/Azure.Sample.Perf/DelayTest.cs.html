<!DOCTYPE html>
<html><head><title>DelayTest.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(53);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Sample.Perf/DelayTest.cs" target="_top">DelayTest.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Sample.Perf" target="_top">Azure.Sample.Perf.csproj</a> (Azure.Sample.Perf)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Test</span>.<span class="i n">Perf</span>;
<b>using</b> <span class="i">CommandLine</span>;
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Sample</span>.<span class="i n">Perf</span>
{
    <b>public class</b> <a id="d29ecd601913828f" href="R/d29ecd601913828f.html" target="n" data-glyph="0,0" class="t t">DelayTest</a> : <a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="t t">PerfTest</a>&lt;<a href="#d29ecd601913828f" class="t t">DelayTest</a>.<a href="#e757307864c6b47b" class="t t">DelayOptions</a>&gt;
    {
        <b>private static int</b> <a id="21751073465f0edb" href="R/21751073465f0edb.html" target="n" data-glyph="46,1" class="i field">_instanceCount</a> = 0;
        <b>private</b> <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <a id="dbd28e98b024186b" href="R/dbd28e98b024186b.html" target="n" data-glyph="46,1" class="i field">_delay</a>;
 
        <b>public</b> <a id="caef99963771b706" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">DelayTest</a>(<a href="#d29ecd601913828f" class="t t">DelayTest</a>.<a href="#e757307864c6b47b" class="t t">DelayOptions</a> <span id="r0 rd" class="r0 r">options</span>) : <a href="/Azure.Test.Perf/A.html#9c8f97d1230a6380" class="k">base</a>(<span class="r0 r">options</span>)
        {
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r1 rd" class="r1 r">instanceCount</span> = <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#09bb1e21afd76cf2" class="i method">Increment</a>(<b>ref</b> <a href="#21751073465f0edb" class="i field">_instanceCount</a>) - 1;
 
            <a href="#dbd28e98b024186b" class="i field">_delay</a> = <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#668d91d771bce54b" class="i method">FromMilliseconds</a>(<span class="r0 r">options</span>.<a href="#fba7b27f20e47d46" class="i property">InitialDelayMs</a> * <a href="@0@mscorlib/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@0@mscorlib/A.html#95354113fadc3083" class="i method">Pow</a>(<span class="r0 r">options</span>.<a href="#a0a2c71a16198ce6" class="i property">InstanceGrowthFactor</a>, <span class="r1 r">instanceCount</span>));
        }
 
        <b>public override void</b> <a id="7ed5a79add008d83" href="R/7ed5a79add008d83.html" target="n" data-glyph="72,1" class="i method">Run</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r2 rd" class="r2 r">cancellationToken</span>)
        {
            <a href="@0@mscorlib/A.html#3980e012bae82e96" class="t t">Thread</a>.<a href="@0@mscorlib/A.html#82aedb56cecde82c" class="i method">Sleep</a>(<a href="#dbd28e98b024186b" class="i field">_delay</a>);
            <a href="#dbd28e98b024186b" class="i field">_delay</a> = <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#668d91d771bce54b" class="i method">FromMilliseconds</a>(<a href="#dbd28e98b024186b" class="i field">_delay</a>.<a href="@0@mscorlib/A.html#0001a4a9e0a9b848" class="i property">TotalMilliseconds</a> * <a href="/Azure.Test.Perf/A.html#6753d1eb81ca846e" class="i property">Options</a>.<a href="#274476e2e7efc047" class="i property">IterationGrowthFactor</a>);
        }
 
        <b>public override async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="392d797f39bd1c0e" href="R/392d797f39bd1c0e.html" target="n" data-glyph="72,1" class="i method">RunAsync</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r3 rd" class="r3 r">cancellationToken</span>)
        {
            <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#b070ae859dd3f7b7" class="i method">Delay</a>(<a href="#dbd28e98b024186b" class="i field">_delay</a>, <span class="r3 r">cancellationToken</span>);
            <a href="#dbd28e98b024186b" class="i field">_delay</a> = <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#668d91d771bce54b" class="i method">FromMilliseconds</a>(<a href="#dbd28e98b024186b" class="i field">_delay</a>.<a href="@0@mscorlib/A.html#0001a4a9e0a9b848" class="i property">TotalMilliseconds</a> * <a href="/Azure.Test.Perf/A.html#6753d1eb81ca846e" class="i property">Options</a>.<a href="#274476e2e7efc047" class="i property">IterationGrowthFactor</a>);
        }
 
        <b>public class</b> <a id="e757307864c6b47b" href="R/e757307864c6b47b.html" target="n" data-glyph="0,1" class="t t"><span id="d3cebf9a38839aa3">DelayOptions</span></a> : <a href="/Azure.Test.Perf/A.html#57187bab792d1f66" class="t t">PerfOptions</a>
        {
            [<span class="i">Option</span>(<span class="s">&quot;initialDelayMs&quot;</span>, <span class="i">Default</span> = 1000, <span class="i">HelpText</span> = <span class="s">&quot;Initial delay (in milliseconds)&quot;</span>)]
            <b>public int</b> <a id="fba7b27f20e47d46" href="R/fba7b27f20e47d46.html" target="n" data-glyph="102,2" class="i property">InitialDelayMs</a> { <b>get</b>; <b>set</b>; }
 
            <span class="c">// Used for verifying the perf framework correctly computes average throughput across parallel tests of different speed.</span>
            <span class="c">// Each instance of this test completes operations at a different rate, to allow for testing scenarios where</span>
            <span class="c">// some instances are still waiting when time expires.  The first instance completes in 1 second per operation,</span>
            <span class="c">// the second instance in 2 seconds, the third instance in 4 seconds, and so on.</span>
            [<span class="i">Option</span>(<span class="s">&quot;instanceGrowthFactor&quot;</span>, <span class="i">Default</span> = 1, <span class="i">HelpText</span> = <span class="s">&quot;Instance growth factor.  The delay of instance N will be (InitialDelayMS * (InstanceGrowthFactor ^ InstanceCount)).&quot;</span>)]
            <b>public double</b> <a id="a0a2c71a16198ce6" href="R/a0a2c71a16198ce6.html" target="n" data-glyph="102,2" class="i property">InstanceGrowthFactor</a> { <b>get</b>; <b>set</b>; }
 
            [<span class="i">Option</span>(<span class="s">&quot;iterationGrowthFactor&quot;</span>, <span class="i">Default</span> = 1, <span class="i">HelpText</span> = <span class="s">&quot;Iteration growth factor.  The delay of iteration N will be (InitialDelayMS * (IterationGrowthFactor ^ IterationCount)).&quot;</span>)]
            <b>public double</b> <a id="274476e2e7efc047" href="R/274476e2e7efc047.html" target="n" data-glyph="102,2" class="i property">IterationGrowthFactor</a> { <b>get</b>; <b>set</b>; }
        }
    }
}
</pre></td></tr></table></div></body></html>
