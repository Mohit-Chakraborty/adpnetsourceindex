<!DOCTYPE html>
<html><head><title>CosmosDBTest.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(167);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#SmokeTest/CosmosDBTest.cs" target="_top">CosmosDBTest.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#SmokeTest" target="_top">SmokeTest.csproj</a> (SmokeTest)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// ------------------------------------</span>
<span class="c">// Copyright(c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
<span class="c">// ------------------------------------</span>
<b>using</b> <span class="i">Microsoft</span>.<span class="i">Azure</span>.<span class="i">Documents</span>;
<b>using</b> <span class="i">Microsoft</span>.<span class="i">Azure</span>.<span class="i">Documents</span>.<span class="i">Client</span>;
<b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>;
<b>using</b> <span class="i">System</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
 
<b>namespace</b> <span class="i n">SmokeTest</span>
{
    <b>public class</b> <a id="caedc76514d38e8c" href="R/caedc76514d38e8c.html" target="n" data-glyph="0,0" class="t t"><span id="9238e3c2db53c4a3">Planet</span></a>
    {
        [<span class="i">JsonProperty</span>(<span class="i">PropertyName</span> = <span class="s">&quot;id&quot;</span>)]
        <b>public string</b> <a id="0f141c4b5643f72f" href="R/0f141c4b5643f72f.html" target="n" data-glyph="102,1" class="i property">Id</a> { <b>get</b>; <b>set</b>; }
        <b>public bool</b> <a id="bd17bd83cc630be7" href="R/bd17bd83cc630be7.html" target="n" data-glyph="102,1" class="i property">HasRings</a> { <b>get</b>; <b>set</b>; }
        <b>public int</b> <a id="96e8e8c80044e123" href="R/96e8e8c80044e123.html" target="n" data-glyph="102,1" class="i property">Radius</a> { <b>get</b>; <b>set</b>; }
        <b>public</b> <a href="#0edae6fb409c8ce5" class="t t">Moon</a>[] <a id="0e81c35114ec7e43" href="R/0e81c35114ec7e43.html" target="n" data-glyph="102,1" class="i property">Moons</a> { <b>get</b>; <b>set</b>; }
        <b>public override string</b> <a id="d99544b0743b19e9" href="R/d99544b0743b19e9.html" target="n" data-glyph="72,1" class="i method">ToString</a>()
        {
            <b>return</b> <span class="i">JsonConvert</span>.<span class="i">SerializeObject</span>(<a href="#caedc76514d38e8c" class="k">this</a>);
        }
    }
 
    <b>public class</b> <a id="0edae6fb409c8ce5" href="R/0edae6fb409c8ce5.html" target="n" data-glyph="0,0" class="t t"><span id="fa1dced469a8230c">Moon</span></a>
    {
        <b>public string</b> <a id="cda5c0efe07d6c7d" href="R/cda5c0efe07d6c7d.html" target="n" data-glyph="102,1" class="i property">Name</a> { <b>get</b>; <b>set</b>; }
    }
 
    <b>class</b> <a id="00caa55620b2f5b7" href="R/../../0000000000.html" target="n" data-glyph="2,0" class="t t"><span id="95f5f9b2e2b06b93">CosmosDBTest</span></a>
    {
        <b>private static</b> <span class="i">DocumentClient</span> <a id="81019b7e3ee41a9b" href="R/81019b7e3ee41a9b.html" target="n" data-glyph="46,1" class="i field">client</a>;
        <b>private static string</b> <a id="9aaa2e8534f0fb52" href="R/9aaa2e8534f0fb52.html" target="n" data-glyph="46,1" class="i field">DataBaseName</a> = <span class="s">$&quot;</span><span class="s">netSolarSystemDB-</span>{<span class="i">Guid</span>.<span class="i">NewGuid</span>()}<span class="s">&quot;</span>;
        <b>private const string</b> <a id="d06d511da82d8572" href="R/d06d511da82d8572.html" target="n" data-glyph="10,1" class="i field">CollectionName</a> = <span class="s">&quot;PlanetsCollection&quot;</span>;
        <b>private static</b> <span class="i">List</span>&lt;<a href="#caedc76514d38e8c" class="t t">Planet</a>&gt; <a id="ca3864b46d7fa2a7" href="R/ca3864b46d7fa2a7.html" target="n" data-glyph="46,1" class="i field">planets</a> = <b>new</b> <span class="i">List</span>&lt;<a href="#caedc76514d38e8c" class="t t">Planet</a>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test the Cosmos DB SDK by creating an example Database called {DataBaseName} and a PlanetsCollection with planets on it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static async</b> <span class="i">Task</span> <a id="2ec5ec6481c12e8a" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">RunTests</a>()
        {
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;\n---------------------------------&quot;</span>);
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;COSMOS DB&quot;</span>);
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;---------------------------------&quot;</span>);
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;Functionalities to test: 5:&quot;</span>);
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;1.- Create a Database&quot;</span>);
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;2.- Create a Collection in the DB&quot;</span>);
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;3.- Create 2 JSON Documents (Items) in the collection&quot;</span>);
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;4.- Excecute simple query to the collection&quot;</span>);
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;5.- Clean up the resource (Delete DB)\n&quot;</span>);
 
            <b>string</b> <span id="r0 rd" class="r0 r">endpoint</span> = <span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<span class="s">&quot;COSMOS_URI&quot;</span>);
            <b>string</b> <span id="r1 rd" class="r1 r">authKey</span> = <span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<span class="s">&quot;COSMOS_AUTH_KEY&quot;</span>);
            <a href="#81019b7e3ee41a9b" class="i field">client</a> = <b>new</b> <span class="i">DocumentClient</span>(<b>new</b> <span class="i">Uri</span>(<span class="r0 r">endpoint</span>), <span class="r1 r">authKey</span>);
 
            <span class="c">//Delete the database to ensure that the test environment is clean.</span>
            <b>try</b>
            {
                <b>await</b> <a href="#add0229c3151bebc" class="i method">DeleteDatabase</a>();
            }
            <b>catch</b>
            { }
 
            <b>await</b> <a href="#cea8dbcb7fa02f3c" class="i method">CreateDatabase</a>();
            <b>await</b> <a href="#04ea2b419b053fcd" class="i method">CreateCollection</a>();
            <b>await</b> <a href="#d5c2f81ea095dc46" class="i method">CreateDocuments</a>();
            <a href="#eb6952cecb9696a6" class="i method">ExecuteSimpleQuery</a>();
            <b>await</b> <a href="#add0229c3151bebc" class="i method">DeleteDatabase</a>();
        }
 
        <b>private static async</b> <span class="i">Task</span> <a id="cea8dbcb7fa02f3c" href="R/cea8dbcb7fa02f3c.html" target="n" data-glyph="76,1" class="i method">CreateDatabase</a>()
        {
            <span class="i">Console</span>.<span class="i">Write</span>(<span class="s">&quot;Creating Database &#39;&quot;</span> + <a href="#9aaa2e8534f0fb52" class="i field">DataBaseName</a> + <span class="s">&quot;&#39;...&quot;</span>);
            <b>await</b> <a href="#81019b7e3ee41a9b" class="i field">client</a>.<span class="i">CreateDatabaseIfNotExistsAsync</span>(<b>new</b> <span class="i">Database</span> { <span class="i">Id</span> = <a href="#9aaa2e8534f0fb52" class="i field">DataBaseName</a> });
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;\tdone&quot;</span>);
        }
 
        <b>private static async</b> <span class="i">Task</span> <a id="04ea2b419b053fcd" href="R/04ea2b419b053fcd.html" target="n" data-glyph="76,1" class="i method">CreateCollection</a>()
        {
            <span class="i">Console</span>.<span class="i">Write</span>(<span class="s">&quot;Creating collection &#39;&quot;</span> + <a href="#d06d511da82d8572" class="i field">CollectionName</a> + <span class="s">&quot;&#39;...&quot;</span>);
            <b>await</b> <a href="#81019b7e3ee41a9b" class="i field">client</a>.<span class="i">CreateDocumentCollectionIfNotExistsAsync</span>(<span class="i">UriFactory</span>.<span class="i">CreateDatabaseUri</span>(<a href="#9aaa2e8534f0fb52" class="i field">DataBaseName</a>), <b>new</b> <span class="i">DocumentCollection</span> { <span class="i">Id</span> = <a href="#d06d511da82d8572" class="i field">CollectionName</a> });
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;\tdone&quot;</span>);
        }
 
        <b>private static async</b> <span class="i">Task</span> <a id="d5c2f81ea095dc46" href="R/d5c2f81ea095dc46.html" target="n" data-glyph="76,1" class="i method">CreateDocuments</a>()
        {
            <a href="#ca3864b46d7fa2a7" class="i field">planets</a>.<span class="i">Add</span>(<b>new</b> <span class="t">Planet</span>
            {
                <a href="#0f141c4b5643f72f" class="i property">Id</a> = <span class="s">&quot;Earth&quot;</span>,
                <a href="#bd17bd83cc630be7" class="i property">HasRings</a> = <b>false</b>,
                <a href="#96e8e8c80044e123" class="i property">Radius</a> = 3959,
                <a href="#0e81c35114ec7e43" class="i property">Moons</a> = <b>new</b> <a href="#0edae6fb409c8ce5" class="t t">Moon</a>[]
               {
                    <b>new</b> <span class="t">Moon</span>
                    {
                        <a href="#cda5c0efe07d6c7d" class="i property">Name</a> = <span class="s">&quot;Moon&quot;</span>
                    }
               }
            });
            <a href="#ca3864b46d7fa2a7" class="i field">planets</a>.<span class="i">Add</span>(<b>new</b> <span class="t">Planet</span>
            {
                <a href="#0f141c4b5643f72f" class="i property">Id</a> = <span class="s">&quot;Mars&quot;</span>,
                <a href="#bd17bd83cc630be7" class="i property">HasRings</a> = <b>false</b>,
                <a href="#96e8e8c80044e123" class="i property">Radius</a> = 2106,
                <a href="#0e81c35114ec7e43" class="i property">Moons</a> = <b>new</b> <a href="#0edae6fb409c8ce5" class="t t">Moon</a>[]
                {
                    <b>new</b> <span class="t">Moon</span>
                    {
                        <a href="#cda5c0efe07d6c7d" class="i property">Name</a> = <span class="s">&quot;Phobos&quot;</span>
                    },
                    <b>new</b> <span class="t">Moon</span>
                    {
                        <a href="#cda5c0efe07d6c7d" class="i property">Name</a> = <span class="s">&quot;Deimos&quot;</span>
                    }
                }
            });
 
            <span class="c">//The items must NOT exists in the collection</span>
            <b>foreach</b> (<a href="#caedc76514d38e8c" class="t t">Planet</a> <span id="r2 rd" class="r2 r">planet</span> <b>in</b> <a href="#ca3864b46d7fa2a7" class="i field">planets</a>)
            {
                <span class="i">Console</span>.<span class="i">Write</span>(<span class="s">&quot;Inserting &#39;&quot;</span>+<span class="r2 r">planet</span>.<a href="#0f141c4b5643f72f" class="i property">Id</a>+<span class="s">&quot;&#39; document...&quot;</span>);
                <b>await</b> <a href="#81019b7e3ee41a9b" class="i field">client</a>.<span class="i">CreateDocumentAsync</span>(<span class="i">UriFactory</span>.<span class="i">CreateDocumentCollectionUri</span>(<a href="#9aaa2e8534f0fb52" class="i field">DataBaseName</a>, <a href="#d06d511da82d8572" class="i field">CollectionName</a>), <span class="r2 r">planet</span>);
                <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;\tdone&quot;</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The query retrieve all planets, this is going to verify that planets match</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static void</b> <a id="eb6952cecb9696a6" href="R/eb6952cecb9696a6.html" target="n" data-glyph="76,1" class="i method">ExecuteSimpleQuery</a>(){
            <span class="i">Console</span>.<span class="i">Write</span>(<span class="s">&quot;Querying... &quot;</span>);
            <span class="i">IQueryable</span>&lt;<a href="#caedc76514d38e8c" class="t t">Planet</a>&gt; <span id="r3 rd" class="r3 r">planetarySqlQuery</span> = <a href="#81019b7e3ee41a9b" class="i field">client</a>.<span class="i">CreateDocumentQuery</span>&lt;<a href="#caedc76514d38e8c" class="t t">Planet</a>&gt;(<span class="i">UriFactory</span>.<span class="i">CreateDocumentCollectionUri</span>(<a href="#9aaa2e8534f0fb52" class="i field">DataBaseName</a>, <a href="#d06d511da82d8572" class="i field">CollectionName</a>), <span class="s">&quot;SELECT * FROM c&quot;</span>);
 
            <b>var</b> <span id="r4 rd" class="r4 r">planetsSet</span> = <b>new</b> <span class="i">HashSet</span>&lt;<b>string</b>&gt;();
            <b>foreach</b>(<a href="#caedc76514d38e8c" class="t t">Planet</a> <span id="r5 rd" class="r5 r">planet</span> <b>in</b> <a href="#ca3864b46d7fa2a7" class="i field">planets</a>)
            {
                <span class="r4 r">planetsSet</span>.<span class="i">Add</span>(<span class="r5 r">planet</span>.<a href="#d99544b0743b19e9" class="i method">ToString</a>());
            }
 
            <b>int</b> <span id="r6 rd" class="r6 r">i</span> = 0;
            <b>foreach</b> (<a href="#caedc76514d38e8c" class="t t">Planet</a> <span id="r7 rd" class="r7 r">planet</span> <b>in</b> <span class="r3 r">planetarySqlQuery</span>)
            {
                <b>var</b> <span id="r8 rd" class="r8 r">serializedPlanet</span> = <span class="r7 r">planet</span>.<a href="#d99544b0743b19e9" class="i method">ToString</a>();
                <b>if</b> (<span class="r4 r">planetsSet</span>.<span class="i">Contains</span>(<span class="r8 r">serializedPlanet</span>))
                {
                    <span class="r6 r">i</span>++;
                }
            }
 
            <b>if</b>(<span class="r6 r">i</span> != <a href="#ca3864b46d7fa2a7" class="i field">planets</a>.<span class="i">Count</span>)
            {
                <b>throw</b> <b>new</b> <span class="i">Exception</span>(<span class="s">&quot;Error, values do not match.&quot;</span>);
            }
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;\tdone&quot;</span>);
        }
 
        <b>private static async</b> <span class="i">Task</span> <a id="add0229c3151bebc" href="R/add0229c3151bebc.html" target="n" data-glyph="76,1" class="i method">DeleteDatabase</a>()
        {
            <span class="i">Console</span>.<span class="i">Write</span>(<span class="s">&quot;Cleaning up the resource...&quot;</span>);
            <b>await</b> <a href="#81019b7e3ee41a9b" class="i field">client</a>.<span class="i">DeleteDatabaseAsync</span>(<span class="i">UriFactory</span>.<span class="i">CreateDatabaseUri</span>(<a href="#9aaa2e8534f0fb52" class="i field">DataBaseName</a>));
            <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="s">&quot;\tdone&quot;</span>);
        }
    }
}</pre></td></tr></table></div></body></html>
