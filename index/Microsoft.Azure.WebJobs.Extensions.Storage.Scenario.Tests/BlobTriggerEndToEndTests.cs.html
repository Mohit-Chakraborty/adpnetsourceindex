<!DOCTYPE html>
<html><head><title>BlobTriggerEndToEndTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(356);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.WebJobs.Extensions.Storage.Scenario.Tests/BlobTriggerEndToEndTests.cs" target="_top">BlobTriggerEndToEndTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.WebJobs.Extensions.Storage.Scenario.Tests" target="_top">Microsoft.Azure.WebJobs.Extensions.Storage.Scenario.Tests.csproj</a> (Microsoft.Azure.WebJobs.Extensions.Storage.Scenario.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">TestFramework</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Blobs</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Blobs</span>.<span class="i n">Specialized</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Queues</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">WebJobs</span>.<span class="i n">Extensions</span>.<span class="i n">Storage</span>.<span class="i n">Common</span>.<span class="i n">Tests</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">WebJobs</span>.<span class="i n">Host</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">WebJobs</span>.<span class="i n">Host</span>.<span class="i n">Executors</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">DependencyInjection</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Hosting</span>;
<b>using</b> <span class="i n">Newtonsoft</span>.<span class="i n">Json</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">NUnit</span>.<span class="i n">Framework</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">WebJobs</span>.<span class="i n">Extensions</span>.<span class="i n">Storage</span>.<span class="i n">ScenarioTests</span>
{
    <b>public class</b> <a id="7a93572f834f8b61" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">BlobTriggerEndToEndTests</a> : <a href="/Azure.Core.TestFramework/A.html#f9e2d2f7614dcccf" class="t t">LiveTestBase</a>&lt;<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#288f73a0244d6c9d" class="t t">WebJobsTestEnvironment</a>&gt;, <a href="@0@mscorlib/A.html#1f55292c3174123d" class="t t">IDisposable</a>
    {
        <b>private const string</b> <a id="15bfd95d91930b91" href="R/15bfd95d91930b91.html" target="n" data-glyph="10,1" class="i field">TestArtifactPrefix</a> = <span class="s">&quot;e2etests&quot;</span>;
 
        <b>private const string</b> <a id="7ff713c8412f2504" href="R/7ff713c8412f2504.html" target="n" data-glyph="10,1" class="i field">SingleTriggerContainerName</a> = <a href="#15bfd95d91930b91" class="i field">TestArtifactPrefix</a> + <span class="s">&quot;singletrigger-%rnd%&quot;</span>;
        <b>private const string</b> <a id="8d1f67c6bf1bb2b7" href="R/8d1f67c6bf1bb2b7.html" target="n" data-glyph="10,1" class="i field">PoisonTestContainerName</a> = <a href="#15bfd95d91930b91" class="i field">TestArtifactPrefix</a> + <span class="s">&quot;poison-%rnd%&quot;</span>;
        <b>private const string</b> <a id="4bb9647f25b28aaf" href="R/4bb9647f25b28aaf.html" target="n" data-glyph="10,1" class="i field">TestBlobName</a> = <span class="s">&quot;test&quot;</span>;
 
        <b>private const string</b> <a id="5a392bafea9d6697" href="R/5a392bafea9d6697.html" target="n" data-glyph="10,1" class="i field">BlobChainContainerName</a> = <a href="#15bfd95d91930b91" class="i field">TestArtifactPrefix</a> + <span class="s">&quot;blobchain-%rnd%&quot;</span>;
        <b>private const string</b> <a id="d2fc19f81c99e678" href="R/d2fc19f81c99e678.html" target="n" data-glyph="10,1" class="i field">BlobChainTriggerBlobName</a> = <span class="s">&quot;blob&quot;</span>;
        <b>private const string</b> <a id="44cc81706d4d6724" href="R/44cc81706d4d6724.html" target="n" data-glyph="10,1" class="i field">BlobChainTriggerBlobPath</a> = <a href="#5a392bafea9d6697" class="i field">BlobChainContainerName</a> + <span class="s">&quot;/&quot;</span> + <a href="#d2fc19f81c99e678" class="i field">BlobChainTriggerBlobName</a>;
        <b>private const string</b> <a id="93261f34a0f63dd6" href="R/93261f34a0f63dd6.html" target="n" data-glyph="10,1" class="i field">BlobChainCommittedQueueName</a> = <span class="s">&quot;committed&quot;</span>;
        <b>private const string</b> <a id="455dca77a7c53480" href="R/455dca77a7c53480.html" target="n" data-glyph="10,1" class="i field">BlobChainIntermediateBlobPath</a> = <a href="#5a392bafea9d6697" class="i field">BlobChainContainerName</a> + <span class="s">&quot;/&quot;</span> + <span class="s">&quot;blob.middle&quot;</span>;
        <b>private const string</b> <a id="0c3b249dcf272153" href="R/0c3b249dcf272153.html" target="n" data-glyph="10,1" class="i field">BlobChainOutputBlobName</a> = <span class="s">&quot;blob.out&quot;</span>;
        <b>private const string</b> <a id="8899b37760379cdd" href="R/8899b37760379cdd.html" target="n" data-glyph="10,1" class="i field">BlobChainOutputBlobPath</a> = <a href="#5a392bafea9d6697" class="i field">BlobChainContainerName</a> + <span class="s">&quot;/&quot;</span> + <a href="#0c3b249dcf272153" class="i field">BlobChainOutputBlobName</a>;
 
        <b>private readonly</b> <a href="/Azure.Storage.Blobs/A.html#6bb2c165ee95c7d4" class="t t">BlobContainerClient</a> <a id="f8cd21481d3fe9da" href="R/f8cd21481d3fe9da.html" target="n" data-glyph="46,1" class="i field">_testContainer</a>;
        <b>private readonly</b> <a href="/Azure.Storage.Blobs/A.html#5c3c4fe54cdb5868" class="t t">BlobServiceClient</a> <a id="736e0fc7b9aae489" href="R/736e0fc7b9aae489.html" target="n" data-glyph="46,1" class="i field">_blobServiceClient</a>;
        <b>private readonly</b> <a href="/Azure.Storage.Queues/A.html#ef0f353b721b0444" class="t t">QueueServiceClient</a> <a id="4f589c76c8be4f07" href="R/4f589c76c8be4f07.html" target="n" data-glyph="46,1" class="i field">_queueServiceClient</a>;
        <b>private readonly</b> <a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#f107bd899291b5d4" class="t t">RandomNameResolver</a> <a id="5c419e56b07d4845" href="R/5c419e56b07d4845.html" target="n" data-glyph="46,1" class="i field">_nameResolver</a>;
 
        <b>private static object</b> <a id="9d2062ada99a712a" href="R/9d2062ada99a712a.html" target="n" data-glyph="46,1" class="i field">_syncLock</a> = <b>new</b> <b>object</b>();
 
        <b>public</b> <a id="dfb3cb772aa71581" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">BlobTriggerEndToEndTests</a>()
        {
            <a href="#5c419e56b07d4845" class="i field">_nameResolver</a> = <b>new</b> <a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#1e1e22aac421ca23" class="t constructor">RandomNameResolver</a>();
 
            <span class="c">// pull from a default host</span>
            <b>var</b> <span id="r0 rd" class="r0 r">host</span> = <b>new</b> <span class="t constructor">HostBuilder</span>()
                .<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#348e9e432ee4d5b9" class="i method">ConfigureDefaultTestHost</a>(<span id="r1 rd" class="r1 r">b</span> =&gt;
                {
                    <span class="r1 r">b</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#a4ba870e12f90f4a" class="i method">AddAzureStorageBlobs</a>().<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#88bea00a76ab1f62" class="i method">AddAzureStorageQueues</a>();
                })
                .<span class="i method">Build</span>();
            <a href="#736e0fc7b9aae489" class="i field">_blobServiceClient</a> = <b>new</b> <a href="/Azure.Storage.Blobs/A.html#66aac072e757eda3" class="t constructor">BlobServiceClient</a>(<a href="/Azure.Core.TestFramework/A.html#26a1e2ab3c3c535e" class="i property">TestEnvironment</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#0f55788eb27fcd2b" class="i property">PrimaryStorageAccountConnectionString</a>);
            <a href="#4f589c76c8be4f07" class="i field">_queueServiceClient</a> = <b>new</b> <a href="/Azure.Storage.Queues/A.html#e53e713f2d2882f0" class="t constructor">QueueServiceClient</a>(<a href="/Azure.Core.TestFramework/A.html#26a1e2ab3c3c535e" class="i property">TestEnvironment</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#0f55788eb27fcd2b" class="i property">PrimaryStorageAccountConnectionString</a>); <span class="c">// No encoding</span>
            <a href="#f8cd21481d3fe9da" class="i field">_testContainer</a> = <a href="#736e0fc7b9aae489" class="i field">_blobServiceClient</a>.<a href="/Azure.Storage.Blobs/A.html#e3b6b5726874c210" class="i method">GetBlobContainerClient</a>(<a href="#5c419e56b07d4845" class="i field">_nameResolver</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#454ee046bb695881" class="i method">ResolveInString</a>(<a href="#7ff713c8412f2504" class="i field">SingleTriggerContainerName</a>));
            <span class="t t">Assert</span>.<span class="i method">False</span>(<a href="#f8cd21481d3fe9da" class="i field">_testContainer</a>.<a href="/Azure.Storage.Blobs/A.html#3a094ee87deb9190" class="i method">ExistsAsync</a>().<a href="@0@mscorlib/A.html#826690b09f24e719" class="i property">Result</a>);
            <a href="#f8cd21481d3fe9da" class="i field">_testContainer</a>.<a href="/Azure.Storage.Blobs/A.html#47f53d489abf3bfe" class="i method">CreateAsync</a>().<a href="@0@mscorlib/A.html#1bfe9e19e44f4cfa" class="i method">Wait</a>();
        }
 
        <b>public</b> <span class="t t">IHostBuilder</span> <a id="3672048349488ee6" href="R/3672048349488ee6.html" target="n" data-glyph="72,1" class="i method">NewBuilder</a>&lt;<span id="r2 rd t" class="r2 r t">TProgram</span>&gt;(<span class="r2 r t">TProgram</span> <span id="r3 rd" class="r3 r">program</span>, <a href="@0@mscorlib/A.html#486d58da4553e12d" class="t t">Action</a>&lt;<span class="t t">IWebJobsBuilder</span>&gt; <span id="r4 rd" class="r4 r">configure</span> = <b>null</b>)
        {
            <a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#ea9db6c44c07a012" class="k">var</a> <span id="r5 rd" class="r5 r">activator</span> = <b>new</b> <a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#74ba712bac4d90f3" class="t constructor">FakeActivator</a>();
            <span class="r5 r">activator</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#99f97e63638fdfa2" class="i method">Add</a>(<span class="r3 r">program</span>);
 
            <b>return</b> <b>new</b> <span class="t constructor">HostBuilder</span>()
                .<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#8e7ac0e678c7c7a5" class="i method">ConfigureDefaultTestHost</a>&lt;<span class="r2 r t">TProgram</span>&gt;(<span id="r6 rd" class="r6 r">b</span> =&gt;
                {
                    <span class="r6 r">b</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#a4ba870e12f90f4a" class="i method">AddAzureStorageBlobs</a>().<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#88bea00a76ab1f62" class="i method">AddAzureStorageQueues</a>();
                    <span class="r4 r">configure</span>?.<a href="@0@mscorlib/A.html#2d4ce5e8c3a9aa80" class="i method">Invoke</a>(<span class="r6 r">b</span>);
                })
                .<span class="i method">ConfigureServices</span>(<span id="r7 rd" class="r7 r">services</span> =&gt;
                {
                    <span class="r7 r">services</span>.<span class="i method">AddSingleton</span>&lt;<span class="t t">IJobActivator</span>&gt;(<span class="r5 r">activator</span>);
                    <span class="r7 r">services</span>.<span class="i method">AddSingleton</span>&lt;<span class="t t">INameResolver</span>&gt;(<a href="#5c419e56b07d4845" class="i field">_nameResolver</a>);
                });
        }
 
        <b>public class</b> <a id="db058dec5a5e7d16" href="R/db058dec5a5e7d16.html" target="n" data-glyph="0,1" class="t t"><span id="f00964a2572c0ef3">Poison_Program</span></a>
        {
            <b>public</b> <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <a id="8b1d6dce630c9e28" href="R/8b1d6dce630c9e28.html" target="n" data-glyph="42,2" class="i field">_poisonBlobMessagesPrimary</a> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;();
            <b>public</b> <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <a id="6bc2a63fd94a1d0a" href="R/6bc2a63fd94a1d0a.html" target="n" data-glyph="42,2" class="i field">_poisonBlobMessagesSecondary</a> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;();
 
            <b>public void</b> <a id="67122cc9b4d8b301" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">BlobProcessorPrimary</a>(
                [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#bb93ab668e365624" class="t constructor">BlobTrigger</a>(<a href="#8d1f67c6bf1bb2b7" class="i field">PoisonTestContainerName</a> + <span class="s">&quot;/{name}&quot;</span>)] <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r8 rd" class="r8 r">input</span>)
            {
                <span class="c">// throw to generate a poison blob message</span>
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#5ee7f173f9e53170" class="t constructor">Exception</a>();
            }
 
            <span class="c">// process the poison queue for the primary storage account</span>
            <b>public void</b> <a id="1112b9b45bb8cfee" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">PoisonBlobQueueProcessorPrimary</a>(
                [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#c3e2dc420c6e33e5" class="t constructor">QueueTrigger</a>(<span class="s">&quot;webjobs-blobtrigger-poison&quot;</span>)] <span class="t t">JObject</span> <span id="r9 rd" class="r9 r">message</span>)
            {
                <b>lock</b> (<a href="#9d2062ada99a712a" class="i field">_syncLock</a>)
                {
                    <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r10 rd" class="r10 r">blobName</span> = (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>)<span class="r9 r">message</span>[<span class="s">&quot;BlobName&quot;</span>];
                    <a href="#8b1d6dce630c9e28" class="i field">_poisonBlobMessagesPrimary</a>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r10 r">blobName</span>);
                }
            }
 
            <b>public void</b> <a id="d5ed02e82aca0eba" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">BlobProcessorSecondary</a>(
                [<span class="t constructor">StorageAccount</span>(<span class="s">&quot;SecondaryStorage&quot;</span>)]
            [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#bb93ab668e365624" class="t constructor">BlobTrigger</a>(<a href="#8d1f67c6bf1bb2b7" class="i field">PoisonTestContainerName</a> + <span class="s">&quot;/{name}&quot;</span>)] <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r11 rd" class="r11 r">input</span>)
            {
                <span class="c">// throw to generate a poison blob message</span>
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#5ee7f173f9e53170" class="t constructor">Exception</a>();
            }
 
            <span class="c">// process the poison queue for the secondary storage account</span>
            <b>public void</b> <a id="6452869d37691a05" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">PoisonBlobQueueProcessorSecondary</a>(
                [<span class="t constructor">StorageAccount</span>(<span class="s">&quot;SecondaryStorage&quot;</span>)]
            [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#c3e2dc420c6e33e5" class="t constructor">QueueTrigger</a>(<span class="s">&quot;webjobs-blobtrigger-poison&quot;</span>)] <span class="t t">JObject</span> <span id="r12 rd" class="r12 r">message</span>)
            {
                <b>lock</b> (<a href="#9d2062ada99a712a" class="i field">_syncLock</a>)
                {
                    <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r13 rd" class="r13 r">blobName</span> = (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>)<span class="r12 r">message</span>[<span class="s">&quot;BlobName&quot;</span>];
                    <a href="#6bc2a63fd94a1d0a" class="i field">_poisonBlobMessagesSecondary</a>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r13 r">blobName</span>);
                }
            }
        }
 
        <b>public class</b> <a id="c539f2d84389dba9" href="R/c539f2d84389dba9.html" target="n" data-glyph="0,1" class="t t"><span id="02f9dbc1b37223ea">BlobGetsProcessedOnlyOnce_SingleHost_Program</span></a>
        {
            <b>public int</b> <a id="a74a3ea212fb93f4" href="R/a74a3ea212fb93f4.html" target="n" data-glyph="42,2" class="i field">_timesProcessed</a>;
            <b>public</b> <a href="@0@mscorlib/A.html#797f9a2c1f6fe76f" class="t t">ManualResetEvent</a> <a id="42e1da43009c856c" href="R/42e1da43009c856c.html" target="n" data-glyph="42,2" class="i field">_completedEvent</a>;
 
            <b>public void</b> <a id="0e8fd5b90bb2fd0d" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">SingleBlobTrigger</a>(
                [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#bb93ab668e365624" class="t constructor">BlobTrigger</a>(<a href="#7ff713c8412f2504" class="i field">SingleTriggerContainerName</a> + <span class="s">&quot;/{name}&quot;</span>)] <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r14 rd" class="r14 r">sleepTimeInSeconds</span>)
            {
                <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#09bb1e21afd76cf2" class="i method">Increment</a>(<b>ref</b> <a href="#a74a3ea212fb93f4" class="i field">_timesProcessed</a>);
 
                <b>int</b> <span id="r15 rd" class="r15 r">sleepTime</span> = <b>int</b>.<a href="@0@mscorlib/A.html#a438016f815a35c3" class="i method">Parse</a>(<span class="r14 r">sleepTimeInSeconds</span>) * 1000;
                <a href="@0@mscorlib/A.html#3980e012bae82e96" class="t t">Thread</a>.<a href="@0@mscorlib/A.html#5f1072b92dae1dd8" class="i method">Sleep</a>(<span class="r15 r">sleepTime</span>);
 
                <a href="#42e1da43009c856c" class="i field">_completedEvent</a>.<a href="@0@mscorlib/A.html#63f3d76fa45ccc3d" class="i method">Set</a>();
            }
        }
 
        <b>public class</b> <a id="206c7accb0e2747b" href="R/206c7accb0e2747b.html" target="n" data-glyph="0,1" class="t t"><span id="d663203ed48d3c72">BlobChainTest_Program</span></a>
        {
            <b>public</b> <a href="@0@mscorlib/A.html#797f9a2c1f6fe76f" class="t t">ManualResetEvent</a> <a id="a36ecff356a6a480" href="R/a36ecff356a6a480.html" target="n" data-glyph="42,2" class="i field">_completedEvent</a>;
 
            <b>public void</b> <a id="707add6556d6f97d" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">BlobChainStepOne</a>(
                [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#bb93ab668e365624" class="t constructor">BlobTrigger</a>(<a href="#44cc81706d4d6724" class="i field">BlobChainTriggerBlobPath</a>)] <a href="@0@mscorlib/A.html#7b5eff52b5bf1164" class="t t">TextReader</a> <span id="r16 rd" class="r16 r">input</span>,
                [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#75fba02e18abef0f" class="t constructor">Blob</a>(<a href="#455dca77a7c53480" class="i field">BlobChainIntermediateBlobPath</a>)] <a href="@0@mscorlib/A.html#6e84a88dc2be46e3" class="t t">TextWriter</a> <span id="r17 rd" class="r17 r">output</span>)
            {
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r18 rd" class="r18 r">content</span> = <span class="r16 r">input</span>.<a href="@0@mscorlib/A.html#500f43aa5f43a9c5" class="i method">ReadToEnd</a>();
                <span class="r17 r">output</span>.<a href="@0@mscorlib/A.html#d3fb8ea93246e9a9" class="i method">Write</a>(<span class="r18 r">content</span>);
            }
 
            <b>public void</b> <a id="c548bbdff006a586" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">BlobChainStepTwo</a>(
                [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#bb93ab668e365624" class="t constructor">BlobTrigger</a>(<a href="#455dca77a7c53480" class="i field">BlobChainIntermediateBlobPath</a>)] <a href="@0@mscorlib/A.html#7b5eff52b5bf1164" class="t t">TextReader</a> <span id="r19 rd" class="r19 r">input</span>,
                [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#75fba02e18abef0f" class="t constructor">Blob</a>(<a href="#8899b37760379cdd" class="i field">BlobChainOutputBlobPath</a>)] <a href="@0@mscorlib/A.html#6e84a88dc2be46e3" class="t t">TextWriter</a> <span id="r20 rd" class="r20 r">output</span>,
                [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#326caa0a3eed3e0e" class="t constructor">Queue</a>(<a href="#93261f34a0f63dd6" class="i field">BlobChainCommittedQueueName</a>)] <b>out string</b> <span id="r21 rd" class="r21 r">committed</span>)
            {
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r22 rd" class="r22 r">content</span> = <span class="r19 r">input</span>.<a href="@0@mscorlib/A.html#500f43aa5f43a9c5" class="i method">ReadToEnd</a>();
                <span class="r20 r">output</span>.<a href="@0@mscorlib/A.html#d3fb8ea93246e9a9" class="i method">Write</a>(<span class="s">&quot;*&quot;</span> + <span class="r22 r">content</span> + <span class="s">&quot;*&quot;</span>);
                <span class="r21 r">committed</span> = <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@0@mscorlib/A.html#c9f70a27facb27cf" class="i field">Empty</a>;
            }
 
            <b>public void</b> <a id="3366a110e1387550" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">BlobChainStepThree</a>([<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#c3e2dc420c6e33e5" class="t constructor">QueueTrigger</a>(<a href="#93261f34a0f63dd6" class="i field">BlobChainCommittedQueueName</a>)] <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r23 rd" class="r23 r">ignore</span>)
            {
                <a href="#a36ecff356a6a480" class="i field">_completedEvent</a>.<a href="@0@mscorlib/A.html#63f3d76fa45ccc3d" class="i method">Set</a>();
            }
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="604ef87407f49c18" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">PoisonMessage_CreatedInPrimaryStorageAccount</a>()
        {
            <b>await</b> <a href="#cc90a18f5fc17fc5" class="i method">PoisonMessage_CreatedInCorrectStorageAccount</a>(<a href="/Azure.Core.TestFramework/A.html#26a1e2ab3c3c535e" class="i property">TestEnvironment</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#0f55788eb27fcd2b" class="i property">PrimaryStorageAccountConnectionString</a>, <b>true</b>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="e6729cfbf6f0d547" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">PoisonMessage_CreatedInSecondaryStorageAccount</a>()
        {
            <b>await</b> <a href="#cc90a18f5fc17fc5" class="i method">PoisonMessage_CreatedInCorrectStorageAccount</a>(<a href="/Azure.Core.TestFramework/A.html#26a1e2ab3c3c535e" class="i property">TestEnvironment</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#e7a73cf1e76a02c1" class="i property">SecondaryStorageAccountConnectionString</a>, <b>false</b>);
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="cc90a18f5fc17fc5" href="R/cc90a18f5fc17fc5.html" target="n" data-glyph="76,1" class="i method">PoisonMessage_CreatedInCorrectStorageAccount</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r24 rd" class="r24 r">connectionString</span>, <b>bool</b> <span id="r25 rd" class="r25 r">isPrimary</span>)
        {
            <a href="/Azure.Storage.Blobs/A.html#5c3c4fe54cdb5868" class="k">var</a> <span id="r26 rd" class="r26 r">blobClient</span> = <b>new</b> <a href="/Azure.Storage.Blobs/A.html#66aac072e757eda3" class="t constructor">BlobServiceClient</a>(<span class="r24 r">connectionString</span>);
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r27 rd" class="r27 r">containerName</span> = <a href="#5c419e56b07d4845" class="i field">_nameResolver</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#454ee046bb695881" class="i method">ResolveInString</a>(<a href="#8d1f67c6bf1bb2b7" class="i field">PoisonTestContainerName</a>);
            <a href="/Azure.Storage.Blobs/A.html#6bb2c165ee95c7d4" class="k">var</a> <span id="r28 rd" class="r28 r">container</span> = <span class="r26 r">blobClient</span>.<a href="/Azure.Storage.Blobs/A.html#e3b6b5726874c210" class="i method">GetBlobContainerClient</a>(<span class="r27 r">containerName</span>);
            <b>await</b> <span class="r28 r">container</span>.<a href="/Azure.Storage.Blobs/A.html#47f53d489abf3bfe" class="i method">CreateAsync</a>();
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r29 rd" class="r29 r">blobName</span> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>();
            <a href="/Azure.Storage.Blobs/A.html#a021487ec216e15d" class="k">var</a> <span id="r30 rd" class="r30 r">blob</span> = <span class="r28 r">container</span>.<a href="/Azure.Storage.Blobs/A.html#9212d86e1f5d0a57" class="i method">GetBlockBlobClient</a>(<span class="r29 r">blobName</span>);
            <b>await</b> <span class="r30 r">blob</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#7c345baacd43f10d" class="i method">UploadTextAsync</a>(<span class="s">&quot;0&quot;</span>);
 
            <a href="#db058dec5a5e7d16" class="k">var</a> <span id="r31 rd" class="r31 r">prog</span> = <b>new</b> <a href="#db058dec5a5e7d16" class="t constructor">Poison_Program</a>();
            <b>var</b> <span id="r32 rd" class="r32 r">host</span> = <a href="#3672048349488ee6" class="i method">NewBuilder</a>(<span class="r31 r">prog</span>).<span class="i method">Build</span>();
 
            <b>using</b> (<span class="r32 r">host</span>)
            {
                <span class="r32 r">host</span>.<span class="i method">Start</span>();
 
                <span class="c">// wait for the poison message to be handled</span>
                <b>await</b> <a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#6f570104f95090e2" class="t t">TestHelpers</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#b38072bf26486142" class="i method">Await</a>(() =&gt;
                {
                    <b>if</b> (<span class="r25 r">isPrimary</span>)
                    {
                        <b>return</b> <span class="r31 r">prog</span>.<a href="#8b1d6dce630c9e28" class="i field">_poisonBlobMessagesPrimary</a>.<a href="@0@mscorlib/A.html#521b9f7129105e15" class="i method">Contains</a>(<span class="r29 r">blobName</span>);
                    }
                    <b>else</b>
                    {
                        <b>return</b> <span class="r31 r">prog</span>.<a href="#6bc2a63fd94a1d0a" class="i field">_poisonBlobMessagesSecondary</a>.<a href="@0@mscorlib/A.html#521b9f7129105e15" class="i method">Contains</a>(<span class="r29 r">blobName</span>);
                    }
                });
            }
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="ee9cf395653568c1" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">BlobGetsProcessedOnlyOnce_SingleHost</a>()
        {
            <a href="/Azure.Storage.Blobs/A.html#a021487ec216e15d" class="k">var</a> <span id="r33 rd" class="r33 r">blob</span> = <a href="#f8cd21481d3fe9da" class="i field">_testContainer</a>.<a href="/Azure.Storage.Blobs/A.html#9212d86e1f5d0a57" class="i method">GetBlockBlobClient</a>(<a href="#4bb9647f25b28aaf" class="i field">TestBlobName</a>);
            <b>await</b> <span class="r33 r">blob</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#7c345baacd43f10d" class="i method">UploadTextAsync</a>(<span class="s">&quot;0&quot;</span>);
 
            <b>int</b> <span id="r34 rd" class="r34 r">timeToProcess</span>;
 
            <a href="#c539f2d84389dba9" class="k">var</a> <span id="r35 rd" class="r35 r">prog</span> = <b>new</b> <a href="#c539f2d84389dba9" class="t constructor">BlobGetsProcessedOnlyOnce_SingleHost_Program</a>();
 
            <span class="c">// make sure they both have the same id</span>
            <b>var</b> <span id="r36 rd" class="r36 r">host</span> = <a href="#3672048349488ee6" class="i method">NewBuilder</a>(<span class="r35 r">prog</span>, <span id="r37 rd" class="r37 r">builder</span> =&gt; <span class="r37 r">builder</span>.<span class="i method">UseHostId</span>(<a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#8015cb30da6ca742" class="i method">ToString</a>(<span class="s">&quot;N&quot;</span>)))
                .<span class="i method">Build</span>();
 
            <span class="c">// Process the blob first</span>
            <b>using</b> (<span class="r35 r">prog</span>.<a href="#42e1da43009c856c" class="i field">_completedEvent</a> = <b>new</b> <a href="@0@mscorlib/A.html#3f1e8fec681dd775" class="t constructor">ManualResetEvent</a>(<span class="r38 r">initialState</span>: <b>false</b>))
            <b>using</b> (<span class="r36 r">host</span>)
            {
                <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a> <span id="r39 rd" class="r39 r">startTime</span> = <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#1cd5dd408a32124f" class="i property">Now</a>;
 
                <span class="r36 r">host</span>.<span class="i method">Start</span>();
                <span class="t t">Assert</span>.<span class="i method">True</span>(<span class="r35 r">prog</span>.<a href="#42e1da43009c856c" class="i field">_completedEvent</a>.<a href="@0@mscorlib/A.html#338dcea05d182d3c" class="i method">WaitOne</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(60)));
 
                <span class="r34 r">timeToProcess</span> = (<b>int</b>)(<a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#1cd5dd408a32124f" class="i property">Now</a> - <span class="r39 r">startTime</span>).<a href="@0@mscorlib/A.html#0001a4a9e0a9b848" class="i property">TotalMilliseconds</a>;
 
                <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(1, <span class="r35 r">prog</span>.<a href="#a74a3ea212fb93f4" class="i field">_timesProcessed</a>);
 
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>[] <span id="r40 rd" class="r40 r">loggerOutputLines</span> = <span class="r36 r">host</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#d6d7108e8522b51b" class="i method">GetTestLoggerProvider</a>().<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#c0d546c72b75e0fc" class="i method">GetAllLogMessages</a>()
                    .<a href="@0@System.Core/A.html#e73922753675387a" class="i method">Where</a>(<span id="r41 rd" class="r41 r">p</span> =&gt; <span class="r41 r">p</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#8b46c16949a51568" class="i property">FormattedMessage</a> != <b>null</b>)
                    .<a href="@0@System.Core/A.html#8f3471331178bcb0" class="i method">SelectMany</a>(<span id="r42 rd" class="r42 r">p</span> =&gt; <span class="r42 r">p</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#8b46c16949a51568" class="i property">FormattedMessage</a>.<a href="@0@mscorlib/A.html#1ff97959e1d46a53" class="i method">Split</a>(<a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#63a04833d43dd9d3" class="i property">NewLine</a>.<a href="@0@mscorlib/A.html#81c2d980f5d0ee35" class="i method">ToCharArray</a>(), <a href="@0@mscorlib/A.html#a948431c3f385783" class="t t">StringSplitOptions</a>.<a href="@0@mscorlib/A.html#03026d3a84da22cb" class="i field">None</a>))
                    .<a href="@0@System.Core/A.html#783a052330e7d48d" class="i method">ToArray</a>();
 
                <a href="@0@mscorlib/A.html#3acf01620172c7f0" class="k">var</a> <span id="r43 rd" class="r43 r">executions</span> = <span class="r40 r">loggerOutputLines</span>.<a href="@0@System.Core/A.html#e73922753675387a" class="i method">Where</a>(<span id="r44 rd" class="r44 r">p</span> =&gt; <span class="r44 r">p</span>.<a href="@0@mscorlib/A.html#428c5c9954dea844" class="i method">Contains</a>(<span class="s">&quot;Executing&quot;</span>));
                <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(1, <span class="r43 r">executions</span>.<a href="@0@System.Core/A.html#41ef9e39e54d0d0b" class="i method">Count</a>());
                <span class="t t">StringAssert</span>.<span class="i method">StartsWith</span>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#7432dab173fae5fc" class="i method">Format</a>(<span class="s">&quot;Executing &#39;BlobGetsProcessedOnlyOnce_SingleHost_Program.SingleBlobTrigger&#39; (Reason=&#39;New blob detected: {0}/{1}&#39;, Id=&quot;</span>, <span class="r33 r">blob</span>.<a href="/Azure.Storage.Blobs/A.html#8125465144699fdb" class="i property">BlobContainerName</a>, <span class="r33 r">blob</span>.<a href="/Azure.Storage.Blobs/A.html#157bb830a0c2db34" class="i property">Name</a>), <span class="r43 r">executions</span>.<a href="@0@System.Core/A.html#35e2ff5965cb4b7e" class="i method">Single</a>());
 
                <b>await</b> <span class="r36 r">host</span>.<span class="i method">StopAsync</span>();
 
                <span class="c">// Can&#39;t restart</span>
                <span class="t t">Assert</span>.<span class="i method">Throws</span>&lt;<a href="@0@mscorlib/A.html#beac22dfca574cd4" class="t t">InvalidOperationException</a>&gt;(() =&gt; <span class="r36 r">host</span>.<span class="i method">Start</span>());
            }
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(1, <span class="r35 r">prog</span>.<a href="#a74a3ea212fb93f4" class="i field">_timesProcessed</a>);
        } <span class="c">// host</span>
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="9a2a2ea878dc3474" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">BlobChainTest</a>()
        {
            <span class="c">// write the initial trigger blob to start the chain</span>
            <a href="/Azure.Storage.Blobs/A.html#6bb2c165ee95c7d4" class="k">var</a> <span id="r45 rd" class="r45 r">container</span> = <a href="#736e0fc7b9aae489" class="i field">_blobServiceClient</a>.<a href="/Azure.Storage.Blobs/A.html#e3b6b5726874c210" class="i method">GetBlobContainerClient</a>(<a href="#5c419e56b07d4845" class="i field">_nameResolver</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#454ee046bb695881" class="i method">ResolveInString</a>(<a href="#5a392bafea9d6697" class="i field">BlobChainContainerName</a>));
            <b>await</b> <span class="r45 r">container</span>.<a href="/Azure.Storage.Blobs/A.html#bc2496fa7483427d" class="i method">CreateIfNotExistsAsync</a>();
            <a href="/Azure.Storage.Blobs/A.html#a021487ec216e15d" class="k">var</a> <span id="r46 rd" class="r46 r">blob</span> = <span class="r45 r">container</span>.<a href="/Azure.Storage.Blobs/A.html#9212d86e1f5d0a57" class="i method">GetBlockBlobClient</a>(<a href="#d2fc19f81c99e678" class="i field">BlobChainTriggerBlobName</a>);
            <b>await</b> <span class="r46 r">blob</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#7c345baacd43f10d" class="i method">UploadTextAsync</a>(<span class="s">&quot;0&quot;</span>);
 
            <a href="#206c7accb0e2747b" class="k">var</a> <span id="r47 rd" class="r47 r">prog</span> = <b>new</b> <a href="#206c7accb0e2747b" class="t constructor">BlobChainTest_Program</a>();
            <b>var</b> <span id="r48 rd" class="r48 r">host</span> = <a href="#3672048349488ee6" class="i method">NewBuilder</a>(<span class="r47 r">prog</span>).<span class="i method">Build</span>();
 
            <b>using</b> (<span class="r47 r">prog</span>.<a href="#a36ecff356a6a480" class="i field">_completedEvent</a> = <b>new</b> <a href="@0@mscorlib/A.html#3f1e8fec681dd775" class="t constructor">ManualResetEvent</a>(<span class="r38 r">initialState</span>: <b>false</b>))
            <b>using</b> (<span class="r48 r">host</span>)
            {
                <span class="r48 r">host</span>.<span class="i method">Start</span>();
                <span class="t t">Assert</span>.<span class="i method">True</span>(<span class="r47 r">prog</span>.<a href="#a36ecff356a6a480" class="i field">_completedEvent</a>.<a href="@0@mscorlib/A.html#338dcea05d182d3c" class="i method">WaitOne</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(60)));
            }
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="ef45e6f8aca47dcc" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GarbageMessageDoesNotCrashHost</a>()
        {
            <span class="c">// write the initial trigger blob to start the chain</span>
            <a href="/Azure.Storage.Blobs/A.html#6bb2c165ee95c7d4" class="k">var</a> <span id="r49 rd" class="r49 r">container</span> = <a href="#736e0fc7b9aae489" class="i field">_blobServiceClient</a>.<a href="/Azure.Storage.Blobs/A.html#e3b6b5726874c210" class="i method">GetBlobContainerClient</a>(<a href="#5c419e56b07d4845" class="i field">_nameResolver</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#454ee046bb695881" class="i method">ResolveInString</a>(<a href="#5a392bafea9d6697" class="i field">BlobChainContainerName</a>));
            <b>await</b> <span class="r49 r">container</span>.<a href="/Azure.Storage.Blobs/A.html#bc2496fa7483427d" class="i method">CreateIfNotExistsAsync</a>();
            <a href="/Azure.Storage.Blobs/A.html#a021487ec216e15d" class="k">var</a> <span id="r50 rd" class="r50 r">blob</span> = <span class="r49 r">container</span>.<a href="/Azure.Storage.Blobs/A.html#9212d86e1f5d0a57" class="i method">GetBlockBlobClient</a>(<a href="#d2fc19f81c99e678" class="i field">BlobChainTriggerBlobName</a>);
            <b>await</b> <span class="r50 r">blob</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#7c345baacd43f10d" class="i method">UploadTextAsync</a>(<span class="s">&quot;0&quot;</span>);
 
            <a href="#206c7accb0e2747b" class="k">var</a> <span id="r51 rd" class="r51 r">prog</span> = <b>new</b> <a href="#206c7accb0e2747b" class="t constructor">BlobChainTest_Program</a>();
            <b>var</b> <span id="r52 rd" class="r52 r">host</span> = <a href="#3672048349488ee6" class="i method">NewBuilder</a>(<span class="r51 r">prog</span>).<span class="i method">Build</span>();
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r53 rd" class="r53 r">hostId</span> = <b>await</b> <span class="r52 r">host</span>.<span class="i property">Services</span>.<span class="i method">GetService</span>&lt;<span class="t t">IHostIdProvider</span>&gt;().<span class="i method">GetHostIdAsync</span>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@0@mscorlib/A.html#ec32c41597007382" class="i property">None</a>);
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r54 rd" class="r54 r">hostBlobTriggerQueueName</span> = <span class="s">&quot;azure-webjobs-blobtrigger-&quot;</span> + <span class="r53 r">hostId</span>;
 
            <a href="/Azure.Storage.Queues/A.html#9deade59b6175965" class="k">var</a> <span id="r55 rd" class="r55 r">blobTriggerQueue</span> = <a href="#4f589c76c8be4f07" class="i field">_queueServiceClient</a>.<a href="/Azure.Storage.Queues/A.html#3691ef0a47344425" class="i method">GetQueueClient</a>(<span class="r54 r">hostBlobTriggerQueueName</span>);
            <b>await</b> <span class="r55 r">blobTriggerQueue</span>.<a href="/Azure.Storage.Queues/A.html#29f4bf7a8bda13c8" class="i method">CreateIfNotExistsAsync</a>();
 
            <span class="c">// Inject garbage message, i.e. not base-64 encoded</span>
            <b>await</b> <span class="r55 r">blobTriggerQueue</span>.<a href="/Azure.Storage.Queues/A.html#8c21fc372cc81608" class="i method">SendMessageAsync</a>(<span class="s">&quot;KABOOM&quot;</span>);
 
            <b>using</b> (<span class="r51 r">prog</span>.<a href="#a36ecff356a6a480" class="i field">_completedEvent</a> = <b>new</b> <a href="@0@mscorlib/A.html#3f1e8fec681dd775" class="t constructor">ManualResetEvent</a>(<span class="r38 r">initialState</span>: <b>false</b>))
            <b>using</b> (<span class="r52 r">host</span>)
            {
                <span class="r52 r">host</span>.<span class="i method">Start</span>();
                <span class="t t">Assert</span>.<span class="i method">True</span>(<span class="r51 r">prog</span>.<a href="#a36ecff356a6a480" class="i field">_completedEvent</a>.<a href="@0@mscorlib/A.html#338dcea05d182d3c" class="i method">WaitOne</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(60)));
 
                <span class="c">// make sure it was logged.</span>
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r56 rd" class="r56 r">invalidMessageLog</span> = <span class="r52 r">host</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#d6d7108e8522b51b" class="i method">GetTestLoggerProvider</a>().<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#c0d546c72b75e0fc" class="i method">GetAllLogMessages</a>()
                    .<a href="@0@System.Core/A.html#e73922753675387a" class="i method">Where</a>(<span id="r57 rd" class="r57 r">p</span> =&gt; <span class="r57 r">p</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#8b46c16949a51568" class="i property">FormattedMessage</a> != <b>null</b>)
                    .<a href="@0@System.Core/A.html#8f3471331178bcb0" class="i method">SelectMany</a>(<span id="r58 rd" class="r58 r">p</span> =&gt; <span class="r58 r">p</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#8b46c16949a51568" class="i property">FormattedMessage</a>.<a href="@0@mscorlib/A.html#1ff97959e1d46a53" class="i method">Split</a>(<a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#63a04833d43dd9d3" class="i property">NewLine</a>.<a href="@0@mscorlib/A.html#81c2d980f5d0ee35" class="i method">ToCharArray</a>(), <a href="@0@mscorlib/A.html#a948431c3f385783" class="t t">StringSplitOptions</a>.<a href="@0@mscorlib/A.html#03026d3a84da22cb" class="i field">None</a>))
                    .<a href="@0@System.Core/A.html#e73922753675387a" class="i method">Where</a>(<span id="r59 rd" class="r59 r">s</span> =&gt; <span class="r59 r">s</span>.<a href="@0@mscorlib/A.html#428c5c9954dea844" class="i method">Contains</a>(<span class="s">&quot;KABOOM&quot;</span>))
                    .<a href="@0@System.Core/A.html#8087366974af11d2" class="i method">FirstOrDefault</a>();
                <span class="t t">StringAssert</span>.<span class="i method">Contains</span>(<span class="s">&quot;KABOOM&quot;</span>, <span class="r56 r">invalidMessageLog</span>);
            }
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="076c775fe2f2e1a9" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">BlobGetsProcessedOnlyOnce_MultipleHosts</a>()
        {
            <b>await</b> <a href="#f8cd21481d3fe9da" class="i field">_testContainer</a>
                .<a href="/Azure.Storage.Blobs/A.html#9212d86e1f5d0a57" class="i method">GetBlockBlobClient</a>(<a href="#4bb9647f25b28aaf" class="i field">TestBlobName</a>)
                .<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#7c345baacd43f10d" class="i method">UploadTextAsync</a>(<span class="s">&quot;10&quot;</span>);
 
            <a href="#c539f2d84389dba9" class="k">var</a> <span id="r60 rd" class="r60 r">prog</span> = <b>new</b> <a href="#c539f2d84389dba9" class="t constructor">BlobGetsProcessedOnlyOnce_SingleHost_Program</a>();
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r61 rd" class="r61 r">hostId</span> = <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#8015cb30da6ca742" class="i method">ToString</a>(<span class="s">&quot;N&quot;</span>);
            <b>var</b> <span id="r62 rd" class="r62 r">host1</span> = <a href="#3672048349488ee6" class="i method">NewBuilder</a>(<span class="r60 r">prog</span>, <span id="r63 rd" class="r63 r">builder</span>=&gt;<span class="r63 r">builder</span>.<span class="i method">UseHostId</span>(<span class="r61 r">hostId</span>))
                .<span class="i method">Build</span>();
            <b>var</b> <span id="r64 rd" class="r64 r">host2</span> = <a href="#3672048349488ee6" class="i method">NewBuilder</a>(<span class="r60 r">prog</span>, <span id="r65 rd" class="r65 r">builder</span> =&gt; <span class="r65 r">builder</span>.<span class="i method">UseHostId</span>(<span class="r61 r">hostId</span>))
                .<span class="i method">Build</span>();
 
            <b>using</b> (<span class="r60 r">prog</span>.<a href="#42e1da43009c856c" class="i field">_completedEvent</a> = <b>new</b> <a href="@0@mscorlib/A.html#3f1e8fec681dd775" class="t constructor">ManualResetEvent</a>(<span class="r38 r">initialState</span>: <b>false</b>))
            <b>using</b> (<span class="r62 r">host1</span>)
            <b>using</b> (<span class="r64 r">host2</span>)
            {
                <span class="r62 r">host1</span>.<span class="i method">Start</span>();
                <span class="r64 r">host2</span>.<span class="i method">Start</span>();
 
                <span class="t t">Assert</span>.<span class="i method">True</span>(<span class="r60 r">prog</span>.<a href="#42e1da43009c856c" class="i field">_completedEvent</a>.<a href="@0@mscorlib/A.html#338dcea05d182d3c" class="i method">WaitOne</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(60)));
            }
 
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(1, <span class="r60 r">prog</span>.<a href="#a74a3ea212fb93f4" class="i field">_timesProcessed</a>);
        }
 
        <b>public void</b> <a id="1f10cb47040ec425" href="R/1f10cb47040ec425.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <b>foreach</b> (<a href="/Azure.Storage.Blobs/A.html#51495ef18796e708" class="k">var</a> <span id="r66 rd" class="r66 r">testContainer</span> <b>in</b> <a href="#736e0fc7b9aae489" class="i field">_blobServiceClient</a>.<a href="/Azure.Storage.Blobs/A.html#75bfd9993dbf784b" class="i method">GetBlobContainers</a>(<span class="r67 r">prefix</span>: <a href="#15bfd95d91930b91" class="i field">TestArtifactPrefix</a>))
            {
                <a href="#736e0fc7b9aae489" class="i field">_blobServiceClient</a>.<a href="/Azure.Storage.Blobs/A.html#e3b6b5726874c210" class="i method">GetBlobContainerClient</a>(<span class="r66 r">testContainer</span>.<a href="/Azure.Storage.Blobs/A.html#93185e6245e64b03" class="i property">Name</a>).<a href="/Azure.Storage.Blobs/A.html#15ec3babf4858e1f" class="i method">Delete</a>();
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
