<!DOCTYPE html>
<html><head><title>ScenarioTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(122);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.WebJobs.Extensions.Storage.Scenario.Tests/ScenarioTests.cs" target="_top">ScenarioTests.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/master/sdk/storage/Microsoft.Azure.WebJobs.Extensions.Storage.Scenario.Tests/tests/ScenarioTests.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.WebJobs.Extensions.Storage.Scenario.Tests" target="_top">Microsoft.Azure.WebJobs.Extensions.Storage.Scenario.Tests.csproj</a> (Microsoft.Azure.WebJobs.Extensions.Storage.Scenario.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Blobs</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Blobs</span>.<span class="i n">Specialized</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Queues</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">WebJobs</span>.<span class="i n">Extensions</span>.<span class="i n">Storage</span>.<span class="i n">Common</span>.<span class="i n">Tests</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Azure</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Hosting</span>;
<b>using</b> <span class="i n">NUnit</span>.<span class="i n">Framework</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">WebJobs</span>.<span class="i n">Extensions</span>.<span class="i n">Storage</span>.<span class="i n">ScenarioTests</span>
{
    <b>public class</b> <a id="6a4a4e278f107214" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="918fbba0dc3d447f">ScenarioTests</span></a>
    {
        <b>private const string</b> <a id="15e9887db4f68191" href="R/15e9887db4f68191.html" target="n" data-glyph="10,1" class="i field">ContainerName</a> = <span class="s">&quot;container-scenariotests&quot;</span>;
        <b>private const string</b> <a id="545022e059af250c" href="R/545022e059af250c.html" target="n" data-glyph="10,1" class="i field">BlobName</a> = <span class="s">&quot;blob&quot;</span>;
        <b>private const string</b> <a id="b607095b2acfe3b9" href="R/b607095b2acfe3b9.html" target="n" data-glyph="10,1" class="i field">BlobPath</a> = <a href="#15e9887db4f68191" class="i field">ContainerName</a> + <span class="s">&quot;/&quot;</span> + <a href="#545022e059af250c" class="i field">BlobName</a>;
        <b>private const string</b> <a id="480436937323b07b" href="R/480436937323b07b.html" target="n" data-glyph="10,1" class="i field">OutputBlobName</a> = <span class="s">&quot;blob.out&quot;</span>;
        <b>private const string</b> <a id="fba3a91660ed48ac" href="R/../../0000000000.html" target="n" data-glyph="10,1" class="i field">OutputBlobPath</a> = <a href="#15e9887db4f68191" class="i field">ContainerName</a> + <span class="s">&quot;/&quot;</span> + <a href="#480436937323b07b" class="i field">OutputBlobName</a>;
        <b>private const string</b> <a id="119f1feff871c324" href="R/119f1feff871c324.html" target="n" data-glyph="10,1" class="i field">QueueName</a> = <span class="s">&quot;queue-scenariotests&quot;</span>;
        <b>private</b> <a href="/Azure.Storage.Blobs/A.html#5c3c4fe54cdb5868" class="t t">BlobServiceClient</a> <a id="e9bc8e0d3a87fab8" href="R/e9bc8e0d3a87fab8.html" target="n" data-glyph="46,1" class="i field">blobServiceClient</a>;
        <b>private</b> <a href="/Azure.Storage.Queues/A.html#ef0f353b721b0444" class="t t">QueueServiceClient</a> <a id="bfc8ee788502b114" href="R/bfc8ee788502b114.html" target="n" data-glyph="46,1" class="i field">queueServiceClient</a>;
 
        [<span class="t constructor">SetUp</span>]
        <b>public void</b> <a id="d69ce883e6502a0e" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SetUp</a>()
        {
            <a href="#e9bc8e0d3a87fab8" class="i field">blobServiceClient</a> = <a href="Shared/AzuriteNUnitFixture.cs.html#eb5e3a22026110cd" class="t t">AzuriteNUnitFixture</a>.<a href="Shared/AzuriteNUnitFixture.cs.html#2debfead00347dbd" class="i property">Instance</a>.<a href="Shared/AzuriteFixtureExtensions.cs.html#5d8875fd4833160f" class="i method">GetBlobServiceClient</a>();
            <a href="#bfc8ee788502b114" class="i field">queueServiceClient</a> = <a href="Shared/AzuriteNUnitFixture.cs.html#eb5e3a22026110cd" class="t t">AzuriteNUnitFixture</a>.<a href="Shared/AzuriteNUnitFixture.cs.html#2debfead00347dbd" class="i property">Instance</a>.<a href="Shared/AzuriteFixtureExtensions.cs.html#2f0a7e0451068187" class="i method">GetQueueServiceClient</a>();
            <a href="#e9bc8e0d3a87fab8" class="i field">blobServiceClient</a>.<a href="/Azure.Storage.Blobs/A.html#e3b6b5726874c210" class="i method">GetBlobContainerClient</a>(<a href="#15e9887db4f68191" class="i field">ContainerName</a>).<a href="/Azure.Storage.Blobs/A.html#42450f84c76edbc6" class="i method">DeleteIfExists</a>();
            <span class="c">// make sure our system containers are present</span>
            <a href="#e9bc8e0d3a87fab8" class="i field">blobServiceClient</a>.<a href="/Azure.Storage.Blobs/A.html#e3b6b5726874c210" class="i method">GetBlobContainerClient</a>(<span class="s">&quot;azure-webjobs-hosts&quot;</span>).<a href="/Azure.Storage.Blobs/A.html#ae92191ef11ca804" class="i method">CreateIfNotExists</a>();
            <a href="#bfc8ee788502b114" class="i field">queueServiceClient</a>.<a href="/Azure.Storage.Queues/A.html#3691ef0a47344425" class="i method">GetQueueClient</a>(<a href="#119f1feff871c324" class="i field">QueueName</a>).<a href="/Azure.Storage.Queues/A.html#8890357113ccd924" class="i method">DeleteIfExists</a>();
        }
 
        [<span class="t constructor">Test</span>]
        <b>public async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="04cccc52bf015225" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">BlobTriggerToQueueTriggerToBlob_WritesFinalBlob</a>()
        {
            <span class="c">// Arrange</span>
            <a href="/Azure.Storage.Blobs/A.html#6bb2c165ee95c7d4" class="k">var</a> <span id="r0 rd" class="r0 r">container</span> = <b>await</b> <a href="#c084b1243ef5601d" class="i method">CreateContainerAsync</a>(<a href="#e9bc8e0d3a87fab8" class="i field">blobServiceClient</a>, <a href="#15e9887db4f68191" class="i field">ContainerName</a>);
            <a href="/Azure.Storage.Blobs/A.html#a021487ec216e15d" class="k">var</a> <span id="r1 rd" class="r1 r">inputBlob</span> = <span class="r0 r">container</span>.<a href="/Azure.Storage.Blobs/A.html#9212d86e1f5d0a57" class="i method">GetBlockBlobClient</a>(<a href="#545022e059af250c" class="i field">BlobName</a>);
            <b>await</b> <span class="r1 r">inputBlob</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#7c345baacd43f10d" class="i method">UploadTextAsync</a>(<span class="s">&quot;15&quot;</span>);
 
            <span class="c">// Act</span>
            <b>await</b> <a href="#6271029fb87a435b" class="i method">RunTriggerAsync</a>&lt;<b>object</b>&gt;(<b>typeof</b>(<a href="#88b7cae619003d70" class="t t">BlobTriggerToQueueTriggerToBlobProgram</a>),
                (<span id="r2 rd" class="r2 r">s</span>) =&gt; <a href="#88b7cae619003d70" class="t t">BlobTriggerToQueueTriggerToBlobProgram</a>.<a href="#6451894f0c7d126b" class="i property">TaskSource</a> = <span class="r2 r">s</span>);
 
            <span class="c">// Assert</span>
            <a href="/Azure.Storage.Blobs/A.html#a021487ec216e15d" class="k">var</a> <span id="r3 rd" class="r3 r">outputBlob</span> = <span class="r0 r">container</span>.<a href="/Azure.Storage.Blobs/A.html#9212d86e1f5d0a57" class="i method">GetBlockBlobClient</a>(<a href="#480436937323b07b" class="i field">OutputBlobName</a>);
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r4 rd" class="r4 r">content</span> = <b>await</b> <span class="r3 r">outputBlob</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#669e2d24a90c31d4" class="i method">DownloadTextAsync</a>();
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;16&quot;</span>, <span class="r4 r">content</span>);
        }
 
        <b>private static async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/Azure.Storage.Blobs/A.html#6bb2c165ee95c7d4" class="t t">BlobContainerClient</a>&gt; <a id="c084b1243ef5601d" href="R/c084b1243ef5601d.html" target="n" data-glyph="76,1" class="i method">CreateContainerAsync</a>(<a href="/Azure.Storage.Blobs/A.html#5c3c4fe54cdb5868" class="t t">BlobServiceClient</a> <span id="r5 rd" class="r5 r">blobServiceClient</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r6 rd" class="r6 r">containerName</span>)
        {
            <a href="/Azure.Storage.Blobs/A.html#6bb2c165ee95c7d4" class="k">var</a> <span id="r7 rd" class="r7 r">container</span> = <span class="r5 r">blobServiceClient</span>.<a href="/Azure.Storage.Blobs/A.html#e3b6b5726874c210" class="i method">GetBlobContainerClient</a>(<span class="r6 r">containerName</span>);
            <b>await</b> <span class="r7 r">container</span>.<a href="/Azure.Storage.Blobs/A.html#bc2496fa7483427d" class="i method">CreateIfNotExistsAsync</a>();
            <b>return</b> <span class="r7 r">container</span>;
        }
 
        <b>private async</b> <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="r8 r t">TResult</span>&gt; <a id="6271029fb87a435b" href="R/6271029fb87a435b.html" target="n" data-glyph="76,1" class="i method">RunTriggerAsync</a>&lt;<span id="r8 rd t" class="r8 r t">TResult</span>&gt;(<a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a> <span id="r9 rd" class="r9 r">programType</span>,
            <a href="@0@mscorlib/A.html#486d58da4553e12d" class="t t">Action</a>&lt;<a href="@0@mscorlib/A.html#94bf04047d6bd325" class="t t">TaskCompletionSource</a>&lt;<span class="r8 r t">TResult</span>&gt;&gt; <span id="r10 rd" class="r10 r">setTaskSource</span>)
        {
            <b>return</b> <b>await</b> <a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#2f452443c345e67f" class="t t">FunctionalTest</a>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Common.Tests/A.html#96d9d56dc4dce591" class="i method">RunTriggerAsync</a>&lt;<span class="r8 r t">TResult</span>&gt;(<span id="r11 rd" class="r11 r">b</span> =&gt;
            {
                <span class="r11 r">b</span>.<span class="i property">Services</span>.<a href="/Microsoft.Extensions.Azure/A.html#45b489a53881c853" class="i method">AddAzureClients</a>(<span id="r12 rd" class="r12 r">builder</span> =&gt;
                {
                    <span class="r12 r">builder</span>.<a href="/Microsoft.Extensions.Azure/A.html#13ca63ee2fe42295" class="i method">ConfigureDefaults</a>(<span id="r13 rd" class="r13 r">options</span> =&gt; <span class="r13 r">options</span>.<a href="/Azure.Core/A.html#d1bdf798bcd1c508" class="i property">Transport</a> = <a href="Shared/AzuriteNUnitFixture.cs.html#eb5e3a22026110cd" class="t t">AzuriteNUnitFixture</a>.<a href="Shared/AzuriteNUnitFixture.cs.html#2debfead00347dbd" class="i property">Instance</a>.<a href="Shared/AzuriteFixture.cs.html#4f52897b3a52f9bd" class="i method">GetTransport</a>());
                });
                <span class="r11 r">b</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#88bea00a76ab1f62" class="i method">AddAzureStorageQueues</a>();
                <span class="r11 r">b</span>.<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#a4ba870e12f90f4a" class="i method">AddAzureStorageBlobs</a>();
            }, <span class="r9 r">programType</span>, <span class="r10 r">setTaskSource</span>,
            <span class="r14 r">settings</span>: <b>new</b> <a href="@0@mscorlib/A.html#bf6849e410b43c4c" class="t constructor">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>&gt;() {
                <span class="c">// This takes precedence over env variables.</span>
                { <span class="s">&quot;ConnectionStrings:AzureWebJobsStorage&quot;</span>, <a href="Shared/AzuriteNUnitFixture.cs.html#eb5e3a22026110cd" class="t t">AzuriteNUnitFixture</a>.<a href="Shared/AzuriteNUnitFixture.cs.html#2debfead00347dbd" class="i property">Instance</a>.<a href="Shared/AzuriteFixture.cs.html#ece53a12773000d0" class="i method">GetAzureAccount</a>().<a href="Shared/AzuriteFixture.cs.html#fdf5c321e79ba110" class="i property">ConnectionString</a> }
            });
        }
 
        <b>private class</b> <a id="88b7cae619003d70" href="R/88b7cae619003d70.html" target="n" data-glyph="4,1" class="t t"><span id="587870e077dabb60">BlobTriggerToQueueTriggerToBlobProgram</span></a>
        {
            <b>private const string</b> <a id="5de9e79fe6abb2f1" href="R/5de9e79fe6abb2f1.html" target="n" data-glyph="10,2" class="i field">CommittedQueueName</a> = <span class="s">&quot;committed&quot;</span>;
 
            <b>public static</b> <a href="@0@mscorlib/A.html#94bf04047d6bd325" class="t t">TaskCompletionSource</a>&lt;<b>object</b>&gt; <a id="6451894f0c7d126b" href="R/6451894f0c7d126b.html" target="n" data-glyph="102,2" class="i property">TaskSource</a> { <b>get</b>; <b>set</b>; }
 
            <b>public static void</b> <a id="8dd7962ac227c228" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">StepOne</a>([<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#bb93ab668e365624" class="t constructor">BlobTrigger</a>(<a href="#b607095b2acfe3b9" class="i field">BlobPath</a>)] <a href="@0@mscorlib/A.html#7b5eff52b5bf1164" class="t t">TextReader</a> <span id="r15 rd" class="r15 r">input</span>, [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#326caa0a3eed3e0e" class="t constructor">Queue</a>(<a href="#119f1feff871c324" class="i field">QueueName</a>)] <b>out</b> <a href="#a13aaaaafaea2214" class="t t">Payload</a> <span id="r16 rd" class="r16 r">output</span>)
            {
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r17 rd" class="r17 r">content</span> = <span class="r15 r">input</span>.<a href="@0@mscorlib/A.html#500f43aa5f43a9c5" class="i method">ReadToEnd</a>();
                <b>int</b> <span id="r18 rd" class="r18 r">value</span> = <b>int</b>.<a href="@0@mscorlib/A.html#a438016f815a35c3" class="i method">Parse</a>(<span class="r17 r">content</span>);
                <span class="r16 r">output</span> = <b>new</b> <a href="#a13aaaaafaea2214" class="t constructor">Payload</a>
                {
                    <a href="#b2c5c0b4f8c5bcfa" class="i property">Value</a> = <span class="r18 r">value</span> + 1,
                    <a href="#f3d1fb0942749b78" class="i property">Output</a> = <a href="#480436937323b07b" class="i field">OutputBlobName</a>
                };
            }
 
            <b>public static void</b> <a id="60d055f78fd5f74f" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">StepTwo</a>([<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#c3e2dc420c6e33e5" class="t constructor">QueueTrigger</a>(<a href="#119f1feff871c324" class="i field">QueueName</a>)] <a href="#a13aaaaafaea2214" class="t t">Payload</a> <span id="r19 rd" class="r19 r">input</span>, <b>int</b> <span id="r20 rd" class="r20 r">value</span>,
                [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Blobs/A.html#75fba02e18abef0f" class="t constructor">Blob</a>(<a href="#15e9887db4f68191" class="i field">ContainerName</a> + <span class="s">&quot;/{Output}&quot;</span>)] <a href="@0@mscorlib/A.html#6e84a88dc2be46e3" class="t t">TextWriter</a> <span id="r21 rd" class="r21 r">output</span>, [<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#326caa0a3eed3e0e" class="t constructor">Queue</a>(<a href="#5de9e79fe6abb2f1" class="i field">CommittedQueueName</a>)] <b>out string</b> <span id="r22 rd" class="r22 r">committed</span>)
            {
                <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="r19 r">input</span>.<a href="#b2c5c0b4f8c5bcfa" class="i property">Value</a>, <span class="r20 r">value</span>);
                <span class="r21 r">output</span>.<a href="@0@mscorlib/A.html#56758e04831e4a91" class="i method">Write</a>(<span class="r20 r">value</span>);
                <span class="r22 r">committed</span> = <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#c9f70a27facb27cf" class="i field">Empty</a>;
            }
 
            <b>public static void</b> <a id="24c7636757efdccf" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">StepThree</a>([<a href="/Microsoft.Azure.WebJobs.Extensions.Storage.Queues/A.html#c3e2dc420c6e33e5" class="t constructor">QueueTrigger</a>(<a href="#5de9e79fe6abb2f1" class="i field">CommittedQueueName</a>)] <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r23 rd" class="r23 r">ignore</span>)
            {
                <a href="#6451894f0c7d126b" class="i property">TaskSource</a>.<a href="@0@mscorlib/A.html#f58e440930617bf6" class="i method">TrySetResult</a>(<b>null</b>);
            }
        }
 
        <b>private class</b> <a id="a13aaaaafaea2214" href="R/a13aaaaafaea2214.html" target="n" data-glyph="4,1" class="t t"><span id="749f001afc054e09">Payload</span></a>
        {
            <b>public int</b> <a id="b2c5c0b4f8c5bcfa" href="R/b2c5c0b4f8c5bcfa.html" target="n" data-glyph="102,2" class="i property">Value</a> { <b>get</b>; <b>set</b>; }
 
            <b>public string</b> <a id="f3d1fb0942749b78" href="R/f3d1fb0942749b78.html" target="n" data-glyph="102,2" class="i property">Output</a> { <b>get</b>; <b>set</b>; }
        }
    }
}
</pre></td></tr></table></div></body></html>
