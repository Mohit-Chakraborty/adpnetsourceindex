<!DOCTYPE html>
<html><head><title>WebKeyEcValidationTest.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(274);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.KeyVault.WebKey.Tests/WebKeyEcValidationTest.cs" target="_top">WebKeyEcValidationTest.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/master/sdk/keyvault/Microsoft.Azure.KeyVault.WebKey/tests/WebKeyEcValidationTest.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.KeyVault.WebKey.Tests" target="_top">Microsoft.Azure.KeyVault.WebKey.Tests.csproj</a> (Microsoft.Azure.KeyVault.WebKey.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for</span>
<span class="c">// license information.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Security</span>.<span class="i n">Cryptography</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">Newtonsoft</span>.<span class="i n">Json</span>;
<b>using</b> <span class="i n">Xunit</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">KeyVault</span>.<span class="i n">WebKey</span>.<span class="i n">Tests</span>
{
    <b>public static class</b> <a id="cc8583f321b6c4b2" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">WebKeyEcValidationTest</a>
    {
        <b>private static readonly string</b> <a id="5a8f105f8948709f" href="R/5a8f105f8948709f.html" target="n" data-glyph="46,1" class="i field">P256TestKey</a> = <span class="s">&quot;{\&quot;kty\&quot;:\&quot;EC\&quot;,\&quot;key_ops\&quot;:[\&quot;sign\&quot;,\&quot;verify\&quot;],\&quot;crv\&quot;:\&quot;P-256\&quot;,\&quot;x\&quot;:\&quot;IzSTOwCKbS-BEdPwVT0xGnW18zzgyG7CwnMDKLULyQo\&quot;,\&quot;y\&quot;:\&quot;K7m-pJxgWIjHGHMF5IZpWLasH6TizES9eidg--wQkSE\&quot;,\&quot;d\&quot;:\&quot;9hY6iHNcR-IuyacHOelfiCvjRWyfOscFVL05zJM4Ne4\&quot;}&quot;</span>;
        <b>private static readonly string</b> <a id="89248fb2bf822642" href="R/89248fb2bf822642.html" target="n" data-glyph="46,1" class="i field">P384TestKey</a> = <span class="s">&quot;{\&quot;kty\&quot;:\&quot;EC\&quot;,\&quot;key_ops\&quot;:[\&quot;sign\&quot;,\&quot;verify\&quot;],\&quot;crv\&quot;:\&quot;P-384\&quot;,\&quot;x\&quot;:\&quot;5XN86Y1xhKo1GuohlWzcvoJmZs36USIFopOU1wha6qbtZzM2C1OK01lh8DJYwQsi\&quot;,\&quot;y\&quot;:\&quot;ZsI5YcBKzo-0d5lS3106nYPshOi9LcCecNJebIina6fw7Ab7TD3f3fhNxEaAE6ja\&quot;,\&quot;d\&quot;:\&quot;6g0maM_o7vcYWJzPMwqE3l0v2vsyjWtOsvRyAch44aZLg9IGaVEUu6Ol718ICyWX\&quot;}&quot;</span>;
        <b>private static readonly string</b> <a id="4dfddc8eb8b0c3e5" href="R/4dfddc8eb8b0c3e5.html" target="n" data-glyph="46,1" class="i field">P521TestKey</a> = <span class="s">&quot;{\&quot;kty\&quot;:\&quot;EC\&quot;,\&quot;key_ops\&quot;:[\&quot;sign\&quot;,\&quot;verify\&quot;],\&quot;crv\&quot;:\&quot;P-521\&quot;,\&quot;x\&quot;:\&quot;ASggRFEA2L_FxGjnU5FNplPHBi8tU0e2L89ZWro4ZpDYvBvel0gjao_S23fuNFlhufLp5kePdGbqujy45wHKMjMR\&quot;,\&quot;y\&quot;:\&quot;AFDVBsQZN2V1lox2kMCmqWL5Kn4f3X0mtqnBLWgPlOSl6l-tMDHj8gcLnMGJZNarCKVGVrdjhmK9BpbYy0Q8Omnm\&quot;,\&quot;d\&quot;:\&quot;AJC_2pp8DO_LxfFuC7yMfd7TGD51f8ydJgHy-Tf-37NBToBjGPo6njEcrppW1QSVWTMJpjfVWJb6x24YZQ73PP04\&quot;}&quot;</span>;
        <b>private static readonly string</b> <a id="b8f332b74c13c9e7" href="R/b8f332b74c13c9e7.html" target="n" data-glyph="46,1" class="i field">Secp256k1TestKey</a> = <span class="s">&quot;{\&quot;kty\&quot;:\&quot;EC\&quot;,\&quot;key_ops\&quot;:[\&quot;sign\&quot;,\&quot;verify\&quot;],\&quot;crv\&quot;:\&quot;P-256K\&quot;,\&quot;x\&quot;:\&quot;yBMUvQwthIjbdvYUC2DDDs6I45dqG0B1GQ3-Eg5RxXM\&quot;,\&quot;y\&quot;:\&quot;KGf5oIzA7QNhZ8gXP8LSQfZKSMsGrmcUphyWpD2ingg\&quot;,\&quot;d\&quot;:\&quot;qmWUH9HNAAYzeNrVYbtoVlrnbiRIa2jDZW5YJh7OoUs\&quot;}&quot;</span>;
 
        [<span class="t constructor">Fact</span>]
        <b>public static void</b> <a id="ea0702d512fd330c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">HardCodedKeysMustWork</a>()
        {
            <b>if</b> ( !<a href="#ab2a7312ff3b38ba" class="i method">IsCngSupported</a>() )
                <b>return</b>;
 
            <a href="#99c9dda20a48300b" class="i method">DoHardCodedKeyTests</a>( <a href="#5a8f105f8948709f" class="i field">P256TestKey</a>, <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#6a1a931e140d8adf" class="i field">P256</a>, 256, 32 );
            <a href="#99c9dda20a48300b" class="i method">DoHardCodedKeyTests</a>( <a href="#89248fb2bf822642" class="i field">P384TestKey</a>, <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#8c9b687b5dca9101" class="i field">P384</a>, 384, 48 );
            <a href="#99c9dda20a48300b" class="i method">DoHardCodedKeyTests</a>( <a href="#4dfddc8eb8b0c3e5" class="i field">P521TestKey</a>, <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#f3954843cd633684" class="i field">P521</a>, 521, 64 );
            <a href="#99c9dda20a48300b" class="i method">DoHardCodedKeyTests</a>( <a href="#b8f332b74c13c9e7" class="i field">Secp256k1TestKey</a>, <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#a386af2b91da273d" class="i field">P256K</a>, 256, 32 );
        }
 
        <b>private static void</b> <a id="99c9dda20a48300b" href="R/99c9dda20a48300b.html" target="n" data-glyph="76,1" class="i method">DoHardCodedKeyTests</a>( <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r0 rd" class="r0 r">json</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r1 rd" class="r1 r">curve</span>, <b>int</b> <span id="r2 rd" class="r2 r">keySize</span>, <b>int</b> <span id="r3 rd" class="r3 r">digestSize</span> )
        {
            <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="k">var</a> <span id="r4 rd" class="r4 r">jwk</span> = <a href="#a2696fb56f8fd099" class="i method">DoSerializationTests</a>( <span class="r0 r">json</span>, <span class="r1 r">curve</span>, <span class="r2 r">keySize</span> );
            <a href="#c9a56080b10a1af1" class="i method">DoECDsaTests</a>( <span class="r4 r">jwk</span>, <span class="r3 r">digestSize</span> );
        }
 
        [<span class="t constructor">Fact</span>]
        <b>public static void</b> <a id="6f06e3f22968a02f" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">RandomKeysMustWork</a>()
        {
            <b>if</b> ( !<a href="#ab2a7312ff3b38ba" class="i method">IsCngSupported</a>() )
                <b>return</b>;
 
            <a href="#7eb27d569e07a7aa" class="i method">DoRamdomKeyTest</a>( <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#6a1a931e140d8adf" class="i field">P256</a>, 256, 32 );
            <a href="#7eb27d569e07a7aa" class="i method">DoRamdomKeyTest</a>( <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#8c9b687b5dca9101" class="i field">P384</a>, 384, 48 );
            <a href="#7eb27d569e07a7aa" class="i method">DoRamdomKeyTest</a>( <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#f3954843cd633684" class="i field">P521</a>, 521, 64 );
            <a href="#7eb27d569e07a7aa" class="i method">DoRamdomKeyTest</a>( <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#a386af2b91da273d" class="i field">P256K</a>, 256, 32 );
        }
 
        <b>private static void</b> <a id="7eb27d569e07a7aa" href="R/7eb27d569e07a7aa.html" target="n" data-glyph="76,1" class="i method">DoRamdomKeyTest</a>( <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r5 rd" class="r5 r">curve</span>, <b>int</b> <span id="r6 rd" class="r6 r">keySize</span>, <b>int</b> <span id="r7 rd" class="r7 r">digestSize</span> )
        {
            <a href="@0@System.Core/A.html#59084d68c76f225c" class="k">var</a> <span id="r8 rd" class="r8 r">ecdsa</span> = <a href="#3aa851556b00fab4" class="i method">CreateRandomKey</a>( <span class="r5 r">curve</span> );
 
            <span class="c">// The constructor must accept a random key.</span>
            <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="k">var</a> <span id="r9 rd" class="r9 r">jwk</span> = <b>new</b> <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#ca9cc4d8b3fc8a31" class="t constructor">JsonWebKey</a>( <span class="r8 r">ecdsa</span>, <b>true</b> );
            <a href="#0164a4dad9be2379" class="i method">VerifyAttributes</a>( <span class="r9 r">jwk</span>, <span class="r5 r">curve</span>, <span class="r6 r">keySize</span>, <b>true</b> );
 
            <a href="@0@System.Core/A.html#59084d68c76f225c" class="k">var</a> <span id="r10 rd" class="r10 r">ecdsa2</span> = <span class="r9 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>( <b>true</b> );
            <span class="t t">Assert</span>.<span class="i method">True</span>( <span class="r10 r">ecdsa2</span>.<a href="@0@mscorlib/A.html#27170d83fa59297b" class="i property">KeySize</a> == <span class="r6 r">keySize</span>, <span class="s">$&quot;</span><span class="s">Expected key size to be </span>{<span class="r6 r">keySize</span>}<span class="s">, but found </span>{<span class="r10 r">ecdsa2</span>.<a href="@0@mscorlib/A.html#27170d83fa59297b" class="i property">KeySize</a>}<span class="s">&quot;</span> );
 
            <span class="c">// This call insures JsonWebKey is not using dummy or constant-result methods.</span>
            <a href="#6e04a462b3e1195c" class="i method">DoSignVerifyTests</a>( <span class="r7 r">digestSize</span>, <span class="r8 r">ecdsa</span>, <span class="r9 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>() );
 
            <span class="c">// Do normal tests.</span>
            <a href="#a2696fb56f8fd099" class="i method">DoSerializationTests</a>( <span class="t t">JsonConvert</span>.<span class="i method">SerializeObject</span>( <span class="r9 r">jwk</span> ), <span class="r5 r">curve</span>, <span class="r6 r">keySize</span> );
            <a href="#c9a56080b10a1af1" class="i method">DoECDsaTests</a>( <span class="r9 r">jwk</span>, <span class="r7 r">digestSize</span> );
        }
 
        <b>private static</b> <a href="@0@System.Core/A.html#59084d68c76f225c" class="t t">ECDsa</a> <a id="3aa851556b00fab4" href="R/3aa851556b00fab4.html" target="n" data-glyph="76,1" class="i method">CreateRandomKey</a>( <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r11 rd" class="r11 r">curve</span> )
        {
            <a href="@0@System.Core/A.html#46d0be971fbf8134" class="t t">CngAlgorithm</a> <span id="r12 rd" class="r12 r">algo</span>;
            <b>switch</b> ( <span class="r11 r">curve</span> )
            {
                <b>case</b> <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#6a1a931e140d8adf" class="i field">P256</a>:
                    <span class="r12 r">algo</span> = <a href="@0@System.Core/A.html#46d0be971fbf8134" class="t t">CngAlgorithm</a>.<a href="@0@System.Core/A.html#bb1b85afafc141e5" class="i property">ECDsaP256</a>;
                    <b>break</b>;
 
                <b>case</b> <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#8c9b687b5dca9101" class="i field">P384</a>:
                    <span class="r12 r">algo</span> = <a href="@0@System.Core/A.html#46d0be971fbf8134" class="t t">CngAlgorithm</a>.<a href="@0@System.Core/A.html#5fbd27b1737e97af" class="i property">ECDsaP384</a>;
                    <b>break</b>;
 
                <b>case</b> <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#f3954843cd633684" class="i field">P521</a>:
                    <span class="r12 r">algo</span> = <a href="@0@System.Core/A.html#46d0be971fbf8134" class="t t">CngAlgorithm</a>.<a href="@0@System.Core/A.html#2cb97702d616aeed" class="i property">ECDsaP521</a>;
                    <b>break</b>;
 
                <b>case</b> <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#a386af2b91da273d" class="i field">P256K</a>:
                    <span class="r12 r">algo</span> = <b>new</b> <a href="@0@System.Core/A.html#40159cf70f20247e" class="t constructor">CngAlgorithm</a>( <span class="s">&quot;ECDSA&quot;</span> );
                    <b>break</b>;
 
                <b>default</b>:
                    <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#3f64c7634faf1768" class="t constructor">NotImplementedException</a>( <span class="s">$&quot;</span><span class="s">Curve tests not implemented: </span>{<span class="r11 r">curve</span>}<span class="s">&quot;</span> );
            }
 
            <a href="@0@System.Core/A.html#849bcfa612bcf097" class="k">var</a> <span id="r13 rd" class="r13 r">kcp</span> = <b>new</b> <a href="@0@System.Core/A.html#2934898eeaad404b" class="t constructor">CngKeyCreationParameters</a>
            {
                <a href="@0@System.Core/A.html#cda7df1ec7a64281" class="i property">ExportPolicy</a> = <a href="@0@System.Core/A.html#9dfd8402656557e3" class="t t">CngExportPolicies</a>.<a href="@0@System.Core/A.html#f2322ad7b9b9254a" class="i field">AllowPlaintextExport</a>,
                <a href="@0@System.Core/A.html#10aacc9a19aaf4e2" class="i property">KeyUsage</a> = <a href="@0@System.Core/A.html#9ce8d7c267170a57" class="t t">CngKeyUsages</a>.<a href="@0@System.Core/A.html#c1818bb914fd99b6" class="i field">Signing</a>,
            };
 
            <b>if</b> ( <span class="r11 r">curve</span> == <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#a386af2b91da273d" class="i field">P256K</a> )
                <span class="r13 r">kcp</span>.<a href="@0@System.Core/A.html#0623e51a980487cf" class="i property">Parameters</a>.<a href="@0@mscorlib/A.html#5c61cc24de82f7e7" class="i method">Add</a>( <b>new</b> <a href="@0@System.Core/A.html#7acd3b3dedd33dfe" class="t constructor">CngProperty</a>( <span class="s">&quot;ECCCurveName&quot;</span>, <a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#3ab75dace56ae6d2" class="i property">Unicode</a>.<a href="@0@mscorlib/A.html#83f2d2c6f22db1a9" class="i method">GetBytes</a>( <span class="s">&quot;secP256k1\0&quot;</span> ), <a href="@0@System.Core/A.html#6be7c8f8868a871f" class="t t">CngPropertyOptions</a>.<a href="@0@System.Core/A.html#e50a1259b4edeb83" class="i field">None</a> ) );
 
            <b>return</b> <b>new</b> <a href="@0@System.Core/A.html#1ee60f249b2afc62" class="t constructor">ECDsaCng</a>( <a href="@0@System.Core/A.html#d22415edef5b8a28" class="t t">CngKey</a>.<a href="@0@System.Core/A.html#e71832db201a177c" class="i method">Create</a>( <span class="r12 r">algo</span>, <b>null</b>, <span class="r13 r">kcp</span> ) );
        }
 
        <b>private static</b> <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="t t">JsonWebKey</a> <a id="a2696fb56f8fd099" href="R/a2696fb56f8fd099.html" target="n" data-glyph="76,1" class="i method">DoSerializationTests</a>( <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r14 rd" class="r14 r">json</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r15 rd" class="r15 r">curve</span>, <b>int</b> <span id="r16 rd" class="r16 r">keySize</span> )
        {
            <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="k">var</a> <span id="r17 rd" class="r17 r">jwk</span> = <span class="t t">JsonConvert</span>.<span class="i method">DeserializeObject</span>&lt;<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="t t">JsonWebKey</a>&gt;( <span class="r14 r">json</span> );
            <a href="#0164a4dad9be2379" class="i method">VerifyAttributes</a>( <span class="r17 r">jwk</span>, <span class="r15 r">curve</span>, <span class="r16 r">keySize</span>, <b>true</b> );
 
            <span class="c">// Serialization round-trip.</span>
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r18 rd" class="r18 r">json2</span> = <span class="t t">JsonConvert</span>.<span class="i method">SerializeObject</span>( <span class="r17 r">jwk</span> );
            <span class="t t">Assert</span>.<span class="i method">True</span>( <span class="r18 r">json2</span> == <span class="r14 r">json</span>, <span class="s">$&quot;</span><span class="s">Expected: </span>{<span class="r14 r">json</span>}<span class="s">\r\nFound: </span>{<span class="r18 r">json2</span>}<span class="s">&quot;</span> );
 
            <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="k">var</a> <span id="r19 rd" class="r19 r">jwk2</span> = <span class="t t">JsonConvert</span>.<span class="i method">DeserializeObject</span>&lt;<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="t t">JsonWebKey</a>&gt;( <span class="r14 r">json</span> );
 
            <span class="c">// Equals method.</span>
            <span class="t t">Assert</span>.<span class="i method">True</span>( <span class="r17 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#dd2022e1649e713a" class="i method">Equals</a>( <span class="r19 r">jwk2</span> ) );
 
            <span class="c">// Equals must consider curve.</span>
            <span class="r19 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#9cf03f581bcca3f1" class="i property">CurveName</a> = <b>null</b>;
            <span class="t t">Assert</span>.<span class="i method">False</span>( <span class="r17 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#dd2022e1649e713a" class="i method">Equals</a>( <span class="r19 r">jwk2</span> ) );
            <span class="r19 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#9cf03f581bcca3f1" class="i property">CurveName</a> = <span class="r17 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#9cf03f581bcca3f1" class="i property">CurveName</a>;
 
            <span class="c">// Equals must consider X.</span>
            <span class="r19 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#3087694fafdb835b" class="i property">X</a> = <b>null</b>;
            <span class="t t">Assert</span>.<span class="i method">False</span>( <span class="r17 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#dd2022e1649e713a" class="i method">Equals</a>( <span class="r19 r">jwk2</span> ) );
            <span class="r19 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#3087694fafdb835b" class="i property">X</a> = (<b>byte</b>[]) <span class="r17 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#3087694fafdb835b" class="i property">X</a>.<a href="@0@mscorlib/A.html#e71b274caef60cf0" class="i method">Clone</a>();
 
            <span class="c">// Equals must consider Y.</span>
            <span class="r19 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#16ff122891b4ddee" class="i property">Y</a> = <b>null</b>;
            <span class="t t">Assert</span>.<span class="i method">False</span>( <span class="r17 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#dd2022e1649e713a" class="i method">Equals</a>( <span class="r19 r">jwk2</span> ) );
            <span class="r19 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#16ff122891b4ddee" class="i property">Y</a> = (<b>byte</b>[]) <span class="r17 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#16ff122891b4ddee" class="i property">Y</a>.<a href="@0@mscorlib/A.html#e71b274caef60cf0" class="i method">Clone</a>();
 
            <span class="c">// Equals must consider D.</span>
            <span class="r19 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#e36618c05b815e77" class="i property">D</a> = <b>null</b>;
            <span class="t t">Assert</span>.<span class="i method">False</span>( <span class="r17 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#dd2022e1649e713a" class="i method">Equals</a>( <span class="r19 r">jwk2</span> ) );
            <span class="r19 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#e36618c05b815e77" class="i property">D</a> = (<b>byte</b>[]) <span class="r17 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#e36618c05b815e77" class="i property">D</a>.<a href="@0@mscorlib/A.html#e71b274caef60cf0" class="i method">Clone</a>();
 
            <b>return</b> <span class="r17 r">jwk</span>;
        }
 
        <b>private static void</b> <a id="c9a56080b10a1af1" href="R/c9a56080b10a1af1.html" target="n" data-glyph="76,1" class="i method">DoECDsaTests</a>( <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="t t">JsonWebKey</a> <span id="r20 rd" class="r20 r">jwk</span>, <b>int</b> <span id="r21 rd" class="r21 r">digestSize</span> )
        {
            <a href="@0@System.Core/A.html#59084d68c76f225c" class="k">var</a> <span id="r22 rd" class="r22 r">privateEcdsa</span> = <span class="r20 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>( <b>true</b> );
            <a href="@0@System.Core/A.html#59084d68c76f225c" class="k">var</a> <span id="r23 rd" class="r23 r">publicEcdsa</span> = <span class="r20 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>();
 
            <span class="c">// Round-trip with private Ecdsa.</span>
            <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="k">var</a> <span id="r24 rd" class="r24 r">jwk2</span> = <b>new</b> <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#ca9cc4d8b3fc8a31" class="t constructor">JsonWebKey</a>( <span class="r22 r">privateEcdsa</span> );
            <a href="@0@System.Core/A.html#59084d68c76f225c" class="k">var</a> <span id="r25 rd" class="r25 r">publicEcdsa2</span> = <span class="r24 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>();
 
            <a href="#6e04a462b3e1195c" class="i method">DoSignVerifyTests</a>( <span class="r21 r">digestSize</span>, <span class="r22 r">privateEcdsa</span>, <span class="r25 r">publicEcdsa2</span> );
 
            <span class="c">// Round-trip with public Ecdsa.</span>
            <span class="r24 r">jwk2</span> = <b>new</b> <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#ca9cc4d8b3fc8a31" class="t constructor">JsonWebKey</a>( <span class="r23 r">publicEcdsa</span> );
            <span class="r25 r">publicEcdsa2</span> = <span class="r24 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>();
 
            <a href="#6e04a462b3e1195c" class="i method">DoSignVerifyTests</a>( <span class="r21 r">digestSize</span>, <span class="r22 r">privateEcdsa</span>, <span class="r25 r">publicEcdsa2</span> );
        }
 
        <b>private static void</b> <a id="6e04a462b3e1195c" href="R/6e04a462b3e1195c.html" target="n" data-glyph="76,1" class="i method">DoSignVerifyTests</a>( <b>int</b> <span id="r26 rd" class="r26 r">digestSize</span>, <a href="@0@System.Core/A.html#59084d68c76f225c" class="t t">ECDsa</a> <span id="r27 rd" class="r27 r">privateEcdsa</span>, <a href="@0@System.Core/A.html#59084d68c76f225c" class="t t">ECDsa</a> <span id="r28 rd" class="r28 r">publicEcdsa</span> )
        {
            <span class="c">// Create pseudo-random hash.</span>
            <a href="@0@mscorlib/A.html#bb77e610694e64ca" class="k">var</a> <span id="r29 rd" class="r29 r">rnd</span> = <b>new</b> <a href="@0@mscorlib/A.html#92e3cf6e56571d5a" class="t constructor">Random</a>( 0 );
            <b>var</b> <span id="r30 rd" class="r30 r">digest</span> = <b>new</b> <b>byte</b>[<span class="r26 r">digestSize</span>];
            <span class="r29 r">rnd</span>.<a href="@0@mscorlib/A.html#04910e5e5c6c9a8b" class="i method">NextBytes</a>( <span class="r30 r">digest</span> );
 
            <b>bool</b> <span id="r31 rd" class="r31 r">verified</span>;
 
            <span class="c">// Check if private key can sign digest.</span>
            <b>var</b> <span id="r32 rd" class="r32 r">signature</span> = <span class="r27 r">privateEcdsa</span>.<a href="@0@System.Core/A.html#6b29f755b94d7d32" class="i method">SignHash</a>( <span class="r30 r">digest</span> );
 
            <span class="c">// Check if private key can verify digest.</span>
            <span class="r31 r">verified</span> = <span class="r27 r">privateEcdsa</span>.<a href="@0@System.Core/A.html#318c697ad38d9c98" class="i method">VerifyHash</a>( <span class="r30 r">digest</span>, <span class="r32 r">signature</span> );
            <span class="t t">Assert</span>.<span class="i method">True</span>( <span class="r31 r">verified</span> );
 
            <span class="c">// Check if public key can verify digest.</span>
            <span class="r31 r">verified</span> = <span class="r28 r">publicEcdsa</span>.<a href="@0@System.Core/A.html#318c697ad38d9c98" class="i method">VerifyHash</a>( <span class="r30 r">digest</span>, <span class="r32 r">signature</span> );
            <span class="t t">Assert</span>.<span class="i method">True</span>( <span class="r31 r">verified</span> );
 
            <span class="r32 r">signature</span>[<span class="r32 r">signature</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> - 1] ^= 1;
 
            <span class="c">// Check if private key can deny invalid digest.</span>
            <span class="r31 r">verified</span> = <span class="r27 r">privateEcdsa</span>.<a href="@0@System.Core/A.html#318c697ad38d9c98" class="i method">VerifyHash</a>( <span class="r30 r">digest</span>, <span class="r32 r">signature</span> );
            <span class="t t">Assert</span>.<span class="i method">False</span>( <span class="r31 r">verified</span> );
 
            <span class="c">// Check if public key can deny invalid digest.</span>
            <span class="r31 r">verified</span> = <span class="r28 r">publicEcdsa</span>.<a href="@0@System.Core/A.html#318c697ad38d9c98" class="i method">VerifyHash</a>( <span class="r30 r">digest</span>, <span class="r32 r">signature</span> );
            <span class="t t">Assert</span>.<span class="i method">False</span>( <span class="r31 r">verified</span> );
        }
 
        [<span class="t constructor">Fact</span>]
        <b>public static void</b> <a id="b7f97e0c03e719c7" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">PrivateKeyMustBeProtected</a>()
        {
            <b>if</b> ( !<a href="#ab2a7312ff3b38ba" class="i method">IsCngSupported</a>() )
                <b>return</b>;
 
            <a href="#5c1e3d069d792215" class="i method">DoPrivateKeyMustBeProtectedTests</a>( <a href="#5a8f105f8948709f" class="i field">P256TestKey</a>, 32 );
            <a href="#5c1e3d069d792215" class="i method">DoPrivateKeyMustBeProtectedTests</a>( <a href="#b8f332b74c13c9e7" class="i field">Secp256k1TestKey</a>, 32 );
        }
 
        <b>private static void</b> <a id="5c1e3d069d792215" href="R/5c1e3d069d792215.html" target="n" data-glyph="76,1" class="i method">DoPrivateKeyMustBeProtectedTests</a>( <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r33 rd" class="r33 r">json</span>, <b>int</b> <span id="r34 rd" class="r34 r">digestSize</span> )
        {
            <span class="c">// Create pseudo-random hash.</span>
            <a href="@0@mscorlib/A.html#bb77e610694e64ca" class="k">var</a> <span id="r35 rd" class="r35 r">rnd</span> = <b>new</b> <a href="@0@mscorlib/A.html#92e3cf6e56571d5a" class="t constructor">Random</a>( 0 );
            <b>var</b> <span id="r36 rd" class="r36 r">digest</span> = <b>new</b> <b>byte</b>[<span class="r34 r">digestSize</span>];
            <span class="r35 r">rnd</span>.<a href="@0@mscorlib/A.html#04910e5e5c6c9a8b" class="i method">NextBytes</a>( <span class="r36 r">digest</span> );
 
            <span class="c">// Get the key.</span>
            <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="k">var</a> <span id="r37 rd" class="r37 r">jwk</span> = <span class="t t">JsonConvert</span>.<span class="i method">DeserializeObject</span>&lt;<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="t t">JsonWebKey</a>&gt;( <span class="r33 r">json</span> );
            <a href="@0@System.Core/A.html#59084d68c76f225c" class="k">var</a> <span id="r38 rd" class="r38 r">privateEcdsa</span> = <span class="r37 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>( <b>true</b> );
 
            <span class="c">// Exporting ECDsa must not include private key.</span>
            <a href="@0@System.Core/A.html#59084d68c76f225c" class="k">var</a> <span id="r39 rd" class="r39 r">ecdsa</span> = <span class="r37 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>();
            <span class="t t">Assert</span>.<span class="i method">ThrowsAny</span>&lt;<a href="@0@mscorlib/A.html#0b7aa8a209a7f19f" class="t t">CryptographicException</a>&gt;( () =&gt; <span class="r39 r">ecdsa</span>.<a href="@0@System.Core/A.html#6b29f755b94d7d32" class="i method">SignHash</a>( <span class="r36 r">digest</span> ) );
 
            <span class="c">// Exporting ECParameters must not include private key.</span>
            <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#35603abbad105a6f" class="k">var</a> <span id="r40 rd" class="r40 r">ecParams</span> = <span class="r37 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#7098cfae074b12d3" class="i method">ToEcParameters</a>();
            <span class="t t">Assert</span>.<span class="i method">Null</span>( <span class="r40 r">ecParams</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#8c8f223bb8c260ce" class="i property">D</a> );
 
            <span class="c">// Importing ECDsa with private key must not include private key.</span>
            <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="k">var</a> <span id="r41 rd" class="r41 r">jwk2</span> = <b>new</b> <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#ca9cc4d8b3fc8a31" class="t constructor">JsonWebKey</a>( <span class="r38 r">privateEcdsa</span> );
            <span class="t t">Assert</span>.<span class="i method">Null</span>( <span class="r41 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#e36618c05b815e77" class="i property">D</a> );
 
            <span class="c">// Importing ECParameters without private key must work.</span>
            <span class="r40 r">ecParams</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#8c8f223bb8c260ce" class="i property">D</a> = <b>null</b>;
            <span class="r41 r">jwk2</span> = <b>new</b> <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#bd1475a2a996e042" class="t constructor">JsonWebKey</a>( <span class="r40 r">ecParams</span> );
            <span class="r41 r">jwk2</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>();
 
            <span class="r37 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#e36618c05b815e77" class="i property">D</a> = <b>null</b>;
 
            <span class="c">// Exporting ECDsa when WebKey lacks private key, must work.</span>
            <a href="@0@System.Core/A.html#59084d68c76f225c" class="k">var</a> <span id="r42 rd" class="r42 r">publicEcdsa</span> = <span class="r37 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>();
            <a href="#6e04a462b3e1195c" class="i method">DoSignVerifyTests</a>( <span class="r34 r">digestSize</span>, <span class="r38 r">privateEcdsa</span>, <span class="r42 r">publicEcdsa</span> );
 
            <span class="c">// Exporting ECDsa demanding private key when WebKey lacks private key, must throw exception.</span>
            <span class="t t">Assert</span>.<span class="i method">Throws</span>&lt;<a href="@0@mscorlib/A.html#109b3ef6299ef9df" class="t t">ArgumentException</a>&gt;( () =&gt; <span class="r37 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#118a8b68f400983e" class="i method">ToECDsa</a>( <b>true</b> ) );
 
            <span class="c">// Exporting ECParameters demanding private key when WebKey lacks private key, must throw exception.</span>
            <span class="t t">Assert</span>.<span class="i method">Throws</span>&lt;<a href="@0@mscorlib/A.html#109b3ef6299ef9df" class="t t">ArgumentException</a>&gt;( () =&gt; <span class="r37 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#7098cfae074b12d3" class="i method">ToEcParameters</a>( <b>true</b> ) );
        }
 
        <b>private static void</b> <a id="0164a4dad9be2379" href="R/0164a4dad9be2379.html" target="n" data-glyph="76,1" class="i method">VerifyAttributes</a>( <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#072f5b35a8ee35c6" class="t t">JsonWebKey</a> <span id="r43 rd" class="r43 r">jwk</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r44 rd" class="r44 r">curve</span>, <b>int</b> <span id="r45 rd" class="r45 r">keySize</span>, <b>bool</b> <span id="r46 rd" class="r46 r">expectPrivateKey</span> )
        {
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r47 rd" class="r47 r">keySizeInBytes</span> = ( <span class="r45 r">keySize</span> + 7 ) / 8;
            <span class="t t">Assert</span>.<span class="i method">Equal</span>( <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#c90001f143f0f6b2" class="t t">JsonWebKeyType</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#8ec62d93b4c095ea" class="i field">EllipticCurve</a>, <span class="r43 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#bf5694ab09c369fd" class="i property">Kty</a> );
            <span class="t t">Assert</span>.<span class="i method">Equal</span>( <span class="r44 r">curve</span>, <span class="r43 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#9cf03f581bcca3f1" class="i property">CurveName</a> );
            <span class="t t">Assert</span>.<span class="i method">Equal</span>( <span class="r47 r">keySizeInBytes</span>, <span class="r43 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#3087694fafdb835b" class="i property">X</a>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> );
            <span class="t t">Assert</span>.<span class="i method">Equal</span>( <span class="r47 r">keySizeInBytes</span>, <span class="r43 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#16ff122891b4ddee" class="i property">Y</a>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> );
            <b>if</b> ( <span class="r46 r">expectPrivateKey</span> )
                <span class="t t">Assert</span>.<span class="i method">Equal</span>( <span class="r47 r">keySizeInBytes</span>, <span class="r43 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#e36618c05b815e77" class="i property">D</a>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> );
            <b>var</b> <span id="r48 rd" class="r48 r">operations</span> = <b>new</b>[] {<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#b9f5c67cab5ac556" class="t t">JsonWebKeyOperation</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#dfad66299196683a" class="i field">Sign</a>, <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#b9f5c67cab5ac556" class="t t">JsonWebKeyOperation</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#caef56d617f788b0" class="i field">Verify</a>};
            <span class="t t">Assert</span>.<span class="i method">Equal</span>( <span class="r48 r">operations</span>, <span class="r43 r">jwk</span>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#6c108e193a5974bc" class="i property">KeyOps</a> );
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Insures Windows CNG (NCrypt) is supported on this platform.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> For instance, CNG is not supported on Linux.</span>
        <b>private static bool</b> <a id="ab2a7312ff3b38ba" href="R/ab2a7312ff3b38ba.html" target="n" data-glyph="76,1" class="i method">IsCngSupported</a>()
        {
            <b>try</b>
            {
                <a href="@0@System.Core/A.html#59084d68c76f225c" class="k">var</a> <span id="r49 rd" class="r49 r">key</span> = <a href="#3aa851556b00fab4" class="i method">CreateRandomKey</a>( <a href="/Microsoft.Azure.KeyVault.WebKey/A.html#880f0ad409210774" class="t t">JsonWebKeyCurveName</a>.<a href="/Microsoft.Azure.KeyVault.WebKey/A.html#6a1a931e140d8adf" class="i field">P256</a> );
                <span class="r49 r">key</span>.<a href="@0@mscorlib/A.html#496ab6e6cbd2d299" class="i method">Dispose</a>();
                <b>return</b> <b>true</b>;
            }
            <b>catch</b> ( <a href="@0@mscorlib/A.html#c5c14f954574e491" class="t t">PlatformNotSupportedException</a> )
            {
                <b>return</b> <b>false</b>;
            }
        }
    }
}</pre></td></tr></table></div></body></html>
