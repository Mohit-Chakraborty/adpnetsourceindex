<!DOCTYPE html>
<html><head><title>UploadFile.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(101);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Storage.Files.Shares.Perf/Scenarios/UploadFile.cs" target="_top">Scenarios\UploadFile.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Storage.Files.Shares.Perf" target="_top">Azure.Storage.Files.Shares\perf\Azure.Storage.Files.Shares.Perf\Azure.Storage.Files.Shares.Perf.csproj</a> (Azure.Storage.Files.Shares.Perf)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">//Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Test</span>.<span class="i n">Perf</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Files</span>.<span class="i n">Shares</span>.<span class="i n">Perf</span>.<span class="i n">Scenarios</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> The performance test scenario focused on uploading files to the Azure Files Shares storage.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">Azure</span>.<span class="i n">Test</span>.<span class="i n">Perf</span>.<a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="t t">PerfTest</a>{<span class="r0 r t">SizeOptions</span>}<span class="c">&quot;</span> <span class="c">/&gt;</span>
    <b>public sealed class</b> <a id="bcdd73aaf094f612" href="../R/bcdd73aaf094f612.html" target="n" data-glyph="0,0" class="t t">UploadFile</a> : <a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="t t">PerfTest</a>&lt;<a href="/Azure.Test.Perf/A.html#2f3451004e81ba49" class="t t">SizeOptions</a>&gt;
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The client to interact with an Azure storage share.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="/Azure.Storage.Files.Shares/A.html#8e93be0f24ba37e5" class="t t">ShareClient</a> <a id="a91efd9764d1a2f6" href="../R/a91efd9764d1a2f6.html" target="n" data-glyph="46,1" class="i field">_shareClient</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The client to interact with an Azure storage file inside an Azure storage share.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="/Azure.Storage.Files.Shares/A.html#6b6c6457cf67860c" class="t t">ShareFileClient</a> <a id="423b94d3735cedb0" href="../R/423b94d3735cedb0.html" target="n" data-glyph="46,1" class="i field">_fileClient</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Local stream uploaded to Azure storage.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <a id="2ecd8be7e230f0c9" href="../R/2ecd8be7e230f0c9.html" target="n" data-glyph="46,1" class="i field">_stream</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#bcdd73aaf094f612" class="t t">UploadFile</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The set of options to consider for configuring the scenario.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="c3fca14d9432d310" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">UploadFile</a>(<a href="/Azure.Test.Perf/A.html#2f3451004e81ba49" class="t t">SizeOptions</a> <span id="r1 rd" class="r1 r">options</span>) : <a href="/Azure.Test.Perf/A.html#9c8f97d1230a6380" class="k">base</a>(<span class="r1 r">options</span>)
        {
            <a href="#2ecd8be7e230f0c9" class="i field">_stream</a> = <a href="/Azure.Test.Perf/A.html#4226be2cb71e05eb" class="t t">RandomStream</a>.<a href="/Azure.Test.Perf/A.html#fecc53a895dfefc4" class="i method">Create</a>(<span class="r1 r">options</span>.<a href="/Azure.Test.Perf/A.html#40d7e60cfc4f9601" class="i property">Size</a>);
        }
 
        <b>public override void</b> <a id="107e27c2d4afa2b4" href="../R/107e27c2d4afa2b4.html" target="n" data-glyph="72,1" class="i method">Dispose</a>(<b>bool</b> <span id="r2 rd" class="r2 r">disposing</span>)
        {
            <a href="#2ecd8be7e230f0c9" class="i field">_stream</a>.<a href="@0@mscorlib/A.html#f1b4285950a82354" class="i method">Dispose</a>();
            <a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="k">base</a>.<a href="/Azure.Test.Perf/A.html#de03ba7d62078084" class="i method">Dispose</a>(<span class="r2 r">disposing</span>);
        }
 
        <b>public override async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="8cfca53b2a2d9607" href="../R/8cfca53b2a2d9607.html" target="n" data-glyph="72,1" class="i method">SetupAsync</a>()
        {
            <b>await</b> <a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="k">base</a>.<a href="/Azure.Test.Perf/A.html#5bcf2ef2415e5758" class="i method">SetupAsync</a>();
 
            <span class="c">// See https://docs.microsoft.com/en-us/rest/api/storageservices/naming-and-referencing-shares--directories--files--and-metadata for</span>
            <span class="c">// restrictions on file share naming.</span>
            <a href="#a91efd9764d1a2f6" class="i field">_shareClient</a> = <b>new</b> <a href="/Azure.Storage.Files.Shares/A.html#9c154aeabee90bcc" class="t constructor">ShareClient</a>(<a href="../Infrastructure/PerfTestEnvironment.cs.html#5f78632cc7b94205" class="t t">PerfTestEnvironment</a>.<a href="../Infrastructure/PerfTestEnvironment.cs.html#b091fd4dc7efe440" class="i property">Instance</a>.<a href="../Infrastructure/PerfTestEnvironment.cs.html#6e379d80e579c8fb" class="i property">FileSharesConnectionString</a>, <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>());
            <b>await</b> <a href="#a91efd9764d1a2f6" class="i field">_shareClient</a>.<span class="i">CreateAsync</span>();
 
            <a href="/Azure.Storage.Files.Shares/A.html#a4d391a2a09e50e5" class="t t">ShareDirectoryClient</a> <span id="r3 rd" class="r3 r">DirectoryClient</span> = <a href="#a91efd9764d1a2f6" class="i field">_shareClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#84917ce5da419d57" class="i method">GetDirectoryClient</a>(<a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#efb113f637a6bb47" class="i method">GetRandomFileName</a>());
            <b>await</b> <span class="r3 r">DirectoryClient</span>.<span class="i">CreateAsync</span>();
 
            <a href="#423b94d3735cedb0" class="i field">_fileClient</a> = <span class="r3 r">DirectoryClient</span>.<a href="/Azure.Storage.Files.Shares/A.html#99746bc3e3922d9b" class="i method">GetFileClient</a>(<a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#efb113f637a6bb47" class="i method">GetRandomFileName</a>());
            <b>await</b> <a href="#423b94d3735cedb0" class="i field">_fileClient</a>.<span class="i">CreateAsync</span>(<a href="#2ecd8be7e230f0c9" class="i field">_stream</a>.<a href="@0@mscorlib/A.html#48b7e39cfd844dc5" class="i property">Length</a>, <span class="i">cancellationToken</span>: <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@0@mscorlib/A.html#ec32c41597007382" class="i property">None</a>);
        }
 
        <b>public override async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="95b14ff9f568867f" href="../R/95b14ff9f568867f.html" target="n" data-glyph="72,1" class="i method">CleanupAsync</a>()
        {
            <b>await</b> <a href="#a91efd9764d1a2f6" class="i field">_shareClient</a>.<span class="i">DeleteAsync</span>();
            <b>await</b> <a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="k">base</a>.<a href="/Azure.Test.Perf/A.html#912d4c73ddef5685" class="i method">CleanupAsync</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Uploads a file to Azure Shares files storage by calling </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/Azure.Storage.Files.Shares/A.html#6b6c6457cf67860c" class="t t">ShareFileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#726e635b59cfb49c" class="i method">Upload</a>(<a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a>, <a href="@0@mscorlib/A.html#766adb700a2972f5" class="t t">IProgress</a>{<b>long</b>}, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The token used to signal cancellation request.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="2c83c404cecb43d0" href="../R/2c83c404cecb43d0.html" target="n" data-glyph="72,1" class="i method">Run</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r4 rd" class="r4 r">cancellationToken</span>)
        {
            <a href="#2ecd8be7e230f0c9" class="i field">_stream</a>.<a href="@0@mscorlib/A.html#eb5599035c4388ce" class="i method">Seek</a>(0, <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>.<a href="@0@mscorlib/A.html#c29481af7c617299" class="i field">Begin</a>);
 
            <span class="i n">Models</span>.<a href="/Azure.Storage.Files.Shares/A.html#9a96305c01de8651" class="t t">ShareFileUploadInfo</a> <span id="r5 rd" class="r5 r">fileUploadInfo</span> = <a href="#423b94d3735cedb0" class="i field">_fileClient</a>.<span class="i">Upload</span>(<a href="#2ecd8be7e230f0c9" class="i field">_stream</a>, <span class="i">cancellationToken</span>: <span class="r4 r">cancellationToken</span>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">DEBUG</span>
            <a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#5ac7c4fda643413b" class="i method">WriteLine</a>(<span class="s">$&quot;</span><span class="s">Uploaded stream to </span>{<a href="#423b94d3735cedb0" class="i field">_fileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#c92bb63e7a46e6ab" class="i property">Path</a>}<span class="s">. Hash: </span>{<span class="r5 r">fileUploadInfo</span>.<a href="/Azure.Storage.Files.Shares/A.html#100f244ab55152d2" class="i property">ContentHash</a>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>}<span class="s">&quot;</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Uploads a file to Azure Shares files storage by calling </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/Azure.Storage.Files.Shares/A.html#6b6c6457cf67860c" class="t t">ShareFileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#0f3953e7a200faf9" class="i method">UploadAsync</a>(<a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a>, <a href="@0@mscorlib/A.html#766adb700a2972f5" class="t t">IProgress</a>{<b>long</b>}, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The token used to signal cancellation request.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public override async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="279a3847a40ba5e9" href="../R/279a3847a40ba5e9.html" target="n" data-glyph="72,1" class="i method">RunAsync</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r6 rd" class="r6 r">cancellationToken</span>)
        {
            <a href="#2ecd8be7e230f0c9" class="i field">_stream</a>.<a href="@0@mscorlib/A.html#eb5599035c4388ce" class="i method">Seek</a>(0, <a href="@0@mscorlib/A.html#2cc1cf6635f00a52" class="t t">SeekOrigin</a>.<a href="@0@mscorlib/A.html#c29481af7c617299" class="i field">Begin</a>);
 
            <span class="i n">Models</span>.<a href="/Azure.Storage.Files.Shares/A.html#9a96305c01de8651" class="t t">ShareFileUploadInfo</a> <span id="r7 rd" class="r7 r">fileUploadInfo</span> = <b>await</b> <a href="#423b94d3735cedb0" class="i field">_fileClient</a>.<span class="i">UploadAsync</span>(<a href="#2ecd8be7e230f0c9" class="i field">_stream</a>, <span class="i">cancellationToken</span>: <span class="r6 r">cancellationToken</span>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">DEBUG</span>
            <a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#5ac7c4fda643413b" class="i method">WriteLine</a>(<span class="s">$&quot;</span><span class="s">Uploaded stream to </span>{<a href="#423b94d3735cedb0" class="i field">_fileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#c92bb63e7a46e6ab" class="i property">Path</a>}<span class="s">. Hash: </span>{<span class="r7 r">fileUploadInfo</span>.<a href="/Azure.Storage.Files.Shares/A.html#100f244ab55152d2" class="i property">ContentHash</a>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>}<span class="s">&quot;</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
    }
}
</pre></td></tr></table></div></body></html>
