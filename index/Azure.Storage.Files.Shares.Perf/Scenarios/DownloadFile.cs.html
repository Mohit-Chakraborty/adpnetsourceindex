<!DOCTYPE html>
<html><head><title>DownloadFile.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(105);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Storage.Files.Shares.Perf/Scenarios/DownloadFile.cs" target="_top">Scenarios\DownloadFile.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/storage/Azure.Storage.Files.Shares/perf/Azure.Storage.Files.Shares.Perf/Scenarios/DownloadFile.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Storage.Files.Shares.Perf" target="_top">Azure.Storage.Files.Shares.Perf.csproj</a> (Azure.Storage.Files.Shares.Perf)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Test</span>.<span class="i n">Perf</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Files</span>.<span class="i n">Shares</span>.<span class="i n">Perf</span>.<span class="i n">Scenarios</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> The performance test scenario focused on downloading files from the Azure Files Shares storage.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">Azure</span>.<span class="i n">Test</span>.<span class="i n">Perf</span>.<a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="t t">PerfTest</a>{<span class="r0 r t">SizeOptions</span>}<span class="c">&quot;</span> <span class="c">/&gt;</span>
    <b>public sealed class</b> <a id="ad2a1ae8ab51abc9" href="../R/ad2a1ae8ab51abc9.html" target="n" data-glyph="0,0" class="t t">DownloadFile</a> : <a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="t t">PerfTest</a>&lt;<a href="/Azure.Test.Perf/A.html#2f3451004e81ba49" class="t t">SizeOptions</a>&gt;
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The client to interact with an Azure storage share.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="/Azure.Storage.Files.Shares/A.html#8e93be0f24ba37e5" class="t t">ShareClient</a> <a id="6edec5fae04e7e5d" href="../R/6edec5fae04e7e5d.html" target="n" data-glyph="46,1" class="i field">_shareClient</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The client to interact with an Azure storage file inside an Azure storage share.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="/Azure.Storage.Files.Shares/A.html#6b6c6457cf67860c" class="t t">ShareFileClient</a> <a id="8649ed24fbb7d6ce" href="../R/8649ed24fbb7d6ce.html" target="n" data-glyph="46,1" class="i field">_fileClient</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Local stream uploaded to Azure storage.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a> <a id="11d07673bad8e66a" href="../R/11d07673bad8e66a.html" target="n" data-glyph="46,1" class="i field">_stream</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#ad2a1ae8ab51abc9" class="t t">DownloadFile</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The set of options to consider for configuring the scenario.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="6c1610a4688257c3" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">DownloadFile</a>(<a href="/Azure.Test.Perf/A.html#2f3451004e81ba49" class="t t">SizeOptions</a> <span id="r1 rd" class="r1 r">options</span>) : <a href="/Azure.Test.Perf/A.html#9c8f97d1230a6380" class="k">base</a>(<span class="r1 r">options</span>)
        {
            <a href="#11d07673bad8e66a" class="i field">_stream</a> = <a href="/Azure.Test.Perf/A.html#4226be2cb71e05eb" class="t t">RandomStream</a>.<a href="/Azure.Test.Perf/A.html#fecc53a895dfefc4" class="i method">Create</a>(<span class="r1 r">options</span>.<a href="/Azure.Test.Perf/A.html#40d7e60cfc4f9601" class="i property">Size</a>);
        }
 
        <b>public override void</b> <a id="9c718ef6ac5bf586" href="../R/9c718ef6ac5bf586.html" target="n" data-glyph="72,1" class="i method">Dispose</a>(<b>bool</b> <span id="r2 rd" class="r2 r">disposing</span>)
        {
            <a href="#11d07673bad8e66a" class="i field">_stream</a>.<a href="@0@mscorlib/A.html#f1b4285950a82354" class="i method">Dispose</a>();
            <a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="k">base</a>.<a href="/Azure.Test.Perf/A.html#8e400d7d9ac3d219" class="i method">Dispose</a>(<span class="r2 r">disposing</span>);
        }
 
        <b>public override async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="5e127511592c9943" href="../R/5e127511592c9943.html" target="n" data-glyph="72,1" class="i method">SetupAsync</a>()
        {
            <b>await</b> <a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="k">base</a>.<a href="/Azure.Test.Perf/A.html#a685002f0fee8393" class="i method">SetupAsync</a>();
 
            <span class="c">// See https://docs.microsoft.com/en-us/rest/api/storageservices/naming-and-referencing-shares--directories--files--and-metadata for</span>
            <span class="c">// restrictions on file share naming.</span>
            <a href="#6edec5fae04e7e5d" class="i field">_shareClient</a> = <b>new</b> <a href="/Azure.Storage.Files.Shares/A.html#9c154aeabee90bcc" class="t constructor">ShareClient</a>(<a href="../Infrastructure/PerfTestEnvironment.cs.html#5f78632cc7b94205" class="t t">PerfTestEnvironment</a>.<a href="../Infrastructure/PerfTestEnvironment.cs.html#b091fd4dc7efe440" class="i property">Instance</a>.<a href="../Infrastructure/PerfTestEnvironment.cs.html#6e379d80e579c8fb" class="i property">FileSharesConnectionString</a>, <a href="@0@mscorlib/A.html#b622ef5f6b76c10a" class="t t">Guid</a>.<a href="@0@mscorlib/A.html#b7fae6994c22c22e" class="i method">NewGuid</a>().<a href="@0@mscorlib/A.html#a6547a472def7796" class="i method">ToString</a>());
            <b>await</b> <a href="#6edec5fae04e7e5d" class="i field">_shareClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#f9949d8e9a778999" class="i method">CreateIfNotExistsAsync</a>();
 
            <a href="/Azure.Storage.Files.Shares/A.html#a4d391a2a09e50e5" class="t t">ShareDirectoryClient</a> <span id="r3 rd" class="r3 r">DirectoryClient</span> = <a href="#6edec5fae04e7e5d" class="i field">_shareClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#84917ce5da419d57" class="i method">GetDirectoryClient</a>(<a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#efb113f637a6bb47" class="i method">GetRandomFileName</a>());
            <b>await</b> <span class="r3 r">DirectoryClient</span>.<a href="/Azure.Storage.Files.Shares/A.html#6f19e97fbea489e0" class="i method">CreateIfNotExistsAsync</a>();
 
            <a href="#8649ed24fbb7d6ce" class="i field">_fileClient</a> = <span class="r3 r">DirectoryClient</span>.<a href="/Azure.Storage.Files.Shares/A.html#99746bc3e3922d9b" class="i method">GetFileClient</a>(<a href="@0@mscorlib/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@0@mscorlib/A.html#efb113f637a6bb47" class="i method">GetRandomFileName</a>());
            <b>await</b> <a href="#8649ed24fbb7d6ce" class="i field">_fileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#209fd69c4e8fe723" class="i method">CreateAsync</a>(<a href="#11d07673bad8e66a" class="i field">_stream</a>.<a href="@0@mscorlib/A.html#48b7e39cfd844dc5" class="i property">Length</a>, <span class="r4 r">cancellationToken</span>: <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@0@mscorlib/A.html#ec32c41597007382" class="i property">None</a>);
 
            <b>await</b> <a href="#8649ed24fbb7d6ce" class="i field">_fileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#17ec84ea8fa9c8d4" class="i method">UploadAsync</a>(<a href="#11d07673bad8e66a" class="i field">_stream</a>, <span class="r5 r">cancellationToken</span>: <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@0@mscorlib/A.html#ec32c41597007382" class="i property">None</a>);
        }
 
        <b>public override async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="eacb8d41c5d00cbd" href="../R/eacb8d41c5d00cbd.html" target="n" data-glyph="72,1" class="i method">CleanupAsync</a>()
        {
            <b>await</b> <a href="#6edec5fae04e7e5d" class="i field">_shareClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#ce3432d855678185" class="i method">DeleteIfExistsAsync</a>();
            <b>await</b> <a href="/Azure.Test.Perf/A.html#6fba2fa062ac4150" class="k">base</a>.<a href="/Azure.Test.Perf/A.html#921b14ff703aeeed" class="i method">CleanupAsync</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Downloads a file from the Azure Shares files storage by calling </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/Azure.Storage.Files.Shares/A.html#6b6c6457cf67860c" class="t t">ShareFileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#69a90524c6f790e8" class="i method">Download</a>(<a href="/Azure.Core/A.html#d6f9b3aba6783671" class="t t">HttpRange</a>, <b>bool</b>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The token used to signal cancellation request.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="735262953089df68" href="../R/735262953089df68.html" target="n" data-glyph="72,1" class="i method">Run</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r6 rd" class="r6 r">cancellationToken</span>)
        {
            <span class="i n">Models</span>.<a href="/Azure.Storage.Files.Shares/A.html#06de3053278dac3a" class="t t">ShareFileDownloadInfo</a> <span id="r7 rd" class="r7 r">fileDownloadInfo</span> = <a href="#8649ed24fbb7d6ce" class="i field">_fileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#fc4047ee92368e25" class="i method">Download</a>(<span class="r8 r">cancellationToken</span>: <span class="r6 r">cancellationToken</span>);
 
            <span class="c">// Copy the stream so it is actually downloaded. We use a memory stream as destination to avoid the cost of copying to a file on disk.</span>
            <span class="r7 r">fileDownloadInfo</span>.<a href="/Azure.Storage.Files.Shares/A.html#a56fabfcb5b967c4" class="i property">Content</a>.<a href="@0@mscorlib/A.html#295ec16c77d4fafb" class="i method">CopyTo</a>(<a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a>.<a href="@0@mscorlib/A.html#7e25c72455973e1f" class="i field">Null</a>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">DEBUG</span>
            <a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#5ac7c4fda643413b" class="i method">WriteLine</a>(<span class="s">$&quot;</span><span class="s">Downloaded file from </span>{<a href="#8649ed24fbb7d6ce" class="i field">_fileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#c92bb63e7a46e6ab" class="i property">Path</a>}<span class="s">. Content length: </span>{<span class="r7 r">fileDownloadInfo</span>.<a href="/Azure.Storage.Files.Shares/A.html#45354bc023174330" class="i property">ContentLength</a>}<span class="s">&quot;</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Downloads a file from the Azure Shares files storage by calling </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/Azure.Storage.Files.Shares/A.html#6b6c6457cf67860c" class="t t">ShareFileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#f67e32394338a532" class="i method">DownloadAsync</a>(<a href="/Azure.Core/A.html#d6f9b3aba6783671" class="t t">HttpRange</a>, <b>bool</b>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The token used to signal cancellation request.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public override async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="a89af3f4ac32dfa1" href="../R/a89af3f4ac32dfa1.html" target="n" data-glyph="72,1" class="i method">RunAsync</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r9 rd" class="r9 r">cancellationToken</span>)
        {
            <span class="i n">Models</span>.<a href="/Azure.Storage.Files.Shares/A.html#06de3053278dac3a" class="t t">ShareFileDownloadInfo</a> <span id="r10 rd" class="r10 r">fileDownloadInfo</span> = <b>await</b> <a href="#8649ed24fbb7d6ce" class="i field">_fileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#223d13d8e0b055a1" class="i method">DownloadAsync</a>(<span class="r11 r">cancellationToken</span>: <span class="r9 r">cancellationToken</span>);
 
            <span class="c">// Copy the stream so it is actually downloaded. We use a local memory stream as destination to avoid the cost of copying to a file on disk.</span>
            <b>await</b> <span class="r10 r">fileDownloadInfo</span>.<a href="/Azure.Storage.Files.Shares/A.html#a56fabfcb5b967c4" class="i property">Content</a>.<a href="@0@mscorlib/A.html#8048a9680abdd13b" class="i method">CopyToAsync</a>(<a href="@0@mscorlib/A.html#f956b0c07e86df64" class="t t">Stream</a>.<a href="@0@mscorlib/A.html#7e25c72455973e1f" class="i field">Null</a>, (<b>int</b>)<a href="#11d07673bad8e66a" class="i field">_stream</a>.<a href="@0@mscorlib/A.html#48b7e39cfd844dc5" class="i property">Length</a>, <span class="r12 r">cancellationToken</span>: <span class="r9 r">cancellationToken</span>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">DEBUG</span>
            <a href="@0@mscorlib/A.html#f907d79481da6ba4" class="t t">Console</a>.<a href="@0@mscorlib/A.html#5ac7c4fda643413b" class="i method">WriteLine</a>(<span class="s">$&quot;</span><span class="s">Downloaded file from </span>{<a href="#8649ed24fbb7d6ce" class="i field">_fileClient</a>.<a href="/Azure.Storage.Files.Shares/A.html#c92bb63e7a46e6ab" class="i property">Path</a>}<span class="s">. Content length: </span>{<span class="r10 r">fileDownloadInfo</span>.<a href="/Azure.Storage.Files.Shares/A.html#45354bc023174330" class="i property">ContentLength</a>}<span class="s">&quot;</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
    }
}
</pre></td></tr></table></div></body></html>
