<!DOCTYPE html>
<html><head><title>Sample4_DownloadCertificate.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(83);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Security.KeyVault.Certificates.Tests/samples/Sample4_DownloadCertificate.cs" target="_top">samples\Sample4_DownloadCertificate.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/keyvault/Azure.Security.KeyVault.Certificates/tests/samples/Sample4_DownloadCertificate.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Security.KeyVault.Certificates.Tests" target="_top">Azure.Security.KeyVault.Certificates.Tests.csproj</a> (Azure.Security.KeyVault.Certificates.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">NUnit</span>.<span class="i n">Framework</span>;
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Runtime</span>.<span class="i n">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Security</span>.<span class="i n">Cryptography</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Security</span>.<span class="i n">Cryptography</span>.<span class="i n">X509Certificates</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Security</span>.<span class="i n">KeyVault</span>.<span class="i n">Certificates</span>.<span class="i n">Samples</span>
{
    <b>public</b> <a href="../P/a4941eda6c04f934.html" target="s" class="k">partial</a> <b>class</b> <a id="a4941eda6c04f934" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="601d757adbe33eb2">DownloadCertificate</span></a>
    {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">NET461</span>
<span class="e">        [Test]
        public void DownloadCertificateSync()
        {
            // Environment variable with the Key Vault endpoint.
            string keyVaultUrl = TestEnvironment.KeyVaultUrl;
 
</span>        <span class="k preprocess">#</span><span class="k preprocess">region</span> Snippet:CertificatesSample4CertificateClient
<span class="e">            CertificateClient client = new CertificateClient(new Uri(keyVaultUrl), new DefaultAzureCredential());
</span>        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
<span class="e">
            string certificateName = $&quot;rsa-{Guid.NewGuid()}&quot;;
            CertificateOperation operation = client.StartCreateCertificate(certificateName, CertificatePolicy.Default);
 
            while (!operation.HasCompleted)
            {
                operation.UpdateStatus();
                Thread.Sleep(TimeSpan.FromSeconds(10));
            }
 
            using SHA256 sha = SHA256.Create();
            byte[] data = Encoding.UTF8.GetBytes(&quot;test&quot;);
            byte[] hash = sha.ComputeHash(data);
 
</span>        <span class="k preprocess">#</span><span class="k preprocess">region</span> Snippet:CertificatesSample4DownloadCertificate
<span class="e">            X509KeyStorageFlags keyStorageFlags = X509KeyStorageFlags.MachineKeySet;
            if (!RuntimeInformation.IsOSPlatform(OSPlatform.OSX))
            {
                keyStorageFlags |= X509KeyStorageFlags.EphemeralKeySet;
            }
 
            DownloadCertificateOptions options = new DownloadCertificateOptions(certificateName)
            {
                KeyStorageFlags = keyStorageFlags
            };
 
            using X509Certificate2 certificate = client.DownloadCertificate(options);
            using RSA key = certificate.GetRSAPrivateKey();
 
            byte[] signature = key.SignHash(hash, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1);
            Debug.WriteLine($&quot;Signature: {Convert.ToBase64String(signature)}&quot;);
</span>        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
<span class="e">
</span>        <span class="k preprocess">#</span><span class="k preprocess">region</span> Snippet:CertificatesSample4PublicKey
<span class="e">            Response&lt;KeyVaultCertificateWithPolicy&gt; certificateResponse = client.GetCertificate(certificateName);
            using X509Certificate2 publicCertificate = new X509Certificate2(certificateResponse.Value.Cer);
            using RSA publicKey = publicCertificate.GetRSAPublicKey();
 
            bool verified = publicKey.VerifyHash(hash, signature, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1);
            Debug.WriteLine($&quot;Signature verified: {verified}&quot;);
</span>        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
<span class="e">
            Assert.IsTrue(verified);
 
            DeleteCertificateOperation deleteOperation = client.StartDeleteCertificate(certificateName);
            while (!deleteOperation.HasCompleted)
            {
                deleteOperation.UpdateStatus();
                Thread.Sleep(TimeSpan.FromSeconds(2));
            }
 
            client.PurgeDeletedCertificate(certificateName);
        }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
    }
}
</pre></td></tr></table></div></body></html>
