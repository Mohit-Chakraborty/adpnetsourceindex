<!DOCTYPE html>
<html><head><title>PemReaderTests.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(113);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Security.KeyVault.Certificates.Tests/PemReaderTests.cs" target="_top">PemReaderTests.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/keyvault/Azure.Security.KeyVault.Certificates/tests/PemReaderTests.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Security.KeyVault.Certificates.Tests" target="_top">Azure.Security.KeyVault.Certificates.Tests.csproj</a> (Azure.Security.KeyVault.Certificates.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Security</span>.<span class="i n">Cryptography</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Security</span>.<span class="i n">Cryptography</span>.<span class="i n">X509Certificates</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>;
<b>using</b> <span class="i n">NUnit</span>.<span class="i n">Framework</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Security</span>.<span class="i n">KeyVault</span>.<span class="i n">Certificates</span>.<span class="i n">Tests</span>
{
    <b>public</b> <a href="P/c3fa7fa055990c92.html" target="s" class="k">partial</a> <b>class</b> <a id="c3fa7fa055990c92" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="db4a4e198381bb08">PemReaderTests</span></a>
    {
        [<span class="t constructor">Test</span>]
        <b>public void</b> <a id="bf2ede11f53ee5cd" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LoadCertificate</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">NET461</span>
            <span class="t t">Assert</span>.<span class="i method">Ignore</span>(<span class="s">&quot;Loading X509Certificate2 with private EC key not supported on this platform&quot;</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>using</b> <a href="@0@System/A.html#2e8ad9e6007798e5" class="t t">X509Certificate2</a> <span id="r0 rd" class="r0 r">certificate</span> = <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#dfa8de8f1f4a3a94" class="i method">LoadCertificate</a>(<a href="PemReaderTests.Keys.cs.html#fc5c9dd91ab1cb43" class="i field">s_ecdsaFullCertificate</a>.<span class="i method">AsSpan</span>(), <span class="r1 r">keyType</span>: <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#1127f8a274ecf440" class="t t">KeyType</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#e959944af68bc123" class="i field">ECDsa</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;CN=Azure SDK&quot;</span>, <span class="r0 r">certificate</span>.<a href="@0@mscorlib/A.html#ab0ff5e07f224a7a" class="i property">Subject</a>);
            <span class="t t">Assert</span>.<span class="i method">IsTrue</span>(<span class="r0 r">certificate</span>.<a href="@0@System/A.html#f7670d048c7a5a70" class="i property">HasPrivateKey</a>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public void</b> <a id="6055d63a71217a29" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LoadCertificateAutomatically</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">NET461</span>
            <span class="t t">Assert</span>.<span class="i method">Ignore</span>(<span class="s">&quot;Loading X509Certificate2 with private EC key not supported on this platform&quot;</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>using</b> <a href="@0@System/A.html#2e8ad9e6007798e5" class="t t">X509Certificate2</a> <span id="r2 rd" class="r2 r">certificate</span> = <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#dfa8de8f1f4a3a94" class="i method">LoadCertificate</a>(<a href="PemReaderTests.Keys.cs.html#fc5c9dd91ab1cb43" class="i field">s_ecdsaFullCertificate</a>.<span class="i method">AsSpan</span>());
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;CN=Azure SDK&quot;</span>, <span class="r2 r">certificate</span>.<a href="@0@mscorlib/A.html#ab0ff5e07f224a7a" class="i property">Subject</a>);
            <span class="t t">Assert</span>.<span class="i method">IsTrue</span>(<span class="r2 r">certificate</span>.<a href="@0@System/A.html#f7670d048c7a5a70" class="i property">HasPrivateKey</a>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public void</b> <a id="4030372419984d4c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LoadCertificateWithPublicKey</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">NET461</span>
            <span class="t t">Assert</span>.<span class="i method">Ignore</span>(<span class="s">&quot;Loading X509Certificate2 with private EC key not supported on this platform&quot;</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>using</b> <a href="@0@System/A.html#2e8ad9e6007798e5" class="t t">X509Certificate2</a> <span id="r3 rd" class="r3 r">certificate</span> = <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#dfa8de8f1f4a3a94" class="i method">LoadCertificate</a>(<a href="PemReaderTests.Keys.cs.html#3d4ee943f8d9bba4" class="i field">ECDsaPrivateKey</a>.<span class="i method">AsSpan</span>(), <span class="r4 r">cer</span>: <a href="PemReaderTests.Keys.cs.html#68c517885cf27364" class="i field">s_ecdsaCertificateBytes</a>, <span class="r1 r">keyType</span>: <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#1127f8a274ecf440" class="t t">KeyType</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#e959944af68bc123" class="i field">ECDsa</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;CN=Azure SDK&quot;</span>, <span class="r3 r">certificate</span>.<a href="@0@mscorlib/A.html#ab0ff5e07f224a7a" class="i property">Subject</a>);
            <span class="t t">Assert</span>.<span class="i method">IsTrue</span>(<span class="r3 r">certificate</span>.<a href="@0@System/A.html#f7670d048c7a5a70" class="i property">HasPrivateKey</a>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public void</b> <a id="9b8aeab901eda8f4" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LoadCertificateWithoutPublicKey</a>()
        {
            <a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r5 rd" class="r5 r">ex</span> = <span class="t t">Assert</span>.<span class="i method">Throws</span>&lt;<a href="@0@System/A.html#2b389f14fb01ad1b" class="t t">InvalidDataException</a>&gt;(() =&gt; <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#dfa8de8f1f4a3a94" class="i method">LoadCertificate</a>(<a href="PemReaderTests.Keys.cs.html#3d4ee943f8d9bba4" class="i field">ECDsaPrivateKey</a>.<span class="i method">AsSpan</span>(), <span class="r1 r">keyType</span>: <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#1127f8a274ecf440" class="t t">KeyType</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#e959944af68bc123" class="i field">ECDsa</a>));
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;The certificate is missing the public key&quot;</span>, <span class="r5 r">ex</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public void</b> <a id="155aee461ec6cc66" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LoadCertificateWithoutPrivateKey</a>()
        {
            <a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r6 rd" class="r6 r">ex</span> = <span class="t t">Assert</span>.<span class="i method">Throws</span>&lt;<a href="@0@System/A.html#2b389f14fb01ad1b" class="t t">InvalidDataException</a>&gt;(() =&gt; <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#dfa8de8f1f4a3a94" class="i method">LoadCertificate</a>(<a href="PemReaderTests.Keys.cs.html#17f040ee1f23262b" class="i field">ECDsaCertificate</a>.<span class="i method">AsSpan</span>(), <span class="r1 r">keyType</span>: <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#1127f8a274ecf440" class="t t">KeyType</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#e959944af68bc123" class="i field">ECDsa</a>));
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;The certificate is missing the private key&quot;</span>, <span class="r6 r">ex</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public void</b> <a id="7d21af535b65936f" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LoadCertificateWithOnlyPublicKeyAllowed</a>()
        {
            <b>using</b> <a href="@0@System/A.html#2e8ad9e6007798e5" class="t t">X509Certificate2</a> <span id="r7 rd" class="r7 r">certificate</span> = <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#dfa8de8f1f4a3a94" class="i method">LoadCertificate</a>(<a href="PemReaderTests.Keys.cs.html#17f040ee1f23262b" class="i field">ECDsaCertificate</a>.<span class="i method">AsSpan</span>(), <span class="r8 r">allowCertificateOnly</span>: <b>true</b>, <span class="r1 r">keyType</span>: <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#1127f8a274ecf440" class="t t">KeyType</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#e959944af68bc123" class="i field">ECDsa</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;CN=Azure SDK&quot;</span>, <span class="r7 r">certificate</span>.<a href="@0@mscorlib/A.html#ab0ff5e07f224a7a" class="i property">Subject</a>);
            <span class="t t">Assert</span>.<span class="i method">IsFalse</span>(<span class="r7 r">certificate</span>.<a href="@0@System/A.html#f7670d048c7a5a70" class="i property">HasPrivateKey</a>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public void</b> <a id="012155cf70244e80" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LoadCertificateWithNoKeys</a>()
        {
            <a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r9 rd" class="r9 r">ex</span> = <span class="t t">Assert</span>.<span class="i method">Throws</span>&lt;<a href="@0@System/A.html#2b389f14fb01ad1b" class="t t">InvalidDataException</a>&gt;(() =&gt; <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#dfa8de8f1f4a3a94" class="i method">LoadCertificate</a>(<span class="t t">Span</span>&lt;<b>char</b>&gt;.<span class="i property">Empty</span>, <span class="r1 r">keyType</span>: <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#1127f8a274ecf440" class="t t">KeyType</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#e959944af68bc123" class="i field">ECDsa</a>));
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;The certificate is missing the public key&quot;</span>, <span class="r9 r">ex</span>.<a href="@0@mscorlib/A.html#5fba0e16215b42a3" class="i property">Message</a>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public void</b> <a id="c12d7e656d72bfb8" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LoadCertificatePemOverridesCer</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">NET461</span>
            <span class="t t">Assert</span>.<span class="i method">Ignore</span>(<span class="s">&quot;Loading X509Certificate2 with private EC key not supported on this platform&quot;</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>using</b> <a href="@0@System/A.html#2e8ad9e6007798e5" class="t t">X509Certificate2</a> <span id="r10 rd" class="r10 r">certificate</span> = <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#dfa8de8f1f4a3a94" class="i method">LoadCertificate</a>(<a href="PemReaderTests.Keys.cs.html#fc5c9dd91ab1cb43" class="i field">s_ecdsaFullCertificate</a>.<span class="i method">AsSpan</span>(), <span class="r4 r">cer</span>: <a href="@0@mscorlib/A.html#3b6090c501893c25" class="t t">Encoding</a>.<a href="@0@mscorlib/A.html#a10eb90a3d884500" class="i property">UTF8</a>.<a href="@0@mscorlib/A.html#83f2d2c6f22db1a9" class="i method">GetBytes</a>(<span class="s">&quot;This is not a certificate&quot;</span>), <span class="r1 r">keyType</span>: <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#1127f8a274ecf440" class="t t">KeyType</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#e959944af68bc123" class="i field">ECDsa</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;CN=Azure SDK&quot;</span>, <span class="r10 r">certificate</span>.<a href="@0@mscorlib/A.html#ab0ff5e07f224a7a" class="i property">Subject</a>);
            <span class="t t">Assert</span>.<span class="i method">IsTrue</span>(<span class="r10 r">certificate</span>.<a href="@0@System/A.html#f7670d048c7a5a70" class="i property">HasPrivateKey</a>);
        }
 
        [<span class="t constructor">Test</span>]
        <b>public void</b> <a id="23116ac245698074" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LoadRSACertificate</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">NET461</span>
            <span class="c">// Compatible with previous release. Goes through the LightweightPkcs8Decoder.DecodeECDsaPkcs8().</span>
            <span class="t t">Assert</span>.<span class="i method">Throws</span>&lt;<a href="@0@System/A.html#2b389f14fb01ad1b" class="t t">InvalidDataException</a>&gt;(() =&gt; <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#dfa8de8f1f4a3a94" class="i method">LoadCertificate</a>(<a href="PemReaderTests.Keys.cs.html#fd2d62862272c18a" class="i field">RSACertificate</a>.<span class="i method">AsSpan</span>(), <span class="r1 r">keyType</span>: <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#1127f8a274ecf440" class="t t">KeyType</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#e959944af68bc123" class="i field">ECDsa</a>));
<span class="k preprocess">#</span><span class="k preprocess">else</span>
<span class="e">            // Compatible with the previous release. Goes through RSA.ImportPKcs8PrivateKey().
            Assert.That(() =&gt; PemReader.LoadCertificate(RSACertificate.AsSpan(), keyType: PemReader.KeyType.ECDsa), Throws.InstanceOf&lt;CryptographicException&gt;());
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        [<span class="t constructor">Test</span>]
        <b>public void</b> <a id="9f9a084eb53a569e" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LoadECDsaPrime256v1Certificate</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">NET461</span>
            <span class="t t">Assert</span>.<span class="i method">Ignore</span>(<span class="s">&quot;Loading X509Certificate2 with private EC key not supported on this platform&quot;</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>using</b> <a href="@0@System/A.html#2e8ad9e6007798e5" class="t t">X509Certificate2</a> <span id="r11 rd" class="r11 r">certificate</span> = <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#dfa8de8f1f4a3a94" class="i method">LoadCertificate</a>(<a href="PemReaderTests.Keys.cs.html#fc5c9dd91ab1cb43" class="i field">s_ecdsaFullCertificate</a>.<span class="i method">AsSpan</span>(), <span class="r1 r">keyType</span>: <a href="/Azure.Security.KeyVault.Certificates/A.html#7cfeb2a4805407b3" class="t t">PemReader</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#1127f8a274ecf440" class="t t">KeyType</a>.<a href="/Azure.Security.KeyVault.Certificates/A.html#e959944af68bc123" class="i field">ECDsa</a>);
            <span class="t t">Assert</span>.<span class="i method">AreEqual</span>(<span class="s">&quot;CN=Azure SDK&quot;</span>, <span class="r11 r">certificate</span>.<a href="@0@mscorlib/A.html#ab0ff5e07f224a7a" class="i property">Subject</a>);
            <span class="t t">Assert</span>.<span class="i method">IsTrue</span>(<span class="r11 r">certificate</span>.<a href="@0@System/A.html#f7670d048c7a5a70" class="i property">HasPrivateKey</a>);
        }
    }
}
</pre></td></tr></table></div></body></html>
