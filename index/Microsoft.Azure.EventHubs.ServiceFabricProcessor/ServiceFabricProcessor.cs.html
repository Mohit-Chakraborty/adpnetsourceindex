<!DOCTYPE html>
<html><head><title>ServiceFabricProcessor.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(522);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.EventHubs.ServiceFabricProcessor/ServiceFabricProcessor.cs" target="_top">ServiceFabricProcessor.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.EventHubs.ServiceFabricProcessor" target="_top">..\..\Microsoft.Azure.EventHubs.ServiceFabricProcessor\src\Microsoft.Azure.EventHubs.ServiceFabricProcessor.csproj</a> (Microsoft.Azure.EventHubs.ServiceFabricProcessor)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft. All rights reserved.</span>
<span class="c">// Licensed under the MIT license. See LICENSE file in the project root for full license information.using System;</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<span class="i n">ServiceFabricProcessor</span>
{
    <b>using</b> <span class="i">System</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Fabric</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Fabric</span>.<span class="i">Description</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Fabric</span>.<span class="i">Query</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Threading</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i">ServiceFabric</span>.<span class="i">Data</span>;
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Base class that implements event processor functionality.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="a32fbfa5c91e3b37" href="R/a32fbfa5c91e3b37.html" target="n" data-glyph="0,0" class="t t">ServiceFabricProcessor</a> : <a href="/Microsoft.Azure.EventHubs/A.html#4376c1c4658c32ac" class="t t">IPartitionReceiveHandler</a>
    {
        <span class="c">// Service Fabric objects initialized in constructor</span>
        <b>private readonly</b> <span class="i">IReliableStateManager</span> <a id="07665dfa79598741" href="R/07665dfa79598741.html" target="n" data-glyph="46,1" class="i field">serviceStateManager</a>;
        <b>private readonly</b> <span class="i">Uri</span> <a id="9bcd7a087fb5cbf9" href="R/9bcd7a087fb5cbf9.html" target="n" data-glyph="46,1" class="i field">serviceFabricServiceName</a>;
        <b>private readonly</b> <span class="i">Guid</span> <a id="43eadaa6b36a0529" href="R/43eadaa6b36a0529.html" target="n" data-glyph="46,1" class="i field">serviceFabricPartitionId</a>;
        <b>private readonly</b> <span class="i">IStatefulServicePartition</span> <a id="b5b66e4a72aea36c" href="R/b5b66e4a72aea36c.html" target="n" data-glyph="46,1" class="i field">servicePartition</a>;
 
        <span class="c">// ServiceFabricProcessor settings initialized in constructor</span>
        <b>private readonly</b> <a href="IEventProcessor.cs.html#e56915915feb4fed" class="t t">IEventProcessor</a> <a id="61b4a9cdd12049f3" href="R/61b4a9cdd12049f3.html" target="n" data-glyph="46,1" class="i field">userEventProcessor</a>;
        <b>private readonly</b> <a href="EventProcessorOptions.cs.html#99ecb9feab823adf" class="t t">EventProcessorOptions</a> <a id="7015a1cfd021c855" href="R/7015a1cfd021c855.html" target="n" data-glyph="46,1" class="i field">options</a>;
        <b>private readonly</b> <a href="ICheckpointMananger.cs.html#569f46826265f34a" class="t t">ICheckpointMananger</a> <a id="b2d12271d6f6d26c" href="R/b2d12271d6f6d26c.html" target="n" data-glyph="46,1" class="i field">checkpointManager</a>;
 
        <span class="c">// Initialized during RunAsync startup</span>
        <b>private int</b> <a id="f84a7c255ba17e97" href="R/f84a7c255ba17e97.html" target="n" data-glyph="46,1" class="i field">fabricPartitionOrdinal</a> = -1;
        <b>private int</b> <a id="2e28508f7890b59b" href="R/2e28508f7890b59b.html" target="n" data-glyph="46,1" class="i field">servicePartitionCount</a> = -1;
        <b>private string</b> <a id="936ea959803bdd2e" href="R/936ea959803bdd2e.html" target="n" data-glyph="46,1" class="i field">hubPartitionId</a>;
        <b>private</b> <a href="PartitionContext.cs.html#1a49dc0b2da9fcb8" class="t t">PartitionContext</a> <a id="09cfc83cf153d52e" href="R/09cfc83cf153d52e.html" target="n" data-glyph="46,1" class="i field">partitionContext</a>;
        <b>private string</b> <a id="d9dc760d9ada39f4" href="R/d9dc760d9ada39f4.html" target="n" data-glyph="46,1" class="i field">initialOffset</a>;
        <b>private</b> <span class="i">CancellationTokenSource</span> <a id="e0d5438e23fd1a18" href="R/e0d5438e23fd1a18.html" target="n" data-glyph="46,1" class="i field">internalCanceller</a>;
        <b>private</b> <span class="i">Exception</span> <a id="922cefca92695b8d" href="R/922cefca92695b8d.html" target="n" data-glyph="46,1" class="i field">internalFatalException</a>;
        <b>private</b> <span class="i">CancellationToken</span> <a id="c8fb9728da7ca96a" href="R/c8fb9728da7ca96a.html" target="n" data-glyph="46,1" class="i field">linkedCancellationToken</a>;
        <b>private</b> <a href="/Microsoft.Azure.EventHubs/A.html#37541b805119d484" class="t t">EventHubsConnectionStringBuilder</a> <a id="100c54e66a3cc783" href="R/100c54e66a3cc783.html" target="n" data-glyph="46,1" class="i field">ehConnectionString</a>;
        <b>private string</b> <a id="a6a7de9a1b999085" href="R/a6a7de9a1b999085.html" target="n" data-glyph="46,1" class="i field">consumerGroupName</a>;
 
        <span class="c">// Value managed by RunAsync</span>
        <b>private int</b> <a id="8422e818b68783a1" href="R/8422e818b68783a1.html" target="n" data-glyph="46,1" class="i field">running</a> = 0;
 
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor. Arguments break down into three groups: (1) Service Fabric objects so this library can access</span>
        <span class="c">///</span><span class="c"> Service Fabric facilities, (2) Event Hub-related arguments which indicate what event hub to receive from and</span>
        <span class="c">///</span><span class="c"> how to process the events, and (3) advanced, which right now consists only of the ability to replace the default</span>
        <span class="c">///</span><span class="c"> reliable dictionary-based checkpoint manager with a user-provided implementation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">serviceFabricServiceName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Service Fabric Uri found in StatefulServiceContext</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">serviceFabricPartitionId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Service Fabric partition id found in StatefulServiceContext</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">stateManager</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Service Fabric-provided state manager, provides access to reliable dictionaries</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">partition</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Service Fabric-provided partition information</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">userEventProcessor</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">User&#39;s event processor implementation</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">eventHubConnectionString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Connection string for user&#39;s event hub</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">eventHubConsumerGroup</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Name of event hub consumer group to receive from</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Optional: Options structure for ServiceFabricProcessor library</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">checkpointManager</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Very advanced/optional: user-provided checkpoint manager implementation</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="40b1e869fb8e6507" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">ServiceFabricProcessor</a>(<span class="i">Uri</span> <span id="r0 rd" class="r0 r">serviceFabricServiceName</span>, <span class="i">Guid</span> <span id="r1 rd" class="r1 r">serviceFabricPartitionId</span>, <span class="i">IReliableStateManager</span> <span id="r2 rd" class="r2 r">stateManager</span>, <span class="i">IStatefulServicePartition</span> <span id="r3 rd" class="r3 r">partition</span>, <a href="IEventProcessor.cs.html#e56915915feb4fed" class="t t">IEventProcessor</a> <span id="r4 rd" class="r4 r">userEventProcessor</span>,
            <b>string</b> <span id="r5 rd" class="r5 r">eventHubConnectionString</span>, <b>string</b> <span id="r6 rd" class="r6 r">eventHubConsumerGroup</span>,
            <a href="EventProcessorOptions.cs.html#99ecb9feab823adf" class="t t">EventProcessorOptions</a> <span id="r7 rd" class="r7 r">options</span> = <b>null</b>, <a href="ICheckpointMananger.cs.html#569f46826265f34a" class="t t">ICheckpointMananger</a> <span id="r8 rd" class="r8 r">checkpointManager</span> = <b>null</b>)
        {
            <b>if</b> (<span class="r0 r">serviceFabricServiceName</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<span class="s">&quot;serviceFabricServiceName is null&quot;</span>);
            }
            <b>if</b> (<span class="r1 r">serviceFabricPartitionId</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<span class="s">&quot;serviceFabricPartitionId is null&quot;</span>);
            }
            <b>if</b> (<span class="r2 r">stateManager</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<span class="s">&quot;stateManager is null&quot;</span>);
            }
            <b>if</b> (<span class="r3 r">partition</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<span class="s">&quot;partition is null&quot;</span>);
            }
            <b>if</b> (<span class="r4 r">userEventProcessor</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<span class="s">&quot;userEventProcessor is null&quot;</span>);
            }
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r5 r">eventHubConnectionString</span>))
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<span class="s">&quot;eventHubConnectionString is null or empty&quot;</span>);
            }
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r6 r">eventHubConsumerGroup</span>))
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<span class="s">&quot;eventHubConsumerGroup is null or empty&quot;</span>);
            }
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#9bcd7a087fb5cbf9" class="i field">serviceFabricServiceName</a> = <span class="r0 r">serviceFabricServiceName</span>;
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#43eadaa6b36a0529" class="i field">serviceFabricPartitionId</a> = <span class="r1 r">serviceFabricPartitionId</span>;
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#07665dfa79598741" class="i field">serviceStateManager</a> = <span class="r2 r">stateManager</span>;
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b5b66e4a72aea36c" class="i field">servicePartition</a> = <span class="r3 r">partition</span>;
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a> = <span class="r4 r">userEventProcessor</span>;
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#100c54e66a3cc783" class="i field">ehConnectionString</a> = <b>new</b> <span class="t">EventHubsConnectionStringBuilder</span>(<span class="r5 r">eventHubConnectionString</span>);
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#a6a7de9a1b999085" class="i field">consumerGroupName</a> = <span class="r6 r">eventHubConsumerGroup</span>;
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a> = <span class="r7 r">options</span> ?? <b>new</b> <a href="EventProcessorOptions.cs.html#e0540df14db5eeaf" class="t constructor">EventProcessorOptions</a>();
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b2d12271d6f6d26c" class="i field">checkpointManager</a> = <span class="r8 r">checkpointManager</span> ?? <b>new</b> <a href="ReliableDictionaryCheckpointMananger.cs.html#00f7b7d0f0e39fd9" class="t constructor">ReliableDictionaryCheckpointMananger</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#07665dfa79598741" class="i field">serviceStateManager</a>);
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e5879beff7f3c6f0" class="i property">EventHubClientFactory</a> = <b>new</b> <a href="EventHubWrappers.cs.html#2e0454f5c1ce0b4a" class="t t">EventHubWrappers</a>.<span class="t">EventHubClientFactory</span>();
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#08f857bf2b9eb9b5" class="i property">TestMode</a> = <b>false</b>;
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#03645bd1e986acf7" class="i property">MockMode</a> = <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> For testing purposes. Do not change after calling RunAsync.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="EventHubWrappers.cs.html#2e0454f5c1ce0b4a" class="t t">EventHubWrappers</a>.<a href="EventHubWrappers.cs.html#b5f7fbda947a9219" class="t t">IEventHubClientFactory</a> <a id="e5879beff7f3c6f0" href="R/e5879beff7f3c6f0.html" target="n" data-glyph="102,1" class="i property">EventHubClientFactory</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> For testing purposes. Do not change after calling RunAsync.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="08f857bf2b9eb9b5" href="R/08f857bf2b9eb9b5.html" target="n" data-glyph="102,1" class="i property">TestMode</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> For testing purposes. Do not change after calling RunAsync.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="IFabricPartitionLister.cs.html#7476ab5a071bd9ab" class="t t">IFabricPartitionLister</a> <a id="03645bd1e986acf7" href="R/03645bd1e986acf7.html" target="n" data-glyph="102,1" class="i property">MockMode</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Starts processing of events.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">fabricCancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Cancellation token provided by Service Fabric, assumed to indicate instance shutdown when cancelled.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Task that completes when event processing shuts down.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public async</b> <span class="i">Task</span> <a id="05bd82b03a1e5184" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">RunAsync</a>(<span class="i">CancellationToken</span> <span id="r9 rd" class="r9 r">fabricCancellationToken</span>)
        {
            <b>if</b> (<span class="i">Interlocked</span>.<span class="i">Exchange</span>(<b>ref</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#8422e818b68783a1" class="i field">running</a>, 1) == 1)
            {
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Already running&quot;</span>);
                <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<span class="s">&quot;EventProcessorService.RunAsync has already been called.&quot;</span>);
            }
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e0d5438e23fd1a18" class="i field">internalCanceller</a> = <b>new</b> <span class="i">CancellationTokenSource</span>();
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#922cefca92695b8d" class="i field">internalFatalException</a> = <b>null</b>;
 
            <b>try</b>
            {
                <b>using</b> (<span class="i">CancellationTokenSource</span> <span id="r10 rd" class="r10 r">linkedCanceller</span> = <span class="i">CancellationTokenSource</span>.<span class="i">CreateLinkedTokenSource</span>(<span class="r9 r">fabricCancellationToken</span>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e0d5438e23fd1a18" class="i field">internalCanceller</a>.<span class="i">Token</span>))
                {
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a> = <span class="r10 r">linkedCanceller</span>.<span class="i">Token</span>;
                    
                    <b>await</b> <a href="#f714647a773a7cca" class="i method">InnerRunAsync</a>().<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#bcb0bdbb6482216e" class="i method">NotifyOnShutdown</a>(<b>null</b>);
                }
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r11 rd" class="r11 r">e</span>)
            {
                <span class="c">// If InnerRunAsync throws, that is intended to be a fatal exception for this instance.</span>
                <span class="c">// Catch it here just long enough to log and notify, then rethrow.</span>
 
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<span class="i">Message</span>(<span class="s">&quot;THROWING OUT: {0}&quot;</span>, <span class="r11 r">e</span>);
                <b>if</b> (<span class="r11 r">e</span>.<span class="i">InnerException</span> != <b>null</b>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<span class="i">Message</span>(<span class="s">&quot;THROWING OUT INNER: {0}&quot;</span>, <span class="r11 r">e</span>.<span class="i">InnerException</span>);
                }
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#bcb0bdbb6482216e" class="i method">NotifyOnShutdown</a>(<span class="r11 r">e</span>);
                <b>throw</b> <span class="r11 r">e</span>;
            }
        }
 
        <b>private async</b> <span class="i">Task</span> <a id="f714647a773a7cca" href="R/f714647a773a7cca.html" target="n" data-glyph="76,1" class="i method">InnerRunAsync</a>()
        {
            <a href="EventHubWrappers.cs.html#2e0454f5c1ce0b4a" class="t t">EventHubWrappers</a>.<a href="EventHubWrappers.cs.html#8d8b643cdc1ffa6f" class="t t">IEventHubClient</a> <span id="r12 rd" class="r12 r">ehclient</span> = <b>null</b>;
            <a href="EventHubWrappers.cs.html#2e0454f5c1ce0b4a" class="t t">EventHubWrappers</a>.<a href="EventHubWrappers.cs.html#b39dbb17ea3e02bb" class="t t">IPartitionReceiver</a> <span id="r13 rd" class="r13 r">receiver</span> = <b>null</b>;
            <b>bool</b> <span id="r14 rd" class="r14 r">processorOpened</span> = <b>false</b>;
 
            <b>try</b>
            {
                <span class="c">//</span>
                <span class="c">// Get Service Fabric partition information.</span>
                <span class="c">//</span>
                <b>await</b> <a href="#8e26e3876e431123" class="i method">GetServicePartitionId</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                <span class="c">//</span>
                <span class="c">// Create EventHubClient and check partition count.</span>
                <span class="c">//</span>
                <span class="i">Exception</span> <span id="r15 rd" class="r15 r">lastException</span> = <b>null</b>;
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Creating event hub client&quot;</span>);
                <span class="r15 r">lastException</span> = <span class="i">RetryWrapper</span>(() =&gt; { <span class="r12 r">ehclient</span> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e5879beff7f3c6f0" class="i property">EventHubClientFactory</a>.<a href="EventHubWrappers.cs.html#cf9da52f6381e952" class="i method">Create</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#100c54e66a3cc783" class="i field">ehConnectionString</a>.<span class="i">ToString</span>(), <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#7f85c4108794d3e5" class="i property">ReceiveTimeout</a>); });
                <b>if</b> (<span class="r12 r">ehclient</span> == <b>null</b>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Out of retries event hub client&quot;</span>);
                    <b>throw</b> <b>new</b> <span class="i">Exception</span>(<span class="s">&quot;Out of retries creating EventHubClient&quot;</span>, <span class="r15 r">lastException</span>);
                }
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Event hub client OK&quot;</span>);
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Getting event hub info&quot;</span>);
                <a href="/Microsoft.Azure.EventHubs/A.html#46003615b8a69ab0" class="t t">EventHubRuntimeInformation</a> <span id="r16 rd" class="r16 r">ehInfo</span> = <b>null</b>;
                <span class="c">// Lambda MUST be synchronous to work with RetryWrapper!</span>
                <span class="r15 r">lastException</span> = <span class="i">RetryWrapper</span>(() =&gt; { <span class="r16 r">ehInfo</span> = <span class="r12 r">ehclient</span>.<a href="EventHubWrappers.cs.html#52f25c1330bc4aef" class="i method">GetRuntimeInformationAsync</a>().<span class="i">Result</span>; });
                <b>if</b> (<span class="r16 r">ehInfo</span> == <b>null</b>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Out of retries getting event hub info&quot;</span>);
                    <b>throw</b> <b>new</b> <span class="i">Exception</span>(<span class="s">&quot;Out of retries getting event hub runtime info&quot;</span>, <span class="r15 r">lastException</span>);
                }
                <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#08f857bf2b9eb9b5" class="i property">TestMode</a>)
                {
                    <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a> &gt; <span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#df527c1931264461" class="i property">PartitionCount</a>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;TestMode requires event hub partition count larger than service partitinon count&quot;</span>);
                        <b>throw</b> <b>new</b> <a href="EventProcessorConfigurationException.cs.html#3f42782dff39b1dc" class="t constructor">EventProcessorConfigurationException</a>(<span class="s">&quot;TestMode requires event hub partition count larger than service partitinon count&quot;</span>);
                    }
                    <b>else</b> <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a> &lt; <span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#df527c1931264461" class="i property">PartitionCount</a>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;TestMode: receiving from subset of event hub&quot;</span>);
                    }
                }
                <b>else</b> <b>if</b> (<span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#df527c1931264461" class="i property">PartitionCount</a> != <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Service partition count </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a>}<span class="s"> does not match event hub partition count </span>{<span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#df527c1931264461" class="i property">PartitionCount</a>}<span class="s">&quot;</span>);
                    <b>throw</b> <b>new</b> <a href="EventProcessorConfigurationException.cs.html#3f42782dff39b1dc" class="t constructor">EventProcessorConfigurationException</a>(<span class="s">$&quot;</span><span class="s">Service partition count </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a>}<span class="s"> does not match event hub partition count </span>{<span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#df527c1931264461" class="i property">PartitionCount</a>}<span class="s">&quot;</span>);
                }
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a> = <span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#6f7d55289e44ee46" class="i property">PartitionIds</a>[<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#f84a7c255ba17e97" class="i field">fabricPartitionOrdinal</a>];
 
                <span class="c">//</span>
                <span class="c">// Generate a PartitionContext now that the required info is available.</span>
                <span class="c">//</span>
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a> = <b>new</b> <a href="PartitionContext.cs.html#6ba69c3709a450ce" class="t constructor">PartitionContext</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#100c54e66a3cc783" class="i field">ehConnectionString</a>.<a href="/Microsoft.Azure.EventHubs/A.html#07eaa0ed4c59a2a0" class="i property">EntityPath</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#a6a7de9a1b999085" class="i field">consumerGroupName</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b2d12271d6f6d26c" class="i field">checkpointManager</a>);
 
                <span class="c">//</span>
                <span class="c">// Start up checkpoint manager and get checkpoint, if any.</span>
                <span class="c">//</span>
                <b>await</b> <a href="#8c313a8662a5b7c0" class="i method">CheckpointStartup</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                <span class="c">//</span>
                <span class="c">// If there was a checkpoint, the offset is in this.initialOffset, so convert it to an EventPosition.</span>
                <span class="c">// If no checkpoint, get starting point from user-supplied provider.</span>
                <span class="c">//</span>
                <a href="/Microsoft.Azure.EventHubs/A.html#5c55f1ce5bfdf68d" class="t t">EventPosition</a> <span id="r17 rd" class="r17 r">initialPosition</span> = <b>null</b>;
                <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a> != <b>null</b>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Initial position from checkpoint, offset </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a>}<span class="s">&quot;</span>);
                    <span class="r17 r">initialPosition</span> = <a href="/Microsoft.Azure.EventHubs/A.html#5c55f1ce5bfdf68d" class="t t">EventPosition</a>.<span class="i">FromOffset</span>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a>);
                }
                <b>else</b>
                {
                    <span class="r17 r">initialPosition</span> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<span class="i">InitialPositionProvider</span>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>);
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Initial position from provider&quot;</span>);
                }
 
                <span class="c">//</span>
                <span class="c">// Create receiver.</span>
                <span class="c">//</span>
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Creating receiver&quot;</span>);
                <span class="r15 r">lastException</span> = <span class="i">RetryWrapper</span>(() =&gt; { <span class="r13 r">receiver</span> = <span class="r12 r">ehclient</span>.<a href="EventHubWrappers.cs.html#94544f9a8dae736a" class="i method">CreateEpochReceiver</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#a6a7de9a1b999085" class="i field">consumerGroupName</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>, <span class="r17 r">initialPosition</span>,
                    <a href="Constants.cs.html#b615ac250a0079ff" class="t t">Constants</a>.<a href="Constants.cs.html#66b616037746f932" class="i field">FixedReceiverEpoch</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#84e5faec0c48ce4f" class="i property">ClientReceiverOptions</a>); });
                <b>if</b> (<span class="r13 r">receiver</span> == <b>null</b>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Out of retries creating receiver&quot;</span>);
                    <b>throw</b> <b>new</b> <span class="i">Exception</span>(<span class="s">&quot;Out of retries creating event hub receiver&quot;</span>, <span class="r15 r">lastException</span>);
                }
                <span class="r13 r">receiver</span>.<a href="EventHubWrappers.cs.html#2a18971c07151001" class="i property">PrefetchCount</a> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#c7c24cb3948ddf67" class="i property">PrefetchCount</a>;
 
                <span class="c">//</span>
                <span class="c">// Call Open on user&#39;s event processor instance.</span>
                <span class="c">// If user&#39;s Open code fails, treat that as a fatal exception and let it throw out.</span>
                <span class="c">//</span>
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Creating event processor&quot;</span>);
                <b>await</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a>.<a href="IEventProcessor.cs.html#f7c181e0ac848042" class="i method">OpenAsync</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                <span class="r14 r">processorOpened</span> = <b>true</b>;
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Event processor created and opened OK&quot;</span>);
 
                <span class="c">//</span>
                <span class="c">// Start metrics reporting. This runs as a separate background thread.</span>
                <span class="c">//</span>
                <span class="i">Thread</span> <span id="r18 rd" class="r18 r">t</span> = <b>new</b> <span class="i">Thread</span>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<span class="i">MetricsHandler</span>);
                <span class="r18 r">t</span>.<span class="i">Start</span>();
 
                <span class="c">//</span>
                <span class="c">// Receive pump.</span>
                <span class="c">//</span>
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;RunAsync setting handler and waiting&quot;</span>);
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#1d0fd599af6ebd4c" class="i property">MaxBatchSize</a> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#4458ab71cae449a4" class="i property">MaxBatchSize</a>;
                <span class="r13 r">receiver</span>.<a href="EventHubWrappers.cs.html#14f485589de1a8dc" class="i method">SetReceiveHandler</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#9ec549ff063eba68" class="i property">InvokeProcessorAfterReceiveTimeout</a>);
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>.<span class="i">WaitHandle</span>.<span class="i">WaitOne</span>();
 
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;RunAsync continuing, cleanup&quot;</span>);
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r14 r">processorOpened</span>)
                {
                    <b>try</b>
                    {
                        <b>await</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a>.<a href="IEventProcessor.cs.html#41990decd5218ff1" class="i method">CloseAsync</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>.<span class="i">IsCancellationRequested</span> ? <a href="CloseReason.cs.html#214d5ae440ddfe86" class="t t">CloseReason</a>.<a href="CloseReason.cs.html#a5314b945db249d2" class="i field">Cancelled</a> : <a href="CloseReason.cs.html#214d5ae440ddfe86" class="t t">CloseReason</a>.<a href="CloseReason.cs.html#3c52ebc6d43e1b83" class="i field">Failure</a>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r19 rd" class="r19 r">e</span>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">IEventProcessor.CloseAsync threw </span>{<span class="r19 r">e</span>}<span class="s">, continuing cleanup</span><span class="s">&quot;</span>);
                    }
                }
                <b>if</b> (<span class="r13 r">receiver</span> != <b>null</b>)
                {
                    <b>try</b>
                    {
                        <span class="r13 r">receiver</span>.<a href="EventHubWrappers.cs.html#14f485589de1a8dc" class="i method">SetReceiveHandler</a>(<b>null</b>);
                        <b>await</b> <span class="r13 r">receiver</span>.<a href="EventHubWrappers.cs.html#d51cdb402b2c50c7" class="i method">CloseAsync</a>().<span class="i">ConfigureAwait</span>(<b>false</b>);
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r20 rd" class="r20 r">e</span>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Receiver close threw </span>{<span class="r20 r">e</span>}<span class="s">, continuing cleanup</span><span class="s">&quot;</span>);
                    }
                }
                <b>if</b> (<span class="r12 r">ehclient</span> != <b>null</b>)
                {
                    <b>try</b>
                    {
                        <b>await</b> <span class="r12 r">ehclient</span>.<a href="EventHubWrappers.cs.html#89ea2e584a2cbdf3" class="i method">CloseAsync</a>().<span class="i">ConfigureAwait</span>(<b>false</b>);
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r21 rd" class="r21 r">e</span>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">EventHubClient close threw </span>{<span class="r21 r">e</span>}<span class="s">, continuing cleanup</span><span class="s">&quot;</span>);
                    }
                }
                <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#922cefca92695b8d" class="i field">internalFatalException</a> != <b>null</b>)
                {
                    <b>throw</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#922cefca92695b8d" class="i field">internalFatalException</a>;
                }
            }
        }
 
        <b>private</b> <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a> <a id="1a2886b022ac3895" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">RetryWrapper</a>(<span class="i">Action</span> <span id="r22 rd" class="r22 r">action</span>)
        {
            <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a> <span id="r23 rd" class="r23 r">lastException</span> = <b>null</b>;
 
            <b>for</b> (<b>int</b> <span id="r24 rd" class="r24 r">i</span> = 0; <span class="r24 r">i</span> &lt; <a href="Constants.cs.html#b615ac250a0079ff" class="t t">Constants</a>.<a href="Constants.cs.html#69ba3ab8dc42ad32" class="i field">RetryCount</a>; <span class="r24 r">i</span>++)
            {
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>.<span class="i">ThrowIfCancellationRequested</span>();
                <b>try</b>
                {
                    <span class="r22 r">action</span>.<span class="i">Invoke</span>();
                    <b>break</b>;
                }
                <b>catch</b> (<a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a> <span id="r25 rd" class="r25 r">e</span>)
                {
                    <b>if</b> (!<span class="r25 r">e</span>.<a href="/Microsoft.Azure.EventHubs/A.html#82f11a700820e554" class="i property">IsTransient</a>)
                    {
                        <b>throw</b> <span class="r25 r">e</span>;
                    }
                    <span class="r23 r">lastException</span> = <span class="r25 r">e</span>;
                }
                <b>catch</b> (<span class="i">AggregateException</span> <span id="r26 rd" class="r26 r">ae</span>)
                {
                    <b>if</b> (<span class="r26 r">ae</span>.<span class="i">InnerException</span> <b>is</b> <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a>)
                    {
                        <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a> <span id="r27 rd" class="r27 r">ehe</span> = (<a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a>)<span class="r26 r">ae</span>.<span class="i">InnerException</span>;
                        <b>if</b> (!<span class="r27 r">ehe</span>.<a href="/Microsoft.Azure.EventHubs/A.html#82f11a700820e554" class="i property">IsTransient</a>)
                        {
                            <b>throw</b> <span class="r27 r">ehe</span>;
                        }
                        <span class="r23 r">lastException</span> = <span class="r27 r">ehe</span>;
                    }
                    <b>else</b>
                    {
                        <b>throw</b> <span class="r26 r">ae</span>;
                    }
                }
            }
 
            <b>return</b> <span class="r23 r">lastException</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> From IPartitionReceiveHandler</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public int</b> <a id="1d0fd599af6ebd4c" href="R/1d0fd599af6ebd4c.html" target="n" data-glyph="102,1" class="i property">MaxBatchSize</a> { <b>get</b>; <b>set</b>; }
 
        <b>async</b> <span class="i">Task</span> <a href="/Microsoft.Azure.EventHubs/A.html#4376c1c4658c32ac" class="t t">IPartitionReceiveHandler</a>.<a id="ee6372bb0fe7800c" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ProcessEventsAsync</a>(<span class="i">IEnumerable</span>&lt;<a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a>&gt; <span id="r28 rd" class="r28 r">events</span>)
        {
            <span class="i">IEnumerable</span>&lt;<a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a>&gt; <span id="r29 rd" class="r29 r">effectiveEvents</span> = <span class="r28 r">events</span> ?? <b>new</b> <span class="i">List</span>&lt;<a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a>&gt;(); <span class="c">// convert to empty list if events is null</span>
 
            <b>if</b> (<span class="r28 r">events</span> != <b>null</b>)
            {
                <span class="c">// Save position of last event if we got a real list of events</span>
                <span class="i">IEnumerator</span>&lt;<a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a>&gt; <span id="r30 rd" class="r30 r">scanner</span> = <span class="r29 r">effectiveEvents</span>.<span class="i">GetEnumerator</span>();
                <a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a> <span id="r31 rd" class="r31 r">last</span> = <b>null</b>;
                <b>while</b> (<span class="r30 r">scanner</span>.<span class="i">MoveNext</span>())
                {
                    <span class="r31 r">last</span> = <span class="r30 r">scanner</span>.<span class="i">Current</span>;
                }
                <b>if</b> (<span class="r31 r">last</span> != <b>null</b>)
                {
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>.<a href="PartitionContext.cs.html#d5a8ce76bcc14e5b" class="i method">SetOffsetAndSequenceNumber</a>(<span class="r31 r">last</span>);
                    <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#feaa575b2ffb6e09" class="i property">EnableReceiverRuntimeMetric</a>)
                    {
                        <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>.<a href="PartitionContext.cs.html#7f0473a8a8ebf80b" class="i property">RuntimeInformation</a>.<span class="i">Update</span>(<span class="r31 r">last</span>);
                    }
                }
            }
 
            <b>try</b>
            {
                <b>await</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a>.<a href="IEventProcessor.cs.html#e7fa497ca119d749" class="i method">ProcessEventsAsync</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>, <span class="r29 r">effectiveEvents</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r32 rd" class="r32 r">e</span>)
            {
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Processing exception on </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>}<span class="s">: </span>{<span class="r32 r">e</span>}<span class="s">&quot;</span>);
                <a href="#5a21901626f81ccf" class="i method">SafeProcessError</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>, <span class="r32 r">e</span>);
            }
 
            <b>foreach</b> (<a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a> <span id="r33 rd" class="r33 r">ev</span> <b>in</b> <span class="r29 r">effectiveEvents</span>)
            {
                <span class="r33 r">ev</span>.<span class="i">Dispose</span>();
            }
        }
 
        <span class="i">Task</span> <a href="/Microsoft.Azure.EventHubs/A.html#4376c1c4658c32ac" class="t t">IPartitionReceiveHandler</a>.<a id="1bed3c6602818ce8" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ProcessErrorAsync</a>(<span class="i">Exception</span> <span id="r34 rd" class="r34 r">error</span>)
        {
            <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">RECEIVE EXCEPTION on </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>}<span class="s">: </span>{<span class="r34 r">error</span>}<span class="s">&quot;</span>);
            <a href="#5a21901626f81ccf" class="i method">SafeProcessError</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>, <span class="r34 r">error</span>);
            <b>if</b> (<span class="r34 r">error</span> <b>is</b> <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a>)
            {
                <b>if</b> (!(<span class="r34 r">error</span> <b>as</b> <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a>).<a href="/Microsoft.Azure.EventHubs/A.html#82f11a700820e554" class="i property">IsTransient</a>)
                {
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#922cefca92695b8d" class="i field">internalFatalException</a> = <span class="r34 r">error</span>;
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e0d5438e23fd1a18" class="i field">internalCanceller</a>.<span class="i">Cancel</span>();
                }
                <span class="c">// else don&#39;t cancel on transient errors</span>
            }
            <b>else</b>
            {
                <span class="c">// All other exceptions are assumed fatal.</span>
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#922cefca92695b8d" class="i field">internalFatalException</a> = <span class="r34 r">error</span>;
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e0d5438e23fd1a18" class="i field">internalCanceller</a>.<span class="i">Cancel</span>();
            }
            <b>return</b> <span class="i">Task</span>.<span class="i">CompletedTask</span>;
        }
 
        <b>private void</b> <a id="5a21901626f81ccf" href="R/5a21901626f81ccf.html" target="n" data-glyph="76,1" class="i method">SafeProcessError</a>(<a href="PartitionContext.cs.html#1a49dc0b2da9fcb8" class="t t">PartitionContext</a> <span id="r35 rd" class="r35 r">context</span>, <span class="i">Exception</span> <span id="r36 rd" class="r36 r">error</span>)
        {
            <b>try</b>
            {
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a>.<a href="IEventProcessor.cs.html#d8130ba6a4c81263" class="i method">ProcessErrorAsync</a>(<span class="r35 r">context</span>, <span class="r36 r">error</span>).<span class="i">Wait</span>();
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r37 rd" class="r37 r">e</span>)
            {
                <span class="c">// The user&#39;s error notification method has thrown.</span>
                <span class="c">// Recursively notifying could easily cause an infinite loop, until the stack runs out.</span>
                <span class="c">// So do not notify, just log.</span>
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Error thrown by ProcessErrorASync: </span>{<span class="r37 r">e</span>}<span class="s">&quot;</span>);
            }
        }
 
        <b>private async</b> <span class="i">Task</span> <a id="8c313a8662a5b7c0" href="R/8c313a8662a5b7c0.html" target="n" data-glyph="76,1" class="i method">CheckpointStartup</a>(<span class="i">CancellationToken</span> <span id="r38 rd" class="r38 r">cancellationToken</span>)
        {
            <span class="c">// Set up store and get checkpoint, if any.</span>
            <b>await</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b2d12271d6f6d26c" class="i field">checkpointManager</a>.<a href="ICheckpointMananger.cs.html#33224550e84d2cc5" class="i method">CreateCheckpointStoreIfNotExistsAsync</a>(<span class="r38 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
            <a href="Checkpoint.cs.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a> <span id="r39 rd" class="r39 r">checkpoint</span> = <b>await</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b2d12271d6f6d26c" class="i field">checkpointManager</a>.<a href="ICheckpointMananger.cs.html#6916074a49128f05" class="i method">CreateCheckpointIfNotExistsAsync</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>, <span class="r38 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
            <b>if</b> (!<span class="r39 r">checkpoint</span>.<a href="Checkpoint.cs.html#7d4a9395607e78d5" class="i property">Valid</a>)
            {
                <span class="c">// Not actually any existing checkpoint.</span>
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a> = <b>null</b>;
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;No checkpoint&quot;</span>);
            }
            <b>else</b> <b>if</b> (<span class="r39 r">checkpoint</span>.<a href="Checkpoint.cs.html#8eb0d03518da5da0" class="i property">Version</a> == 1)
            {
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a> = <span class="r39 r">checkpoint</span>.<a href="Checkpoint.cs.html#bff53215c46b4889" class="i property">Offset</a>;
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Checkpoint provides initial offset </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a>}<span class="s">&quot;</span>);
            }
            <b>else</b>
            {
                <span class="c">// It&#39;s actually a later-version checkpoint but we don&#39;t know the details.</span>
                <span class="c">// Access it via the V1 interface and hope it does something sensible.</span>
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a> = <span class="r39 r">checkpoint</span>.<a href="Checkpoint.cs.html#bff53215c46b4889" class="i property">Offset</a>;
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Unexpected checkpoint version </span>{<span class="r39 r">checkpoint</span>.<a href="Checkpoint.cs.html#8eb0d03518da5da0" class="i property">Version</a>}<span class="s">, provided initial offset </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a>}<span class="s">&quot;</span>);
            }
        }
 
        <b>private async</b> <span class="i">Task</span> <a id="8e26e3876e431123" href="R/8e26e3876e431123.html" target="n" data-glyph="76,1" class="i method">GetServicePartitionId</a>(<span class="i">CancellationToken</span> <span id="r40 rd" class="r40 r">cancellationToken</span>)
        {
            <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#f84a7c255ba17e97" class="i field">fabricPartitionOrdinal</a> == -1)
            {
                <a href="IFabricPartitionLister.cs.html#7476ab5a071bd9ab" class="t t">IFabricPartitionLister</a> <span id="r41 rd" class="r41 r">lister</span> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#03645bd1e986acf7" class="i property">MockMode</a> ?? <b>new</b> <span class="t">ServiceFabricPartitionLister</span>();
 
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a> = <b>await</b> <span class="r41 r">lister</span>.<a href="IFabricPartitionLister.cs.html#1923c259022a1aad" class="i method">GetServiceFabricPartitionCount</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#9bcd7a087fb5cbf9" class="i field">serviceFabricServiceName</a>).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#f84a7c255ba17e97" class="i field">fabricPartitionOrdinal</a> = <b>await</b> <span class="r41 r">lister</span>.<a href="IFabricPartitionLister.cs.html#bab872da027e4e5b" class="i method">GetServiceFabricPartitionOrdinal</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#43eadaa6b36a0529" class="i field">serviceFabricPartitionId</a>).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Total partitions </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a>}<span class="s">&quot;</span>);
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Partition ordinal </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#f84a7c255ba17e97" class="i field">fabricPartitionOrdinal</a>}<span class="s">&quot;</span>);
                <span class="c">// TODO check that ordinal is not -1</span>
            }
        }
 
        <b>private void</b> <a id="7a8e6fcd52d91c00" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">MetricsHandler</a>()
        {
            <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;METRIC reporter starting&quot;</span>);
 
            <b>while</b> (!<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>.<span class="i">IsCancellationRequested</span>)
            {
                <span class="i">Dictionary</span>&lt;<b>string</b>, <b>int</b>&gt; <span id="r42 rd" class="r42 r">userMetrics</span> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a>.<a href="IEventProcessor.cs.html#2fed9fbca72dbfce" class="i method">GetLoadMetric</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>);
 
                <b>try</b>
                {
                    <span class="i">List</span>&lt;<span class="i">LoadMetric</span>&gt; <span id="r43 rd" class="r43 r">reportableMetrics</span> = <b>new</b> <span class="i">List</span>&lt;<span class="i">LoadMetric</span>&gt;();
                    <b>foreach</b> (<span class="i">KeyValuePair</span>&lt;<b>string</b>, <b>int</b>&gt; <span id="r44 rd" class="r44 r">metric</span> <b>in</b> <span class="r42 r">userMetrics</span>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">METRIC </span>{<span class="r44 r">metric</span>.<span class="i">Key</span>}<span class="s"> for partition </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>.<a href="PartitionContext.cs.html#103246bc5457d1b2" class="i property">PartitionId</a>}<span class="s"> is </span>{<span class="r44 r">metric</span>.<span class="i">Value</span>}<span class="s">&quot;</span>);
                        <span class="r43 r">reportableMetrics</span>.<span class="i">Add</span>(<b>new</b> <span class="i">LoadMetric</span>(<span class="r44 r">metric</span>.<span class="i">Key</span>, <span class="r44 r">metric</span>.<span class="i">Value</span>));
                    }
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b5b66e4a72aea36c" class="i field">servicePartition</a>.<span class="i">ReportLoad</span>(<span class="r43 r">reportableMetrics</span>);
                    <span class="i">Task</span>.<span class="i">Delay</span>(<a href="Constants.cs.html#b615ac250a0079ff" class="t t">Constants</a>.<a href="Constants.cs.html#d3c876e72882a358" class="i field">MetricReportingInterval</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>).<span class="i">Wait</span>(); <span class="c">// throws on cancel</span>
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r45 rd" class="r45 r">e</span>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">METRIC partition </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>.<a href="PartitionContext.cs.html#103246bc5457d1b2" class="i property">PartitionId</a>}<span class="s"> exception </span>{<span class="r45 r">e</span>}<span class="s">&quot;</span>);
                }
            }
 
            <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;METRIC reporter exiting&quot;</span>);
        }
    }
}
</pre></td></tr></table></div></body></html>
