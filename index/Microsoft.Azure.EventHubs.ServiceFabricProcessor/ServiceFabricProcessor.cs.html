<!DOCTYPE html>
<html><head><title>ServiceFabricProcessor.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(522);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.EventHubs.ServiceFabricProcessor/ServiceFabricProcessor.cs" target="_top">ServiceFabricProcessor.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/eventhub/Microsoft.Azure.EventHubs.ServiceFabricProcessor/src/ServiceFabricProcessor.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.EventHubs.ServiceFabricProcessor" target="_top">Microsoft.Azure.EventHubs.ServiceFabricProcessor.csproj</a> (Microsoft.Azure.EventHubs.ServiceFabricProcessor)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft. All rights reserved.</span>
<span class="c">// Licensed under the MIT license. See LICENSE file in the project root for full license information.using System;</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<span class="i n">ServiceFabricProcessor</span>
{
    <b>using</b> <span class="i n">System</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Fabric</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Fabric</span>.<span class="i n">Description</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Fabric</span>.<span class="i n">Query</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">ServiceFabric</span>.<span class="i n">Data</span>;
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Base class that implements event processor functionality.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="a32fbfa5c91e3b37" href="R/a32fbfa5c91e3b37.html" target="n" data-glyph="0,0" class="t t">ServiceFabricProcessor</a> : <a href="/Microsoft.Azure.EventHubs/A.html#4376c1c4658c32ac" class="t t">IPartitionReceiveHandler</a>
    {
        <span class="c">// Service Fabric objects initialized in constructor</span>
        <b>private readonly</b> <span class="t t">IReliableStateManager</span> <a id="07665dfa79598741" href="R/07665dfa79598741.html" target="n" data-glyph="46,1" class="i field">serviceStateManager</a>;
        <b>private readonly</b> <a href="@1@netstandard/A.html#991565dd25f47c90" class="t t">Uri</a> <a id="9bcd7a087fb5cbf9" href="R/9bcd7a087fb5cbf9.html" target="n" data-glyph="46,1" class="i field">serviceFabricServiceName</a>;
        <b>private readonly</b> <a href="@1@netstandard/A.html#b622ef5f6b76c10a" class="t t">Guid</a> <a id="43eadaa6b36a0529" href="R/43eadaa6b36a0529.html" target="n" data-glyph="46,1" class="i field">serviceFabricPartitionId</a>;
        <b>private readonly</b> <span class="t t">IStatefulServicePartition</span> <a id="b5b66e4a72aea36c" href="R/b5b66e4a72aea36c.html" target="n" data-glyph="46,1" class="i field">servicePartition</a>;
 
        <span class="c">// ServiceFabricProcessor settings initialized in constructor</span>
        <b>private readonly</b> <a href="IEventProcessor.cs.html#e56915915feb4fed" class="t t">IEventProcessor</a> <a id="61b4a9cdd12049f3" href="R/61b4a9cdd12049f3.html" target="n" data-glyph="46,1" class="i field">userEventProcessor</a>;
        <b>private readonly</b> <a href="EventProcessorOptions.cs.html#99ecb9feab823adf" class="t t">EventProcessorOptions</a> <a id="7015a1cfd021c855" href="R/7015a1cfd021c855.html" target="n" data-glyph="46,1" class="i field">options</a>;
        <b>private readonly</b> <a href="ICheckpointMananger.cs.html#569f46826265f34a" class="t t">ICheckpointMananger</a> <a id="b2d12271d6f6d26c" href="R/b2d12271d6f6d26c.html" target="n" data-glyph="46,1" class="i field">checkpointManager</a>;
 
        <span class="c">// Initialized during RunAsync startup</span>
        <b>private int</b> <a id="f84a7c255ba17e97" href="R/f84a7c255ba17e97.html" target="n" data-glyph="46,1" class="i field">fabricPartitionOrdinal</a> = -1;
        <b>private int</b> <a id="2e28508f7890b59b" href="R/2e28508f7890b59b.html" target="n" data-glyph="46,1" class="i field">servicePartitionCount</a> = -1;
        <b>private string</b> <a id="936ea959803bdd2e" href="R/936ea959803bdd2e.html" target="n" data-glyph="46,1" class="i field">hubPartitionId</a>;
        <b>private</b> <a href="PartitionContext.cs.html#1a49dc0b2da9fcb8" class="t t">PartitionContext</a> <a id="09cfc83cf153d52e" href="R/09cfc83cf153d52e.html" target="n" data-glyph="46,1" class="i field">partitionContext</a>;
        <b>private string</b> <a id="d9dc760d9ada39f4" href="R/d9dc760d9ada39f4.html" target="n" data-glyph="46,1" class="i field">initialOffset</a>;
        <b>private</b> <a href="@1@netstandard/A.html#130a9536ac96b392" class="t t">CancellationTokenSource</a> <a id="e0d5438e23fd1a18" href="R/e0d5438e23fd1a18.html" target="n" data-glyph="46,1" class="i field">internalCanceller</a>;
        <b>private</b> <a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <a id="922cefca92695b8d" href="R/922cefca92695b8d.html" target="n" data-glyph="46,1" class="i field">internalFatalException</a>;
        <b>private</b> <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <a id="c8fb9728da7ca96a" href="R/c8fb9728da7ca96a.html" target="n" data-glyph="46,1" class="i field">linkedCancellationToken</a>;
        <b>private</b> <a href="/Microsoft.Azure.EventHubs/A.html#37541b805119d484" class="t t">EventHubsConnectionStringBuilder</a> <a id="100c54e66a3cc783" href="R/100c54e66a3cc783.html" target="n" data-glyph="46,1" class="i field">ehConnectionString</a>;
        <b>private string</b> <a id="a6a7de9a1b999085" href="R/a6a7de9a1b999085.html" target="n" data-glyph="46,1" class="i field">consumerGroupName</a>;
 
        <span class="c">// Value managed by RunAsync</span>
        <b>private int</b> <a id="8422e818b68783a1" href="R/8422e818b68783a1.html" target="n" data-glyph="46,1" class="i field">running</a> = 0;
 
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor. Arguments break down into three groups: (1) Service Fabric objects so this library can access</span>
        <span class="c">///</span><span class="c"> Service Fabric facilities, (2) Event Hub-related arguments which indicate what event hub to receive from and</span>
        <span class="c">///</span><span class="c"> how to process the events, and (3) advanced, which right now consists only of the ability to replace the default</span>
        <span class="c">///</span><span class="c"> reliable dictionary-based checkpoint manager with a user-provided implementation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">serviceFabricServiceName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Service Fabric Uri found in StatefulServiceContext</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">serviceFabricPartitionId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Service Fabric partition id found in StatefulServiceContext</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">stateManager</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Service Fabric-provided state manager, provides access to reliable dictionaries</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">partition</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Service Fabric-provided partition information</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">userEventProcessor</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">User&#39;s event processor implementation</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">eventHubConnectionString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Connection string for user&#39;s event hub</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">eventHubConsumerGroup</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Name of event hub consumer group to receive from</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Optional: Options structure for ServiceFabricProcessor library</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">checkpointManager</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Very advanced/optional: user-provided checkpoint manager implementation</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="ebd08711d7c3c556" href="R/ebd08711d7c3c556.html" target="n" data-glyph="72,1" class="t constructor">ServiceFabricProcessor</a>(<a href="@1@netstandard/A.html#991565dd25f47c90" class="t t">Uri</a> <span id="r0 rd" class="r0 r">serviceFabricServiceName</span>, <a href="@1@netstandard/A.html#b622ef5f6b76c10a" class="t t">Guid</a> <span id="r1 rd" class="r1 r">serviceFabricPartitionId</span>, <span class="t t">IReliableStateManager</span> <span id="r2 rd" class="r2 r">stateManager</span>, <span class="t t">IStatefulServicePartition</span> <span id="r3 rd" class="r3 r">partition</span>, <a href="IEventProcessor.cs.html#e56915915feb4fed" class="t t">IEventProcessor</a> <span id="r4 rd" class="r4 r">userEventProcessor</span>,
            <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r5 rd" class="r5 r">eventHubConnectionString</span>, <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r6 rd" class="r6 r">eventHubConsumerGroup</span>,
            <a href="EventProcessorOptions.cs.html#99ecb9feab823adf" class="t t">EventProcessorOptions</a> <span id="r7 rd" class="r7 r">options</span> = <b>null</b>, <a href="ICheckpointMananger.cs.html#569f46826265f34a" class="t t">ICheckpointMananger</a> <span id="r8 rd" class="r8 r">checkpointManager</span> = <b>null</b>)
        {
            <b>if</b> (<span class="r0 r">serviceFabricServiceName</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<span class="s">&quot;serviceFabricServiceName is null&quot;</span>);
            }
            <b>if</b> (<span class="r1 r">serviceFabricPartitionId</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<span class="s">&quot;serviceFabricPartitionId is null&quot;</span>);
            }
            <b>if</b> (<span class="r2 r">stateManager</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<span class="s">&quot;stateManager is null&quot;</span>);
            }
            <b>if</b> (<span class="r3 r">partition</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<span class="s">&quot;partition is null&quot;</span>);
            }
            <b>if</b> (<span class="r4 r">userEventProcessor</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<span class="s">&quot;userEventProcessor is null&quot;</span>);
            }
            <b>if</b> (<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r5 r">eventHubConnectionString</span>))
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#eb98012a74461437" class="t constructor">ArgumentException</a>(<span class="s">&quot;eventHubConnectionString is null or empty&quot;</span>);
            }
            <b>if</b> (<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r6 r">eventHubConsumerGroup</span>))
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#eb98012a74461437" class="t constructor">ArgumentException</a>(<span class="s">&quot;eventHubConsumerGroup is null or empty&quot;</span>);
            }
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#9bcd7a087fb5cbf9" class="i field">serviceFabricServiceName</a> = <span class="r0 r">serviceFabricServiceName</span>;
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#43eadaa6b36a0529" class="i field">serviceFabricPartitionId</a> = <span class="r1 r">serviceFabricPartitionId</span>;
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#07665dfa79598741" class="i field">serviceStateManager</a> = <span class="r2 r">stateManager</span>;
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b5b66e4a72aea36c" class="i field">servicePartition</a> = <span class="r3 r">partition</span>;
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a> = <span class="r4 r">userEventProcessor</span>;
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#100c54e66a3cc783" class="i field">ehConnectionString</a> = <b>new</b> <a href="/Microsoft.Azure.EventHubs/A.html#cf3f2e7ab687f745" class="t constructor">EventHubsConnectionStringBuilder</a>(<span class="r5 r">eventHubConnectionString</span>);
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#a6a7de9a1b999085" class="i field">consumerGroupName</a> = <span class="r6 r">eventHubConsumerGroup</span>;
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a> = <span class="r7 r">options</span> ?? <b>new</b> <a href="EventProcessorOptions.cs.html#e0540df14db5eeaf" class="t constructor">EventProcessorOptions</a>();
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b2d12271d6f6d26c" class="i field">checkpointManager</a> = <span class="r8 r">checkpointManager</span> ?? <b>new</b> <a href="ReliableDictionaryCheckpointMananger.cs.html#6d4dc737a5ab15a3" class="t constructor">ReliableDictionaryCheckpointMananger</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#07665dfa79598741" class="i field">serviceStateManager</a>);
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e5879beff7f3c6f0" class="i property">EventHubClientFactory</a> = <b>new</b> <a href="EventHubWrappers.cs.html#2e0454f5c1ce0b4a" class="t t">EventHubWrappers</a>.<a href="EventHubWrappers.cs.html#2fdcc0f12c717bfc" class="t constructor">EventHubClientFactory</a>();
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#08f857bf2b9eb9b5" class="i property">TestMode</a> = <b>false</b>;
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#03645bd1e986acf7" class="i property">MockMode</a> = <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> For testing purposes. Do not change after calling RunAsync.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="EventHubWrappers.cs.html#2e0454f5c1ce0b4a" class="t t">EventHubWrappers</a>.<a href="EventHubWrappers.cs.html#b5f7fbda947a9219" class="t t">IEventHubClientFactory</a> <a id="e5879beff7f3c6f0" href="R/e5879beff7f3c6f0.html" target="n" data-glyph="102,1" class="i property">EventHubClientFactory</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> For testing purposes. Do not change after calling RunAsync.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="08f857bf2b9eb9b5" href="R/08f857bf2b9eb9b5.html" target="n" data-glyph="102,1" class="i property">TestMode</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> For testing purposes. Do not change after calling RunAsync.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="IFabricPartitionLister.cs.html#7476ab5a071bd9ab" class="t t">IFabricPartitionLister</a> <a id="03645bd1e986acf7" href="R/03645bd1e986acf7.html" target="n" data-glyph="102,1" class="i property">MockMode</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Starts processing of events.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">fabricCancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Cancellation token provided by Service Fabric, assumed to indicate instance shutdown when cancelled.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Task that completes when event processing shuts down.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public async</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="410cb423071e870b" href="R/410cb423071e870b.html" target="n" data-glyph="72,1" class="i method">RunAsync</a>(<a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r9 rd" class="r9 r">fabricCancellationToken</span>)
        {
            <b>if</b> (<a href="@1@netstandard/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@1@netstandard/A.html#52be0cc9b3954ae9" class="i method">Exchange</a>(<b>ref</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#8422e818b68783a1" class="i field">running</a>, 1) == 1)
            {
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Already running&quot;</span>);
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">&quot;EventProcessorService.RunAsync has already been called.&quot;</span>);
            }
 
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e0d5438e23fd1a18" class="i field">internalCanceller</a> = <b>new</b> <a href="@1@netstandard/A.html#0fd973cb6741d972" class="t constructor">CancellationTokenSource</a>();
            <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#922cefca92695b8d" class="i field">internalFatalException</a> = <b>null</b>;
 
            <b>try</b>
            {
                <b>using</b> (<a href="@1@netstandard/A.html#130a9536ac96b392" class="t t">CancellationTokenSource</a> <span id="r10 rd" class="r10 r">linkedCanceller</span> = <a href="@1@netstandard/A.html#130a9536ac96b392" class="t t">CancellationTokenSource</a>.<a href="@1@netstandard/A.html#03f4ba87373778ca" class="i method">CreateLinkedTokenSource</a>(<span class="r9 r">fabricCancellationToken</span>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e0d5438e23fd1a18" class="i field">internalCanceller</a>.<a href="@1@netstandard/A.html#9e22b9c8995bf195" class="i property">Token</a>))
                {
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a> = <span class="r10 r">linkedCanceller</span>.<a href="@1@netstandard/A.html#9e22b9c8995bf195" class="i property">Token</a>;
                    
                    <b>await</b> <a href="#f714647a773a7cca" class="i method">InnerRunAsync</a>().<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#508afa14f9207750" class="i method">NotifyOnShutdown</a>(<b>null</b>);
                }
            }
            <b>catch</b> (<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r11 rd" class="r11 r">e</span>)
            {
                <span class="c">// If InnerRunAsync throws, that is intended to be a fatal exception for this instance.</span>
                <span class="c">// Catch it here just long enough to log and notify, then rethrow.</span>
 
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#bc2fe51ddeb890f9" class="i method">Message</a>(<span class="s">&quot;THROWING OUT: {0}&quot;</span>, <span class="r11 r">e</span>);
                <b>if</b> (<span class="r11 r">e</span>.<a href="@1@netstandard/A.html#89c20b39fb04108b" class="i property">InnerException</a> != <b>null</b>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#bc2fe51ddeb890f9" class="i method">Message</a>(<span class="s">&quot;THROWING OUT INNER: {0}&quot;</span>, <span class="r11 r">e</span>.<a href="@1@netstandard/A.html#89c20b39fb04108b" class="i property">InnerException</a>);
                }
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#508afa14f9207750" class="i method">NotifyOnShutdown</a>(<span class="r11 r">e</span>);
                <b>throw</b> <span class="r11 r">e</span>;
            }
        }
 
        <b>private async</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="f714647a773a7cca" href="R/f714647a773a7cca.html" target="n" data-glyph="76,1" class="i method">InnerRunAsync</a>()
        {
            <a href="EventHubWrappers.cs.html#2e0454f5c1ce0b4a" class="t t">EventHubWrappers</a>.<a href="EventHubWrappers.cs.html#8d8b643cdc1ffa6f" class="t t">IEventHubClient</a> <span id="r12 rd" class="r12 r">ehclient</span> = <b>null</b>;
            <a href="EventHubWrappers.cs.html#2e0454f5c1ce0b4a" class="t t">EventHubWrappers</a>.<a href="EventHubWrappers.cs.html#b39dbb17ea3e02bb" class="t t">IPartitionReceiver</a> <span id="r13 rd" class="r13 r">receiver</span> = <b>null</b>;
            <b>bool</b> <span id="r14 rd" class="r14 r">processorOpened</span> = <b>false</b>;
 
            <b>try</b>
            {
                <span class="c">//</span>
                <span class="c">// Get Service Fabric partition information.</span>
                <span class="c">//</span>
                <b>await</b> <a href="#ad1e27361f29db56" class="i method">GetServicePartitionId</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>).<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                <span class="c">//</span>
                <span class="c">// Create EventHubClient and check partition count.</span>
                <span class="c">//</span>
                <a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r15 rd" class="r15 r">lastException</span> = <b>null</b>;
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Creating event hub client&quot;</span>);
                <span class="r15 r">lastException</span> = <a href="#75f1534079053d91" class="i method">RetryWrapper</a>(() =&gt; { <span class="r12 r">ehclient</span> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e5879beff7f3c6f0" class="i property">EventHubClientFactory</a>.<a href="EventHubWrappers.cs.html#be8d30a2ea515795" class="i method">Create</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#100c54e66a3cc783" class="i field">ehConnectionString</a>.<a href="/Microsoft.Azure.EventHubs/A.html#23287d656a851420" class="i method">ToString</a>(), <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#7f85c4108794d3e5" class="i property">ReceiveTimeout</a>); });
                <b>if</b> (<span class="r12 r">ehclient</span> == <b>null</b>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Out of retries event hub client&quot;</span>);
                    <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#266f59a804f72937" class="t constructor">Exception</a>(<span class="s">&quot;Out of retries creating EventHubClient&quot;</span>, <span class="r15 r">lastException</span>);
                }
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Event hub client OK&quot;</span>);
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Getting event hub info&quot;</span>);
                <a href="/Microsoft.Azure.EventHubs/A.html#46003615b8a69ab0" class="t t">EventHubRuntimeInformation</a> <span id="r16 rd" class="r16 r">ehInfo</span> = <b>null</b>;
                <span class="c">// Lambda MUST be synchronous to work with RetryWrapper!</span>
                <span class="r15 r">lastException</span> = <a href="#75f1534079053d91" class="i method">RetryWrapper</a>(() =&gt; { <span class="r16 r">ehInfo</span> = <span class="r12 r">ehclient</span>.<a href="EventHubWrappers.cs.html#52f25c1330bc4aef" class="i method">GetRuntimeInformationAsync</a>().<a href="@1@netstandard/A.html#826690b09f24e719" class="i property">Result</a>; });
                <b>if</b> (<span class="r16 r">ehInfo</span> == <b>null</b>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Out of retries getting event hub info&quot;</span>);
                    <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#266f59a804f72937" class="t constructor">Exception</a>(<span class="s">&quot;Out of retries getting event hub runtime info&quot;</span>, <span class="r15 r">lastException</span>);
                }
                <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#08f857bf2b9eb9b5" class="i property">TestMode</a>)
                {
                    <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a> &gt; <span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#df527c1931264461" class="i property">PartitionCount</a>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;TestMode requires event hub partition count larger than service partitinon count&quot;</span>);
                        <b>throw</b> <b>new</b> <a href="EventProcessorConfigurationException.cs.html#3f42782dff39b1dc" class="t constructor">EventProcessorConfigurationException</a>(<span class="s">&quot;TestMode requires event hub partition count larger than service partitinon count&quot;</span>);
                    }
                    <b>else</b> <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a> &lt; <span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#df527c1931264461" class="i property">PartitionCount</a>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;TestMode: receiving from subset of event hub&quot;</span>);
                    }
                }
                <b>else</b> <b>if</b> (<span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#df527c1931264461" class="i property">PartitionCount</a> != <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Service partition count </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a>}<span class="s"> does not match event hub partition count </span>{<span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#df527c1931264461" class="i property">PartitionCount</a>}<span class="s">&quot;</span>);
                    <b>throw</b> <b>new</b> <a href="EventProcessorConfigurationException.cs.html#3f42782dff39b1dc" class="t constructor">EventProcessorConfigurationException</a>(<span class="s">$&quot;</span><span class="s">Service partition count </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a>}<span class="s"> does not match event hub partition count </span>{<span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#df527c1931264461" class="i property">PartitionCount</a>}<span class="s">&quot;</span>);
                }
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a> = <span class="r16 r">ehInfo</span>.<a href="/Microsoft.Azure.EventHubs/A.html#6f7d55289e44ee46" class="i property">PartitionIds</a>[<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#f84a7c255ba17e97" class="i field">fabricPartitionOrdinal</a>];
 
                <span class="c">//</span>
                <span class="c">// Generate a PartitionContext now that the required info is available.</span>
                <span class="c">//</span>
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a> = <b>new</b> <a href="PartitionContext.cs.html#57ee0ab13b746286" class="t constructor">PartitionContext</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#100c54e66a3cc783" class="i field">ehConnectionString</a>.<a href="/Microsoft.Azure.EventHubs/A.html#07eaa0ed4c59a2a0" class="i property">EntityPath</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#a6a7de9a1b999085" class="i field">consumerGroupName</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b2d12271d6f6d26c" class="i field">checkpointManager</a>);
 
                <span class="c">//</span>
                <span class="c">// Start up checkpoint manager and get checkpoint, if any.</span>
                <span class="c">//</span>
                <b>await</b> <a href="#499fd811f38b0b4e" class="i method">CheckpointStartup</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>).<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                <span class="c">//</span>
                <span class="c">// If there was a checkpoint, the offset is in this.initialOffset, so convert it to an EventPosition.</span>
                <span class="c">// If no checkpoint, get starting point from user-supplied provider.</span>
                <span class="c">//</span>
                <a href="/Microsoft.Azure.EventHubs/A.html#5c55f1ce5bfdf68d" class="t t">EventPosition</a> <span id="r17 rd" class="r17 r">initialPosition</span> = <b>null</b>;
                <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a> != <b>null</b>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Initial position from checkpoint, offset </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a>}<span class="s">&quot;</span>);
                    <span class="r17 r">initialPosition</span> = <a href="/Microsoft.Azure.EventHubs/A.html#5c55f1ce5bfdf68d" class="t t">EventPosition</a>.<a href="/Microsoft.Azure.EventHubs/A.html#f52acfaed963fa7b" class="i method">FromOffset</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a>);
                }
                <b>else</b>
                {
                    <span class="r17 r">initialPosition</span> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#78316b684b6c93c2" class="i property">InitialPositionProvider</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>);
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Initial position from provider&quot;</span>);
                }
 
                <span class="c">//</span>
                <span class="c">// Create receiver.</span>
                <span class="c">//</span>
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Creating receiver&quot;</span>);
                <span class="r15 r">lastException</span> = <a href="#75f1534079053d91" class="i method">RetryWrapper</a>(() =&gt; { <span class="r13 r">receiver</span> = <span class="r12 r">ehclient</span>.<a href="EventHubWrappers.cs.html#94544f9a8dae736a" class="i method">CreateEpochReceiver</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#a6a7de9a1b999085" class="i field">consumerGroupName</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>, <span class="r17 r">initialPosition</span>,
                    <a href="Constants.cs.html#b615ac250a0079ff" class="t t">Constants</a>.<a href="Constants.cs.html#66b616037746f932" class="i field">FixedReceiverEpoch</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#84e5faec0c48ce4f" class="i property">ClientReceiverOptions</a>); });
                <b>if</b> (<span class="r13 r">receiver</span> == <b>null</b>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Out of retries creating receiver&quot;</span>);
                    <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#266f59a804f72937" class="t constructor">Exception</a>(<span class="s">&quot;Out of retries creating event hub receiver&quot;</span>, <span class="r15 r">lastException</span>);
                }
                <span class="r13 r">receiver</span>.<a href="EventHubWrappers.cs.html#2a18971c07151001" class="i property">PrefetchCount</a> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#c7c24cb3948ddf67" class="i property">PrefetchCount</a>;
 
                <span class="c">//</span>
                <span class="c">// Call Open on user&#39;s event processor instance.</span>
                <span class="c">// If user&#39;s Open code fails, treat that as a fatal exception and let it throw out.</span>
                <span class="c">//</span>
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Creating event processor&quot;</span>);
                <b>await</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a>.<a href="IEventProcessor.cs.html#6242a967db78ee30" class="i method">OpenAsync</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>).<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                <span class="r14 r">processorOpened</span> = <b>true</b>;
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;Event processor created and opened OK&quot;</span>);
 
                <span class="c">//</span>
                <span class="c">// Start metrics reporting. This runs as a separate background thread.</span>
                <span class="c">//</span>
                <a href="@1@netstandard/A.html#3980e012bae82e96" class="t t">Thread</a> <span id="r18 rd" class="r18 r">t</span> = <b>new</b> <a href="@1@netstandard/A.html#76f340c84df6da8d" class="t constructor">Thread</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7a8e6fcd52d91c00" class="i method">MetricsHandler</a>);
                <span class="r18 r">t</span>.<a href="@1@netstandard/A.html#cd2144b8dd6f4373" class="i method">Start</a>();
 
                <span class="c">//</span>
                <span class="c">// Receive pump.</span>
                <span class="c">//</span>
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;RunAsync setting handler and waiting&quot;</span>);
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#1d0fd599af6ebd4c" class="i property">MaxBatchSize</a> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#4458ab71cae449a4" class="i property">MaxBatchSize</a>;
                <span class="r13 r">receiver</span>.<a href="EventHubWrappers.cs.html#14f485589de1a8dc" class="i method">SetReceiveHandler</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#9ec549ff063eba68" class="i property">InvokeProcessorAfterReceiveTimeout</a>);
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>.<a href="@1@netstandard/A.html#2d85116bf4acf347" class="i property">WaitHandle</a>.<a href="@1@netstandard/A.html#8f366147dd3f5f63" class="i method">WaitOne</a>();
 
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;RunAsync continuing, cleanup&quot;</span>);
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r14 r">processorOpened</span>)
                {
                    <b>try</b>
                    {
                        <b>await</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a>.<a href="IEventProcessor.cs.html#41990decd5218ff1" class="i method">CloseAsync</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>.<a href="@1@netstandard/A.html#f32abbe8e2f1f6c1" class="i property">IsCancellationRequested</a> ? <a href="CloseReason.cs.html#214d5ae440ddfe86" class="t t">CloseReason</a>.<a href="CloseReason.cs.html#a5314b945db249d2" class="i field">Cancelled</a> : <a href="CloseReason.cs.html#214d5ae440ddfe86" class="t t">CloseReason</a>.<a href="CloseReason.cs.html#3c52ebc6d43e1b83" class="i field">Failure</a>).<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                    }
                    <b>catch</b> (<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r19 rd" class="r19 r">e</span>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">IEventProcessor.CloseAsync threw </span>{<span class="r19 r">e</span>}<span class="s">, continuing cleanup</span><span class="s">&quot;</span>);
                    }
                }
                <b>if</b> (<span class="r13 r">receiver</span> != <b>null</b>)
                {
                    <b>try</b>
                    {
                        <span class="r13 r">receiver</span>.<a href="EventHubWrappers.cs.html#14f485589de1a8dc" class="i method">SetReceiveHandler</a>(<b>null</b>);
                        <b>await</b> <span class="r13 r">receiver</span>.<a href="EventHubWrappers.cs.html#d51cdb402b2c50c7" class="i method">CloseAsync</a>().<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                    }
                    <b>catch</b> (<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r20 rd" class="r20 r">e</span>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Receiver close threw </span>{<span class="r20 r">e</span>}<span class="s">, continuing cleanup</span><span class="s">&quot;</span>);
                    }
                }
                <b>if</b> (<span class="r12 r">ehclient</span> != <b>null</b>)
                {
                    <b>try</b>
                    {
                        <b>await</b> <span class="r12 r">ehclient</span>.<a href="EventHubWrappers.cs.html#89ea2e584a2cbdf3" class="i method">CloseAsync</a>().<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                    }
                    <b>catch</b> (<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r21 rd" class="r21 r">e</span>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">EventHubClient close threw </span>{<span class="r21 r">e</span>}<span class="s">, continuing cleanup</span><span class="s">&quot;</span>);
                    }
                }
                <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#922cefca92695b8d" class="i field">internalFatalException</a> != <b>null</b>)
                {
                    <b>throw</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#922cefca92695b8d" class="i field">internalFatalException</a>;
                }
            }
        }
 
        <b>private</b> <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a> <a id="75f1534079053d91" href="R/75f1534079053d91.html" target="n" data-glyph="76,1" class="i method">RetryWrapper</a>(<a href="@1@netstandard/A.html#9147ae6f76643aae" class="t t">Action</a> <span id="r22 rd" class="r22 r">action</span>)
        {
            <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a> <span id="r23 rd" class="r23 r">lastException</span> = <b>null</b>;
 
            <b>for</b> (<b>int</b> <span id="r24 rd" class="r24 r">i</span> = 0; <span class="r24 r">i</span> &lt; <a href="Constants.cs.html#b615ac250a0079ff" class="t t">Constants</a>.<a href="Constants.cs.html#69ba3ab8dc42ad32" class="i field">RetryCount</a>; <span class="r24 r">i</span>++)
            {
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>.<a href="@1@netstandard/A.html#d2864d73804288fc" class="i method">ThrowIfCancellationRequested</a>();
                <b>try</b>
                {
                    <span class="r22 r">action</span>.<a href="@1@netstandard/A.html#6fbb51427c383a3a" class="i method">Invoke</a>();
                    <b>break</b>;
                }
                <b>catch</b> (<a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a> <span id="r25 rd" class="r25 r">e</span>)
                {
                    <b>if</b> (!<span class="r25 r">e</span>.<a href="/Microsoft.Azure.EventHubs/A.html#82f11a700820e554" class="i property">IsTransient</a>)
                    {
                        <b>throw</b> <span class="r25 r">e</span>;
                    }
                    <span class="r23 r">lastException</span> = <span class="r25 r">e</span>;
                }
                <b>catch</b> (<a href="@1@netstandard/A.html#be77e0a7fbc110e6" class="t t">AggregateException</a> <span id="r26 rd" class="r26 r">ae</span>)
                {
                    <b>if</b> (<span class="r26 r">ae</span>.<a href="@1@netstandard/A.html#89c20b39fb04108b" class="i property">InnerException</a> <b>is</b> <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a>)
                    {
                        <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a> <span id="r27 rd" class="r27 r">ehe</span> = (<a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a>)<span class="r26 r">ae</span>.<a href="@1@netstandard/A.html#89c20b39fb04108b" class="i property">InnerException</a>;
                        <b>if</b> (!<span class="r27 r">ehe</span>.<a href="/Microsoft.Azure.EventHubs/A.html#82f11a700820e554" class="i property">IsTransient</a>)
                        {
                            <b>throw</b> <span class="r27 r">ehe</span>;
                        }
                        <span class="r23 r">lastException</span> = <span class="r27 r">ehe</span>;
                    }
                    <b>else</b>
                    {
                        <b>throw</b> <span class="r26 r">ae</span>;
                    }
                }
            }
 
            <b>return</b> <span class="r23 r">lastException</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> From IPartitionReceiveHandler</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public int</b> <a id="1d0fd599af6ebd4c" href="R/1d0fd599af6ebd4c.html" target="n" data-glyph="102,1" class="i property">MaxBatchSize</a> { <b>get</b>; <b>set</b>; }
 
        <b>async</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <a href="/Microsoft.Azure.EventHubs/A.html#4376c1c4658c32ac" class="t t">IPartitionReceiveHandler</a>.<a href="/Microsoft.Azure.EventHubs/A.html#f6c0da0a407c4a75" class="i method">ProcessEventsAsync</a>(<a href="@1@netstandard/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a>&gt; <span id="r28 rd" class="r28 r">events</span>)
        {
            <a href="@1@netstandard/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a>&gt; <span id="r29 rd" class="r29 r">effectiveEvents</span> = <span class="r28 r">events</span> ?? <b>new</b> <a href="@1@netstandard/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a>&gt;(); <span class="c">// convert to empty list if events is null</span>
 
            <b>if</b> (<span class="r28 r">events</span> != <b>null</b>)
            {
                <span class="c">// Save position of last event if we got a real list of events</span>
                <a href="@1@netstandard/A.html#893e8cdebffde2da" class="t t">IEnumerator</a>&lt;<a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a>&gt; <span id="r30 rd" class="r30 r">scanner</span> = <span class="r29 r">effectiveEvents</span>.<a href="@1@netstandard/A.html#a242475701b655b2" class="i method">GetEnumerator</a>();
                <a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a> <span id="r31 rd" class="r31 r">last</span> = <b>null</b>;
                <b>while</b> (<span class="r30 r">scanner</span>.<a href="@1@netstandard/A.html#116c28c0f6355e3f" class="i method">MoveNext</a>())
                {
                    <span class="r31 r">last</span> = <span class="r30 r">scanner</span>.<a href="@1@netstandard/A.html#d231e5618becae91" class="i property">Current</a>;
                }
                <b>if</b> (<span class="r31 r">last</span> != <b>null</b>)
                {
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>.<a href="PartitionContext.cs.html#d5a8ce76bcc14e5b" class="i method">SetOffsetAndSequenceNumber</a>(<span class="r31 r">last</span>);
                    <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#7015a1cfd021c855" class="i field">options</a>.<a href="EventProcessorOptions.cs.html#feaa575b2ffb6e09" class="i property">EnableReceiverRuntimeMetric</a>)
                    {
                        <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>.<a href="PartitionContext.cs.html#7f0473a8a8ebf80b" class="i property">RuntimeInformation</a>.<a href="/Microsoft.Azure.EventHubs/A.html#4fdd945800972a65" class="i method">Update</a>(<span class="r31 r">last</span>);
                    }
                }
            }
 
            <b>try</b>
            {
                <b>await</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a>.<a href="IEventProcessor.cs.html#35fc928603d72bc4" class="i method">ProcessEventsAsync</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>, <span class="r29 r">effectiveEvents</span>).<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
            }
            <b>catch</b> (<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r32 rd" class="r32 r">e</span>)
            {
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Processing exception on </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>}<span class="s">: </span>{<span class="r32 r">e</span>}<span class="s">&quot;</span>);
                <a href="#151468707c78ce3a" class="i method">SafeProcessError</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>, <span class="r32 r">e</span>);
            }
 
            <b>foreach</b> (<a href="/Microsoft.Azure.EventHubs/A.html#f56ed6e805f7061b" class="t t">EventData</a> <span id="r33 rd" class="r33 r">ev</span> <b>in</b> <span class="r29 r">effectiveEvents</span>)
            {
                <span class="r33 r">ev</span>.<a href="/Microsoft.Azure.EventHubs/A.html#e38e100a682c26e3" class="i method">Dispose</a>();
            }
        }
 
        <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <a href="/Microsoft.Azure.EventHubs/A.html#4376c1c4658c32ac" class="t t">IPartitionReceiveHandler</a>.<a href="/Microsoft.Azure.EventHubs/A.html#a67f88bc32727169" class="i method">ProcessErrorAsync</a>(<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r34 rd" class="r34 r">error</span>)
        {
            <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">RECEIVE EXCEPTION on </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>}<span class="s">: </span>{<span class="r34 r">error</span>}<span class="s">&quot;</span>);
            <a href="#151468707c78ce3a" class="i method">SafeProcessError</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>, <span class="r34 r">error</span>);
            <b>if</b> (<span class="r34 r">error</span> <b>is</b> <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a>)
            {
                <b>if</b> (!(<span class="r34 r">error</span> <b>as</b> <a href="/Microsoft.Azure.EventHubs/A.html#8b9817f4bb66b95f" class="t t">EventHubsException</a>).<a href="/Microsoft.Azure.EventHubs/A.html#82f11a700820e554" class="i property">IsTransient</a>)
                {
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#922cefca92695b8d" class="i field">internalFatalException</a> = <span class="r34 r">error</span>;
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e0d5438e23fd1a18" class="i field">internalCanceller</a>.<a href="@1@netstandard/A.html#93c25ccd0946470f" class="i method">Cancel</a>();
                }
                <span class="c">// else don&#39;t cancel on transient errors</span>
            }
            <b>else</b>
            {
                <span class="c">// All other exceptions are assumed fatal.</span>
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#922cefca92695b8d" class="i field">internalFatalException</a> = <span class="r34 r">error</span>;
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#e0d5438e23fd1a18" class="i field">internalCanceller</a>.<a href="@1@netstandard/A.html#93c25ccd0946470f" class="i method">Cancel</a>();
            }
            <b>return</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@netstandard/A.html#66f1c3e3e272f591" class="i property">CompletedTask</a>;
        }
 
        <b>private void</b> <a id="151468707c78ce3a" href="R/151468707c78ce3a.html" target="n" data-glyph="76,1" class="i method">SafeProcessError</a>(<a href="PartitionContext.cs.html#1a49dc0b2da9fcb8" class="t t">PartitionContext</a> <span id="r35 rd" class="r35 r">context</span>, <a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r36 rd" class="r36 r">error</span>)
        {
            <b>try</b>
            {
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a>.<a href="IEventProcessor.cs.html#81363de9f1db3de7" class="i method">ProcessErrorAsync</a>(<span class="r35 r">context</span>, <span class="r36 r">error</span>).<a href="@1@netstandard/A.html#1bfe9e19e44f4cfa" class="i method">Wait</a>();
            }
            <b>catch</b> (<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r37 rd" class="r37 r">e</span>)
            {
                <span class="c">// The user&#39;s error notification method has thrown.</span>
                <span class="c">// Recursively notifying could easily cause an infinite loop, until the stack runs out.</span>
                <span class="c">// So do not notify, just log.</span>
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Error thrown by ProcessErrorASync: </span>{<span class="r37 r">e</span>}<span class="s">&quot;</span>);
            }
        }
 
        <b>private async</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="499fd811f38b0b4e" href="R/499fd811f38b0b4e.html" target="n" data-glyph="76,1" class="i method">CheckpointStartup</a>(<a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r38 rd" class="r38 r">cancellationToken</span>)
        {
            <span class="c">// Set up store and get checkpoint, if any.</span>
            <b>await</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b2d12271d6f6d26c" class="i field">checkpointManager</a>.<a href="ICheckpointMananger.cs.html#08e2bd65e762715a" class="i method">CreateCheckpointStoreIfNotExistsAsync</a>(<span class="r38 r">cancellationToken</span>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
            <a href="Checkpoint.cs.html#ccd5e0095fe46ec0" class="t t">Checkpoint</a> <span id="r39 rd" class="r39 r">checkpoint</span> = <b>await</b> <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b2d12271d6f6d26c" class="i field">checkpointManager</a>.<a href="ICheckpointMananger.cs.html#a222cb9af87398cf" class="i method">CreateCheckpointIfNotExistsAsync</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#936ea959803bdd2e" class="i field">hubPartitionId</a>, <span class="r38 r">cancellationToken</span>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
            <b>if</b> (!<span class="r39 r">checkpoint</span>.<a href="Checkpoint.cs.html#7d4a9395607e78d5" class="i property">Valid</a>)
            {
                <span class="c">// Not actually any existing checkpoint.</span>
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a> = <b>null</b>;
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;No checkpoint&quot;</span>);
            }
            <b>else</b> <b>if</b> (<span class="r39 r">checkpoint</span>.<a href="Checkpoint.cs.html#8eb0d03518da5da0" class="i property">Version</a> == 1)
            {
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a> = <span class="r39 r">checkpoint</span>.<a href="Checkpoint.cs.html#bff53215c46b4889" class="i property">Offset</a>;
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Checkpoint provides initial offset </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a>}<span class="s">&quot;</span>);
            }
            <b>else</b>
            {
                <span class="c">// It&#39;s actually a later-version checkpoint but we don&#39;t know the details.</span>
                <span class="c">// Access it via the V1 interface and hope it does something sensible.</span>
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a> = <span class="r39 r">checkpoint</span>.<a href="Checkpoint.cs.html#bff53215c46b4889" class="i property">Offset</a>;
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Unexpected checkpoint version </span>{<span class="r39 r">checkpoint</span>.<a href="Checkpoint.cs.html#8eb0d03518da5da0" class="i property">Version</a>}<span class="s">, provided initial offset </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#d9dc760d9ada39f4" class="i field">initialOffset</a>}<span class="s">&quot;</span>);
            }
        }
 
        <b>private async</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="ad1e27361f29db56" href="R/ad1e27361f29db56.html" target="n" data-glyph="76,1" class="i method">GetServicePartitionId</a>(<a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r40 rd" class="r40 r">cancellationToken</span>)
        {
            <b>if</b> (<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#f84a7c255ba17e97" class="i field">fabricPartitionOrdinal</a> == -1)
            {
                <a href="IFabricPartitionLister.cs.html#7476ab5a071bd9ab" class="t t">IFabricPartitionLister</a> <span id="r41 rd" class="r41 r">lister</span> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#03645bd1e986acf7" class="i property">MockMode</a> ?? <b>new</b> <a href="ServiceFabricPartitionLister.cs.html#22d4287491404554" class="t constructor">ServiceFabricPartitionLister</a>();
 
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a> = <b>await</b> <span class="r41 r">lister</span>.<a href="IFabricPartitionLister.cs.html#beaecd9f42775383" class="i method">GetServiceFabricPartitionCount</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#9bcd7a087fb5cbf9" class="i field">serviceFabricServiceName</a>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#f84a7c255ba17e97" class="i field">fabricPartitionOrdinal</a> = <b>await</b> <span class="r41 r">lister</span>.<a href="IFabricPartitionLister.cs.html#9f78c1a6c5c7ccdc" class="i method">GetServiceFabricPartitionOrdinal</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#43eadaa6b36a0529" class="i field">serviceFabricPartitionId</a>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Total partitions </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#2e28508f7890b59b" class="i field">servicePartitionCount</a>}<span class="s">&quot;</span>);
                <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">Partition ordinal </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#f84a7c255ba17e97" class="i field">fabricPartitionOrdinal</a>}<span class="s">&quot;</span>);
                <span class="c">// TODO check that ordinal is not -1</span>
            }
        }
 
        <b>private void</b> <a id="7a8e6fcd52d91c00" href="R/7a8e6fcd52d91c00.html" target="n" data-glyph="76,1" class="i method">MetricsHandler</a>()
        {
            <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;METRIC reporter starting&quot;</span>);
 
            <b>while</b> (!<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>.<a href="@1@netstandard/A.html#f32abbe8e2f1f6c1" class="i property">IsCancellationRequested</a>)
            {
                <a href="@1@netstandard/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>, <b>int</b>&gt; <span id="r42 rd" class="r42 r">userMetrics</span> = <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#61b4a9cdd12049f3" class="i field">userEventProcessor</a>.<a href="IEventProcessor.cs.html#a6f1c2b59e75c16d" class="i method">GetLoadMetric</a>(<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>);
 
                <b>try</b>
                {
                    <a href="@1@netstandard/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<span class="t t">LoadMetric</span>&gt; <span id="r43 rd" class="r43 r">reportableMetrics</span> = <b>new</b> <a href="@1@netstandard/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<span class="t t">LoadMetric</span>&gt;();
                    <b>foreach</b> (<a href="@1@netstandard/A.html#8585965bb176a426" class="t t">KeyValuePair</a>&lt;<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>, <b>int</b>&gt; <span id="r44 rd" class="r44 r">metric</span> <b>in</b> <span class="r42 r">userMetrics</span>)
                    {
                        <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">METRIC </span>{<span class="r44 r">metric</span>.<a href="@1@netstandard/A.html#f9d1c04feb1af032" class="i property">Key</a>}<span class="s"> for partition </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>.<a href="PartitionContext.cs.html#103246bc5457d1b2" class="i property">PartitionId</a>}<span class="s"> is </span>{<span class="r44 r">metric</span>.<a href="@1@netstandard/A.html#38c0e86cc4b30170" class="i property">Value</a>}<span class="s">&quot;</span>);
                        <span class="r43 r">reportableMetrics</span>.<a href="@1@netstandard/A.html#9cc11588bffd57c1" class="i method">Add</a>(<b>new</b> <span class="t constructor">LoadMetric</span>(<span class="r44 r">metric</span>.<a href="@1@netstandard/A.html#f9d1c04feb1af032" class="i property">Key</a>, <span class="r44 r">metric</span>.<a href="@1@netstandard/A.html#38c0e86cc4b30170" class="i property">Value</a>));
                    }
                    <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#b5b66e4a72aea36c" class="i field">servicePartition</a>.<span class="i method">ReportLoad</span>(<span class="r43 r">reportableMetrics</span>);
                    <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@netstandard/A.html#b070ae859dd3f7b7" class="i method">Delay</a>(<a href="Constants.cs.html#b615ac250a0079ff" class="t t">Constants</a>.<a href="Constants.cs.html#d3c876e72882a358" class="i field">MetricReportingInterval</a>, <a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#c8fb9728da7ca96a" class="i field">linkedCancellationToken</a>).<a href="@1@netstandard/A.html#1bfe9e19e44f4cfa" class="i method">Wait</a>(); <span class="c">// throws on cancel</span>
                }
                <b>catch</b> (<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r45 rd" class="r45 r">e</span>)
                {
                    <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">$&quot;</span><span class="s">METRIC partition </span>{<a href="#a32fbfa5c91e3b37" class="k">this</a>.<a href="#09cfc83cf153d52e" class="i field">partitionContext</a>.<a href="PartitionContext.cs.html#103246bc5457d1b2" class="i property">PartitionId</a>}<span class="s"> exception </span>{<span class="r45 r">e</span>}<span class="s">&quot;</span>);
                }
            }
 
            <a href="EventProcessorEventSource.cs.html#2fed9fafe165eac3" class="t t">EventProcessorEventSource</a>.<a href="EventProcessorEventSource.cs.html#be9569fb60e2506c" class="i field">Current</a>.<a href="EventProcessorEventSource.cs.html#82060e097e4d860d" class="i method">Message</a>(<span class="s">&quot;METRIC reporter exiting&quot;</span>);
        }
    }
}
</pre></td></tr></table></div></body></html>
