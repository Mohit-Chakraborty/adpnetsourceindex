<!DOCTYPE html>
<html><head><title>EventDataBatch.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(164);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.EventHubs/EventDataBatch.cs" target="_top">EventDataBatch.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.EventHubs" target="_top">Microsoft.Azure.EventHubs.csproj</a> (Microsoft.Azure.EventHubs)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft. All rights reserved.</span>
<span class="c">// Licensed under the MIT license. See LICENSE file in the project root for full license information.</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>
{
    <b>using</b> <span class="i">System</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Diagnostics</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i">Amqp</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<span class="i n">Amqp</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<span class="i n">Primitives</span>;
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">A helper class for creating an IEnumerable</span><span class="c">&amp;lt;</span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">&amp;gt;</span><span class="c"> taking into account the max size limit, so that the IEnumerable</span><span class="c">&amp;lt;</span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">&amp;gt;</span><span class="c"> can be passed to the Send or SendAsync method of an </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<a href="EventHubClient.cs.html#ef11bbb905992f88" class="t t">EventHubClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to send the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> objects as a batch.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="3d69be77480a8202" href="R/3d69be77480a8202.html" target="n" data-glyph="0,0" class="t t">EventDataBatch</a> : <span class="i">IDisposable</span>
    {
        <b>const int</b> <a id="111a2e58523b9e39" href="R/111a2e58523b9e39.html" target="n" data-glyph="10,1" class="i field">MaxSizeLimit</a> = 4 * 1024 * 1024;
 
        <span class="c">// System.Diagnostics.Activity.Id is 1024 bytes or shorter.</span>
        <span class="c">// However we will keep overhead at 128 bytes which should be enough for most scenarios.</span>
        <span class="c">// Any client in need of longer Ids should create batch with an appropriate mac-batch-size.</span>
        <b>const int</b> <a id="601bc83c54e59b2f" href="R/601bc83c54e59b2f.html" target="n" data-glyph="10,1" class="i field">DiagnosticsIdOverhead</a> = 128;
 
        <b>readonly</b> <span class="i">List</span>&lt;<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>&gt; <a id="6b0abd5b94e412c5" href="R/6b0abd5b94e412c5.html" target="n" data-glyph="46,1" class="i field">eventDataList</a>;
        <b>readonly long</b> <a id="b4d2373875ffde3d" href="R/b4d2373875ffde3d.html" target="n" data-glyph="46,1" class="i field">maxSize</a>;
 
        <b>long</b> <a id="62bc0eb0b27d4147" href="R/62bc0eb0b27d4147.html" target="n" data-glyph="46,1" class="i field">currentSize</a>;
        <b>bool</b> <a id="4a377a64df3315bd" href="R/4a377a64df3315bd.html" target="n" data-glyph="46,1" class="i field">disposed</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a new </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#3d69be77480a8202" class="t t">EventDataBatch</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">maxSizeInBytes</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The maximum size allowed for the batch</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">partitionKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Partition key associated with the batch</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="38df2bf345874ae5" href="R/38df2bf345874ae5.html" target="n" data-glyph="72,1" class="t constructor">EventDataBatch</a>(<b>long</b> <span id="r0 rd" class="r0 r">maxSizeInBytes</span>, <b>string</b> <span id="r1 rd" class="r1 r">partitionKey</span> = <b>null</b>)
        {
            <a href="#3d69be77480a8202" class="k">this</a>.<a href="#8a995bc51e506a2f" class="i property">PartitionKey</a> = <span class="r1 r">partitionKey</span>;
            <a href="#3d69be77480a8202" class="k">this</a>.<a href="#b4d2373875ffde3d" class="i field">maxSize</a> = <span class="i">Math</span>.<span class="i">Min</span>(<span class="r0 r">maxSizeInBytes</span>, <a href="#111a2e58523b9e39" class="i field">MaxSizeLimit</a>);
            <a href="#3d69be77480a8202" class="k">this</a>.<a href="#6b0abd5b94e412c5" class="i field">eventDataList</a> = <b>new</b> <span class="i">List</span>&lt;<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>&gt;();
 
            <span class="c">// Reserve for wrapper message.</span>
            <b>using</b> (<b>var</b> <span id="r2 rd" class="r2 r">batchMessage</span> = <span class="i">AmqpMessage</span>.<span class="i">Create</span>())
            {
                <span class="r2 r">batchMessage</span>.<span class="i">MessageFormat</span> = <span class="i">AmqpConstants</span>.<span class="i">AmqpBatchedMessageFormat</span>;
                <a href="Amqp/AmqpMessageConverter.cs.html#2175e6b3c265d0d3" class="t t">AmqpMessageConverter</a>.<span class="i">UpdateAmqpMessagePartitionKey</span>(<span class="r2 r">batchMessage</span>, <span class="r1 r">partitionKey</span>);
                <a href="#3d69be77480a8202" class="k">this</a>.<a href="#62bc0eb0b27d4147" class="i field">currentSize</a> = <span class="r2 r">batchMessage</span>.<span class="i">SerializedMessageSize</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Gets the current event count in the batch.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public int</b> <a id="4cccfdf523c818d8" href="R/4cccfdf523c818d8.html" target="n" data-glyph="102,1" class="i property">Count</a>
        {
            <b>get</b>
            {
                <a href="#3d69be77480a8202" class="k">this</a>.<a href="#18d4835d85c66e52" class="i method">ThrowIfDisposed</a>();
                <b>return</b> <a href="#3d69be77480a8202" class="k">this</a>.<a href="#6b0abd5b94e412c5" class="i field">eventDataList</a>.<span class="i">Count</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Gets the current batch size in bytes.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public long</b> <a id="be5655fca68271dc" href="R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Size</a>
        {
            <b>get</b>
            {
                <a href="#3d69be77480a8202" class="k">this</a>.<a href="#18d4835d85c66e52" class="i method">ThrowIfDisposed</a>();
                <b>return</b> <a href="#3d69be77480a8202" class="k">this</a>.<a href="#62bc0eb0b27d4147" class="i field">currentSize</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Tries to add an event data to the batch if permitted by the batch&#39;s size limit.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">eventData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> to add.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A boolean value indicating if the event data has been added to the batch or not.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Thrown when the EventData is null.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ObjectDisposedException</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Thrown when the batch is already disposed.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This method checks the sizes of the batch, the EventData object and the specified limit to determine</span>
        <span class="c">///</span><span class="c"> if the EventData object can be added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="ede06a89dff1d816" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TryAdd</a>(<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a> <span id="r3 rd" class="r3 r">eventData</span>)
        {
            <a href="Primitives/Guard.cs.html#b565701b95b9c8b9" class="t t">Guard</a>.<a href="Primitives/Guard.cs.html#5e02d3d43dcbe30a" class="i method">ArgumentNotNull</a>(<b>nameof</b>(<span class="r3 r">eventData</span>), <span class="r3 r">eventData</span>);
 
            <a href="#3d69be77480a8202" class="k">this</a>.<a href="#18d4835d85c66e52" class="i method">ThrowIfDisposed</a>();
            <b>long</b> <span id="r4 rd" class="r4 r">size</span> = <a href="#cade89109cba161a" class="i method">GetEventSizeForBatch</a>(<span class="r3 r">eventData</span>);
            <b>if</b> (<a href="#3d69be77480a8202" class="k">this</a>.<a href="#6b0abd5b94e412c5" class="i field">eventDataList</a>.<span class="i">Count</span> &gt; 0 &amp;&amp; <a href="#3d69be77480a8202" class="k">this</a>.<a href="#62bc0eb0b27d4147" class="i field">currentSize</a> + <span class="r4 r">size</span> &gt; <a href="#3d69be77480a8202" class="k">this</a>.<a href="#b4d2373875ffde3d" class="i field">maxSize</a>)
            {
                <b>return</b> <b>false</b>;
            }
 
            <a href="#3d69be77480a8202" class="k">this</a>.<a href="#6b0abd5b94e412c5" class="i field">eventDataList</a>.<span class="i">Add</span>(<span class="r3 r">eventData</span>);
            <a href="#3d69be77480a8202" class="k">this</a>.<a href="#62bc0eb0b27d4147" class="i field">currentSize</a> += <span class="r4 r">size</span>;
 
            <b>return</b> <b>true</b>;
        }
 
        <b>internal string</b> <a id="8a995bc51e506a2f" href="R/8a995bc51e506a2f.html" target="n" data-glyph="104,1" class="i property">PartitionKey</a> { <b>get</b>; <b>set</b>; }
 
        <b>long</b> <a id="cade89109cba161a" href="R/cade89109cba161a.html" target="n" data-glyph="76,1" class="i method">GetEventSizeForBatch</a>(<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a> <span id="r5 rd" class="r5 r">eventData</span>)
        {
            <span class="c">// Create AMQP message here.</span>
            <b>var</b> <span id="r6 rd" class="r6 r">amqpMessage</span> = <a href="Amqp/AmqpMessageConverter.cs.html#2175e6b3c265d0d3" class="t t">AmqpMessageConverter</a>.<a href="Amqp/AmqpMessageConverter.cs.html#265c5fef34c226e7" class="i method">EventDataToAmqpMessage</a>(<span class="r5 r">eventData</span>);
            <a href="Amqp/AmqpMessageConverter.cs.html#2175e6b3c265d0d3" class="t t">AmqpMessageConverter</a>.<a href="Amqp/AmqpMessageConverter.cs.html#b05e50687fce4ed8" class="i method">UpdateAmqpMessagePartitionKey</a>(<span class="r6 r">amqpMessage</span>, <a href="#3d69be77480a8202" class="k">this</a>.<a href="#8a995bc51e506a2f" class="i property">PartitionKey</a>);
 
            <span class="c">// Calculate overhead depending on the message size. </span>
            <span class="c">// Overhead is smaller for messages smaller than 256 bytes.</span>
            <b>long</b> <span id="r7 rd" class="r7 r">overhead</span> = <span class="r6 r">amqpMessage</span>.<span class="i">SerializedMessageSize</span> &lt; 256 ? 5 : 8;
 
            <span class="c">// We can use the same AMQP message unless diagnostics is enabled.</span>
            <span class="c">// Diagnostics extension will stamp message with an id on the Send call.</span>
            <b>if</b> (!<a href="EventHubsDiagnosticSource.cs.html#75bd91bbbfd82c87" class="t t">EventHubsDiagnosticSource</a>.<a href="EventHubsDiagnosticSource.cs.html#3bc08e7148d23666" class="i property">IsEnabledForSendActivity</a>)
            {
                <span class="r5 r">eventData</span>.<a href="EventData.cs.html#eff8f3c1e3172224" class="i property">AmqpMessage</a> = <span class="r6 r">amqpMessage</span>;
            }
            <b>else</b>
            {
                <span class="c">// Reserve overhead for diagnostic-id property.</span>
                <span class="r7 r">overhead</span> += <a href="#601bc83c54e59b2f" class="i field">DiagnosticsIdOverhead</a>;
            }
 
            <b>return</b> <span class="r6 r">amqpMessage</span>.<span class="i">SerializedMessageSize</span> + <span class="r7 r">overhead</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Disposes resources attached to an EventDataBatch.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="167417b7c583d9d3" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#270e1aafbfa65132" class="i method">Dispose</a>(<b>true</b>);
        }
 
        <b>void</b> <a id="270e1aafbfa65132" href="R/270e1aafbfa65132.html" target="n" data-glyph="76,1" class="i method">Dispose</a>(<b>bool</b> <span id="r8 rd" class="r8 r">disposing</span>)
        {
            <b>if</b> (!<a href="#4a377a64df3315bd" class="i field">disposed</a>)
            {
                <b>if</b> (<span class="r8 r">disposing</span>)
                {
                    <a href="#3d69be77480a8202" class="k">this</a>.<a href="#4a377a64df3315bd" class="i field">disposed</a> = <b>true</b>;
                    <b>foreach</b> (<b>var</b> <span id="r9 rd" class="r9 r">e</span> <b>in</b> <a href="#3d69be77480a8202" class="k">this</a>.<a href="#6b0abd5b94e412c5" class="i field">eventDataList</a>)
                    {
                        <span class="r9 r">e</span>.<span class="i">Dispose</span>();
                    }
                }
 
                <a href="#4a377a64df3315bd" class="i field">disposed</a> = <b>true</b>;
            }
        }
 
        <b>void</b> <a id="18d4835d85c66e52" href="R/18d4835d85c66e52.html" target="n" data-glyph="76,1" class="i method">ThrowIfDisposed</a>()
        {
            <b>if</b> (<a href="#3d69be77480a8202" class="k">this</a>.<a href="#4a377a64df3315bd" class="i field">disposed</a>)
            {
                <b>throw</b> <b>new</b> <span class="i">ObjectDisposedException</span>(<a href="#3d69be77480a8202" class="k">this</a>.<span class="i">GetType</span>().<span class="i">Name</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Returns the enumerator of EventData objects in the batch.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">IEnumerable of EventData objects.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">IEnumerable</span>&lt;<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>&gt; <a id="d81c9036ddec804d" href="R/d81c9036ddec804d.html" target="n" data-glyph="72,1" class="i method">ToEnumerable</a>()
        {
            <a href="#3d69be77480a8202" class="k">this</a>.<a href="#18d4835d85c66e52" class="i method">ThrowIfDisposed</a>();
            <b>return</b> <a href="#3d69be77480a8202" class="k">this</a>.<a href="#6b0abd5b94e412c5" class="i field">eventDataList</a>;
        }
    }
}
</pre></td></tr></table></div></body></html>
