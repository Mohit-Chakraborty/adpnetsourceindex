<!DOCTYPE html>
<html><head><title>AmqpServiceClient.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(231);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.EventHubs/Amqp/AmqpServiceClient.cs" target="_top">Amqp\AmqpServiceClient.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.EventHubs" target="_top">Microsoft.Azure.EventHubs.csproj</a> (Microsoft.Azure.EventHubs)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft. All rights reserved.</span>
<span class="c">// Licensed under the MIT license. See LICENSE file in the project root for full license information.</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<span class="i n">Amqp</span>.<span class="i n">Management</span>
{
    <b>using</b> <span class="i">System</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i">Amqp</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i">Amqp</span>.<span class="i">Encoding</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i">Amqp</span>.<span class="i">Framing</span>;
 
    <b>class</b> <a id="c4751c591e13bf72" href="../R/c4751c591e13bf72.html" target="n" data-glyph="2,0" class="t t">AmqpServiceClient</a> : <a href="../Primitives/ClientEntity.cs.html#a0afa5cf8d7b86bf" class="t t">ClientEntity</a>
    {
        <b>static readonly string</b>[] <a id="87efc9dfe7c22a3e" href="../R/87efc9dfe7c22a3e.html" target="n" data-glyph="46,1" class="i field">RequiredClaims</a> = { <a href="../Primitives/ClaimConstants.cs.html#748ab48e857a3e43" class="t t">ClaimConstants</a>.<a href="../Primitives/ClaimConstants.cs.html#5f6f20b8225025c0" class="i field">Manage</a>, <a href="../Primitives/ClaimConstants.cs.html#748ab48e857a3e43" class="t t">ClaimConstants</a>.<a href="../Primitives/ClaimConstants.cs.html#06acc30cc9bba37c" class="i field">Listen</a> };
 
        <b>readonly</b> <a href="AmqpEventHubClient.cs.html#a3d8f2ab12489a19" class="t t">AmqpEventHubClient</a> <a id="5771c67a1d2d6400" href="../R/5771c67a1d2d6400.html" target="n" data-glyph="46,1" class="i field">eventHubClient</a>;
        <b>readonly</b> <span class="i">FaultTolerantAmqpObject</span>&lt;<span class="i">RequestResponseAmqpLink</span>&gt; <a id="e5af25856d644abc" href="../R/e5af25856d644abc.html" target="n" data-glyph="46,1" class="i field">link</a>;
        <b>readonly</b> <a href="../Primitives/AsyncLock.cs.html#709f326ddb5298ba" class="t t">AsyncLock</a> <a id="8e482c6047f56696" href="../R/8e482c6047f56696.html" target="n" data-glyph="46,1" class="i field">tokenLock</a> = <b>new</b> <a href="../Primitives/AsyncLock.cs.html#dd14b91f0bf06ac6" class="t constructor">AsyncLock</a>();
 
        <a href="../Primitives/SecurityToken.cs.html#017dc10d8a13dcde" class="t t">SecurityToken</a> <a id="985231b6129d1517" href="../R/985231b6129d1517.html" target="n" data-glyph="46,1" class="i field">token</a>;
 
        <b>public</b> <a id="0f5b89bd53cadf4e" href="../R/0f5b89bd53cadf4e.html" target="n" data-glyph="72,1" class="t constructor">AmqpServiceClient</a>(<a href="AmqpEventHubClient.cs.html#a3d8f2ab12489a19" class="t t">AmqpEventHubClient</a> <span id="r0 rd" class="r0 r">eventHubClient</span>, <b>string</b> <span id="r1 rd" class="r1 r">address</span>)
            : <b>base</b>(<span class="s">&quot;AmqpServiceClient-&quot;</span> + <a href="../Primitives/StringUtility.cs.html#489856bf0ff5a6a7" class="t t">StringUtility</a>.<a href="../Primitives/StringUtility.cs.html#812c848159431087" class="i method">GetRandomString</a>())
        {
            <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#5771c67a1d2d6400" class="i field">eventHubClient</a> = <span class="r0 r">eventHubClient</span>;
            <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#3fc1f9dacebffd31" class="i property">Address</a> = <span class="r1 r">address</span>;
            <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#e5af25856d644abc" class="i field">link</a> = <b>new</b> <span class="i">FaultTolerantAmqpObject</span>&lt;<span class="i">RequestResponseAmqpLink</span>&gt;(<a href="#c4751c591e13bf72" class="k">this</a>.<span class="i">OpenLinkAsync</span>, <span id="r2 rd" class="r2 r">rrlink</span> =&gt; <span class="r2 r">rrlink</span>.<span class="i">CloseAsync</span>(<span class="i">TimeSpan</span>.<span class="i">FromSeconds</span>(10)));
        }
 
        <span class="i">AmqpMessage</span> <a id="171d871883705419" href="../R/171d871883705419.html" target="n" data-glyph="76,1" class="i method">CreateGetRuntimeInformationRequest</a>()
        {
            <span class="i">AmqpMessage</span> <span id="r3 rd" class="r3 r">getRuntimeInfoRequest</span> = <span class="i">AmqpMessage</span>.<span class="i">Create</span>();
            <span class="r3 r">getRuntimeInfoRequest</span>.<span class="i">ApplicationProperties</span> = <b>new</b> <span class="i">ApplicationProperties</span>();
            <span class="r3 r">getRuntimeInfoRequest</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#a02c4822e74873df" class="i field">EntityNameKey</a>] = <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#5771c67a1d2d6400" class="i field">eventHubClient</a>.<a href="../EventHubClient.cs.html#cb2687894300e685" class="i property">EventHubName</a>;
            <span class="r3 r">getRuntimeInfoRequest</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#510399bef86035e9" class="i field">ManagementOperationKey</a>] = <a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#ae44885a243f5a8a" class="i field">ReadOperationValue</a>;
            <span class="r3 r">getRuntimeInfoRequest</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#5b25d0dee1c6b51c" class="i field">ManagementEntityTypeKey</a>] = <a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#43ece0afafac15de" class="i field">ManagementEventHubEntityTypeValue</a>;
 
            <b>return</b> <span class="r3 r">getRuntimeInfoRequest</span>;
        }
 
        <span class="i">AmqpMessage</span> <a id="b98843c365f0b919" href="../R/b98843c365f0b919.html" target="n" data-glyph="76,1" class="i method">CreateGetPartitionRuntimeInformationRequest</a>(<b>string</b> <span id="r4 rd" class="r4 r">partitionKey</span>)
        {
            <span class="i">AmqpMessage</span> <span id="r5 rd" class="r5 r">getRuntimeInfoRequest</span> = <span class="i">AmqpMessage</span>.<span class="i">Create</span>();
            <span class="r5 r">getRuntimeInfoRequest</span>.<span class="i">ApplicationProperties</span> = <b>new</b> <span class="i">ApplicationProperties</span>();
            <span class="r5 r">getRuntimeInfoRequest</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#a02c4822e74873df" class="i field">EntityNameKey</a>] = <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#5771c67a1d2d6400" class="i field">eventHubClient</a>.<a href="../EventHubClient.cs.html#cb2687894300e685" class="i property">EventHubName</a>;
            <span class="r5 r">getRuntimeInfoRequest</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#ed107c735ddc4280" class="i field">PartitionNameKey</a>] = <span class="r4 r">partitionKey</span>;
            <span class="r5 r">getRuntimeInfoRequest</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#510399bef86035e9" class="i field">ManagementOperationKey</a>] = <a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#ae44885a243f5a8a" class="i field">ReadOperationValue</a>;
            <span class="r5 r">getRuntimeInfoRequest</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#5b25d0dee1c6b51c" class="i field">ManagementEntityTypeKey</a>] = <a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#8ae53c817f2875e2" class="i field">ManagementPartitionEntityTypeValue</a>;
 
            <b>return</b> <span class="r5 r">getRuntimeInfoRequest</span>;
        }
 
        <b>public async</b> <span class="i">Task</span>&lt;<a href="../EventHubRuntimeInformation.cs.html#46003615b8a69ab0" class="t t">EventHubRuntimeInformation</a>&gt; <a id="14829312bbdae21a" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetRuntimeInformationAsync</a>()
        {
            <span class="i">RequestResponseAmqpLink</span> <span id="r6 rd" class="r6 r">requestLink</span> = <b>await</b> <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#e5af25856d644abc" class="i field">link</a>.<span class="i">GetOrCreateAsync</span>(
                <span class="i">TimeSpan</span>.<span class="i">FromSeconds</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#bc95632afdd80c05" class="i field">AmqpSessionTimeoutInSeconds</a>)).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
            <span class="c">// Create request and attach token.</span>
            <b>var</b> <span id="r7 rd" class="r7 r">request</span> = <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#171d871883705419" class="i method">CreateGetRuntimeInformationRequest</a>();
            <span class="r7 r">request</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#bed8a059b67462dd" class="i field">ManagementSecurityTokenKey</a>] = <b>await</b> <a href="#1796411d7877b547" class="i method">GetTokenString</a>().<span class="i">ConfigureAwait</span>(<b>false</b>);
 
            <b>var</b> <span id="r8 rd" class="r8 r">response</span> = <b>await</b> <span class="r6 r">requestLink</span>.<span class="i">RequestAsync</span>(<span class="r7 r">request</span>, <a href="#5771c67a1d2d6400" class="i field">eventHubClient</a>.<a href="../EventHubClient.cs.html#58a8e47a06e35c53" class="i property">ConnectionStringBuilder</a>.<a href="../Primitives/EventHubsConnectionStringBuilder.cs.html#9bdfa559ce29adc5" class="i property">OperationTimeout</a>).<span class="i">ConfigureAwait</span>(<b>false</b>);
            <b>int</b> <span id="r9 rd" class="r9 r">statusCode</span> = (<b>int</b>)<span class="r8 r">response</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#577b96c460f7f7df" class="i field">ResponseStatusCode</a>];
            <b>string</b> <span id="r10 rd" class="r10 r">statusDescription</span> = (<b>string</b>)<span class="r8 r">response</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#12a0502d6ecff205" class="i field">ResponseStatusDescription</a>];
            <b>if</b> (<span class="r9 r">statusCode</span> != (<b>int</b>)<span class="i">AmqpResponseStatusCode</span>.<span class="i">Accepted</span> &amp;&amp; <span class="r9 r">statusCode</span> != (<b>int</b>)<span class="i">AmqpResponseStatusCode</span>.<span class="i">OK</span>)
            {
                <span class="i">AmqpSymbol</span> <span id="r11 rd" class="r11 r">errorCondition</span> = <a href="AmqpExceptionHelper.cs.html#a5cb48409a072b48" class="t t">AmqpExceptionHelper</a>.<span class="i">GetResponseErrorCondition</span>(<span class="r8 r">response</span>, (<span class="i">AmqpResponseStatusCode</span>)<span class="r9 r">statusCode</span>);
                <span class="i">Error</span> <span id="r12 rd" class="r12 r">error</span> = <b>new</b> <span class="i">Error</span> { <span class="i">Condition</span> = <span class="r11 r">errorCondition</span>, <span class="i">Description</span> = <span class="r10 r">statusDescription</span> };
                <b>throw</b> <a href="AmqpExceptionHelper.cs.html#a5cb48409a072b48" class="t t">AmqpExceptionHelper</a>.<a href="AmqpExceptionHelper.cs.html#ea3588810654ac00" class="i method">ToMessagingContract</a>(<span class="r12 r">error</span>);
            }
 
            <span class="i">AmqpMap</span> <span id="r13 rd" class="r13 r">infoMap</span> = <b>null</b>;
            <b>if</b> (<span class="r8 r">response</span>.<span class="i">ValueBody</span> != <b>null</b>)
            {
                <span class="r13 r">infoMap</span> = <span class="r8 r">response</span>.<span class="i">ValueBody</span>.<span class="i">Value</span> <b>as</b> <span class="i">AmqpMap</span>;
            }
 
            <b>if</b> (<span class="r13 r">infoMap</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<span class="s">$&quot;</span><span class="s">Return type mismatch in GetRuntimeInformationAsync. Response returned NULL or response isn&#39;t AmqpMap.</span><span class="s">&quot;</span>);
            }
 
            <b>return</b> <b>new</b> <span class="t">EventHubRuntimeInformation</span>()
            {
                <a href="../EventHubRuntimeInformation.cs.html#958a5b5cf10b01eb" class="i property">Type</a> = (<b>string</b>)<span class="r13 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<span class="s">&quot;type&quot;</span>)],
                <a href="../EventHubRuntimeInformation.cs.html#007ead59066395ef" class="i property">Path</a> = (<b>string</b>)<span class="r13 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<span class="s">&quot;name&quot;</span>)],
                <a href="../EventHubRuntimeInformation.cs.html#3af8ee85bd204d4f" class="i property">CreatedAt</a> = (<span class="i">DateTime</span>)<span class="r13 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<span class="s">&quot;created_at&quot;</span>)],
                <a href="../EventHubRuntimeInformation.cs.html#df527c1931264461" class="i property">PartitionCount</a> = (<b>int</b>)<span class="r13 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<span class="s">&quot;partition_count&quot;</span>)],
                <a href="../EventHubRuntimeInformation.cs.html#6f7d55289e44ee46" class="i property">PartitionIds</a> = (<b>string</b>[])<span class="r13 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<span class="s">&quot;partition_ids&quot;</span>)],
            };
        }
 
        <b>public async</b> <span class="i">Task</span>&lt;<a href="../EventHubPartitionRuntimeInformation.cs.html#80a307eafc665477" class="t t">EventHubPartitionRuntimeInformation</a>&gt; <a id="ecd265498a3c2605" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetPartitionRuntimeInformationAsync</a>(<b>string</b> <span id="r14 rd" class="r14 r">partitionId</span>)
        {
            <span class="i">RequestResponseAmqpLink</span> <span id="r15 rd" class="r15 r">requestLink</span> = <b>await</b> <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#e5af25856d644abc" class="i field">link</a>.<span class="i">GetOrCreateAsync</span>(
                <span class="i">TimeSpan</span>.<span class="i">FromSeconds</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#bc95632afdd80c05" class="i field">AmqpSessionTimeoutInSeconds</a>)).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
            <span class="c">// Create request and attach token.</span>
            <b>var</b> <span id="r16 rd" class="r16 r">request</span> = <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#b98843c365f0b919" class="i method">CreateGetPartitionRuntimeInformationRequest</a>(<span class="r14 r">partitionId</span>);
            <span class="r16 r">request</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#bed8a059b67462dd" class="i field">ManagementSecurityTokenKey</a>] = <b>await</b> <a href="#1796411d7877b547" class="i method">GetTokenString</a>().<span class="i">ConfigureAwait</span>(<b>false</b>);
 
            <b>var</b> <span id="r17 rd" class="r17 r">response</span> = <b>await</b> <span class="r15 r">requestLink</span>.<span class="i">RequestAsync</span>(<span class="r16 r">request</span>, <a href="#5771c67a1d2d6400" class="i field">eventHubClient</a>.<a href="../EventHubClient.cs.html#58a8e47a06e35c53" class="i property">ConnectionStringBuilder</a>.<a href="../Primitives/EventHubsConnectionStringBuilder.cs.html#9bdfa559ce29adc5" class="i property">OperationTimeout</a>).<span class="i">ConfigureAwait</span>(<b>false</b>);
            <b>int</b> <span id="r18 rd" class="r18 r">statusCode</span> = (<b>int</b>)<span class="r17 r">response</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#577b96c460f7f7df" class="i field">ResponseStatusCode</a>];
            <b>string</b> <span id="r19 rd" class="r19 r">statusDescription</span> = (<b>string</b>)<span class="r17 r">response</span>.<span class="i">ApplicationProperties</span>.<span class="i">Map</span>[<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#12a0502d6ecff205" class="i field">ResponseStatusDescription</a>];
            <b>if</b> (<span class="r18 r">statusCode</span> != (<b>int</b>)<span class="i">AmqpResponseStatusCode</span>.<span class="i">Accepted</span> &amp;&amp; <span class="r18 r">statusCode</span> != (<b>int</b>)<span class="i">AmqpResponseStatusCode</span>.<span class="i">OK</span>)
            {
                <span class="i">AmqpSymbol</span> <span id="r20 rd" class="r20 r">errorCondition</span> = <a href="AmqpExceptionHelper.cs.html#a5cb48409a072b48" class="t t">AmqpExceptionHelper</a>.<span class="i">GetResponseErrorCondition</span>(<span class="r17 r">response</span>, (<span class="i">AmqpResponseStatusCode</span>)<span class="r18 r">statusCode</span>);
                <span class="i">Error</span> <span id="r21 rd" class="r21 r">error</span> = <b>new</b> <span class="i">Error</span> { <span class="i">Condition</span> = <span class="r20 r">errorCondition</span>, <span class="i">Description</span> = <span class="r19 r">statusDescription</span> };
                <b>throw</b> <a href="AmqpExceptionHelper.cs.html#a5cb48409a072b48" class="t t">AmqpExceptionHelper</a>.<a href="AmqpExceptionHelper.cs.html#ea3588810654ac00" class="i method">ToMessagingContract</a>(<span class="r21 r">error</span>);
            }
 
            <span class="i">AmqpMap</span> <span id="r22 rd" class="r22 r">infoMap</span> = <b>null</b>;
            <b>if</b> (<span class="r17 r">response</span>.<span class="i">ValueBody</span> != <b>null</b>)
            {
                <span class="r22 r">infoMap</span> = <span class="r17 r">response</span>.<span class="i">ValueBody</span>.<span class="i">Value</span> <b>as</b> <span class="i">AmqpMap</span>;
            }
 
            <b>if</b> (<span class="r22 r">infoMap</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<span class="s">$&quot;</span><span class="s">Return type mismatch in GetPartitionRuntimeInformationAsync. Response returned NULL or response isn&#39;t AmqpMap.</span><span class="s">&quot;</span>);
            }
 
            <b>return</b> <b>new</b> <span class="t">EventHubPartitionRuntimeInformation</span>()
            {
                <a href="../EventHubPartitionRuntimeInformation.cs.html#cb0e421b57bd9709" class="i property">Type</a> = (<b>string</b>)<span class="r22 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#bff60ab913b0c180" class="i field">EntityTypeName</a>)],
                <a href="../EventHubPartitionRuntimeInformation.cs.html#9676c1fc0c304ec3" class="i property">Path</a> = (<b>string</b>)<span class="r22 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#a02c4822e74873df" class="i field">EntityNameKey</a>)],
                <a href="../EventHubPartitionRuntimeInformation.cs.html#283ac941de98fcf3" class="i property">PartitionId</a> = (<b>string</b>)<span class="r22 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#ed107c735ddc4280" class="i field">PartitionNameKey</a>)],
                <a href="../EventHubPartitionRuntimeInformation.cs.html#eeb56e778a10832c" class="i property">BeginSequenceNumber</a> = (<b>long</b>)<span class="r22 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#95de42f011592405" class="i field">ManagementPartitionBeginSequenceNumber</a>)],
                <a href="../EventHubPartitionRuntimeInformation.cs.html#ca46b67d9444a696" class="i property">LastEnqueuedSequenceNumber</a> = (<b>long</b>)<span class="r22 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#3d3c03ef39065ccc" class="i field">ManagementPartitionLastEnqueuedSequenceNumber</a>)],
                <a href="../EventHubPartitionRuntimeInformation.cs.html#afbb254953bdbafd" class="i property">LastEnqueuedOffset</a> = (<b>string</b>)<span class="r22 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#c7debbbcf2489a6a" class="i field">ManagementPartitionLastEnqueuedOffset</a>)],
                <a href="../EventHubPartitionRuntimeInformation.cs.html#35db5dc248f7c75f" class="i property">LastEnqueuedTimeUtc</a> = (<span class="i">DateTime</span>)<span class="r22 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#ca7dbe861fae7a2b" class="i field">ManagementPartitionLastEnqueuedTimeUtc</a>)],
                <a href="../EventHubPartitionRuntimeInformation.cs.html#9dec9b46c3cfc0f4" class="i property">IsEmpty</a> = (<b>bool</b>)<span class="r22 r">infoMap</span>[<b>new</b> <span class="i">MapKey</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#d2270c40576839f1" class="i field">ManagementPartitionRuntimeInfoPartitionIsEmpty</a>)]
            };
        }
 
        <b>public string</b> <a id="3fc1f9dacebffd31" href="../R/3fc1f9dacebffd31.html" target="n" data-glyph="102,1" class="i property">Address</a> { <b>get</b>; }
 
        <b>public override</b> <span class="i">Task</span> <a id="b3a6a116abf9edfe" href="../R/b3a6a116abf9edfe.html" target="n" data-glyph="72,1" class="i method">CloseAsync</a>()
        {
            <b>return</b> <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#e5af25856d644abc" class="i field">link</a>.<span class="i">CloseAsync</span>();
        }
 
        <b>async</b> <span class="i">Task</span>&lt;<b>string</b>&gt; <a id="1796411d7877b547" href="../R/1796411d7877b547.html" target="n" data-glyph="76,1" class="i method">GetTokenString</a>()
        {
            <b>using</b> (<b>await</b> <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#8e482c6047f56696" class="i field">tokenLock</a>.<a href="../Primitives/AsyncLock.cs.html#9e14e77e362029c0" class="i method">LockAsync</a>().<span class="i">ConfigureAwait</span>(<b>false</b>))
            {
                <span class="c">// Expect maximum 5 minutes of clock skew between client and the service</span>
                <span class="c">// when checking for token expiry.</span>
                <b>if</b> (<a href="#c4751c591e13bf72" class="k">this</a>.<a href="#985231b6129d1517" class="i field">token</a> == <b>null</b> || <span class="i">DateTime</span>.<span class="i">UtcNow</span> &gt; <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#985231b6129d1517" class="i field">token</a>.<a href="../Primitives/SecurityToken.cs.html#780d7dbfc69db162" class="i property">ExpiresAtUtc</a>.<span class="i">Subtract</span>(<span class="i">TimeSpan</span>.<span class="i">FromMinutes</span>(5)))
                {
                    <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#985231b6129d1517" class="i field">token</a> = <b>await</b> <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#5771c67a1d2d6400" class="i field">eventHubClient</a>.<a href="AmqpEventHubClient.cs.html#ac3b7163899fc20e" class="i property">InternalTokenProvider</a>.<span class="i">GetTokenAsync</span>(
                        <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#5771c67a1d2d6400" class="i field">eventHubClient</a>.<a href="../EventHubClient.cs.html#58a8e47a06e35c53" class="i property">ConnectionStringBuilder</a>.<a href="../Primitives/EventHubsConnectionStringBuilder.cs.html#6d119b1fb797464e" class="i property">Endpoint</a>.<span class="i">AbsoluteUri</span>,
                        <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#5771c67a1d2d6400" class="i field">eventHubClient</a>.<a href="../EventHubClient.cs.html#58a8e47a06e35c53" class="i property">ConnectionStringBuilder</a>.<a href="../Primitives/EventHubsConnectionStringBuilder.cs.html#9bdfa559ce29adc5" class="i property">OperationTimeout</a>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                }
 
                <b>return</b> <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#985231b6129d1517" class="i field">token</a>.<a href="../Primitives/SecurityToken.cs.html#72f48ebd69a01203" class="i property">TokenValue</a>.<span class="i">ToString</span>();
            }
        }
 
        <b>internal void</b> <a id="bb56a584ecd07d90" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">OnAbort</a>()
        {
            <span class="i">RequestResponseAmqpLink</span> <span id="r23 rd" class="r23 r">innerLink</span>;
            <b>if</b> (<a href="#c4751c591e13bf72" class="k">this</a>.<a href="#e5af25856d644abc" class="i field">link</a>.<span class="i">TryGetOpenedObject</span>(<b>out</b> <span class="r23 r">innerLink</span>))
            {
                <span class="r23 r">innerLink</span>?.<span class="i">Abort</span>();
            }
        }
 
        <b>async</b> <span class="i">Task</span>&lt;<span class="i">RequestResponseAmqpLink</span>&gt; <a id="b6c80c1f5a1fa23b" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">OpenLinkAsync</a>(<span class="i">TimeSpan</span> <span id="r24 rd" class="r24 r">timeout</span>)
        {
            <a href="ActiveClientRequestResponseLink.cs.html#95797f0b1c50cfe9" class="t t">ActiveClientRequestResponseLink</a> <span id="r25 rd" class="r25 r">activeClientLink</span> = <b>await</b> <a href="#b9a70c07c8c91533" class="i method">OpenRequestResponseLinkAsync</a>(
                <span class="s">&quot;svc&quot;</span>, <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#3fc1f9dacebffd31" class="i property">Address</a>, <b>null</b>, <a href="#c4751c591e13bf72" class="t t">AmqpServiceClient</a>.<a href="#87efc9dfe7c22a3e" class="i field">RequiredClaims</a>, <span class="r24 r">timeout</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
            <b>return</b> <span class="r25 r">activeClientLink</span>.<a href="ActiveClientRequestResponseLink.cs.html#9e3d5898f4bb0117" class="i property">Link</a>;
        }
 
        <b>async</b> <span class="i">Task</span>&lt;<a href="ActiveClientRequestResponseLink.cs.html#95797f0b1c50cfe9" class="t t">ActiveClientRequestResponseLink</a>&gt; <a id="b9a70c07c8c91533" href="../R/b9a70c07c8c91533.html" target="n" data-glyph="76,1" class="i method">OpenRequestResponseLinkAsync</a>(
            <b>string</b> <span id="r26 rd" class="r26 r">type</span>, <b>string</b> <span id="r27 rd" class="r27 r">address</span>, <a href="../Primitives/MessagingEntityType.cs.html#1e322cb393957686" class="t t">MessagingEntityType</a>? <span id="r28 rd" class="r28 r">entityType</span>, <b>string</b>[] <span id="r29 rd" class="r29 r">requiredClaims</span>, <span class="i">TimeSpan</span> <span id="r30 rd" class="r30 r">timeout</span>)
        {
            <a href="../Primitives/TimeoutHelper.cs.html#e772a1e22bafc59c" class="k">var</a> <span id="r31 rd" class="r31 r">timeoutHelper</span> = <b>new</b> <a href="../Primitives/TimeoutHelper.cs.html#d31129aa8e684f15" class="t constructor">TimeoutHelper</a>(<span class="r30 r">timeout</span>, <b>true</b>);
            <span class="i">AmqpSession</span> <span id="r32 rd" class="r32 r">session</span> = <b>null</b>;
            <b>try</b>
            {
                <span class="c">// Don&#39;t need to get token for namespace scope operations, included in request</span>
                <b>bool</b> <span id="r33 rd" class="r33 r">isNamespaceScope</span> = <span class="r27 r">address</span>.<span class="i">Equals</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#4f7abf316a77f550" class="i field">ManagementAddress</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
 
                <b>var</b> <span id="r34 rd" class="r34 r">connection</span> = <b>await</b> <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#5771c67a1d2d6400" class="i field">eventHubClient</a>.<a href="AmqpEventHubClient.cs.html#bedb28b5969278fa" class="i property">ConnectionManager</a>.<span class="i">GetOrCreateAsync</span>(<span class="r31 r">timeoutHelper</span>.<a href="../Primitives/TimeoutHelper.cs.html#a2f50f7cc33bc27c" class="i method">RemainingTime</a>()).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                <b>var</b> <span id="r35 rd" class="r35 r">sessionSettings</span> = <b>new</b> <span class="i">AmqpSessionSettings</span> { <span class="i">Properties</span> = <b>new</b> <span class="i">Fields</span>() };
                <span class="r32 r">session</span> = <span class="r34 r">connection</span>.<span class="i">CreateSession</span>(<span class="r35 r">sessionSettings</span>);
 
                <b>await</b> <span class="r32 r">session</span>.<span class="i">OpenAsync</span>(<span class="r31 r">timeoutHelper</span>.<a href="../Primitives/TimeoutHelper.cs.html#a2f50f7cc33bc27c" class="i method">RemainingTime</a>()).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                <b>var</b> <span id="r36 rd" class="r36 r">linkSettings</span> = <b>new</b> <span class="i">AmqpLinkSettings</span>();
                <span class="r36 r">linkSettings</span>.<span class="i">AddProperty</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#dca913f95644f9ab" class="i field">TimeoutName</a>, (<b>uint</b>)<span class="r31 r">timeoutHelper</span>.<a href="../Primitives/TimeoutHelper.cs.html#a2f50f7cc33bc27c" class="i method">RemainingTime</a>().<span class="i">TotalMilliseconds</span>);
                <b>if</b> (<span class="r28 r">entityType</span> != <b>null</b>)
                {
                    <span class="r36 r">linkSettings</span>.<span class="i">AddProperty</span>(<a href="AmqpClientConstants.cs.html#c8bb1175d0499823" class="t t">AmqpClientConstants</a>.<a href="AmqpClientConstants.cs.html#bff60ab913b0c180" class="i field">EntityTypeName</a>, (<b>int</b>)<span class="r28 r">entityType</span>.<span class="i">Value</span>);
                }
 
                <span class="c">// Create the link</span>
                <b>var</b> <span id="r37 rd" class="r37 r">link</span> = <b>new</b> <span class="i">RequestResponseAmqpLink</span>(<span class="r26 r">type</span>, <span class="r32 r">session</span>, <span class="r27 r">address</span>, <span class="r36 r">linkSettings</span>.<span class="i">Properties</span>);
 
                <b>var</b> <span id="r38 rd" class="r38 r">authorizationValidToUtc</span> = <span class="i">DateTime</span>.<span class="i">MaxValue</span>;
 
                <b>if</b> (!<span class="r33 r">isNamespaceScope</span>)
                {
                    <span class="c">// TODO: Get Entity level token here</span>
                }
 
                <b>await</b> <span class="r37 r">link</span>.<span class="i">OpenAsync</span>(<span class="r31 r">timeoutHelper</span>.<a href="../Primitives/TimeoutHelper.cs.html#a2f50f7cc33bc27c" class="i method">RemainingTime</a>()).<span class="i">ConfigureAwait</span>(<b>false</b>);
 
                <span class="c">// Redirected scenario requires entityPath as the audience, otherwise we </span>
                <span class="c">// should always use the full EndpointUri as audience.</span>
                <b>return</b> <b>new</b> <span class="t">ActiveClientRequestResponseLink</span>(
                    <span class="r37 r">link</span>,
                    <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#5771c67a1d2d6400" class="i field">eventHubClient</a>.<a href="../EventHubClient.cs.html#58a8e47a06e35c53" class="i property">ConnectionStringBuilder</a>.<a href="../Primitives/EventHubsConnectionStringBuilder.cs.html#6d119b1fb797464e" class="i property">Endpoint</a>.<span class="i">AbsoluteUri</span>, <span class="c">// audience</span>
                    <a href="#c4751c591e13bf72" class="k">this</a>.<a href="#5771c67a1d2d6400" class="i field">eventHubClient</a>.<a href="../EventHubClient.cs.html#58a8e47a06e35c53" class="i property">ConnectionStringBuilder</a>.<a href="../Primitives/EventHubsConnectionStringBuilder.cs.html#6d119b1fb797464e" class="i property">Endpoint</a>.<span class="i">AbsoluteUri</span>, <span class="c">// endpointUri</span>
                    <span class="r29 r">requiredClaims</span>,
                    <b>false</b>,
                    <span class="r38 r">authorizationValidToUtc</span>);
            }
            <b>catch</b> (<span class="i">Exception</span>)
            {
                <span class="c">// Aborting the session will cleanup the link as well.</span>
                <span class="r32 r">session</span>?.<span class="i">Abort</span>();
                <b>throw</b>;
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
