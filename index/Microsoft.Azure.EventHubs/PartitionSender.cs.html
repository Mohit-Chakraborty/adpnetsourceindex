<!DOCTYPE html>
<html><head><title>PartitionSender.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(202);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.EventHubs/PartitionSender.cs" target="_top">PartitionSender.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.EventHubs" target="_top">Microsoft.Azure.EventHubs.csproj</a> (Microsoft.Azure.EventHubs)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft. All rights reserved.</span>
<span class="c">// Licensed under the MIT license. See LICENSE file in the project root for full license information.</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>
{
    <b>using</b> <span class="i">System</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Diagnostics</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Linq</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">EventHubs</span>.<span class="i n">Primitives</span>;
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This sender class is a logical representation of sending events to a specific EventHub partition. Do not use this class</span>
    <span class="c">///</span><span class="c"> if you do not care about sending events to specific partitions, instead use </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventHubClient.cs.html#ef11bbb905992f88" class="t t">EventHubClient</a>.<a href="EventHubClient.cs.html#00219a9cd9f2f271" class="i method">SendAsync</a>(<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventHubClient.cs.html#ef11bbb905992f88" class="t t">EventHubClient</a>.<a href="EventHubClient.cs.html#a34202db42c39c02" class="i method">CreatePartitionSender</a>(<b>string</b>)<span class="c">&quot;</span><span class="c">/&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventHubClient.cs.html#ef11bbb905992f88" class="t t">EventHubClient</a>.<a href="EventHubClient.cs.html#911ed71627886602" class="i method">CreateFromConnectionString</a>(<b>string</b>)<span class="c">&quot;</span><span class="c">/&gt;</span>
    <b>public sealed class</b> <a id="8b49c497c5b6a804" href="R/8b49c497c5b6a804.html" target="n" data-glyph="0,0" class="t t">PartitionSender</a> : <a href="Primitives/ClientEntity.cs.html#a0afa5cf8d7b86bf" class="t t">ClientEntity</a>
    {
        <b>internal</b> <a id="9a77ada11bd68e01" href="R/9a77ada11bd68e01.html" target="n" data-glyph="74,1" class="t constructor">PartitionSender</a>(<a href="EventHubClient.cs.html#ef11bbb905992f88" class="t t">EventHubClient</a> <span id="r0 rd" class="r0 r">eventHubClient</span>, <b>string</b> <span id="r1 rd" class="r1 r">partitionId</span>)
            : <a href="Primitives/ClientEntity.cs.html#3edb1b686f2de50f" class="k">base</a>(<span class="s">$&quot;</span>{<b>nameof</b>(<a href="#8b49c497c5b6a804" class="t t">PartitionSender</a>)}{<a href="Primitives/ClientEntity.cs.html#a0afa5cf8d7b86bf" class="t t">ClientEntity</a>.<a href="Primitives/ClientEntity.cs.html#a6bcf34c95b5621e" class="i method">GetNextId</a>()}<span class="s">(</span>{<span class="r0 r">eventHubClient</span>.<a href="EventHubClient.cs.html#cb2687894300e685" class="i property">EventHubName</a>}<span class="s">,</span>{<span class="r1 r">partitionId</span>}<span class="s">)</span><span class="s">&quot;</span>)
        {
            <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#03a4e908ed6de67c" class="i property">EventHubClient</a> = <span class="r0 r">eventHubClient</span>;
            <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#57445131716865c7" class="i property">PartitionId</a> = <span class="r1 r">partitionId</span>;
            <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#d02751ac658ec81f" class="i property">InnerSender</a> = <span class="r0 r">eventHubClient</span>.<a href="EventHubClient.cs.html#b02b938c80b42898" class="i method">CreateEventSender</a>(<span class="r1 r">partitionId</span>);
            <span class="r0 r">eventHubClient</span>.<a href="EventHubClient.cs.html#de8952fb7dd3c8fb" class="i method">AddChildEntity</a>(<a href="#8b49c497c5b6a804" class="k">this</a>);
            <a href="EventHubsEventSource.cs.html#a8d90a446db9f305" class="t t">EventHubsEventSource</a>.<a href="EventHubsEventSource.cs.html#876999de01c1c51a" class="i property">Log</a>.<a href="EventHubsEventSource.cs.html#cd961c51848920ed" class="i method">ClientCreated</a>(<a href="#8b49c497c5b6a804" class="k">this</a>.<a href="Primitives/ClientEntity.cs.html#5b2ded861d3b6cd6" class="i property">ClientId</a>, <b>null</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#03a4e908ed6de67c" class="i property">EventHubClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> associated with this PartitionSender.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="EventHubClient.cs.html#ef11bbb905992f88" class="t t">EventHubClient</a> <a id="03a4e908ed6de67c" href="R/03a4e908ed6de67c.html" target="n" data-glyph="102,1" class="i property">EventHubClient</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the partition ID for this </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#8b49c497c5b6a804" class="t t">PartitionSender</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="57445131716865c7" href="R/57445131716865c7.html" target="n" data-glyph="102,1" class="i property">PartitionId</a> { <b>get</b>; }
 
        <a href="EventDataSender.cs.html#e258527873f12d05" class="t t">EventDataSender</a> <a id="d02751ac658ec81f" href="R/d02751ac658ec81f.html" target="n" data-glyph="106,1" class="i property">InnerSender</a> { <b>get</b>; }
 
        <b>object</b> <a id="d4379087f764d6ad" href="R/../../0000000000.html" target="n" data-glyph="106,1" class="i property">ThisLock</a> { <b>get</b>; } = <b>new</b> <b>object</b>();
 
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Creates a batch where event data objects can be added for later SendAsync call.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Returns </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventDataBatch.cs.html#3d69be77480a8202" class="t t">EventDataBatch</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public</b> <a href="EventDataBatch.cs.html#3d69be77480a8202" class="t t">EventDataBatch</a> <a id="559117386ed6d37a" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CreateBatch</a>()
        {
            <b>return</b> <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#c7830a7ab3226a7b" class="i method">CreateBatch</a>(<b>new</b> <span class="t">BatchOptions</span>());
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Creates a batch where event data objects can be added for later SendAsync call.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="BatchOptions.cs.html#c6675183874cbefc" class="t t">BatchOptions</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> to define partition key and max message size.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Returns </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventDataBatch.cs.html#3d69be77480a8202" class="t t">EventDataBatch</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public</b> <a href="EventDataBatch.cs.html#3d69be77480a8202" class="t t">EventDataBatch</a> <a id="c7830a7ab3226a7b" href="R/c7830a7ab3226a7b.html" target="n" data-glyph="72,1" class="i method">CreateBatch</a>(<a href="BatchOptions.cs.html#c6675183874cbefc" class="t t">BatchOptions</a> <span id="r2 rd" class="r2 r">options</span>)
        {
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrWhiteSpace</span>(<span class="r2 r">options</span>.<a href="BatchOptions.cs.html#bf2a27c161dfaf08" class="i property">PartitionKey</a>))
            {
                <b>throw</b> <a href="Primitives/Fx.cs.html#b0aa19c5eed5b9f5" class="t t">Fx</a>.<a href="Primitives/Fx.cs.html#0460fd9e6943b44f" class="i property">Exception</a>.<a href="Primitives/ExceptionUtility.cs.html#9211c429efc34d3f" class="i method">InvalidOperation</a>(<a href="Resources.Designer.cs.html#384a7f500795c32f" class="t t">Resources</a>.<a href="Resources.Designer.cs.html#e4ce91940086059f" class="i property">PartitionSenderInvalidWithPartitionKeyOnBatch</a>);
            }
 
            <b>return</b> <b>new</b> <a href="EventDataBatch.cs.html#38df2bf345874ae5" class="t constructor">EventDataBatch</a>(<span class="r2 r">options</span>.<a href="BatchOptions.cs.html#6cbe5e4726166030" class="i property">MaxMessageSize</a> &gt; 0 ? <span class="r2 r">options</span>.<a href="BatchOptions.cs.html#6cbe5e4726166030" class="i property">MaxMessageSize</a> : <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#d02751ac658ec81f" class="i property">InnerSender</a>.<a href="EventDataSender.cs.html#07d507543a06f9ed" class="i property">MaxMessageSize</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to a specific EventHub partition. The target partition is pre-determined when this PartitionSender was created.</span>
        <span class="c">///</span><span class="c"> This send pattern emphasizes data correlation over general availability and latency.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">There are 3 ways to send to EventHubs, each exposed as a method (along with its sendBatch overload):</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">i.   </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventHubClient.cs.html#ef11bbb905992f88" class="t t">EventHubClient</a>.<a href="EventHubClient.cs.html#00219a9cd9f2f271" class="i method">SendAsync</a>(<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> or </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventHubClient.cs.html#ef11bbb905992f88" class="t t">EventHubClient</a>.<a href="EventHubClient.cs.html#6c0e18e526254b39" class="i method">SendAsync</a>(<span class="i">IEnumerable</span>{<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>})<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">ii.  </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventHubClient.cs.html#ef11bbb905992f88" class="t t">EventHubClient</a>.<a href="EventHubClient.cs.html#0b53ca1caa8621f5" class="i method">SendAsync</a>(<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>, <b>string</b>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> or </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventHubClient.cs.html#ef11bbb905992f88" class="t t">EventHubClient</a>.<a href="EventHubClient.cs.html#3ca405ef5b5a7822" class="i method">SendAsync</a>(<span class="i">IEnumerable</span>{<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>}, <b>string</b>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">iii. </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#8b49c497c5b6a804" class="t t">PartitionSender</a>.<a href="#b4ee49640a828c2c" class="i method">SendAsync</a>(<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> or </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#8b49c497c5b6a804" class="t t">PartitionSender</a>.<a href="#26d830498add0551" class="i method">SendAsync</a>(<span class="i">IEnumerable</span>{<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>})<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Use this type of send if:</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">a. The client wants to take direct control of distribution of data across partitions. In this case client is responsible for making sure there is at least one sender per event hub partition.</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">b. User cannot use partition key as a mean to direct events to specific partition, yet there is a need for data correlation with partitioning scheme.</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">eventData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to be sent.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A Task that completes when the send operations is done.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="Primitives/MessageSizeExceededException.cs.html#718c51e6758e6953" class="t t">MessageSizeExceededException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">the total size of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> exceeds a pre-defined limit set by the service. Default is 256k bytes.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="Primitives/EventHubsException.cs.html#8b9817f4bb66b95f" class="t t">EventHubsException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Event Hubs service encountered problems during the operation.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">Task</span> <a id="b4ee49640a828c2c" href="R/b4ee49640a828c2c.html" target="n" data-glyph="72,1" class="i method">SendAsync</a>(<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a> <span id="r3 rd" class="r3 r">eventData</span>)
        {
            <a href="Primitives/Guard.cs.html#b565701b95b9c8b9" class="t t">Guard</a>.<a href="Primitives/Guard.cs.html#5e02d3d43dcbe30a" class="i method">ArgumentNotNull</a>(<b>nameof</b>(<span class="r3 r">eventData</span>), <span class="r3 r">eventData</span>);
            <b>return</b> <a href="#8b49c497c5b6a804" class="k">this</a>.<span class="i">SendAsync</span>(<b>new</b>[] { <span class="r3 r">eventData</span> });
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to a specific EventHub partition. The targeted partition is pre-determined when this PartitionSender was created.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> There are 3 ways to send to EventHubs, to understand this particular type of send refer to the overload </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#b4ee49640a828c2c" class="i method">SendAsync</a>(<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">, which is the same type of send and is used to send single </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sending a batch of </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">&#39;s is useful in the following cases:</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">i.    Efficient send - sending a batch of </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> maximizes the overall throughput by optimally using the number of sessions created to EventHubs&#39; service.</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">para</span><span class="c">&gt;</span><span class="c">ii.   Sending multiple </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">&#39;s in a Transaction. To acheive ACID properties, the Gateway Service will forward all </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">&#39;s in the batch to a single EventHub partition.</span><span class="c">&lt;/</span><span class="c">para</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">example</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sample code:</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> EventHubClient client = EventHubClient.Create(&quot;__connectionString__&quot;);</span>
        <span class="c">///</span><span class="c"> PartitionSender senderToPartitionOne = client.CreatePartitionSender(&quot;1&quot;);</span>
        <span class="c">///</span><span class="c">         </span>
        <span class="c">///</span><span class="c"> while (true)</span>
        <span class="c">///</span><span class="c"> {</span>
        <span class="c">///</span><span class="c">     var events = new List</span><span class="c">&amp;lt;</span><span class="c">EventData</span><span class="c">&amp;gt;</span><span class="c">();</span>
        <span class="c">///</span><span class="c">     for (int count = 1; count </span><span class="c">&amp;lt;</span><span class="c"> 11; count++)</span>
        <span class="c">///</span><span class="c">     {</span>
        <span class="c">///</span><span class="c">         var payload = new PayloadEvent(count);</span>
        <span class="c">///</span><span class="c">         byte[] payloadBytes = Encoding.UTF8.GetBytes(JsonConvert.SerializeObject(payload));</span>
        <span class="c">///</span><span class="c">         var sendEvent = new EventData(payloadBytes);</span>
        <span class="c">///</span><span class="c">         var applicationProperties = new Dictionary</span><span class="c">&amp;lt;</span><span class="c">string, string</span><span class="c">&amp;gt;</span><span class="c">();</span>
        <span class="c">///</span><span class="c">         applicationProperties[&quot;from&quot;] = &quot;csharpClient&quot;;</span>
        <span class="c">///</span><span class="c">         sendEvent.Properties = applicationProperties;</span>
        <span class="c">///</span><span class="c">         events.Add(sendEvent);</span>
        <span class="c">///</span><span class="c">     }</span>
        <span class="c">///</span><span class="c">         </span>
        <span class="c">///</span><span class="c">     await senderToPartitionOne.SendAsync(events);</span>
        <span class="c">///</span><span class="c">     Console.WriteLine(&quot;Sent Batch... Size: {0}&quot;, events.Count);</span>
        <span class="c">///</span><span class="c">     </span>
        <span class="c">///</span><span class="c"> }</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">example</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">eventDatas</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">batch of events to send to EventHub</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">a Task that completes when the send operation is done.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="Primitives/MessageSizeExceededException.cs.html#718c51e6758e6953" class="t t">MessageSizeExceededException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">the total size of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> exceeds a pre-defined limit set by the service. Default is 256k bytes.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="Primitives/EventHubsException.cs.html#8b9817f4bb66b95f" class="t t">EventHubsException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Event Hubs service encountered problems during the operation.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public async</b> <span class="i">Task</span> <a id="26d830498add0551" href="R/26d830498add0551.html" target="n" data-glyph="72,1" class="i method">SendAsync</a>(<span class="i">IEnumerable</span>&lt;<a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a>&gt; <span id="r4 rd" class="r4 r">eventDatas</span>)
        {
            <a href="Primitives/Guard.cs.html#b565701b95b9c8b9" class="t t">Guard</a>.<span class="i">ArgumentNotNull</span>(<b>nameof</b>(<span class="r4 r">eventDatas</span>), <span class="r4 r">eventDatas</span>);
            <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="Primitives/ClientEntity.cs.html#c3517d421bd9e8cb" class="i method">ThrowIfClosed</a>();
 
            <b>if</b> (<span class="r4 r">eventDatas</span> <b>is</b> <a href="EventDataBatch.cs.html#3d69be77480a8202" class="t t">EventDataBatch</a> &amp;&amp; !<b>string</b>.<span class="i">IsNullOrEmpty</span>(((<a href="EventDataBatch.cs.html#3d69be77480a8202" class="t t">EventDataBatch</a>)<span class="r4 r">eventDatas</span>).<a href="EventDataBatch.cs.html#8a995bc51e506a2f" class="i property">PartitionKey</a>))
            {
                <b>throw</b> <a href="Primitives/Fx.cs.html#b0aa19c5eed5b9f5" class="t t">Fx</a>.<a href="Primitives/Fx.cs.html#0460fd9e6943b44f" class="i property">Exception</a>.<a href="Primitives/ExceptionUtility.cs.html#9211c429efc34d3f" class="i method">InvalidOperation</a>(<a href="Resources.Designer.cs.html#384a7f500795c32f" class="t t">Resources</a>.<a href="Resources.Designer.cs.html#e4ce91940086059f" class="i property">PartitionSenderInvalidWithPartitionKeyOnBatch</a>);
            }
 
            <span class="c">// Convert enumerator to a rescannable collection to avoid skipping events if underlying enumerator is not re-scannabled.</span>
            <b>var</b> <span id="r5 rd" class="r5 r">eventDataList</span> = <span class="r4 r">eventDatas</span>?.<span class="i">ToList</span>();
 
            <b>int</b> <span id="r6 rd" class="r6 r">count</span> = <a href="EventDataSender.cs.html#e258527873f12d05" class="t t">EventDataSender</a>.<span class="i">ValidateEvents</span>(<span class="r5 r">eventDataList</span>);
            <a href="EventHubsEventSource.cs.html#a8d90a446db9f305" class="t t">EventHubsEventSource</a>.<a href="EventHubsEventSource.cs.html#876999de01c1c51a" class="i property">Log</a>.<a href="EventHubsEventSource.cs.html#a0311132dcfe86da" class="i method">EventSendStart</a>(<a href="#8b49c497c5b6a804" class="k">this</a>.<a href="Primitives/ClientEntity.cs.html#5b2ded861d3b6cd6" class="i property">ClientId</a>, <span class="r6 r">count</span>, <b>null</b>);
            <span class="i">Activity</span> <span id="r7 rd" class="r7 r">activity</span> = <a href="EventHubsDiagnosticSource.cs.html#75bd91bbbfd82c87" class="t t">EventHubsDiagnosticSource</a>.<span class="i">StartSendActivity</span>(<a href="#8b49c497c5b6a804" class="k">this</a>.<a href="Primitives/ClientEntity.cs.html#5b2ded861d3b6cd6" class="i property">ClientId</a>, <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#03a4e908ed6de67c" class="i property">EventHubClient</a>.<a href="EventHubClient.cs.html#58a8e47a06e35c53" class="i property">ConnectionStringBuilder</a>, <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#57445131716865c7" class="i property">PartitionId</a>, <span class="r5 r">eventDataList</span>, <span class="r6 r">count</span>);
 
            <span class="i">Task</span> <span id="r8 rd" class="r8 r">sendTask</span> = <b>null</b>;
            <b>try</b>
            {
                <span class="r8 r">sendTask</span> = <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#d02751ac658ec81f" class="i property">InnerSender</a>.<span class="i">SendAsync</span>(<span class="r5 r">eventDataList</span>, <b>null</b>);
                <b>await</b> <span class="r8 r">sendTask</span>.<span class="i">ConfigureAwait</span>(<b>false</b>);
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r9 rd" class="r9 r">exception</span>)
            {
                <a href="EventHubsEventSource.cs.html#a8d90a446db9f305" class="t t">EventHubsEventSource</a>.<a href="EventHubsEventSource.cs.html#876999de01c1c51a" class="i property">Log</a>.<span class="i">EventSendException</span>(<a href="#8b49c497c5b6a804" class="k">this</a>.<a href="Primitives/ClientEntity.cs.html#5b2ded861d3b6cd6" class="i property">ClientId</a>, <span class="r9 r">exception</span>.<span class="i">ToString</span>());
                <a href="EventHubsDiagnosticSource.cs.html#75bd91bbbfd82c87" class="t t">EventHubsDiagnosticSource</a>.<span class="i">FailSendActivity</span>(<span class="r7 r">activity</span>, <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#03a4e908ed6de67c" class="i property">EventHubClient</a>.<a href="EventHubClient.cs.html#58a8e47a06e35c53" class="i property">ConnectionStringBuilder</a>, <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#57445131716865c7" class="i property">PartitionId</a>, <span class="r5 r">eventDataList</span>, <span class="r9 r">exception</span>);
                <b>throw</b>;
            }
            <b>finally</b>
            {
                <a href="EventHubsEventSource.cs.html#a8d90a446db9f305" class="t t">EventHubsEventSource</a>.<a href="EventHubsEventSource.cs.html#876999de01c1c51a" class="i property">Log</a>.<a href="EventHubsEventSource.cs.html#0d6d65645c39a8f5" class="i method">EventSendStop</a>(<a href="#8b49c497c5b6a804" class="k">this</a>.<a href="Primitives/ClientEntity.cs.html#5b2ded861d3b6cd6" class="i property">ClientId</a>);
                <a href="EventHubsDiagnosticSource.cs.html#75bd91bbbfd82c87" class="t t">EventHubsDiagnosticSource</a>.<span class="i">StopSendActivity</span>(<span class="r7 r">activity</span>, <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#03a4e908ed6de67c" class="i property">EventHubClient</a>.<a href="EventHubClient.cs.html#58a8e47a06e35c53" class="i property">ConnectionStringBuilder</a>, <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#57445131716865c7" class="i property">PartitionId</a>, <span class="r5 r">eventDataList</span>, <span class="r8 r">sendTask</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send a batch of </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventData.cs.html#f56ed6e805f7061b" class="t t">EventData</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> in </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="EventDataBatch.cs.html#3d69be77480a8202" class="t t">EventDataBatch</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">eventDataBatch</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">the batch of events to send to EventHub</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A Task that completes when the send operation is done.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public async</b> <span class="i">Task</span> <a id="4f6d5d8a0ab5027c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SendAsync</a>(<a href="EventDataBatch.cs.html#3d69be77480a8202" class="t t">EventDataBatch</a> <span id="r10 rd" class="r10 r">eventDataBatch</span>)
        {
            <b>if</b> (<span class="r10 r">eventDataBatch</span> == <b>null</b>)
            {
                <b>throw</b> <a href="Primitives/Fx.cs.html#b0aa19c5eed5b9f5" class="t t">Fx</a>.<a href="Primitives/Fx.cs.html#0460fd9e6943b44f" class="i property">Exception</a>.<a href="Primitives/ExceptionUtility.cs.html#8b38f50ea2ff74a3" class="i method">Argument</a>(<b>nameof</b>(<span class="r10 r">eventDataBatch</span>), <a href="Resources.Designer.cs.html#384a7f500795c32f" class="t t">Resources</a>.<a href="Resources.Designer.cs.html#217396eb8b052af2" class="i property">EventDataListIsNullOrEmpty</a>);
            }
 
            <b>if</b> (<span class="r10 r">eventDataBatch</span>.<a href="EventDataBatch.cs.html#8a995bc51e506a2f" class="i property">PartitionKey</a> != <b>null</b>)
            {
                <b>throw</b> <a href="Primitives/Fx.cs.html#b0aa19c5eed5b9f5" class="t t">Fx</a>.<a href="Primitives/Fx.cs.html#0460fd9e6943b44f" class="i property">Exception</a>.<a href="Primitives/ExceptionUtility.cs.html#9211c429efc34d3f" class="i method">InvalidOperation</a>(<a href="Resources.Designer.cs.html#384a7f500795c32f" class="t t">Resources</a>.<a href="Resources.Designer.cs.html#e4ce91940086059f" class="i property">PartitionSenderInvalidWithPartitionKeyOnBatch</a>);
            }
 
            <b>await</b> <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#26d830498add0551" class="i method">SendAsync</a>(<span class="r10 r">eventDataBatch</span>.<a href="EventDataBatch.cs.html#d81c9036ddec804d" class="i method">ToEnumerable</a>()).<span class="i">ConfigureAwait</span>(<b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes and releases resources for the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#8b49c497c5b6a804" class="t t">PartitionSender</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An asynchronous operation</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public override async</b> <span class="i">Task</span> <a id="3047ba6cc2c1461f" href="R/3047ba6cc2c1461f.html" target="n" data-glyph="72,1" class="i method">CloseAsync</a>()
        {
            <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="Primitives/ClientEntity.cs.html#136db9d3ec1ba014" class="i property">IsClosed</a> = <b>true</b>;
 
            <a href="EventHubsEventSource.cs.html#a8d90a446db9f305" class="t t">EventHubsEventSource</a>.<a href="EventHubsEventSource.cs.html#876999de01c1c51a" class="i property">Log</a>.<a href="EventHubsEventSource.cs.html#a34b011175a3b474" class="i method">ClientCloseStart</a>(<a href="#8b49c497c5b6a804" class="k">this</a>.<a href="Primitives/ClientEntity.cs.html#5b2ded861d3b6cd6" class="i property">ClientId</a>);
            <b>try</b>
            {
                <b>await</b> <a href="#8b49c497c5b6a804" class="k">this</a>.<a href="#d02751ac658ec81f" class="i property">InnerSender</a>.<a href="Primitives/ClientEntity.cs.html#9b71183983a05ff2" class="i method">CloseAsync</a>().<span class="i">ConfigureAwait</span>(<b>false</b>);
            }
            <b>finally</b>
            {
                <a href="EventHubsEventSource.cs.html#a8d90a446db9f305" class="t t">EventHubsEventSource</a>.<a href="EventHubsEventSource.cs.html#876999de01c1c51a" class="i property">Log</a>.<a href="EventHubsEventSource.cs.html#202ca0152c385c25" class="i method">ClientCloseStop</a>(<a href="#8b49c497c5b6a804" class="k">this</a>.<a href="Primitives/ClientEntity.cs.html#5b2ded861d3b6cd6" class="i property">ClientId</a>);
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
