<!DOCTYPE html>
<html><head><title>ServiceBusMessageBatch.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(176);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Messaging.ServiceBus/Sender/ServiceBusMessageBatch.cs" target="_top">Sender\ServiceBusMessageBatch.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Messaging.ServiceBus" target="_top">Azure.Messaging.ServiceBus.csproj</a> (Azure.Messaging.ServiceBus)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">ServiceBus</span>.<span class="i n">Core</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">ServiceBus</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c">   A set of </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Primitives/ServiceBusMessage.cs.html#55f40903fe7b78d8" class="t t">ServiceBusMessage</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> with size constraints known up-front,</span>
    <span class="c">///</span><span class="c">   intended to be sent to the Queue/Topic as a single batch.</span>
    <span class="c">///</span><span class="c">   A </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#31077058165fc40f" class="t t">ServiceBusMessageBatch</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> can be created using</span>
    <span class="c">///</span><span class="c">   </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ServiceBusSender.cs.html#565d94b474d31465" class="t t">ServiceBusSender</a>.<a href="ServiceBusSender.cs.html#2a4fb351785793f7" class="i method">CreateMessageBatchAsync</a>(<span class="i n">System</span>.<span class="i n">Threading</span>.<a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
    <span class="c">///</span><span class="c">   Messages can be added to the batch using the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#6680c7a85fc9d380" class="i method">TryAddMessage</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> method on the batch.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span>
    <b>public sealed class</b> <a id="31077058165fc40f" href="../R/31077058165fc40f.html" target="n" data-glyph="0,0" class="t t">ServiceBusMessageBatch</a> : <a href="@1@netstandard/A.html#1f55292c3174123d" class="t t">IDisposable</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">An object instance to use as the synchronization root for ensuring the thread-safety of operations.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly object</b> <a id="626059229a80ab31" href="../R/626059229a80ab31.html" target="n" data-glyph="46,1" class="i field">_syncGuard</a> = <b>new</b> <b>object</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">A flag indicating that the batch is locked, such as when in use during a send batch operation.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="2212c6b6b059af97" href="../R/2212c6b6b059af97.html" target="n" data-glyph="46,1" class="i field">_locked</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The maximum size allowed for the batch, in bytes.  This includes the messages in the batch as</span>
        <span class="c">///</span><span class="c">   well as any overhead for the batch itself when sent to the Queue/Topic.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public long</b> <a id="048d3e400b9294b0" href="../R/048d3e400b9294b0.html" target="n" data-glyph="102,1" class="i property">MaxSizeInBytes</a> =&gt; <a href="#ab3aa61257a3250a" class="i property">InnerBatch</a>.<a href="../Core/TransportMessageBatch.cs.html#09bae8752f138c25" class="i property">MaxSizeInBytes</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The size of the batch, in bytes, as it will be sent to the Queue/Topic.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public long</b> <a id="29a8ec13705d19f8" href="../R/29a8ec13705d19f8.html" target="n" data-glyph="102,1" class="i property">SizeInBytes</a> =&gt; <a href="#ab3aa61257a3250a" class="i property">InnerBatch</a>.<a href="../Core/TransportMessageBatch.cs.html#0cf6a31c58c99b01" class="i property">SizeInBytes</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The count of messages contained in the batch.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public int</b> <a id="a015ed58451e00a1" href="../R/a015ed58451e00a1.html" target="n" data-glyph="102,1" class="i property">Count</a> =&gt; <a href="#ab3aa61257a3250a" class="i property">InnerBatch</a>.<a href="../Core/TransportMessageBatch.cs.html#1c77a12f311ad12e" class="i property">Count</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The transport-specific batch responsible for performing the batch operations</span>
        <span class="c">///</span><span class="c">   in a manner compatible with the associated </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Core/TransportSender.cs.html#c54f19921ea3dbe2" class="t t">TransportSender</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>private</b> <a href="../Core/TransportMessageBatch.cs.html#3b59283f63988656" class="t t">TransportMessageBatch</a> <a id="ab3aa61257a3250a" href="../R/ab3aa61257a3250a.html" target="n" data-glyph="106,1" class="i property">InnerBatch</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#31077058165fc40f" class="t t">ServiceBusMessageBatch</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">transportBatch</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The  transport-specific batch responsible for performing the batch operations.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   As an internal type, this class performs only basic sanity checks against its arguments.  It</span>
        <span class="c">///</span><span class="c">   is assumed that callers are trusted and have performed deep validation.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">   Any parameters passed are assumed to be owned by this instance and safe to mutate or dispose;</span>
        <span class="c">///</span><span class="c">   creation of clones or otherwise protecting the parameters is assumed to be the purview of the</span>
        <span class="c">///</span><span class="c">   caller.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>internal</b> <a id="4a3c407b80a094ef" href="../R/4a3c407b80a094ef.html" target="n" data-glyph="74,1" class="t constructor">ServiceBusMessageBatch</a>(<a href="../Core/TransportMessageBatch.cs.html#3b59283f63988656" class="t t">TransportMessageBatch</a> <span id="r0 rd" class="r0 r">transportBatch</span>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#208d023d6fa23d33" class="i method">AssertNotNull</a>(<span class="r0 r">transportBatch</span>, <b>nameof</b>(<span class="r0 r">transportBatch</span>));
            <a href="#ab3aa61257a3250a" class="i property">InnerBatch</a> = <span class="r0 r">transportBatch</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Attempts to add a message to the batch, ensuring that the size</span>
        <span class="c">///</span><span class="c">   of the batch does not exceed its maximum.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The message to attempt to add to the batch.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if the message was added; otherwise, </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="@1@netstandard/A.html#beac22dfca574cd4" class="t t">InvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   When a batch is sent, it will be locked for the duration of that operation.  During this time,</span>
        <span class="c">///</span><span class="c">   no messages may be added to the batch.  Calling </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">TryAdd</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> while the batch is being sent will</span>
        <span class="c">///</span><span class="c">   result in an </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="@1@netstandard/A.html#beac22dfca574cd4" class="t t">InvalidOperationException</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> until the send has completed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public bool</b> <a id="6680c7a85fc9d380" href="../R/6680c7a85fc9d380.html" target="n" data-glyph="72,1" class="i method">TryAddMessage</a>(<a href="../Primitives/ServiceBusMessage.cs.html#55f40903fe7b78d8" class="t t">ServiceBusMessage</a> <span id="r1 rd" class="r1 r">message</span>)
        {
            <b>lock</b> (<a href="#626059229a80ab31" class="i field">_syncGuard</a>)
            {
                <a href="#d84ba26051c06447" class="i method">AssertNotLocked</a>();
                <b>return</b> <a href="#ab3aa61257a3250a" class="i property">InnerBatch</a>.<a href="../Core/TransportMessageBatch.cs.html#654ee71142e5bb04" class="i method">TryAddMessage</a>(<span class="r1 r">message</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Performs the task needed to clean up resources used by the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#31077058165fc40f" class="t t">ServiceBusMessageBatch</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>public void</b> <a id="cf5cb093a7d37b83" href="../R/cf5cb093a7d37b83.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <b>lock</b> (<a href="#626059229a80ab31" class="i field">_syncGuard</a>)
            {
                <a href="#d84ba26051c06447" class="i method">AssertNotLocked</a>();
                <a href="#ab3aa61257a3250a" class="i property">InnerBatch</a>.<a href="../Core/TransportMessageBatch.cs.html#f68c817bf0cffbfc" class="i method">Dispose</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Clears the batch, removing all messages and resetting the</span>
        <span class="c">///</span><span class="c">   available size.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>internal void</b> <a id="81738b3ff8d43a4c" href="../R/81738b3ff8d43a4c.html" target="n" data-glyph="74,1" class="i method">Clear</a>()
        {
            <b>lock</b> (<a href="#626059229a80ab31" class="i field">_syncGuard</a>)
            {
                <a href="#d84ba26051c06447" class="i method">AssertNotLocked</a>();
                <a href="#ab3aa61257a3250a" class="i property">InnerBatch</a>.<a href="../Core/TransportMessageBatch.cs.html#2ca18496d3cc7bfc" class="i method">Clear</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Represents the batch as an enumerable set of specific representations of a message.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">typeparam</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r t">T</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The specific message representation being requested.</span><span class="c">&lt;/</span><span class="c">typeparam</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The set of messages as an enumerable of the requested type.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>internal</b> <a href="@1@netstandard/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<span class="r2 r t">T</span>&gt; <a id="5670e8d78393f8b9" href="../R/5670e8d78393f8b9.html" target="n" data-glyph="74,1" class="i method">AsEnumerable</a>&lt;<span id="r2 rd t" class="r2 r t">T</span>&gt;() =&gt; <a href="#ab3aa61257a3250a" class="i property">InnerBatch</a>.<a href="../Core/TransportMessageBatch.cs.html#1648d6247ae40c43" class="i method">AsEnumerable</a>&lt;<span class="r2 r t">T</span>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Locks the batch to prevent new messages from being added while a service</span>
        <span class="c">///</span><span class="c">   operation is active.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>internal void</b> <a id="83ae400673384596" href="../R/83ae400673384596.html" target="n" data-glyph="74,1" class="i method">Lock</a>()
        {
            <b>lock</b> (<a href="#626059229a80ab31" class="i field">_syncGuard</a>)
            {
                <a href="#2212c6b6b059af97" class="i field">_locked</a> = <b>true</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Unlocks the batch, allowing new messages to be added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>internal void</b> <a id="f9bb92bd49850f53" href="../R/f9bb92bd49850f53.html" target="n" data-glyph="74,1" class="i method">Unlock</a>()
        {
            <b>lock</b> (<a href="#626059229a80ab31" class="i field">_syncGuard</a>)
            {
                <a href="#2212c6b6b059af97" class="i field">_locked</a> = <b>false</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Validates that the batch is not in a locked state, triggering an</span>
        <span class="c">///</span><span class="c">   invalid operation if it is.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="@1@netstandard/A.html#beac22dfca574cd4" class="t t">InvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Occurs when the batch is locked.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <b>private void</b> <a id="d84ba26051c06447" href="../R/d84ba26051c06447.html" target="n" data-glyph="76,1" class="i method">AssertNotLocked</a>()
        {
            <b>if</b> (<a href="#2212c6b6b059af97" class="i field">_locked</a>)
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#21a14239251047c2" class="i property">MessageBatchIsLocked</a>);
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
