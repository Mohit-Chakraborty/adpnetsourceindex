<!DOCTYPE html>
<html><head><title>ServiceBusProcessor.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(745);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Messaging.ServiceBus/Processor/ServiceBusProcessor.cs" target="_top">Processor\ServiceBusProcessor.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Messaging.ServiceBus" target="_top">src\Azure.Messaging.ServiceBus.csproj</a> (Azure.Messaging.ServiceBus)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i">System</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i">System</span>.<span class="i">ComponentModel</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Threading</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">ServiceBus</span>.<span class="i n">Core</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">ServiceBus</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">ServiceBus</span>.<span class="i n">Plugins</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Messaging</span>.<span class="i n">ServiceBus</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> The </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#53f32235bf319489" class="t t">ServiceBusProcessor</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> provides an abstraction around a set of </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Receiver/ServiceBusReceiver.cs.html#2224f17dabcb26c3" class="t t">ServiceBusReceiver</a><span class="c">&quot;</span><span class="c">/&gt;</span>
    <span class="c">///</span><span class="c"> that allows using an event based model for processing received </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Primitives/ServiceBusReceivedMessage.cs.html#347e87fb652ef164" class="t t">ServiceBusReceivedMessage</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">.</span>
    <span class="c">///</span><span class="c"> It is constructed by calling </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Client/ServiceBusClient.cs.html#ad46ff0588c85077" class="t t">ServiceBusClient</a>.<a href="../Client/ServiceBusClient.cs.html#e88d31494c5ac451" class="i method">CreateProcessor</a>(<b>string</b>, <a href="ServiceBusProcessorOptions.cs.html#3ee0705bcc32cc6b" class="t t">ServiceBusProcessorOptions</a>)<span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
    <span class="c">///</span><span class="c"> The message handler is specified with the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#6f26a2b2eb22920d" class="i">ProcessMessageAsync</a><span class="c">&quot;</span><span class="c">/&gt;</span>
    <span class="c">///</span><span class="c"> property. The error handler is specified with the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#3c7d5830cb3c7e5a" class="i">ProcessErrorAsync</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> property.</span>
    <span class="c">///</span><span class="c"> To start processing after the handlers have been specified, call </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#20feb1e36486f404" class="i method">StartProcessingAsync</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">CA1001</span> <span class="c">// Types that own disposable fields should be disposable</span>
    <b>public class</b> <a id="53f32235bf319489" href="../R/53f32235bf319489.html" target="n" data-glyph="0,0" class="t t">ServiceBusProcessor</a> : <span class="i">IAsyncDisposable</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> <span class="i">CA1001</span> <span class="c">// Types that own disposable fields should be disposable</span>
    {
        <b>private</b> <span class="i">Func</span>&lt;<a href="ProcessMessageEventArgs.cs.html#ab6a0d7f27cb1284" class="t t">ProcessMessageEventArgs</a>, <span class="i">Task</span>&gt; <a id="01388bef07dc39c6" href="../R/01388bef07dc39c6.html" target="n" data-glyph="46,1" class="i field">_processMessageAsync</a>;
 
        <b>private</b> <span class="i">Func</span>&lt;<a href="ProcessSessionMessageEventArgs.cs.html#7ed608712705605f" class="t t">ProcessSessionMessageEventArgs</a>, <span class="i">Task</span>&gt; <a id="9b3ae8f7153cd5c6" href="../R/9b3ae8f7153cd5c6.html" target="n" data-glyph="46,1" class="i field">_processSessionMessageAsync</a>;
 
        <b>private</b> <span class="i">Func</span>&lt;<a href="ProcessErrorEventArgs.cs.html#6d0ae56c469cb1ba" class="t t">ProcessErrorEventArgs</a>, <span class="i">Task</span>&gt; <a id="4adf9cdb3a13fb8d" href="../R/4adf9cdb3a13fb8d.html" target="n" data-glyph="46,1" class="i field">_processErrorAsync</a>;
 
        <b>private</b> <span class="i">Func</span>&lt;<a href="ProcessSessionEventArgs.cs.html#833b7a9c2dde6645" class="t t">ProcessSessionEventArgs</a>, <span class="i">Task</span>&gt; <a id="fcdf61880c92645a" href="../R/fcdf61880c92645a.html" target="n" data-glyph="46,1" class="i field">_sessionInitializingAsync</a>;
 
        <b>private</b> <span class="i">Func</span>&lt;<a href="ProcessSessionEventArgs.cs.html#833b7a9c2dde6645" class="t t">ProcessSessionEventArgs</a>, <span class="i">Task</span>&gt; <a id="fd25e357813f1523" href="../R/fd25e357813f1523.html" target="n" data-glyph="46,1" class="i field">_sessionClosingAsync</a>;
 
        <b>private readonly</b> <span class="i">SemaphoreSlim</span> <a id="b855c0765a548b8d" href="../R/b855c0765a548b8d.html" target="n" data-glyph="46,1" class="i field">_messageHandlerSemaphore</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The primitive for ensuring that the service is not overloaded with</span>
        <span class="c">///</span><span class="c"> accept session requests.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <span class="i">SemaphoreSlim</span> <a id="e79f05add880a9cd" href="../R/e79f05add880a9cd.html" target="n" data-glyph="106,1" class="i property">MaxConcurrentAcceptSessionsSemaphore</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">The primitive for synchronizing access during start and close operations.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="i">SemaphoreSlim</span> <a id="2145abf80f6a4c2d" href="../R/2145abf80f6a4c2d.html" target="n" data-glyph="46,1" class="i field">_processingStartStopSemaphore</a> = <b>new</b> <span class="i">SemaphoreSlim</span>(1, 1);
 
        <b>private</b> <span class="i">CancellationTokenSource</span> <a id="82a22252316d5c0d" href="../R/82a22252316d5c0d.html" target="n" data-glyph="106,1" class="i property">RunningTaskTokenSource</a> { <b>get</b>; <b>set</b>; }
 
        <b>private</b> <span class="i">Task</span> <a id="5e9513b381e4b1d9" href="../R/5e9513b381e4b1d9.html" target="n" data-glyph="106,1" class="i property">ActiveReceiveTask</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the fully qualified Service Bus namespace that the receiver is associated with. This is likely</span>
        <span class="c">///</span><span class="c"> to be similar to </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">{yournamespace}.servicebus.windows.net</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="2b69541cea22b677" href="../R/2b69541cea22b677.html" target="n" data-glyph="102,1" class="i property">FullyQualifiedNamespace</a> =&gt; <a href="#c1293d05d2981eff" class="i field">_connection</a>.<a href="../Primitives/ServiceBusConnection.cs.html#729943334b661165" class="i property">FullyQualifiedNamespace</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the path of the Service Bus entity that the processor is connected to, specific to the</span>
        <span class="c">///</span><span class="c"> Service Bus namespace that contains it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="995621e1398d3f75" href="../R/995621e1398d3f75.html" target="n" data-glyph="102,1" class="i property">EntityPath</a> { <b>get</b>; <b>private set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the ID to identify this processor. This can be used to correlate logs and exceptions.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">Every new processor has a unique ID.</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal string</b> <a id="d6c26a7bd351c628" href="../R/d6c26a7bd351c628.html" target="n" data-glyph="104,1" class="i property">Identifier</a> { <b>get</b>; <b>private set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#ca838df7a94de6ad" class="i property">ReceiveMode</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> used to specify how messages are received. Defaults to PeekLock mode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="../Receiver/ServiceBusReceiveMode.cs.html#baa558d5ec869168" class="t t">ServiceBusReceiveMode</a> <a id="ca838df7a94de6ad" href="../R/ca838df7a94de6ad.html" target="n" data-glyph="102,1" class="i property">ReceiveMode</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets whether the processor is configured to process session entities.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="e881579351797be9" href="../R/e881579351797be9.html" target="n" data-glyph="104,1" class="i property">IsSessionProcessor</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the number of messages that will be eagerly requested from Queues or Subscriptions</span>
        <span class="c">///</span><span class="c"> during processing. This is intended to help maximize throughput by allowing the</span>
        <span class="c">///</span><span class="c"> processor to receive from a local cache rather than waiting on a service request.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public int</b> <a id="b1a249b1cd43711d" href="../R/b1a249b1cd43711d.html" target="n" data-glyph="102,1" class="i property">PrefetchCount</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets whether or not this processor is currently processing messages.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if the processor is processing messages; otherwise, </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="5e3e1b9e0add30b7" href="../R/5e3e1b9e0add30b7.html" target="n" data-glyph="102,1" class="i property">IsProcessing</a> =&gt; <a href="#5e9513b381e4b1d9" class="i property">ActiveReceiveTask</a> != <b>null</b>;
 
        <b>private readonly</b> <a href="ServiceBusProcessorOptions.cs.html#3ee0705bcc32cc6b" class="t t">ServiceBusProcessorOptions</a> <a id="0a646bf948a940dd" href="../R/0a646bf948a940dd.html" target="n" data-glyph="46,1" class="i field">_options</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   The active connection to the Azure Service Bus service, enabling client communications for metadata</span>
        <span class="c">///</span><span class="c">   about the associated Service Bus entity and access to transport-aware consumers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <a href="../Primitives/ServiceBusConnection.cs.html#5fc67fb7b5056bea" class="t t">ServiceBusConnection</a> <a id="c1293d05d2981eff" href="../R/c1293d05d2981eff.html" target="n" data-glyph="46,1" class="i field">_connection</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Gets the maximum number of concurrent calls to the</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#6f26a2b2eb22920d" class="i">ProcessMessageAsync</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> message handler the processor should initiate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">The maximum number of concurrent calls to the message handler.</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>public int</b> <a id="7154e0aa8a0e5c18" href="../R/7154e0aa8a0e5c18.html" target="n" data-glyph="102,1" class="i property">MaxConcurrentCalls</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a value that indicates whether the processor should automatically</span>
        <span class="c">///</span><span class="c"> complete messages after the message handler has completed processing. If the</span>
        <span class="c">///</span><span class="c"> message handler triggers an exception, the message will not be automatically</span>
        <span class="c">///</span><span class="c"> completed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">true to complete the message processing automatically on</span>
        <span class="c">///</span><span class="c"> successful execution of the operation; otherwise, false.</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="5ecb5b213cfdc1d1" href="../R/5ecb5b213cfdc1d1.html" target="n" data-glyph="102,1" class="i property">AutoCompleteMessages</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the maximum duration within which the lock will be renewed automatically. This</span>
        <span class="c">///</span><span class="c"> value should be greater than the longest message lock duration; for example, the LockDuration Property.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">The maximum duration during which locks are automatically renewed.</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">The message renew can continue for sometime in the background</span>
        <span class="c">///</span><span class="c"> after completion of message and result in a few false MessageLockLostExceptions temporarily.</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">TimeSpan</span> <a id="4f58c57c763e93b2" href="../R/4f58c57c763e93b2.html" target="n" data-glyph="102,1" class="i property">MaxAutoLockRenewalDuration</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The instance of </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Diagnostics/ServiceBusEventSource.cs.html#9f107e3f0d141c2b" class="t t">ServiceBusEventSource</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> which can be mocked for testing.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../Diagnostics/ServiceBusEventSource.cs.html#9f107e3f0d141c2b" class="t t">ServiceBusEventSource</a> <a id="64e9ad4543157de7" href="../R/64e9ad4543157de7.html" target="n" data-glyph="104,1" class="i property">Logger</a> { <b>get</b>; <b>set</b>; } = <a href="../Diagnostics/ServiceBusEventSource.cs.html#9f107e3f0d141c2b" class="t t">ServiceBusEventSource</a>.<a href="../Diagnostics/ServiceBusEventSource.cs.html#9494c77d3f8244ec" class="i property">Log</a>;
        <b>internal int</b> <a id="7407672d4f4e1005" href="../R/7407672d4f4e1005.html" target="n" data-glyph="104,1" class="i property">MaxConcurrentSessions</a> { <b>get</b>; }
        <b>internal int</b> <a id="7e60a030877f1f38" href="../R/7e60a030877f1f38.html" target="n" data-glyph="104,1" class="i property">MaxConcurrentCallsPerSession</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Indicates whether or not this </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#53f32235bf319489" class="t t">ServiceBusProcessor</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> has been closed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if the processor is closed; otherwise, </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="47e32fcb3f58701e" href="../R/47e32fcb3f58701e.html" target="n" data-glyph="102,1" class="i property">IsClosed</a>
        {
            <b>get</b> =&gt; <a href="#5b6e4c9c3b66b9b9" class="i field">_closed</a>;
            <b>private set</b> =&gt; <a href="#5b6e4c9c3b66b9b9" class="i field">_closed</a> = <b>value</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span><span class="c">Indicates whether or not this instance has been closed.</span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private volatile bool</b> <a id="5b6e4c9c3b66b9b9" href="../R/5b6e4c9c3b66b9b9.html" target="n" data-glyph="46,1" class="i field">_closed</a>;
 
        <b>private readonly string</b>[] <a id="7b221f1360a4b2f1" href="../R/7b221f1360a4b2f1.html" target="n" data-glyph="46,1" class="i field">_sessionIds</a>;
        <b>private readonly</b> <a href="../Diagnostics/EntityScopeFactory.cs.html#9100164b526814a3" class="t t">EntityScopeFactory</a> <a id="508a0c62a929ba00" href="../R/508a0c62a929ba00.html" target="n" data-glyph="46,1" class="i field">_scopeFactory</a>;
        <b>private readonly</b> <span class="i">IList</span>&lt;<a href="../Plugins/ServiceBusPlugin.cs.html#5ee21a6788ad51aa" class="t t">ServiceBusPlugin</a>&gt; <a id="edaa27eefb15f16c" href="../R/edaa27eefb15f16c.html" target="n" data-glyph="46,1" class="i field">_plugins</a>;
        <b>private readonly</b> <span class="i">IList</span>&lt;<a href="ReceiverManager.cs.html#ccf80319c0706d5c" class="t t">ReceiverManager</a>&gt; <a id="249779253a6c12e5" href="../R/249779253a6c12e5.html" target="n" data-glyph="46,1" class="i field">_receiverManagers</a> = <b>new</b> <span class="i">List</span>&lt;<a href="ReceiverManager.cs.html#ccf80319c0706d5c" class="t t">ReceiverManager</a>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#53f32235bf319489" class="t t">ServiceBusProcessor</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">connection</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Primitives/ServiceBusConnection.cs.html#5fc67fb7b5056bea" class="t t">ServiceBusConnection</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> connection to use for communication with the Service Bus service.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">entityPath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The queue name or subscription path to process messages from.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">isSessionEntity</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Whether or not the processor is associated with a session entity.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">plugins</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The set of plugins to apply to incoming messages.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The set of options to use when configuring the processor.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">sessionIds</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An optional set of session Ids to limit processing to.</span>
        <span class="c">///</span><span class="c"> Only applies if isSessionEntity is true.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">maxConcurrentSessions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The max number of sessions that can be processed concurrently.</span>
        <span class="c">///</span><span class="c"> Only applies if isSessionEntity is true.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">maxConcurrentCallsPerSession</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The max number of concurrent calls per session.</span>
        <span class="c">///</span><span class="c"> Only applies if isSessionEntity is true.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="bb785a180630d72d" href="../R/bb785a180630d72d.html" target="n" data-glyph="74,1" class="t constructor">ServiceBusProcessor</a>(
            <a href="../Primitives/ServiceBusConnection.cs.html#5fc67fb7b5056bea" class="t t">ServiceBusConnection</a> <span id="r0 rd" class="r0 r">connection</span>,
            <b>string</b> <span id="r1 rd" class="r1 r">entityPath</span>,
            <b>bool</b> <span id="r2 rd" class="r2 r">isSessionEntity</span>,
            <span class="i">IList</span>&lt;<a href="../Plugins/ServiceBusPlugin.cs.html#5ee21a6788ad51aa" class="t t">ServiceBusPlugin</a>&gt; <span id="r3 rd" class="r3 r">plugins</span>,
            <a href="ServiceBusProcessorOptions.cs.html#3ee0705bcc32cc6b" class="t t">ServiceBusProcessorOptions</a> <span id="r4 rd" class="r4 r">options</span>,
            <b>string</b>[] <span id="r5 rd" class="r5 r">sessionIds</span> = <b>default</b>,
            <b>int</b> <span id="r6 rd" class="r6 r">maxConcurrentSessions</span> = <b>default</b>,
            <b>int</b> <span id="r7 rd" class="r7 r">maxConcurrentCallsPerSession</span> = <b>default</b>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#fa55a5c88c3dc11d" class="i method">AssertNotNullOrWhiteSpace</a>(<span class="r1 r">entityPath</span>, <b>nameof</b>(<span class="r1 r">entityPath</span>));
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#208d023d6fa23d33" class="i method">AssertNotNull</a>(<span class="r0 r">connection</span>, <b>nameof</b>(<span class="r0 r">connection</span>));
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../SharedSource/Azure.Core/Argument.cs.html#208d023d6fa23d33" class="i method">AssertNotNull</a>(<span class="r0 r">connection</span>.<a href="../Primitives/ServiceBusConnection.cs.html#6fbb28757496f6ee" class="i property">RetryOptions</a>, <b>nameof</b>(<span class="r0 r">connection</span>.<a href="../Primitives/ServiceBusConnection.cs.html#6fbb28757496f6ee" class="i property">RetryOptions</a>));
            <span class="r0 r">connection</span>.<a href="../Primitives/ServiceBusConnection.cs.html#9c53664d76dd11d7" class="i method">ThrowIfClosed</a>();
 
            <a href="#0a646bf948a940dd" class="i field">_options</a> = <span class="r4 r">options</span>?.<a href="ServiceBusProcessorOptions.cs.html#ebffb97ea1ea89d7" class="i method">Clone</a>() ?? <b>new</b> <span class="t">ServiceBusProcessorOptions</span>();
            <a href="#c1293d05d2981eff" class="i field">_connection</a> = <span class="r0 r">connection</span>;
            <a href="#995621e1398d3f75" class="i property">EntityPath</a> = <span class="r1 r">entityPath</span>;
            <a href="#d6c26a7bd351c628" class="i property">Identifier</a> = <a href="../Diagnostics/DiagnosticUtilities.cs.html#e63dadcef3cbbce1" class="t t">DiagnosticUtilities</a>.<a href="../Diagnostics/DiagnosticUtilities.cs.html#582c96465587da53" class="i method">GenerateIdentifier</a>(<a href="#995621e1398d3f75" class="i property">EntityPath</a>);
 
            <a href="#ca838df7a94de6ad" class="i property">ReceiveMode</a> = <a href="#0a646bf948a940dd" class="i field">_options</a>.<a href="ServiceBusProcessorOptions.cs.html#d93d046d4cc17eff" class="i property">ReceiveMode</a>;
            <a href="#b1a249b1cd43711d" class="i property">PrefetchCount</a> = <a href="#0a646bf948a940dd" class="i field">_options</a>.<a href="ServiceBusProcessorOptions.cs.html#4fa3116b8cfab82c" class="i property">PrefetchCount</a>;
            <a href="#4f58c57c763e93b2" class="i property">MaxAutoLockRenewalDuration</a> = <a href="#0a646bf948a940dd" class="i field">_options</a>.<a href="ServiceBusProcessorOptions.cs.html#1580e3ccf212e594" class="i property">MaxAutoLockRenewalDuration</a>;
            <a href="#7154e0aa8a0e5c18" class="i property">MaxConcurrentCalls</a> = <a href="#0a646bf948a940dd" class="i field">_options</a>.<a href="ServiceBusProcessorOptions.cs.html#bfac3f0cfa7dc675" class="i property">MaxConcurrentCalls</a>;
            <a href="#7407672d4f4e1005" class="i property">MaxConcurrentSessions</a> = <span class="r6 r">maxConcurrentSessions</span>;
            <a href="#7e60a030877f1f38" class="i property">MaxConcurrentCallsPerSession</a> = <span class="r7 r">maxConcurrentCallsPerSession</span>;
            <a href="#7b221f1360a4b2f1" class="i field">_sessionIds</a> = <span class="r5 r">sessionIds</span> ?? <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>string</b>&gt;();
 
            <b>int</b> <span id="r8 rd" class="r8 r">maxCalls</span> = <span class="r2 r">isSessionEntity</span> ?
                (<a href="#7b221f1360a4b2f1" class="i field">_sessionIds</a>.<span class="i">Length</span> &gt; 0 ?
                    <span class="i">Math</span>.<span class="i">Min</span>(<a href="#7b221f1360a4b2f1" class="i field">_sessionIds</a>.<span class="i">Length</span>, <a href="#7407672d4f4e1005" class="i property">MaxConcurrentSessions</a>) :
                    <a href="#7407672d4f4e1005" class="i property">MaxConcurrentSessions</a>) * <a href="#7e60a030877f1f38" class="i property">MaxConcurrentCallsPerSession</a> :
                <a href="#7154e0aa8a0e5c18" class="i property">MaxConcurrentCalls</a>;
 
            <a href="#b855c0765a548b8d" class="i field">_messageHandlerSemaphore</a> = <b>new</b> <span class="i">SemaphoreSlim</span>(
                <span class="r8 r">maxCalls</span>,
                <span class="r8 r">maxCalls</span>);
            <b>var</b> <span id="r9 rd" class="r9 r">maxAcceptSessions</span> = <span class="i">Math</span>.<span class="i">Min</span>(<span class="r8 r">maxCalls</span>, 2 * <span class="i">Environment</span>.<span class="i">ProcessorCount</span>);
            <a href="#e79f05add880a9cd" class="i property">MaxConcurrentAcceptSessionsSemaphore</a> = <b>new</b> <span class="i">SemaphoreSlim</span>(
                <span class="r9 r">maxAcceptSessions</span>,
                <span class="r9 r">maxAcceptSessions</span>);
 
            <a href="#5ecb5b213cfdc1d1" class="i property">AutoCompleteMessages</a> = <a href="#0a646bf948a940dd" class="i field">_options</a>.<a href="ServiceBusProcessorOptions.cs.html#5aaf62e52e2e1e81" class="i property">AutoCompleteMessages</a>;
 
            <a href="#995621e1398d3f75" class="i property">EntityPath</a> = <span class="r1 r">entityPath</span>;
            <a href="#e881579351797be9" class="i property">IsSessionProcessor</a> = <span class="r2 r">isSessionEntity</span>;
            <a href="#508a0c62a929ba00" class="i field">_scopeFactory</a> = <b>new</b> <a href="../Diagnostics/EntityScopeFactory.cs.html#5f446a7a93a315a4" class="t constructor">EntityScopeFactory</a>(<a href="#995621e1398d3f75" class="i property">EntityPath</a>, <a href="#2b69541cea22b677" class="i property">FullyQualifiedNamespace</a>);
            <a href="#edaa27eefb15f16c" class="i field">_plugins</a> = <span class="r3 r">plugins</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#53f32235bf319489" class="t t">ServiceBusProcessor</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class for mocking.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected</b> <a id="889153985486e743" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="t constructor">ServiceBusProcessor</a>()
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Determines whether the specified </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">System</span>.<span class="i">Object</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> is equal to this instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">obj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">System</span>.<span class="i">Object</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> to compare with this instance.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">true</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c"> if the specified </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">System</span>.<span class="i">Object</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> is equal to this instance; otherwise, </span><span class="c">&lt;</span><span class="c">c</span><span class="c">&gt;</span><span class="c">false</span><span class="c">&lt;/</span><span class="c">c</span><span class="c">&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">EditorBrowsable</span>(<span class="i">EditorBrowsableState</span>.<span class="i">Never</span>)]
        <b>public override bool</b> <a id="47386006ee1ee771" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Equals</a>(<b>object</b> <span id="r10 rd" class="r10 r">obj</span>) =&gt; <b>base</b>.<span class="i">Equals</span>(<span class="r10 r">obj</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns a hash code for this instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A hash code for this instance, suitable for use in hashing algorithms and data structures like a hash table.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span>
        [<span class="i">EditorBrowsable</span>(<span class="i">EditorBrowsableState</span>.<span class="i">Never</span>)]
        <b>public override int</b> <a id="36a1b7e99fd961e7" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetHashCode</a>() =&gt; <b>base</b>.<span class="i">GetHashCode</span>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Converts the instance to string representation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">System</span>.<span class="i">String</span><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> that represents this instance.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">EditorBrowsable</span>(<span class="i">EditorBrowsableState</span>.<span class="i">Never</span>)]
        <b>public override string</b> <a id="38f260e7bc46062e" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ToString</a>() =&gt; <b>base</b>.<span class="i">ToString</span>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The handler responsible for processing messages received from the Queue</span>
        <span class="c">///</span><span class="c"> or Subscription.</span>
        <span class="c">///</span><span class="c"> Implementation is mandatory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0002:Ensure all service methods take an optional CancellationToken parameter.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;Guidance does not apply; this is an event.&quot;</span>)]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0003:DO make service methods virtual.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;This member follows the standard .NET event pattern; override via the associated On&lt;&lt;EVENT&gt;&gt; method.&quot;</span>)]
        <b>public event</b> <span class="i">Func</span>&lt;<a href="ProcessMessageEventArgs.cs.html#ab6a0d7f27cb1284" class="t t">ProcessMessageEventArgs</a>, <span class="i">Task</span>&gt; <a id="6f26a2b2eb22920d" href="../R/6f26a2b2eb22920d.html" target="n" data-glyph="30,1" class="i">ProcessMessageAsync</a>
        {
            <b>add</b>
            {
                <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<b>value</b>, <b>nameof</b>(<a href="#6f26a2b2eb22920d" class="i">ProcessMessageAsync</a>));
 
                <b>if</b> (<a href="#01388bef07dc39c6" class="i field">_processMessageAsync</a> != <b>default</b>)
                {
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">CA1065</span> <span class="c">// Do not raise exceptions in unexpected locations</span>
                    <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#003e2b76ffc55c54" class="i property">HandlerHasAlreadyBeenAssigned</a>);
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> <span class="i">CA1065</span> <span class="c">// Do not raise exceptions in unexpected locations</span>
                }
                <span class="i">EnsureNotRunningAndInvoke</span>(() =&gt; <a href="#01388bef07dc39c6" class="i field">_processMessageAsync</a> = <b>value</b>);
            }
 
            <b>remove</b>
            {
                <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<b>value</b>, <b>nameof</b>(<a href="#6f26a2b2eb22920d" class="i">ProcessMessageAsync</a>));
 
                <b>if</b> (<a href="#01388bef07dc39c6" class="i field">_processMessageAsync</a> != <b>value</b>)
                {
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">CA1065</span> <span class="c">// Do not raise exceptions in unexpected locations</span>
                    <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#18f0feedcca7ea20" class="i property">HandlerHasNotBeenAssigned</a>);
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> <span class="i">CA1065</span> <span class="c">// Do not raise exceptions in unexpected locations</span>
                }
 
                <span class="i">EnsureNotRunningAndInvoke</span>(() =&gt; <a href="#01388bef07dc39c6" class="i field">_processMessageAsync</a> = <b>default</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The handler responsible for processing messages received from the Queue</span>
        <span class="c">///</span><span class="c"> or Subscription. Implementation is mandatory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0002:Ensure all service methods take an optional CancellationToken parameter.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;Guidance does not apply; this is an event.&quot;</span>)]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0003:DO make service methods virtual.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;This member follows the standard .NET event pattern; override via the associated On&lt;&lt;EVENT&gt;&gt; method.&quot;</span>)]
        <b>internal event</b> <span class="i">Func</span>&lt;<a href="ProcessSessionMessageEventArgs.cs.html#7ed608712705605f" class="t t">ProcessSessionMessageEventArgs</a>, <span class="i">Task</span>&gt; <a id="304af37e3a267515" href="../R/304af37e3a267515.html" target="n" data-glyph="32,1" class="i">ProcessSessionMessageAsync</a>
        {
            <b>add</b>
            {
                <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<b>value</b>, <b>nameof</b>(<a href="#6f26a2b2eb22920d" class="i">ProcessMessageAsync</a>));
 
                <b>if</b> (<a href="#9b3ae8f7153cd5c6" class="i field">_processSessionMessageAsync</a> != <b>default</b>)
                {
                    <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#003e2b76ffc55c54" class="i property">HandlerHasAlreadyBeenAssigned</a>);
                }
                <span class="i">EnsureNotRunningAndInvoke</span>(() =&gt; <a href="#9b3ae8f7153cd5c6" class="i field">_processSessionMessageAsync</a> = <b>value</b>);
            }
 
            <b>remove</b>
            {
                <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<b>value</b>, <b>nameof</b>(<a href="#6f26a2b2eb22920d" class="i">ProcessMessageAsync</a>));
 
                <b>if</b> (<a href="#9b3ae8f7153cd5c6" class="i field">_processSessionMessageAsync</a> != <b>value</b>)
                {
                    <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#18f0feedcca7ea20" class="i property">HandlerHasNotBeenAssigned</a>);
                }
 
                <span class="i">EnsureNotRunningAndInvoke</span>(() =&gt; <a href="#9b3ae8f7153cd5c6" class="i field">_processSessionMessageAsync</a> = <b>default</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The handler responsible for processing unhandled exceptions thrown while</span>
        <span class="c">///</span><span class="c"> this processor is running.</span>
        <span class="c">///</span><span class="c"> Implementation is mandatory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0002:Ensure all service methods take an optional CancellationToken parameter.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;Guidance does not apply; this is an event.&quot;</span>)]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0003:DO make service methods virtual.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;This member follows the standard .NET event pattern; override via the associated On&lt;&lt;EVENT&gt;&gt; method.&quot;</span>)]
        <b>public event</b> <span class="i">Func</span>&lt;<a href="ProcessErrorEventArgs.cs.html#6d0ae56c469cb1ba" class="t t">ProcessErrorEventArgs</a>, <span class="i">Task</span>&gt; <a id="3c7d5830cb3c7e5a" href="../R/3c7d5830cb3c7e5a.html" target="n" data-glyph="30,1" class="i">ProcessErrorAsync</a>
        {
            <b>add</b>
            {
                <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<b>value</b>, <b>nameof</b>(<a href="#3c7d5830cb3c7e5a" class="i">ProcessErrorAsync</a>));
 
                <b>if</b> (<a href="#4adf9cdb3a13fb8d" class="i field">_processErrorAsync</a> != <b>default</b>)
                {
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">CA1065</span> <span class="c">// Do not raise exceptions in unexpected locations</span>
                    <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#003e2b76ffc55c54" class="i property">HandlerHasAlreadyBeenAssigned</a>);
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> <span class="i">CA1065</span> <span class="c">// Do not raise exceptions in unexpected locations</span>
                }
 
                <span class="i">EnsureNotRunningAndInvoke</span>(() =&gt; <a href="#4adf9cdb3a13fb8d" class="i field">_processErrorAsync</a> = <b>value</b>);
            }
 
            <b>remove</b>
            {
                <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<b>value</b>, <b>nameof</b>(<a href="#3c7d5830cb3c7e5a" class="i">ProcessErrorAsync</a>));
 
                <b>if</b> (<a href="#4adf9cdb3a13fb8d" class="i field">_processErrorAsync</a> != <b>value</b>)
                {
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">CA1065</span> <span class="c">// Do not raise exceptions in unexpected locations</span>
                    <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#18f0feedcca7ea20" class="i property">HandlerHasNotBeenAssigned</a>);
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> <span class="i">CA1065</span> <span class="c">// Do not raise exceptions in unexpected locations</span>
                }
 
                <span class="i">EnsureNotRunningAndInvoke</span>(() =&gt; <a href="#4adf9cdb3a13fb8d" class="i field">_processErrorAsync</a> = <b>default</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Optional handler that can be set to be notified when a new session is about to be processed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0002:Ensure all service methods take an optional CancellationToken parameter.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;Guidance does not apply; this is an event.&quot;</span>)]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0003:DO make service methods virtual.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;This member follows the standard .NET event pattern; override via the associated On&lt;&lt;EVENT&gt;&gt; method.&quot;</span>)]
        <b>internal event</b> <span class="i">Func</span>&lt;<a href="ProcessSessionEventArgs.cs.html#833b7a9c2dde6645" class="t t">ProcessSessionEventArgs</a>, <span class="i">Task</span>&gt; <a id="9627bec6c0d95a48" href="../R/9627bec6c0d95a48.html" target="n" data-glyph="32,1" class="i">SessionInitializingAsync</a>
        {
            <b>add</b>
            {
                <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<b>value</b>, <b>nameof</b>(<a href="#9627bec6c0d95a48" class="i">SessionInitializingAsync</a>));
 
                <b>if</b> (<a href="#fcdf61880c92645a" class="i field">_sessionInitializingAsync</a> != <b>default</b>)
                {
                    <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#003e2b76ffc55c54" class="i property">HandlerHasAlreadyBeenAssigned</a>);
                }
                <span class="i">EnsureNotRunningAndInvoke</span>(() =&gt; <a href="#fcdf61880c92645a" class="i field">_sessionInitializingAsync</a> = <b>value</b>);
            }
 
            <b>remove</b>
            {
                <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<b>value</b>, <b>nameof</b>(<a href="#9627bec6c0d95a48" class="i">SessionInitializingAsync</a>));
                <b>if</b> (<a href="#fcdf61880c92645a" class="i field">_sessionInitializingAsync</a> != <b>value</b>)
                {
                    <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#18f0feedcca7ea20" class="i property">HandlerHasNotBeenAssigned</a>);
                }
                <span class="i">EnsureNotRunningAndInvoke</span>(() =&gt; <a href="#fcdf61880c92645a" class="i field">_sessionInitializingAsync</a> = <b>default</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Optional handler that can be set to be notified when a session is about to be closed for processing.</span>
        <span class="c">///</span><span class="c"> This means that the most recent </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Receiver/ServiceBusReceiver.cs.html#2224f17dabcb26c3" class="t t">ServiceBusReceiver</a>.<a href="../Receiver/ServiceBusReceiver.cs.html#19d33b51af2ff547" class="i method">ReceiveMessageAsync</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> call timed out so there are currently no messages</span>
        <span class="c">///</span><span class="c"> available to be received for the session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0002:Ensure all service methods take an optional CancellationToken parameter.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;Guidance does not apply; this is an event.&quot;</span>)]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Usage&quot;</span>, <span class="s">&quot;AZC0003:DO make service methods virtual.&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;This member follows the standard .NET event pattern; override via the associated On&lt;&lt;EVENT&gt;&gt; method.&quot;</span>)]
        <b>internal event</b> <span class="i">Func</span>&lt;<a href="ProcessSessionEventArgs.cs.html#833b7a9c2dde6645" class="t t">ProcessSessionEventArgs</a>, <span class="i">Task</span>&gt; <a id="99f9fbf9dbf2e712" href="../R/99f9fbf9dbf2e712.html" target="n" data-glyph="32,1" class="i">SessionClosingAsync</a>
        {
            <b>add</b>
            {
                <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<b>value</b>, <b>nameof</b>(<a href="#99f9fbf9dbf2e712" class="i">SessionClosingAsync</a>));
 
                <b>if</b> (<a href="#fd25e357813f1523" class="i field">_sessionClosingAsync</a> != <b>default</b>)
                {
                    <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#003e2b76ffc55c54" class="i property">HandlerHasAlreadyBeenAssigned</a>);
                }
                <span class="i">EnsureNotRunningAndInvoke</span>(() =&gt; <a href="#fd25e357813f1523" class="i field">_sessionClosingAsync</a> = <b>value</b>);
            }
 
            <b>remove</b>
            {
                <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<span class="i">AssertNotNull</span>(<b>value</b>, <b>nameof</b>(<a href="#99f9fbf9dbf2e712" class="i">SessionClosingAsync</a>));
                <b>if</b> (<a href="#fd25e357813f1523" class="i field">_sessionClosingAsync</a> != <b>value</b>)
                {
                    <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#18f0feedcca7ea20" class="i property">HandlerHasNotBeenAssigned</a>);
                }
                <span class="i">EnsureNotRunningAndInvoke</span>(() =&gt; <a href="#fd25e357813f1523" class="i field">_sessionClosingAsync</a> = <b>default</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Signals the processor to begin processing messages. Should this method be</span>
        <span class="c">///</span><span class="c"> called while the processor is already running, an</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is thrown.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to</span>
        <span class="c">///</span><span class="c"> signal the request to cancel the start operation.  This won&#39;t affect the</span>
        <span class="c">///</span><span class="c"> processor once it starts running.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public virtual async</b> <span class="i">Task</span> <a id="20feb1e36486f404" href="../R/20feb1e36486f404.html" target="n" data-glyph="72,1" class="i method">StartProcessingAsync</a>(
            <span class="i">CancellationToken</span> <span id="r11 rd" class="r11 r">cancellationToken</span> = <b>default</b>)
        {
            <a href="../P/0198b1312554d2ed.html#0198b1312554d2ed" class="t t">Argument</a>.<a href="../Core/Argument.cs.html#ad31cdc7051f5f26" class="i method">AssertNotDisposed</a>(<a href="#47e32fcb3f58701e" class="i property">IsClosed</a>, <b>nameof</b>(<a href="#53f32235bf319489" class="t t">ServiceBusProcessor</a>));
            <span class="r11 r">cancellationToken</span>.<a href="../Core/CancellationTokenExtensions.cs.html#02fb1f7bead5539d" class="i method">ThrowIfCancellationRequested</a>&lt;<span class="i">TaskCanceledException</span>&gt;();
            <b>bool</b> <span id="r12 rd" class="r12 r">releaseGuard</span> = <b>false</b>;
            <b>try</b>
            {
                <b>await</b> <a href="#2145abf80f6a4c2d" class="i field">_processingStartStopSemaphore</a>.<span class="i">WaitAsync</span>(<span class="r11 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                <span class="r12 r">releaseGuard</span> = <b>true</b>;
 
                <b>if</b> (<a href="#5e9513b381e4b1d9" class="i property">ActiveReceiveTask</a> == <b>null</b>)
                {
                    <a href="#64e9ad4543157de7" class="i property">Logger</a>.<a href="../Diagnostics/ServiceBusEventSource.cs.html#e7e7b16375669ec3" class="i method">StartProcessingStart</a>(<a href="#d6c26a7bd351c628" class="i property">Identifier</a>);
 
                    <b>try</b>
                    {
                        <a href="#a5fda7923911c065" class="i method">ValidateMessageHandler</a>();
                        <a href="#573bd94c8529054b" class="i method">ValidateErrorHandler</a>();
                        <span class="r11 r">cancellationToken</span>.<a href="../Core/CancellationTokenExtensions.cs.html#02fb1f7bead5539d" class="i method">ThrowIfCancellationRequested</a>&lt;<span class="i">TaskCanceledException</span>&gt;();
 
                        <a href="#e14bb894772c0dd2" class="i method">InitializeReceiverManagers</a>();
 
                        <span class="c">// We expect the token source to be null, but we are playing safe.</span>
 
                        <a href="#82a22252316d5c0d" class="i property">RunningTaskTokenSource</a>?.<span class="i">Cancel</span>();
                        <a href="#82a22252316d5c0d" class="i property">RunningTaskTokenSource</a>?.<span class="i">Dispose</span>();
                        <a href="#82a22252316d5c0d" class="i property">RunningTaskTokenSource</a> = <b>new</b> <span class="i">CancellationTokenSource</span>();
 
                        <span class="c">// Start the main running task.</span>
                        <a href="#5e9513b381e4b1d9" class="i property">ActiveReceiveTask</a> = <span class="i">RunReceiveTaskAsync</span>(<a href="#82a22252316d5c0d" class="i property">RunningTaskTokenSource</a>.<span class="i">Token</span>);
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r13 rd" class="r13 r">exception</span>)
                    {
                        <a href="#64e9ad4543157de7" class="i property">Logger</a>.<span class="i">StartProcessingException</span>(<a href="#d6c26a7bd351c628" class="i property">Identifier</a>, <span class="r13 r">exception</span>.<span class="i">ToString</span>());
                        <b>throw</b>;
                    }
 
                    <a href="#64e9ad4543157de7" class="i property">Logger</a>.<a href="../Diagnostics/ServiceBusEventSource.cs.html#2b0ed37198e8d544" class="i method">StartProcessingComplete</a>(<a href="#d6c26a7bd351c628" class="i property">Identifier</a>);
                }
                <b>else</b>
                {
                    <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#553aeaa66d380977" class="i property">RunningMessageProcessorCannotPerformOperation</a>);
                }
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r12 r">releaseGuard</span>)
                {
                    <a href="#2145abf80f6a4c2d" class="i field">_processingStartStopSemaphore</a>.<span class="i">Release</span>();
                }
            }
        }
 
        <b>private void</b> <a id="e14bb894772c0dd2" href="../R/e14bb894772c0dd2.html" target="n" data-glyph="76,1" class="i method">InitializeReceiverManagers</a>()
        {
            <b>if</b> (<a href="#249779253a6c12e5" class="i field">_receiverManagers</a>.<span class="i">Count</span> &gt; 0)
            {
                <span class="c">// already initialized - this can happen if stopping and then restarting</span>
                <b>return</b>;
            }
 
            <b>if</b> (<a href="#e881579351797be9" class="i property">IsSessionProcessor</a>)
            {
                <b>var</b> <span id="r14 rd" class="r14 r">numReceivers</span> = <a href="#7b221f1360a4b2f1" class="i field">_sessionIds</a>.<span class="i">Length</span> &gt; 0 ? <a href="#7b221f1360a4b2f1" class="i field">_sessionIds</a>.<span class="i">Length</span> : <a href="#7407672d4f4e1005" class="i property">MaxConcurrentSessions</a>;
                <b>for</b> (<b>int</b> <span id="r15 rd" class="r15 r">i</span> = 0; <span class="r15 r">i</span> &lt; <span class="r14 r">numReceivers</span>; <span class="r15 r">i</span>++)
                {
                    <b>var</b> <span id="r16 rd" class="r16 r">sessionId</span> = <a href="#7b221f1360a4b2f1" class="i field">_sessionIds</a>.<span class="i">Length</span> &gt; 0 ? <a href="#7b221f1360a4b2f1" class="i field">_sessionIds</a>[<span class="r15 r">i</span>] : <b>null</b>;
                    <span class="c">// If the user has listed named sessions, and they</span>
                    <span class="c">// have MaxConcurrentSessions greater or equal to the number</span>
                    <span class="c">// of sessions, we can leave the sessions open at all times</span>
                    <span class="c">// instead of cycling through them as receive calls time out.</span>
                    <b>bool</b> <span id="r17 rd" class="r17 r">keepOpenOnReceiveTimeout</span> = <a href="#7b221f1360a4b2f1" class="i field">_sessionIds</a>.<span class="i">Length</span> &gt; 0 &amp;&amp;
                        <a href="#7407672d4f4e1005" class="i property">MaxConcurrentSessions</a> &gt;= <a href="#7b221f1360a4b2f1" class="i field">_sessionIds</a>.<span class="i">Length</span>;
 
                    <a href="#249779253a6c12e5" class="i field">_receiverManagers</a>.<span class="i">Add</span>(
                        <b>new</b> <a href="SessionReceiverManager.cs.html#73c742a866f93eb9" class="t constructor">SessionReceiverManager</a>(
                            <a href="#c1293d05d2981eff" class="i field">_connection</a>,
                            <a href="#2b69541cea22b677" class="i property">FullyQualifiedNamespace</a>,
                            <a href="#995621e1398d3f75" class="i property">EntityPath</a>,
                            <a href="#d6c26a7bd351c628" class="i property">Identifier</a>,
                            <span class="r16 r">sessionId</span>,
                            <a href="#0a646bf948a940dd" class="i field">_options</a>,
                            <a href="#fcdf61880c92645a" class="i field">_sessionInitializingAsync</a>,
                            <a href="#fd25e357813f1523" class="i field">_sessionClosingAsync</a>,
                            <a href="#9b3ae8f7153cd5c6" class="i field">_processSessionMessageAsync</a>,
                            <a href="#4adf9cdb3a13fb8d" class="i field">_processErrorAsync</a>,
                            <a href="#e79f05add880a9cd" class="i property">MaxConcurrentAcceptSessionsSemaphore</a>,
                            <a href="#508a0c62a929ba00" class="i field">_scopeFactory</a>,
                            <a href="#edaa27eefb15f16c" class="i field">_plugins</a>,
                            <a href="#7e60a030877f1f38" class="i property">MaxConcurrentCallsPerSession</a>,
                            <span class="r17 r">keepOpenOnReceiveTimeout</span>));
                }
            }
            <b>else</b>
            {
                <a href="#249779253a6c12e5" class="i field">_receiverManagers</a>.<span class="i">Add</span>(
                    <b>new</b> <a href="ReceiverManager.cs.html#60f04c97f2c2211d" class="t constructor">ReceiverManager</a>(
                        <a href="#c1293d05d2981eff" class="i field">_connection</a>,
                        <a href="#2b69541cea22b677" class="i property">FullyQualifiedNamespace</a>,
                        <a href="#995621e1398d3f75" class="i property">EntityPath</a>,
                        <a href="#d6c26a7bd351c628" class="i property">Identifier</a>,
                        <a href="#0a646bf948a940dd" class="i field">_options</a>,
                        <a href="#01388bef07dc39c6" class="i field">_processMessageAsync</a>,
                        <a href="#4adf9cdb3a13fb8d" class="i field">_processErrorAsync</a>,
                        <a href="#508a0c62a929ba00" class="i field">_scopeFactory</a>,
                        <a href="#edaa27eefb15f16c" class="i field">_plugins</a>));
            }
        }
 
        <b>private void</b> <a id="573bd94c8529054b" href="../R/573bd94c8529054b.html" target="n" data-glyph="76,1" class="i method">ValidateErrorHandler</a>()
        {
            <b>if</b> (<a href="#4adf9cdb3a13fb8d" class="i field">_processErrorAsync</a> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#af7873ea81d56062" class="i property">CannotStartMessageProcessorWithoutHandler</a>, <b>nameof</b>(<a href="#3c7d5830cb3c7e5a" class="i">ProcessErrorAsync</a>)));
            }
        }
 
        <b>private void</b> <a id="a5fda7923911c065" href="../R/a5fda7923911c065.html" target="n" data-glyph="76,1" class="i method">ValidateMessageHandler</a>()
        {
            <b>if</b> (<a href="#e881579351797be9" class="i property">IsSessionProcessor</a>)
            {
                <b>if</b> (<a href="#9b3ae8f7153cd5c6" class="i field">_processSessionMessageAsync</a> == <b>null</b>)
                {
                    <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#af7873ea81d56062" class="i property">CannotStartMessageProcessorWithoutHandler</a>, <b>nameof</b>(<a href="#6f26a2b2eb22920d" class="i">ProcessMessageAsync</a>)));
                }
            }
            <b>else</b> <b>if</b> (<a href="#01388bef07dc39c6" class="i field">_processMessageAsync</a> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#af7873ea81d56062" class="i property">CannotStartMessageProcessorWithoutHandler</a>, <b>nameof</b>(<a href="#6f26a2b2eb22920d" class="i">ProcessMessageAsync</a>)));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Signals the processor to stop processing messaging. Should this method be</span>
        <span class="c">///</span><span class="c"> called while the processor is not running, no action is taken. This method</span>
        <span class="c">///</span><span class="c"> will not close the underlying receivers, but will cause the receivers to stop</span>
        <span class="c">///</span><span class="c"> receiving. To close the underlying receivers, </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#ffdfdf657d1e5c3d" class="i method">CloseAsync</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> should be called.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to</span>
        <span class="c">///</span><span class="c"> signal the request to cancel the stop operation. If the operation is successfully</span>
        <span class="c">///</span><span class="c"> canceled, the processor will keep running.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public virtual async</b> <span class="i">Task</span> <a id="c5a128ec58d61561" href="../R/c5a128ec58d61561.html" target="n" data-glyph="72,1" class="i method">StopProcessingAsync</a>(<span class="i">CancellationToken</span> <span id="r18 rd" class="r18 r">cancellationToken</span> = <b>default</b>)
        {
            <span class="r18 r">cancellationToken</span>.<a href="../Core/CancellationTokenExtensions.cs.html#02fb1f7bead5539d" class="i method">ThrowIfCancellationRequested</a>&lt;<span class="i">TaskCanceledException</span>&gt;();
            <b>bool</b> <span id="r19 rd" class="r19 r">releaseGuard</span> = <b>false</b>;
            <b>try</b>
            {
                <b>await</b> <a href="#2145abf80f6a4c2d" class="i field">_processingStartStopSemaphore</a>.<span class="i">WaitAsync</span>(<span class="r18 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                <span class="r19 r">releaseGuard</span> = <b>true</b>;
 
                <b>if</b> (<a href="#5e9513b381e4b1d9" class="i property">ActiveReceiveTask</a> != <b>null</b>)
                {
                    <a href="#64e9ad4543157de7" class="i property">Logger</a>.<a href="../Diagnostics/ServiceBusEventSource.cs.html#53081ab5959573c2" class="i method">StopProcessingStart</a>(<a href="#d6c26a7bd351c628" class="i property">Identifier</a>);
                    <span class="r18 r">cancellationToken</span>.<a href="../Core/CancellationTokenExtensions.cs.html#02fb1f7bead5539d" class="i method">ThrowIfCancellationRequested</a>&lt;<span class="i">TaskCanceledException</span>&gt;();
 
                    <span class="c">// Cancel the current running task.</span>
 
                    <a href="#82a22252316d5c0d" class="i property">RunningTaskTokenSource</a>.<span class="i">Cancel</span>();
                    <a href="#82a22252316d5c0d" class="i property">RunningTaskTokenSource</a>.<span class="i">Dispose</span>();
                    <a href="#82a22252316d5c0d" class="i property">RunningTaskTokenSource</a> = <b>null</b>;
 
                    <span class="c">// Now that a cancellation request has been issued, wait for the running task to finish.  In case something</span>
                    <span class="c">// unexpected happened and it stopped working midway, this is the moment we expect to catch an exception.</span>
                    <b>try</b>
                    {
                        <b>await</b> <a href="#5e9513b381e4b1d9" class="i property">ActiveReceiveTask</a>.<span class="i">ConfigureAwait</span>(<b>false</b>);
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r20 rd" class="r20 r">ex</span>) <b>when</b> (<span class="r20 r">ex</span> <b>is</b> <span class="i">TaskCanceledException</span> || <span class="r20 r">ex</span> <b>is</b> <span class="i">OperationCanceledException</span>)
                    {
                        <span class="c">// Nothing to do here.  These exceptions are expected.</span>
                    }
 
                    <a href="#5e9513b381e4b1d9" class="i property">ActiveReceiveTask</a>.<span class="i">Dispose</span>();
                    <a href="#5e9513b381e4b1d9" class="i property">ActiveReceiveTask</a> = <b>null</b>;
                }
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r21 rd" class="r21 r">exception</span>)
            {
                <a href="#64e9ad4543157de7" class="i property">Logger</a>.<span class="i">StopProcessingException</span>(<a href="#d6c26a7bd351c628" class="i property">Identifier</a>, <span class="r21 r">exception</span>.<span class="i">ToString</span>());
                <b>throw</b>;
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r19 r">releaseGuard</span>)
                {
                    <a href="#2145abf80f6a4c2d" class="i field">_processingStartStopSemaphore</a>.<span class="i">Release</span>();
                }
            }
            <a href="#64e9ad4543157de7" class="i property">Logger</a>.<a href="../Diagnostics/ServiceBusEventSource.cs.html#3e3b568876e640af" class="i method">StopProcessingComplete</a>(<a href="#d6c26a7bd351c628" class="i property">Identifier</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Runs the Receive task in as many threads as are</span>
        <span class="c">///</span><span class="c"> specified in the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#7154e0aa8a0e5c18" class="i property">MaxConcurrentCalls</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> property.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private async</b> <span class="i">Task</span> <a id="51a4562cc9c9fdca" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">RunReceiveTaskAsync</a>(
            <span class="i">CancellationToken</span> <span id="r22 rd" class="r22 r">cancellationToken</span>)
        {
            <span class="i">List</span>&lt;<span class="i">Task</span>&gt; <span id="r23 rd" class="r23 r">tasks</span> = <b>new</b> <span class="i">List</span>&lt;<span class="i">Task</span>&gt;();
            <b>try</b>
            {
                <b>while</b> (!<span class="r22 r">cancellationToken</span>.<span class="i">IsCancellationRequested</span>)
                {
                    <b>foreach</b> (<a href="ReceiverManager.cs.html#ccf80319c0706d5c" class="t t">ReceiverManager</a> <span id="r24 rd" class="r24 r">receiverManager</span> <b>in</b> <a href="#249779253a6c12e5" class="i field">_receiverManagers</a>)
                    {
                        <b>await</b> <a href="#b855c0765a548b8d" class="i field">_messageHandlerSemaphore</a>.<span class="i">WaitAsync</span>(<span class="r22 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
                        <span class="c">// hold onto all the tasks that we are starting so that when cancellation is requested,</span>
                        <span class="c">// we can await them to make sure we surface any unexpected exceptions, i.e. exceptions</span>
                        <span class="c">// other than TaskCanceledExceptions</span>
                        <span class="r23 r">tasks</span>.<span class="i">Add</span>(<a href="#e357839efbc42d96" class="i method">ReceiveAndProcessMessagesAsync</a>(<span class="r24 r">receiverManager</span>, <span class="r22 r">cancellationToken</span>));
                    }
                    <b>if</b> (<span class="r23 r">tasks</span>.<span class="i">Count</span> &gt; <a href="#7154e0aa8a0e5c18" class="i property">MaxConcurrentCalls</a>)
                    {
                        <span class="r23 r">tasks</span>.<span class="i">RemoveAll</span>(<span id="r25 rd" class="r25 r">t</span> =&gt; <span class="r25 r">t</span>.<span class="i">IsCompleted</span>);
                    }
                }
            }
            <b>finally</b>
            {
                <b>await</b> <span class="i">Task</span>.<span class="i">WhenAll</span>(<span class="r23 r">tasks</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
            }
        }
 
        <b>private async</b> <span class="i">Task</span> <a id="e357839efbc42d96" href="../R/e357839efbc42d96.html" target="n" data-glyph="76,1" class="i method">ReceiveAndProcessMessagesAsync</a>(
            <a href="ReceiverManager.cs.html#ccf80319c0706d5c" class="t t">ReceiverManager</a> <span id="r26 rd" class="r26 r">receiverManager</span>,
            <span class="i">CancellationToken</span> <span id="r27 rd" class="r27 r">cancellationToken</span>)
        {
            <b>try</b>
            {
                <b>await</b> <span class="r26 r">receiverManager</span>.<a href="ReceiverManager.cs.html#6c5579536472eedd" class="i method">ReceiveAndProcessMessagesAsync</a>(<span class="r27 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
            }
            <b>finally</b>
            {
                <a href="#b855c0765a548b8d" class="i field">_messageHandlerSemaphore</a>.<span class="i">Release</span>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Invokes a specified action only if this </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#53f32235bf319489" class="t t">ServiceBusProcessor</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c"> instance is not running.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r28 r">action</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The action to invoke.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Occurs when this method is invoked while the event processor is running.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="a269242e32dc8f58" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">EnsureNotRunningAndInvoke</a>(<span class="i">Action</span> <span id="r28 rd" class="r28 r">action</span>)
        {
            <b>if</b> (<a href="#5e9513b381e4b1d9" class="i property">ActiveReceiveTask</a> == <b>null</b>)
            {
                <b>try</b>
                {
                    <a href="#2145abf80f6a4c2d" class="i field">_processingStartStopSemaphore</a>.<span class="i">Wait</span>();
                    <b>if</b> (<a href="#5e9513b381e4b1d9" class="i property">ActiveReceiveTask</a> == <b>null</b>)
                    {
                        <span class="r28 r">action</span>?.<span class="i">Invoke</span>();
                    }
                    <b>else</b>
                    {
                        <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#553aeaa66d380977" class="i property">RunningMessageProcessorCannotPerformOperation</a>);
                    }
                }
                <b>finally</b>
                {
                    <a href="#2145abf80f6a4c2d" class="i field">_processingStartStopSemaphore</a>.<span class="i">Release</span>();
                }
            }
            <b>else</b>
            {
                <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<a href="../Resources.Designer.cs.html#7e6b2ac45384f6a8" class="t t">Resources</a>.<a href="../Resources.Designer.cs.html#553aeaa66d380977" class="i property">RunningMessageProcessorCannotPerformOperation</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Performs the task needed to clean up resources used by the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#53f32235bf319489" class="t t">ServiceBusProcessor</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c"> An optional</span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">CancellationToken</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> instance to signal the</span>
        <span class="c">///</span><span class="c"> request to cancel the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public virtual async</b> <span class="i">Task</span> <a id="ffdfdf657d1e5c3d" href="../R/ffdfdf657d1e5c3d.html" target="n" data-glyph="72,1" class="i method">CloseAsync</a>(
            <span class="i">CancellationToken</span> <span id="r29 rd" class="r29 r">cancellationToken</span> = <b>default</b>)
        {
            <a href="#47e32fcb3f58701e" class="i property">IsClosed</a> = <b>true</b>;
 
            <b>if</b> (<a href="#5e3e1b9e0add30b7" class="i property">IsProcessing</a>)
            {
                <b>await</b> <a href="#c5a128ec58d61561" class="i method">StopProcessingAsync</a>(<span class="r29 r">cancellationToken</span>).<span class="i">ConfigureAwait</span>(<b>false</b>);
            }
            <b>foreach</b> (<a href="ReceiverManager.cs.html#ccf80319c0706d5c" class="t t">ReceiverManager</a> <span id="r30 rd" class="r30 r">receiverManager</span> <b>in</b> <a href="#249779253a6c12e5" class="i field">_receiverManagers</a>)
            {
                <b>await</b> <span class="r30 r">receiverManager</span>.<a href="ReceiverManager.cs.html#8f851ee173de6456" class="i method">CloseReceiverIfNeeded</a>(
                    <span class="r29 r">cancellationToken</span>,
                    <span class="r31 r">forceClose</span>: <b>true</b>)
                    .<span class="i">ConfigureAwait</span>(<b>false</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   Performs the task needed to clean up resources used by the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#53f32235bf319489" class="t t">ServiceBusProcessor</a><span class="c">&quot;</span> <span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c">   This is equivalent to calling </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#ffdfdf657d1e5c3d" class="i method">CloseAsync</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> with the default </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Primitives/LinkCloseMode.cs.html#f8c9ace71ea8e421" class="t t">LinkCloseMode</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public async</b> <span class="i">ValueTask</span> <a id="98eda9bd5e723e38" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">DisposeAsync</a>() =&gt;
            <b>await</b> <a href="#ffdfdf657d1e5c3d" class="i method">CloseAsync</a>().<span class="i">ConfigureAwait</span>(<b>false</b>);
    }
}
</pre></td></tr></table></div></body></html>
