<!DOCTYPE html>
<html><head><title>AzureArcManagedIdentitySource.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(104);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Identity/AzureArcManagedIdentitySource.cs" target="_top">AzureArcManagedIdentitySource.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Identity" target="_top">Azure.Identity.csproj</a> (Azure.Identity)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Security</span>.<span class="i n">Cryptography</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Identity</span>
{
    <b>internal class</b> <a id="04f78041981a207b" href="R/04f78041981a207b.html" target="n" data-glyph="2,0" class="t t">AzureArcManagedIdentitySource</a> : <a href="ManagedIdentitySource.cs.html#56166eaff4308374" class="t t">ManagedIdentitySource</a>
    {
        <b>private const string</b> <a id="43f2359e058a68d4" href="R/43f2359e058a68d4.html" target="n" data-glyph="10,1" class="i field">IdentityEndpointInvalidUriError</a> = <span class="s">&quot;The environment variable IDENTITY_ENDPOINT contains an invalid Uri.&quot;</span>;
        <b>private const string</b> <a id="9cab5538e739f37f" href="R/9cab5538e739f37f.html" target="n" data-glyph="10,1" class="i field">NoChallengeErrorMessage</a> = <span class="s">&quot;Did not receive expected WWW-Authenticate header in the response from Azure Arc Managed Identity Endpoint.&quot;</span>;
        <b>private const string</b> <a id="a6fbe77d8af1ee21" href="R/a6fbe77d8af1ee21.html" target="n" data-glyph="10,1" class="i field">InvalidChallangeErrorMessage</a> = <span class="s">&quot;The WWW-Authenticate header in the response from Azure Arc Managed Identity Endpoint did not match the expected format.&quot;</span>;
        <b>private const string</b> <a id="9111cb7f56aee229" href="R/9111cb7f56aee229.html" target="n" data-glyph="10,1" class="i field">UserAssignedNotSupportedErrorMessage</a> = <span class="s">&quot;User assigned identity is not supported by the Azure Arc Managed Identity Endpoint. To authenticate with the system assigned identity omit the client id when constructing the ManagedIdentityCredential, or if authenticating with the DefaultAzureCredential ensure the AZURE_CLIENT_ID environment variable is not set.&quot;</span>;
        <b>private const string</b> <a id="5f04cce1fe3a8080" href="R/5f04cce1fe3a8080.html" target="n" data-glyph="10,1" class="i field">ArcApiVersion</a> = <span class="s">&quot;2019-11-01&quot;</span>;
 
        <b>private readonly string</b> <a id="ba54f7b36d4b1d0d" href="R/ba54f7b36d4b1d0d.html" target="n" data-glyph="46,1" class="i field">_clientId</a>;
        <b>private readonly</b> <a href="@1@netstandard/A.html#991565dd25f47c90" class="t t">Uri</a> <a id="fc5c13e2b3f31d53" href="R/fc5c13e2b3f31d53.html" target="n" data-glyph="46,1" class="i field">_endpoint</a>;
 
        <b>public static</b> <a href="ManagedIdentitySource.cs.html#56166eaff4308374" class="t t">ManagedIdentitySource</a> <a id="b37c9dfcc9800e6d" href="R/b37c9dfcc9800e6d.html" target="n" data-glyph="72,1" class="i method">TryCreate</a>(<a href="ManagedIdentityClientOptions.cs.html#6d8b26e7f064d1bf" class="t t">ManagedIdentityClientOptions</a> <span id="r0 rd" class="r0 r">options</span>)
        {
            <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r1 rd" class="r1 r">identityEndpoint</span> = <a href="EnvironmentVariables.cs.html#c2ba6c1998ea65d9" class="t t">EnvironmentVariables</a>.<a href="EnvironmentVariables.cs.html#df2b2359b5fcb0ad" class="i property">IdentityEndpoint</a>;
            <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r2 rd" class="r2 r">imdsEndpoint</span> = <a href="EnvironmentVariables.cs.html#c2ba6c1998ea65d9" class="t t">EnvironmentVariables</a>.<a href="EnvironmentVariables.cs.html#432bdb38c10815af" class="i property">ImdsEndpoint</a>;
 
            <span class="c">// if BOTH the env vars IDENTITY_ENDPOINT and IMDS_ENDPOINT are set the MsiType is Azure Arc</span>
            <b>if</b> (<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r1 r">identityEndpoint</span>) || <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<span class="r2 r">imdsEndpoint</span>))
            {
                <b>return</b> <b>default</b>;
            }
 
            <b>if</b> (!<a href="@1@netstandard/A.html#991565dd25f47c90" class="t t">Uri</a>.<a href="@1@netstandard/A.html#49754736d6982eb6" class="i method">TryCreate</a>(<span class="r1 r">identityEndpoint</span>, <a href="@1@netstandard/A.html#ac43655101ad74be" class="t t">UriKind</a>.<a href="@1@netstandard/A.html#d734108197254429" class="i field">Absolute</a>, <b>out</b> <a href="@1@netstandard/A.html#991565dd25f47c90" class="t t">Uri</a> <span id="r3 rd" class="r3 r">endpointUri</span>))
            {
                <b>throw</b> <b>new</b> <a href="AuthenticationFailedException.cs.html#fb3c8b081324305b" class="t constructor">AuthenticationFailedException</a>(<a href="#43f2359e058a68d4" class="i field">IdentityEndpointInvalidUriError</a>);
            }
 
            <b>return</b> <b>new</b> <a href="#ed042587fd5661fd" class="t constructor">AzureArcManagedIdentitySource</a>(<span class="r0 r">options</span>.<a href="ManagedIdentityClientOptions.cs.html#40faea45885c391a" class="i property">Pipeline</a>, <span class="r3 r">endpointUri</span>, <span class="r0 r">options</span>.<a href="ManagedIdentityClientOptions.cs.html#4958969e78e3e0d8" class="i property">ClientId</a>);
        }
 
        <b>private</b> <a id="ed042587fd5661fd" href="R/ed042587fd5661fd.html" target="n" data-glyph="76,1" class="t constructor">AzureArcManagedIdentitySource</a>(<a href="CredentialPipeline.cs.html#c499b392d2e1b5fb" class="t t">CredentialPipeline</a> <span id="r4 rd" class="r4 r">pipeline</span>, <a href="@1@netstandard/A.html#991565dd25f47c90" class="t t">Uri</a> <span id="r5 rd" class="r5 r">endpoint</span>, <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r6 rd" class="r6 r">clientId</span>) : <a href="ManagedIdentitySource.cs.html#edace3126b4078cf" class="k">base</a>(<span class="r4 r">pipeline</span>)
        {
            <a href="#fc5c13e2b3f31d53" class="i field">_endpoint</a> = <span class="r5 r">endpoint</span>;
            <a href="#ba54f7b36d4b1d0d" class="i field">_clientId</a> = <span class="r6 r">clientId</span>;
        }
 
        <b>protected override</b> <a href="/Azure.Core/A.html#a519adbefba2e288" class="t t">Request</a> <a id="5e51d6b00641932f" href="R/5e51d6b00641932f.html" target="n" data-glyph="75,1" class="i method">CreateRequest</a>(<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>[] <span id="r7 rd" class="r7 r">scopes</span>)
        {
            <span class="c">// arc MI endpoint doesn&#39;t support user assigned identities so if client id was specified throw AuthenticationFailedException</span>
            <b>if</b> (!<a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@1@netstandard/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<a href="#ba54f7b36d4b1d0d" class="i field">_clientId</a>))
            {
                <b>throw</b> <b>new</b> <a href="AuthenticationFailedException.cs.html#fb3c8b081324305b" class="t constructor">AuthenticationFailedException</a>(<a href="#9111cb7f56aee229" class="i field">UserAssignedNotSupportedErrorMessage</a>);
            }
 
            <span class="c">// covert the scopes to a resource string</span>
            <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r8 rd" class="r8 r">resource</span> = <a href="ScopeUtilities.cs.html#65eff6769481ceb6" class="t t">ScopeUtilities</a>.<a href="ScopeUtilities.cs.html#472c79fe4d466ac8" class="i method">ScopesToResource</a>(<span class="r7 r">scopes</span>);
            <a href="/Azure.Core/A.html#a519adbefba2e288" class="t t">Request</a> <span id="r9 rd" class="r9 r">request</span> = <a href="ManagedIdentitySource.cs.html#3ac6b239e722e77a" class="i property">Pipeline</a>.<a href="CredentialPipeline.cs.html#f970784bc1812f80" class="i property">HttpPipeline</a>.<a href="/Azure.Core/A.html#6751a95ec456ee31" class="i method">CreateRequest</a>();
            <span class="r9 r">request</span>.<a href="/Azure.Core/A.html#38781a2f20c88339" class="i property">Method</a> = <a href="/Azure.Core/A.html#fccfde0a4ed3b2c2" class="t t">RequestMethod</a>.<a href="/Azure.Core/A.html#c1939eaa5920682f" class="i property">Get</a>;
            <span class="r9 r">request</span>.<a href="/Azure.Core/A.html#e6c474e362de2358" class="i property">Headers</a>.<a href="/Azure.Core/A.html#c446fa86f8d3ef04" class="i method">Add</a>(<span class="s">&quot;Metadata&quot;</span>, <span class="s">&quot;true&quot;</span>);
 
            <span class="r9 r">request</span>.<a href="/Azure.Core/A.html#a3954f29cb1a883c" class="i property">Uri</a>.<a href="/Azure.Core/A.html#79e001a52a92afbe" class="i method">Reset</a>(<a href="#fc5c13e2b3f31d53" class="i field">_endpoint</a>);
            <span class="r9 r">request</span>.<a href="/Azure.Core/A.html#a3954f29cb1a883c" class="i property">Uri</a>.<a href="/Azure.Core/A.html#6fa915bdbe4ddf27" class="i method">AppendQuery</a>(<span class="s">&quot;api-version&quot;</span>, <a href="#5f04cce1fe3a8080" class="i field">ArcApiVersion</a>);
 
            <span class="r9 r">request</span>.<a href="/Azure.Core/A.html#a3954f29cb1a883c" class="i property">Uri</a>.<a href="/Azure.Core/A.html#6fa915bdbe4ddf27" class="i method">AppendQuery</a>(<span class="s">&quot;resource&quot;</span>, <span class="r8 r">resource</span>);
 
            <b>return</b> <span class="r9 r">request</span>;
        }
 
        <b>protected override async</b> <span class="t t">ValueTask</span>&lt;<a href="/Azure.Core/A.html#b9cb398886850745" class="t t">AccessToken</a>&gt; <a id="25d44039af185586" href="R/25d44039af185586.html" target="n" data-glyph="75,1" class="i method">HandleResponseAsync</a>(<b>bool</b> <span id="r10 rd" class="r10 r">async</span>, <a href="/Azure.Core/A.html#9d9eb2813d5fd899" class="t t">TokenRequestContext</a> <span id="r11 rd" class="r11 r">context</span>, <a href="/Azure.Core/A.html#ad97b1910f5ca3eb" class="t t">Response</a> <span id="r12 rd" class="r12 r">response</span>, <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r13 rd" class="r13 r">cancellationToken</span>)
        {
            <b>if</b> (<span class="r12 r">response</span>.<a href="/Azure.Core/A.html#53e6401c580f9719" class="i property">Status</a> == 401)
            {
                <b>if</b> (!<span class="r12 r">response</span>.<a href="/Azure.Core/A.html#9f6adbd7e81f8000" class="i property">Headers</a>.<a href="/Azure.Core/A.html#b9e2782d1af92ede" class="i method">TryGetValue</a>(<span class="s">&quot;WWW-Authenticate&quot;</span>, <b>out string</b> <span id="r14 rd" class="r14 r">challenge</span>))
                {
                    <b>throw</b> <b>new</b> <a href="AuthenticationFailedException.cs.html#fb3c8b081324305b" class="t constructor">AuthenticationFailedException</a>(<a href="#9cab5538e739f37f" class="i field">NoChallengeErrorMessage</a>);
                }
 
                <b>var</b> <span id="r15 rd" class="r15 r">splitChallenge</span> = <span class="r14 r">challenge</span>.<a href="@1@netstandard/A.html#1ff97959e1d46a53" class="i method">Split</a>(<b>new</b> <b>char</b>[] { <span class="s">&#39;=&#39;</span> }, <a href="@1@netstandard/A.html#a948431c3f385783" class="t t">StringSplitOptions</a>.<a href="@1@netstandard/A.html#249c323b50d44651" class="i field">RemoveEmptyEntries</a>);
 
                <b>if</b> (<span class="r15 r">splitChallenge</span>.<a href="@1@netstandard/A.html#42e9b7616956cf94" class="i property">Length</a> != 2)
                {
                    <b>throw</b> <b>new</b> <a href="AuthenticationFailedException.cs.html#fb3c8b081324305b" class="t constructor">AuthenticationFailedException</a>(<a href="#a6fbe77d8af1ee21" class="i field">InvalidChallangeErrorMessage</a>);
                }
 
                <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r16 rd" class="r16 r">authHeaderValue</span> = <span class="s">&quot;Basic &quot;</span> + <a href="@1@netstandard/A.html#1c7421e464f67b7e" class="t t">File</a>.<a href="@1@netstandard/A.html#8a84c56a62fd8d45" class="i method">ReadAllText</a>(<span class="r15 r">splitChallenge</span>[1]);
 
                <b>using</b> <a href="/Azure.Core/A.html#a519adbefba2e288" class="t t">Request</a> <span id="r17 rd" class="r17 r">request</span> = <a href="#5e51d6b00641932f" class="i method">CreateRequest</a>(<span class="r11 r">context</span>.<a href="/Azure.Core/A.html#c2d39696789a7847" class="i property">Scopes</a>);
 
                <span class="r17 r">request</span>.<a href="/Azure.Core/A.html#e6c474e362de2358" class="i property">Headers</a>.<a href="/Azure.Core/A.html#c446fa86f8d3ef04" class="i method">Add</a>(<span class="s">&quot;Authorization&quot;</span>, <span class="r16 r">authHeaderValue</span>);
 
                <span class="r12 r">response</span> = <span class="r10 r">async</span>
                    ? <b>await</b> <a href="ManagedIdentitySource.cs.html#3ac6b239e722e77a" class="i property">Pipeline</a>.<a href="CredentialPipeline.cs.html#f970784bc1812f80" class="i property">HttpPipeline</a>.<a href="/Azure.Core/A.html#050e54deb97e58f3" class="i method">SendRequestAsync</a>(<span class="r17 r">request</span>, <span class="r13 r">cancellationToken</span>).<span class="i method">ConfigureAwait</span>(<b>false</b>)
                    : <a href="ManagedIdentitySource.cs.html#3ac6b239e722e77a" class="i property">Pipeline</a>.<a href="CredentialPipeline.cs.html#f970784bc1812f80" class="i property">HttpPipeline</a>.<a href="/Azure.Core/A.html#55a8fc3c4f00882e" class="i method">SendRequest</a>(<span class="r17 r">request</span>, <span class="r13 r">cancellationToken</span>);
 
                <b>return</b> <b>await</b> <a href="ManagedIdentitySource.cs.html#56166eaff4308374" class="k">base</a>.<a href="ManagedIdentitySource.cs.html#076772f1c06f0a4b" class="i method">HandleResponseAsync</a>(<span class="r10 r">async</span>, <span class="r11 r">context</span>, <span class="r12 r">response</span>, <span class="r13 r">cancellationToken</span>).<span class="i method">ConfigureAwait</span>(<b>false</b>);
            }
 
            <b>return</b> <b>await</b> <a href="ManagedIdentitySource.cs.html#56166eaff4308374" class="k">base</a>.<a href="ManagedIdentitySource.cs.html#076772f1c06f0a4b" class="i method">HandleResponseAsync</a>(<span class="r10 r">async</span>, <span class="r11 r">context</span>, <span class="r12 r">response</span>, <span class="r13 r">cancellationToken</span>).<span class="i method">ConfigureAwait</span>(<b>false</b>);
        }
    }
}
</pre></td></tr></table></div></body></html>
