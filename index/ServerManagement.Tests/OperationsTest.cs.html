<!DOCTYPE html>
<html><head><title>OperationsTest.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(565);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#ServerManagement.Tests/OperationsTest.cs" target="_top">OperationsTest.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#ServerManagement.Tests" target="_top">tests\Microsoft.Azure.Management.ServerManagement.Tests.csproj</a> (ServerManagement.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for</span>
<span class="c">// license information.</span>
 
<b>using</b> <span class="i">System</span>;
<b>using</b> <span class="i">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Text</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">ServerManagement</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Management</span>.<span class="i n">ServerManagement</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">Rest</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">Rest</span>.<span class="i">Azure</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">Rest</span>.<span class="i">ClientRuntime</span>.<span class="i">Azure</span>.<span class="i">TestFramework</span>;
<b>using</b> <span class="i">Xunit</span>;
<b>using</b> <span class="i">Xunit</span>.<span class="i">Abstractions</span>;
 
<b>namespace</b> <span class="i n">ServerManagement</span>.<span class="i n">Tests</span>
{
    <b>public class</b> <a id="1fa8f735f1185dff" href="R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">OperationsTest</a> : <a href="ServerManagementTestBase.cs.html#aa270c4456625330" class="t t">ServerManagementTestBase</a>
    {
        <b>public</b> <a id="d66c1ca5953d7343" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">OperationsTest</a>(<span class="i">ITestOutputHelper</span> <span id="r0 rd" class="r0 r">output</span>) : <a href="ServerManagementTestBase.cs.html#c168acba4f6656cb" class="k">base</a>(<span class="r0 r">output</span>)
        {
        }
 
        <b>private async</b> <span class="i">Task</span> <a id="5a10d82c5bc5b13b" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">RunPowerShellCommand</a>(<a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="t t">ServerManagementClient</a> <span id="r1 rd" class="r1 r">client</span>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#edcfdd73c9ff2d67" class="t t">NodeResource</a> <span id="r2 rd" class="r2 r">node</span>,
            <a href="/Microsoft.Azure.Management.ServerManagement/A.html#e84255680b9ec48d" class="t t">SessionResource</a> <span id="r3 rd" class="r3 r">session</span>,
            <a href="/Microsoft.Azure.Management.ServerManagement/A.html#4de853940c146d17" class="t t">PowerShellSessionResource</a> <span id="r4 rd" class="r4 r">ps</span>)
        {
            <span class="c">// run a command</span>
            <b>var</b> <span id="r5 rd" class="r5 r">result</span> =
                <b>await</b>
                    <span class="r1 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#d5808e826321d01b" class="i property">PowerShell</a>.<span class="i">InvokeCommandAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>,
                        <span class="r2 r">node</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>,
                        <span class="r3 r">session</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>,
                        <span class="r4 r">ps</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#7de0801159289d58" class="i property">SessionId</a>,
                        <span class="s">&quot;dir c:\\&quot;</span>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r5 r">result</span>);
 
            <span class="c">// did the command complete successfully?t</span>
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r5 r">result</span>.<span class="i">Completed</span>);
 
            <span class="c">// did we get some results?</span>
            <b>var</b> <span id="r6 rd" class="r6 r">found</span> = <b>false</b>;
            <b>foreach</b> (<b>var</b> <span id="r7 rd" class="r7 r">r</span> <b>in</b> <span class="r5 r">result</span>.<span class="i">Results</span>)
            {
                <span class="r6 r">found</span> = <b>true</b>;
                <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot; {0}&quot;</span>, <span class="r7 r">r</span>.<span class="i">ToJson</span>()));
            }
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r6 r">found</span>);
        }
 
        <b>private async</b> <span class="i">Task</span> <a id="c7f6cc1e12496359" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">RunLongPowerShellCommand</a>(<a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="t t">ServerManagementClient</a> <span id="r8 rd" class="r8 r">client</span>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#edcfdd73c9ff2d67" class="t t">NodeResource</a> <span id="r9 rd" class="r9 r">node</span>,
            <a href="/Microsoft.Azure.Management.ServerManagement/A.html#e84255680b9ec48d" class="t t">SessionResource</a> <span id="r10 rd" class="r10 r">session</span>,
            <a href="/Microsoft.Azure.Management.ServerManagement/A.html#4de853940c146d17" class="t t">PowerShellSessionResource</a> <span id="r11 rd" class="r11 r">ps</span>)
        {
            <span class="c">// run a command</span>
            <b>var</b> <span id="r12 rd" class="r12 r">result</span> = <b>await</b> <span class="r8 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#d5808e826321d01b" class="i property">PowerShell</a>.<span class="i">InvokeCommandAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>,
                <span class="r9 r">node</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>,
                <span class="r10 r">session</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>,
                <span class="r11 r">ps</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#7de0801159289d58" class="i property">SessionId</a>,
                <span class="s">&quot;dir c:\\ ; sleep 20 ; dir c:\\windows&quot;</span>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r12 r">result</span>);
 
            <span class="c">// this should return false because 20 seconds is too long...</span>
            <span class="c">// did the command complete successfully?</span>
            <span class="i">Assert</span>.<span class="i">False</span>(<span class="r12 r">result</span>.<span class="i">Completed</span>);
 
            <span class="c">// did we get some results?</span>
            <b>var</b> <span id="r13 rd" class="r13 r">found</span> = <b>false</b>;
            <b>foreach</b> (<b>var</b> <span id="r14 rd" class="r14 r">r</span> <b>in</b> <span class="r12 r">result</span>.<span class="i">Results</span>)
            {
                <span class="r13 r">found</span> = <b>true</b>;
                <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot; {0}&quot;</span>, <span class="r14 r">r</span>.<span class="i">ToJson</span>()));
            }
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r13 r">found</span>);
 
            <a href="/Microsoft.Azure.Management.ServerManagement/A.html#4c25d0dccee8d23f" class="t t">PowerShellCommandStatus</a> <span id="r15 rd" class="r15 r">more</span>;
            <span class="r13 r">found</span> = <b>false</b>;
            <span class="c">// go back for some more results.</span>
            <b>do</b>
            {
                <span class="r15 r">more</span> = <b>await</b> <span class="r8 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#d5808e826321d01b" class="i property">PowerShell</a>.<span class="i">GetCommandStatusAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>,
                    <span class="r9 r">node</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>,
                    <span class="r10 r">session</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>,
                    <span class="r11 r">ps</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#7de0801159289d58" class="i property">SessionId</a>,
                    <a href="/Microsoft.Azure.Management.ServerManagement/A.html#b7975f23111e72a3" class="t t">PowerShellExpandOption</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#f8210f80ac3da7e9" class="i field">Output</a>);
 
                <b>foreach</b> (<b>var</b> <span id="r16 rd" class="r16 r">r</span> <b>in</b> <span class="r15 r">more</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#ee3c5eac86767e3a" class="i property">Results</a>)
                {
                    <span class="r13 r">found</span> = <b>true</b>;
                    <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot; {0}&quot;</span>, <span class="r16 r">r</span>.<span class="i">ToJson</span>()));
                }
            } <b>while</b> (!(<span class="r15 r">more</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#2b517b9a86cd9b9f" class="i property">Completed</a> ?? <b>false</b>));
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r13 r">found</span>);
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r15 r">more</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#2b517b9a86cd9b9f" class="i property">Completed</a>);
        }
 
        <b>private async</b> <span class="i">Task</span> <a id="8d2f2b90342b011a" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ListPowerShellSessions</a>(<a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="t t">ServerManagementClient</a> <span id="r17 rd" class="r17 r">client</span>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#edcfdd73c9ff2d67" class="t t">NodeResource</a> <span id="r18 rd" class="r18 r">node</span>,
            <a href="/Microsoft.Azure.Management.ServerManagement/A.html#e84255680b9ec48d" class="t t">SessionResource</a> <span id="r19 rd" class="r19 r">session</span>)
        {
            <b>bool</b> <span id="r20 rd" class="r20 r">found</span>;
            <span class="c">// list the powershell sessions open</span>
            <b>var</b> <span id="r21 rd" class="r21 r">sessions</span> = <b>await</b> <span class="r17 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#d5808e826321d01b" class="i property">PowerShell</a>.<span class="i">ListSessionAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <span class="r18 r">node</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>, <span class="r19 r">session</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r21 r">sessions</span>);
            <span class="r20 r">found</span> = <b>false</b>;
            <b>foreach</b> (<b>var</b> <span id="r22 rd" class="r22 r">s</span> <b>in</b> <span class="r21 r">sessions</span>.<span class="i">Value</span>)
            {
                <span class="r20 r">found</span> = <b>true</b>;
                <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot; {0}&quot;</span>, <span class="r22 r">s</span>.<span class="i">ToJson</span>()));
            }
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r20 r">found</span>);
        }
 
        <b>private async</b> <span class="i">Task</span>&lt;<span class="i">IPage</span>&lt;<a href="/Microsoft.Azure.Management.ServerManagement/A.html#edcfdd73c9ff2d67" class="t t">NodeResource</a>&gt;&gt; <a id="967cf907e4655d78" href="R/967cf907e4655d78.html" target="n" data-glyph="76,1" class="i method">ListNodesInSubscription</a>(<a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="t t">ServerManagementClient</a> <span id="r23 rd" class="r23 r">client</span>)
        {
            <span class="c">// look at all the nodes in the subscription</span>
            <b>var</b> <span id="r24 rd" class="r24 r">nodes</span> = <b>await</b> <span class="r23 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#fc9f0460be9fe7df" class="i property">Node</a>.<span class="i">ListAsync</span>();
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r24 r">nodes</span>);
 
            <b>var</b> <span id="r25 rd" class="r25 r">found</span> = <b>false</b>;
            <b>foreach</b> (<b>var</b> <span id="r26 rd" class="r26 r">n</span> <b>in</b> <span class="r24 r">nodes</span>)
            {
                <span class="r25 r">found</span> = <b>true</b>;
                <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot;Found node in subscription: {0}&quot;</span>, <span class="r26 r">n</span>.<span class="i">Name</span>));
            }
 
            <span class="c">// make sure we got *some* back.</span>
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r25 r">found</span>, <span class="s">&quot;No nodes in collection&quot;</span>);
            <b>return</b> <span class="r24 r">nodes</span>;
        }
 
        <b>private static async</b> <span class="i">Task</span>&lt;<a href="/Microsoft.Azure.Management.ServerManagement/A.html#edcfdd73c9ff2d67" class="t t">NodeResource</a>&gt; <a id="7984a66b8e2a095e" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">CreateNode</a>(<a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="t t">ServerManagementClient</a> <span id="r27 rd" class="r27 r">client</span>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#22876475cbab8ab0" class="t t">GatewayResource</a> <span id="r28 rd" class="r28 r">gateway</span>, <b>string</b> <span id="r29 rd" class="r29 r">userName</span>, <b>string</b> <span id="r30 rd" class="r30 r">password</span>)
        {
            <b>var</b> <span id="r31 rd" class="r31 r">node</span> = <b>await</b> <span class="r27 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#fc9f0460be9fe7df" class="i property">Node</a>.<span class="i">CreateAsync</span>(
                <a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>,
                <a href="ServerManagementTestBase.cs.html#511a120cd1125537" class="i property">NodeName</a>,
                <span class="i">connectionName</span>: <a href="ServerManagementTestBase.cs.html#511a120cd1125537" class="i property">NodeName</a>,
                <span class="i">gatewayId</span>: <span class="r28 r">gateway</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#07bc30facf5eda09" class="i property">Id</a>,
                <span class="i">location</span>: <a href="ServerManagementTestBase.cs.html#ce15f52e44a2aedc" class="i property">Location</a>,
                <span class="i">userName</span>: <span class="r29 r">userName</span>,
                <span class="i">password</span>: <span class="r30 r">password</span>
                );
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r31 r">node</span>);
            <b>return</b> <span class="r31 r">node</span>;
        }
 
        <b>private async</b> <span class="i">Task</span>&lt;<a href="/Microsoft.Azure.Management.ServerManagement/A.html#22876475cbab8ab0" class="t t">GatewayResource</a>&gt; <a id="ea70cc25ac51362d" href="R/ea70cc25ac51362d.html" target="n" data-glyph="76,1" class="i method">CreateAndConfigureGateway</a>(<a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="t t">ServerManagementClient</a> <span id="r32 rd" class="r32 r">client</span>, <b>string</b> <span id="r33 rd" class="r33 r">GatewayName</span>)
        {
            <a href="/Microsoft.Azure.Management.ServerManagement/A.html#22876475cbab8ab0" class="t t">GatewayResource</a> <span id="r34 rd" class="r34 r">gateway</span>;
            <span class="c">// create a gateway</span>
            <span class="r34 r">gateway</span> = <b>await</b> <span class="r32 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">CreateAsync</span>(
                <a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>,
                <span class="r33 r">GatewayName</span>,
                <span class="i">upgradeMode</span>: <a href="/Microsoft.Azure.Management.ServerManagement/A.html#3f17bc2069724a94" class="t t">UpgradeMode</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#2c06cc85e49225a4" class="i field">Automatic</a>,
                <span class="i">location</span>: <a href="ServerManagementTestBase.cs.html#ce15f52e44a2aedc" class="i property">Location</a>
                );
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r34 r">gateway</span>);
 
            <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot;Created Gateway: {0}&quot;</span>, <span class="r34 r">gateway</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>));
 
            <b>var</b> <span id="r35 rd" class="r35 r">profile</span> = <b>await</b> <span class="r32 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">GetProfileAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <span class="r33 r">GatewayName</span>);
 
            <b>if</b> (<a href="ServerManagementTestBase.cs.html#31a0a424c711af86" class="i property">TestingInteractively</a>)
            {
                <span class="c">// stop the service</span>
                <a href="ServerManagementTestBase.cs.html#bba6bac9b87e93aa" class="i method">StopGateway</a>();
 
                <span class="c">// install the new profile</span>
                <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot;Profile:\r\n{0}&quot;</span>, <span class="r35 r">profile</span>.<span class="i">ToJson</span>()));
                <b>var</b> <span id="r36 rd" class="r36 r">encrypted</span> = <span class="i">ProtectedData</span>.<span class="i">Protect</span>(<span class="i">Encoding</span>.<span class="i">UTF8</span>.<span class="i">GetBytes</span>(<span class="r35 r">profile</span>.<span class="i">ToJsonTight</span>()),
                    <b>null</b>,
                    <span class="i">DataProtectionScope</span>.<span class="i">LocalMachine</span>);
                <b>var</b> <span id="r37 rd" class="r37 r">path</span> = <span class="i">Environment</span>.<span class="i">ExpandEnvironmentVariables</span>(<span class="s">@&quot;%PROGRAMDATA%&quot;</span>) + <span class="s">@&quot;\ManagementGateway&quot;</span>;
                <span class="i">Directory</span>.<span class="i">CreateDirectory</span>(<span class="r37 r">path</span>);
                <span class="i">File</span>.<span class="i">WriteAllBytes</span>(<span class="r37 r">path</span> + <span class="s">@&quot;\GatewayProfile.json&quot;</span>, <span class="r36 r">encrypted</span>);
 
                <span class="c">// start the service.</span>
                <a href="ServerManagementTestBase.cs.html#34ca6bf5f9ff1eb2" class="i method">StartGateway</a>();
 
                <span class="c">// wait for service to initialize itself.</span>
                <span class="i">Task</span>.<span class="i">Delay</span>(180 * 1000).<span class="i">Wait</span>();
            }
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r34 r">gateway</span>);
 
            <b>return</b> <span class="r34 r">gateway</span>;
        }
 
        <b>private async</b> <span class="i">Task</span> <a id="2bceb0b8c26c0121" href="R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">GetTabCompletionResults</a>(<a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="t t">ServerManagementClient</a> <span id="r38 rd" class="r38 r">client</span>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#edcfdd73c9ff2d67" class="t t">NodeResource</a> <span id="r39 rd" class="r39 r">node</span>,
            <a href="/Microsoft.Azure.Management.ServerManagement/A.html#e84255680b9ec48d" class="t t">SessionResource</a> <span id="r40 rd" class="r40 r">session</span>,
            <a href="/Microsoft.Azure.Management.ServerManagement/A.html#4de853940c146d17" class="t t">PowerShellSessionResource</a> <span id="r41 rd" class="r41 r">ps</span>)
        {
            <b>bool</b> <span id="r42 rd" class="r42 r">found</span>;
            <span class="c">// try to get tab command completion</span>
            <b>var</b> <span id="r43 rd" class="r43 r">results</span> = <b>await</b> <span class="r38 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#d5808e826321d01b" class="i property">PowerShell</a>.<span class="i">TabCompletionAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>,
                <span class="r39 r">node</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>,
                <span class="r40 r">session</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#310e3a9fa26a1440" class="i property">Name</a>,
                <span class="r41 r">ps</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#7de0801159289d58" class="i property">SessionId</a>,
                <span class="s">&quot;dir c:\\&quot;</span>);
            <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r43 r">results</span>);
            <span class="r42 r">found</span> = <b>false</b>;
            <b>foreach</b> (<b>var</b> <span id="r44 rd" class="r44 r">s</span> <b>in</b> <span class="r43 r">results</span>.<span class="i">Results</span>)
            {
                <span class="r42 r">found</span> = <b>true</b>;
                <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot; {0}&quot;</span>, <span class="r44 r">s</span>.<span class="i">ToJson</span>()));
            }
            <span class="i">Assert</span>.<span class="i">True</span>(<span class="r42 r">found</span>);
        }
 
        [<span class="i">Fact</span>]
        <b>public async</b> <span class="i">Task</span> <a id="68a9cbb22a3f45ac" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CreateGatewayFailTest</a>()
        {
            <span class="c">// ensure known state before starting.</span>
            <b>await</b> <a href="ServerManagementTestBase.cs.html#55ba6778e9474fd9" class="i method">EnsurePrerequisites</a>();
 
            <b>using</b> (<b>var</b> <span id="r45 rd" class="r45 r">context</span> = <span class="i">MockContext</span>.<span class="i">Start</span>(<span class="s">&quot;Tests&quot;</span>))
            {
                <a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="k">var</a> <span id="r46 rd" class="r46 r">client</span> = <span class="i">GetServerManagementClient</span>(<span class="r45 r">context</span>);
 
                <span class="c">// try an empty string for name</span>
                <b>await</b> <span class="i">Assert</span>.<span class="i">ThrowsAsync</span>&lt;<span class="i">ValidationException</span>&gt;(() =&gt; <span class="r46 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">CreateAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <span class="s">&quot;&quot;</span>));
 
                <span class="c">// try a non existent resource group</span>
                <b>await</b> <span class="i">Assert</span>.<span class="i">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Management.ServerManagement/A.html#3c1a23925601d4bd" class="t t">ErrorException</a>&gt;(
                    () =&gt; <span class="r46 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">CreateAsync</span>(<span class="s">&quot;mary had a little lamb&quot;</span>, <span class="s">&quot;testgateway&quot;</span>));
 
                <span class="c">// try a bad location</span>
                <b>await</b> <span class="i">Assert</span>.<span class="i">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Management.ServerManagement/A.html#3c1a23925601d4bd" class="t t">ErrorException</a>&gt;(
                    () =&gt; <span class="r46 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">CreateAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <span class="s">&quot;testgateway&quot;</span>, <span class="s">&quot;neverneverland&quot;</span>));
            }
        }
 
        [<span class="i">Fact</span>]
        <b>public async</b> <span class="i">Task</span> <a id="182de0e866864666" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GatewayTest</a>()
        {
            <span class="c">// ensure known state before starting.</span>
            <b>await</b> <a href="ServerManagementTestBase.cs.html#55ba6778e9474fd9" class="i method">EnsurePrerequisites</a>();
 
            <b>using</b> (<b>var</b> <span id="r47 rd" class="r47 r">context</span> = <span class="i">MockContext</span>.<span class="i">Start</span>(<span class="s">&quot;Tests&quot;</span>))
            {
                <a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="k">var</a> <span id="r48 rd" class="r48 r">client</span> = <span class="i">GetServerManagementClient</span>(<span class="r47 r">context</span>);
 
                <b>try</b>
                {
                    <span class="c">// create a gateway</span>
                    <b>var</b> <span id="r49 rd" class="r49 r">gateway</span> = <b>await</b> <span class="r48 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">CreateAsync</span>(
                        <a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>,
                        <a href="ServerManagementTestBase.cs.html#403787a7942e2142" class="i property">GatewayOne</a>,
                        <span class="i">upgradeMode</span>: <a href="/Microsoft.Azure.Management.ServerManagement/A.html#3f17bc2069724a94" class="t t">UpgradeMode</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#2c06cc85e49225a4" class="i field">Automatic</a>,
                        <span class="i">location</span>: <a href="ServerManagementTestBase.cs.html#ce15f52e44a2aedc" class="i property">Location</a>
                        );
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r49 r">gateway</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="ServerManagementTestBase.cs.html#403787a7942e2142" class="i property">GatewayOne</a>, <span class="r49 r">gateway</span>.<span class="i">Name</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="s">&quot;microsoft.servermanagement/gateways&quot;</span>, <span class="r49 r">gateway</span>.<span class="i">Type</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="ServerManagementTestBase.cs.html#ce15f52e44a2aedc" class="i property">Location</a>, <span class="r49 r">gateway</span>.<span class="i">Location</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="/Microsoft.Azure.Management.ServerManagement/A.html#3f17bc2069724a94" class="t t">UpgradeMode</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#2c06cc85e49225a4" class="i field">Automatic</a>, <span class="r49 r">gateway</span>.<span class="i">UpgradeMode</span>);
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="r49 r">gateway</span>.<span class="i">ToJson</span>());
 
                    <span class="c">// verify that we can get the gateway again.</span>
                    <span class="r49 r">gateway</span> = <b>await</b> <span class="r48 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#403787a7942e2142" class="i property">GatewayOne</a>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r49 r">gateway</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="ServerManagementTestBase.cs.html#403787a7942e2142" class="i property">GatewayOne</a>, <span class="r49 r">gateway</span>.<span class="i">Name</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="s">&quot;microsoft.servermanagement/gateways&quot;</span>, <span class="r49 r">gateway</span>.<span class="i">Type</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="ServerManagementTestBase.cs.html#ce15f52e44a2aedc" class="i property">Location</a>, <span class="r49 r">gateway</span>.<span class="i">Location</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="/Microsoft.Azure.Management.ServerManagement/A.html#3f17bc2069724a94" class="t t">UpgradeMode</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#2c06cc85e49225a4" class="i field">Automatic</a>, <span class="r49 r">gateway</span>.<span class="i">UpgradeMode</span>);
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="r49 r">gateway</span>.<span class="i">ToJson</span>());
 
                    <span class="c">// update the gateway a bit.</span>
                    <span class="r49 r">gateway</span> = <b>await</b> <span class="r48 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">UpdateAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>,
                        <a href="ServerManagementTestBase.cs.html#403787a7942e2142" class="i property">GatewayOne</a>,
                        <a href="ServerManagementTestBase.cs.html#ce15f52e44a2aedc" class="i property">Location</a>,
                        <span class="i">upgradeMode</span>: <a href="/Microsoft.Azure.Management.ServerManagement/A.html#3f17bc2069724a94" class="t t">UpgradeMode</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#2c06cc85e49225a4" class="i field">Automatic</a>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="/Microsoft.Azure.Management.ServerManagement/A.html#3f17bc2069724a94" class="t t">UpgradeMode</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#2c06cc85e49225a4" class="i field">Automatic</a>, <span class="r49 r">gateway</span>.<span class="i">UpgradeMode</span>);
 
                    <span class="c">// get the gateway status</span>
                    <span class="r49 r">gateway</span> = <b>await</b> <span class="r48 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#403787a7942e2142" class="i property">GatewayOne</a>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#bcd232cda8b43c12" class="t t">GatewayExpandOption</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#efa8730f51c05691" class="i field">Status</a>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r49 r">gateway</span>);
 
                    <span class="c">// check for some extended properties</span>
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r49 r">gateway</span>.<span class="i">LatestPublishedMsiVersion</span>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r49 r">gateway</span>.<span class="i">ActiveMessageCount</span>);
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="r49 r">gateway</span>.<span class="i">ToJson</span>());
 
                    <span class="c">// Let&#39;s see how many gatways are in the subscription</span>
                    <b>var</b> <span id="r50 rd" class="r50 r">gateways</span> = <b>await</b> <span class="r48 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">ListAsync</span>();
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r50 r">gateways</span>);
 
                    <b>var</b> <span id="r51 rd" class="r51 r">found</span> = <b>false</b>;
                    <b>foreach</b> (<b>var</b> <span id="r52 rd" class="r52 r">g</span> <b>in</b> <span class="r50 r">gateways</span>)
                    {
                        <span class="r51 r">found</span> = <b>true</b>;
                        <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot;Found Gateway in subscription: {0}&quot;</span>, <span class="r52 r">g</span>.<span class="i">Name</span>));
                    }
 
                    <span class="i">Assert</span>.<span class="i">True</span>(<span class="r51 r">found</span>, <span class="s">&quot;No gateways in collection?&quot;</span>);
                }
                <b>finally</b>
                {
                    <span class="c">// remove gateway that we&#39;ve created </span>
                    <a href="ServerManagementTestBase.cs.html#36edeb0261d17d9b" class="i method">RemoveGateway</a>(<span class="r48 r">client</span>, <a href="ServerManagementTestBase.cs.html#403787a7942e2142" class="i property">GatewayOne</a>).<span class="i">Wait</span>();
                }
 
                <span class="c">// make sure that the gateway is gone.</span>
                <b>await</b> <span class="i">Assert</span>.<span class="i">ThrowsAsync</span>&lt;<a href="/Microsoft.Azure.Management.ServerManagement/A.html#3c1a23925601d4bd" class="t t">ErrorException</a>&gt;(() =&gt; <span class="r48 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#403787a7942e2142" class="i property">GatewayOne</a>));
            }
        }
 
        [<span class="i">Fact</span>]
        <b>public async</b> <span class="i">Task</span> <a id="f9e442665ad32b06" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">NodeTest</a>()
        {
            <span class="c">// ensure known state before starting.</span>
            <b>await</b> <a href="ServerManagementTestBase.cs.html#55ba6778e9474fd9" class="i method">EnsurePrerequisites</a>();
 
            <b>using</b> (<b>var</b> <span id="r53 rd" class="r53 r">context</span> = <span class="i">MockContext</span>.<span class="i">Start</span>(<span class="s">&quot;Tests&quot;</span>))
            {
                <a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="k">var</a> <span id="r54 rd" class="r54 r">client</span> = <span class="i">GetServerManagementClient</span>(<span class="r53 r">context</span>);
                <a href="/Microsoft.Azure.Management.ServerManagement/A.html#22876475cbab8ab0" class="t t">GatewayResource</a> <span id="r55 rd" class="r55 r">gateway</span> = <b>null</b>;
 
                <b>if</b> (!<a href="ServerManagementTestBase.cs.html#d78b77279e578c0c" class="i property">ForceResetGatewayProfile</a>)
                {
                    <b>try</b>
                    {
                        <span class="r55 r">gateway</span> = <b>await</b> <span class="r54 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>);
 
                        <span class="c">// make sure the gateway service is running.</span>
                        <a href="ServerManagementTestBase.cs.html#34ca6bf5f9ff1eb2" class="i method">StartGateway</a>();
                    }
                    <b>catch</b>
                    {
                        <span class="c">// if it&#39;s not there, we&#39;ll create it anyway.</span>
                    }
                }
                <b>try</b>
                {
                    <b>if</b> (<span class="r55 r">gateway</span> == <b>null</b>)
                    {
                        <span class="c">// create gateway</span>
                        <b>await</b> <a href="#ea70cc25ac51362d" class="i method">CreateAndConfigureGateway</a>(<span class="r54 r">client</span>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>);
 
                        <span class="c">// get gateway status</span>
                        <span class="r55 r">gateway</span> = <b>await</b> <span class="r54 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#bcd232cda8b43c12" class="t t">GatewayExpandOption</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#efa8730f51c05691" class="i field">Status</a>);
                    }
 
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Creating Node&quot;</span>);
                    <b>var</b> <span id="r56 rd" class="r56 r">node</span> = <b>await</b> <span class="i">CreateNode</span>(<span class="r54 r">client</span>, <span class="r55 r">gateway</span>, <b>string</b>.<span class="i">Empty</span>, <b>string</b>.<span class="i">Empty</span>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r56 r">node</span>);
 
                    <span class="c">// get the same node again</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Getting Node&quot;</span>);
                    <span class="r56 r">node</span> = <b>await</b> <span class="r54 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#fc9f0460be9fe7df" class="i property">Node</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#511a120cd1125537" class="i property">NodeName</a>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r56 r">node</span>);
 
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="ServerManagementTestBase.cs.html#511a120cd1125537" class="i property">NodeName</a>, <span class="r56 r">node</span>.<span class="i">Name</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="ServerManagementTestBase.cs.html#511a120cd1125537" class="i property">NodeName</a>, <span class="r56 r">node</span>.<span class="i">ConnectionName</span>);
 
                    <span class="c">// get all the nodes in the subscription</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Listing Nodes&quot;</span>);
                    <b>var</b> <span id="r57 rd" class="r57 r">nodes</span> = <b>await</b> <a href="#967cf907e4655d78" class="i method">ListNodesInSubscription</a>(<span class="r54 r">client</span>);
 
                    <span class="c">// make sure this resource group just has the one node </span>
                    <span class="r57 r">nodes</span> = <b>await</b> <span class="r54 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#fc9f0460be9fe7df" class="i property">Node</a>.<span class="i">ListForResourceGroupAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>);
                    <span class="i">Assert</span>.<span class="i">Single</span>(<span class="r57 r">nodes</span>);
 
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Creating Session&quot;</span>);
                    <span class="c">// Create a session for this node.</span>
                    <b>var</b> <span id="r58 rd" class="r58 r">session</span> = <b>await</b> <span class="r54 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#1fa36993ff34a04c" class="i property">Session</a>.<span class="i">CreateAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>,
                        <span class="r56 r">node</span>.<span class="i">Name</span>,
                        <a href="ServerManagementTestBase.cs.html#e6307178dcad137a" class="i property">SessionId</a>,
                        <a href="ServerManagementTestBase.cs.html#6ed9eb70ea2cc23c" class="i property">NodeUserName</a>,
                        <a href="ServerManagementTestBase.cs.html#9e2f3a7ad419c7fa" class="i property">NodePassword</a>);
 
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r58 r">session</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="r58 r">session</span>.<span class="i">Name</span>, <a href="ServerManagementTestBase.cs.html#e6307178dcad137a" class="i property">SessionId</a>);
 
                    <span class="c">// Get the same session again</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Getting Session&quot;</span>);
                    <span class="r58 r">session</span> = <b>await</b> <span class="r54 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#1fa36993ff34a04c" class="i property">Session</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <span class="r56 r">node</span>.<span class="i">Name</span>, <span class="r58 r">session</span>.<span class="i">Name</span>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r58 r">session</span>);
                    <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot;Session/Get response:{0}&quot;</span>, <span class="r58 r">session</span>.<span class="i">ToJson</span>()));
 
                    <span class="c">// create a powershell session inside the SMT session</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Creating PowerShell Session&quot;</span>);
                    <b>var</b> <span id="r59 rd" class="r59 r">ps</span> = <b>await</b> <span class="r54 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#d5808e826321d01b" class="i property">PowerShell</a>.<span class="i">CreateSessionAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>,
                        <span class="r56 r">node</span>.<span class="i">Name</span>,
                        <span class="r58 r">session</span>.<span class="i">Name</span>,
                        <a href="../GuidAssembly/R/00000000-0000-0000-0000-000000000000.html" target="n" class="s">&quot;00000000-0000-0000-0000-000000000000&quot;</a>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r59 r">ps</span>);
 
                    <span class="c">// run a powershell command on that session</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Running PowerShell command&quot;</span>);
                    <b>await</b> <span class="i">RunPowerShellCommand</span>(<span class="r54 r">client</span>, <span class="r56 r">node</span>, <span class="r58 r">session</span>, <span class="r59 r">ps</span>);
 
                    <span class="c">// get some tab completion results</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Try Tab Completion&quot;</span>);
                    <b>await</b> <span class="i">GetTabCompletionResults</span>(<span class="r54 r">client</span>, <span class="r56 r">node</span>, <span class="r58 r">session</span>, <span class="r59 r">ps</span>);
 
                    <span class="c">// look at all the open powershell sessions</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;List PowerShell Sessions&quot;</span>);
                    <b>await</b> <span class="i">ListPowerShellSessions</span>(<span class="r54 r">client</span>, <span class="r56 r">node</span>, <span class="r58 r">session</span>);
 
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Try a long-running command.&quot;</span>);
                    <b>await</b> <span class="i">RunLongPowerShellCommand</span>(<span class="r54 r">client</span>, <span class="r56 r">node</span>, <span class="r58 r">session</span>, <span class="r59 r">ps</span>);
 
                    <span class="c">// clean up our active SMT session.</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Delete Session&quot;</span>);
                    <b>await</b> <span class="r54 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#1fa36993ff34a04c" class="i property">Session</a>.<span class="i">DeleteAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <span class="r56 r">node</span>.<span class="i">Name</span>, <span class="r58 r">session</span>.<span class="i">Name</span>);
                }
                <b>finally</b>
                {
                    <span class="c">// remove gateway that we&#39;ve created </span>
                    <b>if</b> (<a href="ServerManagementTestBase.cs.html#d78b77279e578c0c" class="i property">ForceResetGatewayProfile</a>)
                    {
                        <a href="ServerManagementTestBase.cs.html#36edeb0261d17d9b" class="i method">RemoveGateway</a>(<span class="r54 r">client</span>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>).<span class="i">Wait</span>();
                    }
 
                    <span class="c">// regardless, always clear the nodes out.</span>
                    <a href="ServerManagementTestBase.cs.html#4123bfe7feece3c8" class="i method">RemoveAllNodes</a>(<span class="r54 r">client</span>).<span class="i">Wait</span>();
                }
            }
        }
 
        [<span class="i">Fact</span>]
        <b>public async</b> <span class="i">Task</span> <a id="481dc749662589f6" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CreateSession</a>()
        {
            <span class="c">// ensure known state before starting.</span>
            <b>await</b> <a href="ServerManagementTestBase.cs.html#55ba6778e9474fd9" class="i method">EnsurePrerequisites</a>();
 
            <b>using</b> (<b>var</b> <span id="r60 rd" class="r60 r">context</span> = <span class="i">MockContext</span>.<span class="i">Start</span>(<span class="s">&quot;Tests&quot;</span>))
            {
                <a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="k">var</a> <span id="r61 rd" class="r61 r">client</span> = <span class="i">GetServerManagementClient</span>(<span class="r60 r">context</span>);
                <a href="/Microsoft.Azure.Management.ServerManagement/A.html#22876475cbab8ab0" class="t t">GatewayResource</a> <span id="r62 rd" class="r62 r">gateway</span> = <b>null</b>;
 
                <b>if</b> (!<a href="ServerManagementTestBase.cs.html#d78b77279e578c0c" class="i property">ForceResetGatewayProfile</a>)
                {
                    <b>try</b>
                    {
                        <span class="r62 r">gateway</span> = <b>await</b> <span class="r61 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#bcd232cda8b43c12" class="t t">GatewayExpandOption</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#efa8730f51c05691" class="i field">Status</a>);
 
                        <span class="c">// make sure the gateway service is running.</span>
                        <a href="ServerManagementTestBase.cs.html#34ca6bf5f9ff1eb2" class="i method">StartGateway</a>();
                    }
                    <b>catch</b>
                    {
                        <span class="c">// if it&#39;s not there, we&#39;ll create it anyway.</span>
                    }
                }
 
                <b>try</b>
                {
                    <b>if</b> (<span class="r62 r">gateway</span> == <b>null</b>)
                    {
                        <span class="c">// create gateway</span>
                        <b>await</b> <a href="#ea70cc25ac51362d" class="i method">CreateAndConfigureGateway</a>(<span class="r61 r">client</span>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>);
 
                        <span class="c">// get gateway status</span>
                        <span class="r62 r">gateway</span> = <b>await</b> <span class="r61 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#bcd232cda8b43c12" class="t t">GatewayExpandOption</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#efa8730f51c05691" class="i field">Status</a>);
                    }
 
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Creating Node&quot;</span>);
                    <b>var</b> <span id="r63 rd" class="r63 r">node</span> = <b>await</b> <span class="i">CreateNode</span>(<span class="r61 r">client</span>, <span class="r62 r">gateway</span>, <b>string</b>.<span class="i">Empty</span>, <span class="i">String</span>.<span class="i">Empty</span>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r63 r">node</span>);
 
                    <span class="c">// get the same node again</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Getting Node&quot;</span>);
                    <span class="r63 r">node</span> = <b>await</b> <span class="r61 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#fc9f0460be9fe7df" class="i property">Node</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#511a120cd1125537" class="i property">NodeName</a>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r63 r">node</span>);
 
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="ServerManagementTestBase.cs.html#511a120cd1125537" class="i property">NodeName</a>, <span class="r63 r">node</span>.<span class="i">Name</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<a href="ServerManagementTestBase.cs.html#511a120cd1125537" class="i property">NodeName</a>, <span class="r63 r">node</span>.<span class="i">ConnectionName</span>);
 
                    <span class="c">// Create a session for this node.</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Creating Session&quot;</span>);
 
                    <b>var</b> <span id="r64 rd" class="r64 r">username</span> =  <a href="/Microsoft.Azure.Management.ServerManagement/A.html#1c687d5db77ac48e" class="t t">Utility</a>.<span class="i">EncryptUsingGatewaySettings</span>(<span class="r62 r">gateway</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#a61416b99548b526" class="i property">Instances</a>[0], <a href="ServerManagementTestBase.cs.html#6ed9eb70ea2cc23c" class="i property">NodeUserName</a>);
                    <b>var</b> <span id="r65 rd" class="r65 r">password</span> =  <a href="/Microsoft.Azure.Management.ServerManagement/A.html#1c687d5db77ac48e" class="t t">Utility</a>.<span class="i">EncryptUsingGatewaySettings</span>(<span class="r62 r">gateway</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#a61416b99548b526" class="i property">Instances</a>[0], <a href="ServerManagementTestBase.cs.html#9e2f3a7ad419c7fa" class="i property">NodePassword</a>);
 
                    <b>var</b> <span id="r66 rd" class="r66 r">session</span> = <b>await</b> <span class="r61 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#1fa36993ff34a04c" class="i property">Session</a>.<span class="i">CreateAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <span class="r63 r">node</span>.<span class="i">Name</span>, <a href="ServerManagementTestBase.cs.html#fd3f0b31fa4db496" class="i property">SessionIdTwo</a>, <span class="r64 r">username</span>, <span class="r65 r">password</span>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#577857fac38b5923" class="t t">RetentionPeriod</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#d45f0b6e787ad299" class="i field">Session</a>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#bc737407973c92fe" class="t t">CredentialDataFormat</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#8a37a5f94f41b5b3" class="i field">RsaEncrypted</a>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r66 r">session</span>);
                    <span class="i">Assert</span>.<span class="i">Equal</span>(<span class="r66 r">session</span>.<span class="i">Name</span>, <a href="ServerManagementTestBase.cs.html#fd3f0b31fa4db496" class="i property">SessionIdTwo</a>);
 
                    <span class="c">// Get the same session again</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Getting Session&quot;</span>);
                    <span class="r66 r">session</span> = <b>await</b> <span class="r61 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#1fa36993ff34a04c" class="i property">Session</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <span class="r63 r">node</span>.<span class="i">Name</span>, <span class="r66 r">session</span>.<span class="i">Name</span>);
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r66 r">session</span>);
                    <span class="i">WriteLine</span>(<b>string</b>.<span class="i">Format</span>(<span class="s">&quot;Session/Get response:{0}&quot;</span>, <span class="r66 r">session</span>.<span class="i">ToJson</span>()));
 
                    <span class="c">// clean up our active SMT session.</span>
                    <a href="ServerManagementTestBase.cs.html#efa696ce4d9693fc" class="i method">WriteLine</a>(<span class="s">&quot;Delete Session&quot;</span>);
                    <b>await</b> <span class="r61 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#1fa36993ff34a04c" class="i property">Session</a>.<span class="i">DeleteAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <span class="r63 r">node</span>.<span class="i">Name</span>, <span class="r66 r">session</span>.<span class="i">Name</span>);
 
                }
                <b>finally</b>
                {
                    <span class="c">// remove gateway that we&#39;ve created </span>
                    <b>if</b> (<a href="ServerManagementTestBase.cs.html#d78b77279e578c0c" class="i property">ForceResetGatewayProfile</a>)
                    {
                        <a href="ServerManagementTestBase.cs.html#36edeb0261d17d9b" class="i method">RemoveGateway</a>(<span class="r61 r">client</span>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>).<span class="i">Wait</span>();
                    }
 
                    <span class="c">// regardless, always clear the nodes out.</span>
                    <a href="ServerManagementTestBase.cs.html#4123bfe7feece3c8" class="i method">RemoveAllNodes</a>(<span class="r61 r">client</span>).<span class="i">Wait</span>();
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> query gateway using &#39;download&#39; option; verify that the installerDownload and minimumVersion are set and valid</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">Fact</span>]
        <b>public async</b> <span class="i">Task</span> <a id="5e7c1af3020b7f0c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GatewayExpandOptions</a>()
        {
            <span class="c">// ensure known state before starting.</span>
            <b>await</b> <a href="ServerManagementTestBase.cs.html#55ba6778e9474fd9" class="i method">EnsurePrerequisites</a>();
 
            <b>using</b> (<b>var</b> <span id="r67 rd" class="r67 r">context</span> = <span class="i">MockContext</span>.<span class="i">Start</span>(<span class="s">&quot;Tests&quot;</span>))
            {
                <a href="/Microsoft.Azure.Management.ServerManagement/A.html#13eff9a237fc8458" class="k">var</a> <span id="r68 rd" class="r68 r">client</span> = <span class="i">GetServerManagementClient</span>(<span class="r67 r">context</span>);
                <a href="/Microsoft.Azure.Management.ServerManagement/A.html#22876475cbab8ab0" class="t t">GatewayResource</a> <span id="r69 rd" class="r69 r">gateway</span> = <b>null</b>;
 
                <b>if</b> (!<a href="ServerManagementTestBase.cs.html#d78b77279e578c0c" class="i property">ForceResetGatewayProfile</a>)
                {
                    <b>try</b>
                    {
                        <span class="r69 r">gateway</span> = <b>await</b> <span class="r68 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#bcd232cda8b43c12" class="t t">GatewayExpandOption</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#a22779d66cebd586" class="i field">Download</a>);
 
                        <span class="c">// make sure the gateway service is running.</span>
                        <a href="ServerManagementTestBase.cs.html#34ca6bf5f9ff1eb2" class="i method">StartGateway</a>();
                    }
                    <b>catch</b>
                    {
                        <span class="c">// if it&#39;s not there, we&#39;ll create it anyway.</span>
                    }
                }
 
                <b>try</b>
                {
                    <b>if</b> (<span class="r69 r">gateway</span> == <b>null</b>)
                    {
                        <span class="c">// create gateway</span>
                        <b>await</b> <a href="#ea70cc25ac51362d" class="i method">CreateAndConfigureGateway</a>(<span class="r68 r">client</span>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>);
 
                        <span class="c">// get gateway status</span>
                        <span class="r69 r">gateway</span> = <b>await</b> <span class="r68 r">client</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#5545bab9074dfb1b" class="i property">Gateway</a>.<span class="i">GetAsync</span>(<a href="ServerManagementTestBase.cs.html#d764bf26a879d15b" class="i field">ResourceGroup</a>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>, <a href="/Microsoft.Azure.Management.ServerManagement/A.html#bcd232cda8b43c12" class="t t">GatewayExpandOption</a>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#a22779d66cebd586" class="i field">Download</a>);
                    }
 
                    <span class="i">Assert</span>.<span class="i">NotNull</span>(<span class="r69 r">gateway</span>);
                    <span class="i">Assert</span>.<span class="i">True</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r69 r">gateway</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#8c81cd0dc9945bde" class="i property">InstallerDownload</a>));
                    <span class="i">Assert</span>.<span class="i">True</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r69 r">gateway</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#f86e72c70eed6e29" class="i property">MinimumVersion</a>));
 
                    <span class="i">Assert</span>.<span class="i">True</span>(<span class="i">Uri</span>.<span class="i">IsWellFormedUriString</span>(<span class="r69 r">gateway</span>.<a href="/Microsoft.Azure.Management.ServerManagement/A.html#8c81cd0dc9945bde" class="i property">InstallerDownload</a>, <span class="i">UriKind</span>.<span class="i">Absolute</span>));
                }
                <b>finally</b>
                {
                    <span class="c">// remove gateway that we&#39;ve created </span>
                    <b>if</b> (<a href="ServerManagementTestBase.cs.html#d78b77279e578c0c" class="i property">ForceResetGatewayProfile</a>)
                    {
                        <a href="ServerManagementTestBase.cs.html#36edeb0261d17d9b" class="i method">RemoveGateway</a>(<span class="r68 r">client</span>, <a href="ServerManagementTestBase.cs.html#c95033893446f1f0" class="i property">GatewayTwo</a>).<span class="i">Wait</span>();
                    }
                }
            }
        }
    }
}</pre></td></tr></table></div></body></html>
