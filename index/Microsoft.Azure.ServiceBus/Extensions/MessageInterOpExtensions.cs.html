<!DOCTYPE html>
<html><head><title>MessageInterOpExtensions.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(108);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.ServiceBus/Extensions/MessageInterOpExtensions.cs" target="_top">Extensions\MessageInterOpExtensions.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.ServiceBus" target="_top">Microsoft.Azure.ServiceBus.csproj</a> (Microsoft.Azure.ServiceBus)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft. All rights reserved.</span>
<span class="c">// Licensed under the MIT license. See LICENSE file in the project root for full license information.</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">ServiceBus</span>.<span class="i n">InteropExtensions</span>
{
    <b>using</b> <span class="i">System</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">IO</span>;
    <b>using</b> <span class="i">System</span>.<span class="i">Runtime</span>.<span class="i">Serialization</span>;
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> A Message Extension Class that provides extension methods to deserialize</span>
    <span class="c">///</span><span class="c"> the body of a message that was serialized and sent to ServiceBus Queue/Topic</span>
    <span class="c">///</span><span class="c"> using the WindowsAzure.Messaging client library. The WindowsAzure.Messaging</span>
    <span class="c">///</span><span class="c"> client library serializes objects using the</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="DataContractBinarySerializer.cs.html#d415a156d9a8494b" class="t t">DataContractBinarySerializer</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> (default serializer) or </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">DataContractSerializer</span><span class="c">&quot;</span><span class="c">/&gt;</span>
    <span class="c">///</span><span class="c"> when sending message. This class provides extension methods to deserialize</span>
    <span class="c">///</span><span class="c"> and retrieve the body of such messages.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> 1. If a message is only being sent and received using this Microsoft.Azure.ServiceBus</span>
    <span class="c">///</span><span class="c"> client library, then the below extension methods are not relevant and should not be used.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> 2. If this client library will be used to receive messages that were sent using both</span>
    <span class="c">///</span><span class="c"> WindowsAzure.Messaging client library and this (Microsoft.Azure.ServiceBus) library,</span>
    <span class="c">///</span><span class="c"> then the Users need to add a User property </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../Message.cs.html#74fc1aa4fea2b013" class="t t">Message</a>.<a href="../Message.cs.html#f726ec22859aa013" class="i property">UserProperties</a><span class="c">&quot;</span><span class="c">/&gt;</span>
    <span class="c">///</span><span class="c"> while sending the message. On receiving the message, this property can be examined to</span>
    <span class="c">///</span><span class="c"> determine if the message was from WindowsAzure.Messaging client library and if so</span>
    <span class="c">///</span><span class="c"> use the message.GetBody() extension method to get the actual body associated with the message.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> ----------------------------------------------</span>
    <span class="c">///</span><span class="c"> Scenarios to use the GetBody Extension method:</span>
    <span class="c">///</span><span class="c"> ----------------------------------------------</span>
    <span class="c">///</span><span class="c"> If message was constructed using the WindowsAzure.Messaging client library as follows:</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c">     var message1 = new BrokeredMessage(&quot;contoso&quot;); // Sending a plain string</span>
    <span class="c">///</span><span class="c">     var message2 = new BrokeredMessage(sampleObject); // Sending an actual customer object</span>
    <span class="c">///</span><span class="c">     var message3 = new BrokeredMessage(Encoding.UTF8.GetBytes(&quot;contoso&quot;)); // Sending a UTF8 encoded byte array object</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c">     await messageSender.SendAsync(message1);</span>
    <span class="c">///</span><span class="c">     await messageSender.SendAsync(message2);</span>
    <span class="c">///</span><span class="c">     await messageSender.SendAsync(message3);</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> Then retrieve the original objects using this client library as follows:</span>
    <span class="c">///</span><span class="c"> (By default </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="DataContractBinarySerializer.cs.html#d415a156d9a8494b" class="t t">DataContractBinarySerializer</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> will be used to deserialize and retrieve the body.</span>
    <span class="c">///</span><span class="c">  If a serializer other than that was used, pass in the serializer explicitly.)</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">code</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c">     var message1 = await messageReceiver.ReceiveAsync();</span>
    <span class="c">///</span><span class="c">     var returnedData1 = message1.GetBody</span><span class="c">&amp;lt;</span><span class="c">string</span><span class="c">&amp;gt;</span><span class="c">();</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c">     var message2 = await messageReceiver.ReceiveAsync();</span>
    <span class="c">///</span><span class="c">     var returnedData2 = message1.GetBody</span><span class="c">&amp;lt;</span><span class="c">SampleObject</span><span class="c">&amp;gt;</span><span class="c">();</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c">     var message3 = await messageReceiver.ReceiveAsync();</span>
    <span class="c">///</span><span class="c">     var returnedData3Bytes = message1.GetBody</span><span class="c">&amp;lt;</span><span class="c">byte[]</span><span class="c">&amp;gt;</span><span class="c">();</span>
    <span class="c">///</span><span class="c">     Console.WriteLine($&quot;Message3 String: {Encoding.UTF8.GetString(returnedData3Bytes)}&quot;);</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">code</span><span class="c">&gt;</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> -------------------------------------------------</span>
    <span class="c">///</span><span class="c"> Scenarios to NOT use the GetBody Extension method:</span>
    <span class="c">///</span><span class="c"> -------------------------------------------------</span>
    <span class="c">///</span><span class="c">  If message was sent using the WindowsAzure.Messaging client library as follows:</span>
    <span class="c">///</span><span class="c">     var message4 = new BrokeredMessage(new MemoryStream(Encoding.UTF8.GetBytes(&quot;contoso&quot;)));</span>
    <span class="c">///</span><span class="c">     await messageSender.SendAsync(message4);</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c">  Then retrieve the original objects using this client library as follows:</span>
    <span class="c">///</span><span class="c">     var message4 = await messageReceiver.ReceiveAsync();</span>
    <span class="c">///</span><span class="c">     string returned = Encoding.UTF8.GetString(message4.Body); // Since message was sent as Stream, no deserialization required here.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
    <b>public static class</b> <a id="a38d683e7ec422a8" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">MessageInteropExtensions</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Deserializes the body of a message that was serialized using XmlObjectSerializer</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <span class="r0 r t">T</span> <a id="efc8a0a69a3b297e" href="../R/../../0000000000.html" target="n" data-glyph="220,1" class="i method">GetBody</a>&lt;<span id="r0 rd t" class="r0 r t">T</span>&gt;(<b>this</b> <a href="../Message.cs.html#74fc1aa4fea2b013" class="t t">Message</a> <span id="r1 rd" class="r1 r">message</span>, <span class="i">XmlObjectSerializer</span> <span id="r2 rd" class="r2 r">serializer</span> = <b>null</b>)
        {
            <b>if</b>(<span class="r1 r">message</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r1 r">message</span>));
            }
 
            <b>if</b>(<span class="r1 r">message</span>.<a href="../Message.cs.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="../Message.cs.html#58017714256a1c78" class="i property">BodyObject</a> != <b>null</b>)
            {
                <b>return</b> (<span class="r0 r t">T</span>)<span class="r1 r">message</span>.<a href="../Message.cs.html#5b973fca03337aea" class="i property">SystemProperties</a>.<a href="../Message.cs.html#58017714256a1c78" class="i property">BodyObject</a>;
            }
 
            <b>if</b>(<span class="r1 r">message</span>.<a href="../Message.cs.html#9112b84aac32afc0" class="i property">Body</a> == <b>null</b> || <span class="r1 r">message</span>.<a href="../Message.cs.html#9112b84aac32afc0" class="i property">Body</a>.<span class="i">Length</span> == 0)
            {
                <b>return</b> <b>default</b>;
            }
 
            <b>if</b>(<span class="r2 r">serializer</span> == <b>null</b>)
            {
                <span class="r2 r">serializer</span> = <a href="DataContractBinarySerializer.cs.html#051bdcfee30cc6b9" class="t t">DataContractBinarySerializer</a>&lt;<span class="r0 r t">T</span>&gt;.<a href="DataContractBinarySerializer.cs.html#9890a774b9b15702" class="i field">Instance</a>;
            }
 
            <b>using</b> (<b>var</b> <span id="r3 rd" class="r3 r">memoryStream</span> = <b>new</b> <span class="i">MemoryStream</span>(<span class="r1 r">message</span>.<a href="../Message.cs.html#9112b84aac32afc0" class="i property">Body</a>.<span class="i">Length</span>))
            {
                <span class="r3 r">memoryStream</span>.<span class="i">Write</span>(<span class="r1 r">message</span>.<a href="../Message.cs.html#9112b84aac32afc0" class="i property">Body</a>, 0, <span class="r1 r">message</span>.<a href="../Message.cs.html#9112b84aac32afc0" class="i property">Body</a>.<span class="i">Length</span>);
                <span class="r3 r">memoryStream</span>.<span class="i">Flush</span>();
                <span class="r3 r">memoryStream</span>.<span class="i">Position</span> = 0;
                <b>return</b> (<span class="r0 r t">T</span>)<span class="r2 r">serializer</span>.<span class="i">ReadObject</span>(<span class="r3 r">memoryStream</span>);
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
