<!DOCTYPE html>
<html><head><title>RetryExponential.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(105);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.ServiceBus/RetryExponential.cs" target="_top">RetryExponential.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.ServiceBus" target="_top">Microsoft.Azure.ServiceBus.csproj</a> (Microsoft.Azure.ServiceBus)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft. All rights reserved.</span>
<span class="c">// Licensed under the MIT license. See LICENSE file in the project root for full license information.</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">ServiceBus</span>
{
    <b>using</b> <span class="i">System</span>;
    <b>using</b> <span class="i n">Primitives</span>;
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> RetryPolicy implementation where the delay between retries will grow in a staggered exponential manner.</span>
    <span class="c">///</span><span class="c"> RetryIntervals will be computed using a retryFactor which is a function of deltaBackOff (MaximumBackoff - MinimumBackoff) and MaximumRetryCount.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">RetryPolicy will not be applied when an ambient transaction is found.</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public sealed class</b> <a id="70ad52bf08b9e410" href="R/70ad52bf08b9e410.html" target="n" data-glyph="0,0" class="t t">RetryExponential</a> : <a href="RetryPolicy.cs.html#f4d3d17482dc49e5" class="t t">RetryPolicy</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns a new RetryExponential retry policy object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">minimumBackoff</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Minimum backoff interval.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">maximumBackoff</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Maximum backoff interval.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="8ff9c057cee7f04e" href="R/8ff9c057cee7f04e.html" target="n" data-glyph="72,1" class="t constructor">RetryExponential</a>(<span class="i">TimeSpan</span> <span id="r0 rd" class="r0 r">minimumBackoff</span>, <span class="i">TimeSpan</span> <span id="r1 rd" class="r1 r">maximumBackoff</span>, <b>int</b> <span id="r2 rd" class="r2 r">maximumRetryCount</span>)
            : <a href="#4b92f4fd67af29d7" class="k">this</a>(<span class="r0 r">minimumBackoff</span>, <span class="r1 r">maximumBackoff</span>, <a href="Constants.cs.html#6e9a057faa1690df" class="t t">Constants</a>.<a href="Constants.cs.html#87bfddce2e630391" class="i field">DefaultRetryDeltaBackoff</a>, <span class="r2 r">maximumRetryCount</span>)
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns a new RetryExponential retry policy object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">minimumBackoff</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Minimum backoff interval.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">maximumBackoff</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Maximum backoff interval.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">deltaBackoff</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Delta backoff interval.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="4b92f4fd67af29d7" href="R/4b92f4fd67af29d7.html" target="n" data-glyph="72,1" class="t constructor">RetryExponential</a>(<span class="i">TimeSpan</span> <span id="r3 rd" class="r3 r">minimumBackoff</span>, <span class="i">TimeSpan</span> <span id="r4 rd" class="r4 r">maximumBackoff</span>, <span class="i">TimeSpan</span> <span id="r5 rd" class="r5 r">deltaBackoff</span>, <b>int</b> <span id="r6 rd" class="r6 r">maxRetryCount</span>)
        {
            <a href="Primitives/TimeoutHelper.cs.html#a61b449000b5ed05" class="t t">TimeoutHelper</a>.<a href="Primitives/TimeoutHelper.cs.html#caee1619e95488a8" class="i method">ThrowIfNonPositiveArgument</a>(<span class="r5 r">deltaBackoff</span>, <b>nameof</b>(<span class="r5 r">deltaBackoff</span>));
            <a href="Primitives/TimeoutHelper.cs.html#a61b449000b5ed05" class="t t">TimeoutHelper</a>.<a href="Primitives/TimeoutHelper.cs.html#26d4c4d9bc637af5" class="i method">ThrowIfNegativeArgument</a>(<span class="r3 r">minimumBackoff</span>, <b>nameof</b>(<span class="r3 r">minimumBackoff</span>));
            <a href="Primitives/TimeoutHelper.cs.html#a61b449000b5ed05" class="t t">TimeoutHelper</a>.<a href="Primitives/TimeoutHelper.cs.html#caee1619e95488a8" class="i method">ThrowIfNonPositiveArgument</a>(<span class="r4 r">maximumBackoff</span>, <b>nameof</b>(<span class="r4 r">maximumBackoff</span>));
 
            <b>if</b> (<span class="r6 r">maxRetryCount</span> &lt;= 0)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentOutOfRangeException</span>(
                    <b>nameof</b>(<span class="r6 r">maxRetryCount</span>),
                    <a href="Resources.Designer.cs.html#8e0563579d43c165" class="t t">Resources</a>.<a href="Resources.Designer.cs.html#7fcfad0beb6256b4" class="i property">ArgumentMustBePositive</a>.<a href="Primitives/StringUtility.cs.html#3a252e19ad9654c1" class="i method">FormatForUser</a>(<b>nameof</b>(<span class="r6 r">maxRetryCount</span>)));
            }
 
            <b>if</b> (<span class="r3 r">minimumBackoff</span> &gt;= <span class="r4 r">maximumBackoff</span>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<a href="Resources.Designer.cs.html#8e0563579d43c165" class="t t">Resources</a>.<a href="Resources.Designer.cs.html#8a07aac1d94d516c" class="i property">ExponentialRetryBackoffRange</a>.<span class="i">FormatForUser</span>(<span class="r3 r">minimumBackoff</span>, <span class="r4 r">maximumBackoff</span>));
            }
 
            <a href="#70ad52bf08b9e410" class="k">this</a>.<a href="#3071d10359b673ee" class="i property">MinimalBackoff</a> = <span class="r3 r">minimumBackoff</span>;
            <a href="#70ad52bf08b9e410" class="k">this</a>.<a href="#938bec36c829ab1f" class="i property">MaximumBackoff</a> = <span class="r4 r">maximumBackoff</span>;
            <a href="#70ad52bf08b9e410" class="k">this</a>.<a href="#528264a5d3e177f0" class="i property">DeltaBackoff</a> = <span class="r5 r">deltaBackoff</span>;
            <a href="#70ad52bf08b9e410" class="k">this</a>.<a href="#0fe9160a10ca02a0" class="i property">MaxRetryCount</a> = <span class="r6 r">maxRetryCount</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Minimum backoff interval.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">The minimum backoff interval.</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">TimeSpan</span> <a id="3071d10359b673ee" href="R/3071d10359b673ee.html" target="n" data-glyph="102,1" class="i property">MinimalBackoff</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the maximum backoff interval.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">The maximum backoff interval.</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">TimeSpan</span> <a id="938bec36c829ab1f" href="R/938bec36c829ab1f.html" target="n" data-glyph="102,1" class="i property">MaximumBackoff</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the backoff interval associated with the retry.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">The backoff interval associated with the retry.</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">TimeSpan</span> <a id="528264a5d3e177f0" href="R/528264a5d3e177f0.html" target="n" data-glyph="102,1" class="i property">DeltaBackoff</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the maximum number of allowed retries.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">The maximum number of allowed retries.</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>public int</b> <a id="0fe9160a10ca02a0" href="R/0fe9160a10ca02a0.html" target="n" data-glyph="102,1" class="i property">MaxRetryCount</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Called to see if a retry should be performed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">remainingTime</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The remaining time before the timeout expires.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">currentRetryCount</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The number of attempts that have been processed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">retryInterval</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The amount of time to delay before retry.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected override bool</b> <a id="cc3994c6e8756078" href="R/cc3994c6e8756078.html" target="n" data-glyph="75,1" class="i method">OnShouldRetry</a>(<span class="i">TimeSpan</span> <span id="r7 rd" class="r7 r">remainingTime</span>, <b>int</b> <span id="r8 rd" class="r8 r">currentRetryCount</span>, <b>out</b> <span class="i">TimeSpan</span> <span id="r9 rd" class="r9 r">retryInterval</span>)
        {
            <b>if</b> (<span class="r8 r">currentRetryCount</span> &gt; <a href="#70ad52bf08b9e410" class="k">this</a>.<a href="#0fe9160a10ca02a0" class="i property">MaxRetryCount</a>)
            {
                <span class="r9 r">retryInterval</span> = <span class="i">TimeSpan</span>.<span class="i">Zero</span>;
                <b>return</b> <b>false</b>;
            }
 
            <span class="c">// Logic: - first use currentRetryCount to calculate the size of the interval.</span>
            <span class="c">//        - then get the interval in terms of sleep time (between min and max sleep time)</span>
            <span class="c">//        - if interval to large to fit inside remainingTime, we quit.</span>
            <b>var</b> <span id="r10 rd" class="r10 r">randomizedInterval</span> = <a href="Primitives/ConcurrentRandom.cs.html#3763ba5087b92d01" class="t t">ConcurrentRandom</a>.<a href="Primitives/ConcurrentRandom.cs.html#9079ee61afaa656c" class="i method">Next</a>((<b>int</b>)(<a href="#70ad52bf08b9e410" class="k">this</a>.<a href="#528264a5d3e177f0" class="i property">DeltaBackoff</a>.<span class="i">TotalMilliseconds</span> * 0.8), (<b>int</b>)(<a href="#70ad52bf08b9e410" class="k">this</a>.<a href="#528264a5d3e177f0" class="i property">DeltaBackoff</a>.<span class="i">TotalMilliseconds</span> * 1.2));
            <b>double</b> <span id="r11 rd" class="r11 r">increment</span> = (<span class="i">Math</span>.<span class="i">Pow</span>(2, <span class="r8 r">currentRetryCount</span>) - 1) * <span class="r10 r">randomizedInterval</span>;
            <b>double</b> <span id="r12 rd" class="r12 r">timeToSleepMsec</span> = <span class="i">Math</span>.<span class="i">Min</span>(<a href="#70ad52bf08b9e410" class="k">this</a>.<a href="#3071d10359b673ee" class="i property">MinimalBackoff</a>.<span class="i">TotalMilliseconds</span> + <span class="r11 r">increment</span>, <a href="#70ad52bf08b9e410" class="k">this</a>.<a href="#938bec36c829ab1f" class="i property">MaximumBackoff</a>.<span class="i">TotalMilliseconds</span>);
            <span class="r9 r">retryInterval</span> = <span class="i">TimeSpan</span>.<span class="i">FromMilliseconds</span>(<span class="r12 r">timeToSleepMsec</span>);
 
            <b>return</b> <b>true</b>;
        }
    }
}</pre></td></tr></table></div></body></html>
