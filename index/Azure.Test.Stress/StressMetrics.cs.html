<!DOCTYPE html>
<html><head><title>StressMetrics.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(241);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Test.Stress/StressMetrics.cs" target="_top">StressMetrics.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Test.Stress" target="_top">Azure.Test.Stress.csproj</a> (Azure.Test.Stress)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Concurrent</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i n">Tracing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Reflection</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Test</span>.<span class="i n">Stress</span>
{
    <b>public class</b> <a id="c4bbf6e1c18460d0" href="R/c4bbf6e1c18460d0.html" target="n" data-glyph="0,0" class="t t"><span id="97cefb7a864d51b7">StressMetrics</span></a>
    {
        <span class="c">// Timing</span>
        <b>public</b> <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a> <a id="1e652eb8731912d6" href="R/1e652eb8731912d6.html" target="n" data-glyph="102,1" class="i property">StartTime</a> { <b>get</b>; } = <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#1cd5dd408a32124f" class="i property">Now</a>;
        <b>public</b> <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a> <a id="a5691181c6dc7d25" href="R/a5691181c6dc7d25.html" target="n" data-glyph="102,1" class="i property">CurrentTime</a> =&gt; <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#1cd5dd408a32124f" class="i property">Now</a>;
        <b>public</b> <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a> <a id="ecfe415a951a35bb" href="R/ecfe415a951a35bb.html" target="n" data-glyph="102,1" class="i property">EndTime</a> =&gt; <a href="#1e652eb8731912d6" class="i property">StartTime</a> + <a href="#37d8eb06312e6543" class="i property">Duration</a>;
        <b>public</b> <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <a id="37d8eb06312e6543" href="R/37d8eb06312e6543.html" target="n" data-glyph="102,1" class="i property">Duration</a> { <b>get</b>; <b>set</b>; }
        <b>private</b> <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <a id="e887763ffb748853" href="R/e887763ffb748853.html" target="n" data-glyph="106,1" class="i property">RawRemaining</a> =&gt; <a href="#37d8eb06312e6543" class="i property">Duration</a> - (<a href="#a5691181c6dc7d25" class="i property">CurrentTime</a> - <a href="#1e652eb8731912d6" class="i property">StartTime</a>);
        <b>public</b> <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <a id="9f3482a539bd8513" href="R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Remaining</a> =&gt; (<a href="#e887763ffb748853" class="i property">RawRemaining</a> &gt; <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#225346b4cd3a8300" class="i field">Zero</a>) ? <a href="#e887763ffb748853" class="i property">RawRemaining</a> : <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#225346b4cd3a8300" class="i field">Zero</a>;
 
        <span class="c">// CPU</span>
        <b>public</b> <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <a id="aae6867f1085feff" href="R/aae6867f1085feff.html" target="n" data-glyph="42,1" class="i field">TotalProcessorTime</a>;
 
        <span class="c">// Memory</span>
        <b>public long</b> <a id="f8213623c0649331" href="R/f8213623c0649331.html" target="n" data-glyph="42,1" class="i field">MemorySamples</a>;
        <b>public long</b> <a id="4d0ffdfeb9218f46" href="R/4d0ffdfeb9218f46.html" target="n" data-glyph="42,1" class="i field">MemorySum</a>;
        <b>public long</b> <a id="5a0f14f8bb4cb320" href="R/5a0f14f8bb4cb320.html" target="n" data-glyph="42,1" class="i field">CurrentMemory</a>;
        <b>public long</b> <a id="4a90f632fbfbde4d" href="R/4a90f632fbfbde4d.html" target="n" data-glyph="102,1" class="i property">AverageMemory</a> =&gt; <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#22e58906412927dc" class="i method">Read</a>(<b>ref</b> <a href="#4d0ffdfeb9218f46" class="i field">MemorySum</a>) / <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#22e58906412927dc" class="i method">Read</a>(<b>ref</b> <a href="#f8213623c0649331" class="i field">MemorySamples</a>);
        <b>public long</b> <a id="7853b538523c435f" href="R/7853b538523c435f.html" target="n" data-glyph="42,1" class="i field">PeakMemory</a>;
        <b>public long</b> <a id="3fc5faeee9198eee" href="R/3fc5faeee9198eee.html" target="n" data-glyph="42,1" class="i field">Gen0Collections</a>;
        <b>public long</b> <a id="17ee99218d7b78f6" href="R/17ee99218d7b78f6.html" target="n" data-glyph="42,1" class="i field">Gen1Collections</a>;
        <b>public long</b> <a id="f00e15932c223c8a" href="R/f00e15932c223c8a.html" target="n" data-glyph="42,1" class="i field">Gen2Collections</a>;
 
        <span class="c">// Exceptions</span>
        <b>public</b> <a href="@0@mscorlib/A.html#18bcbcbdddbcfdcb" class="t t">ConcurrentQueue</a>&lt;<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a>&gt; <a id="5dfdebe1f6a54964" href="R/5dfdebe1f6a54964.html" target="n" data-glyph="102,1" class="i property">Exceptions</a> { <b>get</b>; } = <b>new</b> <a href="@0@mscorlib/A.html#a773570b1b021cff" class="t constructor">ConcurrentQueue</a>&lt;<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a>&gt;();
 
        <span class="c">// Events</span>
        <b>private</b> <a href="/Azure.Core/A.html#2da4eb5b1d8d59cd" class="t t">AzureEventSourceListener</a> <a id="5f86e0da3e582bc3" href="R/5f86e0da3e582bc3.html" target="n" data-glyph="46,1" class="i field">_eventListener</a>;
        <b>public</b> <a href="@0@mscorlib/A.html#18bcbcbdddbcfdcb" class="t t">ConcurrentQueue</a>&lt;(<a href="@0@mscorlib/A.html#9317b6858407017e" class="t t">EventWrittenEventArgs</a> <a id="4c82141cc5f2c283" href="R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">EventArgs</a>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <a id="f29f20f5c057590e" href="R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Message</a>)&gt; <a id="690191d73eecdb6f" href="R/690191d73eecdb6f.html" target="n" data-glyph="102,1" class="i property">Events</a> { <b>get</b>; }
            = <b>new</b> <a href="@0@mscorlib/A.html#a773570b1b021cff" class="t constructor">ConcurrentQueue</a>&lt;(<a href="@0@mscorlib/A.html#9317b6858407017e" class="t t">EventWrittenEventArgs</a> <span class="i field">EventArgs</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span class="i field">Message</span>)&gt;();
 
        <span class="c">// Options</span>
        <b>internal</b> <a href="StressOptions.cs.html#c5ef4635f249933f" class="t t">StressOptions</a> <a id="72ea579a2c9f0571" href="R/72ea579a2c9f0571.html" target="n" data-glyph="104,1" class="i property">Options</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">// Private</span>
        <b>private</b> <a href="@0@mscorlib/A.html#3980e012bae82e96" class="t t">Thread</a> <a id="ad8baf2ba995b008" href="R/ad8baf2ba995b008.html" target="n" data-glyph="46,1" class="i field">_updateCpuMemoryThread</a>;
        <b>private</b> <a href="@0@mscorlib/A.html#130a9536ac96b392" class="t t">CancellationTokenSource</a> <a id="6077ac949668983a" href="R/6077ac949668983a.html" target="n" data-glyph="46,1" class="i field">_updateCpuMemoryCts</a>;
 
        <b>protected virtual void</b> <a id="f9342a7057af52c3" href="R/f9342a7057af52c3.html" target="n" data-glyph="75,1" class="i method">ProcessEvent</a>(<a href="@0@mscorlib/A.html#9317b6858407017e" class="t t">EventWrittenEventArgs</a> <span id="r0 rd" class="r0 r">eventArgs</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r1 rd" class="r1 r">message</span>)
        {
            <a href="#690191d73eecdb6f" class="i property">Events</a>.<a href="@0@mscorlib/A.html#62bea3a8141ed2a9" class="i method">Enqueue</a>((<a href="/System.ValueTuple/A.html#4c82141cc5f2c283" class="i field">EventArgs</a>: <span class="r0 r">eventArgs</span>, <a href="/System.ValueTuple/A.html#f29f20f5c057590e" class="i field">Message</a>: <span class="r1 r">message</span>));
        }
 
        <b>internal void</b> <a id="c0ad93a0fe8e34a5" href="R/c0ad93a0fe8e34a5.html" target="n" data-glyph="74,1" class="i method">StartAutoUpdate</a>()
        {
            <a href="#5f86e0da3e582bc3" class="i field">_eventListener</a> = <b>new</b> <a href="/Azure.Core/A.html#fe2888f06df52fcc" class="t constructor">AzureEventSourceListener</a>((<span id="r2 rd" class="r2 r">eventArgs</span>, <span id="r3 rd" class="r3 r">message</span>) =&gt;
            {
                <a href="#f9342a7057af52c3" class="i method">ProcessEvent</a>(<span class="r2 r">eventArgs</span>, <span class="r3 r">message</span>);
            },
            <span class="r4 r">level</span>: <a href="#72ea579a2c9f0571" class="i property">Options</a>.<a href="StressOptions.cs.html#0e136b555a09c9ab" class="i property">EventLevel</a>);
 
            <a href="#6077ac949668983a" class="i field">_updateCpuMemoryCts</a> = <b>new</b> <a href="@0@mscorlib/A.html#0fd973cb6741d972" class="t constructor">CancellationTokenSource</a>();
            <a href="#ad8baf2ba995b008" class="i field">_updateCpuMemoryThread</a> = <a href="#a9abb5f80f507d9b" class="i method">UpdateCpuMemory</a>(<a href="#6077ac949668983a" class="i field">_updateCpuMemoryCts</a>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>);
        }
 
        <b>internal void</b> <a id="e405b4b2ea2966f8" href="R/e405b4b2ea2966f8.html" target="n" data-glyph="74,1" class="i method">StopAutoUpdate</a>()
        {
            <a href="#5f86e0da3e582bc3" class="i field">_eventListener</a>.<a href="@0@mscorlib/A.html#5bce26480f34f716" class="i method">Dispose</a>();
            <a href="#5f86e0da3e582bc3" class="i field">_eventListener</a> = <b>null</b>;
 
            <a href="#6077ac949668983a" class="i field">_updateCpuMemoryCts</a>.<a href="@0@mscorlib/A.html#93c25ccd0946470f" class="i method">Cancel</a>();
            <a href="#ad8baf2ba995b008" class="i field">_updateCpuMemoryThread</a>.<a href="@0@mscorlib/A.html#6f7bed56e0efe767" class="i method">Join</a>();
        }
 
        <span class="c">// Run in dedicated thread to ensure this thread has priority and never fails to run to due ThreadPool starvation.</span>
        <b>private</b> <a href="@0@mscorlib/A.html#3980e012bae82e96" class="t t">Thread</a> <a id="a9abb5f80f507d9b" href="R/a9abb5f80f507d9b.html" target="n" data-glyph="76,1" class="i method">UpdateCpuMemory</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r5 rd" class="r5 r">token</span>)
        {
            <span class="c">// Update once synchronously, to ensure values are initialized before first status output.</span>
            <a href="#865f8b939217e9ae" class="i method">UpdateCpuMemory</a>();
 
            <a href="@0@mscorlib/A.html#3980e012bae82e96" class="k">var</a> <span id="r6 rd" class="r6 r">thread</span> = <b>new</b> <a href="@0@mscorlib/A.html#76f340c84df6da8d" class="t constructor">Thread</a>(() =&gt;
            {
                <b>while</b> (!<span class="r5 r">token</span>.<a href="@0@mscorlib/A.html#f32abbe8e2f1f6c1" class="i property">IsCancellationRequested</a>)
                {
                    <b>try</b>
                    {
                        <a href="#b2f0c1e823ed7bdb" class="i method">Sleep</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#c24437e069f958f9" class="i method">FromSeconds</a>(1), <span class="r5 r">token</span>);
                    }
                    <b>catch</b> (<a href="@0@mscorlib/A.html#a0a8b79c277cf327" class="t t">OperationCanceledException</a>)
                    {
                    }
 
                    <a href="#865f8b939217e9ae" class="i method">UpdateCpuMemory</a>();
                }
            });
 
            <span class="r6 r">thread</span>.<a href="@0@mscorlib/A.html#cd2144b8dd6f4373" class="i method">Start</a>();
 
            <b>return</b> <span class="r6 r">thread</span>;
        }
 
        <b>private void</b> <a id="865f8b939217e9ae" href="R/865f8b939217e9ae.html" target="n" data-glyph="76,1" class="i method">UpdateCpuMemory</a>()
        {
            <a href="@0@mscorlib/A.html#e566178cce890c36" class="k">var</a> <span id="r7 rd" class="r7 r">memory</span> = <a href="@0@mscorlib/A.html#25d9c1e022317a99" class="t t">GC</a>.<a href="@0@mscorlib/A.html#3d710c141a784dbf" class="i method">GetTotalMemory</a>(<b>false</b>);
 
            <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#d379c1b796ccdc6f" class="i method">Increment</a>(<b>ref</b> <a href="#f8213623c0649331" class="i field">MemorySamples</a>);
            <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#d07671e23295984f" class="i method">Add</a>(<b>ref</b> <a href="#4d0ffdfeb9218f46" class="i field">MemorySum</a>, <span class="r7 r">memory</span>);
            <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#b4eb06f8a279b2f2" class="i method">Exchange</a>(<b>ref</b> <a href="#5a0f14f8bb4cb320" class="i field">CurrentMemory</a>, <span class="r7 r">memory</span>); ;
            <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#b4eb06f8a279b2f2" class="i method">Exchange</a>(<b>ref</b> <a href="#3fc5faeee9198eee" class="i field">Gen0Collections</a>, <a href="@0@mscorlib/A.html#25d9c1e022317a99" class="t t">GC</a>.<a href="@0@mscorlib/A.html#e4c26eb94fe6de0f" class="i method">CollectionCount</a>(0));
            <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#b4eb06f8a279b2f2" class="i method">Exchange</a>(<b>ref</b> <a href="#17ee99218d7b78f6" class="i field">Gen1Collections</a>, <a href="@0@mscorlib/A.html#25d9c1e022317a99" class="t t">GC</a>.<a href="@0@mscorlib/A.html#e4c26eb94fe6de0f" class="i method">CollectionCount</a>(1));
            <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#b4eb06f8a279b2f2" class="i method">Exchange</a>(<b>ref</b> <a href="#f00e15932c223c8a" class="i field">Gen2Collections</a>, <a href="@0@mscorlib/A.html#25d9c1e022317a99" class="t t">GC</a>.<a href="@0@mscorlib/A.html#e4c26eb94fe6de0f" class="i method">CollectionCount</a>(2));
 
            <b>if</b> (<span class="r7 r">memory</span> &gt; <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#22e58906412927dc" class="i method">Read</a>(<b>ref</b> <a href="#7853b538523c435f" class="i field">PeakMemory</a>))
            {
                <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#b4eb06f8a279b2f2" class="i method">Exchange</a>(<b>ref</b> <a href="#7853b538523c435f" class="i field">PeakMemory</a>, <span class="r7 r">memory</span>);
            }
 
            <a href="#aae6867f1085feff" class="i field">TotalProcessorTime</a> = <a href="@0@System/A.html#f8b2e604d6f1fe04" class="t t">Process</a>.<a href="@0@System/A.html#a106ad886675f6a5" class="i method">GetCurrentProcess</a>().<a href="@0@System/A.html#c05869fd201ecb84" class="i property">TotalProcessorTime</a>;
        }
 
        <b>private static void</b> <a id="b2f0c1e823ed7bdb" href="R/b2f0c1e823ed7bdb.html" target="n" data-glyph="76,1" class="i method">Sleep</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <span id="r8 rd" class="r8 r">timeout</span>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r9 rd" class="r9 r">token</span>)
        {
            <a href="@0@System/A.html#ceb0ba9cc88de82e" class="k">var</a> <span id="r10 rd" class="r10 r">sw</span> = <a href="@0@System/A.html#ceb0ba9cc88de82e" class="t t">Stopwatch</a>.<a href="@0@System/A.html#dc0a41ceabc92682" class="i method">StartNew</a>();
            <b>while</b> (<span class="r10 r">sw</span>.<a href="@0@System/A.html#60e03fb80c10ec79" class="i property">Elapsed</a> &lt; <span class="r8 r">timeout</span>)
            {
                <b>if</b> (<span class="r9 r">token</span>.<a href="@0@mscorlib/A.html#f32abbe8e2f1f6c1" class="i property">IsCancellationRequested</a>)
                {
                    <span class="c">// Simulate behavior of Task.Delay(TimeSpan, CancellationToken)</span>
                    <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#1697b6f5143e8f94" class="t constructor">OperationCanceledException</a>();
                }
 
                <a href="@0@mscorlib/A.html#3980e012bae82e96" class="t t">Thread</a>.<a href="@0@mscorlib/A.html#82aedb56cecde82c" class="i method">Sleep</a>(<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@0@mscorlib/A.html#668d91d771bce54b" class="i method">FromMilliseconds</a>(10));
            }
        }
 
        <b>public override string</b> <a id="887a5573dde180bf" href="R/887a5573dde180bf.html" target="n" data-glyph="72,1" class="i method">ToString</a>()
        {
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r11 rd" class="r11 r">data</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <a id="17480c3db7a05179" href="R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Key</a>, <b>object</b> <a id="c1824f63746153f2" href="R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Value</a>)&gt;();
 
            <span class="c">// Timing</span>
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;Start&quot;</span>, <span class="s">$&quot;</span>{<a href="#1e652eb8731912d6" class="i property">StartTime</a>:<span class="s">G</span>}<span class="s">&quot;</span>));
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;Current&quot;</span>, <span class="s">$&quot;</span>{<a href="#a5691181c6dc7d25" class="i property">CurrentTime</a>:<span class="s">G</span>}<span class="s">&quot;</span>));
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;End&quot;</span>, <span class="s">$&quot;</span>{<a href="#ecfe415a951a35bb" class="i property">EndTime</a>:<span class="s">G</span>}<span class="s">&quot;</span>));
 
            <span class="c">// CPU</span>
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;TotalProcessorTime&quot;</span>, <a href="#aae6867f1085feff" class="i field">TotalProcessorTime</a>.<a href="@0@mscorlib/A.html#b8c8f6dc0f808233" class="i method">ToString</a>()));
 
            <span class="c">// Memory</span>
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;Current Memory&quot;</span>, <a href="#f65b92b291521f05" class="i method">FormatBytes</a>(<a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#22e58906412927dc" class="i method">Read</a>(<b>ref</b> <a href="#5a0f14f8bb4cb320" class="i field">CurrentMemory</a>))));
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;Average Memory&quot;</span>, <a href="#f65b92b291521f05" class="i method">FormatBytes</a>(<a href="#4a90f632fbfbde4d" class="i property">AverageMemory</a>)));
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;Peak Memory&quot;</span>, <a href="#f65b92b291521f05" class="i method">FormatBytes</a>(<a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#22e58906412927dc" class="i method">Read</a>(<b>ref</b> <a href="#7853b538523c435f" class="i field">PeakMemory</a>))));
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;GC Gen 0 Collections&quot;</span>, <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#22e58906412927dc" class="i method">Read</a>(<b>ref</b> <a href="#3fc5faeee9198eee" class="i field">Gen0Collections</a>)));
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;GC Gen 1 Collections&quot;</span>, <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#22e58906412927dc" class="i method">Read</a>(<b>ref</b> <a href="#17ee99218d7b78f6" class="i field">Gen1Collections</a>)));
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;GC Gen 2 Collections&quot;</span>, <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#22e58906412927dc" class="i method">Read</a>(<b>ref</b> <a href="#f00e15932c223c8a" class="i field">Gen2Collections</a>)));
 
            <span class="c">// Exceptions</span>
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;Total Exceptions&quot;</span>, <a href="#5dfdebe1f6a54964" class="i property">Exceptions</a>.<a href="@0@mscorlib/A.html#f36684fa5c19fdfb" class="i property">Count</a>));
            <b>foreach</b> (<a href="@0@System.Core/A.html#2d96a4bb71c065c4" class="k">var</a> <span id="r12 rd" class="r12 r">g</span> <b>in</b> <a href="#5dfdebe1f6a54964" class="i property">Exceptions</a>.<a href="@0@System.Core/A.html#a80c803cd6c25112" class="i method">GroupBy</a>(<span id="r13 rd" class="r13 r">e</span> =&gt; <span class="r13 r">e</span>.<a href="@0@mscorlib/A.html#cf7a3679f8b67db4" class="i method">GetType</a>()).<a href="@0@System.Core/A.html#e449fbc07f49dc52" class="i method">OrderBy</a>(<span id="r14 rd" class="r14 r">g</span> =&gt; <span class="r14 r">g</span>.<a href="@0@System.Core/A.html#249797970861cc23" class="i property">Key</a>.<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>))
            {
                <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="r12 r">g</span>.<a href="@0@System.Core/A.html#249797970861cc23" class="i property">Key</a>.<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>, <span class="r12 r">g</span>.<a href="@0@System.Core/A.html#41ef9e39e54d0d0b" class="i method">Count</a>()));
            }
 
            <span class="c">// Events</span>
            <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="s">&quot;Total Events&quot;</span>, <a href="#690191d73eecdb6f" class="i property">Events</a>.<a href="@0@mscorlib/A.html#f36684fa5c19fdfb" class="i property">Count</a>));
            <b>foreach</b> (<a href="@0@System.Core/A.html#2d96a4bb71c065c4" class="k">var</a> <span id="r15 rd" class="r15 r">g</span> <b>in</b> <a href="#690191d73eecdb6f" class="i property">Events</a>.<a href="@0@System.Core/A.html#a80c803cd6c25112" class="i method">GroupBy</a>(<span id="r16 rd" class="r16 r">e</span> =&gt; <span class="s">$&quot;</span>{<span class="r16 r">e</span>.<a href="/System.ValueTuple/A.html#4c82141cc5f2c283" class="i field">EventArgs</a>.<a href="@0@mscorlib/A.html#116ae55c79f70a5d" class="i property">EventSource</a>.<a href="@0@mscorlib/A.html#87928ac6b561e64f" class="i property">Name</a>}<span class="s">::</span>{<span class="r16 r">e</span>.<a href="/System.ValueTuple/A.html#4c82141cc5f2c283" class="i field">EventArgs</a>.<a href="@0@mscorlib/A.html#75e1a9860a924283" class="i property">EventName</a>}<span class="s">&quot;</span>).<a href="@0@System.Core/A.html#e449fbc07f49dc52" class="i method">OrderBy</a>(<span id="r17 rd" class="r17 r">g</span> =&gt; <span class="r17 r">g</span>.<a href="@0@System.Core/A.html#249797970861cc23" class="i property">Key</a>))
            {
                <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="r15 r">g</span>.<a href="@0@System.Core/A.html#249797970861cc23" class="i property">Key</a>, <span class="r15 r">g</span>.<a href="@0@System.Core/A.html#41ef9e39e54d0d0b" class="i method">Count</a>()));
            }
 
            <b>var</b> <span id="r18 rd" class="r18 r">allMembers</span> = <a href="#c4bbf6e1c18460d0" class="k">this</a>.<a href="@0@mscorlib/A.html#4d73eb225aef8a61" class="i method">GetType</a>().<a href="@0@mscorlib/A.html#cc1729e7759a19c1" class="i method">GetMembers</a>(<a href="@0@mscorlib/A.html#4795caf3b483702d" class="t t">BindingFlags</a>.<a href="@0@mscorlib/A.html#ef2ef39bdfa059df" class="i field">Public</a> | <a href="@0@mscorlib/A.html#4795caf3b483702d" class="t t">BindingFlags</a>.<a href="@0@mscorlib/A.html#54a14f747b06c614" class="i field">Instance</a>);
            <a href="@0@mscorlib/A.html#3acf01620172c7f0" class="k">var</a> <span id="r19 rd" class="r19 r">baseMemberNames</span> = <b>typeof</b>(<a href="#c4bbf6e1c18460d0" class="t t">StressMetrics</a>).<a href="@0@mscorlib/A.html#cc1729e7759a19c1" class="i method">GetMembers</a>(<a href="@0@mscorlib/A.html#4795caf3b483702d" class="t t">BindingFlags</a>.<a href="@0@mscorlib/A.html#ef2ef39bdfa059df" class="i field">Public</a> | <a href="@0@mscorlib/A.html#4795caf3b483702d" class="t t">BindingFlags</a>.<a href="@0@mscorlib/A.html#54a14f747b06c614" class="i field">Instance</a>).<a href="@0@System.Core/A.html#5c652c53e80df013" class="i method">Select</a>(<span id="r20 rd" class="r20 r">m</span> =&gt; <span class="r20 r">m</span>.<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>);
            <a href="@0@mscorlib/A.html#3acf01620172c7f0" class="k">var</a> <span id="r21 rd" class="r21 r">derivedMembers</span> = <span class="r18 r">allMembers</span>.<a href="@0@System.Core/A.html#e73922753675387a" class="i method">Where</a>(<span id="r22 rd" class="r22 r">m</span> =&gt; !<span class="r19 r">baseMemberNames</span>.<a href="@0@System.Core/A.html#f60bab4c5e27a849" class="i method">Contains</a>(<span class="r22 r">m</span>.<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>));
 
            <b>foreach</b> (<a href="@0@mscorlib/A.html#f837137ea25e482a" class="k">var</a> <span id="r23 rd" class="r23 r">member</span> <b>in</b> <span class="r21 r">derivedMembers</span>.<a href="@0@System.Core/A.html#e449fbc07f49dc52" class="i method">OrderBy</a>(<span id="r24 rd" class="r24 r">m</span> =&gt; <span class="r24 r">m</span>.<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>))
            {
                <b>switch</b> (<span class="r23 r">member</span>)
                {
                    <b>case</b> <a href="@0@mscorlib/A.html#329d417f4b15c86c" class="t t">FieldInfo</a> <span id="r25 rd" class="r25 r">f</span>:
                        <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="r25 r">f</span>.<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>, <span class="r25 r">f</span>.<a href="@0@mscorlib/A.html#f8ddbb1dc1c6b29e" class="i method">GetValue</a>(<a href="#c4bbf6e1c18460d0" class="k">this</a>).<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>()));
                        <b>break</b>;
                    <b>case</b> <a href="@0@mscorlib/A.html#f3f0ea5f89a8f162" class="t t">PropertyInfo</a> <span id="r26 rd" class="r26 r">p</span>:
                        <span class="r11 r">data</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>((<span class="r26 r">p</span>.<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>, <span class="r26 r">p</span>.<a href="@0@mscorlib/A.html#7f41c0c1ebadcc33" class="i method">GetValue</a>(<a href="#c4bbf6e1c18460d0" class="k">this</a>).<a href="@0@mscorlib/A.html#ff31a6bf27c58f89" class="i method">ToString</a>()));
                        <b>break</b>;
                    <b>default</b>:
                        <b>break</b>;
                }
            }
 
            <b>return</b> <a href="#eacdcab0fd5cc6b8" class="i method">FormatTable</a>(<span class="r11 r">data</span>);
        }
 
        <b>private static string</b> <a id="f65b92b291521f05" href="R/f65b92b291521f05.html" target="n" data-glyph="76,1" class="i method">FormatBytes</a>(<b>long</b> <span id="r27 rd" class="r27 r">bytes</span>)
        {
            <b>const long</b> <span id="r28 rd" class="r28 r">scale</span> = 1024;
 
            <b>var</b> <span id="r29 rd" class="r29 r">orders</span> = <b>new</b> <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>[] { <span class="s">&quot;TB&quot;</span>, <span class="s">&quot;MB&quot;</span>, <span class="s">&quot;KB&quot;</span>, <span class="s">&quot;bytes&quot;</span> };
            <a href="@0@mscorlib/A.html#e566178cce890c36" class="k">var</a> <span id="r30 rd" class="r30 r">max</span> = (<b>long</b>)<a href="@0@mscorlib/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@0@mscorlib/A.html#95354113fadc3083" class="i method">Pow</a>(<span class="r28 r">scale</span>, (<span class="r29 r">orders</span>.<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a> - 1));
 
            <b>foreach</b> (<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r31 rd" class="r31 r">order</span> <b>in</b> <span class="r29 r">orders</span>)
            {
                <b>if</b> (<span class="r27 r">bytes</span> &gt; <span class="r30 r">max</span>)
                {
                    <b>return</b> <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#7432dab173fae5fc" class="i method">Format</a>(<span class="s">&quot;{0:n2} {1}&quot;</span>, <a href="@0@mscorlib/A.html#1b2858baf311cbf9" class="t t">Decimal</a>.<a href="@0@mscorlib/A.html#65b4a084045cca3d" class="i method">Divide</a>(<span class="r27 r">bytes</span>, <span class="r30 r">max</span>), <span class="r31 r">order</span>);
                }
 
                <span class="r30 r">max</span> /= <span class="r28 r">scale</span>;
            }
 
            <b>return</b> <span class="s">&quot;0 bytes&quot;</span>;
        }
 
        <b>private static string</b> <a id="eacdcab0fd5cc6b8" href="R/eacdcab0fd5cc6b8.html" target="n" data-glyph="76,1" class="i method">FormatTable</a>(<a href="@0@mscorlib/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span class="i field">Key</span>, <b>object</b> <span class="i field">Value</span>)&gt; <span id="r32 rd" class="r32 r">data</span>)
        {
            <a href="@0@mscorlib/A.html#adf60ee46ebd299f" class="k">var</a> <span id="r33 rd" class="r33 r">sb</span> = <b>new</b> <a href="@0@mscorlib/A.html#6e631639c1e2746b" class="t constructor">StringBuilder</a>();
 
            <a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r34 rd" class="r34 r">longestKeyLength</span> = <span class="r32 r">data</span>.<a href="@0@System.Core/A.html#5c652c53e80df013" class="i method">Select</a>(<span id="r35 rd" class="r35 r">v</span> =&gt; <span class="r35 r">v</span>.<a href="/System.ValueTuple/A.html#17480c3db7a05179" class="i field">Key</a>).<a href="@0@System.Core/A.html#7eec09816d04e761" class="i method">OrderByDescending</a>(<span id="r36 rd" class="r36 r">k</span> =&gt; <span class="r36 r">k</span>.<a href="@0@mscorlib/A.html#e13f5829ef28aa07" class="i property">Length</a>).<a href="@0@System.Core/A.html#bc8ae402a61dd9d6" class="i method">First</a>().<a href="@0@mscorlib/A.html#e13f5829ef28aa07" class="i property">Length</a>;
            <b>const int</b> <span id="r37 rd" class="r37 r">padding</span> = 4;
 
            <b>foreach</b> (<a href="/System.ValueTuple/A.html#0d3bf0818d69cf43" class="k">var</a> <span id="r38 rd" class="r38 r">kvp</span> <b>in</b> <span class="r32 r">data</span>)
            {
                <span class="r33 r">sb</span>.<a href="@0@mscorlib/A.html#e8eaef3c361184bc" class="i method">Append</a>(<span class="r38 r">kvp</span>.<a href="/System.ValueTuple/A.html#17480c3db7a05179" class="i field">Key</a>);
                <span class="r33 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<span class="s">&#39;:&#39;</span>);
                <b>for</b> (<a href="@0@mscorlib/A.html#225942ed7b7a3252" class="k">var</a> <span id="r39 rd" class="r39 r">i</span> = <span class="r38 r">kvp</span>.<a href="/System.ValueTuple/A.html#17480c3db7a05179" class="i field">Key</a>.<a href="@0@mscorlib/A.html#e13f5829ef28aa07" class="i property">Length</a> + 1; <span class="r39 r">i</span> &lt; <span class="r34 r">longestKeyLength</span> + <span class="r37 r">padding</span> + 1; <span class="r39 r">i</span>++)
                {
                    <span class="r33 r">sb</span>.<a href="@0@mscorlib/A.html#a2e7c78d85807da5" class="i method">Append</a>(<span class="s">&#39; &#39;</span>);
                }
                <span class="r33 r">sb</span>.<a href="@0@mscorlib/A.html#7685cb28f3648166" class="i method">Append</a>(<span class="r38 r">kvp</span>.<a href="/System.ValueTuple/A.html#c1824f63746153f2" class="i field">Value</a>);
                <span class="r33 r">sb</span>.<a href="@0@mscorlib/A.html#c0554798fe05ba4f" class="i method">AppendLine</a>();
            }
 
            <b>return</b> <span class="r33 r">sb</span>.<a href="@0@mscorlib/A.html#5a97da49a158a3c9" class="i method">ToString</a>();
        }
    }
}
</pre></td></tr></table></div></body></html>
