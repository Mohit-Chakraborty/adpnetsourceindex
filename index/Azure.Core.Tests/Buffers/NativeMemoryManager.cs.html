<!DOCTYPE html>
<html><head><title>NativeMemoryManager.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(118);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Core.Tests/Buffers/NativeMemoryManager.cs" target="_top">Buffers\NativeMemoryManager.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Core.Tests" target="_top">Azure.Core.Tests.csproj</a> (Azure.Core.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Buffers</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Runtime</span>.<span class="i n">InteropServices</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">Tests</span>.<span class="i n">Buffers</span>
{
    <b>internal sealed class</b> <a id="0affe03aba9e49ab" href="../R/0affe03aba9e49ab.html" target="n" data-glyph="2,0" class="t t">NativeMemoryManager</a> : <span class="t t">MemoryManager</span>&lt;<b>byte</b>&gt;
    {
        <b>private readonly int</b> <a id="a331c2165b2a8d36" href="../R/a331c2165b2a8d36.html" target="n" data-glyph="46,1" class="i field">_length</a>;
        <b>private</b> <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a> <a id="fb1b2d1a5b2301b9" href="../R/fb1b2d1a5b2301b9.html" target="n" data-glyph="46,1" class="i field">_ptr</a>;
        <b>private int</b> <a id="5eb30657f07fd71c" href="../R/5eb30657f07fd71c.html" target="n" data-glyph="46,1" class="i field">_retainedCount</a>;
        <b>private bool</b> <a id="04a2cb341605fb7d" href="../R/04a2cb341605fb7d.html" target="n" data-glyph="46,1" class="i field">_disposed</a>;
 
        <b>public</b> <a id="072953cbcb59bce2" href="../R/072953cbcb59bce2.html" target="n" data-glyph="72,1" class="t constructor">NativeMemoryManager</a>(<b>int</b> <span id="r0 rd" class="r0 r">length</span>)
        {
            <b>if</b> (<span class="r0 r">length</span> &lt; 0)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#5fec5e06371b1f6c" class="t constructor">ArgumentOutOfRangeException</a>(<b>nameof</b>(<span class="r0 r">length</span>));
            }
 
            <a href="#a331c2165b2a8d36" class="i field">_length</a> = <span class="r0 r">length</span>;
            <a href="#fb1b2d1a5b2301b9" class="i field">_ptr</a> = <a href="@0@mscorlib/A.html#489a61c84168b119" class="t t">Marshal</a>.<a href="@0@mscorlib/A.html#ad604d46784bcdda" class="i method">AllocHGlobal</a>(<span class="r0 r">length</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">CA2015</span> <span class="c">// Finalizer is defined for testing purposes</span>
        ~<a id="18886dbcb62c26f0" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="t method">NativeMemoryManager</a>()
        {
            <a href="@0@System/A.html#632c6da37ce825df" class="t t">Debug</a>.<a href="@0@System/A.html#73de7bb60da320d3" class="i method">WriteLine</a>(<span class="s">$&quot;</span>{<b>nameof</b>(<a href="#0affe03aba9e49ab" class="t t">NativeMemoryManager</a>)}<span class="s"> being finalized</span><span class="s">&quot;</span>);
            <a href="#240866e1e5c3dc9d" class="i method">Dispose</a>(<b>false</b>);
        }
        <span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> <span class="i">CA2015</span>
 
        <b>public bool</b> <a id="631d61ffa542f59d" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">IsDisposed</a>
        {
            <b>get</b>
            {
                <b>lock</b> (<a href="#0affe03aba9e49ab" class="k">this</a>)
                {
                    <b>return</b> <a href="#04a2cb341605fb7d" class="i field">_disposed</a> &amp;&amp; <a href="#5eb30657f07fd71c" class="i field">_retainedCount</a> == 0;
                }
            }
        }
 
        <b>public override</b> <span class="t t">Memory</span>&lt;<b>byte</b>&gt; <a id="d2ffaab31eabb3ef" href="../R/d2ffaab31eabb3ef.html" target="n" data-glyph="102,1" class="i property">Memory</a> =&gt; <span class="i method">CreateMemory</span>(<a href="#a331c2165b2a8d36" class="i field">_length</a>);
 
        <b>public bool</b> <a id="d9d27084d9974284" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">IsRetained</a>
        {
            <b>get</b>
            {
                <b>lock</b> (<a href="#0affe03aba9e49ab" class="k">this</a>)
                {
                    <b>return</b> <a href="#5eb30657f07fd71c" class="i field">_retainedCount</a> &gt; 0;
                }
            }
        }
 
        <b>public override unsafe</b> <span class="t t">Span</span>&lt;<b>byte</b>&gt; <a id="6b963fe87c46975e" href="../R/6b963fe87c46975e.html" target="n" data-glyph="72,1" class="i method">GetSpan</a>() =&gt; <b>new</b> <span class="t constructor">Span</span>&lt;<b>byte</b>&gt;((<b>void</b>*)<a href="#fb1b2d1a5b2301b9" class="i field">_ptr</a>, <a href="#a331c2165b2a8d36" class="i field">_length</a>);
 
        <b>public override unsafe</b> <span class="t t">MemoryHandle</span> <a id="0f658da45dfe0096" href="../R/0f658da45dfe0096.html" target="n" data-glyph="72,1" class="i method">Pin</a>(<b>int</b> <span id="r1 rd" class="r1 r">elementIndex</span> = 0)
        {
            <span class="c">// Note that this intentionally allows elementIndex == _length to</span>
            <span class="c">// support pinning zero-length instances.</span>
            <b>if</b> ((<b>uint</b>)<span class="r1 r">elementIndex</span> &gt; (<b>uint</b>)<a href="#a331c2165b2a8d36" class="i field">_length</a>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#5fec5e06371b1f6c" class="t constructor">ArgumentOutOfRangeException</a>(<b>nameof</b>(<span class="r1 r">elementIndex</span>));
            }
 
            <b>lock</b> (<a href="#0affe03aba9e49ab" class="k">this</a>)
            {
                <b>if</b> (<a href="#5eb30657f07fd71c" class="i field">_retainedCount</a> == 0 &amp;&amp; <a href="#04a2cb341605fb7d" class="i field">_disposed</a>)
                {
                    <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#5ee7f173f9e53170" class="t constructor">Exception</a>();
                }
                <a href="#5eb30657f07fd71c" class="i field">_retainedCount</a>++;
            }
 
            <b>void</b>* <span id="r2 rd" class="r2 r">pointer</span> = (<b>void</b>*)((<b>byte</b>*)<a href="#fb1b2d1a5b2301b9" class="i field">_ptr</a> + <span class="r1 r">elementIndex</span>);    <span class="c">// T = byte</span>
            <b>return</b> <b>new</b> <span class="t constructor">MemoryHandle</span>(<span class="r2 r">pointer</span>, <b>default</b>, <a href="#0affe03aba9e49ab" class="k">this</a>);
        }
 
        <b>public override void</b> <a id="5dcf06b669bc5d56" href="../R/5dcf06b669bc5d56.html" target="n" data-glyph="72,1" class="i method">Unpin</a>()
        {
            <b>lock</b> (<a href="#0affe03aba9e49ab" class="k">this</a>)
            {
                <b>if</b> (<a href="#5eb30657f07fd71c" class="i field">_retainedCount</a> &gt; 0)
                {
                    <a href="#5eb30657f07fd71c" class="i field">_retainedCount</a>--;
                    <b>if</b> (<a href="#5eb30657f07fd71c" class="i field">_retainedCount</a> == 0)
                    {
                        <b>if</b> (<a href="#04a2cb341605fb7d" class="i field">_disposed</a>)
                        {
                            <a href="@0@mscorlib/A.html#489a61c84168b119" class="t t">Marshal</a>.<a href="@0@mscorlib/A.html#eebf9c918f94b6bd" class="i method">FreeHGlobal</a>(<a href="#fb1b2d1a5b2301b9" class="i field">_ptr</a>);
                            <a href="#fb1b2d1a5b2301b9" class="i field">_ptr</a> = <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>.<a href="@0@mscorlib/A.html#d46202ed9b6005b2" class="i field">Zero</a>;
                        }
                    }
                }
            }
        }
 
        <b>protected override void</b> <a id="240866e1e5c3dc9d" href="../R/240866e1e5c3dc9d.html" target="n" data-glyph="75,1" class="i method">Dispose</a>(<b>bool</b> <span id="r3 rd" class="r3 r">disposing</span>)
        {
            <b>lock</b> (<a href="#0affe03aba9e49ab" class="k">this</a>)
            {
                <a href="#04a2cb341605fb7d" class="i field">_disposed</a> = <b>true</b>;
                <b>if</b> (<a href="#5eb30657f07fd71c" class="i field">_retainedCount</a> == 0)
                {
                    <a href="@0@mscorlib/A.html#489a61c84168b119" class="t t">Marshal</a>.<a href="@0@mscorlib/A.html#eebf9c918f94b6bd" class="i method">FreeHGlobal</a>(<a href="#fb1b2d1a5b2301b9" class="i field">_ptr</a>);
                    <a href="#fb1b2d1a5b2301b9" class="i field">_ptr</a> = <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>.<a href="@0@mscorlib/A.html#d46202ed9b6005b2" class="i field">Zero</a>;
                }
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
