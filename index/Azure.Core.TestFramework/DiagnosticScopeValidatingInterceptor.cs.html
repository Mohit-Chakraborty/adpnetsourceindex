<!DOCTYPE html>
<html><head><title>DiagnosticScopeValidatingInterceptor.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(217);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Core.TestFramework/DiagnosticScopeValidatingInterceptor.cs" target="_top">DiagnosticScopeValidatingInterceptor.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Core.TestFramework" target="_top">Azure.Core.TestFramework.csproj</a> (Azure.Core.TestFramework)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Reflection</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">Tests</span>;
<b>using</b> <span class="i n">Castle</span>.<span class="i n">DynamicProxy</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">TestFramework</span>
{
    <b>public class</b> <a id="b88f8421f58307a7" href="R/b88f8421f58307a7.html" target="n" data-glyph="0,0" class="t t"><span id="72043909b8c0df11">DiagnosticScopeValidatingInterceptor</span></a> : <span class="t t">IInterceptor</span>
    {
        <b>private static readonly</b> <a href="@0@mscorlib/A.html#382d90b1fa682bac" class="t t">MethodInfo</a> <a id="359e515a800c367f" href="R/359e515a800c367f.html" target="n" data-glyph="46,1" class="i field">ValidateDiagnosticScopeMethod</a> = <b>typeof</b>(<a href="#b88f8421f58307a7" class="t t">DiagnosticScopeValidatingInterceptor</a>).<a href="@0@mscorlib/A.html#f24e0c9fd5441fd5" class="i method">GetMethod</a>(<b>nameof</b>(<span class="i">AwaitAndValidateDiagnosticScope</span>), <a href="@0@mscorlib/A.html#4795caf3b483702d" class="t t">BindingFlags</a>.<a href="@0@mscorlib/A.html#5144189c11f6b668" class="i field">NonPublic</a> | <a href="@0@mscorlib/A.html#4795caf3b483702d" class="t t">BindingFlags</a>.<a href="@0@mscorlib/A.html#d1fa47f9abe3c16a" class="i field">Static</a>);
        <b>public void</b> <a id="b0000654889eb726" href="R/b0000654889eb726.html" target="n" data-glyph="72,1" class="i method">Intercept</a>(<span class="t t">IInvocation</span> <span id="r0 rd" class="r0 r">invocation</span>)
        {
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r1 rd" class="r1 r">methodName</span> = <span class="r0 r">invocation</span>.<span class="i property">Method</span>.<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>;
 
            <a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a> <span id="r2 rd" class="r2 r">declaringType</span> = <span class="r0 r">invocation</span>.<span class="i property">Method</span>.<a href="@0@mscorlib/A.html#3eb1391de297c1a8" class="i property">DeclaringType</a>;
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r3 rd" class="r3 r">methodNameWithoutSuffix</span> = <span class="r1 r">methodName</span>.<a href="@0@mscorlib/A.html#41a31e4feec3ef41" class="i method">EndsWith</a>(<span class="s">&quot;Async&quot;</span>, <a href="@0@mscorlib/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@0@mscorlib/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>) ?
                <span class="r1 r">methodName</span>.<a href="@0@mscorlib/A.html#8124961f027d9ac9" class="i method">Substring</a>(0, <span class="r1 r">methodName</span>.<a href="@0@mscorlib/A.html#e13f5829ef28aa07" class="i property">Length</a> - 5) :
                <span class="r1 r">methodName</span>;
 
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r4 rd" class="r4 r">expectedName</span> = <span class="r2 r">declaringType</span>.<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a> + <span class="s">&quot;.&quot;</span> + <span class="r3 r">methodNameWithoutSuffix</span>;
            <b>bool</b> <span id="r5 rd" class="r5 r">strict</span> = !<span class="r0 r">invocation</span>.<span class="i property">Method</span>.<a href="@0@mscorlib/A.html#b25e40856426d3fd" class="i method">GetCustomAttributes</a>(<b>true</b>).<a href="@0@System.Core/A.html#6a1af7c3d17845e3" class="i method">Any</a>(<span id="r6 rd" class="r6 r">a</span> =&gt; <span class="r6 r">a</span>.<a href="@0@mscorlib/A.html#4d73eb225aef8a61" class="i method">GetType</a>().<a href="@0@mscorlib/A.html#976443bb39dc37cd" class="i property">FullName</a> == <span class="s">&quot;Azure.Core.ForwardsClientCallsAttribute&quot;</span>);
 
            <b>if</b> (<span class="r0 r">invocation</span>.<span class="i property">Method</span>.<a href="@0@mscorlib/A.html#5be6c92e98bc4044" class="i property">ReturnType</a> <b>is</b> {<a href="@0@mscorlib/A.html#b81fd50dfeabd50c" class="i property">IsGenericType</a>: <b>true</b>} <span id="r7 rd" class="r7 r">genericType</span> &amp;&amp;
                <span class="r7 r">genericType</span>.<a href="@0@mscorlib/A.html#7179022318447358" class="i method">GetGenericTypeDefinition</a>() == <b>typeof</b>(<a href="/Azure.Core/A.html#ce6e47443d11533b" class="t t">AsyncPageable</a>&lt;&gt;))
            {
                <span class="r0 r">invocation</span>.<span class="i method">Proceed</span>();
                <span class="r0 r">invocation</span>.<span class="i property">ReturnValue</span> = <a href="@0@mscorlib/A.html#955a7437554c8efc" class="t t">Activator</a>.<a href="@0@mscorlib/A.html#f6b936ab5a27846a" class="i method">CreateInstance</a>(<b>typeof</b>(<a href="#0b330ba0beda871a" class="t t">DiagnosticScopeValidatingAsyncEnumerable</a>&lt;&gt;).<a href="@0@mscorlib/A.html#3e82dbae123f91fc" class="i method">MakeGenericType</a>(<span class="r7 r">genericType</span>.<a href="@0@mscorlib/A.html#0aa31a7de47b9dc7" class="i property">GenericTypeArguments</a>[0]), <span class="r0 r">invocation</span>.<span class="i property">ReturnValue</span>, <span class="r4 r">expectedName</span>, <span class="r1 r">methodName</span>, <span class="r5 r">strict</span>);
            }
            <b>else</b> <b>if</b> (<span class="r1 r">methodName</span>.<a href="@0@mscorlib/A.html#cb74053b3f2d03f4" class="i method">EndsWith</a>(<span class="s">&quot;Async&quot;</span>) &amp;&amp; !<span class="r0 r">invocation</span>.<span class="i property">Method</span>.<a href="@0@mscorlib/A.html#5be6c92e98bc4044" class="i property">ReturnType</a>.<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>.<a href="@0@mscorlib/A.html#428c5c9954dea844" class="i method">Contains</a>(<span class="s">&quot;IAsyncEnumerable&quot;</span>))
            {
                <a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a> <span id="r8 rd" class="r8 r">genericArgument</span> = <b>typeof</b>(<b>object</b>);
                <a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a> <span id="r9 rd" class="r9 r">awaitableType</span> = <span class="r0 r">invocation</span>.<span class="i property">Method</span>.<a href="@0@mscorlib/A.html#5be6c92e98bc4044" class="i property">ReturnType</a>;
                <b>if</b> (<span class="r0 r">invocation</span>.<span class="i property">Method</span>.<a href="@0@mscorlib/A.html#5be6c92e98bc4044" class="i property">ReturnType</a> <b>is</b> {<a href="@0@mscorlib/A.html#b81fd50dfeabd50c" class="i property">IsGenericType</a>: <b>true</b>, <a href="@0@mscorlib/A.html#0aa31a7de47b9dc7" class="i property">GenericTypeArguments</a>: {<a href="@0@mscorlib/A.html#42e9b7616956cf94" class="i property">Length</a>: 1} <span id="r10 rd" class="r10 r">genericTypeArguments</span>})
                {
                    <span class="r8 r">genericArgument</span> = <span class="r10 r">genericTypeArguments</span>[0];
                    <span class="r9 r">awaitableType</span> = <span class="r0 r">invocation</span>.<span class="i property">Method</span>.<a href="@0@mscorlib/A.html#5be6c92e98bc4044" class="i property">ReturnType</a>.<a href="@0@mscorlib/A.html#7179022318447358" class="i method">GetGenericTypeDefinition</a>();
                }
                <a href="#359e515a800c367f" class="i field">ValidateDiagnosticScopeMethod</a>.<a href="@0@mscorlib/A.html#6f9c3eb767cf3cc7" class="i method">MakeGenericMethod</a>(<span class="r8 r">genericArgument</span>)
                    .<a href="@0@mscorlib/A.html#c8277ed81262a367" class="i method">Invoke</a>(<b>null</b>, <b>new</b> <b>object</b>[]{<span class="r9 r">awaitableType</span>, <span class="r0 r">invocation</span>, <span class="r4 r">expectedName</span>, <span class="r1 r">methodName</span>, <span class="r5 r">strict</span>});
            }
            <b>else</b>
            {
                <span class="r0 r">invocation</span>.<span class="i method">Proceed</span>();
            }
        }
 
        <b>internal static void</b> <a id="e0f691accf0c9381" href="R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">AwaitAndValidateDiagnosticScope</a>&lt;<span id="r11 rd t" class="r11 r t">T</span>&gt;(<a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a> <span id="r12 rd" class="r12 r">genericType</span>, <span class="t t">IInvocation</span> <span id="r13 rd" class="r13 r">invocation</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r14 rd" class="r14 r">expectedName</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r15 rd" class="r15 r">methodName</span>, <b>bool</b> <span id="r16 rd" class="r16 r">strict</span>)
        {
            <span class="c">// All this ceremony is not to await the returned Task/ValueTask syncronously</span>
            <span class="c">// instead we are replacing the invocation.ReturnValue with the ValidateDiagnosticScope task</span>
            <span class="c">// but we need to make sure the types match</span>
            <b>if</b> (<span class="r12 r">genericType</span> == <b>typeof</b>(<a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;&gt;))
            {
                <span class="r13 r">invocation</span>.<span class="i property">ReturnValue</span> = <a href="#b741164fb7543f4c" class="i method">ValidateDiagnosticScope</a>(<b>async</b> () =&gt;
                {
                    <span class="r13 r">invocation</span>.<span class="i method">Proceed</span>();
                    <b>return</b> (<b>await</b> (<a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="r11 r t">T</span>&gt;)<span class="r13 r">invocation</span>.<span class="i property">ReturnValue</span>, <b>false</b>);
                }, <span class="r14 r">expectedName</span>, <span class="r15 r">methodName</span>, <span class="r16 r">strict</span>).<span class="i method">AsTask</span>();
            }
            <b>else</b> <b>if</b> (<span class="r12 r">genericType</span> == <b>typeof</b>(<a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>))
            {
                <span class="r13 r">invocation</span>.<span class="i property">ReturnValue</span> = <a href="#b741164fb7543f4c" class="i method">ValidateDiagnosticScope</a>&lt;<b>object</b>&gt;(<b>async</b> () =&gt;
                {
                    <span class="r13 r">invocation</span>.<span class="i method">Proceed</span>();
                    <b>await</b> (<a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>)<span class="r13 r">invocation</span>.<span class="i property">ReturnValue</span>;
                    <b>return</b> <b>default</b>;
                }, <span class="r14 r">expectedName</span>, <span class="r15 r">methodName</span>, <span class="r16 r">strict</span>).<span class="i method">AsTask</span>();
            }
            <b>else</b> <b>if</b> (<span class="r12 r">genericType</span> == <b>typeof</b>(<span class="t t">ValueTask</span>&lt;&gt;))
            {
                <span class="r13 r">invocation</span>.<span class="i property">ReturnValue</span> = <a href="#b741164fb7543f4c" class="i method">ValidateDiagnosticScope</a>(<b>async</b> () =&gt;
                {
                    <span class="r13 r">invocation</span>.<span class="i method">Proceed</span>();
                    <b>return</b> (<b>await</b> (<span class="t t">ValueTask</span>&lt;<span class="r11 r t">T</span>&gt;)<span class="r13 r">invocation</span>.<span class="i property">ReturnValue</span>, <b>false</b>);
                }, <span class="r14 r">expectedName</span>, <span class="r15 r">methodName</span>, <span class="r16 r">strict</span>);
            }
            <b>else</b> <b>if</b> (<span class="r12 r">genericType</span> == <b>typeof</b>(<span class="t t">ValueTask</span>))
            {
                <span class="r13 r">invocation</span>.<span class="i property">ReturnValue</span> = <b>new</b> <span class="t constructor">ValueTask</span>(<a href="#b741164fb7543f4c" class="i method">ValidateDiagnosticScope</a>&lt;<b>object</b>&gt;(<b>async</b> () =&gt;
                {
                    <span class="r13 r">invocation</span>.<span class="i method">Proceed</span>();
                    <b>await</b> (<span class="t t">ValueTask</span>)<span class="r13 r">invocation</span>.<span class="i property">ReturnValue</span>;;
                    <b>return</b> <b>default</b>;
                }, <span class="r14 r">expectedName</span>, <span class="r15 r">methodName</span>, <span class="r16 r">strict</span>).<span class="i method">AsTask</span>());
            }
            <b>else</b>
            {
                <a href="#b741164fb7543f4c" class="i method">ValidateDiagnosticScope</a>&lt;<b>object</b>&gt;(() =&gt;
                {
                    <span class="r13 r">invocation</span>.<span class="i method">Proceed</span>();
                    <b>return</b> <b>default</b>;
                }, <span class="r14 r">expectedName</span>, <span class="r15 r">methodName</span>, <span class="r16 r">strict</span>).<span class="i method">GetAwaiter</span>().<span class="i method">GetResult</span>();
            }
        }
 
        <b>internal static async</b> <span class="t t">ValueTask</span>&lt;<span class="r17 r t">T</span>&gt; <a id="b741164fb7543f4c" href="R/b741164fb7543f4c.html" target="n" data-glyph="74,1" class="i method">ValidateDiagnosticScope</a>&lt;<span id="r17 rd t" class="r17 r t">T</span>&gt;(<a href="@0@mscorlib/A.html#87d60abb7092d5a4" class="t t">Func</a>&lt;<span class="t t">ValueTask</span>&lt;(<span class="r17 r t">T</span> <a id="a98dc812e894c686" href="R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Result</a>, <b>bool</b> <a id="cb04d860dfb1a76a" href="R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">SkipChecks</a>)&gt;&gt; <span id="r18 rd" class="r18 r">action</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r19 rd" class="r19 r">expectedName</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r20 rd" class="r20 r">methodName</span>, <b>bool</b> <span id="r21 rd" class="r21 r">strict</span>)
        {
            <b>bool</b> <span id="r22 rd" class="r22 r">expectFailure</span> = <b>false</b>;
            <b>bool</b> <span id="r23 rd" class="r23 r">skipChecks</span> = <b>false</b>;
            <span class="r17 r t">T</span> <span id="r24 rd" class="r24 r">result</span>;
 
            <b>using</b> <a href="ClientDiagnosticListener.cs.html#85d38a2ac10df0d4" class="t t">ClientDiagnosticListener</a> <span id="r25 rd" class="r25 r">diagnosticListener</span> = <b>new</b> <a href="ClientDiagnosticListener.cs.html#49543ea50c379d1b" class="t constructor">ClientDiagnosticListener</a>(<span id="r26 rd" class="r26 r">s</span> =&gt; <span class="r26 r">s</span>.<a href="@0@mscorlib/A.html#23804789ea4c9c0e" class="i method">StartsWith</a>(<span class="s">&quot;Azure.&quot;</span>), <span class="r27 r">asyncLocal</span>: <b>true</b>);
            <b>try</b>
            {
                (<span class="r24 r">result</span>, <span class="r23 r">skipChecks</span>) = <b>await</b> <span class="r18 r">action</span>();
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r28 rd" class="r28 r">ex</span>)
            {
                <span class="r22 r">expectFailure</span> = <b>true</b>;
 
                <b>if</b> (<span class="r28 r">ex</span> <b>is</b> <a href="@0@mscorlib/A.html#109b3ef6299ef9df" class="t t">ArgumentException</a>)
                {
                    <span class="c">// Don&#39;t expect scope for argument validation failures</span>
                    <span class="r23 r">skipChecks</span> = <b>true</b>;
                }
 
                <b>throw</b>;
            }
            <b>finally</b>
            {
                <span class="c">// Remove subscribers before enumerating events.</span>
                <span class="r25 r">diagnosticListener</span>.<a href="ClientDiagnosticListener.cs.html#926248c5461c0f93" class="i method">Dispose</a>();
                <b>if</b> (!<span class="r23 r">skipChecks</span>)
                {
                    <b>if</b> (<span class="r21 r">strict</span>)
                    {
                        <a href="ClientDiagnosticListener.cs.html#85d38a2ac10df0d4" class="t t">ClientDiagnosticListener</a>.<a href="ClientDiagnosticListener.cs.html#985ce503470454e8" class="t t">ProducedDiagnosticScope</a> <span id="r29 rd" class="r29 r">e</span> = <span class="r25 r">diagnosticListener</span>.<a href="ClientDiagnosticListener.cs.html#1710bc53bae2afac" class="i property">Scopes</a>.<a href="@0@System.Core/A.html#b7e5965cab68b1cf" class="i method">FirstOrDefault</a>(<span id="r30 rd" class="r30 r">e</span> =&gt; <span class="r30 r">e</span>.<a href="ClientDiagnosticListener.cs.html#086db95ffa30da30" class="i property">Name</a> == <span class="r19 r">expectedName</span>);
 
                        <b>if</b> (<span class="r29 r">e</span> == <b>default</b>)
                        {
                            <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">$&quot;</span><span class="s">Expected diagnostic scope not created </span>{<span class="r19 r">expectedName</span>}<span class="s"> </span>{<a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#63a04833d43dd9d3" class="i property">NewLine</a>}<span class="s">&quot;</span> +
                                                                <span class="s">$&quot;</span><span class="s">    created </span>{<span class="r25 r">diagnosticListener</span>.<a href="ClientDiagnosticListener.cs.html#1710bc53bae2afac" class="i property">Scopes</a>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a>}<span class="s"> scopes [</span>{<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#da0d95b54df01dcf" class="i method">Join</a>(<span class="s">&quot;, &quot;</span>, <span class="r25 r">diagnosticListener</span>.<a href="ClientDiagnosticListener.cs.html#1710bc53bae2afac" class="i property">Scopes</a>)}<span class="s">] </span>{<a href="@0@mscorlib/A.html#7d2f1469d916fc63" class="t t">Environment</a>.<a href="@0@mscorlib/A.html#63a04833d43dd9d3" class="i property">NewLine</a>}<span class="s">&quot;</span> +
                                                                <span class="s">$&quot;</span><span class="s">    You may have forgotten to add clientDiagnostics.CreateScope(...), set your operationId to </span>{<span class="r19 r">expectedName</span>}<span class="s"> in </span>{<span class="r20 r">methodName</span>}<span class="s"> or applied the Azure.Core.ForwardsClientCallsAttribute to </span>{<span class="r20 r">methodName</span>}<span class="s">.</span><span class="s">&quot;</span>);
                        }
 
                        <b>if</b> (!<span class="r29 r">e</span>.<a href="ClientDiagnosticListener.cs.html#3f0bf175acc908ec" class="i property">Activity</a>.<span class="i property">Tags</span>.<a href="@0@System.Core/A.html#6a1af7c3d17845e3" class="i method">Any</a>(<span id="r31 rd" class="r31 r">tag</span> =&gt; <span class="r31 r">tag</span>.<a href="@0@mscorlib/A.html#f9d1c04feb1af032" class="i property">Key</a> == <span class="s">&quot;az.namespace&quot;</span>))
                        {
                            <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">$&quot;</span><span class="s">All diagnostic scopes should have &#39;az.namespace&#39; attribute, make sure the assembly containing **ClientOptions type is marked with the AzureResourceProviderNamespace attribute specifying the appropriate provider. This attribute should be included in AssemblyInfo, and can be included by pulling in AzureResourceProviderNamespaceAttribute.cs using the AzureCoreSharedSources alias.</span><span class="s">&quot;</span>);
                        }
 
                        <b>if</b> (<span class="r22 r">expectFailure</span> &amp;&amp; !<span class="r29 r">e</span>.<a href="ClientDiagnosticListener.cs.html#315af85bbeeff581" class="i property">IsFailed</a>)
                        {
                            <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">$&quot;</span><span class="s">Expected scope </span>{<span class="r19 r">expectedName</span>}<span class="s"> to be marked as failed but it succeeded</span><span class="s">&quot;</span>);
                        }
                    }
                    <b>else</b>
                    {
                        <b>if</b> (!<span class="r25 r">diagnosticListener</span>.<a href="ClientDiagnosticListener.cs.html#1710bc53bae2afac" class="i property">Scopes</a>.<a href="@0@System.Core/A.html#8788153112b7ffd0" class="i method">Any</a>())
                        {
                            <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">$&quot;</span><span class="s">Expected some diagnostic scopes to be created, found none</span><span class="s">&quot;</span>);
                        }
                    }
                }
            }
 
            <b>return</b> <span class="r24 r">result</span>;
        }
 
        <b>internal class</b> <a id="0b330ba0beda871a" href="R/0b330ba0beda871a.html" target="n" data-glyph="2,1" class="t t">DiagnosticScopeValidatingAsyncEnumerable</a>&lt;<span id="r32 rd t" class="r32 r t">T</span>&gt; : <a href="/Azure.Core/A.html#ce6e47443d11533b" class="t t">AsyncPageable</a>&lt;<span class="r32 r t">T</span>&gt;
        {
            <b>private readonly</b> <a href="/Azure.Core/A.html#ce6e47443d11533b" class="t t">AsyncPageable</a>&lt;<span class="r32 r t">T</span>&gt; <a id="d899b23ed52f8e5a" href="R/d899b23ed52f8e5a.html" target="n" data-glyph="46,2" class="i field">_pageable</a>;
            <b>private readonly string</b> <a id="93ca7e1582a51bb3" href="R/93ca7e1582a51bb3.html" target="n" data-glyph="46,2" class="i field">_expectedName</a>;
            <b>private readonly string</b> <a id="b15a6ab1a22b81c1" href="R/b15a6ab1a22b81c1.html" target="n" data-glyph="46,2" class="i field">_methodName</a>;
            <b>private readonly bool</b> <a id="fe09a06d4191911b" href="R/fe09a06d4191911b.html" target="n" data-glyph="46,2" class="i field">_strict</a>;
            <b>private readonly bool</b> <a id="36a10e55bc18837a" href="R/36a10e55bc18837a.html" target="n" data-glyph="46,2" class="i field">_overridesGetAsyncEnumerator</a>;
 
            <b>public</b> <a id="a32dc9113eb520c8" href="R/../../0000000000.html" target="n" data-glyph="72,2" class="t constructor">DiagnosticScopeValidatingAsyncEnumerable</a>(<a href="/Azure.Core/A.html#ce6e47443d11533b" class="t t">AsyncPageable</a>&lt;<span class="r32 r t">T</span>&gt; <span id="r33 rd" class="r33 r">pageable</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r34 rd" class="r34 r">expectedName</span>, <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r35 rd" class="r35 r">methodName</span>, <b>bool</b> <span id="r36 rd" class="r36 r">strict</span>)
            {
                <b>if</b> (<span class="r33 r">pageable</span> == <b>null</b>) <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#b50c77b2acc23eca" class="t constructor">ArgumentNullException</a>(<b>nameof</b>(<span class="r33 r">pageable</span>), <span class="s">&quot;Operations returning [Async]Pageable should never return null.&quot;</span>);
 
                <span class="c">// If AsyncPageable overrides GetAsyncEnumerator we have to pass the call through to it</span>
                <span class="c">// this would effectively disable the validation so avoid doing it as much as possible</span>
                <a href="@0@mscorlib/A.html#382d90b1fa682bac" class="k">var</a> <span id="r37 rd" class="r37 r">getAsyncEnumeratorMethod</span> = <span class="r33 r">pageable</span>.<a href="@0@mscorlib/A.html#4d73eb225aef8a61" class="i method">GetType</a>().<a href="@0@mscorlib/A.html#f24e0c9fd5441fd5" class="i method">GetMethod</a>(<span class="s">&quot;GetAsyncEnumerator&quot;</span>, <a href="@0@mscorlib/A.html#4795caf3b483702d" class="t t">BindingFlags</a>.<a href="@0@mscorlib/A.html#ef2ef39bdfa059df" class="i field">Public</a> | <a href="@0@mscorlib/A.html#4795caf3b483702d" class="t t">BindingFlags</a>.<a href="@0@mscorlib/A.html#54a14f747b06c614" class="i field">Instance</a>);
                <a href="#36a10e55bc18837a" class="i field">_overridesGetAsyncEnumerator</a> = <span class="r37 r">getAsyncEnumeratorMethod</span>.<a href="@0@mscorlib/A.html#3eb1391de297c1a8" class="i property">DeclaringType</a> <b>is</b> {<a href="@0@mscorlib/A.html#b81fd50dfeabd50c" class="i property">IsGenericType</a>: <b>true</b>} <span id="r38 rd" class="r38 r">genericType</span> &amp;&amp;
                    <span class="r38 r">genericType</span>.<a href="@0@mscorlib/A.html#7179022318447358" class="i method">GetGenericTypeDefinition</a>() != <b>typeof</b>(<a href="/Azure.Core/A.html#ce6e47443d11533b" class="t t">AsyncPageable</a>&lt;&gt;);
 
                <a href="#d899b23ed52f8e5a" class="i field">_pageable</a> = <span class="r33 r">pageable</span>;
                <a href="#93ca7e1582a51bb3" class="i field">_expectedName</a> = <span class="r34 r">expectedName</span>;
                <a href="#b15a6ab1a22b81c1" class="i field">_methodName</a> = <span class="r35 r">methodName</span>;
                <a href="#fe09a06d4191911b" class="i field">_strict</a> = <span class="r36 r">strict</span>;
            }
 
            <b>public override</b> <span class="t t">IAsyncEnumerator</span>&lt;<span class="r32 r t">T</span>&gt; <a id="3c34664f04d9d39f" href="R/3c34664f04d9d39f.html" target="n" data-glyph="72,2" class="i method">GetAsyncEnumerator</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r39 rd" class="r39 r">cancellationToken</span> = <b>default</b>)
            {
                <b>if</b> (<a href="#36a10e55bc18837a" class="i field">_overridesGetAsyncEnumerator</a>)
                {
                    <b>return</b> <a href="#d899b23ed52f8e5a" class="i field">_pageable</a>.<a href="/Azure.Core/A.html#d6a522e44353c5d5" class="i method">GetAsyncEnumerator</a>(<span class="r39 r">cancellationToken</span>);
                }
 
                <b>return</b> <a href="/Azure.Core/A.html#ce6e47443d11533b" class="k">base</a>.<a href="/Azure.Core/A.html#d6a522e44353c5d5" class="i method">GetAsyncEnumerator</a>(<span class="r39 r">cancellationToken</span>);
            }
 
            <b>public override async</b> <span class="t t">IAsyncEnumerable</span>&lt;<a href="/Azure.Core/A.html#b864610eef8c9004" class="t t">Page</a>&lt;<span class="r32 r t">T</span>&gt;&gt; <a id="57b79a4dbcf7e0bf" href="R/57b79a4dbcf7e0bf.html" target="n" data-glyph="72,2" class="i method">AsPages</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r40 rd" class="r40 r">continuationToken</span> = <b>null</b>, <b>int</b>? <span id="r41 rd" class="r41 r">pageSizeHint</span> = <b>null</b>)
            {
                <b>await using</b> <b>var</b> <span id="r42 rd" class="r42 r">enumerator</span> = <a href="#d899b23ed52f8e5a" class="i field">_pageable</a>.<a href="/Azure.Core/A.html#1796337aa63dd119" class="i method">AsPages</a>(<span class="r40 r">continuationToken</span>, <span class="r41 r">pageSizeHint</span>).<span class="i method">GetAsyncEnumerator</span>();
 
                <b>while</b> (<b>await</b> <a href="#b741164fb7543f4c" class="i method">ValidateDiagnosticScope</a>(<b>async</b> () =&gt;
                {
                    <b>bool</b> <span id="r43 rd" class="r43 r">movedNext</span> = <b>await</b> <span class="r42 r">enumerator</span>.<span class="i method">MoveNextAsync</span>();
                    <span class="c">// Don&#39;t expect the MoveNextAsync call that returns false to create scope</span>
                    <b>return</b> (<span class="r43 r">movedNext</span>, !<span class="r43 r">movedNext</span>);
                }, <a href="#93ca7e1582a51bb3" class="i field">_expectedName</a>, <span class="s">$&quot;</span><span class="s">AsPages() implementation returned from </span>{<a href="#b15a6ab1a22b81c1" class="i field">_methodName</a>}<span class="s">&quot;</span>, <a href="#fe09a06d4191911b" class="i field">_strict</a>))
                {
                    <b>yield</b> <b>return</b> <span class="r42 r">enumerator</span>.<span class="i property">Current</span>;
                }
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
