<!DOCTYPE html>
<html><head><title>AzureBlobXmlRepository.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(268);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Extensions.AspNetCore.DataProtection.Blobs/AzureBlobXmlRepository.cs" target="_top">AzureBlobXmlRepository.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Extensions.AspNetCore.DataProtection.Blobs" target="_top">Azure.Extensions.AspNetCore.DataProtection.Blobs.csproj</a> (Azure.Extensions.AspNetCore.DataProtection.Blobs)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Runtime</span>.<span class="i n">ExceptionServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Xml</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Xml</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">Azure</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Blobs</span>;
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Storage</span>.<span class="i n">Blobs</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">DataProtection</span>.<span class="i n">Repositories</span>;
 
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">AZC0001</span> <span class="c">//</span>
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Extensions</span>.<span class="i n">AspNetCore</span>.<span class="i n">DataProtection</span>.<span class="i n">Blobs</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> An </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="t t">IXmlRepository</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> which is backed by Azure Blob Storage.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Instances of this type are thread-safe.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="8d5749da738c5f0d" href="R/8d5749da738c5f0d.html" target="n" data-glyph="2,0" class="t t">AzureBlobXmlRepository</a> : <span class="t t">IXmlRepository</span>
    {
        <b>private const int</b> <a id="d1aadd34e17b8545" href="R/d1aadd34e17b8545.html" target="n" data-glyph="10,1" class="i field">ConflictMaxRetries</a> = 5;
        <b>private static readonly</b> <a href="@1@netstandard/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <a id="0e811d5ef0f655fa" href="R/0e811d5ef0f655fa.html" target="n" data-glyph="46,1" class="i field">ConflictBackoffPeriod</a> = <a href="@1@netstandard/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@1@netstandard/A.html#668d91d771bce54b" class="i method">FromMilliseconds</a>(200);
        <b>private static readonly</b> <a href="@1@netstandard/A.html#59294fe8612c95b2" class="t t">XName</a> <a id="f6a8edf67afb731a" href="R/f6a8edf67afb731a.html" target="n" data-glyph="46,1" class="i field">RepositoryElementName</a> = <span class="s">&quot;repository&quot;</span>;
        <b>private static</b> <a href="/Azure.Storage.Blobs/A.html#84ca02c0580ec46f" class="t t">BlobHttpHeaders</a> <a id="19a0b6e60e241326" href="R/19a0b6e60e241326.html" target="n" data-glyph="46,1" class="i field">_blobHttpHeaders</a> = <b>new</b> <a href="/Azure.Storage.Blobs/A.html#eff8cd4c216b756e" class="t constructor">BlobHttpHeaders</a>() { <a href="/Azure.Storage.Blobs/A.html#d29fc45d857f9449" class="i property">ContentType</a> = <span class="s">&quot;application/xml; charset=utf-8&quot;</span> };
 
        <b>private readonly</b> <a href="@1@netstandard/A.html#bb77e610694e64ca" class="t t">Random</a> <a id="0266536155724a9c" href="R/0266536155724a9c.html" target="n" data-glyph="46,1" class="i field">_random</a>;
        <b>private</b> <a href="#df31ebe42094092f" class="t t">BlobData</a> <a id="23801a23e4c7b837" href="R/23801a23e4c7b837.html" target="n" data-glyph="46,1" class="i field">_cachedBlobData</a>;
        <b>private readonly</b> <a href="/Azure.Storage.Blobs/A.html#f0665d15d63242b1" class="t t">BlobClient</a> <a id="880512ec2456ecae" href="R/880512ec2456ecae.html" target="n" data-glyph="46,1" class="i field">_blobClient</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#8d5749da738c5f0d" class="t t">AzureBlobXmlRepository</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">blobClient</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/Azure.Storage.Blobs/A.html#f0665d15d63242b1" class="t t">BlobClient</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> that is connected to the blob we are reading from and writing to.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="13d6fbeed18d2a84" href="R/13d6fbeed18d2a84.html" target="n" data-glyph="72,1" class="t constructor">AzureBlobXmlRepository</a>(<a href="/Azure.Storage.Blobs/A.html#f0665d15d63242b1" class="t t">BlobClient</a> <span id="r0 rd" class="r0 r">blobClient</span>)
        {
            <a href="#0266536155724a9c" class="i field">_random</a> = <b>new</b> <a href="@1@netstandard/A.html#5d22f8880fc9f8d9" class="t constructor">Random</a>();
            <a href="#880512ec2456ecae" class="i field">_blobClient</a> = <span class="r0 r">blobClient</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">inheritdoc</span> <span class="c">/&gt;</span>
        <b>public</b> <a href="@1@netstandard/A.html#7103bd3a82c9f352" class="t t">IReadOnlyCollection</a>&lt;<a href="@1@netstandard/A.html#3367036406d1344a" class="t t">XElement</a>&gt; <a id="36a62bd0087030b9" href="R/36a62bd0087030b9.html" target="n" data-glyph="72,1" class="i method">GetAllElements</a>()
        {
            <span class="c">// Shunt the work onto a ThreadPool thread so that it&#39;s independent of any</span>
            <span class="c">// existing sync context or other potentially deadlock-causing items.</span>
 
            <a href="@1@netstandard/A.html#b19f71a84062554b" class="k">var</a> <span id="r1 rd" class="r1 r">elements</span> = <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@netstandard/A.html#2b0eb7df73dbd716" class="i method">Run</a>(() =&gt; <a href="#7a90933ffa844abe" class="i method">GetAllElementsAsync</a>()).<a href="@1@netstandard/A.html#e1d639f68b66715a" class="i method">GetAwaiter</a>().<a href="@1@netstandard/A.html#c2597ba59f71d619" class="i method">GetResult</a>();
            <b>return</b> <b>new</b> <a href="@1@netstandard/A.html#64e45c8a9b38b1c2" class="t constructor">ReadOnlyCollection</a>&lt;<a href="@1@netstandard/A.html#3367036406d1344a" class="t t">XElement</a>&gt;(<span class="r1 r">elements</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">inheritdoc</span> <span class="c">/&gt;</span>
        <b>public void</b> <a id="8beae81ab20eb5a1" href="R/8beae81ab20eb5a1.html" target="n" data-glyph="72,1" class="i method">StoreElement</a>(<a href="@1@netstandard/A.html#3367036406d1344a" class="t t">XElement</a> <span id="r2 rd" class="r2 r">element</span>, <a href="@1@netstandard/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r3 rd" class="r3 r">friendlyName</span>)
        {
            <b>if</b> (<span class="r2 r">element</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<b>nameof</b>(<span class="r2 r">element</span>));
            }
 
            <span class="c">// Shunt the work onto a ThreadPool thread so that it&#39;s independent of any</span>
            <span class="c">// existing sync context or other potentially deadlock-causing items.</span>
 
            <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@netstandard/A.html#101f1757fbbf2575" class="i method">Run</a>(() =&gt; <a href="#5ad7cc0b6b6e9997" class="i method">StoreElementAsync</a>(<span class="r2 r">element</span>)).<a href="@1@netstandard/A.html#9865ec4fb8abca74" class="i method">GetAwaiter</a>().<a href="@1@netstandard/A.html#fac5be2731353aa8" class="i method">GetResult</a>();
        }
 
        <b>private static</b> <a href="@1@netstandard/A.html#3354dac0913e417b" class="t t">XDocument</a> <a id="8314443ee4534dee" href="R/8314443ee4534dee.html" target="n" data-glyph="76,1" class="i method">CreateDocumentFromBlob</a>(<b>byte</b>[] <span id="r4 rd" class="r4 r">blob</span>)
        {
            <b>using</b> (<a href="@1@netstandard/A.html#1a4dcb744a23ba6f" class="k">var</a> <span id="r5 rd" class="r5 r">memoryStream</span> = <b>new</b> <a href="@1@netstandard/A.html#f92fa270fda9a82b" class="t constructor">MemoryStream</a>(<span class="r4 r">blob</span>))
            {
                <a href="@1@netstandard/A.html#cb30a8c80b6c7ba8" class="k">var</a> <span id="r6 rd" class="r6 r">xmlReaderSettings</span> = <b>new</b> <a href="@1@netstandard/A.html#31798f77c7ed2365" class="t constructor">XmlReaderSettings</a>()
                {
                    <a href="@1@netstandard/A.html#af04f0b98ea5df61" class="i property">DtdProcessing</a> = <a href="@1@netstandard/A.html#d84195678dddf30f" class="t t">DtdProcessing</a>.<a href="@1@netstandard/A.html#a7b7492401b42013" class="i field">Prohibit</a>, <a href="@1@netstandard/A.html#4765a49bdfbc114a" class="i property">IgnoreProcessingInstructions</a> = <b>true</b>
                };
 
                <b>using</b> (<a href="@1@netstandard/A.html#086471e5cca0825f" class="k">var</a> <span id="r7 rd" class="r7 r">xmlReader</span> = <a href="@1@netstandard/A.html#086471e5cca0825f" class="t t">XmlReader</a>.<a href="@1@netstandard/A.html#c40ac4c7e77c16ce" class="i method">Create</a>(<span class="r5 r">memoryStream</span>, <span class="r6 r">xmlReaderSettings</span>))
                {
                    <b>return</b> <a href="@1@netstandard/A.html#3354dac0913e417b" class="t t">XDocument</a>.<a href="@1@netstandard/A.html#7863839fb2142c14" class="i method">Load</a>(<span class="r7 r">xmlReader</span>);
                }
            }
        }
 
        <b>private async</b> <a href="@1@netstandard/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="@1@netstandard/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="@1@netstandard/A.html#3367036406d1344a" class="t t">XElement</a>&gt;&gt; <a id="7a90933ffa844abe" href="R/7a90933ffa844abe.html" target="n" data-glyph="76,1" class="i method">GetAllElementsAsync</a>()
        {
            <a href="#df31ebe42094092f" class="k">var</a> <span id="r8 rd" class="r8 r">data</span> = <b>await</b> <a href="#1d4135ec034f5dce" class="i method">GetLatestDataAsync</a>().<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
            <b>if</b> (<span class="r8 r">data</span> == <b>null</b> || <span class="r8 r">data</span>.<a href="#13e6ce152d8c9062" class="i field">BlobContents</a>.<a href="@1@netstandard/A.html#42e9b7616956cf94" class="i property">Length</a> == 0)
            {
                <span class="c">// no data in blob storage</span>
                <b>return</b> <a href="@1@netstandard/A.html#156e066ecc4ccedf" class="t t">Array</a>.<a href="@1@netstandard/A.html#bc9fd1be0e4f4e70" class="i method">Empty</a>&lt;<a href="@1@netstandard/A.html#3367036406d1344a" class="t t">XElement</a>&gt;();
            }
 
            <span class="c">// The document will look like this:</span>
            <span class="c">//</span>
            <span class="c">// &lt;root&gt;</span>
            <span class="c">//   &lt;child /&gt;</span>
            <span class="c">//   &lt;child /&gt;</span>
            <span class="c">//   ...</span>
            <span class="c">// &lt;/root&gt;</span>
            <span class="c">//</span>
            <span class="c">// We want to return the first-level child elements to our caller.</span>
 
            <a href="@1@netstandard/A.html#3354dac0913e417b" class="k">var</a> <span id="r9 rd" class="r9 r">doc</span> = <a href="#8314443ee4534dee" class="i method">CreateDocumentFromBlob</a>(<span class="r8 r">data</span>.<a href="#13e6ce152d8c9062" class="i field">BlobContents</a>);
            <b>return</b> <span class="r9 r">doc</span>.<a href="@1@netstandard/A.html#bd595f7d7f214050" class="i property">Root</a>.<a href="@1@netstandard/A.html#ba924793743a69b6" class="i method">Elements</a>().<a href="@1@netstandard/A.html#e276d6892241255b" class="i method">ToList</a>();
        }
 
        <b>private async</b> <a href="@1@netstandard/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="#df31ebe42094092f" class="t t">BlobData</a>&gt; <a id="1d4135ec034f5dce" href="R/1d4135ec034f5dce.html" target="n" data-glyph="76,1" class="i method">GetLatestDataAsync</a>()
        {
            <span class="c">// Set the appropriate AccessCondition based on what we believe the latest</span>
            <span class="c">// file contents to be, then make the request.</span>
 
            <a href="#df31ebe42094092f" class="k">var</a> <span id="r10 rd" class="r10 r">latestCachedData</span> = <a href="@1@netstandard/A.html#d7abcac016fb599d" class="t t">Volatile</a>.<a href="@1@netstandard/A.html#f3ce676af48f87f7" class="i method">Read</a>(<b>ref</b> <a href="#23801a23e4c7b837" class="i field">_cachedBlobData</a>); <span class="c">// local ref so field isn&#39;t mutated under our feet</span>
            <a href="/Azure.Storage.Blobs/A.html#340adb54d55c6c34" class="k">var</a> <span id="r11 rd" class="r11 r">requestCondition</span> = (<span class="r10 r">latestCachedData</span> != <b>null</b>)
                ? <b>new</b> <a href="/Azure.Storage.Blobs/A.html#5fe01134b7f5b183" class="t constructor">BlobRequestConditions</a>() { <a href="/Azure.Core/A.html#9dcd4da0df2d88c2" class="i property">IfNoneMatch</a> = <span class="r10 r">latestCachedData</span>.<a href="#4d870bcbe9a9f9d0" class="i field">ETag</a> }
                : <b>null</b>;
 
            <b>try</b>
            {
                <b>using</b> (<a href="@1@netstandard/A.html#1a4dcb744a23ba6f" class="k">var</a> <span id="r12 rd" class="r12 r">memoryStream</span> = <b>new</b> <a href="@1@netstandard/A.html#d308091cc690e78d" class="t constructor">MemoryStream</a>())
                {
                    <a href="/Azure.Core/A.html#ad97b1910f5ca3eb" class="k">var</a> <span id="r13 rd" class="r13 r">response</span> = <b>await</b> <a href="#880512ec2456ecae" class="i field">_blobClient</a>.<a href="/Azure.Storage.Blobs/A.html#2455f5f748982345" class="i method">DownloadToAsync</a>(
                        <span class="r14 r">destination</span>: <span class="r12 r">memoryStream</span>,
                        <span class="r15 r">conditions</span>: <span class="r11 r">requestCondition</span>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                    <b>if</b> (<span class="r13 r">response</span>.<a href="/Azure.Core/A.html#53e6401c580f9719" class="i property">Status</a> == 304)
                    {
                        <span class="c">// 304 Not Modified</span>
                        <span class="c">// Thrown when we already have the latest cached data.</span>
                        <span class="c">// This isn&#39;t an error; we&#39;ll return our cached copy of the data.</span>
                        <b>return</b> <span class="r10 r">latestCachedData</span>;
                    }
 
                    <span class="c">// At this point, our original cache either didn&#39;t exist or was outdated.</span>
                    <span class="c">// We&#39;ll update it now and return the updated value</span>
                    <span class="r10 r">latestCachedData</span> = <b>new</b> <a href="#df31ebe42094092f" class="t constructor">BlobData</a>()
                    {
                        <a href="#13e6ce152d8c9062" class="i field">BlobContents</a> = <span class="r12 r">memoryStream</span>.<a href="@1@netstandard/A.html#5df5fc757781f05e" class="i method">ToArray</a>(),
                        <a href="#4d870bcbe9a9f9d0" class="i field">ETag</a> = <span class="r13 r">response</span>.<a href="/Azure.Core/A.html#9f6adbd7e81f8000" class="i property">Headers</a>.<a href="/Azure.Core/A.html#5cb5957443570b99" class="i property">ETag</a>
                    };
                }
                <a href="@1@netstandard/A.html#d7abcac016fb599d" class="t t">Volatile</a>.<a href="@1@netstandard/A.html#2a8624052200ee3f" class="i method">Write</a>(<b>ref</b> <a href="#23801a23e4c7b837" class="i field">_cachedBlobData</a>, <span class="r10 r">latestCachedData</span>);
            }
            <b>catch</b> (<a href="/Azure.Core/A.html#253c51f73f5cd67d" class="t t">RequestFailedException</a> <span id="r16 rd" class="r16 r">ex</span>) <b>when</b> (<span class="r16 r">ex</span>.<a href="/Azure.Core/A.html#2e95914e1b156417" class="i property">Status</a> == 404)
            {
                <span class="c">// 404 Not Found</span>
                <span class="c">// Thrown when no file exists in storage.</span>
                <span class="c">// This isn&#39;t an error; we&#39;ll delete our cached copy of data.</span>
 
                <span class="r10 r">latestCachedData</span> = <b>null</b>;
                <a href="@1@netstandard/A.html#d7abcac016fb599d" class="t t">Volatile</a>.<a href="@1@netstandard/A.html#2a8624052200ee3f" class="i method">Write</a>(<b>ref</b> <a href="#23801a23e4c7b837" class="i field">_cachedBlobData</a>, <span class="r10 r">latestCachedData</span>);
            }
 
            <b>return</b> <span class="r10 r">latestCachedData</span>;
        }
 
        <b>private int</b> <a id="ce40f322354ad101" href="R/ce40f322354ad101.html" target="n" data-glyph="76,1" class="i method">GetRandomizedBackoffPeriod</a>()
        {
            <span class="c">// returns a TimeSpan in the range [0.8, 1.0) * ConflictBackoffPeriod</span>
            <span class="c">// not used for crypto purposes</span>
            <a href="@1@netstandard/A.html#1a65cbdb09544ba1" class="k">var</a> <span id="r17 rd" class="r17 r">multiplier</span> = 0.8 + (<a href="#0266536155724a9c" class="i field">_random</a>.<a href="@1@netstandard/A.html#c467f2953a8d2207" class="i method">NextDouble</a>() * 0.2);
            <b>return</b> (<b>int</b>) (<span class="r17 r">multiplier</span> * <a href="#0e811d5ef0f655fa" class="i field">ConflictBackoffPeriod</a>.<a href="@1@netstandard/A.html#45b3882f7cfdd300" class="i property">Ticks</a>);
        }
 
        <b>private async</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="5ad7cc0b6b6e9997" href="R/5ad7cc0b6b6e9997.html" target="n" data-glyph="76,1" class="i method">StoreElementAsync</a>(<a href="@1@netstandard/A.html#3367036406d1344a" class="t t">XElement</a> <span id="r18 rd" class="r18 r">element</span>)
        {
            <span class="c">// holds the last error in case we need to rethrow it</span>
            <a href="@1@netstandard/A.html#1443447025759846" class="t t">ExceptionDispatchInfo</a> <span id="r19 rd" class="r19 r">lastError</span> = <b>null</b>;
 
            <b>for</b> (<a href="@1@netstandard/A.html#225942ed7b7a3252" class="k">var</a> <span id="r20 rd" class="r20 r">i</span> = 0; <span class="r20 r">i</span> &lt; <a href="#d1aadd34e17b8545" class="i field">ConflictMaxRetries</a>; <span class="r20 r">i</span>++)
            {
                <b>if</b> (<span class="r20 r">i</span> &gt; 1)
                {
                    <span class="c">// If multiple conflicts occurred, wait a small period of time before retrying</span>
                    <span class="c">// the operation so that other writers can make forward progress.</span>
                    <b>await</b> <a href="@1@netstandard/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@netstandard/A.html#34b191a243434f6a" class="i method">Delay</a>(<a href="#ce40f322354ad101" class="i method">GetRandomizedBackoffPeriod</a>()).<a href="@1@netstandard/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<b>false</b>);
                }
 
                <b>if</b> (<span class="r20 r">i</span> &gt; 0)
                {
                    <span class="c">// If at least one conflict occurred, make sure we have an up-to-date</span>
                    <span class="c">// view of the blob contents.</span>
                    <b>await</b> <a href="#1d4135ec034f5dce" class="i method">GetLatestDataAsync</a>().<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
                }
 
                <span class="c">// Merge the new element into the document. If no document exists,</span>
                <span class="c">// create a new default document and inject this element into it.</span>
 
                <a href="#df31ebe42094092f" class="k">var</a> <span id="r21 rd" class="r21 r">latestData</span> = <a href="@1@netstandard/A.html#d7abcac016fb599d" class="t t">Volatile</a>.<a href="@1@netstandard/A.html#f3ce676af48f87f7" class="i method">Read</a>(<b>ref</b> <a href="#23801a23e4c7b837" class="i field">_cachedBlobData</a>);
                <a href="@1@netstandard/A.html#3354dac0913e417b" class="k">var</a> <span id="r22 rd" class="r22 r">doc</span> = (<span class="r21 r">latestData</span> != <b>null</b>)
                    ? <a href="#8314443ee4534dee" class="i method">CreateDocumentFromBlob</a>(<span class="r21 r">latestData</span>.<a href="#13e6ce152d8c9062" class="i field">BlobContents</a>)
                    : <b>new</b> <a href="@1@netstandard/A.html#c984361a4979dfdc" class="t constructor">XDocument</a>(<b>new</b> <a href="@1@netstandard/A.html#6be3dee6c68afac7" class="t constructor">XElement</a>(<a href="#f6a8edf67afb731a" class="i field">RepositoryElementName</a>));
                <span class="r22 r">doc</span>.<a href="@1@netstandard/A.html#bd595f7d7f214050" class="i property">Root</a>.<a href="@1@netstandard/A.html#ec7a3166ef790ab0" class="i method">Add</a>(<span class="r18 r">element</span>);
 
                <span class="c">// Turn this document back into a byte[].</span>
 
                <a href="@1@netstandard/A.html#1a4dcb744a23ba6f" class="k">var</a> <span id="r23 rd" class="r23 r">serializedDoc</span> = <b>new</b> <a href="@1@netstandard/A.html#d308091cc690e78d" class="t constructor">MemoryStream</a>();
                <span class="r22 r">doc</span>.<a href="@1@netstandard/A.html#4aba58ecfe2d8a10" class="i method">Save</a>(<span class="r23 r">serializedDoc</span>, <a href="@1@netstandard/A.html#ab1c46fb86d0d183" class="t t">SaveOptions</a>.<a href="@1@netstandard/A.html#46c83f307b13368d" class="i field">DisableFormatting</a>);
                <span class="r23 r">serializedDoc</span>.<a href="@1@netstandard/A.html#ad08f8ca81a5a763" class="i property">Position</a> = 0;
 
                <span class="c">// Generate the appropriate precondition header based on whether or not</span>
                <span class="c">// we believe data already exists in storage.</span>
 
                <a href="/Azure.Storage.Blobs/A.html#340adb54d55c6c34" class="t t">BlobRequestConditions</a> <span id="r24 rd" class="r24 r">requestConditions</span>;
                <b>if</b> (<span class="r21 r">latestData</span> != <b>null</b>)
                {
                    <span class="r24 r">requestConditions</span> = <b>new</b> <a href="/Azure.Storage.Blobs/A.html#5fe01134b7f5b183" class="t constructor">BlobRequestConditions</a>() { <a href="/Azure.Core/A.html#c0640f9cb69488b5" class="i property">IfMatch</a> = <span class="r21 r">latestData</span>.<a href="#4d870bcbe9a9f9d0" class="i field">ETag</a> };
                }
                <b>else</b>
                {
                    <span class="r24 r">requestConditions</span> = <b>new</b> <a href="/Azure.Storage.Blobs/A.html#5fe01134b7f5b183" class="t constructor">BlobRequestConditions</a>() { <a href="/Azure.Core/A.html#9dcd4da0df2d88c2" class="i property">IfNoneMatch</a> = <a href="/Azure.Core/A.html#69017d8593c3f0de" class="t t">ETag</a>.<a href="/Azure.Core/A.html#aaa0ca99cf4ccecf" class="i field">All</a> };
                }
 
                <b>try</b>
                {
                    <span class="c">// Send the request up to the server.</span>
                    <a href="/Azure.Core/A.html#f0acdd38dd24ccb7" class="k">var</a> <span id="r25 rd" class="r25 r">response</span> = <b>await</b> <a href="#880512ec2456ecae" class="i field">_blobClient</a>.<a href="/Azure.Storage.Blobs/A.html#e1ff7f76ced5700a" class="i method">UploadAsync</a>(
                        <span class="r23 r">serializedDoc</span>,
                        <span class="r26 r">httpHeaders</span>: <a href="#19a0b6e60e241326" class="i field">_blobHttpHeaders</a>,
                        <span class="r27 r">conditions</span>: <span class="r24 r">requestConditions</span>).<a href="@1@netstandard/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
                    <span class="c">// If we got this far, success!</span>
                    <span class="c">// We can update the cached view of the remote contents.</span>
 
                    <a href="@1@netstandard/A.html#d7abcac016fb599d" class="t t">Volatile</a>.<a href="@1@netstandard/A.html#2a8624052200ee3f" class="i method">Write</a>(<b>ref</b> <a href="#23801a23e4c7b837" class="i field">_cachedBlobData</a>, <b>new</b> <a href="#df31ebe42094092f" class="t constructor">BlobData</a>()
                    {
                        <a href="#13e6ce152d8c9062" class="i field">BlobContents</a> = <span class="r23 r">serializedDoc</span>.<a href="@1@netstandard/A.html#5df5fc757781f05e" class="i method">ToArray</a>(),
                        <a href="#4d870bcbe9a9f9d0" class="i field">ETag</a> = <span class="r25 r">response</span>.<a href="/Azure.Core/A.html#26af68e791f2f80a" class="i property">Value</a>.<a href="/Azure.Storage.Blobs/A.html#4f7f201ae3000c6c" class="i property">ETag</a> <span class="c">// was updated by Upload routine</span>
                    });
 
                    <b>return</b>;
                }
                <b>catch</b> (<a href="/Azure.Core/A.html#253c51f73f5cd67d" class="t t">RequestFailedException</a> <span id="r28 rd" class="r28 r">ex</span>)
                    <b>when</b> (<span class="r28 r">ex</span>.<a href="/Azure.Core/A.html#2e95914e1b156417" class="i property">Status</a> == 409 || <span class="r28 r">ex</span>.<a href="/Azure.Core/A.html#2e95914e1b156417" class="i property">Status</a> == 412)
                {
                    <span class="c">// 409 Conflict</span>
                    <span class="c">// This error is rare but can be thrown in very special circumstances,</span>
                    <span class="c">// such as if the blob in the process of being created. We treat it</span>
                    <span class="c">// as equivalent to 412 for the purposes of retry logic.</span>
 
                    <span class="c">// 412 Precondition Failed</span>
                    <span class="c">// We&#39;ll get this error if another writer updated the repository and we</span>
                    <span class="c">// have an outdated view of its contents. If this occurs, we&#39;ll just</span>
                    <span class="c">// refresh our view of the remote contents and try again up to the max</span>
                    <span class="c">// retry limit.</span>
 
                    <span class="r19 r">lastError</span> = <a href="@1@netstandard/A.html#1443447025759846" class="t t">ExceptionDispatchInfo</a>.<a href="@1@netstandard/A.html#139923899a417d5a" class="i method">Capture</a>(<span class="r28 r">ex</span>);
                }
            }
 
            <span class="c">// if we got this far, something went awry</span>
            <span class="r19 r">lastError</span>.<a href="@1@netstandard/A.html#fc3b312e2d0ab87a" class="i method">Throw</a>();
        }
 
        <b>private sealed class</b> <a id="df31ebe42094092f" href="R/df31ebe42094092f.html" target="n" data-glyph="4,1" class="t t"><span id="164e7e45f675153c">BlobData</span></a>
        {
            <b>internal byte</b>[] <a id="13e6ce152d8c9062" href="R/13e6ce152d8c9062.html" target="n" data-glyph="44,2" class="i field">BlobContents</a>;
            <b>internal</b> <a href="/Azure.Core/A.html#69017d8593c3f0de" class="t t">ETag</a>? <a id="4d870bcbe9a9f9d0" href="R/4d870bcbe9a9f9d0.html" target="n" data-glyph="44,2" class="i field">ETag</a>;
        }
    }
}
</pre></td></tr></table></div></body></html>
