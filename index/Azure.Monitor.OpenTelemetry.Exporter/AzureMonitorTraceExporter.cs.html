<!DOCTYPE html>
<html><head><title>AzureMonitorTraceExporter.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(81);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Monitor.OpenTelemetry.Exporter/AzureMonitorTraceExporter.cs" target="_top">AzureMonitorTraceExporter.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/monitor/Azure.Monitor.OpenTelemetry.Exporter/src/AzureMonitorTraceExporter.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Monitor.OpenTelemetry.Exporter" target="_top">Azure.Monitor.OpenTelemetry.Exporter.csproj</a> (Azure.Monitor.OpenTelemetry.Exporter)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
 
<b>using</b> <span class="i n">Azure</span>.<span class="i n">Core</span>.<span class="i n">Pipeline</span>;
 
<b>using</b> <span class="i n">OpenTelemetry</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Monitor</span>.<span class="i n">OpenTelemetry</span>.<span class="i n">Exporter</span>
{
    <b>public class</b> <a id="7e3a6d0ba21623d1" href="R/7e3a6d0ba21623d1.html" target="n" data-glyph="0,0" class="t t">AzureMonitorTraceExporter</a> : <span class="t t">BaseExporter</span>&lt;<span class="t t">Activity</span>&gt;
    {
        <b>private readonly</b> <a href="ITransmitter.cs.html#bdde0e25bc65a4f8" class="t t">ITransmitter</a> <a id="94dc9d3b5f451390" href="R/94dc9d3b5f451390.html" target="n" data-glyph="46,1" class="i field">_transmitter</a>;
        <b>private readonly</b> <a href="AzureMonitorExporterOptions.cs.html#7e07465cec4042ba" class="t t">AzureMonitorExporterOptions</a> <a id="af16f4680cb8a738" href="R/af16f4680cb8a738.html" target="n" data-glyph="46,1" class="i field">_options</a>;
        <b>private readonly string</b> <a id="3d61d618c3673d63" href="R/3d61d618c3673d63.html" target="n" data-glyph="46,1" class="i field">_instrumentationKey</a>;
        <b>private readonly</b> <a href="ResourceParser.cs.html#e2b76415adad4916" class="t t">ResourceParser</a> <a id="153a127e8becba11" href="R/153a127e8becba11.html" target="n" data-glyph="46,1" class="i field">_resourceParser</a>;
        <b>private readonly</b> <a href="StorageTransmissionEvaluator.cs.html#b6b247d43de81bed" class="t t">StorageTransmissionEvaluator</a> <a id="ce4c3f787dace05e" href="R/ce4c3f787dace05e.html" target="n" data-glyph="46,1" class="i field">_storageTransmissionEvaluator</a>;
        <b>private const int</b> <a id="0f507972b4afd4c5" href="R/0f507972b4afd4c5.html" target="n" data-glyph="10,1" class="i field">StorageTransmissionEvaluatorSampleSize</a> = 10;
 
        <b>public</b> <a id="22e1fa63594d12c8" href="R/22e1fa63594d12c8.html" target="n" data-glyph="72,1" class="t constructor">AzureMonitorTraceExporter</a>(<a href="AzureMonitorExporterOptions.cs.html#7e07465cec4042ba" class="t t">AzureMonitorExporterOptions</a> <span id="r0 rd" class="r0 r">options</span>) : <a href="#a1a9742b178c8536" class="k">this</a>(<span class="r0 r">options</span>, <b>new</b> <a href="AzureMonitorTransmitter.cs.html#8973e7f23178add5" class="t constructor">AzureMonitorTransmitter</a>(<span class="r0 r">options</span>))
        {
        }
 
        <b>internal</b> <a id="a1a9742b178c8536" href="R/a1a9742b178c8536.html" target="n" data-glyph="74,1" class="t constructor">AzureMonitorTraceExporter</a>(<a href="AzureMonitorExporterOptions.cs.html#7e07465cec4042ba" class="t t">AzureMonitorExporterOptions</a> <span id="r1 rd" class="r1 r">options</span>, <a href="ITransmitter.cs.html#bdde0e25bc65a4f8" class="t t">ITransmitter</a> <span id="r2 rd" class="r2 r">transmitter</span>)
        {
            <a href="#af16f4680cb8a738" class="i field">_options</a> = <span class="r1 r">options</span> ?? <b>throw</b> <b>new</b> <a href="@1@netstandard/A.html#8314938388254d5a" class="t constructor">ArgumentNullException</a>(<b>nameof</b>(<span class="r1 r">options</span>));
            <span class="i n">ConnectionString</span>.<a href="ConnectionString/ConnectionStringParser.cs.html#413cc78b25b8603a" class="t t">ConnectionStringParser</a>.<a href="ConnectionString/ConnectionStringParser.cs.html#b046652ba829be05" class="i method">GetValues</a>(<a href="#af16f4680cb8a738" class="i field">_options</a>.<a href="AzureMonitorExporterOptions.cs.html#cc21c169343c77e5" class="i property">ConnectionString</a>, <b>out</b> <a href="#3d61d618c3673d63" class="i field">_instrumentationKey</a>, <b>out _</b>);
            <a href="#94dc9d3b5f451390" class="i field">_transmitter</a> = <span class="r2 r">transmitter</span>;
            <a href="#153a127e8becba11" class="i field">_resourceParser</a> = <b>new</b> <a href="ResourceParser.cs.html#e2b76415adad4916" class="t constructor">ResourceParser</a>();
 
            <span class="c">// Todo: Add check if offline storage is enabled by user via options</span>
            <a href="#ce4c3f787dace05e" class="i field">_storageTransmissionEvaluator</a> = <b>new</b> <a href="StorageTransmissionEvaluator.cs.html#409ec0b776be571e" class="t constructor">StorageTransmissionEvaluator</a>(<a href="#0f507972b4afd4c5" class="i field">StorageTransmissionEvaluatorSampleSize</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">inheritdoc</span><span class="c">/&gt;</span>
        <b>public override</b> <span class="t t">ExportResult</span> <a id="08247fc5b1a10f95" href="R/08247fc5b1a10f95.html" target="n" data-glyph="72,1" class="i method">Export</a>(<b>in</b> <span class="t t">Batch</span>&lt;<span class="t t">Activity</span>&gt; <span id="r3 rd" class="r3 r">batch</span>)
        {
            <span class="c">// Add export time interval to data sample</span>
            <a href="#ce4c3f787dace05e" class="i field">_storageTransmissionEvaluator</a>?.<a href="StorageTransmissionEvaluator.cs.html#a07bfcd6c43ab79e" class="i method">UpdateExportInterval</a>();
 
            <span class="c">// Prevent Azure Monitor&#39;s HTTP operations from being instrumented.</span>
            <b>using</b> <a href="@1@netstandard/A.html#1f55292c3174123d" class="k">var</a> <span id="r4 rd" class="r4 r">scope</span> = <span class="t t">SuppressInstrumentationScope</span>.<span class="i method">Begin</span>();
 
            <b>try</b>
            {
                <span class="c">// Get number ticks before export</span>
                <b>long</b> <span id="r5 rd" class="r5 r">ticksBeforeExport</span> =  <a href="@1@netstandard/A.html#ceb0ba9cc88de82e" class="t t">Stopwatch</a>.<a href="@1@netstandard/A.html#69c6c3137e12dab4" class="i method">GetTimestamp</a>();
 
                <b>var</b> <span id="r6 rd" class="r6 r">resource</span> = <span class="i property">ParentProvider</span>.<span class="i method">GetResource</span>();
                <a href="#153a127e8becba11" class="i field">_resourceParser</a>.<a href="ResourceParser.cs.html#f5da24288c53aa9a" class="i method">UpdateRoleNameAndInstance</a>(<span class="r6 r">resource</span>);
                <a href="@1@netstandard/A.html#cf7f4095e4de7646" class="k">var</a> <span id="r7 rd" class="r7 r">telemetryItems</span> = <a href="TraceHelper.cs.html#696cd4302d1e8aa4" class="t t">TraceHelper</a>.<a href="TraceHelper.cs.html#bccc6bb2fbc320f2" class="i method">OtelToAzureMonitorTrace</a>(<span class="r3 r">batch</span>, <a href="#153a127e8becba11" class="i field">_resourceParser</a>.<a href="ResourceParser.cs.html#e9cd922bf5e9322d" class="i property">RoleName</a>, <a href="#153a127e8becba11" class="i field">_resourceParser</a>.<a href="ResourceParser.cs.html#97bc0e4610fc2873" class="i property">RoleInstance</a>, <a href="#3d61d618c3673d63" class="i field">_instrumentationKey</a>);
 
                <span class="c">// TODO: Handle return value, it can be converted as metrics.</span>
                <span class="c">// TODO: Validate CancellationToken and async pattern here.</span>
                <b>var</b> <span id="r8 rd" class="r8 r">exportResult</span> = <a href="#94dc9d3b5f451390" class="i field">_transmitter</a>.<a href="ITransmitter.cs.html#05b0f9aa79237892" class="i method">TrackAsync</a>(<span class="r7 r">telemetryItems</span>, <b>false</b>, <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@1@netstandard/A.html#ec32c41597007382" class="i property">None</a>).<a href="Shared/TaskExtensions.cs.html#8c91f60473262282" class="i method">EnsureCompleted</a>();
 
                <span class="c">// Get number of ticks after export</span>
                <b>long</b> <span id="r9 rd" class="r9 r">ticksAfterExport</span> = <a href="@1@netstandard/A.html#ceb0ba9cc88de82e" class="t t">Stopwatch</a>.<a href="@1@netstandard/A.html#69c6c3137e12dab4" class="i method">GetTimestamp</a>();
 
                <span class="c">// Calculate duration and add it to data sample</span>
                <b>double</b> <span id="r10 rd" class="r10 r">currentExportDuration</span> = <a href="@1@netstandard/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@1@netstandard/A.html#6f8cfb43f19b8c4d" class="i method">FromTicks</a>(<span class="r9 r">ticksAfterExport</span> - <span class="r5 r">ticksBeforeExport</span>).<a href="@1@netstandard/A.html#061d7498e3227cfb" class="i property">TotalSeconds</a>;
                <a href="#ce4c3f787dace05e" class="i field">_storageTransmissionEvaluator</a>.<a href="StorageTransmissionEvaluator.cs.html#f694828deb40aa86" class="i method">UpdateExportDuration</a>(<span class="r10 r">currentExportDuration</span>);
 
                <span class="c">// Get max number of files we can transmit in this export and start transmitting</span>
                <b>long</b> <span id="r11 rd" class="r11 r">maxFilesToTransmit</span> = <a href="#ce4c3f787dace05e" class="i field">_storageTransmissionEvaluator</a>.<a href="StorageTransmissionEvaluator.cs.html#5bf9e55f7a41e6f7" class="i method">MaxFilesToTransmitFromStorage</a>();
                <a href="#94dc9d3b5f451390" class="i field">_transmitter</a>.<a href="ITransmitter.cs.html#18694017b899ffa7" class="i method">TransmitFromStorage</a>(<span class="r11 r">maxFilesToTransmit</span>, <b>false</b>, <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@1@netstandard/A.html#ec32c41597007382" class="i property">None</a>);
 
                <b>return</b> <span class="r8 r">exportResult</span>;
            }
            <b>catch</b> (<a href="@1@netstandard/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r12 rd" class="r12 r">ex</span>)
            {
                <a href="AzureMonitorExporterEventSource.cs.html#155c1bf5439a2ad1" class="t t">AzureMonitorExporterEventSource</a>.<a href="AzureMonitorExporterEventSource.cs.html#35e5ee1b6a9ccf51" class="i field">Log</a>.<a href="AzureMonitorExporterEventSource.cs.html#3c05ae2bd549a12a" class="i method">Write</a>(<span class="s">$&quot;</span><span class="s">FailedToExport</span>{<a href="EventLevelSuffix.cs.html#1fcfdf164b5b4c83" class="t t">EventLevelSuffix</a>.<a href="EventLevelSuffix.cs.html#1fe3c3583d7f1778" class="i field">Error</a>}<span class="s">&quot;</span>, <span class="r12 r">ex</span>.<a href="ExceptionExtensions.cs.html#04581afeb4e2794d" class="i method">LogAsyncException</a>());
                <b>return</b> <span class="t t">ExportResult</span>.<span class="i field">Failure</span>;
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
