<!DOCTYPE html>
<html><head><title>AzureMonitorPersistentStorage.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(48);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Monitor.OpenTelemetry.Exporter/AzureMonitorPersistentStorage.cs" target="_top">AzureMonitorPersistentStorage.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/monitor/Azure.Monitor.OpenTelemetry.Exporter/src/AzureMonitorPersistentStorage.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Monitor.OpenTelemetry.Exporter" target="_top">Azure.Monitor.OpenTelemetry.Exporter.csproj</a> (Azure.Monitor.OpenTelemetry.Exporter)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Monitor</span>.<span class="i n">OpenTelemetry</span>.<span class="i n">Exporter</span>
{
    <b>internal class</b> <a id="a246b1e0a2324c45" href="R/a246b1e0a2324c45.html" target="n" data-glyph="2,0" class="t t">AzureMonitorPersistentStorage</a>
    {
        <b>private const int</b> <a id="83e3c0a1c9738fa0" href="R/83e3c0a1c9738fa0.html" target="n" data-glyph="10,1" class="i field">StorageTransmissionEvaluatorSampleSize</a> = 10;
        <b>private readonly</b> <a href="@1@netstandard/A.html#ceb0ba9cc88de82e" class="t t">Stopwatch</a> <a id="ec0eea195f0225aa" href="R/ec0eea195f0225aa.html" target="n" data-glyph="46,1" class="i field">_stopwatch</a>;
        <b>private readonly</b> <a href="StorageTransmissionEvaluator.cs.html#b6b247d43de81bed" class="t t">StorageTransmissionEvaluator</a> <a id="8e5e4d7943e57819" href="R/8e5e4d7943e57819.html" target="n" data-glyph="46,1" class="i field">_storageTransmissionEvaluator</a>;
        <b>private readonly</b> <a href="ITransmitter.cs.html#bdde0e25bc65a4f8" class="t t">ITransmitter</a> <a id="a0a0dd7c75974a12" href="R/a0a0dd7c75974a12.html" target="n" data-glyph="46,1" class="i field">_transmitter</a>;
        <b>private long</b> <a id="47838473e3096ebc" href="R/47838473e3096ebc.html" target="n" data-glyph="46,1" class="i field">_exportStartTimeInMilliseconds</a>;
 
        <b>public</b> <a id="9d31d529e16ecd41" href="R/9d31d529e16ecd41.html" target="n" data-glyph="72,1" class="t constructor">AzureMonitorPersistentStorage</a>(<a href="ITransmitter.cs.html#bdde0e25bc65a4f8" class="t t">ITransmitter</a> <span id="r0 rd" class="r0 r">transmitter</span>)
        {
            <a href="#a0a0dd7c75974a12" class="i field">_transmitter</a> = <span class="r0 r">transmitter</span>;
            <a href="#ec0eea195f0225aa" class="i field">_stopwatch</a> = <a href="@1@netstandard/A.html#ceb0ba9cc88de82e" class="t t">Stopwatch</a>.<a href="@1@netstandard/A.html#dc0a41ceabc92682" class="i method">StartNew</a>();
            <a href="#8e5e4d7943e57819" class="i field">_storageTransmissionEvaluator</a> = <b>new</b> <a href="StorageTransmissionEvaluator.cs.html#409ec0b776be571e" class="t constructor">StorageTransmissionEvaluator</a>(<a href="#83e3c0a1c9738fa0" class="i field">StorageTransmissionEvaluatorSampleSize</a>);
        }
 
        <b>internal void</b> <a id="422d6f409f7ac3c4" href="R/422d6f409f7ac3c4.html" target="n" data-glyph="74,1" class="i method">StartExporterTimer</a>()
        {
            <span class="c">// Get export start time</span>
            <a href="#47838473e3096ebc" class="i field">_exportStartTimeInMilliseconds</a> = <a href="#ec0eea195f0225aa" class="i field">_stopwatch</a>.<a href="@1@netstandard/A.html#1cd9247e94fd0142" class="i property">ElapsedMilliseconds</a>;
 
            <span class="c">// Add export time interval to data sample</span>
            <a href="#8e5e4d7943e57819" class="i field">_storageTransmissionEvaluator</a>.<a href="StorageTransmissionEvaluator.cs.html#ab35bc7f56767f1b" class="i method">AddExportIntervalToDataSample</a>(<a href="#47838473e3096ebc" class="i field">_exportStartTimeInMilliseconds</a>);
        }
 
        <b>internal void</b> <a id="3b4323286db73f7b" href="R/3b4323286db73f7b.html" target="n" data-glyph="74,1" class="i method">StopExporterTimerAndTransmitFromStorage</a>()
        {
            <span class="c">// Get export end time</span>
            <b>long</b> <span id="r1 rd" class="r1 r">exportEndTimeInMilliseconds</span> = <a href="#ec0eea195f0225aa" class="i field">_stopwatch</a>.<a href="@1@netstandard/A.html#1cd9247e94fd0142" class="i property">ElapsedMilliseconds</a>;
 
            <span class="c">// Calculate duration and add it to data sample</span>
            <b>long</b> <span id="r2 rd" class="r2 r">currentBatchExportDurationInMilliseconds</span> = <span class="r1 r">exportEndTimeInMilliseconds</span> - <a href="#47838473e3096ebc" class="i field">_exportStartTimeInMilliseconds</a>;
            <a href="#8e5e4d7943e57819" class="i field">_storageTransmissionEvaluator</a>.<a href="StorageTransmissionEvaluator.cs.html#2973dc57fc500f7d" class="i method">AddExportDurationToDataSample</a>(<span class="r2 r">currentBatchExportDurationInMilliseconds</span>);
 
            <span class="c">// Get max number of files we can transmit in this export and start transmitting</span>
            <b>long</b> <span id="r3 rd" class="r3 r">maxFilesToTransmit</span> = <a href="#8e5e4d7943e57819" class="i field">_storageTransmissionEvaluator</a>.<a href="StorageTransmissionEvaluator.cs.html#01621f333d6faaf7" class="i method">GetMaxFilesToTransmitFromStorage</a>();
            <a href="#a0a0dd7c75974a12" class="i field">_transmitter</a>.<a href="ITransmitter.cs.html#18694017b899ffa7" class="i method">TransmitFromStorage</a>(<span class="r3 r">maxFilesToTransmit</span>, <b>false</b>, <a href="@1@netstandard/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@1@netstandard/A.html#ec32c41597007382" class="i property">None</a>);
        }
    }
}
</pre></td></tr></table></div></body></html>
