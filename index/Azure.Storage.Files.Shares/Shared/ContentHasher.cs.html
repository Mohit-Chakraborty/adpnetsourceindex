<!DOCTYPE html>
<html><head><title>ContentHasher.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(214);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Storage.Files.Shares/Shared/ContentHasher.cs" target="_top">Shared\ContentHasher.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/storage/Azure.Storage.Common/src/Shared/ContentHasher.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Storage.Files.Shares" target="_top">Azure.Storage.Files.Shares.csproj</a> (Azure.Storage.Files.Shares)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="c">// TODO #27253</span>
 
<span class="c">//using System;</span>
<span class="c">//using System.IO;</span>
<span class="c">//using System.Linq;</span>
<span class="c">//using System.Security.Cryptography;</span>
<span class="c">//using Azure.Core;</span>
 
<span class="c">//namespace Azure.Storage</span>
<span class="c">//{</span>
<span class="c">//    /// &lt;summary&gt;</span>
<span class="c">//    /// Hashes Storage content.</span>
<span class="c">//    /// &lt;/summary&gt;</span>
<span class="c">//    internal class ContentHasher</span>
<span class="c">//    {</span>
<span class="c">//        internal class GetHashResult</span>
<span class="c">//        {</span>
<span class="c">//            public GetHashResult(byte[] md5 = default, byte[] storageCrc64 = default)</span>
<span class="c">//            {</span>
<span class="c">//                MD5 = md5;</span>
<span class="c">//                StorageCrc64 = storageCrc64;</span>
<span class="c">//            }</span>
 
<span class="c">//            public byte[] MD5 { get;  }</span>
<span class="c">//            public byte[] StorageCrc64 { get; }</span>
<span class="c">//        }</span>
 
<span class="c">//        /// &lt;summary&gt;</span>
<span class="c">//        /// Asserts the content of the given stream match the response content hash.</span>
<span class="c">//        /// &lt;/summary&gt;</span>
<span class="c">//        /// &lt;param name=&quot;content&quot;&gt;Content to hash.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;algorithm&quot;&gt;Hash algorithm identifier.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;response&quot;&gt;Response containing a response hash.&lt;/param&gt;</span>
<span class="c">//        /// &lt;exception cref=&quot;ArgumentException&quot;&gt;</span>
<span class="c">//        /// Throws if &lt;paramref name=&quot;algorithm&quot;/&gt; is invalid.</span>
<span class="c">//        /// &lt;/exception&gt;</span>
<span class="c">//        /// &lt;exception cref=&quot;InvalidDataException&quot;&gt;</span>
<span class="c">//        /// Throws if the hashes do not match.</span>
<span class="c">//        /// &lt;/exception&gt;</span>
<span class="c">//        public static void AssertResponseHashMatch(Stream content, TransactionalHashAlgorithm algorithm, Response response)</span>
<span class="c">//        {</span>
<span class="c">//            GetHashResult computedHash = GetHash(content, algorithm);</span>
<span class="c">//            AssertResponseHashMatch(computedHash, algorithm, response);</span>
<span class="c">//        }</span>
 
<span class="c">//        /// &lt;summary&gt;</span>
<span class="c">//        /// Asserts the content of the given array match the response content hash.</span>
<span class="c">//        /// &lt;/summary&gt;</span>
<span class="c">//        /// &lt;param name=&quot;content&quot;&gt;Content to hash.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;offset&quot;&gt;Offset to start reading content at.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;count&quot;&gt;Number of bytes to read starting from the offset.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;algorithm&quot;&gt;Hash algorithm identifier.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;response&quot;&gt;Response containing a response hash.&lt;/param&gt;</span>
<span class="c">//        /// &lt;exception cref=&quot;ArgumentException&quot;&gt;</span>
<span class="c">//        /// Throws if &lt;paramref name=&quot;algorithm&quot;/&gt; is invalid.</span>
<span class="c">//        /// &lt;/exception&gt;</span>
<span class="c">//        /// &lt;exception cref=&quot;InvalidDataException&quot;&gt;</span>
<span class="c">//        /// Throws if the hashes do not match.</span>
<span class="c">//        /// &lt;/exception&gt;</span>
<span class="c">//        public static void AssertResponseHashMatch(byte[] content, int offset, int count, TransactionalHashAlgorithm algorithm, Response response)</span>
<span class="c">//        {</span>
<span class="c">//            GetHashResult computedHash = GetHash(content, offset, count, algorithm);</span>
<span class="c">//            AssertResponseHashMatch(computedHash, algorithm, response);</span>
<span class="c">//        }</span>
 
<span class="c">//        /// &lt;summary&gt;</span>
<span class="c">//        /// Asserts the computed hash matches the response content hash.</span>
<span class="c">//        /// &lt;/summary&gt;</span>
<span class="c">//        /// &lt;param name=&quot;computedHash&quot;&gt;SDK computed hash.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;algorithm&quot;&gt;Hash algorithm identifier.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;response&quot;&gt;Response containing a response hash.&lt;/param&gt;</span>
<span class="c">//        /// &lt;exception cref=&quot;ArgumentException&quot;&gt;</span>
<span class="c">//        /// Throws if &lt;paramref name=&quot;algorithm&quot;/&gt; is invalid.</span>
<span class="c">//        /// &lt;/exception&gt;</span>
<span class="c">//        /// &lt;exception cref=&quot;InvalidDataException&quot;&gt;</span>
<span class="c">//        /// Throws if the hashes do not match.</span>
<span class="c">//        /// &lt;/exception&gt;</span>
<span class="c">//        private static void AssertResponseHashMatch(GetHashResult computedHash, TransactionalHashAlgorithm algorithm, Response response)</span>
<span class="c">//        {</span>
<span class="c">//            if (computedHash == default)</span>
<span class="c">//            {</span>
<span class="c">//                throw Errors.ArgumentNull(nameof(computedHash));</span>
<span class="c">//            }</span>
<span class="c">//            if (response == default)</span>
<span class="c">//            {</span>
<span class="c">//                throw Errors.ArgumentNull(nameof(response));</span>
<span class="c">//            }</span>
 
<span class="c">//            switch (algorithm)</span>
<span class="c">//            {</span>
<span class="c">//                case TransactionalHashAlgorithm.MD5:</span>
<span class="c">//                    if (!Enumerable.SequenceEqual(</span>
<span class="c">//                        computedHash.MD5,</span>
<span class="c">//                        response.Headers.TryGetValue(&quot;Content-MD5&quot;, out byte[] md5) ? md5 : default))</span>
<span class="c">//                    {</span>
<span class="c">//                        throw Errors.HashMismatch(&quot;Content-MD5&quot;);</span>
<span class="c">//                    }</span>
<span class="c">//                    break;</span>
<span class="c">//                case TransactionalHashAlgorithm.StorageCrc64:</span>
<span class="c">//                    if (!Enumerable.SequenceEqual(</span>
<span class="c">//                        computedHash.StorageCrc64,</span>
<span class="c">//                        response.Headers.TryGetValue(&quot;x-ms-content-crc64&quot;, out byte[] crc) ? crc : default))</span>
<span class="c">//                    {</span>
<span class="c">//                        throw Errors.HashMismatch(&quot;x-ms-content-crc64&quot;);</span>
<span class="c">//                    }</span>
<span class="c">//                    break;</span>
<span class="c">//                default:</span>
<span class="c">//                    throw Errors.InvalidArgument(nameof(algorithm));</span>
<span class="c">//            }</span>
<span class="c">//        }</span>
 
<span class="c">//        /// &lt;summary&gt;</span>
<span class="c">//        /// Computes the requested hash for an upload operation, or default.</span>
<span class="c">//        /// &lt;/summary&gt;</span>
<span class="c">//        /// &lt;param name=&quot;content&quot;&gt;Content to hash.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;options&quot;&gt;Hash options.&lt;/param&gt;</span>
<span class="c">//        /// &lt;returns&gt;</span>
<span class="c">//        /// Object containing the requested hash on its algorithm&#39;s respective property. If</span>
<span class="c">//        /// &lt;paramref name=&quot;options&quot;/&gt; are default, then the returned result is default.</span>
<span class="c">//        /// &lt;/returns&gt;</span>
<span class="c">//        /// &lt;exception cref=&quot;ArgumentException&quot;&gt;</span>
<span class="c">//        /// Throws if &lt;paramref name=&quot;options&quot;/&gt; exists and &lt;see cref=&quot;UploadTransactionalHashingOptions.Algorithm&quot;/&gt;</span>
<span class="c">//        /// is invalid.</span>
<span class="c">//        /// &lt;/exception&gt;</span>
<span class="c">//        public static GetHashResult GetHashOrDefault(Stream content, UploadTransactionalHashingOptions options)</span>
<span class="c">//        {</span>
<span class="c">//            if (options == default)</span>
<span class="c">//            {</span>
<span class="c">//                return default;</span>
<span class="c">//            }</span>
 
<span class="c">//            if (options.PrecalculatedHash != default)</span>
<span class="c">//            {</span>
<span class="c">//                return options.Algorithm switch</span>
<span class="c">//                {</span>
<span class="c">//                    TransactionalHashAlgorithm.StorageCrc64 =&gt; new GetHashResult(storageCrc64: options.PrecalculatedHash),</span>
<span class="c">//                    TransactionalHashAlgorithm.MD5 =&gt; new GetHashResult(md5: options.PrecalculatedHash),</span>
<span class="c">//                    _ =&gt; throw Errors.InvalidArgument(nameof(options.Algorithm))</span>
<span class="c">//                };</span>
<span class="c">//            }</span>
<span class="c">//            return GetHash(content, options.Algorithm);</span>
<span class="c">//        }</span>
 
<span class="c">//        /// &lt;summary&gt;</span>
<span class="c">//        /// Computes the requested hash, if desired.</span>
<span class="c">//        /// &lt;/summary&gt;</span>
<span class="c">//        /// &lt;param name=&quot;content&quot;&gt;Content to hash.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;algorithmIdentifier&quot;&gt;Algorithm to compute the hash with.&lt;/param&gt;</span>
<span class="c">//        /// &lt;returns&gt;Object containing the requested hash, or no hash, on its algorithm&#39;s respective property.&lt;/returns&gt;</span>
<span class="c">//        /// &lt;exception cref=&quot;ArgumentException&quot;&gt;</span>
<span class="c">//        /// Throws if &lt;paramref name=&quot;algorithmIdentifier&quot;/&gt; is invalid.</span>
<span class="c">//        /// &lt;/exception&gt;</span>
<span class="c">//        public static GetHashResult GetHash(Stream content, TransactionalHashAlgorithm algorithmIdentifier)</span>
<span class="c">//        {</span>
<span class="c">//            return algorithmIdentifier switch</span>
<span class="c">//            {</span>
<span class="c">//                TransactionalHashAlgorithm.StorageCrc64 =&gt; new GetHashResult(</span>
<span class="c">//                    storageCrc64: ComputeHash(content, new NonCryptographicHashAlgorithmHasher(StorageCrc64NonCryptographicHashAlgorithm.Create()))),</span>
<span class="c">//#pragma warning disable CA5351 // Do Not Use Broken Cryptographic Algorithms; MD5 being used for content integrity check, not encryption</span>
<span class="c">//                TransactionalHashAlgorithm.MD5 =&gt; new GetHashResult(md5: ComputeHash(content, new HashAlgorithmHasher(MD5.Create()))),</span>
<span class="c">//#pragma warning restore CA5351 // Do Not Use Broken Cryptographic Algorithms</span>
<span class="c">//                _ =&gt; throw Errors.InvalidArgument(nameof(algorithmIdentifier))</span>
<span class="c">//            };</span>
<span class="c">//        }</span>
 
<span class="c">//        /// &lt;summary&gt;</span>
<span class="c">//        /// Computes the requested hash, if desired.</span>
<span class="c">//        /// &lt;/summary&gt;</span>
<span class="c">//        /// &lt;param name=&quot;content&quot;&gt;Content to hash.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;offset&quot;&gt;Starting offset of content array to compute with.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;count&quot;&gt;Numbert of bytes after offset to compute with.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;algorithmIdentifier&quot;&gt;Algorithm to compute the hash with.&lt;/param&gt;</span>
<span class="c">//        /// &lt;returns&gt;Object containing the requested hash, or no hash, on its algorithm&#39;s respective property.&lt;/returns&gt;</span>
<span class="c">//        /// &lt;exception cref=&quot;ArgumentException&quot;&gt;</span>
<span class="c">//        /// Throws if &lt;paramref name=&quot;algorithmIdentifier&quot;/&gt; is invalid.</span>
<span class="c">//        /// &lt;/exception&gt;</span>
<span class="c">//        public static GetHashResult GetHash(byte[] content, int offset, int count, TransactionalHashAlgorithm algorithmIdentifier)</span>
<span class="c">//        {</span>
<span class="c">//            byte[] computeHash(StorageCrc64NonCryptographicHashAlgorithm nonCryptographicHashAlgorithm)</span>
<span class="c">//            {</span>
<span class="c">//                nonCryptographicHashAlgorithm.Append(new ReadOnlySpan&lt;byte&gt;(content, offset, count));</span>
<span class="c">//                return nonCryptographicHashAlgorithm.GetCurrentHash();</span>
<span class="c">//            }</span>
 
<span class="c">//            return algorithmIdentifier switch</span>
<span class="c">//            {</span>
<span class="c">//                TransactionalHashAlgorithm.StorageCrc64 =&gt; new GetHashResult(</span>
<span class="c">//                    storageCrc64: computeHash(StorageCrc64NonCryptographicHashAlgorithm.Create())),</span>
<span class="c">//#pragma warning disable CA5351 // Do Not Use Broken Cryptographic Algorithms; MD5 being used for content integrity check, not encryption</span>
<span class="c">//                TransactionalHashAlgorithm.MD5 =&gt; new GetHashResult(md5: MD5.Create().ComputeHash(content, offset, count)),</span>
<span class="c">//#pragma warning restore CA5351 // Do Not Use Broken Cryptographic Algorithms</span>
<span class="c">//                _ =&gt; throw Errors.InvalidArgument(nameof(algorithmIdentifier))</span>
<span class="c">//            };</span>
<span class="c">//        }</span>
 
<span class="c">//        /// &lt;summary&gt;</span>
<span class="c">//        /// Compute hash on a stream and reset stream to original position.</span>
<span class="c">//        /// &lt;/summary&gt;</span>
<span class="c">//        /// &lt;param name=&quot;content&quot;&gt;Seekable stream to compute on.&lt;/param&gt;</span>
<span class="c">//        /// &lt;param name=&quot;hasher&quot;&gt;IHasher to compute with.&lt;/param&gt;</span>
<span class="c">//        /// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="c">//        private static byte[] ComputeHash(Stream content, IHasher hasher)</span>
<span class="c">//        {</span>
<span class="c">//            long startPosition = content.Position;</span>
<span class="c">//            byte[] hash = hasher.ComputeHash(content);</span>
<span class="c">//            content.Position = startPosition;</span>
<span class="c">//            return hash;</span>
<span class="c">//        }</span>
<span class="c">//    }</span>
<span class="c">//}</span>
</pre></td></tr></table></div></body></html>
