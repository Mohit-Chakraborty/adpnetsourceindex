<!DOCTYPE html>
<html><head><title>EventPerfTest.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(123);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Azure.Test.Perf/EventPerfTest.cs" target="_top">EventPerfTest.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/main/common/Perf/Azure.Test.Perf/EventPerfTest.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Azure.Test.Perf" target="_top">Azure.Test.Perf.csproj</a> (Azure.Test.Perf)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
 
<b>namespace</b> <span class="i n">Azure</span>.<span class="i n">Test</span>.<span class="i n">Perf</span>
{
    <b>public abstract class</b> <a id="43d1e337ad24116f" href="R/43d1e337ad24116f.html" target="n" data-glyph="0,0" class="t t">EventPerfTest</a>&lt;<span id="r0 rd t" class="r0 r t">TOptions</span>&gt; : <a href="PerfTestBase.cs.html#b59f6fbe1934db28" class="t t">PerfTestBase</a>&lt;<span class="r0 r t">TOptions</span>&gt; <b>where</b> <span class="r0 r t">TOptions</span> : <a href="PerfOptions.cs.html#57187bab792d1f66" class="t t">PerfOptions</a>
    {
        <b>private readonly</b> <a href="@0@System/A.html#ceb0ba9cc88de82e" class="t t">Stopwatch</a> <a id="12d268b967bcd3a0" href="R/12d268b967bcd3a0.html" target="n" data-glyph="46,1" class="i field">_stopwatch</a> = <b>new</b> <a href="@0@System/A.html#e0a8bcc83e66a717" class="t constructor">Stopwatch</a>();
 
        <b>private long</b> <a id="c21cbb3841f93eb9" href="R/c21cbb3841f93eb9.html" target="n" data-glyph="46,1" class="i field">_completedOperations</a>;
        <b>public sealed override long</b> <a id="5a55e93e8c8ea082" href="R/5a55e93e8c8ea082.html" target="n" data-glyph="102,1" class="i property">CompletedOperations</a> =&gt; <a href="#c21cbb3841f93eb9" class="i field">_completedOperations</a>;
 
        <b>public sealed override</b> <a href="@0@mscorlib/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>&gt; <a id="1c3e59c8e7c0635c" href="R/1c3e59c8e7c0635c.html" target="n" data-glyph="102,1" class="i property">Latencies</a> =&gt;
            <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">&quot;EventPerfTest does not support Latencies&quot;</span>);
 
        <b>public sealed override</b> <a href="@0@mscorlib/A.html#b19f71a84062554b" class="t t">IList</a>&lt;<a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>&gt; <a id="78eaee2cb014cd11" href="R/78eaee2cb014cd11.html" target="n" data-glyph="102,1" class="i property">CorrectedLatencies</a> =&gt;
            <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">&quot;EventPerfTest does not support CorrectedLatencies&quot;</span>);
 
        <b>private</b> <a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <a id="217a24af1752da11" href="R/217a24af1752da11.html" target="n" data-glyph="46,1" class="i field">_error</a>;
        <b>private</b> <a href="@0@mscorlib/A.html#130a9536ac96b392" class="t t">CancellationTokenSource</a> <a id="dbe95fb1eed0ebc4" href="R/dbe95fb1eed0ebc4.html" target="n" data-glyph="46,1" class="i field">_errorCancellationTokenSource</a> = <b>new</b> <a href="@0@mscorlib/A.html#0fd973cb6741d972" class="t constructor">CancellationTokenSource</a>();
 
        <b>public</b> <a id="2f71f4eb6d995b17" href="R/2f71f4eb6d995b17.html" target="n" data-glyph="72,1" class="t constructor">EventPerfTest</a>(<span class="r0 r t">TOptions</span> <span id="r1 rd" class="r1 r">options</span>) : <a href="PerfTestBase.cs.html#88f00ef86d3f92d0" class="k">base</a>(<span class="r1 r">options</span>)
        {
            <b>if</b> (<span class="r1 r">options</span>.<a href="PerfOptions.cs.html#c2cac7f1f4f0caea" class="i property">Latency</a>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">&quot;EventPerfTest does not support the &#39;--latency&#39; option&quot;</span>);
            }
 
            <b>if</b> (<span class="r1 r">options</span>.<a href="PerfOptions.cs.html#e3108864aff3c5d1" class="i property">Rate</a>.<a href="@0@mscorlib/A.html#7bbe60e33e857298" class="i property">HasValue</a>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#265d72f49e915224" class="t constructor">InvalidOperationException</a>(<span class="s">&quot;EventPerfTest does not support the &#39;--rate&#39; option&quot;</span>);
            }
        }
 
        <b>protected void</b> <a id="74d3e45d60ac31cc" href="R/74d3e45d60ac31cc.html" target="n" data-glyph="75,1" class="i method">EventRaised</a>()
        {
            <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#d379c1b796ccdc6f" class="i method">Increment</a>(<b>ref</b> <a href="#c21cbb3841f93eb9" class="i field">_completedOperations</a>);
            <a href="PerfTestBase.cs.html#848ac34b87198427" class="i property">LastCompletionTime</a> = <a href="#12d268b967bcd3a0" class="i field">_stopwatch</a>.<a href="@0@System/A.html#60e03fb80c10ec79" class="i property">Elapsed</a>;
        }
 
        <b>protected void</b> <a id="71af74cb8a88d83b" href="R/71af74cb8a88d83b.html" target="n" data-glyph="75,1" class="i method">ErrorRaised</a>(<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r2 rd" class="r2 r">e</span>)
        {
            <a href="#217a24af1752da11" class="i field">_error</a> = <span class="r2 r">e</span>;
            <a href="#dbe95fb1eed0ebc4" class="i field">_errorCancellationTokenSource</a>.<a href="@0@mscorlib/A.html#93c25ccd0946470f" class="i method">Cancel</a>();
        }
 
        <b>public sealed override</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="23e095bd0508dca5" href="R/23e095bd0508dca5.html" target="n" data-glyph="72,1" class="i method">PostSetupAsync</a>()
        {
            <b>return</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#66f1c3e3e272f591" class="i property">CompletedTask</a>;
        }
 
        <b>public sealed override void</b> <a id="eaa2832440ec7284" href="R/eaa2832440ec7284.html" target="n" data-glyph="72,1" class="i method">RunAll</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r3 rd" class="r3 r">cancellationToken</span>)
        {
            <a href="#9b75404fe168694a" class="i method">RunAllAsync</a>(<span class="r3 r">cancellationToken</span>).<a href="@0@mscorlib/A.html#1bfe9e19e44f4cfa" class="i method">Wait</a>();
        }
 
        <b>public sealed override async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="9b75404fe168694a" href="R/9b75404fe168694a.html" target="n" data-glyph="72,1" class="i method">RunAllAsync</a>(<a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a> <span id="r4 rd" class="r4 r">cancellationToken</span>)
        {
            <span class="c">// Must restart stopwatch before resetting LastCompletionTime, to avoid a race condition where an</span>
            <span class="c">// event would use the stopwatch from Warmup at the start of Run.  The results of Warmup have already</span>
            <span class="c">// been printed, so the reverse race condition is not a problem.</span>
            <a href="#12d268b967bcd3a0" class="i field">_stopwatch</a>.<a href="@0@System/A.html#4e1c3f2724f4da74" class="i method">Restart</a>();
 
            <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#b4eb06f8a279b2f2" class="i method">Exchange</a>(<b>ref</b> <a href="#c21cbb3841f93eb9" class="i field">_completedOperations</a>, 0);
            <a href="PerfTestBase.cs.html#848ac34b87198427" class="i property">LastCompletionTime</a> = <b>default</b>;
 
            <span class="c">// Cancel when requested by perf framework or when ErrorRaised() is called</span>
            <b>using</b> (<a href="@0@mscorlib/A.html#130a9536ac96b392" class="k">var</a> <span id="r5 rd" class="r5 r">cts</span> = <a href="@0@mscorlib/A.html#130a9536ac96b392" class="t t">CancellationTokenSource</a>.<a href="@0@mscorlib/A.html#03f4ba87373778ca" class="i method">CreateLinkedTokenSource</a>(<span class="r4 r">cancellationToken</span>, <a href="#dbe95fb1eed0ebc4" class="i field">_errorCancellationTokenSource</a>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>))
            {
                <b>try</b>
                {
                    <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#b070ae859dd3f7b7" class="i method">Delay</a>(<a href="@0@mscorlib/A.html#6b53654d3452a8df" class="t t">Timeout</a>.<a href="@0@mscorlib/A.html#c679290f50556e4e" class="i field">InfiniteTimeSpan</a>, <span class="r5 r">cts</span>.<a href="@0@mscorlib/A.html#9e22b9c8995bf195" class="i property">Token</a>);
                }
                <b>catch</b> (<a href="@0@mscorlib/A.html#30edb7a318d221fa" class="t t">TaskCanceledException</a>)
                {
                    <b>if</b> (<a href="#217a24af1752da11" class="i field">_error</a> != <b>null</b>)
                    {
                        <b>throw</b> <a href="#217a24af1752da11" class="i field">_error</a>;
                    }
                }
            }
        }
 
        <b>public sealed override</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="473055729f2359fd" href="R/473055729f2359fd.html" target="n" data-glyph="72,1" class="i method">PreCleanupAsync</a>()
        {
            <b>return</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#66f1c3e3e272f591" class="i property">CompletedTask</a>;
        }
 
        <span class="c">// https://docs.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-disposeasync#implement-both-dispose-and-async-dispose-patterns</span>
        <b>public override void</b> <a id="4b542dc10ce35713" href="R/4b542dc10ce35713.html" target="n" data-glyph="72,1" class="i method">Dispose</a>(<b>bool</b> <span id="r6 rd" class="r6 r">disposing</span>)
        {
            <b>if</b> (<span class="r6 r">disposing</span>)
            {
                <a href="#dbe95fb1eed0ebc4" class="i field">_errorCancellationTokenSource</a>?.<a href="@0@mscorlib/A.html#d6974e1b9b86299d" class="i method">Dispose</a>();
            }
            <a href="#dbe95fb1eed0ebc4" class="i field">_errorCancellationTokenSource</a> = <b>null</b>;
 
            <a href="PerfTestBase.cs.html#b59f6fbe1934db28" class="k">base</a>.<a href="PerfTestBase.cs.html#8e400d7d9ac3d219" class="i method">Dispose</a>(<span class="r6 r">disposing</span>);
        }
 
        <b>public override async</b> <span class="t t">ValueTask</span> <a id="58072cd6bda9e5f0" href="R/58072cd6bda9e5f0.html" target="n" data-glyph="72,1" class="i method">DisposeAsyncCore</a>()
        {
            <b>if</b> (<a href="#dbe95fb1eed0ebc4" class="i field">_errorCancellationTokenSource</a> <b>is</b> <span class="t t">IAsyncDisposable</span> <span id="r7 rd" class="r7 r">disposable</span>)
            {
                <b>await</b> <span class="r7 r">disposable</span>.<span class="i method">DisposeAsync</span>().<span class="i method">ConfigureAwait</span>(<b>false</b>);
            }
            <b>else</b>
            {
                <a href="#dbe95fb1eed0ebc4" class="i field">_errorCancellationTokenSource</a>?.<a href="@0@mscorlib/A.html#d6974e1b9b86299d" class="i method">Dispose</a>();
            }
            <a href="#dbe95fb1eed0ebc4" class="i field">_errorCancellationTokenSource</a> = <b>null</b>;
 
            <b>await</b> <a href="PerfTestBase.cs.html#b59f6fbe1934db28" class="k">base</a>.<a href="PerfTestBase.cs.html#2950e8dec80a3e01" class="i method">DisposeAsyncCore</a>();
        }
    }
}
</pre></td></tr></table></div></body></html>
