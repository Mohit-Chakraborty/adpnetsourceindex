<!DOCTYPE html>
<html><head><title>AddTasksWorkflowManager.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(474);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.Azure.Batch/AddTasksWorkflowManager.cs" target="_top">AddTasksWorkflowManager.cs</a><br/></td><td><a class="blueLink" href="https://github.com/Azure/azure-sdk-for-net/tree/master/sdk/batch/Microsoft.Azure.Batch/src/AddTasksWorkflowManager.cs" target="_blank">View on GitHub</a></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.Azure.Batch" target="_top">Microsoft.Azure.Batch.csproj</a> (Microsoft.Azure.Batch)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c">// Licensed under the MIT License. See License.txt in the project root for license information.</span>
 
﻿<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>
{
    <b>using</b> <span class="i n">System</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Concurrent</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Globalization</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
    <b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>.<span class="i n">FileStaging</span>;
    <b>using</b> <span class="i">Models</span> = <span class="i n">Microsoft</span>.<span class="i n">Azure</span>.<span class="i n">Batch</span>.<span class="i n">Protocol</span>.<span class="i n">Models</span>;
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Manages the AddTasks workflow, performs multiple CloudTaskAdd requests, and handles retries/exception handling.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="e7d21a279e77c6b3" href="R/e7d21a279e77c6b3.html" target="n" data-glyph="2,0" class="t t">AddTasksWorkflowManager</a>
    {
        <b>private readonly</b> <a href="JobOperations.cs.html#dd44f2346717d078" class="t t">JobOperations</a> <a id="580e7873cef26f1e" href="R/580e7873cef26f1e.html" target="n" data-glyph="46,1" class="i field">_jobOperations</a>;
        <b>private readonly string</b> <a id="7144e501bd646d30" href="R/7144e501bd646d30.html" target="n" data-glyph="46,1" class="i field">_jobId</a>;
        <b>private readonly</b> <a href="@0@mscorlib/A.html#18bcbcbdddbcfdcb" class="t t">ConcurrentQueue</a>&lt;<a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a>&gt; <a id="ce05ac96885eb08e" href="R/ce05ac96885eb08e.html" target="n" data-glyph="46,1" class="i field">_remainingTasksToAdd</a>;
        <b>private readonly</b> <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="@0@mscorlib/A.html#8adbe0476ca899db" class="t t">Func</a>&lt;<a href="P/38c50443aea1fd00.html#38c50443aea1fd00" class="t t">AddTaskResult</a>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>, <a href="AddTaskResult.cs.html#0b0ba3e28616259a" class="t t">AddTaskResultStatus</a>&gt;&gt; <a id="914642d39578de77" href="R/914642d39578de77.html" target="n" data-glyph="46,1" class="i field">_addTaskResultHandlerCollection</a>;
        <b>private readonly</b> <a href="BatchClientParallelOptions.cs.html#f03abc8c46c2be74" class="t t">BatchClientParallelOptions</a> <a id="78575d33c8f07572" href="R/78575d33c8f07572.html" target="n" data-glyph="46,1" class="i field">_parallelOptions</a>;
        <b>private readonly</b> <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <a id="ec57c8e60ba777e8" href="R/ec57c8e60ba777e8.html" target="n" data-glyph="46,1" class="i field">_pendingAsyncOperations</a>;
        <b>private readonly</b> <a href="@0@System/A.html#2b70243adbcbdb40" class="t t">ConcurrentBag</a>&lt;<a href="@0@mscorlib/A.html#2e5ef5704344a309" class="t t">ConcurrentDictionary</a>&lt;<a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a>, <a href="IFileStagingArtifact.cs.html#e009380314179236" class="t t">IFileStagingArtifact</a>&gt;&gt; <a id="e262d79eab36887c" href="R/e262d79eab36887c.html" target="n" data-glyph="46,1" class="i field">_customerVisibleFileStagingArtifacts</a>;
        <b>private readonly</b> <a href="BehaviorManager.cs.html#e4e15696c391247e" class="t t">BehaviorManager</a> <a id="c359706ca39af5f3" href="R/c359706ca39af5f3.html" target="n" data-glyph="46,1" class="i field">_behaviorManager</a>;
        <b>private</b> <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a> <a id="a78cb93ce5029f5e" href="R/a78cb93ce5029f5e.html" target="n" data-glyph="46,1" class="i field">_timeToTimeoutAt</a>;
        <b>private int</b> <a id="6ddb304d24769a30" href="R/6ddb304d24769a30.html" target="n" data-glyph="46,1" class="i field">_hasRun</a>; <span class="c">//Have to use an int because CompareExchange doesn&#39;t support bool</span>
        <b>private int</b> <a id="451c5b8eb49ff025" href="R/451c5b8eb49ff025.html" target="n" data-glyph="46,1" class="i field">_maxTasks</a>;
 
        <b>private const int</b> <a id="a7d831278df1f54d" href="R/a7d831278df1f54d.html" target="n" data-glyph="10,1" class="i field">HasNotRun</a> = 0;
        <b>private const int</b> <a id="b3fbd196f5ba6850" href="R/b3fbd196f5ba6850.html" target="n" data-glyph="10,1" class="i field">HasRun</a> = 1;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates the AddTasks workflow manager with the specified arguments.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">jobOperations</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">jobId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">parallelOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The parallel options associated with this operation.  If this is null, the default is used.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">fileStagingArtifacts</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">File staging artifacts associated with this operation.  If the customer does not set this, it is unviewable by them.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">bhMgr</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The behavior manager.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="d95e2145f519ace1" href="R/d95e2145f519ace1.html" target="n" data-glyph="74,1" class="t constructor">AddTasksWorkflowManager</a>(
            <a href="JobOperations.cs.html#dd44f2346717d078" class="t t">JobOperations</a> <span id="r0 rd" class="r0 r">jobOperations</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r1 rd" class="r1 r">jobId</span>,
            <a href="BatchClientParallelOptions.cs.html#f03abc8c46c2be74" class="t t">BatchClientParallelOptions</a> <span id="r2 rd" class="r2 r">parallelOptions</span>,
            <a href="@0@System/A.html#2b70243adbcbdb40" class="t t">ConcurrentBag</a>&lt;<a href="@0@mscorlib/A.html#2e5ef5704344a309" class="t t">ConcurrentDictionary</a>&lt;<a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a>, <a href="IFileStagingArtifact.cs.html#e009380314179236" class="t t">IFileStagingArtifact</a>&gt;&gt; <span id="r3 rd" class="r3 r">fileStagingArtifacts</span>,
            <a href="BehaviorManager.cs.html#e4e15696c391247e" class="t t">BehaviorManager</a> <span id="r4 rd" class="r4 r">bhMgr</span>)
        {
            <span class="c">//</span>
            <span class="c">// Setup some defaults for the parameters if they were null</span>
            <span class="c">//</span>
            <b>if</b> (<span class="r2 r">parallelOptions</span> == <b>null</b>)
            {
                <span class="r2 r">parallelOptions</span> = <b>new</b> <a href="BatchClientParallelOptions.cs.html#fce217a90920f1c0" class="t constructor">BatchClientParallelOptions</a>();
            }
 
            <span class="c">//</span>
            <span class="c">// Set up the data structures associated with this workflow</span>
            <span class="c">//</span>
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#580e7873cef26f1e" class="i field">_jobOperations</a> = <span class="r0 r">jobOperations</span>;
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#7144e501bd646d30" class="i field">_jobId</a> = <span class="r1 r">jobId</span>;
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ce05ac96885eb08e" class="i field">_remainingTasksToAdd</a> = <b>new</b> <a href="@0@mscorlib/A.html#a773570b1b021cff" class="t constructor">ConcurrentQueue</a>&lt;<a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a>&gt;();
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#914642d39578de77" class="i field">_addTaskResultHandlerCollection</a> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="@0@mscorlib/A.html#8adbe0476ca899db" class="t t">Func</a>&lt;<a href="P/38c50443aea1fd00.html#38c50443aea1fd00" class="t t">AddTaskResult</a>, <a href="@0@mscorlib/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>, <a href="AddTaskResult.cs.html#0b0ba3e28616259a" class="t t">AddTaskResultStatus</a>&gt;&gt;();
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#78575d33c8f07572" class="i field">_parallelOptions</a> = <span class="r2 r">parallelOptions</span>;
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ec57c8e60ba777e8" class="i field">_pendingAsyncOperations</a> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt;();
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#e262d79eab36887c" class="i field">_customerVisibleFileStagingArtifacts</a> = <span class="r3 r">fileStagingArtifacts</span> ?? <b>new</b> <a href="@0@System/A.html#d7c19e4f8f3adffb" class="t constructor">ConcurrentBag</a>&lt;<a href="@0@mscorlib/A.html#2e5ef5704344a309" class="t t">ConcurrentDictionary</a>&lt;<a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a>, <a href="IFileStagingArtifact.cs.html#e009380314179236" class="t t">IFileStagingArtifact</a>&gt;&gt;();
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#c359706ca39af5f3" class="i field">_behaviorManager</a> = <span class="r4 r">bhMgr</span>;
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#451c5b8eb49ff025" class="i field">_maxTasks</a> = <a href="Constants.cs.html#9295672bd7b4088f" class="t t">Constants</a>.<a href="Constants.cs.html#2db8444c043c729e" class="i field">MaxTasksInSingleAddTaskCollectionRequest</a>;
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#6ddb304d24769a30" class="i field">_hasRun</a> = <a href="#a7d831278df1f54d" class="i field">HasNotRun</a>; <span class="c">//Has not run by default</span>
 
            <span class="c">//Read the behavior manager and populate the collection</span>
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="AddTaskCollectionResultHandler.cs.html#0d78c7f1d11cd6c0" class="t t">AddTaskCollectionResultHandler</a>&gt; <span id="r5 rd" class="r5 r">behaviorList</span> = <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#c359706ca39af5f3" class="i field">_behaviorManager</a>.<a href="BehaviorManager.cs.html#094744946fccac98" class="i method">GetBehaviors</a>&lt;<a href="AddTaskCollectionResultHandler.cs.html#0d78c7f1d11cd6c0" class="t t">AddTaskCollectionResultHandler</a>&gt;();
            <b>foreach</b> (<a href="AddTaskCollectionResultHandler.cs.html#0d78c7f1d11cd6c0" class="t t">AddTaskCollectionResultHandler</a> <span id="r6 rd" class="r6 r">handler</span> <b>in</b> <span class="r5 r">behaviorList</span>)
            {
                <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#914642d39578de77" class="i field">_addTaskResultHandlerCollection</a>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r6 r">handler</span>.<a href="AddTaskCollectionResultHandler.cs.html#6e2842401efa99d2" class="i property">ResultHandler</a>);
            }
 
            <span class="c">//Validation that there is a handler for AddTaskResult</span>
            <b>if</b> (<a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#914642d39578de77" class="i field">_addTaskResultHandlerCollection</a>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a> == 0)
            {
                <b>throw</b> <b>new</b> <a href="BatchClientExceptions.cs.html#b639393f4ea24857" class="t constructor">BatchClientException</a>(
                    <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#691a34e179b91fdb" class="i method">Format</a>(<a href="@0@mscorlib/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@0@mscorlib/A.html#26ef1c020f0dbb7a" class="i property">InvariantCulture</a>, <a href="BatchErrorMessages.Designer.cs.html#3c2fda6d707d8e3d" class="t t">BatchErrorMessages</a>.<a href="BatchErrorMessages.Designer.cs.html#df5433cbf1e69e98" class="i property">GeneralBehaviorMissing</a>, <b>typeof</b>(<a href="AddTaskCollectionResultHandler.cs.html#0d78c7f1d11cd6c0" class="t t">AddTaskCollectionResultHandler</a>)));
            }
        }
 
<span class="k preprocess">#</span><span class="k preprocess">region</span> Public methods
 
        <b>public async</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>.<a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="50cabc267b13a786" href="R/50cabc267b13a786.html" target="n" data-glyph="72,1" class="i method">AddTasksAsync</a>(<a href="@0@mscorlib/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="P/eeca8189f6dd1bc1.html#eeca8189f6dd1bc1" class="t t">CloudTask</a>&gt; <span id="r7 rd" class="r7 r">tasksToAdd</span>, <a href="@0@mscorlib/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>? <span id="r8 rd" class="r8 r">timeout</span> = <b>null</b>)
        {
            <span class="c">//Ensure that this object has not already been used</span>
            <b>int</b> <span id="r9 rd" class="r9 r">original</span> = <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#1e337a3aaaf240e4" class="i method">CompareExchange</a>(<b>ref</b> <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#6ddb304d24769a30" class="i field">_hasRun</a>, <a href="#b3fbd196f5ba6850" class="i field">HasRun</a>, <a href="#a7d831278df1f54d" class="i field">HasNotRun</a>);
 
            <b>if</b> (<span class="r9 r">original</span> != <a href="#a7d831278df1f54d" class="i field">HasNotRun</a>)
            {
                <b>throw</b> <b>new</b> <a href="BatchClientExceptions.cs.html#cf851028a1ce5bb8" class="t constructor">RunOnceException</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>.<a href="@0@mscorlib/A.html#691a34e179b91fdb" class="i method">Format</a>(<a href="@0@mscorlib/A.html#e319c6636909012f" class="t t">CultureInfo</a>.<a href="@0@mscorlib/A.html#26ef1c020f0dbb7a" class="i property">InvariantCulture</a>, <a href="BatchErrorMessages.Designer.cs.html#3c2fda6d707d8e3d" class="t t">BatchErrorMessages</a>.<a href="BatchErrorMessages.Designer.cs.html#7d074d258cbd962c" class="i property">CanOnlyBeRunOnceFailure</a>, <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="@0@mscorlib/A.html#4d73eb225aef8a61" class="i method">GetType</a>().<a href="@0@mscorlib/A.html#aa4f112f79364b6e" class="i property">Name</a>));
            }
 
            <span class="c">//Determine what time to timeout at</span>
            <b>if</b> (<span class="r8 r">timeout</span> != <b>null</b>)
            {
                <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#a78cb93ce5029f5e" class="i field">_timeToTimeoutAt</a> = <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#b0d5e4c9a8d4ddac" class="i property">UtcNow</a> + <span class="r8 r">timeout</span>.<a href="@0@mscorlib/A.html#7b38d1fa76071c95" class="i property">Value</a>;
            }
            <b>else</b>
            {
                <span class="c">//TODO: We set this to max value -- maybe in the future we can be a bit more friendly to customers and not run forever</span>
                <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#a78cb93ce5029f5e" class="i field">_timeToTimeoutAt</a> = <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#e5d13395e833fbb8" class="i field">MaxValue</a>;
            }
 
            <span class="c">//</span>
            <span class="c">// Collect the tasks and add them to the pending queue</span>
            <span class="c">//</span>
            <span class="c">//TODO: There is a tension between allowing lazy enumeration of tasksToAdd and performing any validation on tasksToAdd early in the addition process</span>
            <span class="c">//TODO: For now (since most customer implementations are not going to write their own lazy collection) we go ahead and perform</span>
            <span class="c">//TODO: some input validation...</span>
 
            <span class="c">//</span>
            <span class="c">// Perform some basic input validation</span>
            <span class="c">//</span>
            <span class="c">//TODO: Check no duplicate task names?</span>
            <span class="c">//TODO: Check the tasks are not children of some other object already</span>
 
            <span class="c">//Enumerate the supplied collection asynchronously if required</span>
            <span class="r7 r">tasksToAdd</span> = <b>await</b> <a href="UtilitiesInternal.cs.html#75d406733ca3f619" class="t t">UtilitiesInternal</a>.<a href="UtilitiesInternal.cs.html#088abbcf2618839d" class="i method">EnumerateIfNeededAsync</a>(<span class="r7 r">tasksToAdd</span>, <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#78575d33c8f07572" class="i field">_parallelOptions</a>.<a href="BatchClientParallelOptions.cs.html#56f3b3c96d0cb9ca" class="i property">CancellationToken</a>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<b>false</b>);
 
            <span class="c">//TODO: For now perform a copy into a queue -- in the future consider honoring lazy loading and do this later</span>
            <b>foreach</b> (<a href="P/eeca8189f6dd1bc1.html#eeca8189f6dd1bc1" class="t t">CloudTask</a> <span id="r10 rd" class="r10 r">cloudTask</span> <b>in</b> <span class="r7 r">tasksToAdd</span>)
            {
                <b>if</b> (<span class="r10 r">cloudTask</span> == <b>null</b>)
                {
                    <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#b50c77b2acc23eca" class="t constructor">ArgumentNullException</a>(<b>nameof</b>(<span class="r7 r">tasksToAdd</span>), <a href="BatchErrorMessages.Designer.cs.html#3c2fda6d707d8e3d" class="t t">BatchErrorMessages</a>.<a href="BatchErrorMessages.Designer.cs.html#513991ce08c838f5" class="i property">CollectionMustNotContainNull</a>);
                }
 
                <b>if</b> (<span class="r10 r">cloudTask</span>.<a href="CloudTask.cs.html#3f152c16696d1699" class="i property">BindingState</a> == <a href="BindingState.cs.html#8e9f6d0db7ea871e" class="t t">BindingState</a>.<a href="BindingState.cs.html#2a04aec578a32dc4" class="i field">Bound</a>)
                {
                    <b>throw</b> <a href="UtilitiesInternal.cs.html#75d406733ca3f619" class="t t">UtilitiesInternal</a>.<a href="UtilitiesInternal.cs.html#366ebbba9b956c95" class="i property">OperationForbiddenOnBoundObjects</a>;
                }
 
                <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ce05ac96885eb08e" class="i field">_remainingTasksToAdd</a>.<a href="@0@mscorlib/A.html#62bea3a8141ed2a9" class="i method">Enqueue</a>(<b>new</b> <a href="#286d6f62f6c5480d" class="t constructor">TrackedCloudTask</a>(<a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#7144e501bd646d30" class="i field">_jobId</a>, <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#580e7873cef26f1e" class="i field">_jobOperations</a>, <span class="r10 r">cloudTask</span>));
            }
 
            <span class="c">//</span>
            <span class="c">// Fire the requests</span>
            <span class="c">//</span>
            <b>while</b> (!<a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#d66b82f34ba985f9" class="i method">IsWorkflowDone</a>())
            {
                <span class="c">//Wait for an open request &quot;slot&quot; (an existing request to complete) if:</span>
                <span class="c">//1. We have no free request slots</span>
                <span class="c">//2. We have no more tasks to add and there are ongoing pending operations which could result in task add retries (causing us to get more tasks to add)</span>
                <b>bool</b> <span id="r11 rd" class="r11 r">noFreeSlots</span> = <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ec57c8e60ba777e8" class="i field">_pendingAsyncOperations</a>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a> &gt;= <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#78575d33c8f07572" class="i field">_parallelOptions</a>.<a href="BatchClientParallelOptions.cs.html#5129461b7e92cd48" class="i property">MaxDegreeOfParallelism</a>;
                <b>bool</b> <span id="r12 rd" class="r12 r">noTasksToAddButSomePendingLegsRemain</span> = <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ce05ac96885eb08e" class="i field">_remainingTasksToAdd</a>.<a href="@0@mscorlib/A.html#bb6c4718727537aa" class="i property">IsEmpty</a> &amp;&amp; <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ec57c8e60ba777e8" class="i field">_pendingAsyncOperations</a>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a> &gt; 0;
                <b>if</b> (<span class="r11 r">noFreeSlots</span> || <span class="r12 r">noTasksToAddButSomePendingLegsRemain</span>)
                {
                    <b>await</b> <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#be9cb53fcd07bf34" class="i method">ProcessPendingOperationResults</a>().<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<span class="r13 r">continueOnCapturedContext</span>: <b>false</b>);
                }
 
                <span class="c">//If we get here, we are starting a single new leg.  Another iteration of this loop will get to any tasks which do not fit in this leg.</span>
 
                <span class="c">//Add any tasks (up to max count in 1 request) which are remaining since we have an open parallel slot</span>
                <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a>&gt; <span id="r14 rd" class="r14 r">nameToTaskMapping</span> = <b>new</b> <a href="@0@mscorlib/A.html#bf6849e410b43c4c" class="t constructor">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a>&gt;();
 
                <span class="c">//Attempt to take some items from the set of tasks remaining to be added and prepare it to be added</span>
                <b>int</b> <span id="r15 rd" class="r15 r">tmpMaxTasks</span> = <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#451c5b8eb49ff025" class="i field">_maxTasks</a>;
                <b>while</b> (<span class="r14 r">nameToTaskMapping</span>.<a href="@0@mscorlib/A.html#12b9bba2a1f9c3e2" class="i property">Count</a> &lt; <span class="r15 r">tmpMaxTasks</span> &amp;&amp; <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ce05ac96885eb08e" class="i field">_remainingTasksToAdd</a>.<a href="@0@mscorlib/A.html#88b9f17c9182267f" class="i method">TryDequeue</a>(<b>out</b> <a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a> <span id="r16 rd" class="r16 r">taskToAdd</span>))
                {
                    <span class="r14 r">nameToTaskMapping</span>.<a href="@0@mscorlib/A.html#a7861da7aaa500fe" class="i method">Add</a>(<span class="r16 r">taskToAdd</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="Generated/CloudTask.cs.html#04f2bca9eac7b359" class="i property">Id</a>, <span class="r16 r">taskToAdd</span>);
                }
 
                <b>if</b> (<span class="r14 r">nameToTaskMapping</span>.<a href="@0@mscorlib/A.html#12b9bba2a1f9c3e2" class="i property">Count</a> &gt; 0)
                {
                    <span class="c">//Start the async operation to stage the files (if required) and issue the protocol add task request</span>
                    <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <span id="r17 rd" class="r17 r">asyncTask</span> = <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#89820514be6b10bc" class="i method">StageFilesAndAddTasks</a>(
                        <span class="r14 r">nameToTaskMapping</span>,
                        <b>null</b>);
 
                    <span class="c">//Add the request to the operation tracker</span>
                    <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ec57c8e60ba777e8" class="i field">_pendingAsyncOperations</a>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r17 r">asyncTask</span>);
                }
            }
 
            <span class="c">//If we reach here, we have succeeded - yay!</span>
        }
 
<span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
<span class="k preprocess">#</span><span class="k preprocess">region</span> Private methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Checks for operation cancelation or timeout, and throws the corresponding exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="1144e67a6ef818ce" href="R/1144e67a6ef818ce.html" target="n" data-glyph="76,1" class="i method">CheckForCancellationOrTimeoutAndThrow</a>()
        {
            <span class="c">//We always throw when cancelation is requested</span>
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#78575d33c8f07572" class="i field">_parallelOptions</a>.<a href="BatchClientParallelOptions.cs.html#56f3b3c96d0cb9ca" class="i property">CancellationToken</a>.<a href="@0@mscorlib/A.html#d2864d73804288fc" class="i method">ThrowIfCancellationRequested</a>();
 
 
            <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a> <span id="r18 rd" class="r18 r">currentTime</span> = <a href="@0@mscorlib/A.html#df6b1eba7461813b" class="t t">DateTime</a>.<a href="@0@mscorlib/A.html#b0d5e4c9a8d4ddac" class="i property">UtcNow</a>;
 
            <b>if</b> (<span class="r18 r">currentTime</span> &gt; <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#a78cb93ce5029f5e" class="i field">_timeToTimeoutAt</a>)
            {
                <b>throw</b> <b>new</b> <a href="@0@mscorlib/A.html#59c9457789637923" class="t constructor">TimeoutException</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the workflow has finished or not.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if the workflow has successfully completed, false if it has not.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="d66b82f34ba985f9" href="R/d66b82f34ba985f9.html" target="n" data-glyph="76,1" class="i method">IsWorkflowDone</a>()
        {
            <b>return</b> !(!<a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ce05ac96885eb08e" class="i field">_remainingTasksToAdd</a>.<a href="@0@mscorlib/A.html#bb6c4718727537aa" class="i property">IsEmpty</a> || <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ec57c8e60ba777e8" class="i field">_pendingAsyncOperations</a>.<a href="@0@mscorlib/A.html#78a69d857716bc68" class="i property">Count</a> &gt; 0);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Performs file staging and also issues the AddTaskCollection request for the set of tasks to add.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">tasksToAdd</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The set of tasks to add.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">namingFragment</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="89820514be6b10bc" href="R/89820514be6b10bc.html" target="n" data-glyph="76,1" class="i method">StageFilesAndAddTasks</a>(
            <a href="@0@mscorlib/A.html#d3599058f8d79be0" class="t t">Dictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a>&gt; <span id="r19 rd" class="r19 r">tasksToAdd</span>,
            <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r20 rd" class="r20 r">namingFragment</span>)
        {
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<span class="i n">Models</span>.<a href="GeneratedProtocol/Models/TaskAddParameter.cs.html#523f661c1fddbf10" class="t t">TaskAddParameter</a>&gt; <span id="r21 rd" class="r21 r">protoTasksToAdd</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<span class="i n">Models</span>.<a href="GeneratedProtocol/Models/TaskAddParameter.cs.html#523f661c1fddbf10" class="t t">TaskAddParameter</a>&gt;();
 
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#1144e67a6ef818ce" class="i method">CheckForCancellationOrTimeoutAndThrow</a>();
 
            <span class="c">//</span>
            <span class="c">// Perform file staging</span>
            <span class="c">//</span>
 
            <span class="c">// list of all files to be staged across all Tasks</span>
            <a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="FileStaging/IFileStagingProvider.cs.html#a1e33437d516696b" class="t t">IFileStagingProvider</a>&gt; <span id="r22 rd" class="r22 r">allFiles</span> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="FileStaging/IFileStagingProvider.cs.html#a1e33437d516696b" class="t t">IFileStagingProvider</a>&gt;();
 
            <span class="c">// collect all files to be staged</span>
            <b>foreach</b> (<a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a> <span id="r23 rd" class="r23 r">trackedCloudTask</span> <b>in</b> <span class="r19 r">tasksToAdd</span>.<a href="@0@mscorlib/A.html#4367dd1e300ae797" class="i property">Values</a>)
            {
                <b>if</b> (<span class="r23 r">trackedCloudTask</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="Generated/CloudTask.cs.html#d624cff35ee00815" class="i property">FilesToStage</a> != <b>null</b>)
                {
                    <span class="c">// add in the files for the current task</span>
                    <span class="r22 r">allFiles</span>.<a href="@0@mscorlib/A.html#e569d850a66a1771" class="i method">AddRange</a>(<span class="r23 r">trackedCloudTask</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="Generated/CloudTask.cs.html#d624cff35ee00815" class="i property">FilesToStage</a>);
                }
            }
 
            <span class="c">//This dictonary is only for the purpose of this batch add</span>
            <a href="@0@mscorlib/A.html#2e5ef5704344a309" class="t t">ConcurrentDictionary</a>&lt;<a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a>, <a href="IFileStagingArtifact.cs.html#e009380314179236" class="t t">IFileStagingArtifact</a>&gt; <span id="r24 rd" class="r24 r">legStagingArtifacts</span> = <b>new</b> <a href="@0@mscorlib/A.html#abc35f3c19fa0290" class="t constructor">ConcurrentDictionary</a>&lt;<a href="@0@mscorlib/A.html#3d00eeab9feb80f3" class="t t">Type</a>, <a href="IFileStagingArtifact.cs.html#e009380314179236" class="t t">IFileStagingArtifact</a>&gt;();
 
            <span class="c">//Add the file staging artifacts for this let to the overall bag so as to allow customers to track the file staging progress</span>
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#e262d79eab36887c" class="i field">_customerVisibleFileStagingArtifacts</a>.<a href="@0@System/A.html#ef482ba238e37447" class="i method">Add</a>(<span class="r24 r">legStagingArtifacts</span>);
 
            <span class="c">// now we have all files, send off to file staging machine</span>
            <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>.<a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <span id="r25 rd" class="r25 r">fileStagingTask</span> = <a href="FileStaging/FileStagingUtils.cs.html#7e5a513531ef59e4" class="t t">FileStagingUtils</a>.<a href="FileStaging/FileStagingUtils.cs.html#3871c11d9449918f" class="i method">StageFilesAsync</a>(<span class="r22 r">allFiles</span>, <span class="r24 r">legStagingArtifacts</span>, <span class="r20 r">namingFragment</span>);
 
            <span class="c">// wait for file staging async task</span>
            <b>await</b> <span class="r25 r">fileStagingTask</span>.<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<span class="r13 r">continueOnCapturedContext</span>: <b>false</b>);
 
            <span class="c">// now update each non-finalized Task with its new ResourceFiles</span>
            <b>foreach</b> (<a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a> <span id="r26 rd" class="r26 r">taskToAdd</span> <b>in</b> <span class="r19 r">tasksToAdd</span>.<a href="@0@mscorlib/A.html#4367dd1e300ae797" class="i property">Values</a>)
            {
                <span class="c">//Update the resource files if the task hasn&#39;t already been finalized</span>
                <b>if</b> (<span class="r26 r">taskToAdd</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="Generated/CloudTask.cs.html#d624cff35ee00815" class="i property">FilesToStage</a> != <b>null</b>)
                {
                    <b>foreach</b> (<a href="FileStaging/IFileStagingProvider.cs.html#a1e33437d516696b" class="t t">IFileStagingProvider</a> <span id="r27 rd" class="r27 r">curFile</span> <b>in</b> <span class="r26 r">taskToAdd</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="Generated/CloudTask.cs.html#d624cff35ee00815" class="i property">FilesToStage</a>)
                    {
                        <a href="@0@mscorlib/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="P/2b9679370e5dc8dd.html#2b9679370e5dc8dd" class="t t">ResourceFile</a>&gt; <span id="r28 rd" class="r28 r">curStagedFiles</span> = <span class="r27 r">curFile</span>.<a href="FileStaging/IFileStagingProvider.cs.html#75ece8fc9407ceef" class="i property">StagedFiles</a>;
 
                        <b>if</b> (<b>null</b> != <span class="r28 r">curStagedFiles</span> &amp;&amp; !((<a href="IReadOnly.cs.html#aae680cc036f41fa" class="t t">IReadOnly</a>)<span class="r26 r">taskToAdd</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>).<a href="IReadOnly.cs.html#8c3b8447278b82fc" class="i property">IsReadOnly</a>)
                        {
                            <span class="c">//TODO: There is a threading issue here -- lock this property down somehow?</span>
                            <b>if</b> (<span class="r26 r">taskToAdd</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="Generated/CloudTask.cs.html#b42e5eabd845ed9f" class="i property">ResourceFiles</a> == <b>null</b>)
                            {
                                <span class="r26 r">taskToAdd</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="Generated/CloudTask.cs.html#b42e5eabd845ed9f" class="i property">ResourceFiles</a> = <b>new</b> <a href="@0@mscorlib/A.html#9e5352b2b304ceba" class="t constructor">List</a>&lt;<a href="P/2b9679370e5dc8dd.html#2b9679370e5dc8dd" class="t t">ResourceFile</a>&gt;();
                            }
 
                            <b>foreach</b> (<a href="P/2b9679370e5dc8dd.html#2b9679370e5dc8dd" class="t t">ResourceFile</a> <span id="r29 rd" class="r29 r">curStagedFile</span> <b>in</b> <span class="r28 r">curStagedFiles</span>)
                            {
                                <span class="r26 r">taskToAdd</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="Generated/CloudTask.cs.html#b42e5eabd845ed9f" class="i property">ResourceFiles</a>.<a href="@0@mscorlib/A.html#a9319db8c62ae453" class="i method">Add</a>(<span class="r29 r">curStagedFile</span>);
                            }
                        }
                    }
 
                    <span class="c">//Mark the file staging collection as read only just incase there&#39;s another reference to it</span>
                    <a href="ConcurrentChangeTrackedList.cs.html#8f0d85d2a99c872c" class="t t">ConcurrentChangeTrackedList</a>&lt;<a href="FileStaging/IFileStagingProvider.cs.html#a1e33437d516696b" class="t t">IFileStagingProvider</a>&gt; <span id="r30 rd" class="r30 r">filesToStageListImpl</span> =
                        <span class="r26 r">taskToAdd</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="Generated/CloudTask.cs.html#d624cff35ee00815" class="i property">FilesToStage</a> <b>as</b> <a href="ConcurrentChangeTrackedList.cs.html#8f0d85d2a99c872c" class="t t">ConcurrentChangeTrackedList</a>&lt;<a href="FileStaging/IFileStagingProvider.cs.html#a1e33437d516696b" class="t t">IFileStagingProvider</a>&gt;;
 
                    <span class="r30 r">filesToStageListImpl</span>.<a href="ConcurrentChangeTrackedList.cs.html#cda522d1c8932d31" class="i property">IsReadOnly</a> = <b>true</b>; <span class="c">//Set read only</span>
                }
 
                <span class="i n">Models</span>.<a href="GeneratedProtocol/Models/TaskAddParameter.cs.html#523f661c1fddbf10" class="t t">TaskAddParameter</a> <span id="r31 rd" class="r31 r">protoTask</span> = <span class="r26 r">taskToAdd</span>.<a href="#27709233fad85ba0" class="i method">GetProtocolTask</a>();
                <span class="r21 r">protoTasksToAdd</span>.<a href="@0@mscorlib/A.html#9cc11588bffd57c1" class="i method">Add</a>(<span class="r31 r">protoTask</span>);
            }
 
            <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#1144e67a6ef818ce" class="i method">CheckForCancellationOrTimeoutAndThrow</a>();
 
            <span class="c">//</span>
            <span class="c">// Fire the protocol add collection request</span>
            <span class="c">//</span>
            <b>try</b>
            {
                <a href="@0@mscorlib/A.html#5ca7b77f3df89fc6" class="k">var</a> <span id="r32 rd" class="r32 r">asyncTask</span> = <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#580e7873cef26f1e" class="i field">_jobOperations</a>.<a href="JobOperations.cs.html#945084decf100a80" class="i property">ParentBatchClient</a>.<a href="BatchClient.cs.html#a54e70d7960be45a" class="i property">ProtocolLayer</a>.<a href="IProtocolLayer.cs.html#357fbfb466fdae33" class="i method">AddTaskCollection</a>(
                    <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#7144e501bd646d30" class="i field">_jobId</a>,
                    <span class="r21 r">protoTasksToAdd</span>,
                    <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#c359706ca39af5f3" class="i field">_behaviorManager</a>,
                    <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#78575d33c8f07572" class="i field">_parallelOptions</a>.<a href="BatchClientParallelOptions.cs.html#56f3b3c96d0cb9ca" class="i property">CancellationToken</a>);
 
                <a href="/Microsoft.Rest.ClientRuntime.Azure/A.html#97171b8214ee5041" class="k">var</a> <span id="r33 rd" class="r33 r">response</span> = <b>await</b> <span class="r32 r">asyncTask</span>.<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<span class="r34 r">continueOnCapturedContext</span>: <b>false</b>);
                <span class="c">//</span>
                <span class="c">// Process the results of the add task collection request</span>
                <span class="c">//</span>
                <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#209d59adcf3324e0" class="i method">ProcessProtocolAddTaskResults</a>(<span class="r33 r">response</span>.<a href="/Microsoft.Rest.ClientRuntime/A.html#f7006b95fa4d420c" class="i property">Body</a>.<a href="GeneratedProtocol/Models/TaskAddCollectionResult.cs.html#ee9173d1bf283a2b" class="i property">Value</a>, <span class="r19 r">tasksToAdd</span>);
            }
            <b>catch</b>(<span class="i n">Common</span>.<a href="Common/BatchException.cs.html#11968400ddac5a84" class="t t">BatchException</a> <span id="r35 rd" class="r35 r">e</span>)
            {
                <b>if</b> (<span class="r35 r">e</span>.<a href="@0@mscorlib/A.html#89c20b39fb04108b" class="i property">InnerException</a> <b>is</b> <span class="i n">Models</span>.<a href="GeneratedProtocol/Models/BatchErrorException.cs.html#afb146b0c7f5c1a7" class="t t">BatchErrorException</a> <span id="r36 rd" class="r36 r">exception</span>)
                {
                    <span class="i n">Models</span>.<a href="GeneratedProtocol/Models/BatchError.cs.html#436530a9d4116435" class="t t">BatchError</a> <span id="r37 rd" class="r37 r">error</span> = <span class="r36 r">exception</span>.<a href="GeneratedProtocol/Models/BatchErrorException.cs.html#fe2318532dd09dc5" class="i property">Body</a>;
                    <b>int</b> <span id="r38 rd" class="r38 r">currLength</span> = <span class="r19 r">tasksToAdd</span>.<a href="@0@mscorlib/A.html#12b9bba2a1f9c3e2" class="i property">Count</a>;
                    <b>if</b> (<span class="r37 r">error</span>.<a href="GeneratedProtocol/Models/BatchError.cs.html#2e588fb4c09923f0" class="i property">Code</a> == <span class="i n">Common</span>.<a href="Common/BatchErrorCodeStrings.cs.html#9e1a4b502b6f243d" class="t t">BatchErrorCodeStrings</a>.<a href="Common/BatchErrorCodeStrings.cs.html#13fb01f4303dcbeb" class="i field">RequestBodyTooLarge</a> &amp;&amp; <span class="r38 r">currLength</span> != 1)
                    {
                        <span class="c">// Our chunk sizes were too large to fit in a request, so universally reduce size</span>
                        <span class="c">// This is an internal error due to us using greedy initial maximum chunk size,</span>
                        <span class="c">//   so do not increment retry counter.</span>
                        {
                            <b>int</b> <span id="r39 rd" class="r39 r">newLength</span> = <span class="r38 r">currLength</span> / 2;
                            <b>int</b> <span id="r40 rd" class="r40 r">tmpMaxTasks</span> = <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#451c5b8eb49ff025" class="i field">_maxTasks</a>;
                            <b>while</b> (<span class="r39 r">newLength</span> &lt; <span class="r40 r">tmpMaxTasks</span>)
                            {
                                <span class="r40 r">tmpMaxTasks</span> = <a href="@0@mscorlib/A.html#8792520ddc6dadcb" class="t t">Interlocked</a>.<a href="@0@mscorlib/A.html#1e337a3aaaf240e4" class="i method">CompareExchange</a>(<b>ref</b> <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#451c5b8eb49ff025" class="i field">_maxTasks</a>, <span class="r39 r">newLength</span>, <span class="r40 r">tmpMaxTasks</span>);
                            }
                            <b>foreach</b> (<a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a> <span id="r41 rd" class="r41 r">trackedTask</span> <b>in</b> <span class="r19 r">tasksToAdd</span>.<a href="@0@mscorlib/A.html#4367dd1e300ae797" class="i property">Values</a>)
                            {
                                <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ce05ac96885eb08e" class="i field">_remainingTasksToAdd</a>.<a href="@0@mscorlib/A.html#62bea3a8141ed2a9" class="i method">Enqueue</a>(<span class="r41 r">trackedTask</span>);
                            }
                            <b>return</b>;
                        }
                    }
                }
                <b>throw</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Processes a set AddTaskResults from the protocol and groups them according to the results of the AddTaskResultHandler</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r42 r">addTaskResults</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">taskMap</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Dictionary of task name to task object instance for the specific protocol response.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="209d59adcf3324e0" href="R/209d59adcf3324e0.html" target="n" data-glyph="76,1" class="i method">ProcessProtocolAddTaskResults</a>(
            <a href="@0@mscorlib/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<span class="i n">Protocol</span>.<span class="i n">Models</span>.<a href="GeneratedProtocol/Models/TaskAddResult.cs.html#598dac8e97b945b0" class="t t">TaskAddResult</a>&gt; <span id="r42 rd" class="r42 r">addTaskResults</span>,
            <a href="@0@mscorlib/A.html#f786bcc5e7b69c7d" class="t t">IReadOnlyDictionary</a>&lt;<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a>&gt; <span id="r43 rd" class="r43 r">taskMap</span>)
        {
            <b>foreach</b> (<span class="i n">Protocol</span>.<span class="i n">Models</span>.<a href="GeneratedProtocol/Models/TaskAddResult.cs.html#598dac8e97b945b0" class="t t">TaskAddResult</a> <span id="r44 rd" class="r44 r">protoAddTaskResult</span> <b>in</b> <span class="r42 r">addTaskResults</span>)
            {
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r45 rd" class="r45 r">taskId</span> = <span class="r44 r">protoAddTaskResult</span>.<a href="GeneratedProtocol/Models/TaskAddResult.cs.html#161196eee67550e9" class="i property">TaskId</a>;
                <a href="#a2b04d02ea28e4ca" class="t t">TrackedCloudTask</a> <span id="r46 rd" class="r46 r">trackedTask</span> = <span class="r43 r">taskMap</span><a href="@0@mscorlib/A.html#78ec52556882d063">[</a><span class="r45 r">taskId</span>];
 
                <a href="P/38c50443aea1fd00.html#38c50443aea1fd00" class="t t">AddTaskResult</a> <span id="r47 rd" class="r47 r">omResult</span> = <b>new</b> <a href="AddTaskResult.cs.html#fe9e50cda74732df" class="t constructor">AddTaskResult</a>(<span class="r46 r">trackedTask</span>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>, <span class="r46 r">trackedTask</span>.<a href="#7773a41ffd39e029" class="i property">RetryCount</a>, <span class="r44 r">protoAddTaskResult</span>);
 
                <span class="c">//We know that there must be at least one AddTaskResultHandler so the below ForEach will always be called</span>
                <span class="c">//at least once.</span>
                <a href="AddTaskResult.cs.html#0b0ba3e28616259a" class="t t">AddTaskResultStatus</a> <span id="r48 rd" class="r48 r">status</span> = <a href="AddTaskResult.cs.html#0b0ba3e28616259a" class="t t">AddTaskResultStatus</a>.<a href="AddTaskResult.cs.html#3b8a956b1fcaecc1" class="i field">Success</a>; <span class="c">//The default is success to avoid infinite retry</span>
 
                <span class="c">//Call the customer defined result handler</span>
                <b>foreach</b> (<a href="@0@mscorlib/A.html#8adbe0476ca899db" class="k">var</a> <span id="r49 rd" class="r49 r">resultHandlerFunction</span> <b>in</b> <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#914642d39578de77" class="i field">_addTaskResultHandlerCollection</a>)
                {
                    <span class="r48 r">status</span> = <span class="r49 r">resultHandlerFunction</span>(<span class="r47 r">omResult</span>, <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#78575d33c8f07572" class="i field">_parallelOptions</a>.<a href="BatchClientParallelOptions.cs.html#56f3b3c96d0cb9ca" class="i property">CancellationToken</a>);
                }
 
                <b>if</b> (<span class="r48 r">status</span> == <a href="AddTaskResult.cs.html#0b0ba3e28616259a" class="t t">AddTaskResultStatus</a>.<a href="AddTaskResult.cs.html#37bf91f279767e71" class="i field">Retry</a>)
                {
                    <span class="c">//Increment retry count</span>
                    <span class="r46 r">trackedTask</span>.<a href="#f50dca5b8e558468" class="i method">IncrementRetryCount</a>();
 
                    <span class="c">//TODO: There is nothing stopping the user from marking all tasks as Retry and never exiting this work flow...</span>
                    <span class="c">//TODO: In that case maybe we should forcibly abort them after some # of attempts?</span>
                    <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ce05ac96885eb08e" class="i field">_remainingTasksToAdd</a>.<a href="@0@mscorlib/A.html#62bea3a8141ed2a9" class="i method">Enqueue</a>(<span class="r46 r">trackedTask</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waits for a pending operation to complete and throws if the operation failed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="be9cb53fcd07bf34" href="R/be9cb53fcd07bf34.html" target="n" data-glyph="76,1" class="i method">ProcessPendingOperationResults</a>()
        {
            <span class="c">//Wait for any task to complete</span>
            <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <span id="r50 rd" class="r50 r">completedTask</span> = <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#f16158c687359df9" class="i method">WhenAny</a>(<a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ec57c8e60ba777e8" class="i field">_pendingAsyncOperations</a>).<a href="@0@mscorlib/A.html#07ef75a8fa372c94" class="i method">ConfigureAwait</a>(<span class="r51 r">continueOnCapturedContext</span>: <b>false</b>);
 
            <span class="c">//Check for a task failure -- if there is one, we a-wait for all remaining tasks to complete (this will throw an exception since at least one of them failed).</span>
            <b>if</b> (<span class="r50 r">completedTask</span>.<a href="@0@mscorlib/A.html#e9c0495c4af4d4df" class="i property">IsFaulted</a>)
            {
                <b>await</b> <a href="#9342ba7229fe8310" class="i method">WaitForTasksAndThrowParallelOperationsExceptionAsync</a>(<a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ec57c8e60ba777e8" class="i field">_pendingAsyncOperations</a>).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<span class="r13 r">continueOnCapturedContext</span>: <b>false</b>);
            }
            <b>else</b>
            {
                <b>await</b> <span class="r50 r">completedTask</span>.<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<span class="r13 r">continueOnCapturedContext</span>: <b>false</b>); <span class="c">//This await should finish immediately and will not fail since the task has not faulted</span>
 
                <span class="c">//Remove the task which completed</span>
                <a href="#e7d21a279e77c6b3" class="k">this</a>.<a href="#ec57c8e60ba777e8" class="i field">_pendingAsyncOperations</a>.<a href="@0@mscorlib/A.html#db8cdd552a0bb10c" class="i method">Remove</a>(<span class="r50 r">completedTask</span>);
            }
        }
 
        <b>private static async</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="9342ba7229fe8310" href="R/9342ba7229fe8310.html" target="n" data-glyph="76,1" class="i method">WaitForTasksAndThrowParallelOperationsExceptionAsync</a>(<a href="@0@mscorlib/A.html#cf7f4095e4de7646" class="t t">List</a>&lt;<a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r52 rd" class="r52 r">tasks</span>)
        {
            <span class="c">//We know that this will throw, but we want to catch the exception so that we can provide a better aggregate exception experience for users</span>
            <b>try</b>
            {
                <span class="c">//NOTE: This try block should only do a WhenAll and nothing else, since the exception thrown in this try is discarded.</span>
                <b>await</b> <a href="@0@mscorlib/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@0@mscorlib/A.html#69351c6da968e5d1" class="i method">WhenAll</a>(<span class="r52 r">tasks</span>).<a href="@0@mscorlib/A.html#9ca6b2f012ce7587" class="i method">ConfigureAwait</a>(<span class="r13 r">continueOnCapturedContext</span>: <b>false</b>); <span class="c">//This will throw and terminate the workflow</span>
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a>)
            {
                <span class="c">//Swallow the exception and throw a new one</span>
 
                <a href="@0@mscorlib/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a>&gt; <span id="r53 rd" class="r53 r">exceptions</span> = <span class="r52 r">tasks</span>.<a href="@0@System.Core/A.html#e73922753675387a" class="i method">Where</a>(<span id="r54 rd" class="r54 r">t</span> =&gt; <span class="r54 r">t</span>.<a href="@0@mscorlib/A.html#e9c0495c4af4d4df" class="i property">IsFaulted</a>).<a href="@0@System.Core/A.html#8f3471331178bcb0" class="i method">SelectMany</a>(<span id="r55 rd" class="r55 r">t</span> =&gt; <span class="r55 r">t</span>.<a href="@0@mscorlib/A.html#0bdc783f2cd45895" class="i property">Exception</a>.<a href="@0@mscorlib/A.html#e9d864767768da2b" class="i property">InnerExceptions</a>);
                <b>throw</b> <b>new</b> <a href="BatchClientExceptions.cs.html#add64e434c5cb602" class="t constructor">ParallelOperationsException</a>(<a href="BatchErrorMessages.Designer.cs.html#3c2fda6d707d8e3d" class="t t">BatchErrorMessages</a>.<a href="BatchErrorMessages.Designer.cs.html#67ca458cce037303" class="i property">MultipleParallelRequestsHitUnexpectedErrors</a>, <span class="r53 r">exceptions</span>);
            }
        }
 
<span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
<span class="k preprocess">#</span><span class="k preprocess">region</span> Private classes
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Internal task wrapper which tracks a tasks retry count and holds a reference to the protocol object and CloudTask.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private class</b> <a id="a2b04d02ea28e4ca" href="R/a2b04d02ea28e4ca.html" target="n" data-glyph="4,1" class="t t">TrackedCloudTask</a>
        {
            <b>public string</b> <a id="145c602429d8bc83" href="R/145c602429d8bc83.html" target="n" data-glyph="102,2" class="i property">JobId</a> { <b>get</b>; <b>private set</b>; }
            <b>public</b> <a href="P/eeca8189f6dd1bc1.html#eeca8189f6dd1bc1" class="t t">CloudTask</a> <a id="31e81c181cf8ac7e" href="R/31e81c181cf8ac7e.html" target="n" data-glyph="102,2" class="i property">Task</a> { <b>get</b>; <b>private set</b>; }
            <b>public int</b> <a id="7773a41ffd39e029" href="R/7773a41ffd39e029.html" target="n" data-glyph="102,2" class="i property">RetryCount</a> { <b>get</b>; <b>private set</b>; }
            <b>public</b> <a href="JobOperations.cs.html#dd44f2346717d078" class="t t">JobOperations</a> <a id="f0c516a1ce369168" href="R/f0c516a1ce369168.html" target="n" data-glyph="102,2" class="i property">JobOperations</a> { <b>get</b>; <b>private set</b>; }
 
            <b>private</b> <span class="i n">Models</span>.<a href="GeneratedProtocol/Models/TaskAddParameter.cs.html#523f661c1fddbf10" class="t t">TaskAddParameter</a> <a id="81ae3a5915d441c5" href="R/81ae3a5915d441c5.html" target="n" data-glyph="106,2" class="i property">ProtocolTask</a> { <b>get</b>; <b>set</b>; }
 
            <b>internal</b> <a id="286d6f62f6c5480d" href="R/286d6f62f6c5480d.html" target="n" data-glyph="74,2" class="t constructor">TrackedCloudTask</a>(
                <a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r56 rd" class="r56 r">jobId</span>,
                <a href="JobOperations.cs.html#dd44f2346717d078" class="t t">JobOperations</a> <span id="r57 rd" class="r57 r">jobOperations</span>,
                <a href="P/eeca8189f6dd1bc1.html#eeca8189f6dd1bc1" class="t t">CloudTask</a> <span id="r58 rd" class="r58 r">cloudTask</span>)
            {
                <a href="#a2b04d02ea28e4ca" class="k">this</a>.<a href="#31e81c181cf8ac7e" class="i property">Task</a> = <span class="r58 r">cloudTask</span>;
                <a href="#a2b04d02ea28e4ca" class="k">this</a>.<a href="#145c602429d8bc83" class="i property">JobId</a> = <span class="r56 r">jobId</span>;
                <a href="#a2b04d02ea28e4ca" class="k">this</a>.<a href="#f0c516a1ce369168" class="i property">JobOperations</a> = <span class="r57 r">jobOperations</span>;  <span class="c">// matt-c: do we really need one of these in every instance?  Even when they were wiMgrs couldnt something outside keep a reference?</span>
                <a href="#a2b04d02ea28e4ca" class="k">this</a>.<a href="#7773a41ffd39e029" class="i property">RetryCount</a> = 0;
            }
 
            <b>public void</b> <a id="f50dca5b8e558468" href="R/f50dca5b8e558468.html" target="n" data-glyph="72,2" class="i method">IncrementRetryCount</a>()
            {
                <a href="#a2b04d02ea28e4ca" class="k">this</a>.<a href="#7773a41ffd39e029" class="i property">RetryCount</a>++;
            }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Gets the finalized version of this task.  Also internally updates this.Task to refer to a bound read-only copy of the original</span>
            <span class="c">///</span><span class="c"> CloudTask.  Subsequent calls to this method will return a reference to the same object</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <b>public</b> <span class="i n">Models</span>.<a href="GeneratedProtocol/Models/TaskAddParameter.cs.html#523f661c1fddbf10" class="t t">TaskAddParameter</a> <a id="27709233fad85ba0" href="R/27709233fad85ba0.html" target="n" data-glyph="72,2" class="i method">GetProtocolTask</a>()
            {
                <b>if</b> (<a href="#a2b04d02ea28e4ca" class="k">this</a>.<a href="#81ae3a5915d441c5" class="i property">ProtocolTask</a> == <b>null</b>)
                {
                    <a href="#a2b04d02ea28e4ca" class="k">this</a>.<a href="#81ae3a5915d441c5" class="i property">ProtocolTask</a> = <a href="#a2b04d02ea28e4ca" class="k">this</a>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="ITransportObjectProvider.cs.html#9d5fa7c9caec82e0" class="i method">GetTransportObject</a>();
                    <a href="#a2b04d02ea28e4ca" class="k">this</a>.<a href="#31e81c181cf8ac7e" class="i property">Task</a>.<a href="IReadOnly.cs.html#f5f69edae2920df4" class="i method">Freeze</a>(); <span class="c">//Mark the underlying task readonly</span>
                }
 
                <b>return</b> <a href="#a2b04d02ea28e4ca" class="k">this</a>.<a href="#81ae3a5915d441c5" class="i property">ProtocolTask</a>;
            }
        }
 
<span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    }
}
</pre></td></tr></table></div></body></html>
